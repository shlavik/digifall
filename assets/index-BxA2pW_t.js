var k1=Object.defineProperty;var up=n=>{throw TypeError(n)};var T1=(n,t,e)=>t in n?k1(n,t,{enumerable:!0,configurable:!0,writable:!0,value:e}):n[t]=e;var p=(n,t,e)=>T1(n,typeof t!="symbol"?t+"":t,e),su=(n,t,e)=>t.has(n)||up("Cannot "+e);var $=(n,t,e)=>(su(n,t,"read from private field"),e?e.call(n):t.get(n)),_e=(n,t,e)=>t.has(n)?up("Cannot add the same private member more than once"):t instanceof WeakSet?t.add(n):t.set(n,e),Pe=(n,t,e,r)=>(su(n,t,"write to private field"),r?r.call(n,e):t.set(n,e),e),ue=(n,t,e)=>(su(n,t,"access private method"),e);var vo=(n,t,e,r)=>({set _(s){Pe(n,t,s,e)},get _(){return $(n,t,r)}});(function(){const t=document.createElement("link").relList;if(t&&t.supports&&t.supports("modulepreload"))return;for(const s of document.querySelectorAll('link[rel="modulepreload"]'))r(s);new MutationObserver(s=>{for(const i of s)if(i.type==="childList")for(const o of i.addedNodes)o.tagName==="LINK"&&o.rel==="modulepreload"&&r(o)}).observe(document,{childList:!0,subtree:!0});function e(s){const i={};return s.integrity&&(i.integrity=s.integrity),s.referrerPolicy&&(i.referrerPolicy=s.referrerPolicy),s.crossOrigin==="use-credentials"?i.credentials="include":s.crossOrigin==="anonymous"?i.credentials="omit":i.credentials="same-origin",i}function r(s){if(s.ep)return;s.ep=!0;const i=e(s);fetch(s.href,i)}})();const zn=2,zy=4,ll=8,ul=16,Nr=32,to=64,uc=128,Dn=256,dc=512,cn=1024,Rr=2048,Ws=4096,kr=8192,dl=16384,qy=32768,hl=65536,C1=1<<17,P1=1<<19,Wy=1<<20,Es=Symbol("$state"),Gy=Symbol("legacy props"),D1=Symbol(""),dp=!1;var fl=Array.isArray,M1=Array.prototype.indexOf,xh=Array.from,Ih=Object.defineProperty,As=Object.getOwnPropertyDescriptor,Ky=Object.getOwnPropertyDescriptors,L1=Object.prototype,B1=Array.prototype,kh=Object.getPrototypeOf;function N1(n){return typeof n=="function"}const rn=()=>{};function R1(n){return n()}function Ho(n){for(var t=0;t<n.length;t++)n[t]()}const O1=typeof requestIdleCallback>"u"?n=>setTimeout(n,1):requestIdleCallback;let zo=[],qo=[];function Yy(){var n=zo;zo=[],Ho(n)}function Qy(){var n=qo;qo=[],Ho(n)}function pl(n){zo.length===0&&queueMicrotask(Yy),zo.push(n)}function F1(n){qo.length===0&&O1(Qy),qo.push(n)}function hp(){zo.length>0&&Yy(),qo.length>0&&Qy()}function Zy(n){return n===this.v}function Th(n,t){return n!=n?t==t:n!==t||n!==null&&typeof n=="object"||typeof n=="function"}function $1(n,t){return n!==t}function Ch(n){return!Th(n,this.v)}function U1(n){throw new Error("https://svelte.dev/e/effect_in_teardown")}function V1(){throw new Error("https://svelte.dev/e/effect_in_unowned_derived")}function H1(n){throw new Error("https://svelte.dev/e/effect_orphan")}function z1(){throw new Error("https://svelte.dev/e/effect_update_depth_exceeded")}function q1(){throw new Error("https://svelte.dev/e/hydration_failed")}function W1(n){throw new Error("https://svelte.dev/e/props_invalid_value")}function G1(){throw new Error("https://svelte.dev/e/state_descriptors_fixed")}function K1(){throw new Error("https://svelte.dev/e/state_prototype_fixed")}function Y1(){throw new Error("https://svelte.dev/e/state_unsafe_local_read")}function Q1(){throw new Error("https://svelte.dev/e/state_unsafe_mutation")}let no=!1,Z1=!1;function X1(){no=!0}const Ph=1,Dh=2,Xy=4,j1=8,J1=16,eS=1,tS=2,nS=4,rS=8,sS=16,iS=1,oS=2,aS=4,cS=1,lS=2,Mh="[",Lh="[!",Bh="]",Lo={},zt=Symbol();function Nh(n){console.warn("https://svelte.dev/e/hydration_mismatch")}function uS(){throw new Error("https://svelte.dev/e/invalid_default_snippet")}function jy(n){throw new Error("https://svelte.dev/e/lifecycle_outside_component")}let qe=null;function fp(n){qe=n}function kt(n,t=!1,e){qe={p:qe,c:null,e:null,m:!1,s:n,x:null,l:null},no&&!t&&(qe.l={s:null,u:null,r1:[],r2:In(!1)})}function Tt(n){const t=qe;if(t!==null){n!==void 0&&(t.x=n);const o=t.e;if(o!==null){var e=Ce,r=Be;t.e=null;try{for(var s=0;s<o.length;s++){var i=o[s];ir(i.effect),sr(i.reaction),Tn(i.fn)}}finally{ir(e),sr(r)}}qe=t.p,t.m=!0}return n||{}}function ro(){return!no||qe!==null&&qe.l===null}function In(n,t){var e={f:0,v:n,reactions:null,equals:Zy,rv:0,wv:0};return e}function ya(n,t=!1){var r;const e=In(n);return t||(e.equals=Ch),no&&qe!==null&&qe.l!==null&&((r=qe.l).s??(r.s=[])).push(e),e}function Y(n,t=!1){return dS(ya(n,t))}function dS(n){return Be!==null&&!$n&&(Be.f&zn)!==0&&(er===null?pS([n]):er.push(n)),n}function bs(n,t){return B(n,it(()=>b(n))),t}function B(n,t){return Be!==null&&!$n&&ro()&&(Be.f&(zn|ul))!==0&&(er===null||!er.includes(n))&&Q1(),cd(n,t)}function cd(n,t){return n.equals(t)||(n.v,n.v=t,n.wv=av(),Jy(n,Rr),ro()&&Ce!==null&&(Ce.f&cn)!==0&&(Ce.f&(Nr|to))===0&&(br===null?gS([n]):br.push(n))),t}function Jy(n,t){var e=n.reactions;if(e!==null)for(var r=ro(),s=e.length,i=0;i<s;i++){var o=e[i],a=o.f;(a&Rr)===0&&(!r&&o===Ce||(qn(o,t),(a&(cn|Dn))!==0&&((a&zn)!==0?Jy(o,Ws):yl(o))))}}function Wo(n){var t=zn|Rr,e=Be!==null&&(Be.f&zn)!==0?Be:null;return Ce===null||e!==null&&(e.f&Dn)!==0?t|=Dn:Ce.f|=Wy,{ctx:qe,deps:null,effects:null,equals:Zy,f:t,fn:n,reactions:null,rv:0,v:null,wv:0,parent:e??Ce}}function Nt(n){const t=Wo(n);return t.equals=Ch,t}function ev(n){var t=n.effects;if(t!==null){n.effects=null;for(var e=0;e<t.length;e+=1)cs(t[e])}}function hS(n){for(var t=n.parent;t!==null;){if((t.f&zn)===0)return t;t=t.parent}return null}function fS(n){var t,e=Ce;ir(hS(n));try{ev(n),t=lv(n)}finally{ir(e)}return t}function tv(n){var t=fS(n),e=(ts||(n.f&Dn)!==0)&&n.deps!==null?Ws:cn;qn(n,e),n.equals(t)||(n.v=t,n.wv=av())}let Ae=!1;function xr(n){Ae=n}let $e;function Un(n){if(n===null)throw Nh(),Lo;return $e=n}function so(){return Un(Or($e))}function q(n){if(Ae){if(Or($e)!==null)throw Nh(),Lo;$e=n}}function hc(n=1){if(Ae){for(var t=n,e=$e;t--;)e=Or(e);$e=e}}function ld(){for(var n=0,t=$e;;){if(t.nodeType===8){var e=t.data;if(e===Bh){if(n===0)return t;n-=1}else(e===Mh||e===Lh)&&(n+=1)}var r=Or(t);t.remove(),t=r}}function hi(n,t=null,e){if(typeof n!="object"||n===null||Es in n)return n;const r=kh(n);if(r!==L1&&r!==B1)return n;var s=new Map,i=fl(n),o=In(0);i&&s.set("length",In(n.length));var a;return new Proxy(n,{defineProperty(l,u,h){(!("value"in h)||h.configurable===!1||h.enumerable===!1||h.writable===!1)&&G1();var c=s.get(u);return c===void 0?(c=In(h.value),s.set(u,c)):B(c,hi(h.value,a)),!0},deleteProperty(l,u){var h=s.get(u);if(h===void 0)u in l&&s.set(u,In(zt));else{if(i&&typeof u=="string"){var c=s.get("length"),d=Number(u);Number.isInteger(d)&&d<c.v&&B(c,d)}B(h,zt),pp(o)}return!0},get(l,u,h){if(u===Es)return n;var c=s.get(u),d=u in l;if(c===void 0&&(!d||As(l,u)?.writable)&&(c=In(hi(d?l[u]:zt,a)),s.set(u,c)),c!==void 0){var f=b(c);return f===zt?void 0:f}return Reflect.get(l,u,h)},getOwnPropertyDescriptor(l,u){var h=Reflect.getOwnPropertyDescriptor(l,u);if(h&&"value"in h){var c=s.get(u);c&&(h.value=b(c))}else if(h===void 0){var d=s.get(u),f=d?.v;if(d!==void 0&&f!==zt)return{enumerable:!0,configurable:!0,value:f,writable:!0}}return h},has(l,u){if(u===Es)return!0;var h=s.get(u),c=h!==void 0&&h.v!==zt||Reflect.has(l,u);if(h!==void 0||Ce!==null&&(!c||As(l,u)?.writable)){h===void 0&&(h=In(c?hi(l[u],a):zt),s.set(u,h));var d=b(h);if(d===zt)return!1}return c},set(l,u,h,c){var d=s.get(u),f=u in l;if(i&&u==="length")for(var g=h;g<d.v;g+=1){var y=s.get(g+"");y!==void 0?B(y,zt):g in l&&(y=In(zt),s.set(g+"",y))}d===void 0?(!f||As(l,u)?.writable)&&(d=In(void 0),B(d,hi(h,a)),s.set(u,d)):(f=d.v!==zt,B(d,hi(h,a)));var m=Reflect.getOwnPropertyDescriptor(l,u);if(m?.set&&m.set.call(c,h),!f){if(i&&typeof u=="string"){var v=s.get("length"),_=Number(u);Number.isInteger(_)&&_>=v.v&&B(v,_+1)}pp(o)}return!0},ownKeys(l){b(o);var u=Reflect.ownKeys(l).filter(d=>{var f=s.get(d);return f===void 0||f.v!==zt});for(var[h,c]of s)c.v!==zt&&!(h in l)&&u.push(h);return u},setPrototypeOf(){K1()}})}function pp(n,t=1){B(n,n.v+t)}var ud,nv,rv,sv;function dd(){if(ud===void 0){ud=window,nv=/Firefox/.test(navigator.userAgent);var n=Element.prototype,t=Node.prototype;rv=As(t,"firstChild").get,sv=As(t,"nextSibling").get,n.__click=void 0,n.__className=void 0,n.__attributes=null,n.__styles=null,n.__e=void 0,Text.prototype.__t=void 0}}function Ni(n=""){return document.createTextNode(n)}function Ds(n){return rv.call(n)}function Or(n){return sv.call(n)}function W(n,t){if(!Ae)return Ds(n);var e=Ds($e);if(e===null)e=$e.appendChild(Ni());else if(t&&e.nodeType!==3){var r=Ni();return e?.before(r),Un(r),r}return Un(e),e}function sn(n,t){if(!Ae){var e=Ds(n);return e instanceof Comment&&e.data===""?Or(e):e}return $e}function J(n,t=1,e=!1){let r=Ae?$e:n;for(var s;t--;)s=r,r=Or(r);if(!Ae)return r;var i=r?.nodeType;if(e&&i!==3){var o=Ni();return r===null?s?.after(o):r.before(o),Un(o),o}return Un(r),r}function iv(n){n.textContent=""}let Za=!1,fc=!1,pc=null,xs=!1,Rh=!1;function gp(n){Rh=n}let Bo=[];let Be=null,$n=!1;function sr(n){Be=n}let Ce=null;function ir(n){Ce=n}let er=null;function pS(n){er=n}let Wt=null,hn=0,br=null;function gS(n){br=n}let ov=1,gc=0,ts=!1;function av(){return++ov}function io(n){var t=n.f;if((t&Rr)!==0)return!0;if((t&Ws)!==0){var e=n.deps,r=(t&Dn)!==0;if(e!==null){var s,i,o=(t&dc)!==0,a=r&&Ce!==null&&!ts,l=e.length;if(o||a){var u=n,h=u.parent;for(s=0;s<l;s++)i=e[s],(o||!i?.reactions?.includes(u))&&(i.reactions??(i.reactions=[])).push(u);o&&(u.f^=dc),a&&h!==null&&(h.f&Dn)===0&&(u.f^=Dn)}for(s=0;s<l;s++)if(i=e[s],io(i)&&tv(i),i.wv>n.wv)return!0}(!r||Ce!==null&&!ts)&&qn(n,cn)}return!1}function mS(n,t){for(var e=t;e!==null;){if((e.f&uc)!==0)try{e.fn(n);return}catch{e.f^=uc}e=e.parent}throw Za=!1,n}function yS(n){return(n.f&dl)===0&&(n.parent===null||(n.parent.f&uc)===0)}function gl(n,t,e,r){if(Za){if(e===null&&(Za=!1),yS(t))throw n;return}e!==null&&(Za=!0);{mS(n,t);return}}function cv(n,t,e=!0){var r=n.reactions;if(r!==null)for(var s=0;s<r.length;s++){var i=r[s];(i.f&zn)!==0?cv(i,t,!1):t===i&&(e?qn(i,Rr):(i.f&cn)!==0&&qn(i,Ws),yl(i))}}function lv(n){var f;var t=Wt,e=hn,r=br,s=Be,i=ts,o=er,a=qe,l=$n,u=n.f;Wt=null,hn=0,br=null,ts=(u&Dn)!==0&&($n||!xs||Be===null),Be=(u&(Nr|to))===0?n:null,er=null,fp(n.ctx),$n=!1,gc++;try{var h=(0,n.fn)(),c=n.deps;if(Wt!==null){var d;if(mc(n,hn),c!==null&&hn>0)for(c.length=hn+Wt.length,d=0;d<Wt.length;d++)c[hn+d]=Wt[d];else n.deps=c=Wt;if(!ts)for(d=hn;d<c.length;d++)((f=c[d]).reactions??(f.reactions=[])).push(n)}else c!==null&&hn<c.length&&(mc(n,hn),c.length=hn);if(ro()&&br!==null&&!$n&&c!==null&&(n.f&(zn|Ws|Rr))===0)for(d=0;d<br.length;d++)cv(br[d],n);return s!==null&&gc++,h}finally{Wt=t,hn=e,br=r,Be=s,ts=i,er=o,fp(a),$n=l}}function vS(n,t){let e=t.reactions;if(e!==null){var r=M1.call(e,n);if(r!==-1){var s=e.length-1;s===0?e=t.reactions=null:(e[r]=e[s],e.pop())}}e===null&&(t.f&zn)!==0&&(Wt===null||!Wt.includes(t))&&(qn(t,Ws),(t.f&(Dn|dc))===0&&(t.f^=dc),ev(t),mc(t,0))}function mc(n,t){var e=n.deps;if(e!==null)for(var r=t;r<e.length;r++)vS(n,e[r])}function ml(n){var t=n.f;if((t&dl)===0){qn(n,cn);var e=Ce,r=qe,s=xs;Ce=n,xs=!0;try{(t&ul)!==0?kS(n):pv(n),fv(n);var i=lv(n);n.teardown=typeof i=="function"?i:null,n.wv=ov;var o=n.deps,a;dp&&Z1&&n.f&Rr}catch(l){gl(l,n,e,r||n.ctx)}finally{xs=s,Ce=e}}}function bS(){try{z1()}catch(n){if(pc!==null)gl(n,pc,null);else throw n}}function uv(){var n=xs;try{var t=0;for(xs=!0;Bo.length>0;){t++>1e3&&bS();var e=Bo,r=e.length;Bo=[];for(var s=0;s<r;s++){var i=_S(e[s]);wS(i)}}}finally{fc=!1,xs=n,pc=null}}function wS(n){var t=n.length;if(t!==0)for(var e=0;e<t;e++){var r=n[e];if((r.f&(dl|kr))===0)try{io(r)&&(ml(r),r.deps===null&&r.first===null&&r.nodes_start===null&&(r.teardown===null?gv(r):r.fn=null))}catch(s){gl(s,r,null,r.ctx)}}}function yl(n){fc||(fc=!0,queueMicrotask(uv));for(var t=pc=n;t.parent!==null;){t=t.parent;var e=t.f;if((e&(to|Nr))!==0){if((e&cn)===0)return;t.f^=cn}}Bo.push(t)}function _S(n){for(var t=[],e=n;e!==null;){var r=e.f,s=(r&(Nr|to))!==0,i=s&&(r&cn)!==0;if(!i&&(r&kr)===0){if((r&zy)!==0)t.push(e);else if(s)e.f^=cn;else{var o=Be;try{Be=e,io(e)&&ml(e)}catch(u){gl(u,e,null,e.ctx)}finally{Be=o}}var a=e.first;if(a!==null){e=a;continue}}var l=e.parent;for(e=e.next;e===null&&l!==null;)e=l.next,l=l.parent}return t}function yt(n){var t;for(hp();Bo.length>0;)fc=!0,uv(),hp();return t}async function dv(){await Promise.resolve(),yt()}function b(n){var t=n.f,e=(t&zn)!==0;if(Be!==null&&!$n){er!==null&&er.includes(n)&&Y1();var r=Be.deps;n.rv<gc&&(n.rv=gc,Wt===null&&r!==null&&r[hn]===n?hn++:Wt===null?Wt=[n]:(!ts||!Wt.includes(n))&&Wt.push(n))}else if(e&&n.deps===null&&n.effects===null){var s=n,i=s.parent;i!==null&&(i.f&Dn)===0&&(s.f^=Dn)}return e&&(s=n,io(s)&&tv(s)),n.v}function it(n){var t=$n;try{return $n=!0,n()}finally{$n=t}}const SS=-7169;function qn(n,t){n.f=n.f&SS|t}function ES(n,t){var e={};for(var r in n)t.includes(r)||(e[r]=n[r]);return e}function kn(n){if(!(typeof n!="object"||!n||n instanceof EventTarget)){if(Es in n)hd(n);else if(!Array.isArray(n))for(let t in n){const e=n[t];typeof e=="object"&&e&&Es in e&&hd(e)}}}function hd(n,t=new Set){if(typeof n=="object"&&n!==null&&!(n instanceof EventTarget)&&!t.has(n)){t.add(n),n instanceof Date&&n.getTime();for(let r in n)try{hd(n[r],t)}catch{}const e=kh(n);if(e!==Object.prototype&&e!==Array.prototype&&e!==Map.prototype&&e!==Set.prototype&&e!==Date.prototype){const r=Ky(e);for(let s in r){const i=r[s].get;if(i)try{i.call(n)}catch{}}}}}function hv(n){Ce===null&&Be===null&&H1(),Be!==null&&(Be.f&Dn)!==0&&Ce===null&&V1(),Rh&&U1()}function AS(n,t){var e=t.last;e===null?t.last=t.first=n:(e.next=n,n.prev=e,t.last=n)}function oo(n,t,e,r=!0){var s=Ce,i={ctx:qe,deps:null,nodes_start:null,nodes_end:null,f:n|Rr,first:null,fn:t,last:null,next:null,parent:s,prev:null,teardown:null,transitions:null,wv:0};if(e)try{ml(i),i.f|=qy}catch(l){throw cs(i),l}else t!==null&&yl(i);var o=e&&i.deps===null&&i.first===null&&i.nodes_start===null&&i.teardown===null&&(i.f&(Wy|uc))===0;if(!o&&r&&(s!==null&&AS(i,s),Be!==null&&(Be.f&zn)!==0)){var a=Be;(a.effects??(a.effects=[])).push(i)}return i}function Oh(n){const t=oo(ll,null,!1);return qn(t,cn),t.teardown=n,t}function fd(n){hv();var t=Ce!==null&&(Ce.f&Nr)!==0&&qe!==null&&!qe.m;if(t){var e=qe;(e.e??(e.e=[])).push({fn:n,effect:Ce,reaction:Be})}else{var r=Tn(n);return r}}function xS(n){return hv(),ao(n)}function IS(n){const t=oo(to,n,!0);return(e={})=>new Promise(r=>{e.outro?Go(t,()=>{cs(t),r(void 0)}):(cs(t),r(void 0))})}function Tn(n){return oo(zy,n,!1)}function ae(n,t){var e=qe,r={effect:null,ran:!1};e.l.r1.push(r),r.effect=ao(()=>{n(),!r.ran&&(r.ran=!0,B(e.l.r2,!0),it(t))})}function dr(){var n=qe;ao(()=>{if(b(n.l.r2)){for(var t of n.l.r1){var e=t.effect;(e.f&cn)!==0&&qn(e,Ws),io(e)&&ml(e),t.ran=!1}n.l.r2.v=!1}})}function ao(n){return oo(ll,n,!0)}function Ze(n,t=[],e=Wo){const r=t.map(e);return vl(()=>n(...r.map(b)))}function vl(n,t=0){return oo(ll|ul|t,n,!0)}function Ri(n,t=!0){return oo(ll|Nr,n,!0,t)}function fv(n){var t=n.teardown;if(t!==null){const e=Rh,r=Be;gp(!0),sr(null);try{t.call(null)}finally{gp(e),sr(r)}}}function pv(n,t=!1){var e=n.first;for(n.first=n.last=null;e!==null;){var r=e.next;(e.f&to)!==0?e.parent=null:cs(e,t),e=r}}function kS(n){for(var t=n.first;t!==null;){var e=t.next;(t.f&Nr)===0&&cs(t),t=e}}function cs(n,t=!0){var e=!1;if((t||(n.f&P1)!==0)&&n.nodes_start!==null){for(var r=n.nodes_start,s=n.nodes_end;r!==null;){var i=r===s?null:Or(r);r.remove(),r=i}e=!0}pv(n,t&&!e),mc(n,0),qn(n,dl);var o=n.transitions;if(o!==null)for(const l of o)l.stop();fv(n);var a=n.parent;a!==null&&a.first!==null&&gv(n),n.next=n.prev=n.teardown=n.ctx=n.deps=n.fn=n.nodes_start=n.nodes_end=null}function gv(n){var t=n.parent,e=n.prev,r=n.next;e!==null&&(e.next=r),r!==null&&(r.prev=e),t!==null&&(t.first===n&&(t.first=r),t.last===n&&(t.last=e))}function Go(n,t){var e=[];Fh(n,e,!0),mv(e,()=>{cs(n),t&&t()})}function mv(n,t){var e=n.length;if(e>0){var r=()=>--e||t();for(var s of n)s.out(r)}else t()}function Fh(n,t,e){if((n.f&kr)===0){if(n.f^=kr,n.transitions!==null)for(const o of n.transitions)(o.is_global||e)&&t.push(o);for(var r=n.first;r!==null;){var s=r.next,i=(r.f&hl)!==0||(r.f&Nr)!==0;Fh(r,t,i?e:!1),r=s}}}function yc(n){yv(n,!0)}function yv(n,t){if((n.f&kr)!==0){n.f^=kr,(n.f&cn)===0&&(n.f^=cn),io(n)&&(qn(n,Rr),yl(n));for(var e=n.first;e!==null;){var r=e.next,s=(e.f&hl)!==0||(e.f&Nr)!==0;yv(e,s?t:!1),e=r}if(n.transitions!==null)for(const i of n.transitions)(i.is_global||t)&&i.in()}}let mp=!1;function vv(){mp||(mp=!0,document.addEventListener("reset",n=>{Promise.resolve().then(()=>{if(!n.defaultPrevented)for(const t of n.target.elements)t.__on_r?.()})},{capture:!0}))}function $h(n){var t=Be,e=Ce;sr(null),ir(null);try{return n()}finally{sr(t),ir(e)}}function bv(n,t,e,r=e){n.addEventListener(t,()=>$h(e));const s=n.__on_r;s?n.__on_r=()=>{s(),r(!0)}:n.__on_r=()=>r(!0),vv()}const TS=new Set,yp=new Set;function CS(n,t,e,r={}){function s(i){if(r.capture||ko.call(t,i),!i.cancelBubble)return $h(()=>e?.call(this,i))}return n.startsWith("pointer")||n.startsWith("touch")||n==="wheel"?pl(()=>{t.addEventListener(n,s,r)}):t.addEventListener(n,s,r),s}function Me(n,t,e,r,s){var i={capture:r,passive:s},o=CS(n,t,e,i);(t===document.body||t===window||t===document)&&Oh(()=>{t.removeEventListener(n,o,i)})}function ko(n){var t=this,e=t.ownerDocument,r=n.type,s=n.composedPath?.()||[],i=s[0]||n.target,o=0,a=n.__root;if(a){var l=s.indexOf(a);if(l!==-1&&(t===document||t===window)){n.__root=t;return}var u=s.indexOf(t);if(u===-1)return;l<=u&&(o=l)}if(i=s[o]||n.target,i!==t){Ih(n,"currentTarget",{configurable:!0,get(){return i||e}});var h=Be,c=Ce;sr(null),ir(null);try{for(var d,f=[];i!==null;){var g=i.assignedSlot||i.parentNode||i.host||null;try{var y=i["__"+r];if(y!==void 0&&(!i.disabled||n.target===i))if(fl(y)){var[m,...v]=y;m.apply(i,[n,...v])}else y.call(i,n)}catch(_){d?f.push(_):d=_}if(n.cancelBubble||g===t||g===null)break;i=g}if(d){for(let _ of f)queueMicrotask(()=>{throw _});throw d}}finally{n.__root=t,delete n.currentTarget,sr(h),ir(c)}}}function PS(n){var t=document.createElement("template");return t.innerHTML=n,t.content}function Si(n,t){var e=Ce;e.nodes_start===null&&(e.nodes_start=n,e.nodes_end=t)}function ce(n,t){var e=(t&cS)!==0,r=(t&lS)!==0,s,i=!n.startsWith("<!>");return()=>{if(Ae)return Si($e,null),$e;s===void 0&&(s=PS(i?n:"<!>"+n),e||(s=Ds(s)));var o=r||nv?document.importNode(s,!0):s.cloneNode(!0);if(e){var a=Ds(o),l=o.lastChild;Si(a,l)}else Si(o,o);return o}}function bl(){if(Ae)return Si($e,null),$e;var n=document.createDocumentFragment(),t=document.createComment(""),e=Ni();return n.append(t,e),Si(t,e),n}function oe(n,t){if(Ae){Ce.nodes_end=$e,so();return}n!==null&&n.before(t)}const DS=["touchstart","touchmove"];function MS(n){return DS.includes(n)}let pd=!0;function st(n,t){var e=t==null?"":typeof t=="object"?t+"":t;e!==(n.__t??(n.__t=n.nodeValue))&&(n.__t=e,n.nodeValue=e+"")}function wv(n,t){return _v(n,t)}function LS(n,t){dd(),t.intro=t.intro??!1;const e=t.target,r=Ae,s=$e;try{for(var i=Ds(e);i&&(i.nodeType!==8||i.data!==Mh);)i=Or(i);if(!i)throw Lo;xr(!0),Un(i),so();const o=_v(n,{...t,anchor:i});if($e===null||$e.nodeType!==8||$e.data!==Bh)throw Nh(),Lo;return xr(!1),o}catch(o){if(o===Lo)return t.recover===!1&&q1(),dd(),iv(e),xr(!1),wv(n,t);throw o}finally{xr(r),Un(s)}}const si=new Map;function _v(n,{target:t,anchor:e,props:r={},events:s,context:i,intro:o=!0}){dd();var a=new Set,l=c=>{for(var d=0;d<c.length;d++){var f=c[d];if(!a.has(f)){a.add(f);var g=MS(f);t.addEventListener(f,ko,{passive:g});var y=si.get(f);y===void 0?(document.addEventListener(f,ko,{passive:g}),si.set(f,1)):si.set(f,y+1)}}};l(xh(TS)),yp.add(l);var u=void 0,h=IS(()=>{var c=e??t.appendChild(Ni());return Ri(()=>{if(i){kt({});var d=qe;d.c=i}s&&(r.$$events=s),Ae&&Si(c,null),pd=o,u=n(c,r)||{},pd=!0,Ae&&(Ce.nodes_end=$e),i&&Tt()}),()=>{for(var d of a){t.removeEventListener(d,ko);var f=si.get(d);--f===0?(document.removeEventListener(d,ko),si.delete(d)):si.set(d,f)}yp.delete(l),c!==e&&c.parentNode?.removeChild(c)}});return gd.set(u,h),u}let gd=new WeakMap;function BS(n,t){const e=gd.get(n);return e?(gd.delete(n),e(t)):Promise.resolve()}function Uh(n){return function(...t){var e=t[0];return e.preventDefault(),n?.apply(this,t)}}function $t(n){return new NS(n)}var _r,Sn;class NS{constructor(t){_e(this,_r);_e(this,Sn);var e=new Map,r=(i,o)=>{var a=ya(o);return e.set(i,a),a};const s=new Proxy({...t.props||{},$$events:{}},{get(i,o){return b(e.get(o)??r(o,Reflect.get(i,o)))},has(i,o){return o===Gy?!0:(b(e.get(o)??r(o,Reflect.get(i,o))),Reflect.has(i,o))},set(i,o,a){return B(e.get(o)??r(o,a),a),Reflect.set(i,o,a)}});Pe(this,Sn,(t.hydrate?LS:wv)(t.component,{target:t.target,anchor:t.anchor,props:s,context:t.context,intro:t.intro??!1,recover:t.recover})),(!t?.props?.$$host||t.sync===!1)&&yt(),Pe(this,_r,s.$$events);for(const i of Object.keys($(this,Sn)))i==="$set"||i==="$destroy"||i==="$on"||Ih(this,i,{get(){return $(this,Sn)[i]},set(o){$(this,Sn)[i]=o},enumerable:!0});$(this,Sn).$set=i=>{Object.assign(s,i)},$(this,Sn).$destroy=()=>{BS($(this,Sn))}}$set(t){$(this,Sn).$set(t)}$on(t,e){$(this,_r)[t]=$(this,_r)[t]||[];const r=(...s)=>e.call(this,...s);return $(this,_r)[t].push(r),()=>{$(this,_r)[t]=$(this,_r)[t].filter(s=>s!==r)}}$destroy(){$(this,Sn).$destroy()}}_r=new WeakMap,Sn=new WeakMap;const RS="5";var Qm;typeof window<"u"&&((Qm=window.__svelte??(window.__svelte={})).v??(Qm.v=new Set)).add(RS);X1();function Ue(n,t,[e,r]=[0,0]){Ae&&e===0&&so();var s=n,i=null,o=null,a=zt,l=e>0?hl:0,u=!1;const h=(d,f=!0)=>{u=!0,c(f,d)},c=(d,f)=>{if(a===(a=d))return;let g=!1;if(Ae&&r!==-1){if(e===0){const m=s.data;m===Mh?r=0:m===Lh?r=1/0:(r=parseInt(m.substring(1)),r!==r&&(r=a?1/0:-1))}const y=r>e;!!a===y&&(s=ld(),Un(s),xr(!1),g=!0,r=-1)}a?(i?yc(i):f&&(i=Ri(()=>f(s))),o&&Go(o,()=>{o=null})):(o?yc(o):f&&(o=Ri(()=>f(s,[e+1,r]))),i&&Go(i,()=>{i=null})),g&&xr(!0)};vl(()=>{u=!1,t(h),u||c(null,null)},l),Ae&&(s=$e)}function OS(n,t,e){Ae&&so();var r=n,s=zt,i,o=ro()?$1:Th;vl(()=>{o(s,s=t())&&(i&&Go(i),i=Ri(()=>e(r)))}),Ae&&(r=$e)}function Oi(n,t){return t}function FS(n,t,e,r){for(var s=[],i=t.length,o=0;o<i;o++)Fh(t[o].e,s,!0);var a=i>0&&s.length===0&&e!==null;if(a){var l=e.parentNode;iv(l),l.append(e),r.clear(),Kr(n,t[0].prev,t[i-1].next)}mv(s,()=>{for(var u=0;u<i;u++){var h=t[u];a||(r.delete(h.k),Kr(n,h.prev,h.next)),cs(h.e,!a)}})}function Is(n,t,e,r,s,i=null){var o=n,a={flags:t,items:new Map,first:null},l=(t&Xy)!==0;if(l){var u=n;o=Ae?Un(Ds(u)):u.appendChild(Ni())}Ae&&so();var h=null,c=!1,d=Nt(()=>{var f=e();return fl(f)?f:f==null?[]:xh(f)});vl(()=>{var f=b(d),g=f.length;if(c&&g===0)return;c=g===0;let y=!1;if(Ae){var m=o.data===Lh;m!==(g===0)&&(o=ld(),Un(o),xr(!1),y=!0)}if(Ae){for(var v=null,_,w=0;w<g;w++){if($e.nodeType===8&&$e.data===Bh){o=$e,y=!0,xr(!1);break}var S=f[w],E=r(S,w);_=Sv($e,a,v,null,S,E,w,s,t,e),a.items.set(E,_),v=_}g>0&&Un(ld())}Ae||$S(f,a,o,s,t,r,e),i!==null&&(g===0?h?yc(h):h=Ri(()=>i(o)):h!==null&&Go(h,()=>{h=null})),y&&xr(!0),b(d)}),Ae&&(o=$e)}function $S(n,t,e,r,s,i,o){var a=(s&j1)!==0,l=(s&(Ph|Dh))!==0,u=n.length,h=t.items,c=t.first,d=c,f,g=null,y,m=[],v=[],_,w,S,E;if(a)for(E=0;E<u;E+=1)_=n[E],w=i(_,E),S=h.get(w),S!==void 0&&(S.a?.measure(),(y??(y=new Set)).add(S));for(E=0;E<u;E+=1){if(_=n[E],w=i(_,E),S=h.get(w),S===void 0){var A=d?d.e.nodes_start:e;g=Sv(A,t,g,g===null?t.first:g.next,_,w,E,r,s,o),h.set(w,g),m=[],v=[],d=g.next;continue}if(l&&US(S,_,E,s),(S.e.f&kr)!==0&&(yc(S.e),a&&(S.a?.unfix(),(y??(y=new Set)).delete(S))),S!==d){if(f!==void 0&&f.has(S)){if(m.length<v.length){var I=v[0],T;g=I.prev;var x=m[0],V=m[m.length-1];for(T=0;T<m.length;T+=1)vp(m[T],I,e);for(T=0;T<v.length;T+=1)f.delete(v[T]);Kr(t,x.prev,V.next),Kr(t,g,x),Kr(t,V,I),d=I,g=V,E-=1,m=[],v=[]}else f.delete(S),vp(S,d,e),Kr(t,S.prev,S.next),Kr(t,S,g===null?t.first:g.next),Kr(t,g,S),g=S;continue}for(m=[],v=[];d!==null&&d.k!==w;)(d.e.f&kr)===0&&(f??(f=new Set)).add(d),v.push(d),d=d.next;if(d===null)continue;S=d}m.push(S),g=S,d=S.next}if(d!==null||f!==void 0){for(var L=f===void 0?[]:xh(f);d!==null;)(d.e.f&kr)===0&&L.push(d),d=d.next;var N=L.length;if(N>0){var H=(s&Xy)!==0&&u===0?e:null;if(a){for(E=0;E<N;E+=1)L[E].a?.measure();for(E=0;E<N;E+=1)L[E].a?.fix()}FS(t,L,H,h)}}a&&pl(()=>{if(y!==void 0)for(S of y)S.a?.apply()}),Ce.first=t.first&&t.first.e,Ce.last=g&&g.e}function US(n,t,e,r){(r&Ph)!==0&&cd(n.v,t),(r&Dh)!==0?cd(n.i,e):n.i=e}function Sv(n,t,e,r,s,i,o,a,l,u){var h=(l&Ph)!==0,c=(l&J1)===0,d=h?c?ya(s):In(s):s,f=(l&Dh)===0?o:In(o),g={i:f,v:d,k:i,a:null,e:null,prev:e,next:r};try{return g.e=Ri(()=>a(n,d,f,u),Ae),g.e.prev=e&&e.e,g.e.next=r&&r.e,e===null?t.first=g:(e.next=g,e.e.next=g.e),r!==null&&(r.prev=g,r.e.prev=g.e),g}finally{}}function vp(n,t,e){for(var r=n.next?n.next.e.nodes_start:e,s=t?t.e.nodes_start:e,i=n.e.nodes_start;i!==r;){var o=Or(i);s.before(i),i=o}}function Kr(n,t,e){t===null?n.first=e:(t.next=e,t.e.next=e&&e.e),e!==null&&(e.prev=t,e.e.prev=t&&t.e)}function Ev(n,t,e,r,s){Ae&&so();var i=t.$$slots?.[e],o=!1;i===!0&&(i=t.children,o=!0),i===void 0||i(n,o?()=>r:r)}function VS(n,t,e){Tn(()=>{var r=it(()=>t(n,e?.())||{});if(r?.destroy)return()=>r.destroy()})}function Av(n){var t,e,r="";if(typeof n=="string"||typeof n=="number")r+=n;else if(typeof n=="object")if(Array.isArray(n)){var s=n.length;for(t=0;t<s;t++)n[t]&&(e=Av(n[t]))&&(r&&(r+=" "),r+=e)}else for(e in n)n[e]&&(r&&(r+=" "),r+=e);return r}function HS(){for(var n,t,e=0,r="",s=arguments.length;e<s;e++)(n=arguments[e])&&(t=Av(n))&&(r&&(r+=" "),r+=t);return r}function zS(n){return typeof n=="object"?HS(n):n??""}const bp=[...` 	
\r\f \v\uFEFF`];function qS(n,t,e){var r=n==null?"":""+n;if(t&&(r=r?r+" "+t:t),e){for(var s in e)if(e[s])r=r?r+" "+s:s;else if(r.length)for(var i=s.length,o=0;(o=r.indexOf(s,o))>=0;){var a=o+i;(o===0||bp.includes(r[o-1]))&&(a===r.length||bp.includes(r[a]))?r=(o===0?"":r.substring(0,o))+r.substring(a+1):o=a}}return r===""?null:r}function nt(n,t,e,r,s,i){var o=n.__className;if(Ae||o!==e){var a=qS(e,r,i);(!Ae||a!==n.getAttribute("class"))&&(a==null?n.removeAttribute("class"):n.className=a),n.__className=e}else if(i)for(var l in i){var u=!!i[l];(s==null||u!==!!s[l])&&n.classList.toggle(l,u)}return i}function Xa(n){if(Ae){var t=!1,e=()=>{if(!t){if(t=!0,n.hasAttribute("value")){var r=n.value;Ot(n,"value",null),n.value=r}if(n.hasAttribute("checked")){var s=n.checked;Ot(n,"checked",null),n.checked=s}}};n.__on_r=e,F1(e),vv()}}function WS(n,t){var e=n.__attributes??(n.__attributes={});e.checked!==(e.checked=t??void 0)&&(n.checked=t)}function Ot(n,t,e,r){var s=n.__attributes??(n.__attributes={});Ae&&(s[t]=n.getAttribute(t),t==="src"||t==="srcset"||t==="href"&&n.nodeName==="LINK")||s[t]!==(s[t]=e)&&(t==="style"&&"__styles"in n&&(n.__styles={}),t==="loading"&&(n[D1]=e),e==null?n.removeAttribute(t):typeof e!="string"&&GS(n).includes(t)?n[t]=e:n.setAttribute(t,e))}var wp=new Map;function GS(n){var t=wp.get(n.nodeName);if(t)return t;wp.set(n.nodeName,t=[]);for(var e,r=n,s=Element.prototype;s!==r;){e=Ky(r);for(var i in e)e[i].set&&t.push(i);r=kh(r)}return t}function gn(n,t,e,r){var s=n.__styles??(n.__styles={});s[t]!==e&&(s[t]=e,e==null?n.style.removeProperty(t):n.style.setProperty(t,e,""))}const KS=()=>performance.now(),Er={tick:n=>requestAnimationFrame(n),now:()=>KS(),tasks:new Set};function xv(){const n=Er.now();Er.tasks.forEach(t=>{t.c(n)||(Er.tasks.delete(t),t.f())}),Er.tasks.size!==0&&Er.tick(xv)}function YS(n){let t;return Er.tasks.size===0&&Er.tick(xv),{promise:new Promise(e=>{Er.tasks.add(t={c:n,f:e})}),abort(){Er.tasks.delete(t)}}}function Da(n,t){$h(()=>{n.dispatchEvent(new CustomEvent(t))})}function QS(n){if(n==="float")return"cssFloat";if(n==="offset")return"cssOffset";if(n.startsWith("--"))return n;const t=n.split("-");return t.length===1?t[0]:t[0]+t.slice(1).map(e=>e[0].toUpperCase()+e.slice(1)).join("")}function _p(n){const t={},e=n.split(";");for(const r of e){const[s,i]=r.split(":");if(!s||i===void 0)break;const o=QS(s.trim());t[o]=i.trim()}return t}const ZS=n=>n;function Ke(n,t,e,r){var s=(n&iS)!==0,i=(n&oS)!==0,o=s&&i,a=(n&aS)!==0,l=o?"both":s?"in":"out",u,h=t.inert,c=t.style.overflow,d,f;function g(){var w=Be,S=Ce;sr(null),ir(null);try{return u??(u=e()(t,r?.()??{},{direction:l}))}finally{sr(w),ir(S)}}var y={is_global:a,in(){if(t.inert=h,!s){f?.abort(),f?.reset?.();return}i||d?.abort(),Da(t,"introstart"),d=md(t,g(),f,1,()=>{Da(t,"introend"),d?.abort(),d=u=void 0,t.style.overflow=c})},out(w){if(!i){w?.(),u=void 0;return}t.inert=!0,Da(t,"outrostart"),f=md(t,g(),d,0,()=>{Da(t,"outroend"),w?.()})},stop:()=>{d?.abort(),f?.abort()}},m=Ce;if((m.transitions??(m.transitions=[])).push(y),s&&pd){var v=a;if(!v){for(var _=m.parent;_&&(_.f&hl)!==0;)for(;(_=_.parent)&&(_.f&ul)===0;);v=!_||(_.f&qy)!==0}v&&Tn(()=>{it(()=>y.in())})}}function md(n,t,e,r,s){var i=r===1;if(N1(t)){var o,a=!1;return pl(()=>{if(!a){var m=t({direction:i?"in":"out"});o=md(n,m,e,r,s)}}),{abort:()=>{a=!0,o?.abort()},deactivate:()=>o.deactivate(),reset:()=>o.reset(),t:()=>o.t()}}if(e?.deactivate(),!t?.duration)return s(),{abort:rn,deactivate:rn,reset:rn,t:()=>r};const{delay:l=0,css:u,tick:h,easing:c=ZS}=t;var d=[];if(i&&e===void 0&&(h&&h(0,1),u)){var f=_p(u(0,1));d.push(f,f)}var g=()=>1-r,y=n.animate(d,{duration:l});return y.onfinish=()=>{var m=e?.t()??1-r;e?.abort();var v=r-m,_=t.duration*Math.abs(v),w=[];if(_>0){var S=!1;if(u)for(var E=Math.ceil(_/16.666666666666668),A=0;A<=E;A+=1){var I=m+v*c(A/E),T=_p(u(I,1-I));w.push(T),S||(S=T.overflow==="hidden")}S&&(n.style.overflow="hidden"),g=()=>{var x=y.currentTime;return m+v*c(x/_)},h&&YS(()=>{if(y.playState!=="running")return!1;var x=g();return h(x,1-x),!0})}y=n.animate(w,{duration:_,fill:"forwards"}),y.onfinish=()=>{g=()=>r,h?.(r,1-r),s()}},{abort:()=>{y&&(y.cancel(),y.effect=null,y.onfinish=rn)},deactivate:()=>{s=rn},reset:()=>{r===0&&h?.(1,0)},t:()=>g()}}function XS(n,t,e=t){var r=ro();bv(n,"input",s=>{var i=s?n.defaultValue:n.value;if(i=iu(n)?ou(i):i,e(i),r&&i!==(i=t())){var o=n.selectionStart,a=n.selectionEnd;n.value=i??"",a!==null&&(n.selectionStart=o,n.selectionEnd=Math.min(a,n.value.length))}}),(Ae&&n.defaultValue!==n.value||it(t)==null&&n.value)&&e(iu(n)?ou(n.value):n.value),ao(()=>{var s=t();iu(n)&&s===ou(n.value)||n.type==="date"&&!s&&!n.value||s!==n.value&&(n.value=s??"")})}function Sp(n,t,e=t){bv(n,"change",r=>{var s=r?n.defaultChecked:n.checked;e(s)}),(Ae&&n.defaultChecked!==n.checked||it(t)==null)&&e(n.checked),ao(()=>{var r=t();n.checked=!!r})}function iu(n){var t=n.type;return t==="number"||t==="range"}function ou(n){return n===""?null:+n}function Ee(n,t,e){var r=As(n,t);r&&r.set&&(n[t]=e,Oh(()=>{n[t]=null}))}var jr,ki,ca,ol,Iv;const al=class al{constructor(t){_e(this,ol);_e(this,jr,new WeakMap);_e(this,ki);_e(this,ca);Pe(this,ca,t)}observe(t,e){var r=$(this,jr).get(t)||new Set;return r.add(e),$(this,jr).set(t,r),ue(this,ol,Iv).call(this).observe(t,$(this,ca)),()=>{var s=$(this,jr).get(t);s.delete(e),s.size===0&&($(this,jr).delete(t),$(this,ki).unobserve(t))}}};jr=new WeakMap,ki=new WeakMap,ca=new WeakMap,ol=new WeakSet,Iv=function(){return $(this,ki)??Pe(this,ki,new ResizeObserver(t=>{for(var e of t){al.entries.set(e.target,e);for(var r of $(this,jr).get(e.target)||[])r(e)}}))},p(al,"entries",new WeakMap);let yd=al;var jS=new yd({box:"border-box"});function Ep(n,t,e){var r=jS.observe(n,()=>e(n[t]));Tn(()=>(it(()=>e(n[t])),r))}function Ap(n,t){return n===t||n?.[Es]===t}function ht(n={},t,e,r){return Tn(()=>{var s,i;return ao(()=>{s=i,i=[],it(()=>{n!==e(...i)&&(t(n,...i),s&&Ap(e(...s),n)&&t(null,...s))})}),()=>{pl(()=>{i&&Ap(e(...i),n)&&t(null,...i)})}}),n}function Ut(n=!1){const t=qe,e=t.l.u;if(!e)return;let r=()=>kn(t.s);if(n){let s=0,i={};const o=Wo(()=>{let a=!1;const l=t.s;for(const u in l)l[u]!==i[u]&&(i[u]=l[u],a=!0);return a&&s++,s});r=()=>b(o)}e.b.length&&xS(()=>{xp(t,r),Ho(e.b)}),fd(()=>{const s=it(()=>e.m.map(R1));return()=>{for(const i of s)typeof i=="function"&&i()}}),e.a.length&&fd(()=>{xp(t,r),Ho(e.a)})}function xp(n,t){if(n.l.s)for(const e of n.l.s)b(e);t()}function Vt(n,t,e){var r;n.$$events||(n.$$events={}),(r=n.$$events)[t]||(r[t]=[]),n.$$events[t].push(e)}function Ht(n){for(var t in n)t in this&&(this[t]=n[t])}function JS(n){qe===null&&jy(),no&&qe.l!==null?nE(qe).m.push(n):fd(()=>{const t=it(n);if(typeof t=="function")return t})}function eE(n,t,{bubbles:e=!1,cancelable:r=!1}={}){return new CustomEvent(n,{detail:t,bubbles:e,cancelable:r})}function tE(){const n=qe;return n===null&&jy(),(t,e,r)=>{const s=n.s.$$events?.[t];if(s){const i=fl(s)?s.slice():[s],o=eE(t,e,r);for(const a of i)a.call(n.x,o);return!o.defaultPrevented}return!0}}function nE(n){var t=n.l;return t.u??(t.u={a:[],b:[],m:[]})}function Vh(n,t,e){if(n==null)return t(void 0),e&&e(void 0),rn;const r=it(()=>n.subscribe(t,e));return r.unsubscribe?()=>r.unsubscribe():r}const ii=[];function To(n,t){return{subscribe:mt(n,t).subscribe}}function mt(n,t=rn){let e=null;const r=new Set;function s(a){if(Th(n,a)&&(n=a,e)){const l=!ii.length;for(const u of r)u[1](),ii.push(u,n);if(l){for(let u=0;u<ii.length;u+=2)ii[u][0](ii[u+1]);ii.length=0}}}function i(a){s(a(n))}function o(a,l=rn){const u=[a,l];return r.add(u),r.size===1&&(e=t(s,i)||rn),a(n),()=>{r.delete(u),r.size===0&&e&&(e(),e=null)}}return{set:s,update:i,subscribe:o}}function kv(n,t,e){const r=!Array.isArray(n),s=r?[n]:n;if(!s.every(Boolean))throw new Error("derived() expects stores as input, got a falsy value");const i=t.length<2;return To(e,(o,a)=>{let l=!1;const u=[];let h=0,c=rn;const d=()=>{if(h)return;c();const g=t(r?u[0]:u,o,a);i?o(g):c=typeof g=="function"?g:rn},f=s.map((g,y)=>Vh(g,m=>{u[y]=m,h&=~(1<<y),l&&d()},()=>{h|=1<<y}));return l=!0,d(),function(){Ho(f),c(),l=!1}})}function Ne(n){let t;return Vh(n,e=>t=e)(),t}let Ma=!1,vd=Symbol();function ge(n,t,e){const r=e[t]??(e[t]={store:null,source:ya(void 0),unsubscribe:rn});if(r.store!==n&&!(vd in e))if(r.unsubscribe(),r.store=n??null,n==null)r.source.v=void 0,r.unsubscribe=rn;else{var s=!0;r.unsubscribe=Vh(n,i=>{s?r.source.v=i:B(r.source,i)}),s=!1}return n&&vd in e?Ne(n):b(r.source)}function rE(n,t,e){let r=e[t];return r&&r.store!==n&&(r.unsubscribe(),r.unsubscribe=rn),n}function xt(n,t){return n.set(t),t}function wn(){const n={};function t(){Oh(()=>{for(var e in n)n[e].unsubscribe();Ih(n,vd,{enumerable:!1,value:!0})})}return[n,t]}function ja(n,t,e){return n.set(e),t}function sE(n){var t=Ma;try{return Ma=!1,[n(),Ma]}finally{Ma=t}}function At(n,t,e,r){var s=(e&eS)!==0,i=!no||(e&tS)!==0,o=(e&rS)!==0,a=(e&sS)!==0,l=!1,u;o?[u,l]=sE(()=>n[t]):u=n[t];var h=Es in n||Gy in n,c=o&&(As(n,t)?.set??(h&&t in n&&(A=>n[t]=A)))||void 0,d=r,f=!0,g=!1,y=()=>(g=!0,f&&(f=!1,a?d=it(r):d=r),d);u===void 0&&r!==void 0&&(c&&i&&W1(),u=y(),c&&c(u));var m;if(i)m=()=>{var A=n[t];return A===void 0?y():(f=!0,g=!1,A)};else{var v=(s?Wo:Nt)(()=>n[t]);v.f|=C1,m=()=>{var A=b(v);return A!==void 0&&(d=void 0),A===void 0?d:A}}if((e&nS)===0)return m;if(c){var _=n.$$legacy;return function(A,I){return arguments.length>0?((!i||!I||_||l)&&c(I?m():A),A):m()}}var w=!1,S=ya(u),E=Wo(()=>{var A=m(),I=b(S);return w?(w=!1,I):S.v=A});return s||(E.equals=Ch),function(A,I){if(arguments.length>0){const T=I?b(E):i&&o?hi(A):A;return E.equals(T)||(w=!0,B(S,T),g&&d!==void 0&&(d=T),it(()=>b(E))),A}return b(E)}}const vn=!!localStorage.getItem("debug"),Ip=Number(localStorage.getItem("reload")),lt=1e3,ze=Object.freeze({columns:6,rows:6,maxValue:9}),U=Object.freeze({digifall:"digifall",highCombo:"highCombo",highComboPrev:"highComboPrev",highScore:"highScore",highScorePrev:"highScorePrev",leaderboard:"leaderboard",local:"local",moves:"moves",options:"options",peerId:"peerId",playerName:"playerName",records:"records",score:"score",timestamp:"timestamp",type:"type",value:"value"}),ye=Object.freeze({gameOver:"gameOver",leaderboard:"leaderboard",menu:"menu",options:"options",wellcome:"wellcome"}),re=Object.freeze({blink:"blink",combo:"combo",extra:"extra",fall:"fall",gameOver:"gameOver",idle:"idle",initial:"initial",match:"match",plus:"plus",score:"score"}),Gs=Object.freeze([U.highCombo,U.highScore]),Fe=Object.freeze({cards:[],energy:{buffer:0,value:100},[U.leaderboard]:{highCombo:[],highScore:[]},log:[],matchedIndexes:new Set,[U.moves]:"",[U.options]:{[U.playerName]:"",[U.leaderboard]:!0,cluster:!0,rapid:!1,sound:!0},overlay:ye.menu,phase:re.initial,plusIndex:void 0,[U.records]:Gs.reduce((n,t)=>(n[t]={[U.playerName]:"",[U.timestamp]:0,[U.moves]:"",[U.value]:0},n),{}),[U.score]:{buffer:0,value:0}}),{abs:Tv,sign:Hh,trunc:Cv}=Math;function vc(n=0){return(n*16807+19487171)%2147483647}function iE(n){return btoa(String.fromCodePoint(...n))}function Pv(n){return Array.from(atob(n)).map(t=>t.charCodeAt())}function bd(n){const t=BigInt(Number.MAX_SAFE_INTEGER),e=n.reduce((r,s)=>(r=BigInt(`${r}${s}`),r>t&&(r=r%t),r),0);return Number(e)}function Mn(n,t,e=0){const{rapid:r}=Ne(n.options),s=!r&&n.movesInitial===null&&e>0;switch(typeof t){case"undefined":return{duration:s?0:400};case"function":return s?setTimeout(()=>t(n),e):t(n);case"object":return s?{duration:0}:t;default:return s?0:t}}function or(n,t,{muteRapid:e=!1}={}){if(!t)return;const{sound:r,rapid:s}=Ne(n.options);if(!(e&&s)&&!(!r||n.movesInitial!==null||!n.ready)){if(Array.isArray(t)){t.forEach(i=>i&&i());return}t()}}function bc(n,t,e){const r=Ne(n.records);r[t][U.value]>=e||(r[t]={[U.moves]:Ne(n.moves),[U.playerName]:Ne(n.options).playerName,[U.timestamp]:Ne(n.timestamp),[U.value]:e},n.records.set(r))}function Ko(n){return n<ze.maxValue?n+1:0}function wl(n){const t=Array.from({length:ze.columns},()=>Array.from({length:2*ze.rows}));return n.forEach(({x:e,y:r},s)=>t[e][r]=s),t}function Dv(n,t){const e=Ne(n.phase),{rapid:r}=Ne(n.options),s=wl(t),i=[],o=new Set;return s.forEach(a=>{let l=0;a.forEach((u,h)=>{if(u===void 0)return++l;const{x:c,value:d}=t[u],f=r||n.movesInitial||e!==re.fall?0:100*(2*l)**.5;i[u]={x:c,y:h-l,value:d,nextValue:Ko(d),duration:f},l>0&&f>0&&!o.has(f)&&o.add(f)})}),or(n,()=>o.forEach(a=>setTimeout(n.sounds.playKick,a)),{muteRapid:!0}),i}function Mv(n){const t=wl(n),e=new Set,r=[],s=(i,o,a)=>{if(e.has(o))return;const{x:l,y:u,value:h}=n[o];a!==void 0&&a!==h||(r[i]||(r[i]={value:h,indexes:new Set}),r[i].indexes.add(o),e.add(o),u<ze.columns-1&&s(i,t[l][u+1],h),l<ze.columns-1&&s(i,t[l+1][u],h),u>0&&s(i,t[l][u-1],h),l>0&&s(i,t[l-1][u],h))};return n.forEach((i,o)=>s(o,o)),r.reduce((i,o)=>(o.value===o.indexes.size&&(i.counts++,i.digits.add(o.value),o.indexes.forEach(i.indexes.add,i.indexes)),i),{counts:0,digits:new Set,indexes:new Set})}function Lv(n,t,e){const r=[0,0,0,0,0,0],s=i=>r[i]+t.filter(({x:o})=>o===i).sort(({y:o},{y:a})=>a-o)[0].y;return t.map((i,o)=>i.y<ze.rows&&e.has(o)?(++r[i.x],{x:i.x,y:s(i.x),value:n.getNextCardValue(i.x),duration:0}):i)}function _l(n,t){if(!Ne(n.options).cluster)return t;const e=wl(t);return t.map(r=>({...r,cluster:oE(t,e,r)}))}function oE(n,t,{x:e,y:r,value:s}){const i=r===ze.rows-1?-1:t[e][r+1],o=e===ze.columns-1?-1:t[e+1][r],a=r===0?-1:t[e][r-1],l=e===0?-1:t[e-1][r],u=i>-1?n[i].value:NaN,h=o>-1?n[o].value:NaN,c=a>-1?n[a].value:NaN,d=l>-1?n[l].value:NaN;return{top:u===s,right:h===s,bottom:c===s,left:d===s}}function Bv(n){return Hh(n)*Cv(Tv(n)**.5)}function aE(n,{buffer:t,value:e}){const r=Ne(n.phase),{rapid:s}=Ne(n.options),i=s||n.movesInitial?t:r===re.gameOver?Hh(t):Bv(t);if(r===re.extra){if(t===0){Mn(n,()=>n.phase.set(re.combo),800);return}n.log.update(o=>{const a=o.length-1,{extra:l}=o[a];return o[a]={extra:l-i},o})}if(t===0){r===re.gameOver&&or(n,()=>setTimeout(n.sounds.playGameOver,600));return}Mn(n,()=>{n.energy.set({buffer:t-i,value:e+i})},r===re.gameOver?200:32)}function cE(n){setTimeout(()=>n.phase.set(re.idle),0)}function lE(n){if(n.movesInitial!==null){if(n.moveCount<n.movesInitial.length){n.plusIndex.set(n.movesInitial[n.moveCount++]),n.energy.update(({buffer:t,value:e})=>({buffer:t,value:e-10})),n.phase.set(re.plus);return}n.movesInitial=null,bc(n,U.highScore,Ne(n.score).value);return}n.cards.update(t=>t.map(e=>(e.duration=0,e))),bc(n,U.highScore,Ne(n.score).value),or(n,n.sounds.reset)}function uE(n){n.plusIndex.update(t=>{n.cards.update(e=>_l(n,e.map((r,s)=>{if(s!==t)return r;const i=Ko(r.value);return{...r,value:i,nextValue:Ko(i),duration:0}})))}),n.phase.set(re.blink)}function dE(n){const t=Ne(n.cards);let{counts:e,digits:r,indexes:s}=Mv(t);n.matchedIndexes.set(s);const{value:i}=Ne(n.energy);if(s.size>0){const o=Array.from(s);n.log.update(l=>l.concat(o.reduce((u,h)=>{const c=t[h];return u[c.value]=(u[c.value]||0)+c.value,u.sum=(u.sum||0)+c.value,u.counts=e,u.digits=Array.from(r),u},{})));const a=o.reduce((l,u)=>l+t[u].value,0);Mn(n,()=>n.energy.set({buffer:a,value:i}),400),Mn(n,()=>n.phase.set(re.match),800),or(n,[n.sounds.playWordUp,n.sounds.playBlink],{muteRapid:!0});return}if(i>100){n.phase.set(re.extra);return}if(Ne(n.log).length>0){n.phase.set(re.combo);return}if(i<10){n.phase.set(re.gameOver);return}n.phase.set(re.idle)}function hE(n){n.matchedIndexes.update(t=>(n.cards.update(e=>_l(n,Lv(n,e,t))),new Set)),Mn(n,()=>n.phase.set(re.fall),400)}function fE(n){n.cards.update(t=>_l(n,Dv(n,t))),Mn(n,()=>n.phase.set(re.blink),400)}function pE(n){n.energy.update(({value:t})=>({buffer:100-t,value:t})),n.log.update(t=>t.concat({extra:100})),or(n,n.sounds.playWordUp,{muteRapid:!0})}function Nv(n){return n.reduce((t,{counts:e,extra:r,sum:s},i)=>t+(i+1)*(s||r)*(e||1),0)}function gE(n){const t=Ne(n.log),e=Nv(t);n.score.update(({value:r})=>({buffer:e,value:r})),bc(n,U.highCombo,e),Mn(n,()=>n.phase.set(re.score),t.length>1?800:0),or(n,n.sounds.playWordUp,{muteRapid:!0})}function mE(n){Ne(n.log).length<2||n.score.update(t=>({...t}))}function yE(n){Mn(n,()=>{n.energy.update(({value:t})=>({buffer:-t,value:t})),n.score.update(({value:t})=>({buffer:Ne(n.energy).value,value:t}))},400)}const vE={[re.initial]:cE,[re.idle]:lE,[re.plus]:uE,[re.blink]:dE,[re.match]:hE,[re.fall]:fE,[re.extra]:pE,[re.combo]:gE,[re.score]:mE,[re.gameOver]:yE};function bE(n,t){vE[t](n)}function wE(n,t){if(t===void 0||n.movesInitial!==null)return;let e=Ne(n.moves);e=Array.isArray(e)?e:Pv(e),e.push(t),n.moves.set(iE(e)),n.energy.update(r=>({...r,buffer:-10})),Mn(n,()=>n.phase.set(re.plus),400)}function _E(n){switch(Tv(n)){case 1:return 130;case 2:case 3:return 80;case 4:case 5:case 6:return 50;case 7:case 8:case 9:case 10:case 11:return 30;default:return 20}}function SE(n,{buffer:t,value:e}){const r=Ne(n.phase);if(r!==re.gameOver&&r!==re.score)return;if(t===0){if(r===re.gameOver){bc(n,U.highScore,e);return}Mn(n,()=>{n.log.set([]),n.phase.set(Ne(n.energy).value<10?re.gameOver:re.idle),or(n,n.sounds.playTurnOn)},200);return}const{rapid:s}=Ne(n.options),i=s||n.movesInitial?t:r===re.gameOver?Hh(t):Bv(t);Mn(n,()=>{n.score.set({buffer:t-i,value:e+i})},r===re.gameOver?200:_E(i)),or(n,n.sounds.playBleep,{muteRapid:!0})}function zh({playerName:n,timestamp:t}){return n&&typeof n=="string"&&t&&typeof t=="number"&&t<1/0&&bd([t,...Array.from(n).map(e=>e.charCodeAt())])}function EE(n){let t=0;const e=[vc(n)];for(;t<ze.columns-1;)e.push(vc(2*e[t++]));return e}function AE(n){let t=EE(n);return e=>{if(e<0||ze.columns-1<e)return;let r=t[e];return t[e]=vc(r),r%10}}function xE(n){return Array.from({length:ze.columns*ze.rows},(t,e,r,s)=>(r=Cv(e/ze.columns),s=n.getNextCardValue(r),{x:r,y:e%ze.rows,value:s,nextValue:Ko(s),duration:0}))}function IE(n,t){for(;;){const e=Mv(t).indexes;if(e.size===0)return t;const r=Lv(n,t,e);t=Dv(n,r)}}function kE(n,t){if(!t)return;n.getNextCardValue=AE(t),n.cards.set(_l(n,IE(n,xE(n))));let e=Ne(n.moves);if(e){if(e=Array.isArray(e)?e:Pv(e),e.length>0){n.moveCount=0,n.movesInitial=e;return}n.movesInitial=null}}function Rv(n){const t=Ne(n.records);n[U.highComboPrev]=t[U.highCombo][U.value],n[U.highScorePrev]=t[U.highScore][U.value]}function Ov(n,t){return Rv(n),n.sounds=t||{},n.getNextCardValue=()=>0,n.moveCount=0,n.movesInitial=null,n.energy.subscribe(e=>aE(n,e)),n.phase.subscribe(e=>bE(n,e)),n.plusIndex.subscribe(e=>wE(n,e)),n.score.subscribe(e=>SE(n,e)),n.seed.subscribe(e=>kE(n,e)),n}function Fv(n,t,e){if(t<0)return n.ready=!0;setTimeout(()=>{n.log.set(Fe.log),n.plusIndex.set(Fe.plusIndex),n.matchedIndexes.set(Fe.matchedIndexes),n.moves.set(Fe.moves),n.score.set(Fe.score),n.energy.set(Fe.energy),n.phase.set(Fe.phase),n.timestamp.set(Date.now()),Fv(n,--t),e&&n.options.update(r=>({...r,playerName:e}))},64)}function TE(n,t){Rv(n),or(n,n.sounds.playGenerate),n.ready=!1,Fv(n,8,t)}var CE=ce('<div><div class="value"><div> </div> <div class="next"> </div></div></div>');function $v(n,t){if(new.target)return $t({component:$v,...n});kt(t,!1);const e=Y();let r=At(t,"card",12),s=At(t,"index",12),i=At(t,"blink",12),o=At(t,"focus",12),a=At(t,"longpress",12),l=At(t,"plus",12);ae(()=>kn(r()),()=>{B(e,Ko(r().value))}),dr(),Ut();var u=CE();let h;var c=W(u),d=W(c);let f;var g=W(d,!0);q(d);var y=J(d,2),m=W(y,!0);return q(y),q(c),q(u),Ze(()=>{h=nt(u,1,"card",null,h,{blink:i(),focus:o(),longpress:a(),plus:l()}),Ot(u,"data-index",s()),gn(u,"--card-x",r().x),gn(u,"--card-y",r().y),gn(u,"--card-duration",r().duration),f=nt(d,1,"current",null,f,{"cluster-top":r().cluster&&r().cluster.top,"cluster-right":r().cluster&&r().cluster.right,"cluster-bottom":r().cluster&&r().cluster.bottom,"cluster-left":r().cluster&&r().cluster.left}),gn(d,"--color",`var(--color-${r().value??""})`),st(g,r().value),gn(y,"--color",`var(--color-${b(e)??""})`),st(m,b(e))}),oe(n,u),Tt({get card(){return r()},set card(v){r(v),yt()},get index(){return s()},set index(v){s(v),yt()},get blink(){return i()},set blink(v){i(v),yt()},get focus(){return o()},set focus(v){o(v),yt()},get longpress(){return a()},set longpress(v){a(v),yt()},get plus(){return l()},set plus(v){l(v),yt()},$set:Ht,$on:(v,_)=>Vt(t,v,_)})}function PE(n,{duration:t=400}={}){let e;const r=(i={})=>{n.dispatchEvent(new CustomEvent("longpressstart",{bubbles:!0,detail:i})),e=window.setTimeout(()=>{n.dispatchEvent(new CustomEvent("longpressfire",{bubbles:!0,detail:i}))},t)},s=(i={})=>{clearTimeout(e),n.dispatchEvent(new CustomEvent("longpressend",{bubbles:!0,detail:i}))};return n.addEventListener("mousedown",r,{passive:!0}),n.addEventListener("touchstart",r,{passive:!0}),n.addEventListener("touchend",s,{passive:!0}),window.addEventListener("mouseup",s,{passive:!0}),{update(i){clearTimeout(e),t=i.duration||t},destroy(){clearTimeout(e),n.removeEventListener("mousedown",r),n.removeEventListener("touchstart",r),n.removeEventListener("touchend",s),window.removeEventListener("mouseup",s)}}}var bo=typeof globalThis<"u"?globalThis:typeof window<"u"?window:typeof global<"u"?global:typeof self<"u"?self:{};function co(n){return n&&n.__esModule&&Object.prototype.hasOwnProperty.call(n,"default")?n.default:n}var au={};/*!
 *  howler.js v2.2.4
 *  howlerjs.com
 *
 *  (c) 2013-2020, James Simpson of GoldFire Studios
 *  goldfirestudios.com
 *
 *  MIT License
 */var kp;function DE(){return kp||(kp=1,function(n){(function(){var t=function(){this.init()};t.prototype={init:function(){var c=this||e;return c._counter=1e3,c._html5AudioPool=[],c.html5PoolSize=10,c._codecs={},c._howls=[],c._muted=!1,c._volume=1,c._canPlayEvent="canplaythrough",c._navigator=typeof window<"u"&&window.navigator?window.navigator:null,c.masterGain=null,c.noAudio=!1,c.usingWebAudio=!0,c.autoSuspend=!0,c.ctx=null,c.autoUnlock=!0,c._setup(),c},volume:function(c){var d=this||e;if(c=parseFloat(c),d.ctx||h(),typeof c<"u"&&c>=0&&c<=1){if(d._volume=c,d._muted)return d;d.usingWebAudio&&d.masterGain.gain.setValueAtTime(c,e.ctx.currentTime);for(var f=0;f<d._howls.length;f++)if(!d._howls[f]._webAudio)for(var g=d._howls[f]._getSoundIds(),y=0;y<g.length;y++){var m=d._howls[f]._soundById(g[y]);m&&m._node&&(m._node.volume=m._volume*c)}return d}return d._volume},mute:function(c){var d=this||e;d.ctx||h(),d._muted=c,d.usingWebAudio&&d.masterGain.gain.setValueAtTime(c?0:d._volume,e.ctx.currentTime);for(var f=0;f<d._howls.length;f++)if(!d._howls[f]._webAudio)for(var g=d._howls[f]._getSoundIds(),y=0;y<g.length;y++){var m=d._howls[f]._soundById(g[y]);m&&m._node&&(m._node.muted=c?!0:m._muted)}return d},stop:function(){for(var c=this||e,d=0;d<c._howls.length;d++)c._howls[d].stop();return c},unload:function(){for(var c=this||e,d=c._howls.length-1;d>=0;d--)c._howls[d].unload();return c.usingWebAudio&&c.ctx&&typeof c.ctx.close<"u"&&(c.ctx.close(),c.ctx=null,h()),c},codecs:function(c){return(this||e)._codecs[c.replace(/^x-/,"")]},_setup:function(){var c=this||e;if(c.state=c.ctx&&c.ctx.state||"suspended",c._autoSuspend(),!c.usingWebAudio)if(typeof Audio<"u")try{var d=new Audio;typeof d.oncanplaythrough>"u"&&(c._canPlayEvent="canplay")}catch{c.noAudio=!0}else c.noAudio=!0;try{var d=new Audio;d.muted&&(c.noAudio=!0)}catch{}return c.noAudio||c._setupCodecs(),c},_setupCodecs:function(){var c=this||e,d=null;try{d=typeof Audio<"u"?new Audio:null}catch{return c}if(!d||typeof d.canPlayType!="function")return c;var f=d.canPlayType("audio/mpeg;").replace(/^no$/,""),g=c._navigator?c._navigator.userAgent:"",y=g.match(/OPR\/(\d+)/g),m=y&&parseInt(y[0].split("/")[1],10)<33,v=g.indexOf("Safari")!==-1&&g.indexOf("Chrome")===-1,_=g.match(/Version\/(.*?) /),w=v&&_&&parseInt(_[1],10)<15;return c._codecs={mp3:!!(!m&&(f||d.canPlayType("audio/mp3;").replace(/^no$/,""))),mpeg:!!f,opus:!!d.canPlayType('audio/ogg; codecs="opus"').replace(/^no$/,""),ogg:!!d.canPlayType('audio/ogg; codecs="vorbis"').replace(/^no$/,""),oga:!!d.canPlayType('audio/ogg; codecs="vorbis"').replace(/^no$/,""),wav:!!(d.canPlayType('audio/wav; codecs="1"')||d.canPlayType("audio/wav")).replace(/^no$/,""),aac:!!d.canPlayType("audio/aac;").replace(/^no$/,""),caf:!!d.canPlayType("audio/x-caf;").replace(/^no$/,""),m4a:!!(d.canPlayType("audio/x-m4a;")||d.canPlayType("audio/m4a;")||d.canPlayType("audio/aac;")).replace(/^no$/,""),m4b:!!(d.canPlayType("audio/x-m4b;")||d.canPlayType("audio/m4b;")||d.canPlayType("audio/aac;")).replace(/^no$/,""),mp4:!!(d.canPlayType("audio/x-mp4;")||d.canPlayType("audio/mp4;")||d.canPlayType("audio/aac;")).replace(/^no$/,""),weba:!!(!w&&d.canPlayType('audio/webm; codecs="vorbis"').replace(/^no$/,"")),webm:!!(!w&&d.canPlayType('audio/webm; codecs="vorbis"').replace(/^no$/,"")),dolby:!!d.canPlayType('audio/mp4; codecs="ec-3"').replace(/^no$/,""),flac:!!(d.canPlayType("audio/x-flac;")||d.canPlayType("audio/flac;")).replace(/^no$/,"")},c},_unlockAudio:function(){var c=this||e;if(!(c._audioUnlocked||!c.ctx)){c._audioUnlocked=!1,c.autoUnlock=!1,!c._mobileUnloaded&&c.ctx.sampleRate!==44100&&(c._mobileUnloaded=!0,c.unload()),c._scratchBuffer=c.ctx.createBuffer(1,1,22050);var d=function(f){for(;c._html5AudioPool.length<c.html5PoolSize;)try{var g=new Audio;g._unlocked=!0,c._releaseHtml5Audio(g)}catch{c.noAudio=!0;break}for(var y=0;y<c._howls.length;y++)if(!c._howls[y]._webAudio)for(var m=c._howls[y]._getSoundIds(),v=0;v<m.length;v++){var _=c._howls[y]._soundById(m[v]);_&&_._node&&!_._node._unlocked&&(_._node._unlocked=!0,_._node.load())}c._autoResume();var w=c.ctx.createBufferSource();w.buffer=c._scratchBuffer,w.connect(c.ctx.destination),typeof w.start>"u"?w.noteOn(0):w.start(0),typeof c.ctx.resume=="function"&&c.ctx.resume(),w.onended=function(){w.disconnect(0),c._audioUnlocked=!0,document.removeEventListener("touchstart",d,!0),document.removeEventListener("touchend",d,!0),document.removeEventListener("click",d,!0),document.removeEventListener("keydown",d,!0);for(var S=0;S<c._howls.length;S++)c._howls[S]._emit("unlock")}};return document.addEventListener("touchstart",d,!0),document.addEventListener("touchend",d,!0),document.addEventListener("click",d,!0),document.addEventListener("keydown",d,!0),c}},_obtainHtml5Audio:function(){var c=this||e;if(c._html5AudioPool.length)return c._html5AudioPool.pop();var d=new Audio().play();return d&&typeof Promise<"u"&&(d instanceof Promise||typeof d.then=="function")&&d.catch(function(){console.warn("HTML5 Audio pool exhausted, returning potentially locked audio object.")}),new Audio},_releaseHtml5Audio:function(c){var d=this||e;return c._unlocked&&d._html5AudioPool.push(c),d},_autoSuspend:function(){var c=this;if(!(!c.autoSuspend||!c.ctx||typeof c.ctx.suspend>"u"||!e.usingWebAudio)){for(var d=0;d<c._howls.length;d++)if(c._howls[d]._webAudio){for(var f=0;f<c._howls[d]._sounds.length;f++)if(!c._howls[d]._sounds[f]._paused)return c}return c._suspendTimer&&clearTimeout(c._suspendTimer),c._suspendTimer=setTimeout(function(){if(c.autoSuspend){c._suspendTimer=null,c.state="suspending";var g=function(){c.state="suspended",c._resumeAfterSuspend&&(delete c._resumeAfterSuspend,c._autoResume())};c.ctx.suspend().then(g,g)}},3e4),c}},_autoResume:function(){var c=this;if(!(!c.ctx||typeof c.ctx.resume>"u"||!e.usingWebAudio))return c.state==="running"&&c.ctx.state!=="interrupted"&&c._suspendTimer?(clearTimeout(c._suspendTimer),c._suspendTimer=null):c.state==="suspended"||c.state==="running"&&c.ctx.state==="interrupted"?(c.ctx.resume().then(function(){c.state="running";for(var d=0;d<c._howls.length;d++)c._howls[d]._emit("resume")}),c._suspendTimer&&(clearTimeout(c._suspendTimer),c._suspendTimer=null)):c.state==="suspending"&&(c._resumeAfterSuspend=!0),c}};var e=new t,r=function(c){var d=this;if(!c.src||c.src.length===0){console.error("An array of source files must be passed with any new Howl.");return}d.init(c)};r.prototype={init:function(c){var d=this;return e.ctx||h(),d._autoplay=c.autoplay||!1,d._format=typeof c.format!="string"?c.format:[c.format],d._html5=c.html5||!1,d._muted=c.mute||!1,d._loop=c.loop||!1,d._pool=c.pool||5,d._preload=typeof c.preload=="boolean"||c.preload==="metadata"?c.preload:!0,d._rate=c.rate||1,d._sprite=c.sprite||{},d._src=typeof c.src!="string"?c.src:[c.src],d._volume=c.volume!==void 0?c.volume:1,d._xhr={method:c.xhr&&c.xhr.method?c.xhr.method:"GET",headers:c.xhr&&c.xhr.headers?c.xhr.headers:null,withCredentials:c.xhr&&c.xhr.withCredentials?c.xhr.withCredentials:!1},d._duration=0,d._state="unloaded",d._sounds=[],d._endTimers={},d._queue=[],d._playLock=!1,d._onend=c.onend?[{fn:c.onend}]:[],d._onfade=c.onfade?[{fn:c.onfade}]:[],d._onload=c.onload?[{fn:c.onload}]:[],d._onloaderror=c.onloaderror?[{fn:c.onloaderror}]:[],d._onplayerror=c.onplayerror?[{fn:c.onplayerror}]:[],d._onpause=c.onpause?[{fn:c.onpause}]:[],d._onplay=c.onplay?[{fn:c.onplay}]:[],d._onstop=c.onstop?[{fn:c.onstop}]:[],d._onmute=c.onmute?[{fn:c.onmute}]:[],d._onvolume=c.onvolume?[{fn:c.onvolume}]:[],d._onrate=c.onrate?[{fn:c.onrate}]:[],d._onseek=c.onseek?[{fn:c.onseek}]:[],d._onunlock=c.onunlock?[{fn:c.onunlock}]:[],d._onresume=[],d._webAudio=e.usingWebAudio&&!d._html5,typeof e.ctx<"u"&&e.ctx&&e.autoUnlock&&e._unlockAudio(),e._howls.push(d),d._autoplay&&d._queue.push({event:"play",action:function(){d.play()}}),d._preload&&d._preload!=="none"&&d.load(),d},load:function(){var c=this,d=null;if(e.noAudio){c._emit("loaderror",null,"No audio support.");return}typeof c._src=="string"&&(c._src=[c._src]);for(var f=0;f<c._src.length;f++){var g,y;if(c._format&&c._format[f])g=c._format[f];else{if(y=c._src[f],typeof y!="string"){c._emit("loaderror",null,"Non-string found in selected audio sources - ignoring.");continue}g=/^data:audio\/([^;,]+);/i.exec(y),g||(g=/\.([^.]+)$/.exec(y.split("?",1)[0])),g&&(g=g[1].toLowerCase())}if(g||console.warn('No file extension was found. Consider using the "format" property or specify an extension.'),g&&e.codecs(g)){d=c._src[f];break}}if(!d){c._emit("loaderror",null,"No codec support for selected audio sources.");return}return c._src=d,c._state="loading",window.location.protocol==="https:"&&d.slice(0,5)==="http:"&&(c._html5=!0,c._webAudio=!1),new s(c),c._webAudio&&o(c),c},play:function(c,d){var f=this,g=null;if(typeof c=="number")g=c,c=null;else{if(typeof c=="string"&&f._state==="loaded"&&!f._sprite[c])return null;if(typeof c>"u"&&(c="__default",!f._playLock)){for(var y=0,m=0;m<f._sounds.length;m++)f._sounds[m]._paused&&!f._sounds[m]._ended&&(y++,g=f._sounds[m]._id);y===1?c=null:g=null}}var v=g?f._soundById(g):f._inactiveSound();if(!v)return null;if(g&&!c&&(c=v._sprite||"__default"),f._state!=="loaded"){v._sprite=c,v._ended=!1;var _=v._id;return f._queue.push({event:"play",action:function(){f.play(_)}}),_}if(g&&!v._paused)return d||f._loadQueue("play"),v._id;f._webAudio&&e._autoResume();var w=Math.max(0,v._seek>0?v._seek:f._sprite[c][0]/1e3),S=Math.max(0,(f._sprite[c][0]+f._sprite[c][1])/1e3-w),E=S*1e3/Math.abs(v._rate),A=f._sprite[c][0]/1e3,I=(f._sprite[c][0]+f._sprite[c][1])/1e3;v._sprite=c,v._ended=!1;var T=function(){v._paused=!1,v._seek=w,v._start=A,v._stop=I,v._loop=!!(v._loop||f._sprite[c][2])};if(w>=I){f._ended(v);return}var x=v._node;if(f._webAudio){var V=function(){f._playLock=!1,T(),f._refreshBuffer(v);var D=v._muted||f._muted?0:v._volume;x.gain.setValueAtTime(D,e.ctx.currentTime),v._playStart=e.ctx.currentTime,typeof x.bufferSource.start>"u"?v._loop?x.bufferSource.noteGrainOn(0,w,86400):x.bufferSource.noteGrainOn(0,w,S):v._loop?x.bufferSource.start(0,w,86400):x.bufferSource.start(0,w,S),E!==1/0&&(f._endTimers[v._id]=setTimeout(f._ended.bind(f,v),E)),d||setTimeout(function(){f._emit("play",v._id),f._loadQueue()},0)};e.state==="running"&&e.ctx.state!=="interrupted"?V():(f._playLock=!0,f.once("resume",V),f._clearTimer(v._id))}else{var L=function(){x.currentTime=w,x.muted=v._muted||f._muted||e._muted||x.muted,x.volume=v._volume*e.volume(),x.playbackRate=v._rate;try{var D=x.play();if(D&&typeof Promise<"u"&&(D instanceof Promise||typeof D.then=="function")?(f._playLock=!0,T(),D.then(function(){f._playLock=!1,x._unlocked=!0,d?f._loadQueue():f._emit("play",v._id)}).catch(function(){f._playLock=!1,f._emit("playerror",v._id,"Playback was unable to start. This is most commonly an issue on mobile devices and Chrome where playback was not within a user interaction."),v._ended=!0,v._paused=!0})):d||(f._playLock=!1,T(),f._emit("play",v._id)),x.playbackRate=v._rate,x.paused){f._emit("playerror",v._id,"Playback was unable to start. This is most commonly an issue on mobile devices and Chrome where playback was not within a user interaction.");return}c!=="__default"||v._loop?f._endTimers[v._id]=setTimeout(f._ended.bind(f,v),E):(f._endTimers[v._id]=function(){f._ended(v),x.removeEventListener("ended",f._endTimers[v._id],!1)},x.addEventListener("ended",f._endTimers[v._id],!1))}catch(R){f._emit("playerror",v._id,R)}};x.src==="data:audio/wav;base64,UklGRigAAABXQVZFZm10IBIAAAABAAEARKwAAIhYAQACABAAAABkYXRhAgAAAAEA"&&(x.src=f._src,x.load());var N=window&&window.ejecta||!x.readyState&&e._navigator.isCocoonJS;if(x.readyState>=3||N)L();else{f._playLock=!0,f._state="loading";var H=function(){f._state="loaded",L(),x.removeEventListener(e._canPlayEvent,H,!1)};x.addEventListener(e._canPlayEvent,H,!1),f._clearTimer(v._id)}}return v._id},pause:function(c){var d=this;if(d._state!=="loaded"||d._playLock)return d._queue.push({event:"pause",action:function(){d.pause(c)}}),d;for(var f=d._getSoundIds(c),g=0;g<f.length;g++){d._clearTimer(f[g]);var y=d._soundById(f[g]);if(y&&!y._paused&&(y._seek=d.seek(f[g]),y._rateSeek=0,y._paused=!0,d._stopFade(f[g]),y._node))if(d._webAudio){if(!y._node.bufferSource)continue;typeof y._node.bufferSource.stop>"u"?y._node.bufferSource.noteOff(0):y._node.bufferSource.stop(0),d._cleanBuffer(y._node)}else(!isNaN(y._node.duration)||y._node.duration===1/0)&&y._node.pause();arguments[1]||d._emit("pause",y?y._id:null)}return d},stop:function(c,d){var f=this;if(f._state!=="loaded"||f._playLock)return f._queue.push({event:"stop",action:function(){f.stop(c)}}),f;for(var g=f._getSoundIds(c),y=0;y<g.length;y++){f._clearTimer(g[y]);var m=f._soundById(g[y]);m&&(m._seek=m._start||0,m._rateSeek=0,m._paused=!0,m._ended=!0,f._stopFade(g[y]),m._node&&(f._webAudio?m._node.bufferSource&&(typeof m._node.bufferSource.stop>"u"?m._node.bufferSource.noteOff(0):m._node.bufferSource.stop(0),f._cleanBuffer(m._node)):(!isNaN(m._node.duration)||m._node.duration===1/0)&&(m._node.currentTime=m._start||0,m._node.pause(),m._node.duration===1/0&&f._clearSound(m._node))),d||f._emit("stop",m._id))}return f},mute:function(c,d){var f=this;if(f._state!=="loaded"||f._playLock)return f._queue.push({event:"mute",action:function(){f.mute(c,d)}}),f;if(typeof d>"u")if(typeof c=="boolean")f._muted=c;else return f._muted;for(var g=f._getSoundIds(d),y=0;y<g.length;y++){var m=f._soundById(g[y]);m&&(m._muted=c,m._interval&&f._stopFade(m._id),f._webAudio&&m._node?m._node.gain.setValueAtTime(c?0:m._volume,e.ctx.currentTime):m._node&&(m._node.muted=e._muted?!0:c),f._emit("mute",m._id))}return f},volume:function(){var c=this,d=arguments,f,g;if(d.length===0)return c._volume;if(d.length===1||d.length===2&&typeof d[1]>"u"){var y=c._getSoundIds(),m=y.indexOf(d[0]);m>=0?g=parseInt(d[0],10):f=parseFloat(d[0])}else d.length>=2&&(f=parseFloat(d[0]),g=parseInt(d[1],10));var v;if(typeof f<"u"&&f>=0&&f<=1){if(c._state!=="loaded"||c._playLock)return c._queue.push({event:"volume",action:function(){c.volume.apply(c,d)}}),c;typeof g>"u"&&(c._volume=f),g=c._getSoundIds(g);for(var _=0;_<g.length;_++)v=c._soundById(g[_]),v&&(v._volume=f,d[2]||c._stopFade(g[_]),c._webAudio&&v._node&&!v._muted?v._node.gain.setValueAtTime(f,e.ctx.currentTime):v._node&&!v._muted&&(v._node.volume=f*e.volume()),c._emit("volume",v._id))}else return v=g?c._soundById(g):c._sounds[0],v?v._volume:0;return c},fade:function(c,d,f,g){var y=this;if(y._state!=="loaded"||y._playLock)return y._queue.push({event:"fade",action:function(){y.fade(c,d,f,g)}}),y;c=Math.min(Math.max(0,parseFloat(c)),1),d=Math.min(Math.max(0,parseFloat(d)),1),f=parseFloat(f),y.volume(c,g);for(var m=y._getSoundIds(g),v=0;v<m.length;v++){var _=y._soundById(m[v]);if(_){if(g||y._stopFade(m[v]),y._webAudio&&!_._muted){var w=e.ctx.currentTime,S=w+f/1e3;_._volume=c,_._node.gain.setValueAtTime(c,w),_._node.gain.linearRampToValueAtTime(d,S)}y._startFadeInterval(_,c,d,f,m[v],typeof g>"u")}}return y},_startFadeInterval:function(c,d,f,g,y,m){var v=this,_=d,w=f-d,S=Math.abs(w/.01),E=Math.max(4,S>0?g/S:g),A=Date.now();c._fadeTo=f,c._interval=setInterval(function(){var I=(Date.now()-A)/g;A=Date.now(),_+=w*I,_=Math.round(_*100)/100,w<0?_=Math.max(f,_):_=Math.min(f,_),v._webAudio?c._volume=_:v.volume(_,c._id,!0),m&&(v._volume=_),(f<d&&_<=f||f>d&&_>=f)&&(clearInterval(c._interval),c._interval=null,c._fadeTo=null,v.volume(f,c._id),v._emit("fade",c._id))},E)},_stopFade:function(c){var d=this,f=d._soundById(c);return f&&f._interval&&(d._webAudio&&f._node.gain.cancelScheduledValues(e.ctx.currentTime),clearInterval(f._interval),f._interval=null,d.volume(f._fadeTo,c),f._fadeTo=null,d._emit("fade",c)),d},loop:function(){var c=this,d=arguments,f,g,y;if(d.length===0)return c._loop;if(d.length===1)if(typeof d[0]=="boolean")f=d[0],c._loop=f;else return y=c._soundById(parseInt(d[0],10)),y?y._loop:!1;else d.length===2&&(f=d[0],g=parseInt(d[1],10));for(var m=c._getSoundIds(g),v=0;v<m.length;v++)y=c._soundById(m[v]),y&&(y._loop=f,c._webAudio&&y._node&&y._node.bufferSource&&(y._node.bufferSource.loop=f,f&&(y._node.bufferSource.loopStart=y._start||0,y._node.bufferSource.loopEnd=y._stop,c.playing(m[v])&&(c.pause(m[v],!0),c.play(m[v],!0)))));return c},rate:function(){var c=this,d=arguments,f,g;if(d.length===0)g=c._sounds[0]._id;else if(d.length===1){var y=c._getSoundIds(),m=y.indexOf(d[0]);m>=0?g=parseInt(d[0],10):f=parseFloat(d[0])}else d.length===2&&(f=parseFloat(d[0]),g=parseInt(d[1],10));var v;if(typeof f=="number"){if(c._state!=="loaded"||c._playLock)return c._queue.push({event:"rate",action:function(){c.rate.apply(c,d)}}),c;typeof g>"u"&&(c._rate=f),g=c._getSoundIds(g);for(var _=0;_<g.length;_++)if(v=c._soundById(g[_]),v){c.playing(g[_])&&(v._rateSeek=c.seek(g[_]),v._playStart=c._webAudio?e.ctx.currentTime:v._playStart),v._rate=f,c._webAudio&&v._node&&v._node.bufferSource?v._node.bufferSource.playbackRate.setValueAtTime(f,e.ctx.currentTime):v._node&&(v._node.playbackRate=f);var w=c.seek(g[_]),S=(c._sprite[v._sprite][0]+c._sprite[v._sprite][1])/1e3-w,E=S*1e3/Math.abs(v._rate);(c._endTimers[g[_]]||!v._paused)&&(c._clearTimer(g[_]),c._endTimers[g[_]]=setTimeout(c._ended.bind(c,v),E)),c._emit("rate",v._id)}}else return v=c._soundById(g),v?v._rate:c._rate;return c},seek:function(){var c=this,d=arguments,f,g;if(d.length===0)c._sounds.length&&(g=c._sounds[0]._id);else if(d.length===1){var y=c._getSoundIds(),m=y.indexOf(d[0]);m>=0?g=parseInt(d[0],10):c._sounds.length&&(g=c._sounds[0]._id,f=parseFloat(d[0]))}else d.length===2&&(f=parseFloat(d[0]),g=parseInt(d[1],10));if(typeof g>"u")return 0;if(typeof f=="number"&&(c._state!=="loaded"||c._playLock))return c._queue.push({event:"seek",action:function(){c.seek.apply(c,d)}}),c;var v=c._soundById(g);if(v)if(typeof f=="number"&&f>=0){var _=c.playing(g);_&&c.pause(g,!0),v._seek=f,v._ended=!1,c._clearTimer(g),!c._webAudio&&v._node&&!isNaN(v._node.duration)&&(v._node.currentTime=f);var w=function(){_&&c.play(g,!0),c._emit("seek",g)};if(_&&!c._webAudio){var S=function(){c._playLock?setTimeout(S,0):w()};setTimeout(S,0)}else w()}else if(c._webAudio){var E=c.playing(g)?e.ctx.currentTime-v._playStart:0,A=v._rateSeek?v._rateSeek-v._seek:0;return v._seek+(A+E*Math.abs(v._rate))}else return v._node.currentTime;return c},playing:function(c){var d=this;if(typeof c=="number"){var f=d._soundById(c);return f?!f._paused:!1}for(var g=0;g<d._sounds.length;g++)if(!d._sounds[g]._paused)return!0;return!1},duration:function(c){var d=this,f=d._duration,g=d._soundById(c);return g&&(f=d._sprite[g._sprite][1]/1e3),f},state:function(){return this._state},unload:function(){for(var c=this,d=c._sounds,f=0;f<d.length;f++)d[f]._paused||c.stop(d[f]._id),c._webAudio||(c._clearSound(d[f]._node),d[f]._node.removeEventListener("error",d[f]._errorFn,!1),d[f]._node.removeEventListener(e._canPlayEvent,d[f]._loadFn,!1),d[f]._node.removeEventListener("ended",d[f]._endFn,!1),e._releaseHtml5Audio(d[f]._node)),delete d[f]._node,c._clearTimer(d[f]._id);var g=e._howls.indexOf(c);g>=0&&e._howls.splice(g,1);var y=!0;for(f=0;f<e._howls.length;f++)if(e._howls[f]._src===c._src||c._src.indexOf(e._howls[f]._src)>=0){y=!1;break}return i&&y&&delete i[c._src],e.noAudio=!1,c._state="unloaded",c._sounds=[],c=null,null},on:function(c,d,f,g){var y=this,m=y["_on"+c];return typeof d=="function"&&m.push(g?{id:f,fn:d,once:g}:{id:f,fn:d}),y},off:function(c,d,f){var g=this,y=g["_on"+c],m=0;if(typeof d=="number"&&(f=d,d=null),d||f)for(m=0;m<y.length;m++){var v=f===y[m].id;if(d===y[m].fn&&v||!d&&v){y.splice(m,1);break}}else if(c)g["_on"+c]=[];else{var _=Object.keys(g);for(m=0;m<_.length;m++)_[m].indexOf("_on")===0&&Array.isArray(g[_[m]])&&(g[_[m]]=[])}return g},once:function(c,d,f){var g=this;return g.on(c,d,f,1),g},_emit:function(c,d,f){for(var g=this,y=g["_on"+c],m=y.length-1;m>=0;m--)(!y[m].id||y[m].id===d||c==="load")&&(setTimeout(function(v){v.call(this,d,f)}.bind(g,y[m].fn),0),y[m].once&&g.off(c,y[m].fn,y[m].id));return g._loadQueue(c),g},_loadQueue:function(c){var d=this;if(d._queue.length>0){var f=d._queue[0];f.event===c&&(d._queue.shift(),d._loadQueue()),c||f.action()}return d},_ended:function(c){var d=this,f=c._sprite;if(!d._webAudio&&c._node&&!c._node.paused&&!c._node.ended&&c._node.currentTime<c._stop)return setTimeout(d._ended.bind(d,c),100),d;var g=!!(c._loop||d._sprite[f][2]);if(d._emit("end",c._id),!d._webAudio&&g&&d.stop(c._id,!0).play(c._id),d._webAudio&&g){d._emit("play",c._id),c._seek=c._start||0,c._rateSeek=0,c._playStart=e.ctx.currentTime;var y=(c._stop-c._start)*1e3/Math.abs(c._rate);d._endTimers[c._id]=setTimeout(d._ended.bind(d,c),y)}return d._webAudio&&!g&&(c._paused=!0,c._ended=!0,c._seek=c._start||0,c._rateSeek=0,d._clearTimer(c._id),d._cleanBuffer(c._node),e._autoSuspend()),!d._webAudio&&!g&&d.stop(c._id,!0),d},_clearTimer:function(c){var d=this;if(d._endTimers[c]){if(typeof d._endTimers[c]!="function")clearTimeout(d._endTimers[c]);else{var f=d._soundById(c);f&&f._node&&f._node.removeEventListener("ended",d._endTimers[c],!1)}delete d._endTimers[c]}return d},_soundById:function(c){for(var d=this,f=0;f<d._sounds.length;f++)if(c===d._sounds[f]._id)return d._sounds[f];return null},_inactiveSound:function(){var c=this;c._drain();for(var d=0;d<c._sounds.length;d++)if(c._sounds[d]._ended)return c._sounds[d].reset();return new s(c)},_drain:function(){var c=this,d=c._pool,f=0,g=0;if(!(c._sounds.length<d)){for(g=0;g<c._sounds.length;g++)c._sounds[g]._ended&&f++;for(g=c._sounds.length-1;g>=0;g--){if(f<=d)return;c._sounds[g]._ended&&(c._webAudio&&c._sounds[g]._node&&c._sounds[g]._node.disconnect(0),c._sounds.splice(g,1),f--)}}},_getSoundIds:function(c){var d=this;if(typeof c>"u"){for(var f=[],g=0;g<d._sounds.length;g++)f.push(d._sounds[g]._id);return f}else return[c]},_refreshBuffer:function(c){var d=this;return c._node.bufferSource=e.ctx.createBufferSource(),c._node.bufferSource.buffer=i[d._src],c._panner?c._node.bufferSource.connect(c._panner):c._node.bufferSource.connect(c._node),c._node.bufferSource.loop=c._loop,c._loop&&(c._node.bufferSource.loopStart=c._start||0,c._node.bufferSource.loopEnd=c._stop||0),c._node.bufferSource.playbackRate.setValueAtTime(c._rate,e.ctx.currentTime),d},_cleanBuffer:function(c){var d=this,f=e._navigator&&e._navigator.vendor.indexOf("Apple")>=0;if(!c.bufferSource)return d;if(e._scratchBuffer&&c.bufferSource&&(c.bufferSource.onended=null,c.bufferSource.disconnect(0),f))try{c.bufferSource.buffer=e._scratchBuffer}catch{}return c.bufferSource=null,d},_clearSound:function(c){var d=/MSIE |Trident\//.test(e._navigator&&e._navigator.userAgent);d||(c.src="data:audio/wav;base64,UklGRigAAABXQVZFZm10IBIAAAABAAEARKwAAIhYAQACABAAAABkYXRhAgAAAAEA")}};var s=function(c){this._parent=c,this.init()};s.prototype={init:function(){var c=this,d=c._parent;return c._muted=d._muted,c._loop=d._loop,c._volume=d._volume,c._rate=d._rate,c._seek=0,c._paused=!0,c._ended=!0,c._sprite="__default",c._id=++e._counter,d._sounds.push(c),c.create(),c},create:function(){var c=this,d=c._parent,f=e._muted||c._muted||c._parent._muted?0:c._volume;return d._webAudio?(c._node=typeof e.ctx.createGain>"u"?e.ctx.createGainNode():e.ctx.createGain(),c._node.gain.setValueAtTime(f,e.ctx.currentTime),c._node.paused=!0,c._node.connect(e.masterGain)):e.noAudio||(c._node=e._obtainHtml5Audio(),c._errorFn=c._errorListener.bind(c),c._node.addEventListener("error",c._errorFn,!1),c._loadFn=c._loadListener.bind(c),c._node.addEventListener(e._canPlayEvent,c._loadFn,!1),c._endFn=c._endListener.bind(c),c._node.addEventListener("ended",c._endFn,!1),c._node.src=d._src,c._node.preload=d._preload===!0?"auto":d._preload,c._node.volume=f*e.volume(),c._node.load()),c},reset:function(){var c=this,d=c._parent;return c._muted=d._muted,c._loop=d._loop,c._volume=d._volume,c._rate=d._rate,c._seek=0,c._rateSeek=0,c._paused=!0,c._ended=!0,c._sprite="__default",c._id=++e._counter,c},_errorListener:function(){var c=this;c._parent._emit("loaderror",c._id,c._node.error?c._node.error.code:0),c._node.removeEventListener("error",c._errorFn,!1)},_loadListener:function(){var c=this,d=c._parent;d._duration=Math.ceil(c._node.duration*10)/10,Object.keys(d._sprite).length===0&&(d._sprite={__default:[0,d._duration*1e3]}),d._state!=="loaded"&&(d._state="loaded",d._emit("load"),d._loadQueue()),c._node.removeEventListener(e._canPlayEvent,c._loadFn,!1)},_endListener:function(){var c=this,d=c._parent;d._duration===1/0&&(d._duration=Math.ceil(c._node.duration*10)/10,d._sprite.__default[1]===1/0&&(d._sprite.__default[1]=d._duration*1e3),d._ended(c)),c._node.removeEventListener("ended",c._endFn,!1)}};var i={},o=function(c){var d=c._src;if(i[d]){c._duration=i[d].duration,u(c);return}if(/^data:[^;]+;base64,/.test(d)){for(var f=atob(d.split(",")[1]),g=new Uint8Array(f.length),y=0;y<f.length;++y)g[y]=f.charCodeAt(y);l(g.buffer,c)}else{var m=new XMLHttpRequest;m.open(c._xhr.method,d,!0),m.withCredentials=c._xhr.withCredentials,m.responseType="arraybuffer",c._xhr.headers&&Object.keys(c._xhr.headers).forEach(function(v){m.setRequestHeader(v,c._xhr.headers[v])}),m.onload=function(){var v=(m.status+"")[0];if(v!=="0"&&v!=="2"&&v!=="3"){c._emit("loaderror",null,"Failed loading audio file with status: "+m.status+".");return}l(m.response,c)},m.onerror=function(){c._webAudio&&(c._html5=!0,c._webAudio=!1,c._sounds=[],delete i[d],c.load())},a(m)}},a=function(c){try{c.send()}catch{c.onerror()}},l=function(c,d){var f=function(){d._emit("loaderror",null,"Decoding audio data failed.")},g=function(y){y&&d._sounds.length>0?(i[d._src]=y,u(d,y)):f()};typeof Promise<"u"&&e.ctx.decodeAudioData.length===1?e.ctx.decodeAudioData(c).then(g).catch(f):e.ctx.decodeAudioData(c,g,f)},u=function(c,d){d&&!c._duration&&(c._duration=d.duration),Object.keys(c._sprite).length===0&&(c._sprite={__default:[0,c._duration*1e3]}),c._state!=="loaded"&&(c._state="loaded",c._emit("load"),c._loadQueue())},h=function(){if(e.usingWebAudio){try{typeof AudioContext<"u"?e.ctx=new AudioContext:typeof webkitAudioContext<"u"?e.ctx=new webkitAudioContext:e.usingWebAudio=!1}catch{e.usingWebAudio=!1}e.ctx||(e.usingWebAudio=!1);var c=/iP(hone|od|ad)/.test(e._navigator&&e._navigator.platform),d=e._navigator&&e._navigator.appVersion.match(/OS (\d+)_(\d+)_?(\d+)?/),f=d?parseInt(d[1],10):null;if(c&&f&&f<9){var g=/safari/.test(e._navigator&&e._navigator.userAgent.toLowerCase());e._navigator&&!g&&(e.usingWebAudio=!1)}e.usingWebAudio&&(e.masterGain=typeof e.ctx.createGain>"u"?e.ctx.createGainNode():e.ctx.createGain(),e.masterGain.gain.setValueAtTime(e._muted?0:e._volume,e.ctx.currentTime),e.masterGain.connect(e.ctx.destination)),e._setup()}};n.Howler=e,n.Howl=r,typeof bo<"u"?(bo.HowlerGlobal=t,bo.Howler=e,bo.Howl=r,bo.Sound=s):typeof window<"u"&&(window.HowlerGlobal=t,window.Howler=e,window.Howl=r,window.Sound=s)})();/*!
 *  Spatial Plugin - Adds support for stereo and 3D audio where Web Audio is supported.
 *  
 *  howler.js v2.2.4
 *  howlerjs.com
 *
 *  (c) 2013-2020, James Simpson of GoldFire Studios
 *  goldfirestudios.com
 *
 *  MIT License
 */(function(){HowlerGlobal.prototype._pos=[0,0,0],HowlerGlobal.prototype._orientation=[0,0,-1,0,1,0],HowlerGlobal.prototype.stereo=function(e){var r=this;if(!r.ctx||!r.ctx.listener)return r;for(var s=r._howls.length-1;s>=0;s--)r._howls[s].stereo(e);return r},HowlerGlobal.prototype.pos=function(e,r,s){var i=this;if(!i.ctx||!i.ctx.listener)return i;if(r=typeof r!="number"?i._pos[1]:r,s=typeof s!="number"?i._pos[2]:s,typeof e=="number")i._pos=[e,r,s],typeof i.ctx.listener.positionX<"u"?(i.ctx.listener.positionX.setTargetAtTime(i._pos[0],Howler.ctx.currentTime,.1),i.ctx.listener.positionY.setTargetAtTime(i._pos[1],Howler.ctx.currentTime,.1),i.ctx.listener.positionZ.setTargetAtTime(i._pos[2],Howler.ctx.currentTime,.1)):i.ctx.listener.setPosition(i._pos[0],i._pos[1],i._pos[2]);else return i._pos;return i},HowlerGlobal.prototype.orientation=function(e,r,s,i,o,a){var l=this;if(!l.ctx||!l.ctx.listener)return l;var u=l._orientation;if(r=typeof r!="number"?u[1]:r,s=typeof s!="number"?u[2]:s,i=typeof i!="number"?u[3]:i,o=typeof o!="number"?u[4]:o,a=typeof a!="number"?u[5]:a,typeof e=="number")l._orientation=[e,r,s,i,o,a],typeof l.ctx.listener.forwardX<"u"?(l.ctx.listener.forwardX.setTargetAtTime(e,Howler.ctx.currentTime,.1),l.ctx.listener.forwardY.setTargetAtTime(r,Howler.ctx.currentTime,.1),l.ctx.listener.forwardZ.setTargetAtTime(s,Howler.ctx.currentTime,.1),l.ctx.listener.upX.setTargetAtTime(i,Howler.ctx.currentTime,.1),l.ctx.listener.upY.setTargetAtTime(o,Howler.ctx.currentTime,.1),l.ctx.listener.upZ.setTargetAtTime(a,Howler.ctx.currentTime,.1)):l.ctx.listener.setOrientation(e,r,s,i,o,a);else return u;return l},Howl.prototype.init=function(e){return function(r){var s=this;return s._orientation=r.orientation||[1,0,0],s._stereo=r.stereo||null,s._pos=r.pos||null,s._pannerAttr={coneInnerAngle:typeof r.coneInnerAngle<"u"?r.coneInnerAngle:360,coneOuterAngle:typeof r.coneOuterAngle<"u"?r.coneOuterAngle:360,coneOuterGain:typeof r.coneOuterGain<"u"?r.coneOuterGain:0,distanceModel:typeof r.distanceModel<"u"?r.distanceModel:"inverse",maxDistance:typeof r.maxDistance<"u"?r.maxDistance:1e4,panningModel:typeof r.panningModel<"u"?r.panningModel:"HRTF",refDistance:typeof r.refDistance<"u"?r.refDistance:1,rolloffFactor:typeof r.rolloffFactor<"u"?r.rolloffFactor:1},s._onstereo=r.onstereo?[{fn:r.onstereo}]:[],s._onpos=r.onpos?[{fn:r.onpos}]:[],s._onorientation=r.onorientation?[{fn:r.onorientation}]:[],e.call(this,r)}}(Howl.prototype.init),Howl.prototype.stereo=function(e,r){var s=this;if(!s._webAudio)return s;if(s._state!=="loaded")return s._queue.push({event:"stereo",action:function(){s.stereo(e,r)}}),s;var i=typeof Howler.ctx.createStereoPanner>"u"?"spatial":"stereo";if(typeof r>"u")if(typeof e=="number")s._stereo=e,s._pos=[e,0,0];else return s._stereo;for(var o=s._getSoundIds(r),a=0;a<o.length;a++){var l=s._soundById(o[a]);if(l)if(typeof e=="number")l._stereo=e,l._pos=[e,0,0],l._node&&(l._pannerAttr.panningModel="equalpower",(!l._panner||!l._panner.pan)&&t(l,i),i==="spatial"?typeof l._panner.positionX<"u"?(l._panner.positionX.setValueAtTime(e,Howler.ctx.currentTime),l._panner.positionY.setValueAtTime(0,Howler.ctx.currentTime),l._panner.positionZ.setValueAtTime(0,Howler.ctx.currentTime)):l._panner.setPosition(e,0,0):l._panner.pan.setValueAtTime(e,Howler.ctx.currentTime)),s._emit("stereo",l._id);else return l._stereo}return s},Howl.prototype.pos=function(e,r,s,i){var o=this;if(!o._webAudio)return o;if(o._state!=="loaded")return o._queue.push({event:"pos",action:function(){o.pos(e,r,s,i)}}),o;if(r=typeof r!="number"?0:r,s=typeof s!="number"?-.5:s,typeof i>"u")if(typeof e=="number")o._pos=[e,r,s];else return o._pos;for(var a=o._getSoundIds(i),l=0;l<a.length;l++){var u=o._soundById(a[l]);if(u)if(typeof e=="number")u._pos=[e,r,s],u._node&&((!u._panner||u._panner.pan)&&t(u,"spatial"),typeof u._panner.positionX<"u"?(u._panner.positionX.setValueAtTime(e,Howler.ctx.currentTime),u._panner.positionY.setValueAtTime(r,Howler.ctx.currentTime),u._panner.positionZ.setValueAtTime(s,Howler.ctx.currentTime)):u._panner.setPosition(e,r,s)),o._emit("pos",u._id);else return u._pos}return o},Howl.prototype.orientation=function(e,r,s,i){var o=this;if(!o._webAudio)return o;if(o._state!=="loaded")return o._queue.push({event:"orientation",action:function(){o.orientation(e,r,s,i)}}),o;if(r=typeof r!="number"?o._orientation[1]:r,s=typeof s!="number"?o._orientation[2]:s,typeof i>"u")if(typeof e=="number")o._orientation=[e,r,s];else return o._orientation;for(var a=o._getSoundIds(i),l=0;l<a.length;l++){var u=o._soundById(a[l]);if(u)if(typeof e=="number")u._orientation=[e,r,s],u._node&&(u._panner||(u._pos||(u._pos=o._pos||[0,0,-.5]),t(u,"spatial")),typeof u._panner.orientationX<"u"?(u._panner.orientationX.setValueAtTime(e,Howler.ctx.currentTime),u._panner.orientationY.setValueAtTime(r,Howler.ctx.currentTime),u._panner.orientationZ.setValueAtTime(s,Howler.ctx.currentTime)):u._panner.setOrientation(e,r,s)),o._emit("orientation",u._id);else return u._orientation}return o},Howl.prototype.pannerAttr=function(){var e=this,r=arguments,s,i,o;if(!e._webAudio)return e;if(r.length===0)return e._pannerAttr;if(r.length===1)if(typeof r[0]=="object")s=r[0],typeof i>"u"&&(s.pannerAttr||(s.pannerAttr={coneInnerAngle:s.coneInnerAngle,coneOuterAngle:s.coneOuterAngle,coneOuterGain:s.coneOuterGain,distanceModel:s.distanceModel,maxDistance:s.maxDistance,refDistance:s.refDistance,rolloffFactor:s.rolloffFactor,panningModel:s.panningModel}),e._pannerAttr={coneInnerAngle:typeof s.pannerAttr.coneInnerAngle<"u"?s.pannerAttr.coneInnerAngle:e._coneInnerAngle,coneOuterAngle:typeof s.pannerAttr.coneOuterAngle<"u"?s.pannerAttr.coneOuterAngle:e._coneOuterAngle,coneOuterGain:typeof s.pannerAttr.coneOuterGain<"u"?s.pannerAttr.coneOuterGain:e._coneOuterGain,distanceModel:typeof s.pannerAttr.distanceModel<"u"?s.pannerAttr.distanceModel:e._distanceModel,maxDistance:typeof s.pannerAttr.maxDistance<"u"?s.pannerAttr.maxDistance:e._maxDistance,refDistance:typeof s.pannerAttr.refDistance<"u"?s.pannerAttr.refDistance:e._refDistance,rolloffFactor:typeof s.pannerAttr.rolloffFactor<"u"?s.pannerAttr.rolloffFactor:e._rolloffFactor,panningModel:typeof s.pannerAttr.panningModel<"u"?s.pannerAttr.panningModel:e._panningModel});else return o=e._soundById(parseInt(r[0],10)),o?o._pannerAttr:e._pannerAttr;else r.length===2&&(s=r[0],i=parseInt(r[1],10));for(var a=e._getSoundIds(i),l=0;l<a.length;l++)if(o=e._soundById(a[l]),o){var u=o._pannerAttr;u={coneInnerAngle:typeof s.coneInnerAngle<"u"?s.coneInnerAngle:u.coneInnerAngle,coneOuterAngle:typeof s.coneOuterAngle<"u"?s.coneOuterAngle:u.coneOuterAngle,coneOuterGain:typeof s.coneOuterGain<"u"?s.coneOuterGain:u.coneOuterGain,distanceModel:typeof s.distanceModel<"u"?s.distanceModel:u.distanceModel,maxDistance:typeof s.maxDistance<"u"?s.maxDistance:u.maxDistance,refDistance:typeof s.refDistance<"u"?s.refDistance:u.refDistance,rolloffFactor:typeof s.rolloffFactor<"u"?s.rolloffFactor:u.rolloffFactor,panningModel:typeof s.panningModel<"u"?s.panningModel:u.panningModel};var h=o._panner;h||(o._pos||(o._pos=e._pos||[0,0,-.5]),t(o,"spatial"),h=o._panner),h.coneInnerAngle=u.coneInnerAngle,h.coneOuterAngle=u.coneOuterAngle,h.coneOuterGain=u.coneOuterGain,h.distanceModel=u.distanceModel,h.maxDistance=u.maxDistance,h.refDistance=u.refDistance,h.rolloffFactor=u.rolloffFactor,h.panningModel=u.panningModel}return e},Sound.prototype.init=function(e){return function(){var r=this,s=r._parent;r._orientation=s._orientation,r._stereo=s._stereo,r._pos=s._pos,r._pannerAttr=s._pannerAttr,e.call(this),r._stereo?s.stereo(r._stereo):r._pos&&s.pos(r._pos[0],r._pos[1],r._pos[2],r._id)}}(Sound.prototype.init),Sound.prototype.reset=function(e){return function(){var r=this,s=r._parent;return r._orientation=s._orientation,r._stereo=s._stereo,r._pos=s._pos,r._pannerAttr=s._pannerAttr,r._stereo?s.stereo(r._stereo):r._pos?s.pos(r._pos[0],r._pos[1],r._pos[2],r._id):r._panner&&(r._panner.disconnect(0),r._panner=void 0,s._refreshBuffer(r)),e.call(this)}}(Sound.prototype.reset);var t=function(e,r){r=r||"spatial",r==="spatial"?(e._panner=Howler.ctx.createPanner(),e._panner.coneInnerAngle=e._pannerAttr.coneInnerAngle,e._panner.coneOuterAngle=e._pannerAttr.coneOuterAngle,e._panner.coneOuterGain=e._pannerAttr.coneOuterGain,e._panner.distanceModel=e._pannerAttr.distanceModel,e._panner.maxDistance=e._pannerAttr.maxDistance,e._panner.refDistance=e._pannerAttr.refDistance,e._panner.rolloffFactor=e._pannerAttr.rolloffFactor,e._panner.panningModel=e._pannerAttr.panningModel,typeof e._panner.positionX<"u"?(e._panner.positionX.setValueAtTime(e._pos[0],Howler.ctx.currentTime),e._panner.positionY.setValueAtTime(e._pos[1],Howler.ctx.currentTime),e._panner.positionZ.setValueAtTime(e._pos[2],Howler.ctx.currentTime)):e._panner.setPosition(e._pos[0],e._pos[1],e._pos[2]),typeof e._panner.orientationX<"u"?(e._panner.orientationX.setValueAtTime(e._orientation[0],Howler.ctx.currentTime),e._panner.orientationY.setValueAtTime(e._orientation[1],Howler.ctx.currentTime),e._panner.orientationZ.setValueAtTime(e._orientation[2],Howler.ctx.currentTime)):e._panner.setOrientation(e._orientation[0],e._orientation[1],e._orientation[2])):(e._panner=Howler.ctx.createStereoPanner(),e._panner.pan.setValueAtTime(e._stereo,Howler.ctx.currentTime)),e._panner.connect(e._node),e._paused||e._parent.pause(e._id,!0).play(e._id,!0)}})()}(au)),au}var Qt=DE();const{random:wd,round:ME}=Math,Uv=.6,ft={bleep:new Qt.Howl({src:"/sounds/bleep.wav"}),blink:new Qt.Howl({src:"/sounds/blink.wav",rate:Uv}),gameOver:new Qt.Howl({src:"/sounds/game-over.wav"}),generate:new Qt.Howl({src:"/sounds/generate.wav"}),hit:new Qt.Howl({src:"/sounds/hit.wav"}),kicks:[new Qt.Howl({src:"/sounds/kick-1.wav"}),new Qt.Howl({src:"/sounds/kick-2.wav"})],lowEnergy:new Qt.Howl({src:"/sounds/low-energy.wav"}),plus:new Qt.Howl({src:"/sounds/plus.wav"}),slideIn:new Qt.Howl({src:"/sounds/slide-in.wav"}),slideMove:new Qt.Howl({src:"/sounds/slide-move.wav"}),slideOut:new Qt.Howl({src:"/sounds/slide-out.wav"}),turnOn:new Qt.Howl({src:"/sounds/turn-on.wav"}),wordUp:new Qt.Howl({src:"/sounds/word-up.wav"})};function LE(){ft.bleep.play()}function BE(){const n=(t=.02)=>{ft.blink.rate(ft.blink.rate()+t),ft.blink.play()};n(),setTimeout(n,200),setTimeout(()=>n(.04),400)}function _d(){ft.lowEnergy.play()}function Vv(){ft.plus.play()}function NE(){ft.gameOver.play()}function RE(){ft.generate.play()}function Hv(n=0){ft.hit.rate(1-(n||10)/36),ft.hit.play()}function OE(){const n=ft.kicks[ME(wd())];n.rate(1-(wd()-.5)/2),n.play()}function FE(){ft.newRecord.play()}function Sd(){ft.slideIn.play()}function Ed(n=0){ft.slideMove.rate(1+n/27),ft.slideMove.play()}function zv(){ft.slideOut.play()}function $E(){ft.turnOn.rate(1-(wd()-.5)/10),ft.turnOn.play()}function qv(){ft.wordUp.play()}function UE(){ft.blink.rate(Uv)}const VE=Object.freeze(Object.defineProperty({__proto__:null,playBleep:LE,playBlink:BE,playGameOver:NE,playGenerate:RE,playHit:Hv,playKick:OE,playLowEnergy:_d,playNewRecord:FE,playPlus:Vv,playSlideIn:Sd,playSlideMove:Ed,playSlideOut:zv,playTurnOn:$E,playWordUp:qv,reset:UE},Symbol.toStringTag,{value:"Module"}));function qh(n){return new Promise((t,e)=>{n.oncomplete=n.onsuccess=()=>t(n.result),n.onabort=n.onerror=()=>e(n.error)})}function Wv(n,t){const e=indexedDB.open(n);e.onupgradeneeded=()=>e.result.createObjectStore(t);const r=qh(e);return(s,i)=>r.then(o=>i(o.transaction(t,s).objectStore(t)))}let cu;function Gv(){return cu||(cu=Wv("keyval-store","keyval")),cu}function Tp(n,t=Gv()){return t("readonly",e=>qh(e.get(n)))}function Cp(n,t,e=Gv()){return e("readwrite",r=>(r.put(t,n),qh(r.transaction)))}function Sl(n,t){const e=mt(t),r=localStorage.getItem(n);return r?e.set(JSON.parse(r)):localStorage.setItem(n,JSON.stringify(t)),{set(s){localStorage.setItem(n,JSON.stringify(s)),e.set(s)},update(s){this.set(s(Ne(this)))},subscribe:e.subscribe}}function HE(n,t){const e=Wv(n,t);return function(s,i){const o=mt(i);return Tp(s,e).then(a=>{if(a===void 0&&i!==void 0){Cp(s,i,e);return}a!==i&&o.set(a)}),{set(a){Cp(s,a,e).then(()=>o.set(a))},update(a){Tp(s,e).then(l=>this.set(a(l)))},subscribe:o.subscribe}}}const Kv=mt(Fe.cards),El=mt(Fe.energy),va=mt(Fe.log),Yv=mt(Fe.matchedIndexes),zE=Sl(U.moves,Fe.moves),Ft=Sl(U.options,Fe.options),Fr=mt(Fe.phase),Ad=mt(Fe.plusIndex),ba=Sl(U.records,Fe.records),Al=mt(Fe.score),Wh=Sl(U.timestamp,Date.now()),wa=kv([Ft,Wh],([{playerName:n},t])=>zh({playerName:n,timestamp:t})),Ms={cards:Kv,energy:El,log:va,matchedIndexes:Yv,moves:zE,options:Ft,phase:Fr,plusIndex:Ad,records:ba,score:Al,seed:wa,timestamp:Wh,ready:!0};function wo(n,t=0){return Mn(Ms,n,t)}function gr(n,{muteRapid:t=!1}={}){return or(Ms,n,{muteRapid:t})}function Gh(n){_t.set(null),TE(Ms,n)}const Xt=kv([va,Ft,wa],([n,{rapid:t},e])=>{if(!t)return[];if(e!==Xt.seed&&(Xt.seed=e,Xt.prev=[],Xt.rows=[]),n.length===0){const r=Nv(Xt.prev);r&&(Xt.rows=[...Xt.rows,{combo:r,key:performance.now()}],gr(qv),Xt.rows.length>7&&(Xt.rows=Xt.rows.slice(-7)))}else Xt.prev=n;return Xt.rows}),_t=mt(Fe.overlay);var qE=ce('<div tabindex="0" role="button"><!> <div></div> <div></div></div>');function Qv(n,t){if(new.target)return $t({component:Qv,...n});kt(t,!1);const[e,r]=wn(),s=()=>ge(Kv,"$cards",e),i=()=>ge(Ad,"$plusIndex",e),o=()=>ge(Fr,"$phase",e),a=()=>ge(Yv,"$matchedIndexes",e),l=()=>ge(Ft,"$options",e),u=()=>ge(va,"$log",e),h=Y(),c=Y(),d=Y(),f=Y(),g=Y(),y=Y(),m=Y(),v=Y(),_=Y();let w=Y(null),S=null,E=Y(void 0),A=Y(null),I=Y(null),T=Y(null);function x(){return!!b(w)}function V({x:Q=0,y:ne=0}={}){if(!b(c))return{};if(D(),b(w)){S=b(w),Q+=b(w).x,ne+=b(w).y;const Re=Q<0?ze.columns-1:Q%ze.columns,Pt=ne<0?ze.rows-1:ne%ze.rows;return N({x:Re,y:Pt,topEdge:Pt===0&&S&&S.y===ze.rows-1,bottomEdge:Pt===ze.rows-1&&S&&S.y===0})}if(Q!==0)return S?(newValue={x:Q>0?0:ze.columns-1,y:S.y},S=null,N(newValue)):N({x:Math.round(ze.columns/2)+Q+(Q>0?-1:0),y:Math.round(ze.rows/2)+(Q>0?0:-1)});if(ne!==0){if(S){const Re={x:S.x,y:ne>0?0:ze.rows-1};return S=null,N(Re)}return N({x:Math.round(ze.columns/2)+(ne>0?-1:0),y:Math.round(ze.rows/2)+ne+(ne>0?-1:0)})}return b(w)||{}}function L(){if(!x())return;S=null;const Q=s().findIndex(({x:ne,y:Re})=>ne===b(w).x&&Re===b(w).y);Q!==-1&&(xt(Ad,Q),!b(g)&&gr(Vv,{muteRapid:!0}))}function N(Q){x()||gr(Sd);const ne=b(_)[Q.x][Q.y];return gr(()=>Ed(s()[ne].value)),B(w,Q)}function H({savePrev:Q=!1,muteSound:ne=!1}={}){x()&&(S=Q?b(w):null,B(w,null),ne||gr(zv))}function D(){bs(I,b(I).style.animation="none"),b(I).offsetHeight,bs(I,b(I).style.animation=null),bs(T,b(T).style.animation="none"),b(T).offsetHeight,bs(T,b(T).style.animation=null)}function R(Q){if(b(g)||b(E)!==void 0)return;x()||gr(Sd);const ne=s()[Q];ne!==b(w)&&(D(),gr(()=>Ed(ne.value)),S=b(w),B(w,ne))}function P(Q){if(Q===b(A))return;if(Q.classList.contains("card"))return Q;const ne=Q.querySelector(".card");if(ne)return ne;let Re=Q.parentElement;for(;Re;){if(Re.classList.contains("card"))return Re;Re=Re.parentElement}}function k(Q){const ne=P(Q.target);return ne&&Number(ne.dataset.index)}function C(Q){if(!Ms.ready)return;const ne=k(Q);ne>-1&&R(ne)}function O(Q){H({muteSound:o()!==re.idle})}function F(Q){if(b(g))return;const ne=k(Q.detail);ne!==void 0&&(R(ne),b(h)||B(E,ne),Q.detail.type==="mousedown"&&(gr(()=>Hv(s()[ne].value),{}),b(h)&&L()))}function z(Q){b(h)||k(Q.detail)!==b(E)||(B(E,void 0),L(),H())}function G(Q){b(h)||B(E,void 0)}function ee(Q){Q.preventDefault()}wa.subscribe(()=>H({muteSound:!0})),ae(()=>a(),()=>{a().size>0&&H({muteSound:!0})}),ae(()=>(b(h),l()),()=>{(Q=>B(h,Q.rapid))(l())}),ae(()=>(o(),re),()=>{B(c,o()===re.idle)}),ae(()=>(a(),u()),()=>{B(d,a().size>0&&u().length===1)}),ae(()=>(b(c),b(d)),()=>{B(f,!b(c)&&!b(d))}),ae(()=>(b(c),i()),()=>{B(g,!b(c)||i()!==void 0)}),ae(()=>(s(),i()),()=>{B(y,s()[i()])}),ae(()=>(b(m),b(y),b(w)),()=>{B(m,b(y)||b(w)||b(m))}),ae(()=>(b(y),b(w),b(d)),()=>{B(v,b(y)||b(w)||b(d))}),ae(()=>s(),()=>{B(_,wl(s()))}),dr(),Ut();var K=qE();let le;var M=W(K);Is(M,1,s,Oi,(Q,ne,Re)=>{const Pt=Nt(()=>b(ne).x===(b(w)&&b(w).x)&&b(ne).y===(b(w)&&b(w).y)),js=Nt(()=>a().has(Re)),go=Nt(()=>b(E)===Re),Js=Nt(()=>i()===Re);$v(Q,{get card(){return b(ne)},index:Re,get focus(){return b(Pt)},get blink(){return b(js)},get longpress(){return b(go)},get plus(){return b(Js)}})});var ie=J(M,2);let we;ht(ie,Q=>B(I,Q),()=>b(I));var he=J(ie,2);let ve;ht(he,Q=>B(T,Q),()=>b(T)),q(K),Tn(()=>Me("mousemove",K,C)),Tn(()=>Me("mouseleave",K,O)),Tn(()=>Me("longpressstart",K,F)),Tn(()=>Me("longpressfire",K,z)),Tn(()=>Me("longpressend",K,G)),Tn(()=>Me("dblclick",K,ee)),VS(K,Q=>PE?.(Q)),ht(K,Q=>B(A,Q),()=>b(A)),Ze(()=>{le=nt(K,1,"board",null,le,{overflow:b(f),progress:b(g)}),gn(K,"--focus-x",b(m)&&b(m).x),gn(K,"--focus-y",b(m)&&b(m).y),we=nt(ie,1,"slider horizontal",null,we,{blink:b(d),focus:b(v)}),ve=nt(he,1,"slider vertical",null,ve,{blink:b(d),focus:b(v)})}),oe(n,K),Ee(t,"isFocused",x),Ee(t,"shiftFocus",V),Ee(t,"plusFocusedCard",L),Ee(t,"focusCard",N),Ee(t,"blur",H);var je=Tt({isFocused:x,shiftFocus:V,plusFocusedCard:L,focusCard:N,blur:H,$set:Ht,$on:(Q,ne)=>Vt(t,Q,ne)});return r(),je}var WE=ce('<div class="energy"><div><span> </span></div> <div><span> </span></div></div>');function Kh(n,t){if(new.target)return $t({component:Kh,...n});kt(t,!1);const[e,r]=wn(),s=()=>ge(El,"$energy",e),i=()=>ge(Fr,"$phase",e),o=Y(),a=Y(),l=Y(),u=Y(),h=Y(),c=Y(),d=Y();ae(()=>(b(o),s()),()=>{(x=>B(o,x.value))(s())}),ae(()=>b(o),()=>{B(a,b(o)>100)}),ae(()=>(b(o),i(),re),()=>{B(l,b(o)<20&&i()===re.idle)}),ae(()=>(b(l),_d),()=>{b(l)&&gr(_d)}),ae(()=>(b(a),b(o)),()=>{B(u,`
    z-index: ${b(a)?0:1};
    flex: ${(b(a)?200-b(o):b(o))/100};
  `)}),ae(()=>b(a),()=>{B(h,`
    position: ${b(a)?"absolute":"relative"};
  `)}),ae(()=>(b(a),b(o)),()=>{B(c,`
    z-index: ${b(a)?1:0};
    flex: ${b(a)?(b(o)-100)/100:0};
  `)}),ae(()=>(b(a),b(o)),()=>{B(d,`
    position: ${b(a)?"relative":"absolute"};
    left: ${b(a)?`calc(${b(o)>119?0:(b(o)-120)/100} * 128rem)`:0};
  `)}),dr(),Ut();var f=WE(),g=W(f);let y;var m=W(g);let v;var _=W(m,!0);q(m),q(g);var w=J(g,2);let S;var E=W(w);let A;var I=W(E,!0);q(E),q(w),q(f),Ze(()=>{y=nt(g,1,"left-bar",null,y,{warning:b(l)}),Ot(g,"style",b(u)),v=nt(m,1,"left-value",null,v,{warning:b(l)}),Ot(m,"style",b(h)),st(_,b(o)),S=nt(w,1,"right-bar",null,S,{extra:b(a)}),Ot(w,"style",b(c)),A=nt(E,1,"right-value",null,A,{warning:b(l)}),Ot(E,"style",b(d)),st(I,b(o))}),oe(n,f);var T=Tt({$set:Ht,$on:(x,V)=>Vt(t,x,V)});return r(),T}const GE=n=>n;function Zv(n){const t=n-1;return t*t*t+1}function KE(n){return n<.5?4*n*n*n:.5*Math.pow(2*n-2,3)+1}function xd(n){const t=typeof n=="string"&&n.match(/^\s*(-?[\d.]+)([^\s]*)\s*$/);return t?[parseFloat(t[1]),t[2]||"px"]:[n,"px"]}function Tr(n,{delay:t=0,duration:e=400,easing:r=KE,amount:s=5,opacity:i=0}={}){const o=getComputedStyle(n),a=+o.opacity,l=o.filter==="none"?"":o.filter,u=a*(1-i),[h,c]=xd(s);return{delay:t,duration:e,easing:r,css:(d,f)=>`opacity: ${a-u*f}; filter: ${l} blur(${f*h}${c});`}}function Ja(n,{delay:t=0,duration:e=400,easing:r=GE}={}){const s=+getComputedStyle(n).opacity;return{delay:t,duration:e,easing:r,css:i=>`opacity: ${i*s}`}}function tr(n,{delay:t=0,duration:e=400,easing:r=Zv,x:s=0,y:i=0,opacity:o=0}={}){const a=getComputedStyle(n),l=+a.opacity,u=a.transform==="none"?"":a.transform,h=l*(1-o),[c,d]=xd(s),[f,g]=xd(i);return{delay:t,duration:e,easing:r,css:(y,m)=>`
			transform: ${u} translate(${(1-y)*c}${d}, ${(1-y)*f}${g});
			opacity: ${l-h*m}`}}function Pp(n,{delay:t=0,duration:e=400,easing:r=Zv,axis:s="y"}={}){const i=getComputedStyle(n),o=+i.opacity,a=s==="y"?"height":"width",l=parseFloat(i[a]),u=s==="y"?["top","bottom"]:["left","right"],h=u.map(v=>`${v[0].toUpperCase()}${v.slice(1)}`),c=parseFloat(i[`padding${h[0]}`]),d=parseFloat(i[`padding${h[1]}`]),f=parseFloat(i[`margin${h[0]}`]),g=parseFloat(i[`margin${h[1]}`]),y=parseFloat(i[`border${h[0]}Width`]),m=parseFloat(i[`border${h[1]}Width`]);return{delay:t,duration:e,easing:r,css:v=>`overflow: hidden;opacity: ${Math.min(v*20,1)*o};${a}: ${v*l}px;padding-${u[0]}: ${v*c}px;padding-${u[1]}: ${v*d}px;margin-${u[0]}: ${v*f}px;margin-${u[1]}: ${v*g}px;border-${u[0]}-width: ${v*y}px;border-${u[1]}-width: ${v*m}px;min-${a}: 0`}}var YE=ce('<span class="plus">+</span>'),QE=ce('<span class="value"> </span> <!>',1),ZE=ce('<span class="counts"> </span>'),XE=ce('<span>]</span> <!> <span>=</span> <span class="sum"> </span>',1),jE=ce('<span class="extra"> </span> <span>]=</span> <span class="sum"> </span>',1),JE=ce('<li class="row"><span></span> <span>[</span> <!> <!></li>'),eA=ce("<span> </span>"),tA=ce('<li><!> <span class="sum"> </span></li>'),nA=ce('<span class="combo"> </span>'),rA=ce('<ol class="log"><!> <!> <!></ol>');function Xv(n,t){if(new.target)return $t({component:Xv,...n});kt(t,!1);const[e,r]=wn(),s=()=>ge(Fr,"$phase",e),i=()=>ge(va,"$log",e),o=()=>ge(Al,"$score",e),a=()=>ge(Xt,"$combos",e);function l(m=[]){let{length:v}=m;return v<1?"":(v>4&&(v=4),m.reduce((_,w,S)=>_+`--clr-${S+1}: var(--color-${w});`,`animation: colors-${v} ${200+200*v}ms steps(2, end) infinite;`))}Ut();var u=rA(),h=W(u);{var c=m=>{var v=bl(),_=sn(v);Is(_,1,i,Oi,(w,S,E)=>{let A=()=>b(S).digits,I=()=>b(S).counts,T=()=>b(S).extra,x=()=>b(S).sum,V=()=>ES(b(S),["digits","counts","extra","sum"]);var L=JE();const N=Nt(()=>Object.keys(V()));var H=W(L);H.textContent=E+1;var D=J(H,4);Is(D,1,()=>b(N),Oi,(C,O,F)=>{var z=QE(),G=sn(z),ee=W(G,!0);q(G);var K=J(G,2);{var le=M=>{var ie=YE();oe(M,ie)};Ue(K,M=>{F<b(N).length-1&&M(le)})}Ze(()=>{gn(G,"color",`var(--color-${b(O)??""})`),st(ee,V()[b(O)])}),oe(C,z)});var R=J(D,2);{var P=C=>{var O=XE(),F=J(sn(O),2);{var z=K=>{var le=ZE(),M=W(le,!0);q(le),Ze(ie=>{Ot(le,"style",ie),st(M,I())},[()=>l(A())],Nt),oe(K,le)};Ue(F,K=>{I()>1&&K(z)})}var G=J(F,4),ee=W(G,!0);q(G),Ze(()=>st(ee,(E+1)*x()*I())),oe(C,O)},k=C=>{var O=jE(),F=sn(O),z=W(F,!0);q(F);var G=J(F,4),ee=W(G,!0);q(G),Ze(()=>{st(z,T()),st(ee,(E+1)*T())}),oe(C,O)};Ue(R,C=>{T()===void 0?C(P):C(k,!1)})}q(L),Ke(1,L,()=>Pp,()=>wo({duration:100})),Ke(2,L,()=>Ja,()=>wo({duration:200})),oe(w,L)}),oe(m,v)};Ue(h,m=>{s()!==re.score&&m(c)})}var d=J(h,2);{var f=m=>{var v=tA();const _=Nt(()=>i().length===1);let w;var S=W(v);{var E=T=>{var x=eA(),V=W(x,!0);q(x),Ze(()=>st(V,b(_)?"":"combo:")),Ke(2,x,()=>Ja,()=>wo({duration:200})),oe(T,x)};Ue(S,T=>{s()===re.combo&&T(E)})}var A=J(S,2),I=W(A);q(A),q(v),Ze(()=>{w=nt(v,1,"",null,w,{collapse:b(_)}),st(I,`${(s()===re.score&&o().buffer>0?"+":"")??""}${o().buffer??""}`)}),Ke(1,v,()=>Pp,()=>wo({duration:b(_)?0:100})),Ke(2,v,()=>Ja,()=>wo({duration:200})),oe(m,v)};Ue(d,m=>{(s()===re.combo||s()===re.score)&&m(f)})}var g=J(d,2);Is(g,1,a,({combo:m,key:v})=>v,(m,v)=>{let _=()=>b(v).combo;var w=nA(),S=W(w);q(w),Ze(()=>st(S,`+${_()??""}`)),oe(m,w)}),q(u),oe(n,u);var y=Tt({$set:Ht,$on:(m,v)=>Vt(t,m,v)});return r(),y}var sA=ce('<span class="value"> </span>'),iA=ce('<span tabindex="0" role="button"><span> </span> <!></span>');function Yh(n,t){if(new.target)return $t({component:Yh,...n});kt(t,!1);const[e,r]=wn(),s=()=>ge(Al,"$score",e),i=()=>ge(ba,"$records",e),o=()=>ge(Fr,"$phase",e),a=Y(),l=Y();let u=At(t,"newRecordHighCombo",12,!1),h=At(t,"newRecordHighScore",12,!1),c=At(t,"newRecord",12,!1),d=At(t,"overlaid",12,!1);const f={[U.highCombo]:"hi-combo",[U.highScore]:"hi-score",[U.score]:"score"};let g=Y(U.score),y,m=Y(!1),v=Y(!1);function _(){return b(v)}function w(){B(v,!0)}function S(){B(v,!1)}function E(){B(g,I(b(g))),T()}function A(){B(g,I(b(g),!0)),T()}function I(N,H=!1){return c()?{[U.highScore]:u()?U.highCombo:U.highScore,[U.highCombo]:h()?U.highScore:U.highCombo}[N]:H?{[U.score]:U.highCombo,[U.highScore]:U.score,[U.highCombo]:U.highScore}[N]:{[U.score]:U.highScore,[U.highScore]:U.highCombo,[U.highCombo]:U.score}[N]}function T(){B(m,!0),clearTimeout(y),!c()&&(y=setTimeout(()=>{B(g,U.score),B(m,c())},3200))}ae(()=>(kn(c()),kn(h()),U),()=>{c()&&(B(g,h()?U.highScore:U.highCombo),B(m,!0))}),ae(()=>(b(g),s(),i()),()=>{B(a,b(g)===U.score?s().value:i()[b(g)][U.value])}),ae(()=>(b(a),i(),U),()=>{B(l,"score: "+b(a)+`
high score: `+i()[U.highScore][U.value]+`
high combo: `+i()[U.highCombo][U.value])}),dr(),Ut();var x=bl(),V=sn(x);OS(V,()=>b(g),N=>{var H=iA();let D;var R=W(H);let P;var k=W(R);q(R);var C=J(R,2);{var O=F=>{var z=sA(),G=W(z,!0);q(z),Ze(()=>st(G,b(a))),oe(F,z)};Ue(C,F=>{(d()||o()!==re.gameOver)&&F(O)})}q(H),Ze(()=>{D=nt(H,1,"score",null,D,{focus:b(v)}),Ot(H,"title",b(l)),P=nt(R,1,"type",null,P,{visible:b(m)}),st(k,`${f[b(g)]??""}:`)}),Ke(1,H,()=>Tr),Me("click",H,Uh(E)),oe(N,H)}),oe(n,x),Ee(t,"isFocused",_),Ee(t,"focus",w),Ee(t,"blur",S),Ee(t,"nextType",E),Ee(t,"prevType",A);var L=Tt({isFocused:_,focus:w,blur:S,nextType:E,prevType:A,get newRecordHighCombo(){return u()},set newRecordHighCombo(N){u(N),yt()},get newRecordHighScore(){return h()},set newRecordHighScore(N){h(N),yt()},get newRecord(){return c()},set newRecord(N){c(N),yt()},get overlaid(){return d()},set overlaid(N){d(N),yt()},$set:Ht,$on:(N,H)=>Vt(t,N,H)});return r(),L}var oA=ce('<span class="rapid">rapid</span>'),aA=ce('<div class="section-1"><button title="[open menu]"><h1>digifall <!></h1> <!></button></div> <div class="section-2"><!></div> <div class="section-3"><!></div> <div class="section-4"><!></div>',1),cA=ce('<div><div class="seedground"></div> <div class="content"><!></div></div>');function jv(n,t){if(new.target)return $t({component:jv,...n});kt(t,!1);const[e,r]=wn(),s=()=>ge(va,"$log",e),i=()=>ge(Xt,"$combos",e),o=()=>ge(_t,"$overlay",e),a=()=>ge(wa,"$seed",e),l=()=>ge(Ft,"$options",e),u=Y();let h=Y(null),c=Y(null),d=Y(null);function f(){b(h).isFocused()?(b(h).blur(),b(d).shiftFocus({y:1})):b(c).isFocused()?(b(c).blur(),b(h).focus()):b(d).shiftFocus({y:1}).topEdge&&(b(d).blur({savePrev:!0}),b(c).focus())}function g(){b(h).isFocused()?(b(h).blur(),b(c).focus()):b(c).isFocused()?(b(c).blur(),b(d).shiftFocus({y:-1})):b(d).shiftFocus({y:-1}).bottomEdge&&(b(d).blur({savePrev:!0}),b(h).focus())}function y(){b(h).isFocused()||(b(c).isFocused()?b(c).prevType():b(d).shiftFocus({x:-1}))}function m(){b(h).isFocused()||(b(c).isFocused()?b(c).nextType():b(d).shiftFocus({x:1}))}function v(){b(h).isFocused()?(b(h).click(),b(h).blur(),b(d).blur({savePrev:!0})):b(c).isFocused()?b(c).nextType():b(d).plusFocusedCard()}function _(){b(h).blur(),b(c).blur(),b(d).blur()}function w(L){if(!L)return;const N=()=>L=vc(L),H=(z=13)=>`hsl(${N()%360},50%,${z}%)`,D=[2,3,5,7,11,13,17,19,23,29,31,37,41,43,47,53,59,61,67,71,73,79,83,89,97,101,103,107,109,113,127,131,137,139,149];let R=4;const P=[];for(;R--;){const[z]=D.splice(N()%D.length,1);P.push(z)}const[k,C,O,F]=P;return`
      background-color: var(--color-dark);
      background-image:
        linear-gradient(90deg, ${H()} 50%, transparent 50%),
        linear-gradient(90deg, ${H()} 50%, transparent 50%),
        linear-gradient(90deg, transparent 50%, ${H()} 50%),
        linear-gradient(90deg, transparent 50%, ${H()} 50%);
      background-size: ${k}rem, ${C}rem, ${O}rem, ${F}rem;`}ae(()=>b(h),()=>{b(h)&&(bs(h,b(h).isFocused=()=>b(h).classList.contains("focus")),bs(h,b(h).focus=()=>b(h).classList.add("focus")),bs(h,b(h).blur=()=>b(h).classList.remove("focus")))}),ae(()=>(s(),i()),()=>{B(u,s().length>0||i().length>0)}),dr(),Ut();var S=cA();let E;var A=W(S),I=J(A,2),T=W(I);{var x=L=>{var N=aA(),H=sn(N),D=W(H);let R;var P=W(D),k=J(W(P));{var C=M=>{var ie=oA();oe(M,ie)};Ue(k,M=>{l().rapid&&M(C)})}q(P);var O=J(P,2);Xv(O,{}),q(D),ht(D,M=>B(h,M),()=>b(h)),q(H);var F=J(H,2),z=W(F);ht(Yh(z,{$$legacy:!0}),M=>B(c,M),()=>b(c)),q(F);var G=J(F,2),ee=W(G);ht(Qv(ee,{$$legacy:!0}),M=>B(d,M),()=>b(d)),q(G);var K=J(G,2),le=W(K);Kh(le,{}),q(K),Ze(()=>R=nt(D,1,"digifall",null,R,{screen:b(u)})),Me("click",D,()=>xt(_t,ye.menu)),oe(L,N)};Ue(T,L=>{a()&&L(x)})}q(I),q(S),Ze(L=>{E=nt(S,1,"game",null,E,{blur:o()}),Ot(A,"style",L)},[()=>w(a())],Nt),oe(n,S),Ee(t,"moveUp",f),Ee(t,"moveDown",g),Ee(t,"moveLeft",y),Ee(t,"moveRight",m),Ee(t,"perfomAction",v),Ee(t,"blur",_);var V=Tt({moveUp:f,moveDown:g,moveLeft:y,moveRight:m,perfomAction:v,blur:_,$set:Ht,$on:(L,N)=>Vt(t,L,N)});return r(),V}var lA=ce("<h1> </h1>"),uA=ce("<button>p2p leaderboard</button>"),dA=ce('<div class="col"><button>new game</button> <!> <button>options</button></div>'),hA=ce('<span class="letter"> </span>'),fA=ce('<span class="energy-out"></span>'),pA=ce('<div><div class="section-1"><!></div> <div class="section-2"><!></div> <div class="section-3"><!></div> <div class="section-4"><!> <!></div></div>');function Jv(n,t){if(new.target)return $t({component:Jv,...n});kt(t,!1);const[e,r]=wn(),s=()=>ge(El,"$energy",e),i=()=>ge(ba,"$records",e),o=()=>ge(Al,"$score",e),a=()=>ge(Ft,"$options",e),l=Y(),u=Y(),h=Y(),c=Y(),d=Y(),f=Y();let g=At(t,"scoreComponent",12);function y(){Gh()}function m(){xt(_t,ye.leaderboard)}function v(){xt(_t,ye.options)}ae(()=>s(),()=>{B(l,s().value===0)}),ae(()=>(b(l),s()),()=>{B(u,b(l)&&s().buffer===0)}),ae(()=>(i(),U),()=>{B(h,i()[U.highCombo][U.value])}),ae(()=>(b(u),b(h),U),()=>{B(c,b(u)&&b(h)>Ms[U.highComboPrev])}),ae(()=>(b(u),o(),U),()=>{B(d,b(u)&&o().value>Ms[U.highScorePrev])}),ae(()=>(b(c),b(d)),()=>{B(f,b(c)||b(d))}),dr(),Ut();var _=pA();let w;var S=W(_),E=W(S);{var A=k=>{var C=lA(),O=W(C,!0);q(C),Ze(()=>st(O,b(f)?"new record!":"game over")),Ke(5,C,()=>tr,()=>({delay:600,y:-48})),oe(k,C)};Ue(E,k=>{b(u)&&k(A)})}q(S);var I=J(S,2),T=W(I);ht(Yh(T,{get newRecordHighCombo(){return b(c)},get newRecordHighScore(){return b(d)},get newRecord(){return b(f)},overlaid:!0,$$legacy:!0}),k=>g(k),()=>g()),q(I);var x=J(I,2),V=W(x);{var L=k=>{var C=dA(),O=W(C),F=J(O,2);{var z=ee=>{var K=uA();Me("click",K,m),oe(ee,K)};Ue(F,ee=>{a()[U.leaderboard]&&ee(z)})}var G=J(F,2);q(C),Me("click",O,y),Me("click",G,v),Ke(5,C,()=>tr,()=>({delay:600,y:24})),oe(k,C)};Ue(V,k=>{b(u)&&k(L)})}q(x);var N=J(x,2),H=W(N);Kh(H,{});var D=J(H,2);{var R=k=>{var C=fA();Is(C,4,()=>"ut of energy",Oi,(O,F,z)=>{var G=hA(),ee=W(G,!0);q(G),Ze(()=>st(ee,F)),Ke(5,G,()=>tr,()=>({delay:z*48,duration:200,y:48})),oe(O,G)}),q(C),oe(k,C)};Ue(D,k=>{b(l)&&k(R)})}q(N),q(_),Ze(()=>w=nt(_,1,"game-over content",null,w,{"new-record":b(f)})),Ke(1,_,()=>Tr),oe(n,_);var P=Tt({get scoreComponent(){return g()},set scoreComponent(k){g(k),yt()},$set:Ht,$on:(k,C)=>Vt(t,k,C)});return r(),P}const gA=Symbol.for("@libp2p/connection"),Dp=Symbol.for("@libp2p/content-routing"),wc=Symbol.for("@libp2p/peer-discovery"),Qh=Symbol.for("@libp2p/peer-id");function eb(n){return!!n?.[Qh]}const Mp=Symbol.for("@libp2p/peer-routing"),Zh="keep-alive",_c="StrictSign",Xh="StrictNoSign";var Cn;(function(n){n.Accept="accept",n.Ignore="ignore",n.Reject="reject"})(Cn||(Cn={}));const tb=Symbol.for("@libp2p/transport");var Yo;(function(n){n[n.FATAL_ALL=0]="FATAL_ALL",n[n.NO_FATAL=1]="NO_FATAL"})(Yo||(Yo={}));var id;let Ls=(id=class extends Error{constructor(t="The operation was aborted"){super(t),this.name="AbortError"}},p(id,"name","AbortError"),id);class nb extends Error{constructor(t="Unexpected Peer"){super(t),this.name="UnexpectedPeerError"}}p(nb,"name","UnexpectedPeerError");class Id extends Error{constructor(t="Invalid crypto exchange"){super(t),this.name="InvalidCryptoExchangeError"}}p(Id,"name","InvalidCryptoExchangeError");class X extends Error{constructor(t="Invalid parameters"){super(t),this.name="InvalidParametersError"}}p(X,"name","InvalidParametersError");class jh extends Error{constructor(t="Invalid public key"){super(t),this.name="InvalidPublicKeyError"}}p(jh,"name","InvalidPublicKeyError");class Jh extends Error{constructor(t="Invalid private key"){super(t),this.name="InvalidPrivateKeyError"}}p(Jh,"name","InvalidPrivateKeyError");class rb extends Error{constructor(t="The connection is closing"){super(t),this.name="ConnectionClosingError"}}p(rb,"name","ConnectionClosingError");class ef extends Error{constructor(t="The connection is closed"){super(t),this.name="ConnectionClosedError"}}p(ef,"name","ConnectionClosedError");class sb extends Error{constructor(t="Connection failed"){super(t),this.name="ConnectionFailedError"}}p(sb,"name","ConnectionFailedError");class fi extends Error{constructor(t="The muxer is closed"){super(t),this.name="MuxerClosedError"}}p(fi,"name","MuxerClosedError");class ib extends Error{constructor(t="The stream has been reset"){super(t),this.name="StreamResetError"}}p(ib,"name","StreamResetError");class ob extends Error{constructor(t="The stream is in an invalid state"){super(t),this.name="StreamStateError"}}p(ob,"name","StreamStateError");var od;let Sc=(od=class extends Error{constructor(t="Not found"){super(t),this.name="NotFoundError"}},p(od,"name","NotFoundError"),od);class tf extends Error{constructor(t="Invalid PeerID"){super(t),this.name="InvalidPeerIdError"}}p(tf,"name","InvalidPeerIdError");class xl extends Error{constructor(t="Invalid multiaddr"){super(t),this.name="InvalidMultiaddrError"}}p(xl,"name","InvalidMultiaddrError");class ab extends Error{constructor(t="Invalid CID"){super(t),this.name="InvalidCIDError"}}p(ab,"name","InvalidCIDError");class cb extends Error{constructor(t="Invalid Multihash"){super(t),this.name="InvalidMultihashError"}}p(cb,"name","InvalidMultihashError");class Il extends Error{constructor(t="Unsupported protocol error"){super(t),this.name="UnsupportedProtocolError"}}p(Il,"name","UnsupportedProtocolError");class jn extends Error{constructor(t="Invalid message"){super(t),this.name="InvalidMessageError"}}p(jn,"name","InvalidMessageError");class ec extends Error{constructor(t="Protocol error"){super(t),this.name="ProtocolError"}}p(ec,"name","ProtocolError");var ad;let mA=(ad=class extends Error{constructor(t="Timed out"){super(t),this.name="TimeoutError"}},p(ad,"name","TimeoutError"),ad);class Qo extends Error{constructor(t="Not started"){super(t),this.name="NotStartedError"}}p(Qo,"name","NotStartedError");class Ei extends Error{constructor(t="Dial error"){super(t),this.name="DialError"}}p(Ei,"name","DialError");class Ec extends Error{constructor(t="Listen error"){super(t),this.name="ListenError"}}p(Ec,"name","ListenError");class nf extends Error{constructor(t="Limited connection"){super(t),this.name="LimitedConnectionError"}}p(nf,"name","LimitedConnectionError");class lb extends Error{constructor(t="Too many inbound protocol streams"){super(t),this.name="TooManyInboundProtocolStreamsError"}}p(lb,"name","TooManyInboundProtocolStreamsError");class rf extends Error{constructor(t="Too many outbound protocol streams"){super(t),this.name="TooManyOutboundProtocolStreamsError"}}p(rf,"name","TooManyOutboundProtocolStreamsError");class Ks extends Error{constructor(t="Unsupported key type"){super(t),this.name="UnsupportedKeyTypeError"}}p(Ks,"name","UnsupportedKeyTypeError");var Xn;class ar extends EventTarget{constructor(){super();_e(this,Xn,new Map)}listenerCount(e){const r=$(this,Xn).get(e);return r==null?0:r.length}addEventListener(e,r,s){super.addEventListener(e,r,s);let i=$(this,Xn).get(e);i==null&&(i=[],$(this,Xn).set(e,i)),i.push({callback:r,once:(s!==!0&&s!==!1&&s?.once)??!1})}removeEventListener(e,r,s){super.removeEventListener(e.toString(),r??null,s);let i=$(this,Xn).get(e);i!=null&&(i=i.filter(({callback:o})=>o!==r),$(this,Xn).set(e,i))}dispatchEvent(e){const r=super.dispatchEvent(e);let s=$(this,Xn).get(e.type);return s==null||(s=s.filter(({once:i})=>!i),$(this,Xn).set(e.type,s)),r}safeDispatchEvent(e,r={}){return this.dispatchEvent(new CustomEvent(e,r))}}Xn=new WeakMap;function sf(n){return n!=null&&typeof n.start=="function"&&typeof n.stop=="function"}async function ub(...n){const t=[];for(const e of n)sf(e)&&t.push(e);await Promise.all(t.map(async e=>{e.beforeStart!=null&&await e.beforeStart()})),await Promise.all(t.map(async e=>{await e.start()})),await Promise.all(t.map(async e=>{e.afterStart!=null&&await e.afterStart()}))}async function db(...n){const t=[];for(const e of n)sf(e)&&t.push(e);await Promise.all(t.map(async e=>{e.beforeStop!=null&&await e.beforeStop()})),await Promise.all(t.map(async e=>{await e.stop()})),await Promise.all(t.map(async e=>{e.afterStop!=null&&await e.afterStop()}))}const Wn=Symbol.for("@libp2p/service-capabilities"),Ac=Symbol.for("@libp2p/service-dependencies");function yA(n,t){if(n===t)return!0;if(n.byteLength!==t.byteLength)return!1;for(let e=0;e<n.byteLength;e++)if(n[e]!==t[e])return!1;return!0}function kl(n){if(n instanceof Uint8Array&&n.constructor.name==="Uint8Array")return n;if(n instanceof ArrayBuffer)return new Uint8Array(n);if(ArrayBuffer.isView(n))return new Uint8Array(n.buffer,n.byteOffset,n.byteLength);throw new Error("Unknown type, must be binary type")}function vA(n){return new TextEncoder().encode(n)}function bA(n){return new TextDecoder().decode(n)}function wA(n,t){if(n.length>=255)throw new TypeError("Alphabet too long");for(var e=new Uint8Array(256),r=0;r<e.length;r++)e[r]=255;for(var s=0;s<n.length;s++){var i=n.charAt(s),o=i.charCodeAt(0);if(e[o]!==255)throw new TypeError(i+" is ambiguous");e[o]=s}var a=n.length,l=n.charAt(0),u=Math.log(a)/Math.log(256),h=Math.log(256)/Math.log(a);function c(g){if(g instanceof Uint8Array||(ArrayBuffer.isView(g)?g=new Uint8Array(g.buffer,g.byteOffset,g.byteLength):Array.isArray(g)&&(g=Uint8Array.from(g))),!(g instanceof Uint8Array))throw new TypeError("Expected Uint8Array");if(g.length===0)return"";for(var y=0,m=0,v=0,_=g.length;v!==_&&g[v]===0;)v++,y++;for(var w=(_-v)*h+1>>>0,S=new Uint8Array(w);v!==_;){for(var E=g[v],A=0,I=w-1;(E!==0||A<m)&&I!==-1;I--,A++)E+=256*S[I]>>>0,S[I]=E%a>>>0,E=E/a>>>0;if(E!==0)throw new Error("Non-zero carry");m=A,v++}for(var T=w-m;T!==w&&S[T]===0;)T++;for(var x=l.repeat(y);T<w;++T)x+=n.charAt(S[T]);return x}function d(g){if(typeof g!="string")throw new TypeError("Expected String");if(g.length===0)return new Uint8Array;var y=0;if(g[y]!==" "){for(var m=0,v=0;g[y]===l;)m++,y++;for(var _=(g.length-y)*u+1>>>0,w=new Uint8Array(_);g[y];){var S=e[g.charCodeAt(y)];if(S===255)return;for(var E=0,A=_-1;(S!==0||E<v)&&A!==-1;A--,E++)S+=a*w[A]>>>0,w[A]=S%256>>>0,S=S/256>>>0;if(S!==0)throw new Error("Non-zero carry");v=E,y++}if(g[y]!==" "){for(var I=_-v;I!==_&&w[I]===0;)I++;for(var T=new Uint8Array(m+(_-I)),x=m;I!==_;)T[x++]=w[I++];return T}}}function f(g){var y=d(g);if(y)return y;throw new Error(`Non-${t} character`)}return{encode:c,decodeUnsafe:d,decode:f}}var _A=wA,SA=_A;class EA{constructor(t,e,r){p(this,"name");p(this,"prefix");p(this,"baseEncode");this.name=t,this.prefix=e,this.baseEncode=r}encode(t){if(t instanceof Uint8Array)return`${this.prefix}${this.baseEncode(t)}`;throw Error("Unknown type, must be binary type")}}let AA=class{constructor(t,e,r){p(this,"name");p(this,"prefix");p(this,"baseDecode");p(this,"prefixCodePoint");this.name=t,this.prefix=e;const s=e.codePointAt(0);if(s===void 0)throw new Error("Invalid prefix character");this.prefixCodePoint=s,this.baseDecode=r}decode(t){if(typeof t=="string"){if(t.codePointAt(0)!==this.prefixCodePoint)throw Error(`Unable to decode multibase string ${JSON.stringify(t)}, ${this.name} decoder only supports inputs prefixed with ${this.prefix}`);return this.baseDecode(t.slice(this.prefix.length))}else throw Error("Can only multibase decode strings")}or(t){return hb(this,t)}};class xA{constructor(t){p(this,"decoders");this.decoders=t}or(t){return hb(this,t)}decode(t){const e=t[0],r=this.decoders[e];if(r!=null)return r.decode(t);throw RangeError(`Unable to decode multibase string ${JSON.stringify(t)}, only inputs prefixed with ${Object.keys(this.decoders)} are supported`)}}function hb(n,t){return new xA({...n.decoders??{[n.prefix]:n},...t.decoders??{[t.prefix]:t}})}class IA{constructor(t,e,r,s){p(this,"name");p(this,"prefix");p(this,"baseEncode");p(this,"baseDecode");p(this,"encoder");p(this,"decoder");this.name=t,this.prefix=e,this.baseEncode=r,this.baseDecode=s,this.encoder=new EA(t,e,r),this.decoder=new AA(t,e,s)}encode(t){return this.encoder.encode(t)}decode(t){return this.decoder.decode(t)}}function Tl({name:n,prefix:t,encode:e,decode:r}){return new IA(n,t,e,r)}function _a({name:n,prefix:t,alphabet:e}){const{encode:r,decode:s}=SA(e,n);return Tl({prefix:t,name:n,encode:r,decode:i=>kl(s(i))})}function kA(n,t,e,r){const s={};for(let h=0;h<t.length;++h)s[t[h]]=h;let i=n.length;for(;n[i-1]==="=";)--i;const o=new Uint8Array(i*e/8|0);let a=0,l=0,u=0;for(let h=0;h<i;++h){const c=s[n[h]];if(c===void 0)throw new SyntaxError(`Non-${r} character`);l=l<<e|c,a+=e,a>=8&&(a-=8,o[u++]=255&l>>a)}if(a>=e||(255&l<<8-a)!==0)throw new SyntaxError("Unexpected end of data");return o}function TA(n,t,e){const r=t[t.length-1]==="=",s=(1<<e)-1;let i="",o=0,a=0;for(let l=0;l<n.length;++l)for(a=a<<8|n[l],o+=8;o>e;)o-=e,i+=t[s&a>>o];if(o!==0&&(i+=t[s&a<<e-o]),r)for(;(i.length*e&7)!==0;)i+="=";return i}function Ct({name:n,prefix:t,bitsPerChar:e,alphabet:r}){return Tl({prefix:t,name:n,encode(s){return TA(s,r,e)},decode(s){return kA(s,r,e,n)}})}const ot=_a({name:"base58btc",prefix:"z",alphabet:"123456789ABCDEFGHJKLMNPQRSTUVWXYZabcdefghijkmnopqrstuvwxyz"}),CA=_a({name:"base58flickr",prefix:"Z",alphabet:"123456789abcdefghijkmnopqrstuvwxyzABCDEFGHJKLMNPQRSTUVWXYZ"}),PA=Object.freeze(Object.defineProperty({__proto__:null,base58btc:ot,base58flickr:CA},Symbol.toStringTag,{value:"Module"})),Cr=Ct({prefix:"b",name:"base32",alphabet:"abcdefghijklmnopqrstuvwxyz234567",bitsPerChar:5}),DA=Ct({prefix:"B",name:"base32upper",alphabet:"ABCDEFGHIJKLMNOPQRSTUVWXYZ234567",bitsPerChar:5}),MA=Ct({prefix:"c",name:"base32pad",alphabet:"abcdefghijklmnopqrstuvwxyz234567=",bitsPerChar:5}),LA=Ct({prefix:"C",name:"base32padupper",alphabet:"ABCDEFGHIJKLMNOPQRSTUVWXYZ234567=",bitsPerChar:5}),BA=Ct({prefix:"v",name:"base32hex",alphabet:"0123456789abcdefghijklmnopqrstuv",bitsPerChar:5}),NA=Ct({prefix:"V",name:"base32hexupper",alphabet:"0123456789ABCDEFGHIJKLMNOPQRSTUV",bitsPerChar:5}),RA=Ct({prefix:"t",name:"base32hexpad",alphabet:"0123456789abcdefghijklmnopqrstuv=",bitsPerChar:5}),OA=Ct({prefix:"T",name:"base32hexpadupper",alphabet:"0123456789ABCDEFGHIJKLMNOPQRSTUV=",bitsPerChar:5}),FA=Ct({prefix:"h",name:"base32z",alphabet:"ybndrfg8ejkmcpqxot1uwisza345h769",bitsPerChar:5}),$A=Object.freeze(Object.defineProperty({__proto__:null,base32:Cr,base32hex:BA,base32hexpad:RA,base32hexpadupper:OA,base32hexupper:NA,base32pad:MA,base32padupper:LA,base32upper:DA,base32z:FA},Symbol.toStringTag,{value:"Module"})),tc=_a({prefix:"k",name:"base36",alphabet:"0123456789abcdefghijklmnopqrstuvwxyz"}),UA=_a({prefix:"K",name:"base36upper",alphabet:"0123456789ABCDEFGHIJKLMNOPQRSTUVWXYZ"}),VA=Object.freeze(Object.defineProperty({__proto__:null,base36:tc,base36upper:UA},Symbol.toStringTag,{value:"Module"}));var HA=fb,Lp=128,zA=-128,qA=Math.pow(2,31);function fb(n,t,e){t=t||[],e=e||0;for(var r=e;n>=qA;)t[e++]=n&255|Lp,n/=128;for(;n&zA;)t[e++]=n&255|Lp,n>>>=7;return t[e]=n|0,fb.bytes=e-r+1,t}var WA=kd,GA=128,Bp=127;function kd(n,r){var e=0,r=r||0,s=0,i=r,o,a=n.length;do{if(i>=a)throw kd.bytes=0,new RangeError("Could not decode varint");o=n[i++],e+=s<28?(o&Bp)<<s:(o&Bp)*Math.pow(2,s),s+=7}while(o>=GA);return kd.bytes=i-r,e}var KA=Math.pow(2,7),YA=Math.pow(2,14),QA=Math.pow(2,21),ZA=Math.pow(2,28),XA=Math.pow(2,35),jA=Math.pow(2,42),JA=Math.pow(2,49),ex=Math.pow(2,56),tx=Math.pow(2,63),nx=function(n){return n<KA?1:n<YA?2:n<QA?3:n<ZA?4:n<XA?5:n<jA?6:n<JA?7:n<ex?8:n<tx?9:10},rx={encode:HA,decode:WA,encodingLength:nx},xc=rx;function Td(n,t=0){return[xc.decode(n,t),xc.decode.bytes]}function Ic(n,t,e=0){return xc.encode(n,t,e),t}function kc(n){return xc.encodingLength(n)}function Bs(n,t){const e=t.byteLength,r=kc(n),s=r+kc(e),i=new Uint8Array(s+e);return Ic(n,i,0),Ic(e,i,r),i.set(t,s),new of(n,e,t,i)}function $r(n){const t=kl(n),[e,r]=Td(t),[s,i]=Td(t.subarray(r)),o=t.subarray(r+i);if(o.byteLength!==s)throw new Error("Incorrect length");return new of(e,s,o,t)}function sx(n,t){if(n===t)return!0;{const e=t;return n.code===e.code&&n.size===e.size&&e.bytes instanceof Uint8Array&&yA(n.bytes,e.bytes)}}class of{constructor(t,e,r,s){p(this,"code");p(this,"size");p(this,"digest");p(this,"bytes");this.code=t,this.size=e,this.digest=r,this.bytes=s}}function Np(n,t){const{bytes:e,version:r}=n;switch(r){case 0:return ox(e,Cd(n),t??ot.encoder);default:return ax(e,Cd(n),t??Cr.encoder)}}const Rp=new WeakMap;function Cd(n){const t=Rp.get(n);if(t==null){const e=new Map;return Rp.set(n,e),e}return t}var Zm;class Ye{constructor(t,e,r,s){p(this,"code");p(this,"version");p(this,"multihash");p(this,"bytes");p(this,"/");p(this,Zm,"CID");this.code=e,this.version=t,this.multihash=r,this.bytes=s,this["/"]=s}get asCID(){return this}get byteOffset(){return this.bytes.byteOffset}get byteLength(){return this.bytes.byteLength}toV0(){switch(this.version){case 0:return this;case 1:{const{code:t,multihash:e}=this;if(t!==_o)throw new Error("Cannot convert a non dag-pb CID to CIDv0");if(e.code!==cx)throw new Error("Cannot convert non sha2-256 multihash CID to CIDv0");return Ye.createV0(e)}default:throw Error(`Can not convert CID version ${this.version} to version 0. This is a bug please report`)}}toV1(){switch(this.version){case 0:{const{code:t,digest:e}=this.multihash,r=Bs(t,e);return Ye.createV1(this.code,r)}case 1:return this;default:throw Error(`Can not convert CID version ${this.version} to version 1. This is a bug please report`)}}equals(t){return Ye.equals(this,t)}static equals(t,e){const r=e;return r!=null&&t.code===r.code&&t.version===r.version&&sx(t.multihash,r.multihash)}toString(t){return Np(this,t)}toJSON(){return{"/":Np(this)}}link(){return this}[(Zm=Symbol.toStringTag,Symbol.for("nodejs.util.inspect.custom"))](){return`CID(${this.toString()})`}static asCID(t){if(t==null)return null;const e=t;if(e instanceof Ye)return e;if(e["/"]!=null&&e["/"]===e.bytes||e.asCID===e){const{version:r,code:s,multihash:i,bytes:o}=e;return new Ye(r,s,i,o??Op(r,s,i.bytes))}else if(e[lx]===!0){const{version:r,multihash:s,code:i}=e,o=$r(s);return Ye.create(r,i,o)}else return null}static create(t,e,r){if(typeof e!="number")throw new Error("String codecs are no longer supported");if(!(r.bytes instanceof Uint8Array))throw new Error("Invalid digest");switch(t){case 0:{if(e!==_o)throw new Error(`Version 0 CID must use dag-pb (code: ${_o}) block encoding`);return new Ye(t,e,r,r.bytes)}case 1:{const s=Op(t,e,r.bytes);return new Ye(t,e,r,s)}default:throw new Error("Invalid version")}}static createV0(t){return Ye.create(0,_o,t)}static createV1(t,e){return Ye.create(1,t,e)}static decode(t){const[e,r]=Ye.decodeFirst(t);if(r.length!==0)throw new Error("Incorrect length");return e}static decodeFirst(t){const e=Ye.inspectBytes(t),r=e.size-e.multihashSize,s=kl(t.subarray(r,r+e.multihashSize));if(s.byteLength!==e.multihashSize)throw new Error("Incorrect length");const i=s.subarray(e.multihashSize-e.digestSize),o=new of(e.multihashCode,e.digestSize,i,s);return[e.version===0?Ye.createV0(o):Ye.createV1(e.codec,o),t.subarray(e.size)]}static inspectBytes(t){let e=0;const r=()=>{const[c,d]=Td(t.subarray(e));return e+=d,c};let s=r(),i=_o;if(s===18?(s=0,e=0):i=r(),s!==0&&s!==1)throw new RangeError(`Invalid CID version ${s}`);const o=e,a=r(),l=r(),u=e+l,h=u-o;return{version:s,codec:i,multihashCode:a,digestSize:l,multihashSize:h,size:u}}static parse(t,e){const[r,s]=ix(t,e),i=Ye.decode(s);if(i.version===0&&t[0]!=="Q")throw Error("Version 0 CID string must not include multibase prefix");return Cd(i).set(r,t),i}}function ix(n,t){switch(n[0]){case"Q":{const e=t??ot;return[ot.prefix,e.decode(`${ot.prefix}${n}`)]}case ot.prefix:{const e=t??ot;return[ot.prefix,e.decode(n)]}case Cr.prefix:{const e=t??Cr;return[Cr.prefix,e.decode(n)]}case tc.prefix:{const e=t??tc;return[tc.prefix,e.decode(n)]}default:{if(t==null)throw Error("To parse non base32, base36 or base58btc encoded CID multibase decoder must be provided");return[n[0],t.decode(n)]}}}function ox(n,t,e){const{prefix:r}=e;if(r!==ot.prefix)throw Error(`Cannot string encode V0 in ${e.name} encoding`);const s=t.get(r);if(s==null){const i=e.encode(n).slice(1);return t.set(r,i),i}else return s}function ax(n,t,e){const{prefix:r}=e,s=t.get(r);if(s==null){const i=e.encode(n);return t.set(r,i),i}else return s}const _o=112,cx=18;function Op(n,t,e){const r=kc(n),s=r+kc(t),i=new Uint8Array(s+e.byteLength);return Ic(n,i,0),Ic(t,i,r),i.set(e,s),i}const lx=Symbol.for("@ipld/js-cid/CID"),pb=0,ux="identity",gb=kl;function dx(n){return Bs(pb,gb(n))}const Cl={code:pb,name:ux,encode:gb,digest:dx};function It(n,t){if(n===t)return!0;if(n.byteLength!==t.byteLength)return!1;for(let e=0;e<n.byteLength;e++)if(n[e]!==t[e])return!1;return!0}function No(n){if(!Number.isSafeInteger(n)||n<0)throw new Error("positive integer expected, got "+n)}function hx(n){return n instanceof Uint8Array||ArrayBuffer.isView(n)&&n.constructor.name==="Uint8Array"}function Pl(n,...t){if(!hx(n))throw new Error("Uint8Array expected");if(t.length>0&&!t.includes(n.length))throw new Error("Uint8Array expected of length "+t+", got length="+n.length)}function mb(n){if(typeof n!="function"||typeof n.create!="function")throw new Error("Hash should be wrapped by utils.wrapConstructor");No(n.outputLen),No(n.blockLen)}function Tc(n,t=!0){if(n.destroyed)throw new Error("Hash instance has been destroyed");if(t&&n.finished)throw new Error("Hash#digest() has already been called")}function fx(n,t){Pl(n);const e=t.outputLen;if(n.length<e)throw new Error("digestInto() expects output buffer of length at least "+e)}const oi=typeof globalThis=="object"&&"crypto"in globalThis?globalThis.crypto:void 0;/*! noble-hashes - MIT License (c) 2022 Paul Miller (paulmillr.com) */function Ro(n){return new DataView(n.buffer,n.byteOffset,n.byteLength)}function Kn(n,t){return n<<32-t|n>>>t}function lu(n,t){return n<<t|n>>>32-t>>>0}const px=async()=>{};async function gx(n,t,e){let r=Date.now();for(let s=0;s<n;s++){e(s);const i=Date.now()-r;i>=0&&i<t||(await px(),r+=i)}}function mx(n){if(typeof n!="string")throw new Error("utf8ToBytes expected string, got "+typeof n);return new Uint8Array(new TextEncoder().encode(n))}function Zo(n){return typeof n=="string"&&(n=mx(n)),Pl(n),n}function yx(...n){let t=0;for(let r=0;r<n.length;r++){const s=n[r];Pl(s),t+=s.length}const e=new Uint8Array(t);for(let r=0,s=0;r<n.length;r++){const i=n[r];e.set(i,s),s+=i.length}return e}class yb{clone(){return this._cloneInto()}}function vx(n,t){if(t!==void 0&&{}.toString.call(t)!=="[object Object]")throw new Error("Options should be object or undefined");return Object.assign(n,t)}function af(n){const t=r=>n().update(Zo(r)).digest(),e=n();return t.outputLen=e.outputLen,t.blockLen=e.blockLen,t.create=()=>n(),t}function cf(n=32){if(oi&&typeof oi.getRandomValues=="function")return oi.getRandomValues(new Uint8Array(n));if(oi&&typeof oi.randomBytes=="function")return oi.randomBytes(n);throw new Error("crypto.getRandomValues must be defined")}function bx(n,t,e,r){if(typeof n.setBigUint64=="function")return n.setBigUint64(t,e,r);const s=BigInt(32),i=BigInt(4294967295),o=Number(e>>s&i),a=Number(e&i),l=r?4:0,u=r?0:4;n.setUint32(t+l,o,r),n.setUint32(t+u,a,r)}function vb(n,t,e){return n&t^~n&e}function bb(n,t,e){return n&t^n&e^t&e}class lf extends yb{constructor(t,e,r,s){super(),this.blockLen=t,this.outputLen=e,this.padOffset=r,this.isLE=s,this.finished=!1,this.length=0,this.pos=0,this.destroyed=!1,this.buffer=new Uint8Array(t),this.view=Ro(this.buffer)}update(t){Tc(this);const{view:e,buffer:r,blockLen:s}=this;t=Zo(t);const i=t.length;for(let o=0;o<i;){const a=Math.min(s-this.pos,i-o);if(a===s){const l=Ro(t);for(;s<=i-o;o+=s)this.process(l,o);continue}r.set(t.subarray(o,o+a),this.pos),this.pos+=a,o+=a,this.pos===s&&(this.process(e,0),this.pos=0)}return this.length+=t.length,this.roundClean(),this}digestInto(t){Tc(this),fx(t,this),this.finished=!0;const{buffer:e,view:r,blockLen:s,isLE:i}=this;let{pos:o}=this;e[o++]=128,this.buffer.subarray(o).fill(0),this.padOffset>s-o&&(this.process(r,0),o=0);for(let c=o;c<s;c++)e[c]=0;bx(r,s-8,BigInt(this.length*8),i),this.process(r,0);const a=Ro(t),l=this.outputLen;if(l%4)throw new Error("_sha2: outputLen should be aligned to 32bit");const u=l/4,h=this.get();if(u>h.length)throw new Error("_sha2: outputLen bigger than state");for(let c=0;c<u;c++)a.setUint32(4*c,h[c],i)}digest(){const{buffer:t,outputLen:e}=this;this.digestInto(t);const r=t.slice(0,e);return this.destroy(),r}_cloneInto(t){t||(t=new this.constructor),t.set(...this.get());const{blockLen:e,buffer:r,length:s,finished:i,destroyed:o,pos:a}=this;return t.length=s,t.pos=a,t.finished=i,t.destroyed=o,s%e&&t.buffer.set(r),t}}const La=BigInt(2**32-1),Pd=BigInt(32);function wb(n,t=!1){return t?{h:Number(n&La),l:Number(n>>Pd&La)}:{h:Number(n>>Pd&La)|0,l:Number(n&La)|0}}function wx(n,t=!1){let e=new Uint32Array(n.length),r=new Uint32Array(n.length);for(let s=0;s<n.length;s++){const{h:i,l:o}=wb(n[s],t);[e[s],r[s]]=[i,o]}return[e,r]}const _x=(n,t)=>BigInt(n>>>0)<<Pd|BigInt(t>>>0),Sx=(n,t,e)=>n>>>e,Ex=(n,t,e)=>n<<32-e|t>>>e,Ax=(n,t,e)=>n>>>e|t<<32-e,xx=(n,t,e)=>n<<32-e|t>>>e,Ix=(n,t,e)=>n<<64-e|t>>>e-32,kx=(n,t,e)=>n>>>e-32|t<<64-e,Tx=(n,t)=>t,Cx=(n,t)=>n,Px=(n,t,e)=>n<<e|t>>>32-e,Dx=(n,t,e)=>t<<e|n>>>32-e,Mx=(n,t,e)=>t<<e-32|n>>>64-e,Lx=(n,t,e)=>n<<e-32|t>>>64-e;function Bx(n,t,e,r){const s=(t>>>0)+(r>>>0);return{h:n+e+(s/2**32|0)|0,l:s|0}}const Nx=(n,t,e)=>(n>>>0)+(t>>>0)+(e>>>0),Rx=(n,t,e,r)=>t+e+r+(n/2**32|0)|0,Ox=(n,t,e,r)=>(n>>>0)+(t>>>0)+(e>>>0)+(r>>>0),Fx=(n,t,e,r,s)=>t+e+r+s+(n/2**32|0)|0,$x=(n,t,e,r,s)=>(n>>>0)+(t>>>0)+(e>>>0)+(r>>>0)+(s>>>0),Ux=(n,t,e,r,s,i)=>t+e+r+s+i+(n/2**32|0)|0,fe={fromBig:wb,split:wx,toBig:_x,shrSH:Sx,shrSL:Ex,rotrSH:Ax,rotrSL:xx,rotrBH:Ix,rotrBL:kx,rotr32H:Tx,rotr32L:Cx,rotlSH:Px,rotlSL:Dx,rotlBH:Mx,rotlBL:Lx,add:Bx,add3L:Nx,add3H:Rx,add4L:Ox,add4H:Fx,add5H:Ux,add5L:$x},[Vx,Hx]=fe.split(["0x428a2f98d728ae22","0x7137449123ef65cd","0xb5c0fbcfec4d3b2f","0xe9b5dba58189dbbc","0x3956c25bf348b538","0x59f111f1b605d019","0x923f82a4af194f9b","0xab1c5ed5da6d8118","0xd807aa98a3030242","0x12835b0145706fbe","0x243185be4ee4b28c","0x550c7dc3d5ffb4e2","0x72be5d74f27b896f","0x80deb1fe3b1696b1","0x9bdc06a725c71235","0xc19bf174cf692694","0xe49b69c19ef14ad2","0xefbe4786384f25e3","0x0fc19dc68b8cd5b5","0x240ca1cc77ac9c65","0x2de92c6f592b0275","0x4a7484aa6ea6e483","0x5cb0a9dcbd41fbd4","0x76f988da831153b5","0x983e5152ee66dfab","0xa831c66d2db43210","0xb00327c898fb213f","0xbf597fc7beef0ee4","0xc6e00bf33da88fc2","0xd5a79147930aa725","0x06ca6351e003826f","0x142929670a0e6e70","0x27b70a8546d22ffc","0x2e1b21385c26c926","0x4d2c6dfc5ac42aed","0x53380d139d95b3df","0x650a73548baf63de","0x766a0abb3c77b2a8","0x81c2c92e47edaee6","0x92722c851482353b","0xa2bfe8a14cf10364","0xa81a664bbc423001","0xc24b8b70d0f89791","0xc76c51a30654be30","0xd192e819d6ef5218","0xd69906245565a910","0xf40e35855771202a","0x106aa07032bbd1b8","0x19a4c116b8d2d0c8","0x1e376c085141ab53","0x2748774cdf8eeb99","0x34b0bcb5e19b48a8","0x391c0cb3c5c95a63","0x4ed8aa4ae3418acb","0x5b9cca4f7763e373","0x682e6ff3d6b2b8a3","0x748f82ee5defb2fc","0x78a5636f43172f60","0x84c87814a1f0ab72","0x8cc702081a6439ec","0x90befffa23631e28","0xa4506cebde82bde9","0xbef9a3f7b2c67915","0xc67178f2e372532b","0xca273eceea26619c","0xd186b8c721c0c207","0xeada7dd6cde0eb1e","0xf57d4f7fee6ed178","0x06f067aa72176fba","0x0a637dc5a2c898a6","0x113f9804bef90dae","0x1b710b35131c471b","0x28db77f523047d84","0x32caab7b40c72493","0x3c9ebe0a15c9bebc","0x431d67c49c100d4c","0x4cc5d4becb3e42b6","0x597f299cfc657e2a","0x5fcb6fab3ad6faec","0x6c44198c4a475817"].map(n=>BigInt(n))),Hr=new Uint32Array(80),zr=new Uint32Array(80);class zx extends lf{constructor(){super(128,64,16,!1),this.Ah=1779033703,this.Al=-205731576,this.Bh=-1150833019,this.Bl=-2067093701,this.Ch=1013904242,this.Cl=-23791573,this.Dh=-1521486534,this.Dl=1595750129,this.Eh=1359893119,this.El=-1377402159,this.Fh=-1694144372,this.Fl=725511199,this.Gh=528734635,this.Gl=-79577749,this.Hh=1541459225,this.Hl=327033209}get(){const{Ah:t,Al:e,Bh:r,Bl:s,Ch:i,Cl:o,Dh:a,Dl:l,Eh:u,El:h,Fh:c,Fl:d,Gh:f,Gl:g,Hh:y,Hl:m}=this;return[t,e,r,s,i,o,a,l,u,h,c,d,f,g,y,m]}set(t,e,r,s,i,o,a,l,u,h,c,d,f,g,y,m){this.Ah=t|0,this.Al=e|0,this.Bh=r|0,this.Bl=s|0,this.Ch=i|0,this.Cl=o|0,this.Dh=a|0,this.Dl=l|0,this.Eh=u|0,this.El=h|0,this.Fh=c|0,this.Fl=d|0,this.Gh=f|0,this.Gl=g|0,this.Hh=y|0,this.Hl=m|0}process(t,e){for(let w=0;w<16;w++,e+=4)Hr[w]=t.getUint32(e),zr[w]=t.getUint32(e+=4);for(let w=16;w<80;w++){const S=Hr[w-15]|0,E=zr[w-15]|0,A=fe.rotrSH(S,E,1)^fe.rotrSH(S,E,8)^fe.shrSH(S,E,7),I=fe.rotrSL(S,E,1)^fe.rotrSL(S,E,8)^fe.shrSL(S,E,7),T=Hr[w-2]|0,x=zr[w-2]|0,V=fe.rotrSH(T,x,19)^fe.rotrBH(T,x,61)^fe.shrSH(T,x,6),L=fe.rotrSL(T,x,19)^fe.rotrBL(T,x,61)^fe.shrSL(T,x,6),N=fe.add4L(I,L,zr[w-7],zr[w-16]),H=fe.add4H(N,A,V,Hr[w-7],Hr[w-16]);Hr[w]=H|0,zr[w]=N|0}let{Ah:r,Al:s,Bh:i,Bl:o,Ch:a,Cl:l,Dh:u,Dl:h,Eh:c,El:d,Fh:f,Fl:g,Gh:y,Gl:m,Hh:v,Hl:_}=this;for(let w=0;w<80;w++){const S=fe.rotrSH(c,d,14)^fe.rotrSH(c,d,18)^fe.rotrBH(c,d,41),E=fe.rotrSL(c,d,14)^fe.rotrSL(c,d,18)^fe.rotrBL(c,d,41),A=c&f^~c&y,I=d&g^~d&m,T=fe.add5L(_,E,I,Hx[w],zr[w]),x=fe.add5H(T,v,S,A,Vx[w],Hr[w]),V=T|0,L=fe.rotrSH(r,s,28)^fe.rotrBH(r,s,34)^fe.rotrBH(r,s,39),N=fe.rotrSL(r,s,28)^fe.rotrBL(r,s,34)^fe.rotrBL(r,s,39),H=r&i^r&a^i&a,D=s&o^s&l^o&l;v=y|0,_=m|0,y=f|0,m=g|0,f=c|0,g=d|0,{h:c,l:d}=fe.add(u|0,h|0,x|0,V|0),u=a|0,h=l|0,a=i|0,l=o|0,i=r|0,o=s|0;const R=fe.add3L(V,N,D);r=fe.add3H(R,x,L,H),s=R|0}({h:r,l:s}=fe.add(this.Ah|0,this.Al|0,r|0,s|0)),{h:i,l:o}=fe.add(this.Bh|0,this.Bl|0,i|0,o|0),{h:a,l}=fe.add(this.Ch|0,this.Cl|0,a|0,l|0),{h:u,l:h}=fe.add(this.Dh|0,this.Dl|0,u|0,h|0),{h:c,l:d}=fe.add(this.Eh|0,this.El|0,c|0,d|0),{h:f,l:g}=fe.add(this.Fh|0,this.Fl|0,f|0,g|0),{h:y,l:m}=fe.add(this.Gh|0,this.Gl|0,y|0,m|0),{h:v,l:_}=fe.add(this.Hh|0,this.Hl|0,v|0,_|0),this.set(r,s,i,o,a,l,u,h,c,d,f,g,y,m,v,_)}roundClean(){Hr.fill(0),zr.fill(0)}destroy(){this.buffer.fill(0),this.set(0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0)}}const Dl=af(()=>new zx);/*! noble-curves - MIT License (c) 2022 Paul Miller (paulmillr.com) */const Ml=BigInt(0),Ll=BigInt(1),qx=BigInt(2);function Ns(n){return n instanceof Uint8Array||ArrayBuffer.isView(n)&&n.constructor.name==="Uint8Array"}function Sa(n){if(!Ns(n))throw new Error("Uint8Array expected")}function Pr(n,t){if(typeof t!="boolean")throw new Error(n+" boolean expected, got "+t)}const Wx=Array.from({length:256},(n,t)=>t.toString(16).padStart(2,"0"));function Rs(n){Sa(n);let t="";for(let e=0;e<n.length;e++)t+=Wx[n[e]];return t}function pi(n){const t=n.toString(16);return t.length&1?"0"+t:t}function uf(n){if(typeof n!="string")throw new Error("hex string expected, got "+typeof n);return n===""?Ml:BigInt("0x"+n)}const hr={_0:48,_9:57,A:65,F:70,a:97,f:102};function Fp(n){if(n>=hr._0&&n<=hr._9)return n-hr._0;if(n>=hr.A&&n<=hr.F)return n-(hr.A-10);if(n>=hr.a&&n<=hr.f)return n-(hr.a-10)}function Fi(n){if(typeof n!="string")throw new Error("hex string expected, got "+typeof n);const t=n.length,e=t/2;if(t%2)throw new Error("hex string expected, got unpadded hex of length "+t);const r=new Uint8Array(e);for(let s=0,i=0;s<e;s++,i+=2){const o=Fp(n.charCodeAt(i)),a=Fp(n.charCodeAt(i+1));if(o===void 0||a===void 0){const l=n[i]+n[i+1];throw new Error('hex string expected, got non-hex character "'+l+'" at index '+i)}r[s]=o*16+a}return r}function ks(n){return uf(Rs(n))}function Ai(n){return Sa(n),uf(Rs(Uint8Array.from(n).reverse()))}function $i(n,t){return Fi(n.toString(16).padStart(t*2,"0"))}function Xo(n,t){return $i(n,t).reverse()}function Gx(n){return Fi(pi(n))}function dt(n,t,e){let r;if(typeof t=="string")try{r=Fi(t)}catch(i){throw new Error(n+" must be hex string or Uint8Array, cause: "+i)}else if(Ns(t))r=Uint8Array.from(t);else throw new Error(n+" must be hex string or Uint8Array");const s=r.length;if(typeof e=="number"&&s!==e)throw new Error(n+" of length "+e+" expected, got "+s);return r}function Os(...n){let t=0;for(let r=0;r<n.length;r++){const s=n[r];Sa(s),t+=s.length}const e=new Uint8Array(t);for(let r=0,s=0;r<n.length;r++){const i=n[r];e.set(i,s),s+=i.length}return e}function Kx(n,t){if(n.length!==t.length)return!1;let e=0;for(let r=0;r<n.length;r++)e|=n[r]^t[r];return e===0}function Yx(n){if(typeof n!="string")throw new Error("string expected");return new Uint8Array(new TextEncoder().encode(n))}const uu=n=>typeof n=="bigint"&&Ml<=n;function Bl(n,t,e){return uu(n)&&uu(t)&&uu(e)&&t<=n&&n<e}function Pn(n,t,e,r){if(!Bl(t,e,r))throw new Error("expected valid "+n+": "+e+" <= n < "+r+", got "+t)}function _b(n){let t;for(t=0;n>Ml;n>>=Ll,t+=1);return t}function Qx(n,t){return n>>BigInt(t)&Ll}function Zx(n,t,e){return n|(e?Ll:Ml)<<BigInt(t)}const df=n=>(qx<<BigInt(n-1))-Ll,du=n=>new Uint8Array(n),$p=n=>Uint8Array.from(n);function Sb(n,t,e){if(typeof n!="number"||n<2)throw new Error("hashLen must be a number");if(typeof t!="number"||t<2)throw new Error("qByteLen must be a number");if(typeof e!="function")throw new Error("hmacFn must be a function");let r=du(n),s=du(n),i=0;const o=()=>{r.fill(1),s.fill(0),i=0},a=(...c)=>e(s,r,...c),l=(c=du())=>{s=a($p([0]),c),r=a(),c.length!==0&&(s=a($p([1]),c),r=a())},u=()=>{if(i++>=1e3)throw new Error("drbg: tried 1000 values");let c=0;const d=[];for(;c<t;){r=a();const f=r.slice();d.push(f),c+=r.length}return Os(...d)};return(c,d)=>{o(),l(c);let f;for(;!(f=d(u()));)l();return o(),f}}const Xx={bigint:n=>typeof n=="bigint",function:n=>typeof n=="function",boolean:n=>typeof n=="boolean",string:n=>typeof n=="string",stringOrUint8Array:n=>typeof n=="string"||Ns(n),isSafeInteger:n=>Number.isSafeInteger(n),array:n=>Array.isArray(n),field:(n,t)=>t.Fp.isValid(n),hash:n=>typeof n=="function"&&Number.isSafeInteger(n.outputLen)};function lo(n,t,e={}){const r=(s,i,o)=>{const a=Xx[i];if(typeof a!="function")throw new Error("invalid validator function");const l=n[s];if(!(o&&l===void 0)&&!a(l,n))throw new Error("param "+String(s)+" is invalid. Expected "+i+", got "+l)};for(const[s,i]of Object.entries(t))r(s,i,!1);for(const[s,i]of Object.entries(e))r(s,i,!0);return n}const jx=()=>{throw new Error("not implemented")};function jo(n){const t=new WeakMap;return(e,...r)=>{const s=t.get(e);if(s!==void 0)return s;const i=n(e,...r);return t.set(e,i),i}}const Jx=Object.freeze(Object.defineProperty({__proto__:null,aInRange:Pn,abool:Pr,abytes:Sa,bitGet:Qx,bitLen:_b,bitMask:df,bitSet:Zx,bytesToHex:Rs,bytesToNumberBE:ks,bytesToNumberLE:Ai,concatBytes:Os,createHmacDrbg:Sb,ensureBytes:dt,equalBytes:Kx,hexToBytes:Fi,hexToNumber:uf,inRange:Bl,isBytes:Ns,memoized:jo,notImplemented:jx,numberToBytesBE:$i,numberToBytesLE:Xo,numberToHexUnpadded:pi,numberToVarBytesBE:Gx,utf8ToBytes:Yx,validateObject:lo},Symbol.toStringTag,{value:"Module"}));/*! noble-curves - MIT License (c) 2022 Paul Miller (paulmillr.com) */const St=BigInt(0),Je=BigInt(1),gs=BigInt(2),e2=BigInt(3),Dd=BigInt(4),Up=BigInt(5),Vp=BigInt(8);function Qe(n,t){const e=n%t;return e>=St?e:t+e}function t2(n,t,e){if(t<St)throw new Error("invalid exponent, negatives unsupported");if(e<=St)throw new Error("invalid modulus");if(e===Je)return St;let r=Je;for(;t>St;)t&Je&&(r=r*n%e),n=n*n%e,t>>=Je;return r}function et(n,t,e){let r=n;for(;t-- >St;)r*=r,r%=e;return r}function Md(n,t){if(n===St)throw new Error("invert: expected non-zero number");if(t<=St)throw new Error("invert: expected positive modulus, got "+t);let e=Qe(n,t),r=t,s=St,i=Je;for(;e!==St;){const a=r/e,l=r%e,u=s-i*a;r=e,e=l,s=i,i=u}if(r!==Je)throw new Error("invert: does not exist");return Qe(s,t)}function n2(n){const t=(n-Je)/gs;let e,r,s;for(e=n-Je,r=0;e%gs===St;e/=gs,r++);for(s=gs;s<n&&t2(s,t,n)!==n-Je;s++)if(s>1e3)throw new Error("Cannot find square root: likely non-prime P");if(r===1){const o=(n+Je)/Dd;return function(l,u){const h=l.pow(u,o);if(!l.eql(l.sqr(h),u))throw new Error("Cannot find square root");return h}}const i=(e+Je)/gs;return function(a,l){if(a.pow(l,t)===a.neg(a.ONE))throw new Error("Cannot find square root");let u=r,h=a.pow(a.mul(a.ONE,s),e),c=a.pow(l,i),d=a.pow(l,e);for(;!a.eql(d,a.ONE);){if(a.eql(d,a.ZERO))return a.ZERO;let f=1;for(let y=a.sqr(d);f<u&&!a.eql(y,a.ONE);f++)y=a.sqr(y);const g=a.pow(h,Je<<BigInt(u-f-1));h=a.sqr(g),c=a.mul(c,g),d=a.mul(d,h),u=f}return c}}function r2(n){if(n%Dd===e2){const t=(n+Je)/Dd;return function(r,s){const i=r.pow(s,t);if(!r.eql(r.sqr(i),s))throw new Error("Cannot find square root");return i}}if(n%Vp===Up){const t=(n-Up)/Vp;return function(r,s){const i=r.mul(s,gs),o=r.pow(i,t),a=r.mul(s,o),l=r.mul(r.mul(a,gs),o),u=r.mul(a,r.sub(l,r.ONE));if(!r.eql(r.sqr(u),s))throw new Error("Cannot find square root");return u}}return n2(n)}const s2=(n,t)=>(Qe(n,t)&Je)===Je,i2=["create","isValid","is0","neg","inv","sqrt","sqr","eql","add","sub","mul","pow","div","addN","subN","mulN","sqrN"];function o2(n){const t={ORDER:"bigint",MASK:"bigint",BYTES:"isSafeInteger",BITS:"isSafeInteger"},e=i2.reduce((r,s)=>(r[s]="function",r),t);return lo(n,e)}function a2(n,t,e){if(e<St)throw new Error("invalid exponent, negatives unsupported");if(e===St)return n.ONE;if(e===Je)return t;let r=n.ONE,s=t;for(;e>St;)e&Je&&(r=n.mul(r,s)),s=n.sqr(s),e>>=Je;return r}function c2(n,t){const e=new Array(t.length),r=t.reduce((i,o,a)=>n.is0(o)?i:(e[a]=i,n.mul(i,o)),n.ONE),s=n.inv(r);return t.reduceRight((i,o,a)=>n.is0(o)?i:(e[a]=n.mul(i,e[a]),n.mul(i,o)),s),e}function Eb(n,t){const e=t!==void 0?t:n.toString(2).length,r=Math.ceil(e/8);return{nBitLength:e,nByteLength:r}}function Nl(n,t,e=!1,r={}){if(n<=St)throw new Error("invalid field: expected ORDER > 0, got "+n);const{nBitLength:s,nByteLength:i}=Eb(n,t);if(i>2048)throw new Error("invalid field: expected ORDER of <= 2048 bytes");let o;const a=Object.freeze({ORDER:n,isLE:e,BITS:s,BYTES:i,MASK:df(s),ZERO:St,ONE:Je,create:l=>Qe(l,n),isValid:l=>{if(typeof l!="bigint")throw new Error("invalid field element: expected bigint, got "+typeof l);return St<=l&&l<n},is0:l=>l===St,isOdd:l=>(l&Je)===Je,neg:l=>Qe(-l,n),eql:(l,u)=>l===u,sqr:l=>Qe(l*l,n),add:(l,u)=>Qe(l+u,n),sub:(l,u)=>Qe(l-u,n),mul:(l,u)=>Qe(l*u,n),pow:(l,u)=>a2(a,l,u),div:(l,u)=>Qe(l*Md(u,n),n),sqrN:l=>l*l,addN:(l,u)=>l+u,subN:(l,u)=>l-u,mulN:(l,u)=>l*u,inv:l=>Md(l,n),sqrt:r.sqrt||(l=>(o||(o=r2(n)),o(a,l))),invertBatch:l=>c2(a,l),cmov:(l,u,h)=>h?u:l,toBytes:l=>e?Xo(l,i):$i(l,i),fromBytes:l=>{if(l.length!==i)throw new Error("Field.fromBytes: expected "+i+" bytes, got "+l.length);return e?Ai(l):ks(l)}});return Object.freeze(a)}function Ab(n){if(typeof n!="bigint")throw new Error("field order must be bigint");const t=n.toString(2).length;return Math.ceil(t/8)}function xb(n){const t=Ab(n);return t+Math.ceil(t/2)}function l2(n,t,e=!1){const r=n.length,s=Ab(t),i=xb(t);if(r<16||r<i||r>1024)throw new Error("expected "+i+"-1024 bytes of input, got "+r);const o=e?Ai(n):ks(n),a=Qe(o,t-Je)+Je;return e?Xo(a,s):$i(a,s)}/*! noble-curves - MIT License (c) 2022 Paul Miller (paulmillr.com) */const Hp=BigInt(0),Ba=BigInt(1);function hu(n,t){const e=t.negate();return n?e:t}function Ib(n,t){if(!Number.isSafeInteger(n)||n<=0||n>t)throw new Error("invalid window size, expected [1.."+t+"], got W="+n)}function fu(n,t){Ib(n,t);const e=Math.ceil(t/n)+1,r=2**(n-1);return{windows:e,windowSize:r}}function u2(n,t){if(!Array.isArray(n))throw new Error("array expected");n.forEach((e,r)=>{if(!(e instanceof t))throw new Error("invalid point at index "+r)})}function d2(n,t){if(!Array.isArray(n))throw new Error("array of scalars expected");n.forEach((e,r)=>{if(!t.isValid(e))throw new Error("invalid scalar at index "+r)})}const pu=new WeakMap,kb=new WeakMap;function gu(n){return kb.get(n)||1}function Tb(n,t){return{constTimeNegate:hu,hasPrecomputes(e){return gu(e)!==1},unsafeLadder(e,r,s=n.ZERO){let i=e;for(;r>Hp;)r&Ba&&(s=s.add(i)),i=i.double(),r>>=Ba;return s},precomputeWindow(e,r){const{windows:s,windowSize:i}=fu(r,t),o=[];let a=e,l=a;for(let u=0;u<s;u++){l=a,o.push(l);for(let h=1;h<i;h++)l=l.add(a),o.push(l);a=l.double()}return o},wNAF(e,r,s){const{windows:i,windowSize:o}=fu(e,t);let a=n.ZERO,l=n.BASE;const u=BigInt(2**e-1),h=2**e,c=BigInt(e);for(let d=0;d<i;d++){const f=d*o;let g=Number(s&u);s>>=c,g>o&&(g-=h,s+=Ba);const y=f,m=f+Math.abs(g)-1,v=d%2!==0,_=g<0;g===0?l=l.add(hu(v,r[y])):a=a.add(hu(_,r[m]))}return{p:a,f:l}},wNAFUnsafe(e,r,s,i=n.ZERO){const{windows:o,windowSize:a}=fu(e,t),l=BigInt(2**e-1),u=2**e,h=BigInt(e);for(let c=0;c<o;c++){const d=c*a;if(s===Hp)break;let f=Number(s&l);if(s>>=h,f>a&&(f-=u,s+=Ba),f===0)continue;let g=r[d+Math.abs(f)-1];f<0&&(g=g.negate()),i=i.add(g)}return i},getPrecomputes(e,r,s){let i=pu.get(r);return i||(i=this.precomputeWindow(r,e),e!==1&&pu.set(r,s(i))),i},wNAFCached(e,r,s){const i=gu(e);return this.wNAF(i,this.getPrecomputes(i,e,s),r)},wNAFCachedUnsafe(e,r,s,i){const o=gu(e);return o===1?this.unsafeLadder(e,r,i):this.wNAFUnsafe(o,this.getPrecomputes(o,e,s),r,i)},setWindowSize(e,r){Ib(r,t),kb.set(e,r),pu.delete(e)}}}function Cb(n,t,e,r){if(u2(e,n),d2(r,t),e.length!==r.length)throw new Error("arrays of points and scalars must have equal length");const s=n.ZERO,i=_b(BigInt(e.length)),o=i>12?i-3:i>4?i-2:i?2:1,a=(1<<o)-1,l=new Array(a+1).fill(s),u=Math.floor((t.BITS-1)/o)*o;let h=s;for(let c=u;c>=0;c-=o){l.fill(s);for(let f=0;f<r.length;f++){const g=r[f],y=Number(g>>BigInt(c)&BigInt(a));l[y]=l[y].add(e[f])}let d=s;for(let f=l.length-1,g=s;f>0;f--)g=g.add(l[f]),d=d.add(g);if(h=h.add(d),c!==0)for(let f=0;f<o;f++)h=h.double()}return h}function hf(n){return o2(n.Fp),lo(n,{n:"bigint",h:"bigint",Gx:"field",Gy:"field"},{nBitLength:"isSafeInteger",nByteLength:"isSafeInteger"}),Object.freeze({...Eb(n.n,n.nBitLength),...n,p:n.Fp.ORDER})}/*! noble-curves - MIT License (c) 2022 Paul Miller (paulmillr.com) */const Ln=BigInt(0),Zt=BigInt(1),Na=BigInt(2),h2=BigInt(8),f2={zip215:!0};function p2(n){const t=hf(n);return lo(n,{hash:"function",a:"bigint",d:"bigint",randomBytes:"function"},{adjustScalarBytes:"function",domain:"function",uvRatio:"function",mapToCurve:"function"}),Object.freeze({...t})}function g2(n){const t=p2(n),{Fp:e,n:r,prehash:s,hash:i,randomBytes:o,nByteLength:a,h:l}=t,u=Na<<BigInt(a*8)-Zt,h=e.create,c=Nl(t.n,t.nBitLength),d=t.uvRatio||((P,k)=>{try{return{isValid:!0,value:e.sqrt(P*e.inv(k))}}catch{return{isValid:!1,value:Ln}}}),f=t.adjustScalarBytes||(P=>P),g=t.domain||((P,k,C)=>{if(Pr("phflag",C),k.length||C)throw new Error("Contexts/pre-hash are not supported");return P});function y(P,k){Pn("coordinate "+P,k,Ln,u)}function m(P){if(!(P instanceof w))throw new Error("ExtendedPoint expected")}const v=jo((P,k)=>{const{ex:C,ey:O,ez:F}=P,z=P.is0();k==null&&(k=z?h2:e.inv(F));const G=h(C*k),ee=h(O*k),K=h(F*k);if(z)return{x:Ln,y:Zt};if(K!==Zt)throw new Error("invZ was invalid");return{x:G,y:ee}}),_=jo(P=>{const{a:k,d:C}=t;if(P.is0())throw new Error("bad point: ZERO");const{ex:O,ey:F,ez:z,et:G}=P,ee=h(O*O),K=h(F*F),le=h(z*z),M=h(le*le),ie=h(ee*k),we=h(le*h(ie+K)),he=h(M+h(C*h(ee*K)));if(we!==he)throw new Error("bad point: equation left != right (1)");const ve=h(O*F),je=h(z*G);if(ve!==je)throw new Error("bad point: equation left != right (2)");return!0});class w{constructor(k,C,O,F){this.ex=k,this.ey=C,this.ez=O,this.et=F,y("x",k),y("y",C),y("z",O),y("t",F),Object.freeze(this)}get x(){return this.toAffine().x}get y(){return this.toAffine().y}static fromAffine(k){if(k instanceof w)throw new Error("extended point not allowed");const{x:C,y:O}=k||{};return y("x",C),y("y",O),new w(C,O,Zt,h(C*O))}static normalizeZ(k){const C=e.invertBatch(k.map(O=>O.ez));return k.map((O,F)=>O.toAffine(C[F])).map(w.fromAffine)}static msm(k,C){return Cb(w,c,k,C)}_setWindowSize(k){A.setWindowSize(this,k)}assertValidity(){_(this)}equals(k){m(k);const{ex:C,ey:O,ez:F}=this,{ex:z,ey:G,ez:ee}=k,K=h(C*ee),le=h(z*F),M=h(O*ee),ie=h(G*F);return K===le&&M===ie}is0(){return this.equals(w.ZERO)}negate(){return new w(h(-this.ex),this.ey,this.ez,h(-this.et))}double(){const{a:k}=t,{ex:C,ey:O,ez:F}=this,z=h(C*C),G=h(O*O),ee=h(Na*h(F*F)),K=h(k*z),le=C+O,M=h(h(le*le)-z-G),ie=K+G,we=ie-ee,he=K-G,ve=h(M*we),je=h(ie*he),Q=h(M*he),ne=h(we*ie);return new w(ve,je,ne,Q)}add(k){m(k);const{a:C,d:O}=t,{ex:F,ey:z,ez:G,et:ee}=this,{ex:K,ey:le,ez:M,et:ie}=k;if(C===BigInt(-1)){const ei=h((z-F)*(le+K)),mo=h((z+F)*(le-K)),yo=h(mo-ei);if(yo===Ln)return this.double();const ti=h(G*Na*ie),ni=h(ee*Na*M),ri=ni+ti,cp=mo+ei,lp=ni-ti,E1=h(ri*yo),A1=h(cp*lp),x1=h(ri*lp),I1=h(yo*cp);return new w(E1,A1,I1,x1)}const we=h(F*K),he=h(z*le),ve=h(ee*O*ie),je=h(G*M),Q=h((F+z)*(K+le)-we-he),ne=je-ve,Re=je+ve,Pt=h(he-C*we),js=h(Q*ne),go=h(Re*Pt),Js=h(Q*Pt),Pa=h(ne*Re);return new w(js,go,Pa,Js)}subtract(k){return this.add(k.negate())}wNAF(k){return A.wNAFCached(this,k,w.normalizeZ)}multiply(k){const C=k;Pn("scalar",C,Zt,r);const{p:O,f:F}=this.wNAF(C);return w.normalizeZ([O,F])[0]}multiplyUnsafe(k,C=w.ZERO){const O=k;return Pn("scalar",O,Ln,r),O===Ln?E:this.is0()||O===Zt?this:A.wNAFCachedUnsafe(this,O,w.normalizeZ,C)}isSmallOrder(){return this.multiplyUnsafe(l).is0()}isTorsionFree(){return A.unsafeLadder(this,r).is0()}toAffine(k){return v(this,k)}clearCofactor(){const{h:k}=t;return k===Zt?this:this.multiplyUnsafe(k)}static fromHex(k,C=!1){const{d:O,a:F}=t,z=e.BYTES;k=dt("pointHex",k,z),Pr("zip215",C);const G=k.slice(),ee=k[z-1];G[z-1]=ee&-129;const K=Ai(G),le=C?u:e.ORDER;Pn("pointHex.y",K,Ln,le);const M=h(K*K),ie=h(M-Zt),we=h(O*M-F);let{isValid:he,value:ve}=d(ie,we);if(!he)throw new Error("Point.fromHex: invalid y coordinate");const je=(ve&Zt)===Zt,Q=(ee&128)!==0;if(!C&&ve===Ln&&Q)throw new Error("Point.fromHex: x=0 and x_0=1");return Q!==je&&(ve=h(-ve)),w.fromAffine({x:ve,y:K})}static fromPrivateKey(k){return x(k).point}toRawBytes(){const{x:k,y:C}=this.toAffine(),O=Xo(C,e.BYTES);return O[O.length-1]|=k&Zt?128:0,O}toHex(){return Rs(this.toRawBytes())}}w.BASE=new w(t.Gx,t.Gy,Zt,h(t.Gx*t.Gy)),w.ZERO=new w(Ln,Zt,Zt,Ln);const{BASE:S,ZERO:E}=w,A=Tb(w,a*8);function I(P){return Qe(P,r)}function T(P){return I(Ai(P))}function x(P){const k=e.BYTES;P=dt("private key",P,k);const C=dt("hashed private key",i(P),2*k),O=f(C.slice(0,k)),F=C.slice(k,2*k),z=T(O),G=S.multiply(z),ee=G.toRawBytes();return{head:O,prefix:F,scalar:z,point:G,pointBytes:ee}}function V(P){return x(P).pointBytes}function L(P=new Uint8Array,...k){const C=Os(...k);return T(i(g(C,dt("context",P),!!s)))}function N(P,k,C={}){P=dt("message",P),s&&(P=s(P));const{prefix:O,scalar:F,pointBytes:z}=x(k),G=L(C.context,O,P),ee=S.multiply(G).toRawBytes(),K=L(C.context,ee,z,P),le=I(G+K*F);Pn("signature.s",le,Ln,r);const M=Os(ee,Xo(le,e.BYTES));return dt("result",M,e.BYTES*2)}const H=f2;function D(P,k,C,O=H){const{context:F,zip215:z}=O,G=e.BYTES;P=dt("signature",P,2*G),k=dt("message",k),C=dt("publicKey",C,G),z!==void 0&&Pr("zip215",z),s&&(k=s(k));const ee=Ai(P.slice(G,2*G));let K,le,M;try{K=w.fromHex(C,z),le=w.fromHex(P.slice(0,G),z),M=S.multiplyUnsafe(ee)}catch{return!1}if(!z&&K.isSmallOrder())return!1;const ie=L(F,le.toRawBytes(),K.toRawBytes(),k);return le.add(K.multiplyUnsafe(ie)).subtract(M).clearCofactor().equals(w.ZERO)}return S._setWindowSize(8),{CURVE:t,getPublicKey:V,sign:N,verify:D,ExtendedPoint:w,utils:{getExtendedPublicKey:x,randomPrivateKey:()=>o(e.BYTES),precompute(P=8,k=w.BASE){return k._setWindowSize(P),k.multiply(BigInt(3)),k}}}}/*! noble-curves - MIT License (c) 2022 Paul Miller (paulmillr.com) */const ff=BigInt("57896044618658097711785492504343953926634992332820282019728792003956564819949"),zp=BigInt("19681161376707505956807079304988542015446066515923890162744021073123829784752");BigInt(0);const m2=BigInt(1),qp=BigInt(2);BigInt(3);const y2=BigInt(5),v2=BigInt(8);function b2(n){const t=BigInt(10),e=BigInt(20),r=BigInt(40),s=BigInt(80),i=ff,a=n*n%i*n%i,l=et(a,qp,i)*a%i,u=et(l,m2,i)*n%i,h=et(u,y2,i)*u%i,c=et(h,t,i)*h%i,d=et(c,e,i)*c%i,f=et(d,r,i)*d%i,g=et(f,s,i)*f%i,y=et(g,s,i)*f%i,m=et(y,t,i)*h%i;return{pow_p_5_8:et(m,qp,i)*n%i,b2:a}}function w2(n){return n[0]&=248,n[31]&=127,n[31]|=64,n}function _2(n,t){const e=ff,r=Qe(t*t*t,e),s=Qe(r*r*t,e),i=b2(n*s).pow_p_5_8;let o=Qe(n*r*i,e);const a=Qe(t*o*o,e),l=o,u=Qe(o*zp,e),h=a===n,c=a===Qe(-n,e),d=a===Qe(-n*zp,e);return h&&(o=l),(c||d)&&(o=u),s2(o,e)&&(o=Qe(-o,e)),{isValid:h||c,value:o}}const S2=Nl(ff,void 0,!0),E2={a:BigInt(-1),d:BigInt("37095705934669439343138083508754565189542113879843219016388785533085940283555"),Fp:S2,n:BigInt("7237005577332262213973186563042994240857116359379907606001950938285454250989"),h:v2,Gx:BigInt("15112221349535400772501151409588531511454012693041857206046113283949847762202"),Gy:BigInt("46316835694926478169428394003475163141307993866256225615783033603165251855960"),hash:Dl,randomBytes:cf,adjustScalarBytes:w2,uvRatio:_2},Cc=g2(E2),Pc=32,Yr=64,Ld=32;function A2(){const n=Cc.utils.randomPrivateKey(),t=Cc.getPublicKey(n);return{privateKey:k2(n,t),publicKey:t}}function x2(n,t){const e=n.subarray(0,Ld);return Cc.sign(t instanceof Uint8Array?t:t.subarray(),e)}function I2(n,t,e){return Cc.verify(t,e instanceof Uint8Array?e:e.subarray(),n)}function k2(n,t){const e=new Uint8Array(Yr);for(let r=0;r<Ld;r++)e[r]=n[r],e[Ld+r]=t[r];return e}class Pb{constructor(t){p(this,"type","Ed25519");p(this,"raw");this.raw=Jo(t,Pc)}toMultihash(){return Cl.digest(nr(this))}toCID(){return Ye.createV1(114,this.toMultihash())}toString(){return ot.encode(this.toMultihash().bytes).substring(1)}equals(t){return t==null||!(t.raw instanceof Uint8Array)?!1:It(this.raw,t.raw)}verify(t,e){return I2(this.raw,e,t)}}class Bd{constructor(t,e){p(this,"type","Ed25519");p(this,"raw");p(this,"publicKey");this.raw=Jo(t,Yr),this.publicKey=new Pb(e)}equals(t){return t==null||!(t.raw instanceof Uint8Array)?!1:It(this.raw,t.raw)}sign(t){return x2(this.raw,t)}}function Db(n){if(n.length>Yr){n=Jo(n,Yr+Pc);const r=n.subarray(0,Yr),s=n.subarray(Yr,n.length);return new Bd(r,s)}n=Jo(n,Yr);const t=n.subarray(0,Yr),e=n.subarray(Pc);return new Bd(t,e)}function pf(n){return n=Jo(n,Pc),new Pb(n)}async function T2(){const{privateKey:n,publicKey:t}=A2();return new Bd(n,t)}function Jo(n,t){if(n=Uint8Array.from(n??[]),n.length!==t)throw new X(`Key must be a Uint8Array of length ${t}, got ${n.length}`);return n}function Ge(n=0){return new Uint8Array(n)}function cr(n=0){return new Uint8Array(n)}const C2=Math.pow(2,7),P2=Math.pow(2,14),D2=Math.pow(2,21),gf=Math.pow(2,28),mf=Math.pow(2,35),yf=Math.pow(2,42),vf=Math.pow(2,49),De=128,Dt=127;function ln(n){if(n<C2)return 1;if(n<P2)return 2;if(n<D2)return 3;if(n<gf)return 4;if(n<mf)return 5;if(n<yf)return 6;if(n<vf)return 7;if(Number.MAX_SAFE_INTEGER!=null&&n>Number.MAX_SAFE_INTEGER)throw new RangeError("Could not encode varint");return 8}function Mb(n,t,e=0){switch(ln(n)){case 8:t[e++]=n&255|De,n/=128;case 7:t[e++]=n&255|De,n/=128;case 6:t[e++]=n&255|De,n/=128;case 5:t[e++]=n&255|De,n/=128;case 4:t[e++]=n&255|De,n>>>=7;case 3:t[e++]=n&255|De,n>>>=7;case 2:t[e++]=n&255|De,n>>>=7;case 1:{t[e++]=n&255,n>>>=7;break}default:throw new Error("unreachable")}return t}function M2(n,t,e=0){switch(ln(n)){case 8:t.set(e++,n&255|De),n/=128;case 7:t.set(e++,n&255|De),n/=128;case 6:t.set(e++,n&255|De),n/=128;case 5:t.set(e++,n&255|De),n/=128;case 4:t.set(e++,n&255|De),n>>>=7;case 3:t.set(e++,n&255|De),n>>>=7;case 2:t.set(e++,n&255|De),n>>>=7;case 1:{t.set(e++,n&255),n>>>=7;break}default:throw new Error("unreachable")}return t}function Lb(n,t){let e=n[t],r=0;if(r+=e&Dt,e<De||(e=n[t+1],r+=(e&Dt)<<7,e<De)||(e=n[t+2],r+=(e&Dt)<<14,e<De)||(e=n[t+3],r+=(e&Dt)<<21,e<De)||(e=n[t+4],r+=(e&Dt)*gf,e<De)||(e=n[t+5],r+=(e&Dt)*mf,e<De)||(e=n[t+6],r+=(e&Dt)*yf,e<De)||(e=n[t+7],r+=(e&Dt)*vf,e<De))return r;throw new RangeError("Could not decode varint")}function L2(n,t){let e=n.get(t),r=0;if(r+=e&Dt,e<De||(e=n.get(t+1),r+=(e&Dt)<<7,e<De)||(e=n.get(t+2),r+=(e&Dt)<<14,e<De)||(e=n.get(t+3),r+=(e&Dt)<<21,e<De)||(e=n.get(t+4),r+=(e&Dt)*gf,e<De)||(e=n.get(t+5),r+=(e&Dt)*mf,e<De)||(e=n.get(t+6),r+=(e&Dt)*yf,e<De)||(e=n.get(t+7),r+=(e&Dt)*vf,e<De))return r;throw new RangeError("Could not decode varint")}function Vn(n,t,e=0){return t==null&&(t=cr(ln(n))),t instanceof Uint8Array?Mb(n,t,e):M2(n,t,e)}function Ys(n,t=0){return n instanceof Uint8Array?Lb(n,t):L2(n,t)}const bf=new Float32Array([-0]),ns=new Uint8Array(bf.buffer);function B2(n,t,e){bf[0]=n,t[e]=ns[0],t[e+1]=ns[1],t[e+2]=ns[2],t[e+3]=ns[3]}function N2(n,t){return ns[0]=n[t],ns[1]=n[t+1],ns[2]=n[t+2],ns[3]=n[t+3],bf[0]}const wf=new Float64Array([-0]),Mt=new Uint8Array(wf.buffer);function R2(n,t,e){wf[0]=n,t[e]=Mt[0],t[e+1]=Mt[1],t[e+2]=Mt[2],t[e+3]=Mt[3],t[e+4]=Mt[4],t[e+5]=Mt[5],t[e+6]=Mt[6],t[e+7]=Mt[7]}function O2(n,t){return Mt[0]=n[t],Mt[1]=n[t+1],Mt[2]=n[t+2],Mt[3]=n[t+3],Mt[4]=n[t+4],Mt[5]=n[t+5],Mt[6]=n[t+6],Mt[7]=n[t+7],wf[0]}const F2=BigInt(Number.MAX_SAFE_INTEGER),$2=BigInt(Number.MIN_SAFE_INTEGER);class Rt{constructor(t,e){p(this,"lo");p(this,"hi");this.lo=t|0,this.hi=e|0}toNumber(t=!1){if(!t&&this.hi>>>31>0){const e=~this.lo+1>>>0;let r=~this.hi>>>0;return e===0&&(r=r+1>>>0),-(e+r*4294967296)}return this.lo+this.hi*4294967296}toBigInt(t=!1){if(t)return BigInt(this.lo>>>0)+(BigInt(this.hi>>>0)<<32n);if(this.hi>>>31){const e=~this.lo+1>>>0;let r=~this.hi>>>0;return e===0&&(r=r+1>>>0),-(BigInt(e)+(BigInt(r)<<32n))}return BigInt(this.lo>>>0)+(BigInt(this.hi>>>0)<<32n)}toString(t=!1){return this.toBigInt(t).toString()}zzEncode(){const t=this.hi>>31;return this.hi=((this.hi<<1|this.lo>>>31)^t)>>>0,this.lo=(this.lo<<1^t)>>>0,this}zzDecode(){const t=-(this.lo&1);return this.lo=((this.lo>>>1|this.hi<<31)^t)>>>0,this.hi=(this.hi>>>1^t)>>>0,this}length(){const t=this.lo,e=(this.lo>>>28|this.hi<<4)>>>0,r=this.hi>>>24;return r===0?e===0?t<16384?t<128?1:2:t<2097152?3:4:e<16384?e<128?5:6:e<2097152?7:8:r<128?9:10}static fromBigInt(t){if(t===0n)return Ts;if(t<F2&&t>$2)return this.fromNumber(Number(t));const e=t<0n;e&&(t=-t);let r=t>>32n,s=t-(r<<32n);return e&&(r=~r|0n,s=~s|0n,++s>Wp&&(s=0n,++r>Wp&&(r=0n))),new Rt(Number(s),Number(r))}static fromNumber(t){if(t===0)return Ts;const e=t<0;e&&(t=-t);let r=t>>>0,s=(t-r)/4294967296>>>0;return e&&(s=~s>>>0,r=~r>>>0,++r>4294967295&&(r=0,++s>4294967295&&(s=0))),new Rt(r,s)}static from(t){return typeof t=="number"?Rt.fromNumber(t):typeof t=="bigint"?Rt.fromBigInt(t):typeof t=="string"?Rt.fromBigInt(BigInt(t)):t.low!=null||t.high!=null?new Rt(t.low>>>0,t.high>>>0):Ts}}const Ts=new Rt(0,0);Ts.toBigInt=function(){return 0n};Ts.zzEncode=Ts.zzDecode=function(){return this};Ts.length=function(){return 1};const Wp=4294967296n;function U2(n){let t=0,e=0;for(let r=0;r<n.length;++r)e=n.charCodeAt(r),e<128?t+=1:e<2048?t+=2:(e&64512)===55296&&(n.charCodeAt(r+1)&64512)===56320?(++r,t+=4):t+=3;return t}function V2(n,t,e){if(e-t<1)return"";let s;const i=[];let o=0,a;for(;t<e;)a=n[t++],a<128?i[o++]=a:a>191&&a<224?i[o++]=(a&31)<<6|n[t++]&63:a>239&&a<365?(a=((a&7)<<18|(n[t++]&63)<<12|(n[t++]&63)<<6|n[t++]&63)-65536,i[o++]=55296+(a>>10),i[o++]=56320+(a&1023)):i[o++]=(a&15)<<12|(n[t++]&63)<<6|n[t++]&63,o>8191&&((s??(s=[])).push(String.fromCharCode.apply(String,i)),o=0);return s!=null?(o>0&&s.push(String.fromCharCode.apply(String,i.slice(0,o))),s.join("")):String.fromCharCode.apply(String,i.slice(0,o))}function Bb(n,t,e){const r=e;let s,i;for(let o=0;o<n.length;++o)s=n.charCodeAt(o),s<128?t[e++]=s:s<2048?(t[e++]=s>>6|192,t[e++]=s&63|128):(s&64512)===55296&&((i=n.charCodeAt(o+1))&64512)===56320?(s=65536+((s&1023)<<10)+(i&1023),++o,t[e++]=s>>18|240,t[e++]=s>>12&63|128,t[e++]=s>>6&63|128,t[e++]=s&63|128):(t[e++]=s>>12|224,t[e++]=s>>6&63|128,t[e++]=s&63|128);return e-r}function Bn(n,t){return RangeError(`index out of range: ${n.pos} + ${t??1} > ${n.len}`)}function Ra(n,t){return(n[t-4]|n[t-3]<<8|n[t-2]<<16|n[t-1]<<24)>>>0}class H2{constructor(t){p(this,"buf");p(this,"pos");p(this,"len");p(this,"_slice",Uint8Array.prototype.subarray);this.buf=t,this.pos=0,this.len=t.length}uint32(){let t=4294967295;if(t=(this.buf[this.pos]&127)>>>0,this.buf[this.pos++]<128||(t=(t|(this.buf[this.pos]&127)<<7)>>>0,this.buf[this.pos++]<128)||(t=(t|(this.buf[this.pos]&127)<<14)>>>0,this.buf[this.pos++]<128)||(t=(t|(this.buf[this.pos]&127)<<21)>>>0,this.buf[this.pos++]<128)||(t=(t|(this.buf[this.pos]&15)<<28)>>>0,this.buf[this.pos++]<128))return t;if((this.pos+=5)>this.len)throw this.pos=this.len,Bn(this,10);return t}int32(){return this.uint32()|0}sint32(){const t=this.uint32();return t>>>1^-(t&1)|0}bool(){return this.uint32()!==0}fixed32(){if(this.pos+4>this.len)throw Bn(this,4);return Ra(this.buf,this.pos+=4)}sfixed32(){if(this.pos+4>this.len)throw Bn(this,4);return Ra(this.buf,this.pos+=4)|0}float(){if(this.pos+4>this.len)throw Bn(this,4);const t=N2(this.buf,this.pos);return this.pos+=4,t}double(){if(this.pos+8>this.len)throw Bn(this,4);const t=O2(this.buf,this.pos);return this.pos+=8,t}bytes(){const t=this.uint32(),e=this.pos,r=this.pos+t;if(r>this.len)throw Bn(this,t);return this.pos+=t,e===r?new Uint8Array(0):this.buf.subarray(e,r)}string(){const t=this.bytes();return V2(t,0,t.length)}skip(t){if(typeof t=="number"){if(this.pos+t>this.len)throw Bn(this,t);this.pos+=t}else do if(this.pos>=this.len)throw Bn(this);while((this.buf[this.pos++]&128)!==0);return this}skipType(t){switch(t){case 0:this.skip();break;case 1:this.skip(8);break;case 2:this.skip(this.uint32());break;case 3:for(;(t=this.uint32()&7)!==4;)this.skipType(t);break;case 5:this.skip(4);break;default:throw Error(`invalid wire type ${t} at offset ${this.pos}`)}return this}readLongVarint(){const t=new Rt(0,0);let e=0;if(this.len-this.pos>4){for(;e<4;++e)if(t.lo=(t.lo|(this.buf[this.pos]&127)<<e*7)>>>0,this.buf[this.pos++]<128)return t;if(t.lo=(t.lo|(this.buf[this.pos]&127)<<28)>>>0,t.hi=(t.hi|(this.buf[this.pos]&127)>>4)>>>0,this.buf[this.pos++]<128)return t;e=0}else{for(;e<3;++e){if(this.pos>=this.len)throw Bn(this);if(t.lo=(t.lo|(this.buf[this.pos]&127)<<e*7)>>>0,this.buf[this.pos++]<128)return t}return t.lo=(t.lo|(this.buf[this.pos++]&127)<<e*7)>>>0,t}if(this.len-this.pos>4){for(;e<5;++e)if(t.hi=(t.hi|(this.buf[this.pos]&127)<<e*7+3)>>>0,this.buf[this.pos++]<128)return t}else for(;e<5;++e){if(this.pos>=this.len)throw Bn(this);if(t.hi=(t.hi|(this.buf[this.pos]&127)<<e*7+3)>>>0,this.buf[this.pos++]<128)return t}throw Error("invalid varint encoding")}readFixed64(){if(this.pos+8>this.len)throw Bn(this,8);const t=Ra(this.buf,this.pos+=4),e=Ra(this.buf,this.pos+=4);return new Rt(t,e)}int64(){return this.readLongVarint().toBigInt()}int64Number(){return this.readLongVarint().toNumber()}int64String(){return this.readLongVarint().toString()}uint64(){return this.readLongVarint().toBigInt(!0)}uint64Number(){const t=Lb(this.buf,this.pos);return this.pos+=ln(t),t}uint64String(){return this.readLongVarint().toString(!0)}sint64(){return this.readLongVarint().zzDecode().toBigInt()}sint64Number(){return this.readLongVarint().zzDecode().toNumber()}sint64String(){return this.readLongVarint().zzDecode().toString()}fixed64(){return this.readFixed64().toBigInt()}fixed64Number(){return this.readFixed64().toNumber()}fixed64String(){return this.readFixed64().toString()}sfixed64(){return this.readFixed64().toBigInt()}sfixed64Number(){return this.readFixed64().toNumber()}sfixed64String(){return this.readFixed64().toString()}}function z2(n){return new H2(n instanceof Uint8Array?n:n.subarray())}function Ie(n,t,e){const r=z2(n);return t.decode(r,void 0,e)}const q2=_a({prefix:"9",name:"base10",alphabet:"0123456789"}),W2=Object.freeze(Object.defineProperty({__proto__:null,base10:q2},Symbol.toStringTag,{value:"Module"})),G2=Ct({prefix:"f",name:"base16",alphabet:"0123456789abcdef",bitsPerChar:4}),K2=Ct({prefix:"F",name:"base16upper",alphabet:"0123456789ABCDEF",bitsPerChar:4}),Y2=Object.freeze(Object.defineProperty({__proto__:null,base16:G2,base16upper:K2},Symbol.toStringTag,{value:"Module"})),Q2=Ct({prefix:"0",name:"base2",alphabet:"01",bitsPerChar:1}),Z2=Object.freeze(Object.defineProperty({__proto__:null,base2:Q2},Symbol.toStringTag,{value:"Module"})),Nb=Array.from("🚀🪐☄🛰🌌🌑🌒🌓🌔🌕🌖🌗🌘🌍🌏🌎🐉☀💻🖥💾💿😂❤😍🤣😊🙏💕😭😘👍😅👏😁🔥🥰💔💖💙😢🤔😆🙄💪😉☺👌🤗💜😔😎😇🌹🤦🎉💞✌✨🤷😱😌🌸🙌😋💗💚😏💛🙂💓🤩😄😀🖤😃💯🙈👇🎶😒🤭❣😜💋👀😪😑💥🙋😞😩😡🤪👊🥳😥🤤👉💃😳✋😚😝😴🌟😬🙃🍀🌷😻😓⭐✅🥺🌈😈🤘💦✔😣🏃💐☹🎊💘😠☝😕🌺🎂🌻😐🖕💝🙊😹🗣💫💀👑🎵🤞😛🔴😤🌼😫⚽🤙☕🏆🤫👈😮🙆🍻🍃🐶💁😲🌿🧡🎁⚡🌞🎈❌✊👋😰🤨😶🤝🚶💰🍓💢🤟🙁🚨💨🤬✈🎀🍺🤓😙💟🌱😖👶🥴▶➡❓💎💸⬇😨🌚🦋😷🕺⚠🙅😟😵👎🤲🤠🤧📌🔵💅🧐🐾🍒😗🤑🌊🤯🐷☎💧😯💆👆🎤🙇🍑❄🌴💣🐸💌📍🥀🤢👅💡💩👐📸👻🤐🤮🎼🥵🚩🍎🍊👼💍📣🥂"),X2=Nb.reduce((n,t,e)=>(n[e]=t,n),[]),j2=Nb.reduce((n,t,e)=>{const r=t.codePointAt(0);if(r==null)throw new Error(`Invalid character: ${t}`);return n[r]=e,n},[]);function J2(n){return n.reduce((t,e)=>(t+=X2[e],t),"")}function eI(n){const t=[];for(const e of n){const r=e.codePointAt(0);if(r==null)throw new Error(`Invalid character: ${e}`);const s=j2[r];if(s==null)throw new Error(`Non-base256emoji character: ${e}`);t.push(s)}return new Uint8Array(t)}const tI=Tl({prefix:"🚀",name:"base256emoji",encode:J2,decode:eI}),nI=Object.freeze(Object.defineProperty({__proto__:null,base256emoji:tI},Symbol.toStringTag,{value:"Module"})),Ea=Ct({prefix:"m",name:"base64",alphabet:"ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/",bitsPerChar:6}),rI=Ct({prefix:"M",name:"base64pad",alphabet:"ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/=",bitsPerChar:6}),Rb=Ct({prefix:"u",name:"base64url",alphabet:"ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789-_",bitsPerChar:6}),sI=Ct({prefix:"U",name:"base64urlpad",alphabet:"ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789-_=",bitsPerChar:6}),iI=Object.freeze(Object.defineProperty({__proto__:null,base64:Ea,base64pad:rI,base64url:Rb,base64urlpad:sI},Symbol.toStringTag,{value:"Module"})),oI=Ct({prefix:"7",name:"base8",alphabet:"01234567",bitsPerChar:3}),aI=Object.freeze(Object.defineProperty({__proto__:null,base8:oI},Symbol.toStringTag,{value:"Module"})),cI=Tl({prefix:"\0",name:"identity",encode:n=>bA(n),decode:n=>vA(n)}),lI=Object.freeze(Object.defineProperty({__proto__:null,identity:cI},Symbol.toStringTag,{value:"Module"}));new TextEncoder;new TextDecoder;function uI({name:n,code:t,encode:e}){return new dI(n,t,e)}class dI{constructor(t,e,r){p(this,"name");p(this,"code");p(this,"encode");this.name=t,this.code=e,this.encode=r}digest(t){if(t instanceof Uint8Array){const e=this.encode(t);return e instanceof Uint8Array?Bs(this.code,e):e.then(r=>Bs(this.code,r))}else throw Error("Unknown type, must be binary type")}}function hI(n){return async t=>new Uint8Array(await crypto.subtle.digest(n,t))}const Aa=uI({name:"sha2-256",code:18,encode:hI("SHA-256")}),Nd={...lI,...Z2,...aI,...W2,...Y2,...$A,...VA,...PA,...iI,...nI};function Ob(n,t,e,r){return{name:n,prefix:t,encoder:{name:n,prefix:t,encode:e},decoder:{decode:r}}}const Gp=Ob("utf8","u",n=>"u"+new TextDecoder("utf8").decode(n),n=>new TextEncoder().encode(n.substring(1))),mu=Ob("ascii","a",n=>{let t="a";for(let e=0;e<n.length;e++)t+=String.fromCharCode(n[e]);return t},n=>{n=n.substring(1);const t=cr(n.length);for(let e=0;e<n.length;e++)t[e]=n.charCodeAt(e);return t}),Fb={utf8:Gp,"utf-8":Gp,hex:Nd.base16,latin1:mu,ascii:mu,binary:mu,...Nd};function te(n,t="utf8"){const e=Fb[t];if(e==null)throw new Error(`Unsupported encoding "${t}"`);return e.decoder.decode(`${e.prefix}${n}`)}function fI(n){let r,s=8192;return function(o){if(o<1||o>4096)return cr(o);s+o>8192&&(r=cr(8192),s=0);const a=r.subarray(s,s+=o);return(s&7)!==0&&(s=(s|7)+1),a}}class Co{constructor(t,e,r){p(this,"fn");p(this,"len");p(this,"next");p(this,"val");this.fn=t,this.len=e,this.next=void 0,this.val=r}}function yu(){}class pI{constructor(t){p(this,"head");p(this,"tail");p(this,"len");p(this,"next");this.head=t.head,this.tail=t.tail,this.len=t.len,this.next=t.states}}const gI=fI();function mI(n){return globalThis.Buffer!=null?cr(n):gI(n)}class Rd{constructor(){p(this,"len");p(this,"head");p(this,"tail");p(this,"states");this.len=0,this.head=new Co(yu,0,0),this.tail=this.head,this.states=null}_push(t,e,r){return this.tail=this.tail.next=new Co(t,e,r),this.len+=e,this}uint32(t){return this.len+=(this.tail=this.tail.next=new vI((t=t>>>0)<128?1:t<16384?2:t<2097152?3:t<268435456?4:5,t)).len,this}int32(t){return t<0?this._push(Oa,10,Rt.fromNumber(t)):this.uint32(t)}sint32(t){return this.uint32((t<<1^t>>31)>>>0)}uint64(t){const e=Rt.fromBigInt(t);return this._push(Oa,e.length(),e)}uint64Number(t){return this._push(Mb,ln(t),t)}uint64String(t){return this.uint64(BigInt(t))}int64(t){return this.uint64(t)}int64Number(t){return this.uint64Number(t)}int64String(t){return this.uint64String(t)}sint64(t){const e=Rt.fromBigInt(t).zzEncode();return this._push(Oa,e.length(),e)}sint64Number(t){const e=Rt.fromNumber(t).zzEncode();return this._push(Oa,e.length(),e)}sint64String(t){return this.sint64(BigInt(t))}bool(t){return this._push(vu,1,t?1:0)}fixed32(t){return this._push(So,4,t>>>0)}sfixed32(t){return this.fixed32(t)}fixed64(t){const e=Rt.fromBigInt(t);return this._push(So,4,e.lo)._push(So,4,e.hi)}fixed64Number(t){const e=Rt.fromNumber(t);return this._push(So,4,e.lo)._push(So,4,e.hi)}fixed64String(t){return this.fixed64(BigInt(t))}sfixed64(t){return this.fixed64(t)}sfixed64Number(t){return this.fixed64Number(t)}sfixed64String(t){return this.fixed64String(t)}float(t){return this._push(B2,4,t)}double(t){return this._push(R2,8,t)}bytes(t){const e=t.length>>>0;return e===0?this._push(vu,1,0):this.uint32(e)._push(bI,e,t)}string(t){const e=U2(t);return e!==0?this.uint32(e)._push(Bb,e,t):this._push(vu,1,0)}fork(){return this.states=new pI(this),this.head=this.tail=new Co(yu,0,0),this.len=0,this}reset(){return this.states!=null?(this.head=this.states.head,this.tail=this.states.tail,this.len=this.states.len,this.states=this.states.next):(this.head=this.tail=new Co(yu,0,0),this.len=0),this}ldelim(){const t=this.head,e=this.tail,r=this.len;return this.reset().uint32(r),r!==0&&(this.tail.next=t.next,this.tail=e,this.len+=r),this}finish(){let t=this.head.next;const e=mI(this.len);let r=0;for(;t!=null;)t.fn(t.val,e,r),r+=t.len,t=t.next;return e}}function vu(n,t,e){t[e]=n&255}function yI(n,t,e){for(;n>127;)t[e++]=n&127|128,n>>>=7;t[e]=n}class vI extends Co{constructor(e,r){super(yI,e,r);p(this,"next");this.next=void 0}}function Oa(n,t,e){for(;n.hi!==0;)t[e++]=n.lo&127|128,n.lo=(n.lo>>>7|n.hi<<25)>>>0,n.hi>>>=7;for(;n.lo>127;)t[e++]=n.lo&127|128,n.lo=n.lo>>>7;t[e++]=n.lo}function So(n,t,e){t[e]=n&255,t[e+1]=n>>>8&255,t[e+2]=n>>>16&255,t[e+3]=n>>>24}function bI(n,t,e){t.set(n,e)}globalThis.Buffer!=null&&(Rd.prototype.bytes=function(n){const t=n.length>>>0;return this.uint32(t),t>0&&this._push(wI,t,n),this},Rd.prototype.string=function(n){const t=globalThis.Buffer.byteLength(n);return this.uint32(t),t>0&&this._push(_I,t,n),this});function wI(n,t,e){t.set(n,e)}function _I(n,t,e){n.length<40?Bb(n,t,e):t.utf8Write!=null?t.utf8Write(n,e):t.set(te(n),e)}function SI(){return new Rd}function ke(n,t){const e=SI();return t.encode(n,e,{lengthDelimited:!1}),e.finish()}var Dc;(function(n){n[n.VARINT=0]="VARINT",n[n.BIT64=1]="BIT64",n[n.LENGTH_DELIMITED=2]="LENGTH_DELIMITED",n[n.START_GROUP=3]="START_GROUP",n[n.END_GROUP=4]="END_GROUP",n[n.BIT32=5]="BIT32"})(Dc||(Dc={}));function $b(n,t,e,r){return{name:n,type:t,encode:e,decode:r}}function xa(n){function t(s){if(n[s.toString()]==null)throw new Error("Invalid enum value");return n[s]}const e=function(i,o){const a=t(i);o.int32(a)},r=function(i){const o=i.int32();return t(o)};return $b("enum",Dc.VARINT,e,r)}function Te(n,t){return $b("message",Dc.LENGTH_DELIMITED,n,t)}class gt extends Error{constructor(){super(...arguments);p(this,"code","ERR_MAX_LENGTH");p(this,"name","MaxLengthError")}}class Kp extends Error{constructor(){super(...arguments);p(this,"code","ERR_MAX_SIZE");p(this,"name","MaxSizeError")}}var at;(function(n){n.RSA="RSA",n.Ed25519="Ed25519",n.secp256k1="secp256k1"})(at||(at={}));var Od;(function(n){n[n.RSA=0]="RSA",n[n.Ed25519=1]="Ed25519",n[n.secp256k1=2]="secp256k1"})(Od||(Od={}));(function(n){n.codec=()=>xa(Od)})(at||(at={}));var ls;(function(n){let t;n.codec=()=>(t==null&&(t=Te((e,r,s={})=>{s.lengthDelimited!==!1&&r.fork(),e.Type!=null&&(r.uint32(8),at.codec().encode(e.Type,r)),e.Data!=null&&(r.uint32(18),r.bytes(e.Data)),s.lengthDelimited!==!1&&r.ldelim()},(e,r,s={})=>{const i={},o=r==null?e.len:e.pos+r;for(;e.pos<o;){const a=e.uint32();switch(a>>>3){case 1:{i.Type=at.codec().decode(e);break}case 2:{i.Data=e.bytes();break}default:{e.skipType(a&7);break}}}return i})),t),n.encode=e=>ke(e,n.codec()),n.decode=(e,r)=>Ie(e,n.codec(),r)})(ls||(ls={}));var Mc;(function(n){let t;n.codec=()=>(t==null&&(t=Te((e,r,s={})=>{s.lengthDelimited!==!1&&r.fork(),e.Type!=null&&(r.uint32(8),at.codec().encode(e.Type,r)),e.Data!=null&&(r.uint32(18),r.bytes(e.Data)),s.lengthDelimited!==!1&&r.ldelim()},(e,r,s={})=>{const i={},o=r==null?e.len:e.pos+r;for(;e.pos<o;){const a=e.uint32();switch(a>>>3){case 1:{i.Type=at.codec().decode(e);break}case 2:{i.Data=e.bytes();break}default:{e.skipType(a&7);break}}}return i})),t),n.encode=e=>ke(e,n.codec()),n.decode=(e,r)=>Ie(e,n.codec(),r)})(Mc||(Mc={}));const EI=new Uint32Array([1116352408,1899447441,3049323471,3921009573,961987163,1508970993,2453635748,2870763221,3624381080,310598401,607225278,1426881987,1925078388,2162078206,2614888103,3248222580,3835390401,4022224774,264347078,604807628,770255983,1249150122,1555081692,1996064986,2554220882,2821834349,2952996808,3210313671,3336571891,3584528711,113926993,338241895,666307205,773529912,1294757372,1396182291,1695183700,1986661051,2177026350,2456956037,2730485921,2820302411,3259730800,3345764771,3516065817,3600352804,4094571909,275423344,430227734,506948616,659060556,883997877,958139571,1322822218,1537002063,1747873779,1955562222,2024104815,2227730452,2361852424,2428436474,2756734187,3204031479,3329325298]),qr=new Uint32Array([1779033703,3144134277,1013904242,2773480762,1359893119,2600822924,528734635,1541459225]),Wr=new Uint32Array(64);class AI extends lf{constructor(){super(64,32,8,!1),this.A=qr[0]|0,this.B=qr[1]|0,this.C=qr[2]|0,this.D=qr[3]|0,this.E=qr[4]|0,this.F=qr[5]|0,this.G=qr[6]|0,this.H=qr[7]|0}get(){const{A:t,B:e,C:r,D:s,E:i,F:o,G:a,H:l}=this;return[t,e,r,s,i,o,a,l]}set(t,e,r,s,i,o,a,l){this.A=t|0,this.B=e|0,this.C=r|0,this.D=s|0,this.E=i|0,this.F=o|0,this.G=a|0,this.H=l|0}process(t,e){for(let c=0;c<16;c++,e+=4)Wr[c]=t.getUint32(e,!1);for(let c=16;c<64;c++){const d=Wr[c-15],f=Wr[c-2],g=Kn(d,7)^Kn(d,18)^d>>>3,y=Kn(f,17)^Kn(f,19)^f>>>10;Wr[c]=y+Wr[c-7]+g+Wr[c-16]|0}let{A:r,B:s,C:i,D:o,E:a,F:l,G:u,H:h}=this;for(let c=0;c<64;c++){const d=Kn(a,6)^Kn(a,11)^Kn(a,25),f=h+d+vb(a,l,u)+EI[c]+Wr[c]|0,y=(Kn(r,2)^Kn(r,13)^Kn(r,22))+bb(r,s,i)|0;h=u,u=l,l=a,a=o+f|0,o=i,i=s,s=r,r=f+y|0}r=r+this.A|0,s=s+this.B|0,i=i+this.C|0,o=o+this.D|0,a=a+this.E|0,l=l+this.F|0,u=u+this.G|0,h=h+this.H|0,this.set(r,s,i,o,a,l,u,h)}roundClean(){Wr.fill(0)}destroy(){this.set(0,0,0,0,0,0,0,0),this.buffer.fill(0)}}const Ia=af(()=>new AI);function de(n,t="utf8"){const e=Fb[t];if(e==null)throw new Error(`Unsupported encoding "${t}"`);return e.encoder.encode(n).substring(1)}function bn(n,t){t==null&&(t=n.reduce((s,i)=>s+i.length,0));const e=cr(t);let r=0;for(const s of n)e.set(s,r),r+=s.length;return e}const Ub=Symbol.for("@achingbrain/uint8arraylist");function Yp(n,t){if(t==null||t<0)throw new RangeError("index is out of bounds");let e=0;for(const r of n){const s=e+r.byteLength;if(t<s)return{buf:r,index:t-e};e=s}throw new RangeError("index is out of bounds")}function Fa(n){return!!n?.[Ub]}var Xm;class We{constructor(...t){p(this,"bufs");p(this,"length");p(this,Xm,!0);this.bufs=[],this.length=0,t.length>0&&this.appendAll(t)}*[(Xm=Ub,Symbol.iterator)](){yield*this.bufs}get byteLength(){return this.length}append(...t){this.appendAll(t)}appendAll(t){let e=0;for(const r of t)if(r instanceof Uint8Array)e+=r.byteLength,this.bufs.push(r);else if(Fa(r))e+=r.byteLength,this.bufs.push(...r.bufs);else throw new Error("Could not append value, must be an Uint8Array or a Uint8ArrayList");this.length+=e}prepend(...t){this.prependAll(t)}prependAll(t){let e=0;for(const r of t.reverse())if(r instanceof Uint8Array)e+=r.byteLength,this.bufs.unshift(r);else if(Fa(r))e+=r.byteLength,this.bufs.unshift(...r.bufs);else throw new Error("Could not prepend value, must be an Uint8Array or a Uint8ArrayList");this.length+=e}get(t){const e=Yp(this.bufs,t);return e.buf[e.index]}set(t,e){const r=Yp(this.bufs,t);r.buf[r.index]=e}write(t,e=0){if(t instanceof Uint8Array)for(let r=0;r<t.length;r++)this.set(e+r,t[r]);else if(Fa(t))for(let r=0;r<t.length;r++)this.set(e+r,t.get(r));else throw new Error("Could not write value, must be an Uint8Array or a Uint8ArrayList")}consume(t){if(t=Math.trunc(t),!(Number.isNaN(t)||t<=0)){if(t===this.byteLength){this.bufs=[],this.length=0;return}for(;this.bufs.length>0;)if(t>=this.bufs[0].byteLength)t-=this.bufs[0].byteLength,this.length-=this.bufs[0].byteLength,this.bufs.shift();else{this.bufs[0]=this.bufs[0].subarray(t),this.length-=t;break}}}slice(t,e){const{bufs:r,length:s}=this._subList(t,e);return bn(r,s)}subarray(t,e){const{bufs:r,length:s}=this._subList(t,e);return r.length===1?r[0]:bn(r,s)}sublist(t,e){const{bufs:r,length:s}=this._subList(t,e),i=new We;return i.length=s,i.bufs=[...r],i}_subList(t,e){if(t=t??0,e=e??this.length,t<0&&(t=this.length+t),e<0&&(e=this.length+e),t<0||e>this.length)throw new RangeError("index is out of bounds");if(t===e)return{bufs:[],length:0};if(t===0&&e===this.length)return{bufs:this.bufs,length:this.length};const r=[];let s=0;for(let i=0;i<this.bufs.length;i++){const o=this.bufs[i],a=s,l=a+o.byteLength;if(s=l,t>=l)continue;const u=t>=a&&t<l,h=e>a&&e<=l;if(u&&h){if(t===a&&e===l){r.push(o);break}const c=t-a;r.push(o.subarray(c,c+(e-t)));break}if(u){if(t===0){r.push(o);continue}r.push(o.subarray(t-a));continue}if(h){if(e===l){r.push(o);break}r.push(o.subarray(0,e-a));break}r.push(o)}return{bufs:r,length:e-t}}indexOf(t,e=0){if(!Fa(t)&&!(t instanceof Uint8Array))throw new TypeError('The "value" argument must be a Uint8ArrayList or Uint8Array');const r=t instanceof Uint8Array?t:t.subarray();if(e=Number(e??0),isNaN(e)&&(e=0),e<0&&(e=this.length+e),e<0&&(e=0),t.length===0)return e>this.length?this.length:e;const s=r.byteLength;if(s===0)throw new TypeError("search must be at least 1 byte long");const i=256,o=new Int32Array(i);for(let c=0;c<i;c++)o[c]=-1;for(let c=0;c<s;c++)o[r[c]]=c;const a=o,l=this.byteLength-r.byteLength,u=r.byteLength-1;let h;for(let c=e;c<=l;c+=h){h=0;for(let d=u;d>=0;d--){const f=this.get(c+d);if(r[d]!==f){h=Math.max(1,d-a[f]);break}}if(h===0)return c}return-1}getInt8(t){const e=this.subarray(t,t+1);return new DataView(e.buffer,e.byteOffset,e.byteLength).getInt8(0)}setInt8(t,e){const r=cr(1);new DataView(r.buffer,r.byteOffset,r.byteLength).setInt8(0,e),this.write(r,t)}getInt16(t,e){const r=this.subarray(t,t+2);return new DataView(r.buffer,r.byteOffset,r.byteLength).getInt16(0,e)}setInt16(t,e,r){const s=Ge(2);new DataView(s.buffer,s.byteOffset,s.byteLength).setInt16(0,e,r),this.write(s,t)}getInt32(t,e){const r=this.subarray(t,t+4);return new DataView(r.buffer,r.byteOffset,r.byteLength).getInt32(0,e)}setInt32(t,e,r){const s=Ge(4);new DataView(s.buffer,s.byteOffset,s.byteLength).setInt32(0,e,r),this.write(s,t)}getBigInt64(t,e){const r=this.subarray(t,t+8);return new DataView(r.buffer,r.byteOffset,r.byteLength).getBigInt64(0,e)}setBigInt64(t,e,r){const s=Ge(8);new DataView(s.buffer,s.byteOffset,s.byteLength).setBigInt64(0,e,r),this.write(s,t)}getUint8(t){const e=this.subarray(t,t+1);return new DataView(e.buffer,e.byteOffset,e.byteLength).getUint8(0)}setUint8(t,e){const r=cr(1);new DataView(r.buffer,r.byteOffset,r.byteLength).setUint8(0,e),this.write(r,t)}getUint16(t,e){const r=this.subarray(t,t+2);return new DataView(r.buffer,r.byteOffset,r.byteLength).getUint16(0,e)}setUint16(t,e,r){const s=Ge(2);new DataView(s.buffer,s.byteOffset,s.byteLength).setUint16(0,e,r),this.write(s,t)}getUint32(t,e){const r=this.subarray(t,t+4);return new DataView(r.buffer,r.byteOffset,r.byteLength).getUint32(0,e)}setUint32(t,e,r){const s=Ge(4);new DataView(s.buffer,s.byteOffset,s.byteLength).setUint32(0,e,r),this.write(s,t)}getBigUint64(t,e){const r=this.subarray(t,t+8);return new DataView(r.buffer,r.byteOffset,r.byteLength).getBigUint64(0,e)}setBigUint64(t,e,r){const s=Ge(8);new DataView(s.buffer,s.byteOffset,s.byteLength).setBigUint64(0,e,r),this.write(s,t)}getFloat32(t,e){const r=this.subarray(t,t+4);return new DataView(r.buffer,r.byteOffset,r.byteLength).getFloat32(0,e)}setFloat32(t,e,r){const s=Ge(4);new DataView(s.buffer,s.byteOffset,s.byteLength).setFloat32(0,e,r),this.write(s,t)}getFloat64(t,e){const r=this.subarray(t,t+8);return new DataView(r.buffer,r.byteOffset,r.byteLength).getFloat64(0,e)}setFloat64(t,e,r){const s=Ge(8);new DataView(s.buffer,s.byteOffset,s.byteLength).setFloat64(0,e,r),this.write(s,t)}equals(t){if(t==null||!(t instanceof We)||t.bufs.length!==this.bufs.length)return!1;for(let e=0;e<this.bufs.length;e++)if(!It(this.bufs[e],t.bufs[e]))return!1;return!0}static fromUint8Arrays(t,e){const r=new We;return r.bufs=t,e==null&&(e=t.reduce((s,i)=>s+i.byteLength,0)),r.length=e,r}}const xI=parseInt("11111",2),Fd=parseInt("10000000",2),II=parseInt("01111111",2),Qp={2:kI,3:PI,5:CI,6:TI,16:bu,22:bu,48:bu};function Rl(n,t={offset:0}){const e=n[t.offset]&xI;if(t.offset++,Qp[e]!=null)return Qp[e](n,t);throw new Error("No decoder for tag "+e)}function Ol(n,t){let e=0;if((n[t.offset]&Fd)===Fd){const r=n[t.offset]&II;let s="0x";t.offset++;for(let i=0;i<r;i++,t.offset++)s+=n[t.offset].toString(16).padStart(2,"0");e=parseInt(s,16)}else e=n[t.offset],t.offset++;return e}function bu(n,t){Ol(n,t);const e=[];for(;!(t.offset>=n.byteLength);){const r=Rl(n,t);if(r===null)break;e.push(r)}return e}function kI(n,t){const e=Ol(n,t),r=t.offset,s=t.offset+e,i=[];for(let o=r;o<s;o++)o===r&&n[o]===0||i.push(n[o]);return t.offset+=e,Uint8Array.from(i)}function TI(n,t){const e=Ol(n,t);return t.offset+=e,["oid-unimplemented"]}function CI(n,t){return t.offset++,null}function PI(n,t){const e=Ol(n,t),r=n[t.offset];t.offset++;const s=n.subarray(t.offset,t.offset+e);if(t.offset+=e,r!==0)throw new Error("Unused bits in bit string is unimplemented");return Rl(s,{offset:0})}function DI(n){let t=n.toString(16);t.length%2===1&&(t="0"+t);const e=new We;for(let r=0;r<t.length;r+=2)e.append(Uint8Array.from([parseInt(`${t[r]}${t[r+1]}`,16)]));return e}function _f(n){if(n.byteLength<128)return Uint8Array.from([n.byteLength]);const t=DI(n.byteLength);return new We(Uint8Array.from([t.byteLength|Fd]),t)}function Rn(n){const t=new We,e=parseInt("10000000",2);return(n.subarray()[0]&e)===e&&t.append(Uint8Array.from([0])),t.append(n),new We(Uint8Array.from([2]),_f(t),t)}function MI(n){const t=Uint8Array.from([0]),e=new We(t,n);return new We(Uint8Array.from([3]),_f(e),e)}function $d(n){const t=new We;for(const e of n)t.append(e);return new We(Uint8Array.from([48]),_f(t),t)}function Ui(n){if(isNaN(n)||n<=0)throw new X("random bytes length must be a Number bigger than 0");return cf(n)}class Zp extends Error{constructor(t="An error occurred while signing a message"){super(t),this.name="SigningError"}}class Xp extends Error{constructor(t="An error occurred while verifying a message"){super(t),this.name="VerificationError"}}class LI extends Error{constructor(t="Missing Web Crypto API"){super(t),this.name="WebCryptoMissingError"}}const lr={get(n=globalThis){const t=n.crypto;if(t?.subtle==null)throw new LI("Missing Web Crypto API. The most likely cause of this error is that this page is being accessed from an insecure context (i.e. not HTTPS). For more information and possible resolutions see https://github.com/libp2p/js-libp2p/blob/main/packages/crypto/README.md#web-crypto-api");return t}};async function BI(n){const t=await lr.get().subtle.generateKey({name:"RSASSA-PKCS1-v1_5",modulusLength:n,publicExponent:new Uint8Array([1,0,1]),hash:{name:"SHA-256"}},!0,["sign","verify"]),e=await OI(t);return{privateKey:e[0],publicKey:e[1]}}async function NI(n,t){const e=await lr.get().subtle.importKey("jwk",n,{name:"RSASSA-PKCS1-v1_5",hash:{name:"SHA-256"}},!1,["sign"]),r=await lr.get().subtle.sign({name:"RSASSA-PKCS1-v1_5"},e,t instanceof Uint8Array?t:t.subarray());return new Uint8Array(r,0,r.byteLength)}async function RI(n,t,e){const r=await lr.get().subtle.importKey("jwk",n,{name:"RSASSA-PKCS1-v1_5",hash:{name:"SHA-256"}},!1,["verify"]);return lr.get().subtle.verify({name:"RSASSA-PKCS1-v1_5"},r,t,e instanceof Uint8Array?e:e.subarray())}async function OI(n){if(n.privateKey==null||n.publicKey==null)throw new X("Private and public key are required");return Promise.all([lr.get().subtle.exportKey("jwk",n.privateKey),lr.get().subtle.exportKey("jwk",n.publicKey)])}function FI(n){if(n.kty!=="RSA")throw new X("invalid key type");if(n.n==null)throw new X("invalid key modulus");return te(n.n,"base64url").length*8}class Sf{constructor(t,e){p(this,"type","RSA");p(this,"_key");p(this,"_raw");p(this,"_multihash");this._key=t,this._multihash=e}get raw(){return this._raw==null&&(this._raw=Af(this._key)),this._raw}toMultihash(){return this._multihash}toCID(){return Ye.createV1(114,this._multihash)}toString(){return ot.encode(this.toMultihash().bytes).substring(1)}equals(t){return t==null||!(t.raw instanceof Uint8Array)?!1:It(this.raw,t.raw)}verify(t,e){return RI(this._key,e,t)}}class Vb{constructor(t,e){p(this,"type","RSA");p(this,"_key");p(this,"_raw");p(this,"publicKey");this._key=t,this.publicKey=e}get raw(){return this._raw==null&&(this._raw=zI(this._key)),this._raw}equals(t){return t==null||!(t.raw instanceof Uint8Array)?!1:It(this.raw,t.raw)}sign(t){return NI(this._key,t)}}const $I=8192,Ef=18,UI=1062,VI=Uint8Array.from([48,13,6,9,42,134,72,134,247,13,1,1,1,5,0]);function HI(n){const t=Rl(n);return{n:de(t[1],"base64url"),e:de(t[2],"base64url"),d:de(t[3],"base64url"),p:de(t[4],"base64url"),q:de(t[5],"base64url"),dp:de(t[6],"base64url"),dq:de(t[7],"base64url"),qi:de(t[8],"base64url"),kty:"RSA"}}function zI(n){if(n.n==null||n.e==null||n.d==null||n.p==null||n.q==null||n.dp==null||n.dq==null||n.qi==null)throw new X("JWK was missing components");return $d([Rn(Uint8Array.from([0])),Rn(te(n.n,"base64url")),Rn(te(n.e,"base64url")),Rn(te(n.d,"base64url")),Rn(te(n.p,"base64url")),Rn(te(n.q,"base64url")),Rn(te(n.dp,"base64url")),Rn(te(n.dq,"base64url")),Rn(te(n.qi,"base64url"))]).subarray()}function qI(n){const t=Rl(n,{offset:0});return{kty:"RSA",n:de(t[1][0],"base64url"),e:de(t[1][1],"base64url")}}function Af(n){if(n.n==null||n.e==null)throw new X("JWK was missing components");return $d([VI,MI($d([Rn(te(n.n,"base64url")),Rn(te(n.e,"base64url"))]))]).subarray()}function Hb(n){const t=HI(n);return WI(t)}function zb(n,t){if(n.byteLength>=UI)throw new jh("Key size is too large");const e=qI(n);if(t==null){const r=Ia(ls.encode({Type:at.RSA,Data:n}));t=Bs(Ef,r)}return new Sf(e,t)}function WI(n){if(FI(n)>$I)throw new X("Key size is too large");const t=KI(n),e=Ia(ls.encode({Type:at.RSA,Data:Af(t.publicKey)})),r=Bs(Ef,e);return new Vb(t.privateKey,new Sf(t.publicKey,r))}async function GI(n){const t=await BI(n),e=Ia(ls.encode({Type:at.RSA,Data:Af(t.publicKey)})),r=Bs(Ef,e);return new Vb(t.privateKey,new Sf(t.publicKey,r))}function KI(n){if(n==null)throw new X("Missing key parameter");return{privateKey:n,publicKey:{kty:n.kty,n:n.n,e:n.e}}}class qb extends yb{constructor(t,e){super(),this.finished=!1,this.destroyed=!1,mb(t);const r=Zo(e);if(this.iHash=t.create(),typeof this.iHash.update!="function")throw new Error("Expected instance of class which extends utils.Hash");this.blockLen=this.iHash.blockLen,this.outputLen=this.iHash.outputLen;const s=this.blockLen,i=new Uint8Array(s);i.set(r.length>s?t.create().update(r).digest():r);for(let o=0;o<i.length;o++)i[o]^=54;this.iHash.update(i),this.oHash=t.create();for(let o=0;o<i.length;o++)i[o]^=106;this.oHash.update(i),i.fill(0)}update(t){return Tc(this),this.iHash.update(t),this}digestInto(t){Tc(this),Pl(t,this.outputLen),this.finished=!0,this.iHash.digestInto(t),this.oHash.update(t),this.oHash.digestInto(t),this.destroy()}digest(){const t=new Uint8Array(this.oHash.outputLen);return this.digestInto(t),t}_cloneInto(t){t||(t=Object.create(Object.getPrototypeOf(this),{}));const{oHash:e,iHash:r,finished:s,destroyed:i,blockLen:o,outputLen:a}=this;return t=t,t.finished=s,t.destroyed=i,t.blockLen=o,t.outputLen=a,t.oHash=e._cloneInto(t.oHash),t.iHash=r._cloneInto(t.iHash),t}destroy(){this.destroyed=!0,this.oHash.destroy(),this.iHash.destroy()}}const xf=(n,t,e)=>new qb(n,t).update(e).digest();xf.create=(n,t)=>new qb(n,t);/*! noble-curves - MIT License (c) 2022 Paul Miller (paulmillr.com) */function jp(n){n.lowS!==void 0&&Pr("lowS",n.lowS),n.prehash!==void 0&&Pr("prehash",n.prehash)}function YI(n){const t=hf(n);lo(t,{a:"field",b:"field"},{allowedPrivateKeyLengths:"array",wrapPrivateKey:"boolean",isTorsionFree:"function",clearCofactor:"function",allowInfinityPoint:"boolean",fromBytes:"function",toBytes:"function"});const{endo:e,Fp:r,a:s}=t;if(e){if(!r.eql(s,r.ZERO))throw new Error("invalid endomorphism, can only be defined for Koblitz curves that have a=0");if(typeof e!="object"||typeof e.beta!="bigint"||typeof e.splitScalar!="function")throw new Error("invalid endomorphism, expected beta: bigint and splitScalar: function")}return Object.freeze({...t})}const{bytesToNumberBE:QI,hexToBytes:ZI}=Jx;class XI extends Error{constructor(t=""){super(t)}}const wr={Err:XI,_tlv:{encode:(n,t)=>{const{Err:e}=wr;if(n<0||n>256)throw new e("tlv.encode: wrong tag");if(t.length&1)throw new e("tlv.encode: unpadded data");const r=t.length/2,s=pi(r);if(s.length/2&128)throw new e("tlv.encode: long form length too big");const i=r>127?pi(s.length/2|128):"";return pi(n)+i+s+t},decode(n,t){const{Err:e}=wr;let r=0;if(n<0||n>256)throw new e("tlv.encode: wrong tag");if(t.length<2||t[r++]!==n)throw new e("tlv.decode: wrong tlv");const s=t[r++],i=!!(s&128);let o=0;if(!i)o=s;else{const l=s&127;if(!l)throw new e("tlv.decode(long): indefinite length not supported");if(l>4)throw new e("tlv.decode(long): byte length is too big");const u=t.subarray(r,r+l);if(u.length!==l)throw new e("tlv.decode: length bytes not complete");if(u[0]===0)throw new e("tlv.decode(long): zero leftmost byte");for(const h of u)o=o<<8|h;if(r+=l,o<128)throw new e("tlv.decode(long): not minimal encoding")}const a=t.subarray(r,r+o);if(a.length!==o)throw new e("tlv.decode: wrong value length");return{v:a,l:t.subarray(r+o)}}},_int:{encode(n){const{Err:t}=wr;if(n<Ar)throw new t("integer: negative integers are not allowed");let e=pi(n);if(Number.parseInt(e[0],16)&8&&(e="00"+e),e.length&1)throw new t("unexpected DER parsing assertion: unpadded hex");return e},decode(n){const{Err:t}=wr;if(n[0]&128)throw new t("invalid signature integer: negative");if(n[0]===0&&!(n[1]&128))throw new t("invalid signature integer: unnecessary leading zero");return QI(n)}},toSig(n){const{Err:t,_int:e,_tlv:r}=wr,s=typeof n=="string"?ZI(n):n;Sa(s);const{v:i,l:o}=r.decode(48,s);if(o.length)throw new t("invalid signature: left bytes after parsing");const{v:a,l}=r.decode(2,i),{v:u,l:h}=r.decode(2,l);if(h.length)throw new t("invalid signature: left bytes after parsing");return{r:e.decode(a),s:e.decode(u)}},hexFromSig(n){const{_tlv:t,_int:e}=wr,r=t.encode(2,e.encode(n.r)),s=t.encode(2,e.encode(n.s)),i=r+s;return t.encode(48,i)}},Ar=BigInt(0),wt=BigInt(1);BigInt(2);const Jp=BigInt(3);BigInt(4);function jI(n){const t=YI(n),{Fp:e}=t,r=Nl(t.n,t.nBitLength),s=t.toBytes||((y,m,v)=>{const _=m.toAffine();return Os(Uint8Array.from([4]),e.toBytes(_.x),e.toBytes(_.y))}),i=t.fromBytes||(y=>{const m=y.subarray(1),v=e.fromBytes(m.subarray(0,e.BYTES)),_=e.fromBytes(m.subarray(e.BYTES,2*e.BYTES));return{x:v,y:_}});function o(y){const{a:m,b:v}=t,_=e.sqr(y),w=e.mul(_,y);return e.add(e.add(w,e.mul(y,m)),v)}if(!e.eql(e.sqr(t.Gy),o(t.Gx)))throw new Error("bad generator point: equation left != right");function a(y){return Bl(y,wt,t.n)}function l(y){const{allowedPrivateKeyLengths:m,nByteLength:v,wrapPrivateKey:_,n:w}=t;if(m&&typeof y!="bigint"){if(Ns(y)&&(y=Rs(y)),typeof y!="string"||!m.includes(y.length))throw new Error("invalid private key");y=y.padStart(v*2,"0")}let S;try{S=typeof y=="bigint"?y:ks(dt("private key",y,v))}catch{throw new Error("invalid private key, expected hex or "+v+" bytes, got "+typeof y)}return _&&(S=Qe(S,w)),Pn("private key",S,wt,w),S}function u(y){if(!(y instanceof d))throw new Error("ProjectivePoint expected")}const h=jo((y,m)=>{const{px:v,py:_,pz:w}=y;if(e.eql(w,e.ONE))return{x:v,y:_};const S=y.is0();m==null&&(m=S?e.ONE:e.inv(w));const E=e.mul(v,m),A=e.mul(_,m),I=e.mul(w,m);if(S)return{x:e.ZERO,y:e.ZERO};if(!e.eql(I,e.ONE))throw new Error("invZ was invalid");return{x:E,y:A}}),c=jo(y=>{if(y.is0()){if(t.allowInfinityPoint&&!e.is0(y.py))return;throw new Error("bad point: ZERO")}const{x:m,y:v}=y.toAffine();if(!e.isValid(m)||!e.isValid(v))throw new Error("bad point: x or y not FE");const _=e.sqr(v),w=o(m);if(!e.eql(_,w))throw new Error("bad point: equation left != right");if(!y.isTorsionFree())throw new Error("bad point: not in prime-order subgroup");return!0});class d{constructor(m,v,_){if(this.px=m,this.py=v,this.pz=_,m==null||!e.isValid(m))throw new Error("x required");if(v==null||!e.isValid(v))throw new Error("y required");if(_==null||!e.isValid(_))throw new Error("z required");Object.freeze(this)}static fromAffine(m){const{x:v,y:_}=m||{};if(!m||!e.isValid(v)||!e.isValid(_))throw new Error("invalid affine point");if(m instanceof d)throw new Error("projective point not allowed");const w=S=>e.eql(S,e.ZERO);return w(v)&&w(_)?d.ZERO:new d(v,_,e.ONE)}get x(){return this.toAffine().x}get y(){return this.toAffine().y}static normalizeZ(m){const v=e.invertBatch(m.map(_=>_.pz));return m.map((_,w)=>_.toAffine(v[w])).map(d.fromAffine)}static fromHex(m){const v=d.fromAffine(i(dt("pointHex",m)));return v.assertValidity(),v}static fromPrivateKey(m){return d.BASE.multiply(l(m))}static msm(m,v){return Cb(d,r,m,v)}_setWindowSize(m){g.setWindowSize(this,m)}assertValidity(){c(this)}hasEvenY(){const{y:m}=this.toAffine();if(e.isOdd)return!e.isOdd(m);throw new Error("Field doesn't support isOdd")}equals(m){u(m);const{px:v,py:_,pz:w}=this,{px:S,py:E,pz:A}=m,I=e.eql(e.mul(v,A),e.mul(S,w)),T=e.eql(e.mul(_,A),e.mul(E,w));return I&&T}negate(){return new d(this.px,e.neg(this.py),this.pz)}double(){const{a:m,b:v}=t,_=e.mul(v,Jp),{px:w,py:S,pz:E}=this;let A=e.ZERO,I=e.ZERO,T=e.ZERO,x=e.mul(w,w),V=e.mul(S,S),L=e.mul(E,E),N=e.mul(w,S);return N=e.add(N,N),T=e.mul(w,E),T=e.add(T,T),A=e.mul(m,T),I=e.mul(_,L),I=e.add(A,I),A=e.sub(V,I),I=e.add(V,I),I=e.mul(A,I),A=e.mul(N,A),T=e.mul(_,T),L=e.mul(m,L),N=e.sub(x,L),N=e.mul(m,N),N=e.add(N,T),T=e.add(x,x),x=e.add(T,x),x=e.add(x,L),x=e.mul(x,N),I=e.add(I,x),L=e.mul(S,E),L=e.add(L,L),x=e.mul(L,N),A=e.sub(A,x),T=e.mul(L,V),T=e.add(T,T),T=e.add(T,T),new d(A,I,T)}add(m){u(m);const{px:v,py:_,pz:w}=this,{px:S,py:E,pz:A}=m;let I=e.ZERO,T=e.ZERO,x=e.ZERO;const V=t.a,L=e.mul(t.b,Jp);let N=e.mul(v,S),H=e.mul(_,E),D=e.mul(w,A),R=e.add(v,_),P=e.add(S,E);R=e.mul(R,P),P=e.add(N,H),R=e.sub(R,P),P=e.add(v,w);let k=e.add(S,A);return P=e.mul(P,k),k=e.add(N,D),P=e.sub(P,k),k=e.add(_,w),I=e.add(E,A),k=e.mul(k,I),I=e.add(H,D),k=e.sub(k,I),x=e.mul(V,P),I=e.mul(L,D),x=e.add(I,x),I=e.sub(H,x),x=e.add(H,x),T=e.mul(I,x),H=e.add(N,N),H=e.add(H,N),D=e.mul(V,D),P=e.mul(L,P),H=e.add(H,D),D=e.sub(N,D),D=e.mul(V,D),P=e.add(P,D),N=e.mul(H,P),T=e.add(T,N),N=e.mul(k,P),I=e.mul(R,I),I=e.sub(I,N),N=e.mul(R,H),x=e.mul(k,x),x=e.add(x,N),new d(I,T,x)}subtract(m){return this.add(m.negate())}is0(){return this.equals(d.ZERO)}wNAF(m){return g.wNAFCached(this,m,d.normalizeZ)}multiplyUnsafe(m){const{endo:v,n:_}=t;Pn("scalar",m,Ar,_);const w=d.ZERO;if(m===Ar)return w;if(this.is0()||m===wt)return this;if(!v||g.hasPrecomputes(this))return g.wNAFCachedUnsafe(this,m,d.normalizeZ);let{k1neg:S,k1:E,k2neg:A,k2:I}=v.splitScalar(m),T=w,x=w,V=this;for(;E>Ar||I>Ar;)E&wt&&(T=T.add(V)),I&wt&&(x=x.add(V)),V=V.double(),E>>=wt,I>>=wt;return S&&(T=T.negate()),A&&(x=x.negate()),x=new d(e.mul(x.px,v.beta),x.py,x.pz),T.add(x)}multiply(m){const{endo:v,n:_}=t;Pn("scalar",m,wt,_);let w,S;if(v){const{k1neg:E,k1:A,k2neg:I,k2:T}=v.splitScalar(m);let{p:x,f:V}=this.wNAF(A),{p:L,f:N}=this.wNAF(T);x=g.constTimeNegate(E,x),L=g.constTimeNegate(I,L),L=new d(e.mul(L.px,v.beta),L.py,L.pz),w=x.add(L),S=V.add(N)}else{const{p:E,f:A}=this.wNAF(m);w=E,S=A}return d.normalizeZ([w,S])[0]}multiplyAndAddUnsafe(m,v,_){const w=d.BASE,S=(A,I)=>I===Ar||I===wt||!A.equals(w)?A.multiplyUnsafe(I):A.multiply(I),E=S(this,v).add(S(m,_));return E.is0()?void 0:E}toAffine(m){return h(this,m)}isTorsionFree(){const{h:m,isTorsionFree:v}=t;if(m===wt)return!0;if(v)return v(d,this);throw new Error("isTorsionFree() has not been declared for the elliptic curve")}clearCofactor(){const{h:m,clearCofactor:v}=t;return m===wt?this:v?v(d,this):this.multiplyUnsafe(t.h)}toRawBytes(m=!0){return Pr("isCompressed",m),this.assertValidity(),s(d,this,m)}toHex(m=!0){return Pr("isCompressed",m),Rs(this.toRawBytes(m))}}d.BASE=new d(t.Gx,t.Gy,e.ONE),d.ZERO=new d(e.ZERO,e.ONE,e.ZERO);const f=t.nBitLength,g=Tb(d,t.endo?Math.ceil(f/2):f);return{CURVE:t,ProjectivePoint:d,normPrivateKeyToScalar:l,weierstrassEquation:o,isWithinCurveOrder:a}}function JI(n){const t=hf(n);return lo(t,{hash:"hash",hmac:"function",randomBytes:"function"},{bits2int:"function",bits2int_modN:"function",lowS:"boolean"}),Object.freeze({lowS:!0,...t})}function ek(n){const t=JI(n),{Fp:e,n:r}=t,s=e.BYTES+1,i=2*e.BYTES+1;function o(D){return Qe(D,r)}function a(D){return Md(D,r)}const{ProjectivePoint:l,normPrivateKeyToScalar:u,weierstrassEquation:h,isWithinCurveOrder:c}=jI({...t,toBytes(D,R,P){const k=R.toAffine(),C=e.toBytes(k.x),O=Os;return Pr("isCompressed",P),P?O(Uint8Array.from([R.hasEvenY()?2:3]),C):O(Uint8Array.from([4]),C,e.toBytes(k.y))},fromBytes(D){const R=D.length,P=D[0],k=D.subarray(1);if(R===s&&(P===2||P===3)){const C=ks(k);if(!Bl(C,wt,e.ORDER))throw new Error("Point is not on curve");const O=h(C);let F;try{F=e.sqrt(O)}catch(ee){const K=ee instanceof Error?": "+ee.message:"";throw new Error("Point is not on curve"+K)}const z=(F&wt)===wt;return(P&1)===1!==z&&(F=e.neg(F)),{x:C,y:F}}else if(R===i&&P===4){const C=e.fromBytes(k.subarray(0,e.BYTES)),O=e.fromBytes(k.subarray(e.BYTES,2*e.BYTES));return{x:C,y:O}}else{const C=s,O=i;throw new Error("invalid Point, expected length of "+C+", or uncompressed "+O+", got "+R)}}}),d=D=>Rs($i(D,t.nByteLength));function f(D){const R=r>>wt;return D>R}function g(D){return f(D)?o(-D):D}const y=(D,R,P)=>ks(D.slice(R,P));class m{constructor(R,P,k){this.r=R,this.s=P,this.recovery=k,this.assertValidity()}static fromCompact(R){const P=t.nByteLength;return R=dt("compactSignature",R,P*2),new m(y(R,0,P),y(R,P,2*P))}static fromDER(R){const{r:P,s:k}=wr.toSig(dt("DER",R));return new m(P,k)}assertValidity(){Pn("r",this.r,wt,r),Pn("s",this.s,wt,r)}addRecoveryBit(R){return new m(this.r,this.s,R)}recoverPublicKey(R){const{r:P,s:k,recovery:C}=this,O=A(dt("msgHash",R));if(C==null||![0,1,2,3].includes(C))throw new Error("recovery id invalid");const F=C===2||C===3?P+t.n:P;if(F>=e.ORDER)throw new Error("recovery id 2 or 3 invalid");const z=(C&1)===0?"02":"03",G=l.fromHex(z+d(F)),ee=a(F),K=o(-O*ee),le=o(k*ee),M=l.BASE.multiplyAndAddUnsafe(G,K,le);if(!M)throw new Error("point at infinify");return M.assertValidity(),M}hasHighS(){return f(this.s)}normalizeS(){return this.hasHighS()?new m(this.r,o(-this.s),this.recovery):this}toDERRawBytes(){return Fi(this.toDERHex())}toDERHex(){return wr.hexFromSig({r:this.r,s:this.s})}toCompactRawBytes(){return Fi(this.toCompactHex())}toCompactHex(){return d(this.r)+d(this.s)}}const v={isValidPrivateKey(D){try{return u(D),!0}catch{return!1}},normPrivateKeyToScalar:u,randomPrivateKey:()=>{const D=xb(t.n);return l2(t.randomBytes(D),t.n)},precompute(D=8,R=l.BASE){return R._setWindowSize(D),R.multiply(BigInt(3)),R}};function _(D,R=!0){return l.fromPrivateKey(D).toRawBytes(R)}function w(D){const R=Ns(D),P=typeof D=="string",k=(R||P)&&D.length;return R?k===s||k===i:P?k===2*s||k===2*i:D instanceof l}function S(D,R,P=!0){if(w(D))throw new Error("first arg must be private key");if(!w(R))throw new Error("second arg must be public key");return l.fromHex(R).multiply(u(D)).toRawBytes(P)}const E=t.bits2int||function(D){if(D.length>8192)throw new Error("input is too large");const R=ks(D),P=D.length*8-t.nBitLength;return P>0?R>>BigInt(P):R},A=t.bits2int_modN||function(D){return o(E(D))},I=df(t.nBitLength);function T(D){return Pn("num < 2^"+t.nBitLength,D,Ar,I),$i(D,t.nByteLength)}function x(D,R,P=V){if(["recovered","canonical"].some(we=>we in P))throw new Error("sign() legacy options not supported");const{hash:k,randomBytes:C}=t;let{lowS:O,prehash:F,extraEntropy:z}=P;O==null&&(O=!0),D=dt("msgHash",D),jp(P),F&&(D=dt("prehashed msgHash",k(D)));const G=A(D),ee=u(R),K=[T(ee),T(G)];if(z!=null&&z!==!1){const we=z===!0?C(e.BYTES):z;K.push(dt("extraEntropy",we))}const le=Os(...K),M=G;function ie(we){const he=E(we);if(!c(he))return;const ve=a(he),je=l.BASE.multiply(he).toAffine(),Q=o(je.x);if(Q===Ar)return;const ne=o(ve*o(M+Q*ee));if(ne===Ar)return;let Re=(je.x===Q?0:2)|Number(je.y&wt),Pt=ne;return O&&f(ne)&&(Pt=g(ne),Re^=1),new m(Q,Pt,Re)}return{seed:le,k2sig:ie}}const V={lowS:t.lowS,prehash:!1},L={lowS:t.lowS,prehash:!1};function N(D,R,P=V){const{seed:k,k2sig:C}=x(D,R,P),O=t;return Sb(O.hash.outputLen,O.nByteLength,O.hmac)(k,C)}l.BASE._setWindowSize(8);function H(D,R,P,k=L){const C=D;R=dt("msgHash",R),P=dt("publicKey",P);const{lowS:O,prehash:F,format:z}=k;if(jp(k),"strict"in k)throw new Error("options.strict was renamed to lowS");if(z!==void 0&&z!=="compact"&&z!=="der")throw new Error("format must be compact or der");const G=typeof C=="string"||Ns(C),ee=!G&&!z&&typeof C=="object"&&C!==null&&typeof C.r=="bigint"&&typeof C.s=="bigint";if(!G&&!ee)throw new Error("invalid signature, expected Uint8Array, hex string or Signature instance");let K,le;try{if(ee&&(K=new m(C.r,C.s)),G){try{z!=="compact"&&(K=m.fromDER(C))}catch(Re){if(!(Re instanceof wr.Err))throw Re}!K&&z!=="der"&&(K=m.fromCompact(C))}le=l.fromHex(P)}catch{return!1}if(!K||O&&K.hasHighS())return!1;F&&(R=t.hash(R));const{r:M,s:ie}=K,we=A(R),he=a(ie),ve=o(we*he),je=o(M*he),Q=l.BASE.multiplyAndAddUnsafe(le,ve,je)?.toAffine();return Q?o(Q.x)===M:!1}return{CURVE:t,getPublicKey:_,getSharedSecret:S,sign:N,verify:H,ProjectivePoint:l,Signature:m,utils:v}}/*! noble-curves - MIT License (c) 2022 Paul Miller (paulmillr.com) */function tk(n){return{hash:n,hmac:(t,...e)=>xf(n,t,yx(...e)),randomBytes:cf}}function nk(n,t){const e=r=>ek({...n,...tk(r)});return{...e(t),create:e}}/*! noble-curves - MIT License (c) 2022 Paul Miller (paulmillr.com) */const Wb=BigInt("0xfffffffffffffffffffffffffffffffffffffffffffffffffffffffefffffc2f"),eg=BigInt("0xfffffffffffffffffffffffffffffffebaaedce6af48a03bbfd25e8cd0364141"),rk=BigInt(1),Ud=BigInt(2),tg=(n,t)=>(n+t/Ud)/t;function sk(n){const t=Wb,e=BigInt(3),r=BigInt(6),s=BigInt(11),i=BigInt(22),o=BigInt(23),a=BigInt(44),l=BigInt(88),u=n*n*n%t,h=u*u*n%t,c=et(h,e,t)*h%t,d=et(c,e,t)*h%t,f=et(d,Ud,t)*u%t,g=et(f,s,t)*f%t,y=et(g,i,t)*g%t,m=et(y,a,t)*y%t,v=et(m,l,t)*m%t,_=et(v,a,t)*y%t,w=et(_,e,t)*h%t,S=et(w,o,t)*g%t,E=et(S,r,t)*u%t,A=et(E,Ud,t);if(!Vd.eql(Vd.sqr(A),n))throw new Error("Cannot find square root");return A}const Vd=Nl(Wb,void 0,void 0,{sqrt:sk}),ur=nk({a:BigInt(0),b:BigInt(7),Fp:Vd,n:eg,Gx:BigInt("55066263022277343669578718895168534326250603453777594175500187360389116729240"),Gy:BigInt("32670510020758816978083085130507043184471273380659243275938904335757337482424"),h:BigInt(1),lowS:!0,endo:{beta:BigInt("0x7ae96a2b657c07106e64479eac3434e99cf0497512f58995c1396c28719501ee"),splitScalar:n=>{const t=eg,e=BigInt("0x3086d221a7d46bcde86c90e49284eb15"),r=-rk*BigInt("0xe4437ed6010e88286f547fa90abfe4c3"),s=BigInt("0x114ca50f7a8e2f3f657c1108d9d44cfd8"),i=e,o=BigInt("0x100000000000000000000000000000000"),a=tg(i*n,t),l=tg(-r*n,t);let u=Qe(n-a*e-l*s,t),h=Qe(-a*r-l*i,t);const c=u>o,d=h>o;if(c&&(u=t-u),d&&(h=t-h),u>o||h>o)throw new Error("splitScalar: Endomorphism failed, k="+n);return{k1neg:c,k1:u,k2neg:d,k2:h}}}},Ia);BigInt(0);ur.ProjectivePoint;function Gb(n){return n==null?!1:typeof n.then=="function"&&typeof n.catch=="function"&&typeof n.finally=="function"}function ik(n,t){const e=Aa.digest(t instanceof Uint8Array?t:t.subarray());if(Gb(e))return e.then(({digest:r})=>ur.sign(r,n).toDERRawBytes()).catch(r=>{throw new Zp(String(r))});try{return ur.sign(e.digest,n).toDERRawBytes()}catch(r){throw new Zp(String(r))}}function ok(n,t,e){const r=Aa.digest(e instanceof Uint8Array?e:e.subarray());if(Gb(r))return r.then(({digest:s})=>ur.verify(t,s,n)).catch(s=>{throw new Xp(String(s))});try{return ur.verify(t,r.digest,n)}catch(s){throw new Xp(String(s))}}class Kb{constructor(t){p(this,"type","secp256k1");p(this,"raw");p(this,"_key");this._key=uk(t),this.raw=ck(this._key)}toMultihash(){return Cl.digest(nr(this))}toCID(){return Ye.createV1(114,this.toMultihash())}toString(){return ot.encode(this.toMultihash().bytes).substring(1)}equals(t){return t==null||!(t.raw instanceof Uint8Array)?!1:It(this.raw,t.raw)}verify(t,e){return ok(this._key,e,t)}}class Yb{constructor(t,e){p(this,"type","secp256k1");p(this,"raw");p(this,"publicKey");this.raw=lk(t),this.publicKey=new Kb(e??dk(t))}equals(t){return t==null||!(t.raw instanceof Uint8Array)?!1:It(this.raw,t.raw)}sign(t){return ik(this.raw,t)}}function Qb(n){return new Yb(n)}function If(n){return new Kb(n)}async function ak(){const n=hk();return new Yb(n)}function ck(n){return ur.ProjectivePoint.fromHex(n).toRawBytes(!0)}function lk(n){try{return ur.getPublicKey(n,!0),n}catch(t){throw new Jh(String(t))}}function uk(n){try{return ur.ProjectivePoint.fromHex(n),n}catch(t){throw new jh(String(t))}}function dk(n){try{return ur.getPublicKey(n,!0)}catch(t){throw new Jh(String(t))}}function hk(){return ur.utils.randomPrivateKey()}async function Zb(n,t){if(n==="Ed25519")return T2();if(n==="secp256k1")return ak();if(n==="RSA")return GI(2048);throw new Ks}function Lr(n,t){const{Type:e,Data:r}=ls.decode(n),s=r??new Uint8Array;switch(e){case at.RSA:return zb(s,t);case at.Ed25519:return pf(s);case at.secp256k1:return If(s);default:throw new Ks}}function fk(n){return n.byteLength===32?pf(n):n.byteLength===33?If(n):zb(n)}function pk(n){const{Type:t,Data:e}=ls.decode(n.digest),r=e??new Uint8Array;switch(t){case at.Ed25519:return pf(r);case at.secp256k1:return If(r);default:throw new Ks}}function nr(n){return ls.encode({Type:at[n.type],Data:n.raw})}function gk(n){const t=Mc.decode(n),e=t.Data??new Uint8Array;switch(t.Type){case at.RSA:return Hb(e);case at.Ed25519:return Db(e);case at.secp256k1:return Qb(e);default:throw new Ks}}function mk(n){return n.byteLength===64?Db(n):n.byteLength===32?Qb(n):Hb(n)}function Fl(n){return Mc.encode({Type:at[n.type],Data:n.raw})}const Xb=Symbol.for("nodejs.util.inspect.custom"),yk=114;var jm;class kf{constructor(t){p(this,"type");p(this,"multihash");p(this,"publicKey");p(this,"string");p(this,jm,!0);this.type=t.type,this.multihash=t.multihash,Object.defineProperty(this,"string",{enumerable:!1,writable:!0})}get[Symbol.toStringTag](){return`PeerId(${this.toString()})`}toString(){return this.string==null&&(this.string=ot.encode(this.multihash.bytes).slice(1)),this.string}toMultihash(){return this.multihash}toCID(){return Ye.createV1(yk,this.multihash)}toJSON(){return this.toString()}equals(t){if(t==null)return!1;if(t instanceof Uint8Array)return It(this.multihash.bytes,t);if(typeof t=="string")return this.toString()===t;if(t?.toMultihash()?.bytes!=null)return It(this.multihash.bytes,t.toMultihash().bytes);throw new Error("not valid Id")}[(jm=Qh,Xb)](){return`PeerId(${this.toString()})`}}class jb extends kf{constructor(e){super({...e,type:"RSA"});p(this,"type","RSA");p(this,"publicKey");this.publicKey=e.publicKey}}class Jb extends kf{constructor(e){super({...e,type:"Ed25519"});p(this,"type","Ed25519");p(this,"publicKey");this.publicKey=e.publicKey}}class ew extends kf{constructor(e){super({...e,type:"secp256k1"});p(this,"type","secp256k1");p(this,"publicKey");this.publicKey=e.publicKey}}const vk=2336;var Jm,ey;class tw{constructor(t){p(this,"type","url");p(this,"multihash");p(this,"publicKey");p(this,"url");p(this,Jm,!0);this.url=t.toString(),this.multihash=Cl.digest(te(this.url))}[(ey=Xb,Jm=Qh,ey)](){return`PeerId(${this.url})`}toString(){return this.toCID().toString()}toMultihash(){return this.multihash}toCID(){return Ye.createV1(vk,this.toMultihash())}toJSON(){return this.toString()}equals(t){return t==null?!1:(t instanceof Uint8Array&&(t=de(t)),t.toString()===this.toString())}}const bk=114,ng=2336;function Bt(n,t){let e;if(n.charAt(0)==="1"||n.charAt(0)==="Q")e=$r(ot.decode(`z${n}`));else throw new X('Please pass a multibase decoder for strings that do not start with "1" or "Q"');return Qs(e)}function ka(n){if(n.type==="Ed25519")return new Jb({multihash:n.toCID().multihash,publicKey:n});if(n.type==="secp256k1")return new ew({multihash:n.toCID().multihash,publicKey:n});if(n.type==="RSA")return new jb({multihash:n.toCID().multihash,publicKey:n});throw new Ks}function wk(n){return ka(n.publicKey)}function Qs(n){if(Sk(n))return new jb({multihash:n});if(_k(n))try{const t=pk(n);if(t.type==="Ed25519")return new Jb({multihash:n,publicKey:t});if(t.type==="secp256k1")return new ew({multihash:n,publicKey:t})}catch{const e=de(n.digest);return new tw(new URL(e))}throw new cb("Supplied PeerID Multihash is invalid")}function $l(n){if(n?.multihash==null||n.version==null||n.version===1&&n.code!==bk&&n.code!==ng)throw new ab("Supplied PeerID CID is invalid");if(n.code===ng){const t=de(n.multihash.digest);return new tw(new URL(t))}return Qs(n.multihash)}function _k(n){return n.code===Cl.code}function Sk(n){return n.code===Aa.code}function nw(n){return n[Symbol.asyncIterator]!=null}const Ul=n=>{const t=ln(n),e=cr(t);return Vn(n,e),Ul.bytes=t,e};Ul.bytes=0;function Tf(n,t){t=t??{};const e=t.lengthEncoder??Ul;function*r(s){const i=e(s.byteLength);i instanceof Uint8Array?yield i:yield*i,s instanceof Uint8Array?yield s:yield*s}return nw(n)?async function*(){for await(const s of n)yield*r(s)}():function*(){for(const s of n)yield*r(s)}()}Tf.single=(n,t)=>{t=t??{};const e=t.lengthEncoder??Ul;return new We(e(n.byteLength),n)};let Ek=class extends Error{constructor(){super(...arguments);p(this,"name","InvalidMessageLengthError");p(this,"code","ERR_INVALID_MSG_LENGTH")}},Ak=class extends Error{constructor(){super(...arguments);p(this,"name","InvalidDataLengthError");p(this,"code","ERR_MSG_DATA_TOO_LONG")}},xk=class extends Error{constructor(){super(...arguments);p(this,"name","InvalidDataLengthLengthError");p(this,"code","ERR_MSG_LENGTH_TOO_LONG")}},rg=class extends Error{constructor(){super(...arguments);p(this,"name","UnexpectedEOFError");p(this,"code","ERR_UNEXPECTED_EOF")}};const Ik=8,kk=1024*1024*4;var ms;(function(n){n[n.LENGTH=0]="LENGTH",n[n.DATA=1]="DATA"})(ms||(ms={}));const Cf=n=>{const t=Ys(n);return Cf.bytes=ln(t),t};Cf.bytes=0;function Hd(n,t){const e=new We;let r=ms.LENGTH,s=-1;const i=t?.lengthDecoder??Cf,o=t?.maxLengthLength??Ik,a=t?.maxDataLength??kk;function*l(){for(;e.byteLength>0;){if(r===ms.LENGTH)try{if(s=i(e),s<0)throw new Ek("Invalid message length");if(s>a)throw new Ak("Message length too long");const u=i.bytes;e.consume(u),t?.onLength!=null&&t.onLength(s),r=ms.DATA}catch(u){if(u instanceof RangeError){if(e.byteLength>o)throw new xk("Message length length too long");break}throw u}if(r===ms.DATA){if(e.byteLength<s)break;const u=e.sublist(0,s);e.consume(s),t?.onData!=null&&t.onData(u),yield u,r=ms.LENGTH}}}return nw(n)?async function*(){for await(const u of n)e.append(u),yield*l();if(e.byteLength>0)throw new rg("Unexpected end of input")}():function*(){for(const u of n)e.append(u),yield*l();if(e.byteLength>0)throw new rg("Unexpected end of input")}()}Hd.fromReader=(n,t)=>{let e=1;const r=async function*(){for(;;)try{const{done:i,value:o}=await n.next(e);if(i===!0)return;o!=null&&(yield o)}catch(i){if(i.code==="ERR_UNDER_READ")return{done:!0,value:null};throw i}finally{e=1}}();return Hd(r,{...t??{},onLength:i=>{e=i}})};function bt(){const n={};return n.promise=new Promise((t,e)=>{n.resolve=t,n.reject=e}),n}class sg{constructor(t){p(this,"buffer");p(this,"mask");p(this,"top");p(this,"btm");p(this,"next");if(!(t>0)||(t-1&t)!==0)throw new Error("Max size for a FixedFIFO should be a power of two");this.buffer=new Array(t),this.mask=t-1,this.top=0,this.btm=0,this.next=null}push(t){return this.buffer[this.top]!==void 0?!1:(this.buffer[this.top]=t,this.top=this.top+1&this.mask,!0)}shift(){const t=this.buffer[this.btm];if(t!==void 0)return this.buffer[this.btm]=void 0,this.btm=this.btm+1&this.mask,t}isEmpty(){return this.buffer[this.btm]===void 0}}class wu{constructor(t={}){p(this,"size");p(this,"hwm");p(this,"head");p(this,"tail");this.hwm=t.splitLimit??16,this.head=new sg(this.hwm),this.tail=this.head,this.size=0}calculateSize(t){return t?.byteLength!=null?t.byteLength:1}push(t){if(t?.value!=null&&(this.size+=this.calculateSize(t.value)),!this.head.push(t)){const e=this.head;this.head=e.next=new sg(2*this.head.buffer.length),this.head.push(t)}}shift(){let t=this.tail.shift();if(t===void 0&&this.tail.next!=null){const e=this.tail.next;this.tail.next=null,this.tail=e,t=this.tail.shift()}return t?.value!=null&&(this.size-=this.calculateSize(t.value)),t}isEmpty(){return this.head.isEmpty()}}let Tk=class extends Error{constructor(e,r){super(e??"The operation was aborted");p(this,"type");p(this,"code");this.type="aborted",this.code=r??"ABORT_ERR"}};function us(n={}){return Ck(e=>{const r=e.shift();if(r==null)return{done:!0};if(r.error!=null)throw r.error;return{done:r.done===!0,value:r.value}},n)}function Ck(n,t){t=t??{};let e=t.onEnd,r=new wu,s,i,o,a=bt();const l=async()=>{try{return r.isEmpty()?o?{done:!0}:await new Promise((m,v)=>{i=_=>{i=null,r.push(_);try{m(n(r))}catch(w){v(w)}return s}}):n(r)}finally{r.isEmpty()&&queueMicrotask(()=>{a.resolve(),a=bt()})}},u=m=>i!=null?i(m):(r.push(m),s),h=m=>(r=new wu,i!=null?i({error:m}):(r.push({error:m}),s)),c=m=>{if(o)return s;if(t?.objectMode!==!0&&m?.byteLength==null)throw new Error("objectMode was not true but tried to push non-Uint8Array value");return u({done:!1,value:m})},d=m=>o?s:(o=!0,m!=null?h(m):u({done:!0})),f=()=>(r=new wu,d(),{done:!0}),g=m=>(d(m),{done:!0});if(s={[Symbol.asyncIterator](){return this},next:l,return:f,throw:g,push:c,end:d,get readableLength(){return r.size},onEmpty:async m=>{const v=m?.signal;if(v?.throwIfAborted(),r.isEmpty())return;let _,w;v!=null&&(_=new Promise((S,E)=>{w=()=>{E(new Tk)},v.addEventListener("abort",w)}));try{await Promise.race([a.promise,_])}finally{w!=null&&v!=null&&v?.removeEventListener("abort",w)}}},e==null)return s;const y=s;return s={[Symbol.asyncIterator](){return this},next(){return y.next()},throw(m){return y.throw(m),e!=null&&(e(m),e=void 0),{done:!0}},return(){return y.return(),e!=null&&(e(),e=void 0),{done:!0}},push:c,end(m){return y.end(m),e!=null&&(e(m),e=void 0),s},get readableLength(){return y.readableLength},onEmpty:m=>y.onEmpty(m)},s}function Pk(n){return n[Symbol.asyncIterator]!=null}function Lc(...n){const t=[];for(const e of n)Pk(e)||t.push(e);return t.length===n.length?function*(){for(const e of t)yield*e}():async function*(){const e=us({objectMode:!0});Promise.resolve().then(async()=>{try{await Promise.all(n.map(async r=>{for await(const s of r)e.push(s)})),e.end()}catch(r){e.end(r)}}),yield*e}()}function Br(n,...t){if(n==null)throw new Error("Empty pipeline");if(_u(n)){const r=n;n=()=>r.source}else if(sw(n)||rw(n)){const r=n;n=()=>r}const e=[n,...t];if(e.length>1&&_u(e[e.length-1])&&(e[e.length-1]=e[e.length-1].sink),e.length>2)for(let r=1;r<e.length-1;r++)_u(e[r])&&(e[r]=Mk(e[r]));return Dk(...e)}const Dk=(...n)=>{let t;for(;n.length>0;)t=n.shift()(t);return t},rw=n=>n?.[Symbol.asyncIterator]!=null,sw=n=>n?.[Symbol.iterator]!=null,_u=n=>n==null?!1:n.sink!=null&&n.source!=null,Mk=n=>t=>{const e=n.sink(t);if(e?.then!=null){const r=us({objectMode:!0});e.then(()=>{r.end()},o=>{r.end(o)});let s;const i=n.source;if(rw(i))s=async function*(){yield*i,r.end()};else if(sw(i))s=function*(){yield*i,r.end()};else throw new Error("Unknown duplex source type - must be Iterable or AsyncIterable");return Lc(r,s())}return n.source},uo=1e3,Pf=60*uo,ig="/floodsub/1.0.0",og="/meshsub/1.0.0",Lk="/meshsub/1.1.0",Su="/meshsub/1.2.0",Bk=6,Nk=4,Rk=12,Ok=4,Fk=2,$k=5,Uk=3,Vk=6,Hk=.25,zk=3,ag=100,qk=uo,Wk=Pf,Gk=16,Kk=Pf,Yk=10*uo,Qk=15,Zk=300,Xk=uo,jk=60,Jk=2,eT=10*uo,ai=5e3,tT=10,nT=3*uo,rT=2*Pf,sT=120*1e3,iT="ERR_TOPIC_VALIDATOR_REJECT",oT="ERR_TOPIC_VALIDATOR_IGNORE",aT=0,cT=128,lT=1e3,uT=1e3,dT=1,hT=512,fT=512,pT={maxSubscriptions:1/0,maxMessages:1/0,maxIhaveMessageIDs:1/0,maxIwantMessageIDs:1/0,maxIdontwantMessageIDs:1/0,maxControlMessages:1/0,maxPeerInfos:1/0};var Cs;(function(n){(function(e){let r;e.codec=()=>(r==null&&(r=Te((s,i,o={})=>{o.lengthDelimited!==!1&&i.fork(),s.subscribe!=null&&(i.uint32(8),i.bool(s.subscribe)),s.topic!=null&&(i.uint32(18),i.string(s.topic)),o.lengthDelimited!==!1&&i.ldelim()},(s,i,o={})=>{const a={},l=i==null?s.len:s.pos+i;for(;s.pos<l;){const u=s.uint32();switch(u>>>3){case 1:{a.subscribe=s.bool();break}case 2:{a.topic=s.string();break}default:{s.skipType(u&7);break}}}return a})),r),e.encode=s=>ke(s,e.codec()),e.decode=(s,i)=>Ie(s,e.codec(),i)})(n.SubOpts||(n.SubOpts={})),function(e){let r;e.codec=()=>(r==null&&(r=Te((s,i,o={})=>{o.lengthDelimited!==!1&&i.fork(),s.from!=null&&(i.uint32(10),i.bytes(s.from)),s.data!=null&&(i.uint32(18),i.bytes(s.data)),s.seqno!=null&&(i.uint32(26),i.bytes(s.seqno)),s.topic!=null&&s.topic!==""&&(i.uint32(34),i.string(s.topic)),s.signature!=null&&(i.uint32(42),i.bytes(s.signature)),s.key!=null&&(i.uint32(50),i.bytes(s.key)),o.lengthDelimited!==!1&&i.ldelim()},(s,i,o={})=>{const a={topic:""},l=i==null?s.len:s.pos+i;for(;s.pos<l;){const u=s.uint32();switch(u>>>3){case 1:{a.from=s.bytes();break}case 2:{a.data=s.bytes();break}case 3:{a.seqno=s.bytes();break}case 4:{a.topic=s.string();break}case 5:{a.signature=s.bytes();break}case 6:{a.key=s.bytes();break}default:{s.skipType(u&7);break}}}return a})),r),e.encode=s=>ke(s,e.codec()),e.decode=(s,i)=>Ie(s,e.codec(),i)}(n.Message||(n.Message={})),function(e){let r;e.codec=()=>(r==null&&(r=Te((s,i,o={})=>{if(o.lengthDelimited!==!1&&i.fork(),s.ihave!=null)for(const a of s.ihave)i.uint32(10),n.ControlIHave.codec().encode(a,i);if(s.iwant!=null)for(const a of s.iwant)i.uint32(18),n.ControlIWant.codec().encode(a,i);if(s.graft!=null)for(const a of s.graft)i.uint32(26),n.ControlGraft.codec().encode(a,i);if(s.prune!=null)for(const a of s.prune)i.uint32(34),n.ControlPrune.codec().encode(a,i);if(s.idontwant!=null)for(const a of s.idontwant)i.uint32(42),n.ControlIDontWant.codec().encode(a,i);o.lengthDelimited!==!1&&i.ldelim()},(s,i,o={})=>{const a={ihave:[],iwant:[],graft:[],prune:[],idontwant:[]},l=i==null?s.len:s.pos+i;for(;s.pos<l;){const u=s.uint32();switch(u>>>3){case 1:{if(o.limits?.ihave!=null&&a.ihave.length===o.limits.ihave)throw new gt('Decode error - map field "ihave" had too many elements');a.ihave.push(n.ControlIHave.codec().decode(s,s.uint32(),{limits:o.limits?.ihave$}));break}case 2:{if(o.limits?.iwant!=null&&a.iwant.length===o.limits.iwant)throw new gt('Decode error - map field "iwant" had too many elements');a.iwant.push(n.ControlIWant.codec().decode(s,s.uint32(),{limits:o.limits?.iwant$}));break}case 3:{if(o.limits?.graft!=null&&a.graft.length===o.limits.graft)throw new gt('Decode error - map field "graft" had too many elements');a.graft.push(n.ControlGraft.codec().decode(s,s.uint32(),{limits:o.limits?.graft$}));break}case 4:{if(o.limits?.prune!=null&&a.prune.length===o.limits.prune)throw new gt('Decode error - map field "prune" had too many elements');a.prune.push(n.ControlPrune.codec().decode(s,s.uint32(),{limits:o.limits?.prune$}));break}case 5:{if(o.limits?.idontwant!=null&&a.idontwant.length===o.limits.idontwant)throw new gt('Decode error - map field "idontwant" had too many elements');a.idontwant.push(n.ControlIDontWant.codec().decode(s,s.uint32(),{limits:o.limits?.idontwant$}));break}default:{s.skipType(u&7);break}}}return a})),r),e.encode=s=>ke(s,e.codec()),e.decode=(s,i)=>Ie(s,e.codec(),i)}(n.ControlMessage||(n.ControlMessage={})),function(e){let r;e.codec=()=>(r==null&&(r=Te((s,i,o={})=>{if(o.lengthDelimited!==!1&&i.fork(),s.topicID!=null&&(i.uint32(10),i.string(s.topicID)),s.messageIDs!=null)for(const a of s.messageIDs)i.uint32(18),i.bytes(a);o.lengthDelimited!==!1&&i.ldelim()},(s,i,o={})=>{const a={messageIDs:[]},l=i==null?s.len:s.pos+i;for(;s.pos<l;){const u=s.uint32();switch(u>>>3){case 1:{a.topicID=s.string();break}case 2:{if(o.limits?.messageIDs!=null&&a.messageIDs.length===o.limits.messageIDs)throw new gt('Decode error - map field "messageIDs" had too many elements');a.messageIDs.push(s.bytes());break}default:{s.skipType(u&7);break}}}return a})),r),e.encode=s=>ke(s,e.codec()),e.decode=(s,i)=>Ie(s,e.codec(),i)}(n.ControlIHave||(n.ControlIHave={})),function(e){let r;e.codec=()=>(r==null&&(r=Te((s,i,o={})=>{if(o.lengthDelimited!==!1&&i.fork(),s.messageIDs!=null)for(const a of s.messageIDs)i.uint32(10),i.bytes(a);o.lengthDelimited!==!1&&i.ldelim()},(s,i,o={})=>{const a={messageIDs:[]},l=i==null?s.len:s.pos+i;for(;s.pos<l;){const u=s.uint32();switch(u>>>3){case 1:{if(o.limits?.messageIDs!=null&&a.messageIDs.length===o.limits.messageIDs)throw new gt('Decode error - map field "messageIDs" had too many elements');a.messageIDs.push(s.bytes());break}default:{s.skipType(u&7);break}}}return a})),r),e.encode=s=>ke(s,e.codec()),e.decode=(s,i)=>Ie(s,e.codec(),i)}(n.ControlIWant||(n.ControlIWant={})),function(e){let r;e.codec=()=>(r==null&&(r=Te((s,i,o={})=>{o.lengthDelimited!==!1&&i.fork(),s.topicID!=null&&(i.uint32(10),i.string(s.topicID)),o.lengthDelimited!==!1&&i.ldelim()},(s,i,o={})=>{const a={},l=i==null?s.len:s.pos+i;for(;s.pos<l;){const u=s.uint32();switch(u>>>3){case 1:{a.topicID=s.string();break}default:{s.skipType(u&7);break}}}return a})),r),e.encode=s=>ke(s,e.codec()),e.decode=(s,i)=>Ie(s,e.codec(),i)}(n.ControlGraft||(n.ControlGraft={})),function(e){let r;e.codec=()=>(r==null&&(r=Te((s,i,o={})=>{if(o.lengthDelimited!==!1&&i.fork(),s.topicID!=null&&(i.uint32(10),i.string(s.topicID)),s.peers!=null)for(const a of s.peers)i.uint32(18),n.PeerInfo.codec().encode(a,i);s.backoff!=null&&(i.uint32(24),i.uint64Number(s.backoff)),o.lengthDelimited!==!1&&i.ldelim()},(s,i,o={})=>{const a={peers:[]},l=i==null?s.len:s.pos+i;for(;s.pos<l;){const u=s.uint32();switch(u>>>3){case 1:{a.topicID=s.string();break}case 2:{if(o.limits?.peers!=null&&a.peers.length===o.limits.peers)throw new gt('Decode error - map field "peers" had too many elements');a.peers.push(n.PeerInfo.codec().decode(s,s.uint32(),{limits:o.limits?.peers$}));break}case 3:{a.backoff=s.uint64Number();break}default:{s.skipType(u&7);break}}}return a})),r),e.encode=s=>ke(s,e.codec()),e.decode=(s,i)=>Ie(s,e.codec(),i)}(n.ControlPrune||(n.ControlPrune={})),function(e){let r;e.codec=()=>(r==null&&(r=Te((s,i,o={})=>{o.lengthDelimited!==!1&&i.fork(),s.peerID!=null&&(i.uint32(10),i.bytes(s.peerID)),s.signedPeerRecord!=null&&(i.uint32(18),i.bytes(s.signedPeerRecord)),o.lengthDelimited!==!1&&i.ldelim()},(s,i,o={})=>{const a={},l=i==null?s.len:s.pos+i;for(;s.pos<l;){const u=s.uint32();switch(u>>>3){case 1:{a.peerID=s.bytes();break}case 2:{a.signedPeerRecord=s.bytes();break}default:{s.skipType(u&7);break}}}return a})),r),e.encode=s=>ke(s,e.codec()),e.decode=(s,i)=>Ie(s,e.codec(),i)}(n.PeerInfo||(n.PeerInfo={})),function(e){let r;e.codec=()=>(r==null&&(r=Te((s,i,o={})=>{if(o.lengthDelimited!==!1&&i.fork(),s.messageIDs!=null)for(const a of s.messageIDs)i.uint32(10),i.bytes(a);o.lengthDelimited!==!1&&i.ldelim()},(s,i,o={})=>{const a={messageIDs:[]},l=i==null?s.len:s.pos+i;for(;s.pos<l;){const u=s.uint32();switch(u>>>3){case 1:{if(o.limits?.messageIDs!=null&&a.messageIDs.length===o.limits.messageIDs)throw new gt('Decode error - map field "messageIDs" had too many elements');a.messageIDs.push(s.bytes());break}default:{s.skipType(u&7);break}}}return a})),r),e.encode=s=>ke(s,e.codec()),e.decode=(s,i)=>Ie(s,e.codec(),i)}(n.ControlIDontWant||(n.ControlIDontWant={}));let t;n.codec=()=>(t==null&&(t=Te((e,r,s={})=>{if(s.lengthDelimited!==!1&&r.fork(),e.subscriptions!=null)for(const i of e.subscriptions)r.uint32(10),n.SubOpts.codec().encode(i,r);if(e.messages!=null)for(const i of e.messages)r.uint32(18),n.Message.codec().encode(i,r);e.control!=null&&(r.uint32(26),n.ControlMessage.codec().encode(e.control,r)),s.lengthDelimited!==!1&&r.ldelim()},(e,r,s={})=>{const i={subscriptions:[],messages:[]},o=r==null?e.len:e.pos+r;for(;e.pos<o;){const a=e.uint32();switch(a>>>3){case 1:{if(s.limits?.subscriptions!=null&&i.subscriptions.length===s.limits.subscriptions)throw new gt('Decode error - map field "subscriptions" had too many elements');i.subscriptions.push(n.SubOpts.codec().decode(e,e.uint32(),{limits:s.limits?.subscriptions$}));break}case 2:{if(s.limits?.messages!=null&&i.messages.length===s.limits.messages)throw new gt('Decode error - map field "messages" had too many elements');i.messages.push(n.Message.codec().decode(e,e.uint32(),{limits:s.limits?.messages$}));break}case 3:{i.control=n.ControlMessage.codec().decode(e,e.uint32(),{limits:s.limits?.control});break}default:{e.skipType(a&7);break}}}return i})),t),n.encode=e=>ke(e,n.codec()),n.decode=(e,r)=>Ie(e,n.codec(),r)})(Cs||(Cs={}));class gT{constructor(t,e,r){p(this,"gossip");p(this,"msgs",new Map);p(this,"msgIdToStrFn");p(this,"history",[]);p(this,"notValidatedCount",0);this.gossip=t,this.msgIdToStrFn=r;for(let s=0;s<e;s++)this.history[s]=[]}get size(){return this.msgs.size}put(t,e,r=!1){const{msgIdStr:s}=t;return this.msgs.has(s)?!1:(this.msgs.set(s,{message:e,validated:r,originatingPeers:new Set,iwantCounts:new Map}),this.history[0].push({...t,topic:e.topic}),r||this.notValidatedCount++,!0)}observeDuplicate(t,e){const r=this.msgs.get(t);r!=null&&!r.validated&&r.originatingPeers.add(e)}get(t){return this.msgs.get(this.msgIdToStrFn(t))?.message}getWithIWantCount(t,e){const r=this.msgs.get(t);if(r==null)return null;const s=(r.iwantCounts.get(e)??0)+1;return r.iwantCounts.set(e,s),{msg:r.message,count:s}}getGossipIDs(t){const e=new Map;for(let r=0;r<this.gossip;r++)this.history[r].forEach(s=>{if((this.msgs.get(s.msgIdStr)?.validated??!1)&&t.has(s.topic)){let o=e.get(s.topic);o==null&&(o=[],e.set(s.topic,o)),o.push(s.msgId)}});return e}validate(t){const e=this.msgs.get(t);if(e==null)return null;e.validated||this.notValidatedCount--;const{message:r,originatingPeers:s}=e;return e.validated=!0,e.originatingPeers=new Set,{message:r,originatingPeers:s}}shift(){this.history[this.history.length-1].forEach(e=>{const r=this.msgs.get(e.msgIdStr);r!=null&&(this.msgs.delete(e.msgIdStr),r.validated||this.notValidatedCount--)}),this.history.pop(),this.history.unshift([])}remove(t){const e=this.msgs.get(t);return e==null?null:(this.msgs.delete(t),e)}}var cg;(function(n){n.StrictSign="StrictSign",n.StrictNoSign="StrictNoSign"})(cg||(cg={}));var Vi;(function(n){n[n.Signing=0]="Signing",n[n.Anonymous=1]="Anonymous"})(Vi||(Vi={}));var Hn;(function(n){n.Error="error",n.Ignore="ignore",n.Reject="reject",n.Blacklisted="blacklisted"})(Hn||(Hn={}));var jt;(function(n){n.InvalidSignature="invalid_signature",n.InvalidSeqno="invalid_seqno",n.InvalidPeerId="invalid_peerid",n.SignaturePresent="signature_present",n.SeqnoPresent="seqno_present",n.FromPresent="from_present",n.TransformFailed="transform_failed"})(jt||(jt={}));var en;(function(n){n.duplicate="duplicate",n.invalid="invalid",n.valid="valid"})(en||(en={}));function lg(n){switch(n){case Cn.Ignore:return Hn.Ignore;case Cn.Reject:return Hn.Reject;default:throw new Error("Unreachable")}}var ug;(function(n){n.forward="forward",n.publish="publish"})(ug||(ug={}));var nn;(function(n){n.Fanout="fanout",n.Random="random",n.Subscribed="subscribed",n.Outbound="outbound",n.NotEnough="not_enough",n.Opportunistic="opportunistic"})(nn||(nn={}));var Jn;(function(n){n.Dc="disconnected",n.BadScore="bad_score",n.Prune="prune",n.Excess="excess"})(Jn||(Jn={}));var Oo;(function(n){n.GraftBackoff="graft_backoff",n.BrokenPromise="broken_promise",n.MessageDeficit="message_deficit",n.IPColocation="IP_colocation"})(Oo||(Oo={}));var Fo;(function(n){n.LowScore="low_score",n.MaxIhave="max_ihave",n.MaxIasked="max_iasked"})(Fo||(Fo={}));var gi;(function(n){n.graylist="graylist",n.publish="publish",n.gossip="gossip",n.mesh="mesh"})(gi||(gi={}));function mT(n,t,e){return{protocolsEnabled:n.gauge({name:"gossipsub_protocol",help:"Status of enabled protocols",labelNames:["protocol"]}),topicSubscriptionStatus:n.gauge({name:"gossipsub_topic_subscription_status",help:"Status of our subscription to this topic",labelNames:["topicStr"]}),topicPeersCount:n.gauge({name:"gossipsub_topic_peer_count",help:"Number of peers subscribed to each topic",labelNames:["topicStr"]}),meshPeerCounts:n.gauge({name:"gossipsub_mesh_peer_count",help:"Number of peers in our mesh",labelNames:["topicStr"]}),meshPeerInclusionEventsFanout:n.gauge({name:"gossipsub_mesh_peer_inclusion_events_fanout_total",help:"Number of times we include peers in a topic mesh for fanout reasons",labelNames:["topic"]}),meshPeerInclusionEventsRandom:n.gauge({name:"gossipsub_mesh_peer_inclusion_events_random_total",help:"Number of times we include peers in a topic mesh for random reasons",labelNames:["topic"]}),meshPeerInclusionEventsSubscribed:n.gauge({name:"gossipsub_mesh_peer_inclusion_events_subscribed_total",help:"Number of times we include peers in a topic mesh for subscribed reasons",labelNames:["topic"]}),meshPeerInclusionEventsOutbound:n.gauge({name:"gossipsub_mesh_peer_inclusion_events_outbound_total",help:"Number of times we include peers in a topic mesh for outbound reasons",labelNames:["topic"]}),meshPeerInclusionEventsNotEnough:n.gauge({name:"gossipsub_mesh_peer_inclusion_events_not_enough_total",help:"Number of times we include peers in a topic mesh for not_enough reasons",labelNames:["topic"]}),meshPeerInclusionEventsOpportunistic:n.gauge({name:"gossipsub_mesh_peer_inclusion_events_opportunistic_total",help:"Number of times we include peers in a topic mesh for opportunistic reasons",labelNames:["topic"]}),meshPeerInclusionEventsUnknown:n.gauge({name:"gossipsub_mesh_peer_inclusion_events_unknown_total",help:"Number of times we include peers in a topic mesh for unknown reasons",labelNames:["topic"]}),meshPeerChurnEventsDisconnected:n.gauge({name:"gossipsub_peer_churn_events_disconnected_total",help:"Number of times we remove peers in a topic mesh for disconnected reasons",labelNames:["topic"]}),meshPeerChurnEventsBadScore:n.gauge({name:"gossipsub_peer_churn_events_bad_score_total",help:"Number of times we remove peers in a topic mesh for bad_score reasons",labelNames:["topic"]}),meshPeerChurnEventsPrune:n.gauge({name:"gossipsub_peer_churn_events_prune_total",help:"Number of times we remove peers in a topic mesh for prune reasons",labelNames:["topic"]}),meshPeerChurnEventsExcess:n.gauge({name:"gossipsub_peer_churn_events_excess_total",help:"Number of times we remove peers in a topic mesh for excess reasons",labelNames:["topic"]}),meshPeerChurnEventsUnknown:n.gauge({name:"gossipsub_peer_churn_events_unknown_total",help:"Number of times we remove peers in a topic mesh for unknown reasons",labelNames:["topic"]}),peersPerProtocol:n.gauge({name:"gossipsub_peers_per_protocol_count",help:"Peers connected for each topic",labelNames:["protocol"]}),heartbeatDuration:n.histogram({name:"gossipsub_heartbeat_duration_seconds",help:"The time it takes to complete one iteration of the heartbeat",buckets:[.01,.1,1]}),heartbeatSkipped:n.gauge({name:"gossipsub_heartbeat_skipped",help:"Heartbeat run took longer than heartbeat interval so next is skipped"}),acceptedMessagesTotal:n.gauge({name:"gossipsub_accepted_messages_total",help:"Total accepted messages for each topic",labelNames:["topic"]}),ignoredMessagesTotal:n.gauge({name:"gossipsub_ignored_messages_total",help:"Total ignored messages for each topic",labelNames:["topic"]}),rejectedMessagesTotal:n.gauge({name:"gossipsub_rejected_messages_total",help:"Total rejected messages for each topic",labelNames:["topic"]}),unknownValidationResultsTotal:n.gauge({name:"gossipsub_unknown_validation_results_total",help:"Total unknown validation results for each topic",labelNames:["topic"]}),asyncValidationMcacheHit:n.gauge({name:"gossipsub_async_validation_mcache_hit_total",help:"Async validation result reported by the user layer",labelNames:["hit"]}),asyncValidationDelayFromFirstSeenSec:n.histogram({name:"gossipsub_async_validation_delay_from_first_seen",help:"Async validation report delay from first seen in second",buckets:[.01,.03,.1,.3,1,3,10]}),asyncValidationUnknownFirstSeen:n.gauge({name:"gossipsub_async_validation_unknown_first_seen_count_total",help:"Async validation report unknown first seen value for message"}),peerReadStreamError:n.gauge({name:"gossipsub_peer_read_stream_err_count_total",help:"Peer read stream error"}),rpcRecvBytes:n.gauge({name:"gossipsub_rpc_recv_bytes_total",help:"RPC recv"}),rpcRecvCount:n.gauge({name:"gossipsub_rpc_recv_count_total",help:"RPC recv"}),rpcRecvSubscription:n.gauge({name:"gossipsub_rpc_recv_subscription_total",help:"RPC recv"}),rpcRecvMessage:n.gauge({name:"gossipsub_rpc_recv_message_total",help:"RPC recv"}),rpcRecvControl:n.gauge({name:"gossipsub_rpc_recv_control_total",help:"RPC recv"}),rpcRecvIHave:n.gauge({name:"gossipsub_rpc_recv_ihave_total",help:"RPC recv"}),rpcRecvIWant:n.gauge({name:"gossipsub_rpc_recv_iwant_total",help:"RPC recv"}),rpcRecvGraft:n.gauge({name:"gossipsub_rpc_recv_graft_total",help:"RPC recv"}),rpcRecvPrune:n.gauge({name:"gossipsub_rpc_recv_prune_total",help:"RPC recv"}),rpcDataError:n.gauge({name:"gossipsub_rpc_data_err_count_total",help:"RPC data error"}),rpcRecvError:n.gauge({name:"gossipsub_rpc_recv_err_count_total",help:"RPC recv error"}),rpcRecvNotAccepted:n.gauge({name:"gossipsub_rpc_rcv_not_accepted_total",help:"Total count of RPC dropped because acceptFrom() == false"}),rpcSentBytes:n.gauge({name:"gossipsub_rpc_sent_bytes_total",help:"RPC sent"}),rpcSentCount:n.gauge({name:"gossipsub_rpc_sent_count_total",help:"RPC sent"}),rpcSentSubscription:n.gauge({name:"gossipsub_rpc_sent_subscription_total",help:"RPC sent"}),rpcSentMessage:n.gauge({name:"gossipsub_rpc_sent_message_total",help:"RPC sent"}),rpcSentControl:n.gauge({name:"gossipsub_rpc_sent_control_total",help:"RPC sent"}),rpcSentIHave:n.gauge({name:"gossipsub_rpc_sent_ihave_total",help:"RPC sent"}),rpcSentIWant:n.gauge({name:"gossipsub_rpc_sent_iwant_total",help:"RPC sent"}),rpcSentGraft:n.gauge({name:"gossipsub_rpc_sent_graft_total",help:"RPC sent"}),rpcSentPrune:n.gauge({name:"gossipsub_rpc_sent_prune_total",help:"RPC sent"}),rpcSentIDontWant:n.gauge({name:"gossipsub_rpc_sent_idontwant_total",help:"RPC sent"}),msgPublishCount:n.gauge({name:"gossipsub_msg_publish_count_total",help:"Total count of msg published by topic",labelNames:["topic"]}),msgPublishPeersByTopic:n.gauge({name:"gossipsub_msg_publish_peers_total",help:"Total count of peers that we publish a msg to",labelNames:["topic"]}),directPeersPublishedTotal:n.gauge({name:"gossipsub_direct_peers_published_total",help:"Total direct peers that we publish a msg to",labelNames:["topic"]}),floodsubPeersPublishedTotal:n.gauge({name:"gossipsub_floodsub_peers_published_total",help:"Total floodsub peers that we publish a msg to",labelNames:["topic"]}),meshPeersPublishedTotal:n.gauge({name:"gossipsub_mesh_peers_published_total",help:"Total mesh peers that we publish a msg to",labelNames:["topic"]}),fanoutPeersPublishedTotal:n.gauge({name:"gossipsub_fanout_peers_published_total",help:"Total fanout peers that we publish a msg to",labelNames:["topic"]}),msgPublishBytes:n.gauge({name:"gossipsub_msg_publish_bytes_total",help:"Total count of msg publish data.length bytes",labelNames:["topic"]}),msgPublishTime:n.histogram({name:"gossipsub_msg_publish_seconds",help:"Total time in seconds to publish a message",buckets:[.001,.002,.005,.01,.1,.5,1],labelNames:["topic"]}),msgForwardCount:n.gauge({name:"gossipsub_msg_forward_count_total",help:"Total count of msg forwarded by topic",labelNames:["topic"]}),msgForwardPeers:n.gauge({name:"gossipsub_msg_forward_peers_total",help:"Total count of peers that we forward a msg to",labelNames:["topic"]}),msgReceivedPreValidation:n.gauge({name:"gossipsub_msg_received_prevalidation_total",help:"Total count of recv msgs before any validation",labelNames:["topic"]}),msgReceivedError:n.gauge({name:"gossipsub_msg_received_error_total",help:"Total count of recv msgs error",labelNames:["topic"]}),prevalidationInvalidTotal:n.gauge({name:"gossipsub_pre_validation_invalid_total",help:"Total count of invalid messages received",labelNames:["topic"]}),prevalidationValidTotal:n.gauge({name:"gossipsub_pre_validation_valid_total",help:"Total count of valid messages received",labelNames:["topic"]}),prevalidationDuplicateTotal:n.gauge({name:"gossipsub_pre_validation_duplicate_total",help:"Total count of duplicate messages received",labelNames:["topic"]}),prevalidationUnknownTotal:n.gauge({name:"gossipsub_pre_validation_unknown_status_total",help:"Total count of unknown_status messages received",labelNames:["topic"]}),msgReceivedInvalid:n.gauge({name:"gossipsub_msg_received_invalid_total",help:"Tracks specific reason of invalid",labelNames:["error"]}),msgReceivedInvalidByTopic:n.gauge({name:"gossipsub_msg_received_invalid_by_topic_total",help:"Tracks specific invalid message by topic",labelNames:["topic"]}),duplicateMsgDeliveryDelay:n.histogram({name:"gossisub_duplicate_msg_delivery_delay_seconds",help:"Time since the 1st duplicated message validated",labelNames:["topic"],buckets:[.25*e.maxMeshMessageDeliveriesWindowSec,.5*e.maxMeshMessageDeliveriesWindowSec,Number(e.maxMeshMessageDeliveriesWindowSec),2*e.maxMeshMessageDeliveriesWindowSec,4*e.maxMeshMessageDeliveriesWindowSec]}),duplicateMsgLateDelivery:n.gauge({name:"gossisub_duplicate_msg_late_delivery_total",help:"Total count of late duplicate message delivery by topic, which triggers P3 penalty",labelNames:["topic"]}),duplicateMsgIgnored:n.gauge({name:"gossisub_ignored_published_duplicate_msgs_total",help:"Total count of published duplicate message ignored by topic",labelNames:["topic"]}),scoreFnCalls:n.gauge({name:"gossipsub_score_fn_calls_total",help:"Total times score() is called"}),scoreFnRuns:n.gauge({name:"gossipsub_score_fn_runs_total",help:"Total times score() call actually computed computeScore(), no cache"}),scoreCachedDelta:n.histogram({name:"gossipsub_score_cache_delta",help:"Delta of score between cached values that expired",buckets:[10,100,1e3]}),peersByScoreThreshold:n.gauge({name:"gossipsub_peers_by_score_threshold_count",help:"Current count of peers by score threshold",labelNames:["threshold"]}),score:n.avgMinMax({name:"gossipsub_score",help:"Avg min max of gossip scores"}),scoreWeights:n.avgMinMax({name:"gossipsub_score_weights",help:"Separate score weights",labelNames:["topic","p"]}),scorePerMesh:n.avgMinMax({name:"gossipsub_score_per_mesh",help:"Histogram of the scores for each mesh topic",labelNames:["topic"]}),scoringPenalties:n.gauge({name:"gossipsub_scoring_penalties_total",help:"A counter of the kind of penalties being applied to peers",labelNames:["penalty"]}),behaviourPenalty:n.histogram({name:"gossipsub_peer_stat_behaviour_penalty",help:"Current peer stat behaviour_penalty at each scrape",buckets:[.25*e.behaviourPenaltyThreshold,.5*e.behaviourPenaltyThreshold,Number(e.behaviourPenaltyThreshold),2*e.behaviourPenaltyThreshold,4*e.behaviourPenaltyThreshold]}),ihaveRcvIgnored:n.gauge({name:"gossipsub_ihave_rcv_ignored_total",help:"Total received IHAVE messages that we ignore for some reason",labelNames:["reason"]}),ihaveRcvMsgids:n.gauge({name:"gossipsub_ihave_rcv_msgids_total",help:"Total received IHAVE messages by topic",labelNames:["topic"]}),ihaveRcvNotSeenMsgids:n.gauge({name:"gossipsub_ihave_rcv_not_seen_msgids_total",help:"Total messages per topic we do not have, not actual requests",labelNames:["topic"]}),iwantRcvMsgids:n.gauge({name:"gossipsub_iwant_rcv_msgids_total",help:"Total received IWANT messages by topic",labelNames:["topic"]}),iwantRcvDonthaveMsgids:n.gauge({name:"gossipsub_iwant_rcv_dont_have_msgids_total",help:"Total requested messageIDs that we do not have"}),idontwantRcvMsgids:n.gauge({name:"gossipsub_idontwant_rcv_msgids_total",help:"Total received IDONTWANT messages"}),idontwantRcvDonthaveMsgids:n.gauge({name:"gossipsub_idontwant_rcv_dont_have_msgids_total",help:"Total received IDONTWANT messageIDs that we do not have in mcache"}),iwantPromiseStarted:n.gauge({name:"gossipsub_iwant_promise_sent_total",help:"Total count of started IWANT promises"}),iwantPromiseResolved:n.gauge({name:"gossipsub_iwant_promise_resolved_total",help:"Total count of resolved IWANT promises"}),iwantPromiseResolvedFromDuplicate:n.gauge({name:"gossipsub_iwant_promise_resolved_from_duplicate_total",help:"Total count of resolved IWANT promises from duplicate messages"}),iwantPromiseResolvedPeers:n.gauge({name:"gossipsub_iwant_promise_resolved_peers",help:"Total count of peers we have asked IWANT promises that are resolved"}),iwantPromiseBroken:n.gauge({name:"gossipsub_iwant_promise_broken",help:"Total count of broken IWANT promises"}),iwantMessagePruned:n.gauge({name:"gossipsub_iwant_message_pruned",help:"Total count of pruned IWANT messages"}),iwantPromiseDeliveryTime:n.histogram({name:"gossipsub_iwant_promise_delivery_seconds",help:"Histogram of delivery time of resolved IWANT promises",buckets:[.5*e.gossipPromiseExpireSec,Number(e.gossipPromiseExpireSec),2*e.gossipPromiseExpireSec,4*e.gossipPromiseExpireSec]}),iwantPromiseUntracked:n.gauge({name:"gossip_iwant_promise_untracked",help:"Total count of untracked IWANT promise"}),connectedPeersBackoffSec:n.histogram({name:"gossipsub_connected_peers_backoff_seconds",help:"Backoff time in seconds",buckets:[1,2,4,10,20,60,120]}),cacheSize:n.gauge({name:"gossipsub_cache_size",help:"Unbounded cache sizes",labelNames:["cache"]}),mcacheSize:n.gauge({name:"gossipsub_mcache_size",help:"Current mcache msg count"}),mcacheNotValidatedCount:n.gauge({name:"gossipsub_mcache_not_validated_count",help:"Current mcache msg count not validated"}),fastMsgIdCacheCollision:n.gauge({name:"gossipsub_fastmsgid_cache_collision_total",help:"Total count of key collisions on fastmsgid cache put"}),newConnectionCount:n.gauge({name:"gossipsub_new_connection_total",help:"Total new connection by status",labelNames:["status"]}),topicStrToLabel:t,toTopic(r){return this.topicStrToLabel.get(r)??r},onJoin(r){this.topicSubscriptionStatus.set({topicStr:r},1),this.meshPeerCounts.set({topicStr:r},0)},onLeave(r){this.topicSubscriptionStatus.set({topicStr:r},0),this.meshPeerCounts.set({topicStr:r},0)},onAddToMesh(r,s,i){const o=this.toTopic(r);switch(s){case nn.Fanout:this.meshPeerInclusionEventsFanout.inc({topic:o},i);break;case nn.Random:this.meshPeerInclusionEventsRandom.inc({topic:o},i);break;case nn.Subscribed:this.meshPeerInclusionEventsSubscribed.inc({topic:o},i);break;case nn.Outbound:this.meshPeerInclusionEventsOutbound.inc({topic:o},i);break;case nn.NotEnough:this.meshPeerInclusionEventsNotEnough.inc({topic:o},i);break;case nn.Opportunistic:this.meshPeerInclusionEventsOpportunistic.inc({topic:o},i);break;default:this.meshPeerInclusionEventsUnknown.inc({topic:o},i);break}},onRemoveFromMesh(r,s,i){const o=this.toTopic(r);switch(s){case Jn.Dc:this.meshPeerChurnEventsDisconnected.inc({topic:o},i);break;case Jn.BadScore:this.meshPeerChurnEventsBadScore.inc({topic:o},i);break;case Jn.Prune:this.meshPeerChurnEventsPrune.inc({topic:o},i);break;case Jn.Excess:this.meshPeerChurnEventsExcess.inc({topic:o},i);break;default:this.meshPeerChurnEventsUnknown.inc({topic:o},i);break}},onReportValidation(r,s,i){if(this.asyncValidationMcacheHit.inc({hit:r!=null?"hit":"miss"}),r!=null){const o=this.toTopic(r.message.topic);switch(s){case Cn.Accept:this.acceptedMessagesTotal.inc({topic:o});break;case Cn.Ignore:this.ignoredMessagesTotal.inc({topic:o});break;case Cn.Reject:this.rejectedMessagesTotal.inc({topic:o});break;default:this.unknownValidationResultsTotal.inc({topic:o});break}}i!=null?this.asyncValidationDelayFromFirstSeenSec.observe((Date.now()-i)/1e3):this.asyncValidationUnknownFirstSeen.inc()},onScorePenalty(r){this.scoringPenalties.inc({penalty:r},1)},onIhaveRcv(r,s,i){const o=this.toTopic(r);this.ihaveRcvMsgids.inc({topic:o},s),this.ihaveRcvNotSeenMsgids.inc({topic:o},i)},onIwantRcv(r,s){for(const[i,o]of r){const a=this.toTopic(i);this.iwantRcvMsgids.inc({topic:a},o)}this.iwantRcvDonthaveMsgids.inc(s)},onIdontwantRcv(r,s){this.idontwantRcvMsgids.inc(r),this.idontwantRcvDonthaveMsgids.inc(s)},onForwardMsg(r,s){const i=this.toTopic(r);this.msgForwardCount.inc({topic:i},1),this.msgForwardPeers.inc({topic:i},s)},onPublishMsg(r,s,i,o,a){const l=this.toTopic(r);this.msgPublishCount.inc({topic:l},1),this.msgPublishBytes.inc({topic:l},i*o),this.msgPublishPeersByTopic.inc({topic:l},i),this.directPeersPublishedTotal.inc({topic:l},s.direct),this.floodsubPeersPublishedTotal.inc({topic:l},s.floodsub),this.meshPeersPublishedTotal.inc({topic:l},s.mesh),this.fanoutPeersPublishedTotal.inc({topic:l},s.fanout),this.msgPublishTime.observe({topic:l},a/1e3)},onMsgRecvPreValidation(r){const s=this.toTopic(r);this.msgReceivedPreValidation.inc({topic:s},1)},onMsgRecvError(r){const s=this.toTopic(r);this.msgReceivedError.inc({topic:s},1)},onPrevalidationResult(r,s){const i=this.toTopic(r);switch(s){case en.duplicate:this.prevalidationDuplicateTotal.inc({topic:i});break;case en.invalid:this.prevalidationInvalidTotal.inc({topic:i});break;case en.valid:this.prevalidationValidTotal.inc({topic:i});break;default:this.prevalidationUnknownTotal.inc({topic:i});break}},onMsgRecvInvalid(r,s){const i=this.toTopic(r),o=s.reason===Hn.Error?s.error:s.reason;this.msgReceivedInvalid.inc({error:o},1),this.msgReceivedInvalidByTopic.inc({topic:i},1)},onDuplicateMsgDelivery(r,s,i){const o=this.toTopic(r);this.duplicateMsgDeliveryDelay.observe({topic:o},s/1e3),i&&this.duplicateMsgLateDelivery.inc({topic:o},1)},onPublishDuplicateMsg(r){const s=this.toTopic(r);this.duplicateMsgIgnored.inc({topic:s},1)},onPeerReadStreamError(){this.peerReadStreamError.inc(1)},onRpcRecvError(){this.rpcRecvError.inc(1)},onRpcDataError(){this.rpcDataError.inc(1)},onRpcRecv(r,s){this.rpcRecvBytes.inc(s),this.rpcRecvCount.inc(1),r.subscriptions!=null&&this.rpcRecvSubscription.inc(r.subscriptions.length),r.messages!=null&&this.rpcRecvMessage.inc(r.messages.length),r.control!=null&&(this.rpcRecvControl.inc(1),r.control.ihave!=null&&this.rpcRecvIHave.inc(r.control.ihave.length),r.control.iwant!=null&&this.rpcRecvIWant.inc(r.control.iwant.length),r.control.graft!=null&&this.rpcRecvGraft.inc(r.control.graft.length),r.control.prune!=null&&this.rpcRecvPrune.inc(r.control.prune.length))},onRpcSent(r,s){if(this.rpcSentBytes.inc(s),this.rpcSentCount.inc(1),r.subscriptions!=null&&this.rpcSentSubscription.inc(r.subscriptions.length),r.messages!=null&&this.rpcSentMessage.inc(r.messages.length),r.control!=null){const i=r.control.ihave?.length??0,o=r.control.iwant?.length??0,a=r.control.graft?.length??0,l=r.control.prune?.length??0,u=r.control.idontwant?.length??0;i>0&&this.rpcSentIHave.inc(i),o>0&&this.rpcSentIWant.inc(o),a>0&&this.rpcSentGraft.inc(a),l>0&&this.rpcSentPrune.inc(l),u>0&&this.rpcSentIDontWant.inc(u),(i>0||o>0||a>0||l>0||u>0)&&this.rpcSentControl.inc(1)}},registerScores(r,s){let i=0,o=0,a=0,l=0;for(const u of r)u>=s.graylistThreshold&&i++,u>=s.publishThreshold&&o++,u>=s.gossipThreshold&&a++,u>=0&&l++;this.peersByScoreThreshold.set({threshold:gi.graylist},i),this.peersByScoreThreshold.set({threshold:gi.publish},o),this.peersByScoreThreshold.set({threshold:gi.gossip},a),this.peersByScoreThreshold.set({threshold:gi.mesh},l),this.score.set(r)},registerScoreWeights(r){for(const[s,i]of r.byTopic)this.scoreWeights.set({topic:s,p:"p1"},i.p1w),this.scoreWeights.set({topic:s,p:"p2"},i.p2w),this.scoreWeights.set({topic:s,p:"p3"},i.p3w),this.scoreWeights.set({topic:s,p:"p3b"},i.p3bw),this.scoreWeights.set({topic:s,p:"p4"},i.p4w);this.scoreWeights.set({p:"p5"},r.p5w),this.scoreWeights.set({p:"p6"},r.p6w),this.scoreWeights.set({p:"p7"},r.p7w)},registerScorePerMesh(r,s){const i=new Map;r.forEach((o,a)=>{const l=this.topicStrToLabel.get(a)??"unknown";let u=i.get(l);u==null&&(u=new Set,i.set(l,u)),o.forEach(h=>u?.add(h))});for(const[o,a]of i){const l=[];a.forEach(u=>{l.push(s.get(u)??0)}),this.scorePerMesh.set({topic:o},l)}}}}class Oe extends Error{constructor(t="Invalid peer score params"){super(t),this.name="InvalidPeerScoreParamsError"}}p(Oe,"name","InvalidPeerScoreParamsError");const yT={topics:{},topicScoreCap:10,appSpecificScore:()=>0,appSpecificWeight:10,IPColocationFactorWeight:-5,IPColocationFactorThreshold:10,IPColocationFactorWhitelist:new Set,behaviourPenaltyWeight:-10,behaviourPenaltyThreshold:0,behaviourPenaltyDecay:.2,decayInterval:1e3,decayToZero:.1,retainScore:3600*1e3},vT={topicWeight:.5,timeInMeshWeight:1,timeInMeshQuantum:1,timeInMeshCap:3600,firstMessageDeliveriesWeight:1,firstMessageDeliveriesDecay:.5,firstMessageDeliveriesCap:2e3,meshMessageDeliveriesWeight:-1,meshMessageDeliveriesDecay:.5,meshMessageDeliveriesCap:100,meshMessageDeliveriesThreshold:20,meshMessageDeliveriesWindow:10,meshMessageDeliveriesActivation:5e3,meshFailurePenaltyWeight:-1,meshFailurePenaltyDecay:.5,invalidMessageDeliveriesWeight:-1,invalidMessageDeliveriesDecay:.3};function bT(n={}){return{...yT,...n,topics:n.topics!=null?Object.entries(n.topics).reduce((t,[e,r])=>(t[e]=wT(r),t),{}):{}}}function wT(n={}){return{...vT,...n}}function _T(n){for(const[t,e]of Object.entries(n.topics))try{ST(e)}catch(r){throw new Oe(`invalid score parameters for topic ${t}: ${r.message}`)}if(n.topicScoreCap<0)throw new Oe("invalid topic score cap; must be positive (or 0 for no cap)");if(n.appSpecificScore===null||n.appSpecificScore===void 0)throw new Oe("missing application specific score function");if(n.IPColocationFactorWeight>0)throw new Oe("invalid IPColocationFactorWeight; must be negative (or 0 to disable)");if(n.IPColocationFactorWeight!==0&&n.IPColocationFactorThreshold<1)throw new Oe("invalid IPColocationFactorThreshold; must be at least 1");if(n.behaviourPenaltyWeight>0)throw new Oe("invalid BehaviourPenaltyWeight; must be negative (or 0 to disable)");if(n.behaviourPenaltyWeight!==0&&(n.behaviourPenaltyDecay<=0||n.behaviourPenaltyDecay>=1))throw new Oe("invalid BehaviourPenaltyDecay; must be between 0 and 1");if(n.decayInterval<1e3)throw new Oe("invalid DecayInterval; must be at least 1s");if(n.decayToZero<=0||n.decayToZero>=1)throw new Oe("invalid DecayToZero; must be between 0 and 1")}function ST(n){if(n.topicWeight<0)throw new Oe("invalid topic weight; must be >= 0");if(n.timeInMeshQuantum===0)throw new Oe("invalid TimeInMeshQuantum; must be non zero");if(n.timeInMeshWeight<0)throw new Oe("invalid TimeInMeshWeight; must be positive (or 0 to disable)");if(n.timeInMeshWeight!==0&&n.timeInMeshQuantum<=0)throw new Oe("invalid TimeInMeshQuantum; must be positive");if(n.timeInMeshWeight!==0&&n.timeInMeshCap<=0)throw new Oe("invalid TimeInMeshCap; must be positive");if(n.firstMessageDeliveriesWeight<0)throw new Oe("invallid FirstMessageDeliveriesWeight; must be positive (or 0 to disable)");if(n.firstMessageDeliveriesWeight!==0&&(n.firstMessageDeliveriesDecay<=0||n.firstMessageDeliveriesDecay>=1))throw new Oe("invalid FirstMessageDeliveriesDecay; must be between 0 and 1");if(n.firstMessageDeliveriesWeight!==0&&n.firstMessageDeliveriesCap<=0)throw new Oe("invalid FirstMessageDeliveriesCap; must be positive");if(n.meshMessageDeliveriesWeight>0)throw new Oe("invalid MeshMessageDeliveriesWeight; must be negative (or 0 to disable)");if(n.meshMessageDeliveriesWeight!==0&&(n.meshMessageDeliveriesDecay<=0||n.meshMessageDeliveriesDecay>=1))throw new Oe("invalid MeshMessageDeliveriesDecay; must be between 0 and 1");if(n.meshMessageDeliveriesWeight!==0&&n.meshMessageDeliveriesCap<=0)throw new Oe("invalid MeshMessageDeliveriesCap; must be positive");if(n.meshMessageDeliveriesWeight!==0&&n.meshMessageDeliveriesThreshold<=0)throw new Oe("invalid MeshMessageDeliveriesThreshold; must be positive");if(n.meshMessageDeliveriesWindow<0)throw new Oe("invalid MeshMessageDeliveriesWindow; must be non-negative");if(n.meshMessageDeliveriesWeight!==0&&n.meshMessageDeliveriesActivation<1e3)throw new Oe("invalid MeshMessageDeliveriesActivation; must be at least 1s");if(n.meshFailurePenaltyWeight>0)throw new Oe("invalid MeshFailurePenaltyWeight; must be negative (or 0 to disable)");if(n.meshFailurePenaltyWeight!==0&&(n.meshFailurePenaltyDecay<=0||n.meshFailurePenaltyDecay>=1))throw new Oe("invalid MeshFailurePenaltyDecay; must be between 0 and 1");if(n.invalidMessageDeliveriesWeight>0)throw new Oe("invalid InvalidMessageDeliveriesWeight; must be negative (or 0 to disable)");if(n.invalidMessageDeliveriesDecay<=0||n.invalidMessageDeliveriesDecay>=1)throw new Oe("invalid InvalidMessageDeliveriesDecay; must be between 0 and 1")}const ET={gossipThreshold:-10,publishThreshold:-50,graylistThreshold:-80,acceptPXThreshold:10,opportunisticGraftThreshold:20};function AT(n={}){return{...ET,...n}}function zd(n,t,e=()=>!0){const r=new Set;if(t<=0)return r;for(const s of n){if(r.size>=t)break;e(s)&&(r.add(s),n.delete(s))}return r}function xT(n,t){return zd(n,t,()=>!0)}class IT extends Map{constructor(e){super();p(this,"getDefault");this.getDefault=e}getOrDefault(e){let r=super.get(e);return r===void 0&&(r=this.getDefault(),this.set(e,r)),r}}function kT(n,t,e,r){let s=0;Object.entries(t.topics).forEach(([o,a])=>{const l=e.topics[o];if(l===void 0)return;let u=0;if(a.inMesh){let f=a.meshTime/l.timeInMeshQuantum;f>l.timeInMeshCap&&(f=l.timeInMeshCap),u+=f*l.timeInMeshWeight}let h=a.firstMessageDeliveries;if(h>l.firstMessageDeliveriesCap&&(h=l.firstMessageDeliveriesCap),u+=h*l.firstMessageDeliveriesWeight,a.meshMessageDeliveriesActive&&a.meshMessageDeliveries<l.meshMessageDeliveriesThreshold){const f=l.meshMessageDeliveriesThreshold-a.meshMessageDeliveries,g=f*f;u+=g*l.meshMessageDeliveriesWeight}const c=a.meshFailurePenalty;u+=c*l.meshFailurePenaltyWeight;const d=a.invalidMessageDeliveries*a.invalidMessageDeliveries;u+=d*l.invalidMessageDeliveriesWeight,s+=u*l.topicWeight}),e.topicScoreCap>0&&s>e.topicScoreCap&&(s=e.topicScoreCap);const i=e.appSpecificScore(n);if(s+=i*e.appSpecificWeight,t.knownIPs.forEach(o=>{if(e.IPColocationFactorWhitelist.has(o))return;const a=r.get(o),l=a!=null?a.size:0;if(l>e.IPColocationFactorThreshold){const u=l-e.IPColocationFactorThreshold,h=u*u;s+=h*e.IPColocationFactorWeight}}),t.behaviourPenalty>e.behaviourPenaltyThreshold){const o=t.behaviourPenalty-e.behaviourPenaltyThreshold,a=o*o;s+=a*e.behaviourPenaltyWeight}return s}var Eu,dg;function TT(){if(dg)return Eu;dg=1;function n(t,r){var r=r||{};this._capacity=r.capacity,this._head=0,this._tail=0,Array.isArray(t)?this._fromArray(t):(this._capacityMask=3,this._list=new Array(4))}return n.prototype.peekAt=function(e){var r=e;if(r===(r|0)){var s=this.size();if(!(r>=s||r<-s))return r<0&&(r+=s),r=this._head+r&this._capacityMask,this._list[r]}},n.prototype.get=function(e){return this.peekAt(e)},n.prototype.peek=function(){if(this._head!==this._tail)return this._list[this._head]},n.prototype.peekFront=function(){return this.peek()},n.prototype.peekBack=function(){return this.peekAt(-1)},Object.defineProperty(n.prototype,"length",{get:function(){return this.size()}}),n.prototype.size=function(){return this._head===this._tail?0:this._head<this._tail?this._tail-this._head:this._capacityMask+1-(this._head-this._tail)},n.prototype.unshift=function(e){if(arguments.length===0)return this.size();var r=this._list.length;return this._head=this._head-1+r&this._capacityMask,this._list[this._head]=e,this._tail===this._head&&this._growArray(),this._capacity&&this.size()>this._capacity&&this.pop(),this._head<this._tail?this._tail-this._head:this._capacityMask+1-(this._head-this._tail)},n.prototype.shift=function(){var e=this._head;if(e!==this._tail){var r=this._list[e];return this._list[e]=void 0,this._head=e+1&this._capacityMask,e<2&&this._tail>1e4&&this._tail<=this._list.length>>>2&&this._shrinkArray(),r}},n.prototype.push=function(e){if(arguments.length===0)return this.size();var r=this._tail;return this._list[r]=e,this._tail=r+1&this._capacityMask,this._tail===this._head&&this._growArray(),this._capacity&&this.size()>this._capacity&&this.shift(),this._head<this._tail?this._tail-this._head:this._capacityMask+1-(this._head-this._tail)},n.prototype.pop=function(){var e=this._tail;if(e!==this._head){var r=this._list.length;this._tail=e-1+r&this._capacityMask;var s=this._list[this._tail];return this._list[this._tail]=void 0,this._head<2&&e>1e4&&e<=r>>>2&&this._shrinkArray(),s}},n.prototype.removeOne=function(e){var r=e;if(r===(r|0)&&this._head!==this._tail){var s=this.size(),i=this._list.length;if(!(r>=s||r<-s)){r<0&&(r+=s),r=this._head+r&this._capacityMask;var o=this._list[r],a;if(e<s/2){for(a=e;a>0;a--)this._list[r]=this._list[r=r-1+i&this._capacityMask];this._list[r]=void 0,this._head=this._head+1+i&this._capacityMask}else{for(a=s-1-e;a>0;a--)this._list[r]=this._list[r=r+1+i&this._capacityMask];this._list[r]=void 0,this._tail=this._tail-1+i&this._capacityMask}return o}}},n.prototype.remove=function(e,r){var s=e,i,o=r;if(s===(s|0)&&this._head!==this._tail){var a=this.size(),l=this._list.length;if(!(s>=a||s<-a||r<1)){if(s<0&&(s+=a),r===1||!r)return i=new Array(1),i[0]=this.removeOne(s),i;if(s===0&&s+r>=a)return i=this.toArray(),this.clear(),i;s+r>a&&(r=a-s);var u;for(i=new Array(r),u=0;u<r;u++)i[u]=this._list[this._head+s+u&this._capacityMask];if(s=this._head+s&this._capacityMask,e+r===a){for(this._tail=this._tail-r+l&this._capacityMask,u=r;u>0;u--)this._list[s=s+1+l&this._capacityMask]=void 0;return i}if(e===0){for(this._head=this._head+r+l&this._capacityMask,u=r-1;u>0;u--)this._list[s=s+1+l&this._capacityMask]=void 0;return i}if(s<a/2){for(this._head=this._head+e+r+l&this._capacityMask,u=e;u>0;u--)this.unshift(this._list[s=s-1+l&this._capacityMask]);for(s=this._head-1+l&this._capacityMask;o>0;)this._list[s=s-1+l&this._capacityMask]=void 0,o--;e<0&&(this._tail=s)}else{for(this._tail=s,s=s+r+l&this._capacityMask,u=a-(r+e);u>0;u--)this.push(this._list[s++]);for(s=this._tail;o>0;)this._list[s=s+1+l&this._capacityMask]=void 0,o--}return this._head<2&&this._tail>1e4&&this._tail<=l>>>2&&this._shrinkArray(),i}}},n.prototype.splice=function(e,r){var s=e;if(s===(s|0)){var i=this.size();if(s<0&&(s+=i),!(s>i))if(arguments.length>2){var o,a,l,u=arguments.length,h=this._list.length,c=2;if(!i||s<i/2){for(a=new Array(s),o=0;o<s;o++)a[o]=this._list[this._head+o&this._capacityMask];for(r===0?(l=[],s>0&&(this._head=this._head+s+h&this._capacityMask)):(l=this.remove(s,r),this._head=this._head+s+h&this._capacityMask);u>c;)this.unshift(arguments[--u]);for(o=s;o>0;o--)this.unshift(a[o-1])}else{a=new Array(i-(s+r));var d=a.length;for(o=0;o<d;o++)a[o]=this._list[this._head+s+r+o&this._capacityMask];for(r===0?(l=[],s!=i&&(this._tail=this._head+s+h&this._capacityMask)):(l=this.remove(s,r),this._tail=this._tail-d+h&this._capacityMask);c<u;)this.push(arguments[c++]);for(o=0;o<d;o++)this.push(a[o])}return l}else return this.remove(s,r)}},n.prototype.clear=function(){this._list=new Array(this._list.length),this._head=0,this._tail=0},n.prototype.isEmpty=function(){return this._head===this._tail},n.prototype.toArray=function(){return this._copyArray(!1)},n.prototype._fromArray=function(e){var r=e.length,s=this._nextPowerOf2(r);this._list=new Array(s),this._capacityMask=s-1,this._tail=r;for(var i=0;i<r;i++)this._list[i]=e[i]},n.prototype._copyArray=function(e,r){var s=this._list,i=s.length,o=this.length;if(r=r|o,r==o&&this._head<this._tail)return this._list.slice(this._head,this._tail);var a=new Array(r),l=0,u;if(e||this._head>this._tail){for(u=this._head;u<i;u++)a[l++]=s[u];for(u=0;u<this._tail;u++)a[l++]=s[u]}else for(u=this._head;u<this._tail;u++)a[l++]=s[u];return a},n.prototype._growArray=function(){if(this._head!=0){var e=this._copyArray(!0,this._list.length<<1);this._tail=this._list.length,this._head=0,this._list=e}else this._tail=this._list.length,this._list.length<<=1;this._capacityMask=this._capacityMask<<1|1},n.prototype._shrinkArray=function(){this._list.length>>>=1,this._capacityMask>>>=1},n.prototype._nextPowerOf2=function(e){var r=Math.log(e)/Math.log(2),s=1<<r+1;return Math.max(s,4)},Eu=n,Eu}var CT=TT();const PT=co(CT);var Jt;(function(n){n[n.unknown=0]="unknown",n[n.valid=1]="valid",n[n.invalid=2]="invalid",n[n.ignored=3]="ignored"})(Jt||(Jt={}));class DT{constructor(){p(this,"records");p(this,"queue");this.records=new Map,this.queue=new PT}getRecord(t){return this.records.get(t)}ensureRecord(t){let e=this.records.get(t);if(e!=null)return e;e={status:Jt.unknown,firstSeenTsMs:Date.now(),validated:0,peers:new Set},this.records.set(t,e);const r={msgId:t,expire:Date.now()+sT};return this.queue.push(r),e}gc(){const t=Date.now();let e=this.queue.peekFront();for(;e!=null&&e.expire<t;)this.records.delete(e.msgId),this.queue.shift(),e=this.queue.peekFront()}clear(){this.records.clear(),this.queue.clear()}}class MT{constructor(t,e,r,s){p(this,"params");p(this,"metrics");p(this,"peerStats",new Map);p(this,"peerIPs",new IT(()=>new Set));p(this,"scoreCache",new Map);p(this,"deliveryRecords",new DT);p(this,"_backgroundInterval");p(this,"scoreCacheValidityMs");p(this,"computeScore");p(this,"log");this.params=t,this.metrics=e,_T(t),this.scoreCacheValidityMs=s.scoreCacheValidityMs,this.computeScore=s.computeScore??kT,this.log=r.forComponent("libp2p:gossipsub:score")}get size(){return this.peerStats.size}start(){if(this._backgroundInterval!=null){this.log("Peer score already running");return}this._backgroundInterval=setInterval(()=>{this.background()},this.params.decayInterval),this.log("started")}stop(){if(this._backgroundInterval==null){this.log("Peer score already stopped");return}clearInterval(this._backgroundInterval),delete this._backgroundInterval,this.peerIPs.clear(),this.peerStats.clear(),this.deliveryRecords.clear(),this.log("stopped")}background(){this.refreshScores(),this.deliveryRecords.gc()}dumpPeerScoreStats(){return Object.fromEntries(Array.from(this.peerStats.entries()).map(([t,e])=>[t,e]))}messageFirstSeenTimestampMs(t){const e=this.deliveryRecords.getRecord(t);return e!=null?e.firstSeenTsMs:null}refreshScores(){const t=Date.now(),e=this.params.decayToZero;this.peerStats.forEach((r,s)=>{if(!r.connected){t>r.expire&&(this.removeIPsForPeer(s,r.knownIPs),this.peerStats.delete(s),this.scoreCache.delete(s));return}Object.entries(r.topics).forEach(([i,o])=>{const a=this.params.topics[i];a!==void 0&&(o.firstMessageDeliveries*=a.firstMessageDeliveriesDecay,o.firstMessageDeliveries<e&&(o.firstMessageDeliveries=0),o.meshMessageDeliveries*=a.meshMessageDeliveriesDecay,o.meshMessageDeliveries<e&&(o.meshMessageDeliveries=0),o.meshFailurePenalty*=a.meshFailurePenaltyDecay,o.meshFailurePenalty<e&&(o.meshFailurePenalty=0),o.invalidMessageDeliveries*=a.invalidMessageDeliveriesDecay,o.invalidMessageDeliveries<e&&(o.invalidMessageDeliveries=0),o.inMesh&&(o.meshTime=t-o.graftTime,o.meshTime>a.meshMessageDeliveriesActivation&&(o.meshMessageDeliveriesActive=!0)))}),r.behaviourPenalty*=this.params.behaviourPenaltyDecay,r.behaviourPenalty<e&&(r.behaviourPenalty=0)})}score(t){this.metrics?.scoreFnCalls.inc();const e=this.peerStats.get(t);if(e==null)return 0;const r=Date.now(),s=this.scoreCache.get(t);if(s!=null&&s.cacheUntil>r)return s.score;this.metrics?.scoreFnRuns.inc();const i=this.computeScore(t,e,this.params,this.peerIPs),o=r+this.scoreCacheValidityMs;return s!=null?(this.metrics?.scoreCachedDelta.observe(Math.abs(i-s.score)),s.score=i,s.cacheUntil=o):this.scoreCache.set(t,{score:i,cacheUntil:o}),i}addPenalty(t,e,r){const s=this.peerStats.get(t);s!=null&&(s.behaviourPenalty+=e,this.metrics?.onScorePenalty(r))}addPeer(t){const e={connected:!0,expire:0,topics:{},knownIPs:new Set,behaviourPenalty:0};this.peerStats.set(t,e)}addIP(t,e){const r=this.peerStats.get(t);r?.knownIPs.add(e),this.peerIPs.getOrDefault(e).add(t)}removeIP(t,e){const r=this.peerStats.get(t);r?.knownIPs.delete(e);const s=this.peerIPs.get(e);s!=null&&(s.delete(t),s.size===0&&this.peerIPs.delete(e))}removePeer(t){const e=this.peerStats.get(t);if(e!=null){if(this.score(t)>0){this.removeIPsForPeer(t,e.knownIPs),this.peerStats.delete(t);return}Object.entries(e.topics).forEach(([r,s])=>{s.firstMessageDeliveries=0;const i=this.params.topics[r].meshMessageDeliveriesThreshold;if(s.inMesh&&s.meshMessageDeliveriesActive&&s.meshMessageDeliveries<i){const o=i-s.meshMessageDeliveries;s.meshFailurePenalty+=o*o}s.inMesh=!1,s.meshMessageDeliveriesActive=!1}),e.connected=!1,e.expire=Date.now()+this.params.retainScore}}graft(t,e){const r=this.peerStats.get(t);if(r!=null){const s=this.getPtopicStats(r,e);s!=null&&(s.inMesh=!0,s.graftTime=Date.now(),s.meshTime=0,s.meshMessageDeliveriesActive=!1)}}prune(t,e){const r=this.peerStats.get(t);if(r!=null){const s=this.getPtopicStats(r,e);if(s!=null){const i=this.params.topics[e].meshMessageDeliveriesThreshold;if(s.meshMessageDeliveriesActive&&s.meshMessageDeliveries<i){const o=i-s.meshMessageDeliveries;s.meshFailurePenalty+=o*o}s.meshMessageDeliveriesActive=!1,s.inMesh=!1}}}validateMessage(t){this.deliveryRecords.ensureRecord(t)}deliverMessage(t,e,r){this.markFirstMessageDelivery(t,r);const s=this.deliveryRecords.ensureRecord(e),i=Date.now();if(s.status!==Jt.unknown){this.log("unexpected delivery: message from %s was first seen %s ago and has delivery status %s",t,i-s.firstSeenTsMs,Jt[s.status]);return}s.status=Jt.valid,s.validated=i,s.peers.forEach(o=>{o!==t.toString()&&this.markDuplicateMessageDelivery(o,r)})}rejectInvalidMessage(t,e){this.markInvalidMessageDelivery(t,e)}rejectMessage(t,e,r,s){switch(s){case Hn.Error:this.markInvalidMessageDelivery(t,r);return;case Hn.Blacklisted:return}const i=this.deliveryRecords.ensureRecord(e);if(i.status!==Jt.unknown){this.log("unexpected rejection: message from %s was first seen %s ago and has delivery status %d",t,Date.now()-i.firstSeenTsMs,Jt[i.status]);return}if(s===Hn.Ignore){i.status=Jt.ignored,i.peers.clear();return}i.status=Jt.invalid,this.markInvalidMessageDelivery(t,r),i.peers.forEach(o=>{this.markInvalidMessageDelivery(o,r)}),i.peers.clear()}duplicateMessage(t,e,r){const s=this.deliveryRecords.ensureRecord(e);if(!s.peers.has(t))switch(s.status){case Jt.unknown:s.peers.add(t);break;case Jt.valid:s.peers.add(t),this.markDuplicateMessageDelivery(t,r,s.validated);break;case Jt.invalid:this.markInvalidMessageDelivery(t,r);break;case Jt.ignored:break}}markInvalidMessageDelivery(t,e){const r=this.peerStats.get(t);if(r!=null){const s=this.getPtopicStats(r,e);s!=null&&(s.invalidMessageDeliveries+=1)}}markFirstMessageDelivery(t,e){const r=this.peerStats.get(t);if(r!=null){const s=this.getPtopicStats(r,e);if(s!=null){let i=this.params.topics[e].firstMessageDeliveriesCap;s.firstMessageDeliveries=Math.min(i,s.firstMessageDeliveries+1),s.inMesh&&(i=this.params.topics[e].meshMessageDeliveriesCap,s.meshMessageDeliveries=Math.min(i,s.meshMessageDeliveries+1))}}}markDuplicateMessageDelivery(t,e,r){const s=this.peerStats.get(t);if(s!=null){const i=r!==void 0?Date.now():0,o=this.getPtopicStats(s,e);if(o!=null&&o.inMesh){const a=this.params.topics[e];if(r!==void 0){const u=i-r,h=u>a.meshMessageDeliveriesWindow;if(this.metrics?.onDuplicateMsgDelivery(e,u,h),h)return}const l=a.meshMessageDeliveriesCap;o.meshMessageDeliveries=Math.min(l,o.meshMessageDeliveries+1)}}}removeIPsForPeer(t,e){for(const r of e){const s=this.peerIPs.get(r);s!=null&&(s.delete(t),s.size===0&&this.peerIPs.delete(r))}}getPtopicStats(t,e){let r=t.topics[e];return r!==void 0?r:this.params.topics[e]!==void 0?(r={inMesh:!1,graftTime:0,meshTime:0,firstMessageDeliveries:0,meshMessageDeliveries:0,meshMessageDeliveriesActive:!1,meshFailurePenalty:0,invalidMessageDeliveries:0},t.topics[e]=r,r):null}}function LT(n,t,e,r,s){let i=0;const o=new Map;if(Object.entries(t.topics).forEach(([d,f])=>{const g=s.get(d)??"unknown",y=e.topics[d];if(y===void 0)return;let m=o.get(g);m==null&&(m={p1w:0,p2w:0,p3w:0,p3bw:0,p4w:0},o.set(g,m));let v=0,_=0,w=0,S=0,E=0;if(f.inMesh){const x=Math.max(f.meshTime/y.timeInMeshQuantum,y.timeInMeshCap);v+=x*y.timeInMeshWeight}let A=f.firstMessageDeliveries;if(A>y.firstMessageDeliveriesCap&&(A=y.firstMessageDeliveriesCap),_+=A*y.firstMessageDeliveriesWeight,f.meshMessageDeliveriesActive&&f.meshMessageDeliveries<y.meshMessageDeliveriesThreshold){const x=y.meshMessageDeliveriesThreshold-f.meshMessageDeliveries,V=x*x;w+=V*y.meshMessageDeliveriesWeight}const I=f.meshFailurePenalty;S+=I*y.meshFailurePenaltyWeight;const T=f.invalidMessageDeliveries*f.invalidMessageDeliveries;E+=T*y.invalidMessageDeliveriesWeight,i+=(v+_+w+S+E)*y.topicWeight,m.p1w+=v,m.p2w+=_,m.p3w+=w,m.p3bw+=S,m.p4w+=E}),e.topicScoreCap>0&&i>e.topicScoreCap){i=e.topicScoreCap;const d=e.topicScoreCap/i;for(const f of o.values())f.p1w*=d,f.p2w*=d,f.p3w*=d,f.p3bw*=d,f.p4w*=d}let a=0,l=0,u=0;const h=e.appSpecificScore(n);a+=h*e.appSpecificWeight,t.knownIPs.forEach(d=>{if(e.IPColocationFactorWhitelist.has(d))return;const f=r.get(d),g=f!=null?f.size:0;if(g>e.IPColocationFactorThreshold){const y=g-e.IPColocationFactorThreshold,m=y*y;l+=m*e.IPColocationFactorWeight}});const c=t.behaviourPenalty*t.behaviourPenalty;return u+=c*e.behaviourPenaltyWeight,i+=a+l+u,{byTopic:o,p5w:a,p6w:l,p7w:u,score:i}}function BT(n,t,e,r,s){const i={byTopic:new Map,p5w:[],p6w:[],p7w:[],score:[]};for(const o of n){const a=t.get(o);if(a!=null){const l=LT(o,a,e,r,s);for(const[u,h]of l.byTopic){let c=i.byTopic.get(u);c==null&&(c={p1w:[],p2w:[],p3w:[],p3bw:[],p4w:[]},i.byTopic.set(u,c)),c.p1w.push(h.p1w),c.p2w.push(h.p2w),c.p3w.push(h.p3w),c.p3bw.push(h.p3bw),c.p4w.push(h.p4w)}i.p5w.push(l.p5w),i.p6w.push(l.p6w),i.p7w.push(l.p7w),i.score.push(l.score)}else i.p5w.push(0),i.p6w.push(0),i.p7w.push(0),i.score.push(0)}return i}class NT{constructor(t,e,r){p(this,"rawStream");p(this,"pushable");p(this,"closeController");p(this,"maxBufferSize");this.rawStream=t,this.pushable=us(),this.closeController=new AbortController,this.maxBufferSize=r.maxBufferSize??1/0,this.closeController.signal.addEventListener("abort",()=>{t.close().catch(s=>{t.abort(s)})}),Br(this.pushable,this.rawStream).catch(e)}get protocol(){return this.rawStream.protocol}push(t){if(this.pushable.readableLength>this.maxBufferSize)throw Error(`OutboundStream buffer full, size > ${this.maxBufferSize}`);this.pushable.push(Tf.single(t))}pushPrefixed(t){if(this.pushable.readableLength>this.maxBufferSize)throw Error(`OutboundStream buffer full, size > ${this.maxBufferSize}`);this.pushable.push(t)}async close(){this.closeController.abort(),await this.pushable.return()}}class RT{constructor(t,e={}){p(this,"source");p(this,"rawStream");p(this,"closeController");this.rawStream=t,this.closeController=new AbortController,this.closeController.signal.addEventListener("abort",()=>{t.close().catch(r=>{t.abort(r)})}),this.source=Br(this.rawStream,r=>Hd(r,e))}async close(){this.closeController.abort()}}class OT{constructor(t,e,r){p(this,"gossipsubIWantFollowupMs");p(this,"msgIdToStrFn");p(this,"metrics");p(this,"promises",new Map);p(this,"requestMsByMsg",new Map);p(this,"requestMsByMsgExpire");this.gossipsubIWantFollowupMs=t,this.msgIdToStrFn=e,this.metrics=r,this.requestMsByMsgExpire=10*t}get size(){return this.promises.size}get requestMsByMsgSize(){return this.requestMsByMsg.size}addPromise(t,e){const r=Math.floor(Math.random()*e.length),s=e[r],i=this.msgIdToStrFn(s);let o=this.promises.get(i);o==null&&(o=new Map,this.promises.set(i,o));const a=Date.now();o.has(t)||(o.set(t,a+this.gossipsubIWantFollowupMs),this.metrics!=null&&(this.metrics.iwantPromiseStarted.inc(1),this.requestMsByMsg.has(i)||this.requestMsByMsg.set(i,a)))}getBrokenPromises(){const t=Date.now(),e=new Map;let r=0;return this.promises.forEach((s,i)=>{s.forEach((o,a)=>{o<t&&(e.set(a,(e.get(a)??0)+1),s.delete(a),r++)}),s.size===0&&this.promises.delete(i)}),this.metrics?.iwantPromiseBroken.inc(r),e}deliverMessage(t,e=!1){this.trackMessage(t);const r=this.promises.get(t);r!=null&&(this.promises.delete(t),this.metrics!=null&&(this.metrics.iwantPromiseResolved.inc(1),e&&this.metrics.iwantPromiseResolvedFromDuplicate.inc(1),this.metrics.iwantPromiseResolvedPeers.inc(r.size)))}rejectMessage(t,e){switch(this.trackMessage(t),e){case Hn.Error:return}this.promises.delete(t)}clear(){this.promises.clear()}prune(){const t=Date.now()-this.requestMsByMsgExpire;let e=0;for(const[r,s]of this.requestMsByMsg.entries())if(s<t)this.requestMsByMsg.delete(r),e++;else break;this.metrics?.iwantMessagePruned.inc(e)}trackMessage(t){if(this.metrics!=null){const e=this.requestMsByMsg.get(t);e!==void 0&&(this.metrics.iwantPromiseDeliveryTime.observe((Date.now()-e)/1e3),this.requestMsByMsg.delete(t))}}}function iw(n,t,e,r){mb(n);const s=vx({dkLen:32,asyncTick:10},r),{c:i,dkLen:o,asyncTick:a}=s;if(No(i),No(o),No(a),i<1)throw new Error("PBKDF2: iterations (c) should be >= 1");const l=Zo(t),u=Zo(e),h=new Uint8Array(o),c=xf.create(n,l),d=c._cloneInto().update(u);return{c:i,dkLen:o,asyncTick:a,DK:h,PRF:c,PRFSalt:d}}function ow(n,t,e,r,s){return n.destroy(),t.destroy(),r&&r.destroy(),s.fill(0),e}function FT(n,t,e,r){const{c:s,dkLen:i,DK:o,PRF:a,PRFSalt:l}=iw(n,t,e,r);let u;const h=new Uint8Array(4),c=Ro(h),d=new Uint8Array(a.outputLen);for(let f=1,g=0;g<i;f++,g+=a.outputLen){const y=o.subarray(g,g+a.outputLen);c.setInt32(0,f,!1),(u=l._cloneInto(u)).update(h).digestInto(d),y.set(d.subarray(0,y.length));for(let m=1;m<s;m++){a._cloneInto(u).update(d).digestInto(d);for(let v=0;v<y.length;v++)y[v]^=d[v]}}return ow(a,l,o,u,d)}async function aw(n,t,e,r){const{c:s,dkLen:i,asyncTick:o,DK:a,PRF:l,PRFSalt:u}=iw(n,t,e,r);let h;const c=new Uint8Array(4),d=Ro(c),f=new Uint8Array(l.outputLen);for(let g=1,y=0;y<i;g++,y+=l.outputLen){const m=a.subarray(y,y+l.outputLen);d.setInt32(0,g,!1),(h=u._cloneInto(h)).update(c).digestInto(f),m.set(f.subarray(0,m.length)),await gx(s-1,o,()=>{l._cloneInto(h).update(f).digestInto(f);for(let v=0;v<m.length;v++)m[v]^=f[v]})}return ow(l,u,a,h,f)}const Eo=new Uint32Array([1732584193,4023233417,2562383102,271733878,3285377520]),Gr=new Uint32Array(80);class $T extends lf{constructor(){super(64,20,8,!1),this.A=Eo[0]|0,this.B=Eo[1]|0,this.C=Eo[2]|0,this.D=Eo[3]|0,this.E=Eo[4]|0}get(){const{A:t,B:e,C:r,D:s,E:i}=this;return[t,e,r,s,i]}set(t,e,r,s,i){this.A=t|0,this.B=e|0,this.C=r|0,this.D=s|0,this.E=i|0}process(t,e){for(let l=0;l<16;l++,e+=4)Gr[l]=t.getUint32(e,!1);for(let l=16;l<80;l++)Gr[l]=lu(Gr[l-3]^Gr[l-8]^Gr[l-14]^Gr[l-16],1);let{A:r,B:s,C:i,D:o,E:a}=this;for(let l=0;l<80;l++){let u,h;l<20?(u=vb(s,i,o),h=1518500249):l<40?(u=s^i^o,h=1859775393):l<60?(u=bb(s,i,o),h=2400959708):(u=s^i^o,h=3395469782);const c=lu(r,5)+u+a+h+Gr[l]|0;a=o,o=i,i=lu(s,30),s=r,r=c}r=r+this.A|0,s=s+this.B|0,i=i+this.C|0,o=o+this.D|0,a=a+this.E|0,this.set(r,s,i,o,a)}roundClean(){Gr.fill(0)}destroy(){this.set(0,0,0,0,0),this.buffer.fill(0)}}const UT=af(()=>new $T),hg={sha1:UT,"sha2-256":Ia,"sha2-512":Dl};function fg(n,t,e,r,s){if(s!=="sha1"&&s!=="sha2-256"&&s!=="sha2-512"){const a=Object.keys(hg).join(" / ");throw new X(`Hash '${s}' is unknown or not supported. Must be ${a}`)}const i=hg[s],o=FT(i,n,t,{c:e,dkLen:r});return Ea.encode(o).substring(1)}const cw=te("libp2p-pubsub:");async function VT(n,t,e,r){switch(n.type){case Vi.Signing:{const s={from:n.author.toMultihash().bytes,data:r,seqno:Ui(8),topic:t,signature:void 0,key:void 0},i=bn([cw,Cs.Message.encode(s)]);s.signature=await n.privateKey.sign(i),s.key=n.key;const o={type:"signed",from:n.author,data:e,sequenceNumber:BigInt(`0x${de(s.seqno??new Uint8Array(0),"base16")}`),topic:t,signature:s.signature,key:Lr(s.key)};return{raw:s,msg:o}}case Vi.Anonymous:return{raw:{from:void 0,data:r,seqno:void 0,topic:t,signature:void 0,key:void 0},msg:{type:"unsigned",data:e,topic:t}};default:throw new Error("Unreachable")}}async function HT(n,t){switch(n){case Xh:return t.signature!=null?{valid:!1,error:jt.SignaturePresent}:t.seqno!=null?{valid:!1,error:jt.SeqnoPresent}:t.key!=null?{valid:!1,error:jt.FromPresent}:{valid:!0,message:{type:"unsigned",topic:t.topic,data:t.data??new Uint8Array(0)}};case _c:{if(t.seqno==null)return{valid:!1,error:jt.InvalidSeqno};if(t.seqno.length!==8)return{valid:!1,error:jt.InvalidSeqno};if(t.signature==null)return{valid:!1,error:jt.InvalidSignature};if(t.from==null)return{valid:!1,error:jt.InvalidPeerId};let e;try{e=Qs($r(t.from))}catch{return{valid:!1,error:jt.InvalidPeerId}}let r;if(t.key!=null){if(r=Lr(t.key),e.publicKey!==void 0&&!r.equals(e.publicKey))return{valid:!1,error:jt.InvalidPeerId}}else{if(e.publicKey==null)return{valid:!1,error:jt.InvalidPeerId};r=e.publicKey}const s={from:t.from,data:t.data,seqno:t.seqno,topic:t.topic,signature:void 0,key:void 0},i=bn([cw,Cs.Message.encode(s)]);return await r.verify(i,t.signature)?{valid:!0,message:{type:"signed",from:e,data:t.data??new Uint8Array(0),sequenceNumber:BigInt(`0x${de(t.seqno,"base16")}`),topic:t.topic,signature:t.signature,key:t.key!=null?Lr(t.key):r}}:{valid:!1,error:jt.InvalidSignature}}default:throw new Error("Unreachable")}}function Yn(n=[],t){return{subscriptions:[],messages:n,control:t!==void 0?{graft:t.graft??[],prune:t.prune??[],ihave:t.ihave??[],iwant:t.iwant??[],idontwant:t.idontwant??[]}:void 0}}function pg(n){return n.control===void 0&&(n.control={graft:[],prune:[],ihave:[],iwant:[],idontwant:[]}),n}function fr(n){if(n.length<=1)return n;const t=()=>Math.floor(Math.random()*Math.floor(n.length));for(let e=0;e<n.length;e++){const r=t(),s=n[e];n[e]=n[r],n[r]=s}return n}function zT(n){return de(n,"base64")}function qT(n,t,e){switch(n){case _c:return{type:Vi.Signing,author:t,key:nr(e.publicKey),privateKey:e};case Xh:return{type:Vi.Anonymous};default:throw new Error(`Unknown signature policy "${n}"`)}}const WT=(n,t)=>{const e=te(t.toString(16).padStart(16,"0"),"base16"),r=nr(n),s=new Uint8Array(r.byteLength+e.length);return s.set(r,0),s.set(e,r.byteLength),s};function GT(n){if(n.type!=="signed")throw new Error("expected signed message type");if(n.sequenceNumber==null)throw Error("missing seqno field");return WT(n.from.publicKey??n.key,n.sequenceNumber)}async function KT(n){return Aa.encode(n.data)}class YT{constructor(){p(this,"index",0);p(this,"input","")}new(t){return this.index=0,this.input=t,this}readAtomically(t){const e=this.index,r=t();return r===void 0&&(this.index=e),r}parseWith(t){const e=t();if(this.index===this.input.length)return e}peekChar(){if(!(this.index>=this.input.length))return this.input[this.index]}readChar(){if(!(this.index>=this.input.length))return this.input[this.index++]}readGivenChar(t){return this.readAtomically(()=>{const e=this.readChar();if(e===t)return e})}readSeparator(t,e,r){return this.readAtomically(()=>{if(!(e>0&&this.readGivenChar(t)===void 0))return r()})}readNumber(t,e,r,s){return this.readAtomically(()=>{let i=0,o=0;const a=this.peekChar();if(a===void 0)return;const l=a==="0",u=2**(8*s)-1;for(;;){const h=this.readAtomically(()=>{const c=this.readChar();if(c===void 0)return;const d=Number.parseInt(c,t);if(!Number.isNaN(d))return d});if(h===void 0)break;if(i*=t,i+=h,i>u||(o+=1,e!==void 0&&o>e))return}if(o!==0)return!r&&l&&o>1?void 0:i})}readIPv4Addr(){return this.readAtomically(()=>{const t=new Uint8Array(4);for(let e=0;e<t.length;e++){const r=this.readSeparator(".",e,()=>this.readNumber(10,3,!1,1));if(r===void 0)return;t[e]=r}return t})}readIPv6Addr(){const t=e=>{for(let r=0;r<e.length/2;r++){const s=r*2;if(r<e.length-3){const o=this.readSeparator(":",r,()=>this.readIPv4Addr());if(o!==void 0)return e[s]=o[0],e[s+1]=o[1],e[s+2]=o[2],e[s+3]=o[3],[s+4,!0]}const i=this.readSeparator(":",r,()=>this.readNumber(16,4,!0,2));if(i===void 0)return[s,!1];e[s]=i>>8,e[s+1]=i&255}return[e.length,!1]};return this.readAtomically(()=>{const e=new Uint8Array(16),[r,s]=t(e);if(r===16)return e;if(s||this.readGivenChar(":")===void 0||this.readGivenChar(":")===void 0)return;const i=new Uint8Array(14),o=16-(r+2),[a]=t(i.subarray(0,o));return e.set(i.subarray(0,a),16-a),e})}readIPAddr(){return this.readIPv4Addr()??this.readIPv6Addr()}}const lw=45,QT=15,Hi=new YT;function uw(n){if(!(n.length>QT))return Hi.new(n).parseWith(()=>Hi.readIPv4Addr())}function dw(n){if(n.includes("%")&&(n=n.split("%")[0]),!(n.length>lw))return Hi.new(n).parseWith(()=>Hi.readIPv6Addr())}function Bc(n,t=!1){if(n.includes("%")&&(n=n.split("%")[0]),n.length>lw)return;const e=Hi.new(n).parseWith(()=>Hi.readIPAddr());if(e)return t&&e.length===4?Uint8Array.from([0,0,0,0,0,0,0,0,0,0,255,255,e[0],e[1],e[2],e[3]]):e}function ZT(n,t,e){let r=0;for(const s of n)if(!(r<t)){if(r>e)break;if(s!==255)return!1;r++}return!0}function XT(n,t,e,r){let s=0;for(const i of n)if(!(s<e)){if(s>r)break;if(i!==t[s])return!1;s++}return!0}function jT(n){switch(n.length){case ea:return n.join(".");case ta:{const t=[];for(let e=0;e<n.length;e++)e%2===0&&t.push(n[e].toString(16).padStart(2,"0")+n[e+1].toString(16).padStart(2,"0"));return t.join(":")}default:throw new Error("Invalid ip length")}}function JT(n){let t=0;for(let[e,r]of n.entries()){if(r===255){t+=8;continue}for(;(r&128)!=0;)t++,r=r<<1;if((r&128)!=0)return-1;for(let s=e+1;s<n.length;s++)if(n[s]!=0)return-1;break}return t}function eC(n){let t="0x";for(const e of n)t+=(e>>4).toString(16)+(e&15).toString(16);return t}const ea=4,ta=16,tC=new Uint8Array([0,0,0,0,0,0,0,0,0,0,255,255]);function hw(n,t){t.length===ta&&n.length===ea&&ZT(t,0,11)&&(t=t.slice(12)),t.length===ea&&n.length===ta&&XT(n,tC,0,11)&&(n=n.slice(12));const e=n.length;if(e!=t.length)throw new Error("Failed to mask ip");const r=new Uint8Array(e);for(let s=0;s<e;s++)r[s]=n[s]&t[s];return r}function nC(n,t){if(typeof t=="string"&&(t=Bc(t)),t==null)throw new Error("Invalid ip");if(t.length!==n.network.length)return!1;for(let e=0;e<t.length;e++)if((n.network[e]&n.mask[e])!==(t[e]&n.mask[e]))return!1;return!0}function rC(n){const[t,e]=n.split("/");if(!t||!e)throw new Error("Failed to parse given CIDR: "+n);let r=ea,s=uw(t);if(s==null&&(r=ta,s=dw(t),s==null))throw new Error("Failed to parse given CIDR: "+n);const i=parseInt(e,10);if(Number.isNaN(i)||String(i).length!==e.length||i<0||i>r*8)throw new Error("Failed to parse given CIDR: "+n);const o=fw(i,8*r);return{network:hw(s,o),mask:o}}function fw(n,t){if(t!==8*ea&&t!==8*ta)throw new Error("Invalid CIDR mask");if(n<0||n>t)throw new Error("Invalid CIDR mask");const e=t/8,r=new Uint8Array(e);for(let s=0;s<e;s++){if(n>=8){r[s]=255,n-=8;continue}r[s]=255-(255>>n),n=0}return r}class pw{constructor(t,e){if(e==null)({network:this.network,mask:this.mask}=rC(t));else{const r=Bc(t);if(r==null)throw new Error("Failed to parse network");e=String(e);const s=parseInt(e,10);if(Number.isNaN(s)||String(s).length!==e.length||s<0||s>r.length*8){const i=Bc(e);if(i==null)throw new Error("Failed to parse mask");this.mask=i}else this.mask=fw(s,8*r.length);this.network=hw(r,this.mask)}}contains(t){return nC({network:this.network,mask:this.mask},t)}toString(){const t=JT(this.mask),e=t!==-1?String(t):eC(this.mask);return jT(this.network)+"/"+e}}function sC(n,t){return new pw(n).contains(t)}function zi(n){return!!uw(n)}function Df(n){return!!dw(n)}function gw(n){return!!Bc(n)}const gg=zi,iC=Df,mw=function(n){let t=0;if(n=n.toString().trim(),gg(n)){const e=new Uint8Array(t+4);return n.split(/\./g).forEach(r=>{e[t++]=parseInt(r,10)&255}),e}if(iC(n)){const e=n.split(":",8);let r;for(r=0;r<e.length;r++){const i=gg(e[r]);let o;i&&(o=mw(e[r]),e[r]=de(o.slice(0,2),"base16")),o!=null&&++r<8&&e.splice(r,0,de(o.slice(2,4),"base16"))}if(e[0]==="")for(;e.length<8;)e.unshift("0");else if(e[e.length-1]==="")for(;e.length<8;)e.push("0");else if(e.length<8){for(r=0;r<e.length&&e[r]!=="";r++);const i=[r,1];for(r=9-e.length;r>0;r--)i.push("0");e.splice.apply(e,i)}const s=new Uint8Array(t+16);for(r=0;r<e.length;r++){const i=parseInt(e[r],16);s[t++]=i>>8&255,s[t++]=i&255}return s}throw new Error("invalid ip address")},oC=function(n,t=0,e){t=~~t,e=e??n.length-t;const r=new DataView(n.buffer);if(e===4){const s=[];for(let i=0;i<e;i++)s.push(n[t+i]);return s.join(".")}if(e===16){const s=[];for(let i=0;i<e;i+=2)s.push(r.getUint16(t+i).toString(16));return s.join(":").replace(/(^|:)0(:0)*:0(:|$)/,"$1::$3").replace(/:{3,4}/,"::")}return""},dn=-1,na={},qd={},aC=[[4,32,"ip4"],[6,16,"tcp"],[33,16,"dccp"],[41,128,"ip6"],[42,dn,"ip6zone"],[43,8,"ipcidr"],[53,dn,"dns",!0],[54,dn,"dns4",!0],[55,dn,"dns6",!0],[56,dn,"dnsaddr",!0],[132,16,"sctp"],[273,16,"udp"],[275,0,"p2p-webrtc-star"],[276,0,"p2p-webrtc-direct"],[277,0,"p2p-stardust"],[280,0,"webrtc-direct"],[281,0,"webrtc"],[290,0,"p2p-circuit"],[301,0,"udt"],[302,0,"utp"],[400,dn,"unix",!1,!0],[421,dn,"ipfs"],[421,dn,"p2p"],[443,0,"https"],[444,96,"onion"],[445,296,"onion3"],[446,dn,"garlic64"],[448,0,"tls"],[449,dn,"sni"],[460,0,"quic"],[461,0,"quic-v1"],[465,0,"webtransport"],[466,dn,"certhash"],[477,0,"ws"],[478,0,"wss"],[479,0,"p2p-websocket-star"],[480,0,"http"],[481,dn,"http-path"],[777,dn,"memory"]];aC.forEach(n=>{const t=cC(...n);qd[t.code]=t,na[t.name]=t});function cC(n,t,e,r,s){return{code:n,size:t,name:e,resolvable:!!r,path:!!s}}function pe(n){if(typeof n=="number"){if(qd[n]!=null)return qd[n];throw new Error(`no protocol with code: ${n}`)}else if(typeof n=="string"){if(na[n]!=null)return na[n];throw new Error(`no protocol with name: ${n}`)}throw new Error(`invalid protocol id type: ${typeof n}`)}const lC=pe("ip4"),uC=pe("ip6"),dC=pe("ipcidr");function Mf(n,t){switch(pe(n).code){case 4:case 41:return pC(t);case 42:return Iu(t);case 43:return de(t,"base10");case 6:case 273:case 33:case 132:return yw(t).toString();case 53:case 54:case 55:case 56:case 400:case 449:case 777:return Iu(t);case 421:return vC(t);case 444:return vg(t);case 445:return vg(t);case 466:return yC(t);case 481:return globalThis.encodeURIComponent(Iu(t));default:return de(t,"base16")}}function mg(n,t){switch(pe(n).code){case 4:return yg(t);case 41:return yg(t);case 42:return xu(t);case 43:return te(t,"base10");case 6:case 273:case 33:case 132:return Lf(parseInt(t,10));case 53:case 54:case 55:case 56:case 400:case 449:case 777:return xu(t);case 421:return gC(t);case 444:return bC(t);case 445:return wC(t);case 466:return mC(t);case 481:return xu(globalThis.decodeURIComponent(t));default:return te(t,"base16")}}function hC(n){let t,e;if(n.stringTuples().forEach(([r,s])=>{(r===lC.code||r===uC.code)&&(e=s),r===dC.code&&(t=s)}),t==null||e==null)throw new Error("Invalid multiaddr");return new pw(e,t)}const Au=Object.values(Nd).map(n=>n.decoder),fC=function(){let n=Au[0].or(Au[1]);return Au.slice(2).forEach(t=>n=n.or(t)),n}();function yg(n){if(!gw(n))throw new Error("invalid ip address");return mw(n)}function pC(n){const t=oC(n,0,n.length);if(t==null)throw new Error("ipBuff is required");if(!gw(t))throw new Error("invalid ip address");return t}function Lf(n){const t=new ArrayBuffer(2);return new DataView(t).setUint16(0,n),new Uint8Array(t)}function yw(n){return new DataView(n.buffer).getUint16(n.byteOffset)}function xu(n){const t=te(n),e=Uint8Array.from(Vn(t.length));return bn([e,t],e.length+t.length)}function Iu(n){const t=Ys(n);if(n=n.slice(ln(t)),n.length!==t)throw new Error("inconsistent lengths");return de(n)}function gC(n){let t;n[0]==="Q"||n[0]==="1"?t=$r(ot.decode(`z${n}`)).bytes:t=Ye.parse(n).multihash.bytes;const e=Uint8Array.from(Vn(t.length));return bn([e,t],e.length+t.length)}function mC(n){const t=fC.decode(n),e=Uint8Array.from(Vn(t.length));return bn([e,t],e.length+t.length)}function yC(n){const t=Ys(n),e=n.slice(ln(t));if(e.length!==t)throw new Error("inconsistent lengths");return"u"+de(e,"base64url")}function vC(n){const t=Ys(n),e=n.slice(ln(t));if(e.length!==t)throw new Error("inconsistent lengths");return de(e,"base58btc")}function bC(n){const t=n.split(":");if(t.length!==2)throw new Error(`failed to parse onion addr: ["'${t.join('", "')}'"]' does not contain a port number`);if(t[0].length!==16)throw new Error(`failed to parse onion addr: ${t[0]} not a Tor onion address.`);const e=Cr.decode("b"+t[0]),r=parseInt(t[1],10);if(r<1||r>65536)throw new Error("Port number is not in range(1, 65536)");const s=Lf(r);return bn([e,s],e.length+s.length)}function wC(n){const t=n.split(":");if(t.length!==2)throw new Error(`failed to parse onion addr: ["'${t.join('", "')}'"]' does not contain a port number`);if(t[0].length!==56)throw new Error(`failed to parse onion addr: ${t[0]} not a Tor onion3 address.`);const e=Cr.decode(`b${t[0]}`),r=parseInt(t[1],10);if(r<1||r>65536)throw new Error("Port number is not in range(1, 65536)");const s=Lf(r);return bn([e,s],e.length+s.length)}function vg(n){const t=n.slice(0,n.length-2),e=n.slice(n.length-2),r=de(t,"base32"),s=yw(e);return`${r}:${s}`}var Nc;(function(n){n[n.ip4=4]="ip4",n[n.ip6=41]="ip6"})(Nc||(Nc={}));function _C(n){for(const t of n.tuples())switch(t[0]){case Nc.ip4:case Nc.ip6:return Mf(t[0],t[1])}return null}class ku{constructor(t){p(this,"entries",new Map);p(this,"validityMs");this.validityMs=t.validityMs}get size(){return this.entries.size}put(t,e){return this.entries.has(t)?!0:(this.entries.set(t,{value:e,validUntilMs:Date.now()+this.validityMs}),!1)}prune(){const t=Date.now();for(const[e,r]of this.entries.entries())if(r.validUntilMs<t)this.entries.delete(e);else break}has(t){return this.entries.has(t)}get(t){const e=this.entries.get(t);return e!=null&&e.validUntilMs>=Date.now()?e.value:void 0}clear(){this.entries.clear()}}var fn;(function(n){n[n.started=0]="started",n[n.stopped=1]="stopped"})(fn||(fn={}));var ty,ny,ry,sy;class vw extends(sy=ar,ry=Symbol.toStringTag,ny=Wn,ty=Ac,sy){constructor(e,r={}){super();p(this,"globalSignaturePolicy");p(this,"multicodecs",[Su,Lk,og]);p(this,"publishConfig");p(this,"dataTransform");p(this,"peers",new Set);p(this,"streamsInbound",new Map);p(this,"streamsOutbound",new Map);p(this,"outboundInflightQueue",us({objectMode:!0}));p(this,"direct",new Set);p(this,"floodsubPeers",new Set);p(this,"seenCache");p(this,"acceptFromWhitelist",new Map);p(this,"topics",new Map);p(this,"subscriptions",new Set);p(this,"mesh",new Map);p(this,"fanout",new Map);p(this,"fanoutLastpub",new Map);p(this,"gossip",new Map);p(this,"control",new Map);p(this,"peerhave",new Map);p(this,"iasked",new Map);p(this,"backoff",new Map);p(this,"outbound",new Map);p(this,"msgIdFn");p(this,"fastMsgIdFn");p(this,"msgIdToStrFn");p(this,"fastMsgIdCache");p(this,"publishedMessageIds");p(this,"mcache");p(this,"score");p(this,"topicValidators",new Map);p(this,"log");p(this,"heartbeatTicks",0);p(this,"gossipTracer");p(this,"idontwantCounts",new Map);p(this,"idontwants",new Map);p(this,"components");p(this,"directPeerInitial",null);p(this,"opts");p(this,"decodeRpcLimits");p(this,"metrics");p(this,"status",{code:fn.stopped});p(this,"maxInboundStreams");p(this,"maxOutboundStreams");p(this,"runOnLimitedConnection");p(this,"allowedTopics");p(this,"heartbeatTimer",null);p(this,ry,"@chainsafe/libp2p-gossipsub");p(this,ny,["@libp2p/pubsub"]);p(this,ty,["@libp2p/identify"]);p(this,"runHeartbeat",()=>{const e=this.metrics?.heartbeatDuration.startTimer();this.heartbeat().catch(r=>{this.log("Error running heartbeat",r)}).finally(()=>{if(e?.(),this.status.code===fn.started){clearTimeout(this.status.heartbeatTimeout);let r=this.opts.heartbeatInterval-(Date.now()-this.status.hearbeatStartMs)%this.opts.heartbeatInterval;r<this.opts.heartbeatInterval*.25&&(r+=this.opts.heartbeatInterval,this.metrics?.heartbeatSkipped.inc()),this.status.heartbeatTimeout=setTimeout(this.runHeartbeat,r)}})});p(this,"tagMeshPeer",e=>{const{peerId:r,topic:s}=e.detail;this.components.peerStore.merge(Bt(r),{tags:{[s]:{value:100}}}).catch(i=>{this.log.error("Error tagging peer %s with topic %s",r,s,i)})});p(this,"untagMeshPeer",e=>{const{peerId:r,topic:s}=e.detail;this.components.peerStore.merge(Bt(r),{tags:{[s]:void 0}}).catch(i=>{this.log.error("Error untagging peer %s with topic %s",r,s,i)})});const s={fallbackToFloodsub:!0,floodPublish:!0,batchPublish:!1,tagMeshPeers:!0,doPX:!1,directPeers:[],D:Bk,Dlo:Nk,Dhi:Rk,Dscore:Ok,Dout:Fk,Dlazy:Vk,heartbeatInterval:qk,fanoutTTL:Wk,mcacheLength:$k,mcacheGossip:Uk,seenTTL:rT,gossipsubIWantFollowupMs:nT,prunePeers:Gk,pruneBackoff:Kk,unsubcribeBackoff:Yk,graftFloodThreshold:eT,opportunisticGraftPeers:Jk,opportunisticGraftTicks:jk,directConnectTicks:Zk,gossipFactor:Hk,idontwantMinDataSize:hT,idontwantMaxMessages:fT,...r,scoreParams:bT(r.scoreParams),scoreThresholds:AT(r.scoreThresholds)};if(this.components=e,this.decodeRpcLimits=s.decodeRpcLimits??pT,this.globalSignaturePolicy=s.globalSignaturePolicy??_c,s.fallbackToFloodsub&&this.multicodecs.push(ig),this.log=e.logger.forComponent(s.debugName??"libp2p:gossipsub"),this.opts=s,this.direct=new Set(s.directPeers.map(i=>i.id.toString())),this.seenCache=new ku({validityMs:s.seenTTL}),this.publishedMessageIds=new ku({validityMs:s.seenTTL}),r.msgIdFn!=null)this.msgIdFn=r.msgIdFn;else switch(this.globalSignaturePolicy){case _c:this.msgIdFn=GT;break;case Xh:this.msgIdFn=KT;break;default:throw new Error(`Invalid globalSignaturePolicy: ${this.globalSignaturePolicy}`)}if(r.fastMsgIdFn!=null&&(this.fastMsgIdFn=r.fastMsgIdFn,this.fastMsgIdCache=new ku({validityMs:s.seenTTL})),this.msgIdToStrFn=r.msgIdToStrFn??zT,this.mcache=r.messageCache??new gT(s.mcacheGossip,s.mcacheLength,this.msgIdToStrFn),r.dataTransform!=null&&(this.dataTransform=r.dataTransform),r.metricsRegister!=null){if(r.metricsTopicStrToLabel==null)throw Error("Must set metricsTopicStrToLabel with metrics");const i=Math.max(...Object.values(s.scoreParams.topics).map(a=>a.meshMessageDeliveriesWindow),uT),o=mT(r.metricsRegister,r.metricsTopicStrToLabel,{gossipPromiseExpireSec:this.opts.gossipsubIWantFollowupMs/1e3,behaviourPenaltyThreshold:s.scoreParams.behaviourPenaltyThreshold,maxMeshMessageDeliveriesWindowSec:i/1e3});o.mcacheSize.addCollect(()=>{this.onScrapeMetrics(o)});for(const a of this.multicodecs)o.protocolsEnabled.set({protocol:a},1);this.metrics=o}else this.metrics=null;this.gossipTracer=new OT(this.opts.gossipsubIWantFollowupMs,this.msgIdToStrFn,this.metrics),this.score=new MT(this.opts.scoreParams,this.metrics,this.components.logger,{scoreCacheValidityMs:s.heartbeatInterval}),this.maxInboundStreams=r.maxInboundStreams,this.maxOutboundStreams=r.maxOutboundStreams,this.runOnLimitedConnection=r.runOnLimitedConnection,this.allowedTopics=s.allowedTopics!=null?new Set(s.allowedTopics):null}getPeers(){return[...this.peers.keys()].map(e=>Bt(e))}isStarted(){return this.status.code===fn.started}async start(){if(this.isStarted())return;this.log("starting"),this.publishConfig=qT(this.globalSignaturePolicy,this.components.peerId,this.components.privateKey),this.outboundInflightQueue=us({objectMode:!0}),Br(this.outboundInflightQueue,async o=>{for await(const{peerId:a,connection:l}of o)await this.createOutboundStream(a,l)}).catch(o=>{this.log.error("outbound inflight queue error",o)}),await Promise.all(this.opts.directPeers.map(async o=>{await this.components.peerStore.merge(o.id,{multiaddrs:o.addrs})}));const e=this.components.registrar;await Promise.all(this.multicodecs.map(async o=>e.handle(o,this.onIncomingStream.bind(this),{maxInboundStreams:this.maxInboundStreams,maxOutboundStreams:this.maxOutboundStreams,runOnLimitedConnection:this.runOnLimitedConnection})));const r={onConnect:this.onPeerConnected.bind(this),onDisconnect:this.onPeerDisconnected.bind(this),notifyOnLimitedConnection:this.runOnLimitedConnection},s=await Promise.all(this.multicodecs.map(async o=>e.register(o,r))),i=setTimeout(this.runHeartbeat,ag);this.status={code:fn.started,registrarTopologyIds:s,heartbeatTimeout:i,hearbeatStartMs:Date.now()+ag},this.score.start(),this.directPeerInitial=setTimeout(()=>{Promise.resolve().then(async()=>{await Promise.all(Array.from(this.direct).map(async o=>this.connect(o)))}).catch(o=>{this.log(o)})},Xk),this.opts.tagMeshPeers&&(this.addEventListener("gossipsub:graft",this.tagMeshPeer),this.addEventListener("gossipsub:prune",this.untagMeshPeer)),this.log("started")}async stop(){if(this.log("stopping"),this.status.code!==fn.started)return;const{registrarTopologyIds:e}=this.status;this.status={code:fn.stopped},this.opts.tagMeshPeers&&(this.removeEventListener("gossipsub:graft",this.tagMeshPeer),this.removeEventListener("gossipsub:prune",this.untagMeshPeer));const r=this.components.registrar;await Promise.all(this.multicodecs.map(async i=>r.unhandle(i))),e.forEach(i=>{r.unregister(i)}),this.outboundInflightQueue.end();const s=[];for(const i of this.streamsOutbound.values())s.push(i.close());this.streamsOutbound.clear();for(const i of this.streamsInbound.values())s.push(i.close());this.streamsInbound.clear(),await Promise.all(s),this.peers.clear(),this.subscriptions.clear(),this.heartbeatTimer!=null&&(this.heartbeatTimer.cancel(),this.heartbeatTimer=null),this.score.stop(),this.mesh.clear(),this.fanout.clear(),this.fanoutLastpub.clear(),this.gossip.clear(),this.control.clear(),this.peerhave.clear(),this.iasked.clear(),this.backoff.clear(),this.outbound.clear(),this.gossipTracer.clear(),this.seenCache.clear(),this.fastMsgIdCache!=null&&this.fastMsgIdCache.clear(),this.directPeerInitial!=null&&clearTimeout(this.directPeerInitial),this.idontwantCounts.clear(),this.idontwants.clear(),this.log("stopped")}dumpPeerScoreStats(){return this.score.dumpPeerScoreStats()}onIncomingStream({stream:e,connection:r}){if(!this.isStarted())return;const s=r.remotePeer;this.addPeer(s,r.direction,r.remoteAddr),this.createInboundStream(s,e),this.outboundInflightQueue.push({peerId:s,connection:r})}onPeerConnected(e,r){this.metrics?.newConnectionCount.inc({status:r.status}),!(!this.isStarted()||r.status!=="open")&&(this.addPeer(e,r.direction,r.remoteAddr),this.outboundInflightQueue.push({peerId:e,connection:r}))}onPeerDisconnected(e){this.log("connection ended %p",e),this.removePeer(e)}async createOutboundStream(e,r){if(!this.isStarted())return;const s=e.toString();if(this.peers.has(s)&&!this.streamsOutbound.has(s))try{const i=new NT(await r.newStream(this.multicodecs,{runOnLimitedConnection:this.runOnLimitedConnection}),a=>{this.log.error("outbound pipe error",a)},{maxBufferSize:this.opts.maxOutboundBufferSize});this.log("create outbound stream %p",e),this.streamsOutbound.set(s,i);const o=i.protocol;o===ig&&this.floodsubPeers.add(s),this.metrics?.peersPerProtocol.inc({protocol:o},1),this.subscriptions.size>0&&(this.log("send subscriptions to",s),this.sendSubscriptions(s,Array.from(this.subscriptions),!0))}catch(i){this.log.error("createOutboundStream error",i)}}createInboundStream(e,r){if(!this.isStarted())return;const s=e.toString();if(!this.peers.has(s))return;const i=this.streamsInbound.get(s);i!==void 0&&(this.log("replacing existing inbound steam %s",s),i.close().catch(a=>{this.log.error(a)})),this.log("create inbound stream %s",s);const o=new RT(r,{maxDataLength:this.opts.maxInboundDataLength});this.streamsInbound.set(s,o),this.pipePeerReadStream(e,o.source).catch(a=>{this.log(a)})}addPeer(e,r,s){const i=e.toString();if(!this.peers.has(i)){this.log("new peer %p",e),this.peers.add(i),this.score.addPeer(i);const o=_C(s);o!==null?this.score.addIP(i,o):this.log("Added peer has no IP in current address %s %s",i,s.toString()),this.outbound.has(i)||this.outbound.set(i,r==="outbound")}}removePeer(e){const r=e.toString();if(!this.peers.has(r))return;this.log("delete peer %p",e),this.peers.delete(r);const s=this.streamsOutbound.get(r),i=this.streamsInbound.get(r);s!=null&&this.metrics?.peersPerProtocol.inc({protocol:s.protocol},-1),s?.close().catch(o=>{this.log.error(o)}),i?.close().catch(o=>{this.log.error(o)}),this.streamsOutbound.delete(r),this.streamsInbound.delete(r);for(const o of this.topics.values())o.delete(r);for(const[o,a]of this.mesh)a.delete(r)&&this.metrics?.onRemoveFromMesh(o,Jn.Dc,1);for(const o of this.fanout.values())o.delete(r);this.floodsubPeers.delete(r),this.gossip.delete(r),this.control.delete(r),this.outbound.delete(r),this.idontwantCounts.delete(r),this.idontwants.delete(r),this.score.removePeer(r),this.acceptFromWhitelist.delete(r)}get started(){return this.status.code===fn.started}getMeshPeers(e){const r=this.mesh.get(e);return r!=null?Array.from(r):[]}getSubscribers(e){const r=this.topics.get(e);return(r!=null?Array.from(r):[]).map(s=>Bt(s))}getTopics(){return Array.from(this.subscriptions)}async pipePeerReadStream(e,r){try{await Br(r,async s=>{for await(const i of s)try{const o=i.subarray(),a=Cs.decode(o,{limits:{subscriptions:this.decodeRpcLimits.maxSubscriptions,messages:this.decodeRpcLimits.maxMessages,control$:{ihave:this.decodeRpcLimits.maxIhaveMessageIDs,iwant:this.decodeRpcLimits.maxIwantMessageIDs,graft:this.decodeRpcLimits.maxControlMessages,prune:this.decodeRpcLimits.maxControlMessages,prune$:{peers:this.decodeRpcLimits.maxPeerInfos},idontwant:this.decodeRpcLimits.maxControlMessages,idontwant$:{messageIDs:this.decodeRpcLimits.maxIdontwantMessageIDs}}}});if(this.metrics?.onRpcRecv(a,o.length),this.opts.awaitRpcHandler)try{await this.handleReceivedRpc(e,a)}catch(l){this.metrics?.onRpcRecvError(),this.log(l)}else this.handleReceivedRpc(e,a).catch(l=>{this.metrics?.onRpcRecvError(),this.log(l)})}catch(o){this.metrics?.onRpcDataError(),this.log(o)}})}catch(s){this.metrics?.onPeerReadStreamError(),this.handlePeerReadStreamError(s,e)}}handlePeerReadStreamError(e,r){this.log.error(e),this.onPeerDisconnected(r)}async handleReceivedRpc(e,r){if(!this.acceptFrom(e.toString())){this.log("received message from unacceptable peer %p",e),this.metrics?.rpcRecvNotAccepted.inc();return}const s=r.subscriptions!=null?r.subscriptions.length:0,i=r.messages!=null?r.messages.length:0;let o=0,a=0,l=0,u=0;if(r.control!=null&&(r.control.ihave!=null&&(o=r.control.ihave.length),r.control.iwant!=null&&(a=r.control.iwant.length),r.control.graft!=null&&(l=r.control.graft.length),r.control.prune!=null&&(u=r.control.prune.length)),this.log(`rpc.from ${e.toString()} subscriptions ${s} messages ${i} ihave ${o} iwant ${a} graft ${l} prune ${u}`),r.subscriptions!=null&&r.subscriptions.length>0){const h=[];r.subscriptions.forEach(c=>{const d=c.topic,f=c.subscribe===!0;if(d!=null){if(this.allowedTopics!=null&&!this.allowedTopics.has(d))return;this.handleReceivedSubscription(e,d,f),h.push({topic:d,subscribe:f})}}),this.safeDispatchEvent("subscription-change",{detail:{peerId:e,subscriptions:h}})}for(const h of r.messages){if(this.allowedTopics!=null&&!this.allowedTopics.has(h.topic))continue;const c=this.handleReceivedMessage(e,h).catch(d=>{this.metrics?.onMsgRecvError(h.topic),this.log(d)});this.opts.awaitRpcMessageHandler&&await c}r.control!=null&&await this.handleControlMessage(e.toString(),r.control)}handleReceivedSubscription(e,r,s){this.log("subscription update from %p topic %s",e,r);let i=this.topics.get(r);i==null&&(i=new Set,this.topics.set(r,i)),s?i.add(e.toString()):i.delete(e.toString())}async handleReceivedMessage(e,r){this.metrics?.onMsgRecvPreValidation(r.topic);const s=await this.validateReceivedMessage(e,r);this.metrics?.onPrevalidationResult(r.topic,s.code);const i=s.code;switch(i){case en.duplicate:this.score.duplicateMessage(e.toString(),s.msgIdStr,r.topic),this.gossipTracer.deliverMessage(s.msgIdStr,!0),this.mcache.observeDuplicate(s.msgIdStr,e.toString());return;case en.invalid:if(s.msgIdStr!=null){const o=s.msgIdStr;this.score.rejectMessage(e.toString(),o,r.topic,s.reason),this.gossipTracer.rejectMessage(o,s.reason)}else this.score.rejectInvalidMessage(e.toString(),r.topic);this.metrics?.onMsgRecvInvalid(r.topic,s);return;case en.valid:this.score.validateMessage(s.messageId.msgIdStr),this.gossipTracer.deliverMessage(s.messageId.msgIdStr),this.mcache.put(s.messageId,r,!this.opts.asyncValidation),this.subscriptions.has(r.topic)&&(!this.components.peerId.equals(e)||this.opts.emitSelf)&&(super.dispatchEvent(new CustomEvent("gossipsub:message",{detail:{propagationSource:e,msgId:s.messageId.msgIdStr,msg:s.msg}})),super.dispatchEvent(new CustomEvent("message",{detail:s.msg}))),this.opts.asyncValidation||this.forwardMessage(s.messageId.msgIdStr,r,e.toString());break;default:throw new Error(`Invalid validation result: ${i}`)}}async validateReceivedMessage(e,r){const s=this.fastMsgIdFn?.(r),i=s!==void 0?this.fastMsgIdCache?.get(s):void 0;if(i!=null)return{code:en.duplicate,msgIdStr:i};const o=await HT(this.globalSignaturePolicy,r);if(!o.valid)return{code:en.invalid,reason:Hn.Error,error:o.error};const a=o.message;try{this.dataTransform!=null&&(a.data=this.dataTransform.inboundTransform(r.topic,a.data))}catch(d){return this.log("Invalid message, transform failed",d),{code:en.invalid,reason:Hn.Error,error:jt.TransformFailed}}const l=await this.msgIdFn(a),u=this.msgIdToStrFn(l),h={msgId:l,msgIdStr:u};if(s!==void 0&&this.fastMsgIdCache!=null&&this.fastMsgIdCache.put(s,u)&&this.metrics?.fastMsgIdCacheCollision.inc(),this.seenCache.has(u))return{code:en.duplicate,msgIdStr:u};this.seenCache.put(u),(r.data?.length??0)>=this.opts.idontwantMinDataSize&&this.sendIDontWants(l,r.topic,e.toString());const c=this.topicValidators.get(r.topic);if(c!=null){let d;try{d=await c(e,a)}catch(f){const g=f.code;g===oT&&(d=Cn.Ignore),g===iT?d=Cn.Reject:d=Cn.Ignore}if(d!==Cn.Accept)return{code:en.invalid,reason:lg(d),msgIdStr:u}}return{code:en.valid,messageId:h,msg:a}}getScore(e){return this.score.score(e)}sendSubscriptions(e,r,s){this.sendRpc(e,{subscriptions:r.map(i=>({topic:i,subscribe:s})),messages:[]})}async handleControlMessage(e,r){if(r===void 0)return;const s=r.ihave?.length>0?this.handleIHave(e,r.ihave):[],i=r.iwant?.length>0?this.handleIWant(e,r.iwant):[],o=r.graft?.length>0?await this.handleGraft(e,r.graft):[];if(r.prune?.length>0&&await this.handlePrune(e,r.prune),r.idontwant?.length>0&&this.handleIdontwant(e,r.idontwant),s.length===0&&i.length===0&&o.length===0)return;const a=this.sendRpc(e,Yn(i,{iwant:s,prune:o})),l=s[0]?.messageIDs;l!=null&&(a?this.gossipTracer.addPromise(e,l):this.metrics?.iwantPromiseUntracked.inc(1))}acceptFrom(e){if(this.direct.has(e))return!0;const r=Date.now(),s=this.acceptFromWhitelist.get(e);if(s!=null&&s.messagesAccepted<cT&&s.acceptUntil>=r)return s.messagesAccepted+=1,!0;const i=this.score.score(e);return i>=aT?this.acceptFromWhitelist.set(e,{messagesAccepted:0,acceptUntil:r+lT}):this.acceptFromWhitelist.delete(e),i>=this.opts.scoreThresholds.graylistThreshold}handleIHave(e,r){if(r.length===0)return[];const s=this.score.score(e);if(s<this.opts.scoreThresholds.gossipThreshold)return this.log("IHAVE: ignoring peer %s with score below threshold [ score = %d ]",e,s),this.metrics?.ihaveRcvIgnored.inc({reason:Fo.LowScore}),[];const i=(this.peerhave.get(e)??0)+1;if(this.peerhave.set(e,i),i>tT)return this.log("IHAVE: peer %s has advertised too many times (%d) within this heartbeat interval; ignoring",e,i),this.metrics?.ihaveRcvIgnored.inc({reason:Fo.MaxIhave}),[];const o=this.iasked.get(e)??0;if(o>=ai)return this.log("IHAVE: peer %s has already advertised too many messages (%d); ignoring",e,o),this.metrics?.ihaveRcvIgnored.inc({reason:Fo.MaxIasked}),[];const a=new Map;if(r.forEach(({topicID:h,messageIDs:c})=>{if(h==null||c==null||!this.mesh.has(h))return;let d=0;c.forEach(f=>{const g=this.msgIdToStrFn(f);this.seenCache.has(g)||(a.set(g,f),d++)}),this.metrics?.onIhaveRcv(h,c.length,d)}),a.size===0)return[];let l=a.size;l+o>ai&&(l=ai-o),this.log("IHAVE: Asking for %d out of %d messages from %s",l,a.size,e);let u=Array.from(a.values());return fr(u),u=u.slice(0,l),this.iasked.set(e,o+l),[{messageIDs:u}]}handleIWant(e,r){if(r.length===0)return[];const s=this.score.score(e);if(s<this.opts.scoreThresholds.gossipThreshold)return this.log("IWANT: ignoring peer %s with score below threshold [score = %d]",e,s),[];const i=new Map,o=new Map;let a=0;return r.forEach(({messageIDs:l})=>{l?.forEach(u=>{const h=this.msgIdToStrFn(u),c=this.mcache.getWithIWantCount(h,e);if(c==null){a++;return}if(o.set(c.msg.topic,1+(o.get(c.msg.topic)??0)),c.count>zk){this.log("IWANT: Peer %s has asked for message %s too many times: ignoring request",e,u);return}i.set(h,c.msg)})}),this.metrics?.onIwantRcv(o,a),i.size===0?(this.log("IWANT: Could not provide any wanted messages to %s",e),[]):(this.log("IWANT: Sending %d messages to %s",i.size,e),Array.from(i.values()))}async handleGraft(e,r){const s=[],i=this.score.score(e),o=Date.now();let a=this.opts.doPX;if(r.forEach(({topicID:u})=>{if(u==null)return;const h=this.mesh.get(u);if(h==null){a=!1;return}if(h.has(e))return;const c=this.backoff.get(u)?.get(e);if(this.direct.has(e))this.log("GRAFT: ignoring request from direct peer %s",e),s.push(u),a=!1;else if(typeof c=="number"&&o<c){this.log("GRAFT: ignoring backed off peer %s",e),this.score.addPenalty(e,1,Oo.GraftBackoff),a=!1;const d=c+this.opts.graftFloodThreshold-this.opts.pruneBackoff;o<d&&this.score.addPenalty(e,1,Oo.GraftBackoff),this.addBackoff(e,u),s.push(u)}else i<0?(this.log("GRAFT: ignoring peer %s with negative score: score=%d, topic=%s",e,i,u),s.push(u),a=!1,this.addBackoff(e,u)):h.size>=this.opts.Dhi&&!(this.outbound.get(e)??!1)?(s.push(u),this.addBackoff(e,u)):(this.log("GRAFT: Add mesh link from %s in %s",e,u),this.score.graft(e,u),h.add(e),this.metrics?.onAddToMesh(u,nn.Subscribed,1));this.safeDispatchEvent("gossipsub:graft",{detail:{peerId:e,topic:u,direction:"inbound"}})}),s.length===0)return[];const l=!1;return Promise.all(s.map(async u=>this.makePrune(e,u,a,l)))}async handlePrune(e,r){const s=this.score.score(e);for(const{topicID:i,backoff:o,peers:a}of r){if(i==null)continue;const l=this.mesh.get(i);if(l==null)return;this.log("PRUNE: Remove mesh link to %s in %s",e,i),this.score.prune(e,i),l.has(e)&&(l.delete(e),this.metrics?.onRemoveFromMesh(i,Jn.Prune,1)),typeof o=="number"&&o>0?this.doAddBackoff(e,i,o*1e3):this.addBackoff(e,i),a!=null&&a.length>0&&(s<this.opts.scoreThresholds.acceptPXThreshold?this.log("PRUNE: ignoring PX from peer %s with insufficient score [score = %d, topic = %s]",e,s,i):await this.pxConnect(a)),this.safeDispatchEvent("gossipsub:prune",{detail:{peerId:e,topic:i,direction:"inbound"}})}}handleIdontwant(e,r){let s=this.idontwantCounts.get(e)??0;if(s>=this.opts.idontwantMaxMessages)return;const i=s;let o=this.idontwants.get(e);o==null&&(o=new Map,this.idontwants.set(e,o));let a=0;e:for(const{messageIDs:u}of r)for(const h of u){if(s>=this.opts.idontwantMaxMessages)break e;s++;const c=this.msgIdToStrFn(h);o.set(c,this.heartbeatTicks),this.mcache.msgs.has(c)||a++}this.idontwantCounts.set(e,s);const l=s-i;this.metrics?.onIdontwantRcv(l,a)}addBackoff(e,r){this.doAddBackoff(e,r,this.opts.pruneBackoff)}doAddBackoff(e,r,s){let i=this.backoff.get(r);i==null&&(i=new Map,this.backoff.set(r,i));const o=Date.now()+s;(i.get(e)??0)<o&&i.set(e,o)}applyIwantPenalties(){this.gossipTracer.getBrokenPromises().forEach((e,r)=>{this.log("peer %s didn't follow up in %d IWANT requests; adding penalty",r,e),this.score.addPenalty(r,e,Oo.BrokenPromise)})}clearBackoff(){if(this.heartbeatTicks%Qk!==0)return;const e=Date.now();this.backoff.forEach((r,s)=>{r.forEach((i,o)=>{i+dT*this.opts.heartbeatInterval<e&&r.delete(o)}),r.size===0&&this.backoff.delete(s)})}async directConnect(){const e=[];this.direct.forEach(r=>{this.streamsOutbound.has(r)||e.push(r)}),await Promise.all(e.map(async r=>this.connect(r)))}async pxConnect(e){e.length>this.opts.prunePeers&&(fr(e),e=e.slice(0,this.opts.prunePeers));const r=[];await Promise.all(e.map(async s=>{if(s.peerID==null)return;const i=Qs($r(s.peerID)),o=i.toString();if(!this.peers.has(o)){if(s.signedPeerRecord==null){r.push(o);return}try{if(!await this.components.peerStore.consumePeerRecord(s.signedPeerRecord,i)){this.log("bogus peer record obtained through px: could not add peer record to address book");return}r.push(o)}catch{this.log("bogus peer record obtained through px: invalid signature or not a peer record")}}})),r.length!==0&&await Promise.all(r.map(async s=>this.connect(s)))}async connect(e){this.log("Initiating connection with %s",e);const r=Bt(e),s=await this.components.connectionManager.openConnection(r);for(const i of this.multicodecs)for(const o of this.components.registrar.getTopologies(i))o.onConnect?.(r,s)}subscribe(e){if(this.status.code!==fn.started)throw new Error("Pubsub has not started");if(!this.subscriptions.has(e)){this.subscriptions.add(e);for(const r of this.peers.keys())this.sendSubscriptions(r,[e],!0)}this.join(e)}unsubscribe(e){if(this.status.code!==fn.started)throw new Error("Pubsub is not started");const r=this.subscriptions.delete(e);if(this.log("unsubscribe from %s - am subscribed %s",e,r),r)for(const s of this.peers.keys())this.sendSubscriptions(s,[e],!1);this.leave(e)}join(e){if(this.status.code!==fn.started)throw new Error("Gossipsub has not started");if(this.mesh.has(e))return;this.log("JOIN %s",e),this.metrics?.onJoin(e);const r=new Set,s=this.backoff.get(e),i=this.fanout.get(e);if(i!=null&&(this.fanout.delete(e),this.fanoutLastpub.delete(e),i.forEach(o=>{!this.direct.has(o)&&this.score.score(o)>=0&&s?.has(o)!==!0&&r.add(o)}),this.metrics?.onAddToMesh(e,nn.Fanout,r.size)),r.size<this.opts.D){const o=r.size;this.getRandomGossipPeers(e,this.opts.D,l=>!r.has(l)&&!this.direct.has(l)&&this.score.score(l)>=0&&s?.has(l)!==!0).forEach(l=>{r.add(l)}),this.metrics?.onAddToMesh(e,nn.Random,r.size-o)}this.mesh.set(e,r),r.forEach(o=>{this.log("JOIN: Add mesh link to %s in %s",o,e),this.sendGraft(o,e)})}leave(e){if(this.status.code!==fn.started)throw new Error("Gossipsub has not started");this.log("LEAVE %s",e),this.metrics?.onLeave(e);const r=this.mesh.get(e);r!=null&&(Promise.all(Array.from(r).map(async s=>{this.log("LEAVE: Remove mesh link to %s in %s",s,e),await this.sendPrune(s,e)})).catch(s=>{this.log("Error sending prunes to mesh peers",s)}),this.mesh.delete(e))}selectPeersToForward(e,r,s){const i=new Set,o=this.topics.get(e);o!=null&&(this.direct.forEach(l=>{o.has(l)&&r!==l&&!(s?.has(l)??!1)&&i.add(l)}),this.floodsubPeers.forEach(l=>{o.has(l)&&r!==l&&!(s?.has(l)??!1)&&this.score.score(l)>=this.opts.scoreThresholds.publishThreshold&&i.add(l)}));const a=this.mesh.get(e);return a!=null&&a.size>0&&a.forEach(l=>{r!==l&&!(s?.has(l)??!1)&&i.add(l)}),i}selectPeersToPublish(e){const r=new Set,s={direct:0,floodsub:0,mesh:0,fanout:0},i=this.topics.get(e);if(i!=null)if(this.opts.floodPublish)i.forEach(o=>{this.direct.has(o)?(r.add(o),s.direct++):this.score.score(o)>=this.opts.scoreThresholds.publishThreshold&&(r.add(o),s.floodsub++)});else{this.direct.forEach(a=>{i.has(a)&&(r.add(a),s.direct++)}),this.floodsubPeers.forEach(a=>{i.has(a)&&this.score.score(a)>=this.opts.scoreThresholds.publishThreshold&&(r.add(a),s.floodsub++)});const o=this.mesh.get(e);if(o!=null&&o.size>0)o.forEach(a=>{r.add(a),s.mesh++}),o.size<this.opts.D&&this.getRandomGossipPeers(e,this.opts.D-o.size,l=>!o.has(l)&&!this.direct.has(l)&&!this.floodsubPeers.has(l)&&this.score.score(l)>=this.opts.scoreThresholds.publishThreshold).forEach(l=>{r.add(l),s.mesh++});else{const a=this.fanout.get(e);if(a!=null&&a.size>0)a.forEach(l=>{r.add(l),s.fanout++});else{const l=this.getRandomGossipPeers(e,this.opts.D,u=>this.score.score(u)>=this.opts.scoreThresholds.publishThreshold);l.size>0&&(this.fanout.set(e,l),l.forEach(u=>{r.add(u),s.fanout++}))}this.fanoutLastpub.set(e,Date.now())}}return{tosend:r,tosendCount:s}}forwardMessage(e,r,s,i){s!=null&&this.score.deliverMessage(s,e,r.topic);const o=this.selectPeersToForward(r.topic,s,i);o.forEach(a=>{this.sendRpc(a,Yn([r]))}),this.metrics?.onForwardMsg(r.topic,o.size)}async publish(e,r,s){const i=Date.now(),o=this.dataTransform!=null?this.dataTransform.outboundTransform(e,r):r;if(this.publishConfig==null)throw Error("PublishError.Uninitialized");const{raw:a,msg:l}=await VT(this.publishConfig,e,r,o),u=await this.msgIdFn(l),h=this.msgIdToStrFn(u),c=s?.ignoreDuplicatePublishError??this.opts.ignoreDuplicatePublishError;if(this.seenCache.has(h)){if(c)return this.metrics?.onPublishDuplicateMsg(e),{recipients:[]};throw Error("PublishError.Duplicate")}const{tosend:d,tosendCount:f}=this.selectPeersToPublish(e),g=this.opts.emitSelf&&this.subscriptions.has(e),y=s?.allowPublishToZeroTopicPeers??this.opts.allowPublishToZeroTopicPeers;if(d.size===0&&!y&&!g)throw Error("PublishError.NoPeersSubscribedToTopic");this.seenCache.put(h),this.mcache.put({msgId:u,msgIdStr:h},a,!0),this.publishedMessageIds.put(h);const m=s?.batchPublish??this.opts.batchPublish,v=Yn([a]);if(m)this.sendRpcInBatch(d,v);else for(const w of d)this.sendRpc(w,v)||d.delete(w);const _=Date.now()-i;return this.metrics?.onPublishMsg(e,f,d.size,a.data!=null?a.data.length:0,_),g&&(d.add(this.components.peerId.toString()),super.dispatchEvent(new CustomEvent("gossipsub:message",{detail:{propagationSource:this.components.peerId,msgId:h,msg:l}})),super.dispatchEvent(new CustomEvent("message",{detail:l}))),{recipients:Array.from(d.values()).map(w=>Bt(w))}}sendRpcInBatch(e,r){const s=Cs.encode(r),i=Tf.single(s);for(const o of e){const a=this.streamsOutbound.get(o);if(a==null){this.log(`Cannot send RPC to ${o} as there is no open stream to it available`),e.delete(o);continue}try{a.pushPrefixed(i)}catch(l){e.delete(o),this.log.error(`Cannot send rpc to ${o}`,l)}this.metrics?.onRpcSent(r,s.length)}}reportMessageValidationResult(e,r,s){let i;if(s===Cn.Accept){if(i=this.mcache.validate(e),i!=null){const{message:a,originatingPeers:l}=i;this.score.deliverMessage(r,e,a.topic),this.forwardMessage(e,i.message,r,l)}}else if(i=this.mcache.remove(e),i!=null){const a=lg(s),{message:l,originatingPeers:u}=i;this.score.rejectMessage(r,e,l.topic,a);for(const h of u)this.score.rejectMessage(h,e,l.topic,a)}const o=this.score.messageFirstSeenTimestampMs(e);this.metrics?.onReportValidation(i,s,o)}sendGraft(e,r){const i=Yn([],{graft:[{topicID:r}]});this.sendRpc(e,i)}async sendPrune(e,r){const i=[await this.makePrune(e,r,this.opts.doPX,!0)],o=Yn([],{prune:i});this.sendRpc(e,o)}sendIDontWants(e,r,s){const i=this.mesh.get(r);if(i==null)return;const o=new Set(i);o.delete(s);for(const l of o)this.streamsOutbound.get(l)?.protocol!==Su&&o.delete(l);const a=Yn([],{idontwant:[{messageIDs:[e]}]});this.sendRpcInBatch(o,a)}sendRpc(e,r){const s=this.streamsOutbound.get(e);if(s==null)return this.log(`Cannot send RPC to ${e} as there is no open stream to it available`),!1;const i=this.control.get(e);i!=null&&(this.piggybackControl(e,r,i),this.control.delete(e));const o=this.gossip.get(e);o!=null&&(this.piggybackGossip(e,r,o),this.gossip.delete(e));const a=Cs.encode(r);try{s.push(a)}catch(l){return this.log.error(`Cannot send rpc to ${e}`,l),i!=null&&this.control.set(e,i),o!=null&&this.gossip.set(e,o),!1}if(this.metrics?.onRpcSent(r,a.length),r.control?.graft!=null)for(const l of r.control?.graft)l.topicID!=null&&this.safeDispatchEvent("gossipsub:graft",{detail:{peerId:e,topic:l.topicID,direction:"outbound"}});if(r.control?.prune!=null)for(const l of r.control?.prune)l.topicID!=null&&this.safeDispatchEvent("gossipsub:prune",{detail:{peerId:e,topic:l.topicID,direction:"outbound"}});return!0}piggybackControl(e,r,s){const i=pg(r);for(const o of s.graft)o.topicID!=null&&(this.mesh.get(o.topicID)?.has(e)??!1)&&i.control.graft.push(o);for(const o of s.prune)o.topicID!=null&&!(this.mesh.get(o.topicID)?.has(e)??!1)&&i.control.prune.push(o)}piggybackGossip(e,r,s){const i=pg(r);i.control.ihave=s}async sendGraftPrune(e,r,s){const i=this.opts.doPX,o=!1;for(const[a,l]of e){const u=l.map(d=>({topicID:d}));let h=[];const c=r.get(a);c!=null&&(h=await Promise.all(c.map(async d=>this.makePrune(a,d,i&&!(s.get(a)??!1),o))),r.delete(a)),this.sendRpc(a,Yn([],{graft:u,prune:h}))}for(const[a,l]of r){const u=await Promise.all(l.map(async h=>this.makePrune(a,h,i&&!(s.get(a)??!1),o)));this.sendRpc(a,Yn([],{prune:u}))}}emitGossip(e){const r=this.mcache.getGossipIDs(new Set(e.keys()));for(const[s,i]of e)this.doEmitGossip(s,i,r.get(s)??[])}doEmitGossip(e,r,s){if(s.length===0||(fr(s),s.length>ai&&this.log("too many messages for gossip; will truncate IHAVE list (%d messages)",s.length),r.size===0))return;let i=this.opts.Dlazy;const a=this.opts.gossipFactor*r.size;let l=r;a>i&&(i=a),i>l.size?i=l.size:l=fr(Array.from(l)).slice(0,i),l.forEach(u=>{let h=s;s.length>ai&&(h=fr(h.slice()).slice(0,ai)),this.pushGossip(u,{topicID:e,messageIDs:h})})}flush(){for(const[e,r]of this.gossip.entries())this.gossip.delete(e),this.sendRpc(e,Yn([],{ihave:r}));for(const[e,r]of this.control.entries()){this.control.delete(e);const s=Yn([],{graft:r.graft,prune:r.prune});this.sendRpc(e,s)}}pushGossip(e,r){this.log("Add gossip to %s",e);const s=this.gossip.get(e)??[];this.gossip.set(e,s.concat(r))}async makePrune(e,r,s,i){if(this.score.prune(e,r),this.streamsOutbound.get(e)?.protocol===og)return{topicID:r,peers:[]};const o=i?this.opts.unsubcribeBackoff:this.opts.pruneBackoff,a=o/1e3;if(this.doAddBackoff(e,r,o),!s)return{topicID:r,peers:[],backoff:a};const l=this.getRandomGossipPeers(r,this.opts.prunePeers,h=>h!==e&&this.score.score(h)>=0),u=await Promise.all(Array.from(l).map(async h=>{const c=Bt(h);let d;try{d=await this.components.peerStore.get(c)}catch(f){if(f.name!=="NotFoundError")throw f}return{peerID:c.toMultihash().bytes,signedPeerRecord:d?.peerRecordEnvelope}}));return{topicID:r,peers:u,backoff:a}}async heartbeat(){const{D:e,Dlo:r,Dhi:s,Dscore:i,Dout:o,fanoutTTL:a}=this.opts;this.heartbeatTicks++;const l=new Map,u=y=>{let m=l.get(y);return m===void 0&&(m=this.score.score(y),l.set(y,m)),m},h=new Map,c=new Map,d=new Map;this.clearBackoff(),this.peerhave.clear(),this.metrics?.cacheSize.set({cache:"iasked"},this.iasked.size),this.iasked.clear(),this.applyIwantPenalties(),this.idontwantCounts.clear();for(const y of this.idontwants.values())for(const[m,v]of y)this.heartbeatTicks-v>=this.opts.mcacheLength&&y.delete(m);this.heartbeatTicks%this.opts.directConnectTicks===0&&await this.directConnect(),this.fastMsgIdCache?.prune(),this.seenCache.prune(),this.gossipTracer.prune(),this.publishedMessageIds.prune();const f=new Map;this.mesh.forEach((y,m)=>{const v=this.topics.get(m),_=new Set,w=new Set;if(f.set(m,w),v!=null){const A=fr(Array.from(v)),I=this.backoff.get(m);for(const T of A){const x=this.streamsOutbound.get(T);if(x!=null&&this.multicodecs.includes(x.protocol)&&!y.has(T)&&!this.direct.has(T)){const V=u(T);I?.has(T)!==!0&&V>=0&&_.add(T),V>=this.opts.scoreThresholds.gossipThreshold&&w.add(T)}}}const S=(A,I)=>{this.log("HEARTBEAT: Remove mesh link to %s in %s",A,m),this.addBackoff(A,m),y.delete(A),u(A)>=this.opts.scoreThresholds.gossipThreshold&&w.add(A),this.metrics?.onRemoveFromMesh(m,I,1);const T=c.get(A);T==null?c.set(A,[m]):T.push(m)},E=(A,I)=>{this.log("HEARTBEAT: Add mesh link to %s in %s",A,m),this.score.graft(A,m),y.add(A),w.delete(A),this.metrics?.onAddToMesh(m,I,1);const T=h.get(A);T==null?h.set(A,[m]):T.push(m)};if(y.forEach(A=>{const I=u(A);I<0&&(this.log("HEARTBEAT: Prune peer %s with negative score: score=%d, topic=%s",A,I,m),S(A,Jn.BadScore),d.set(A,!0))}),y.size<r){const A=e-y.size;xT(_,A).forEach(T=>{E(T,nn.NotEnough)})}if(y.size>s){let A=Array.from(y);A.sort((T,x)=>u(x)-u(T)),A=A.slice(0,i).concat(fr(A.slice(i)));let I=0;if(A.slice(0,e).forEach(T=>{(this.outbound.get(T)??!1)&&I++}),I<o){const T=V=>{const L=A[V];for(let N=V;N>0;N--)A[N]=A[N-1];A[0]=L};if(I>0){let V=I;for(let L=1;L<e&&V>0;L++)(this.outbound.get(A[L])??!1)&&(T(L),V--)}let x=e-I;for(let V=e;V<A.length&&x>0;V++)(this.outbound.get(A[V])??!1)&&(T(V),x--)}A.slice(e).forEach(T=>{S(T,Jn.Excess)})}if(y.size>=r){let A=0;if(y.forEach(I=>{(this.outbound.get(I)??!1)&&A++}),A<o){const I=o-A;zd(_,I,x=>this.outbound.get(x)===!0).forEach(x=>{E(x,nn.Outbound)})}}if(this.heartbeatTicks%this.opts.opportunisticGraftTicks===0&&y.size>1){const A=Array.from(y).sort((x,V)=>u(x)-u(V)),I=Math.floor(y.size/2),T=u(A[I]);if(T<this.opts.scoreThresholds.opportunisticGraftThreshold){const x=this.opts.opportunisticGraftPeers,V=zd(_,x,L=>u(L)>T);for(const L of V)this.log("HEARTBEAT: Opportunistically graft peer %s on topic %s",L,m),E(L,nn.Opportunistic)}}});const g=Date.now();this.fanoutLastpub.forEach((y,m)=>{y+a<g&&(this.fanout.delete(m),this.fanoutLastpub.delete(m))}),this.fanout.forEach((y,m)=>{const v=this.topics.get(m);y.forEach(E=>{(!(v?.has(E)??!1)||u(E)<this.opts.scoreThresholds.publishThreshold)&&y.delete(E)});const _=this.topics.get(m),w=[],S=new Set;if(f.set(m,S),_!=null){const E=fr(Array.from(_));for(const A of E){const I=this.streamsOutbound.get(A);if(I!=null&&this.multicodecs.includes(I.protocol)&&!y.has(A)&&!this.direct.has(A)){const T=u(A);T>=this.opts.scoreThresholds.publishThreshold&&w.push(A),T>=this.opts.scoreThresholds.gossipThreshold&&S.add(A)}}}if(y.size<e){const E=e-y.size;w.slice(0,E).forEach(A=>{y.add(A),S?.delete(A)})}}),this.emitGossip(f),await this.sendGraftPrune(h,c,d),this.flush(),this.mcache.shift(),this.dispatchEvent(new CustomEvent("gossipsub:heartbeat"))}getRandomGossipPeers(e,r,s=()=>!0){const i=this.topics.get(e);if(i==null)return new Set;let o=[];return i.forEach(a=>{const l=this.streamsOutbound.get(a);l!=null&&this.multicodecs.includes(l.protocol)&&s(a)&&o.push(a)}),o=fr(o),r>0&&o.length>r&&(o=o.slice(0,r)),new Set(o)}onScrapeMetrics(e){e.mcacheSize.set(this.mcache.size),e.mcacheNotValidatedCount.set(this.mcache.notValidatedCount),e.cacheSize.set({cache:"direct"},this.direct.size),e.cacheSize.set({cache:"seenCache"},this.seenCache.size),e.cacheSize.set({cache:"fastMsgIdCache"},this.fastMsgIdCache?.size??0),e.cacheSize.set({cache:"publishedMessageIds"},this.publishedMessageIds.size),e.cacheSize.set({cache:"mcache"},this.mcache.size),e.cacheSize.set({cache:"score"},this.score.size),e.cacheSize.set({cache:"gossipTracer.promises"},this.gossipTracer.size),e.cacheSize.set({cache:"gossipTracer.requests"},this.gossipTracer.requestMsByMsgSize),e.cacheSize.set({cache:"topics"},this.topics.size),e.cacheSize.set({cache:"subscriptions"},this.subscriptions.size),e.cacheSize.set({cache:"mesh"},this.mesh.size),e.cacheSize.set({cache:"fanout"},this.fanout.size),e.cacheSize.set({cache:"peers"},this.peers.size),e.cacheSize.set({cache:"streamsOutbound"},this.streamsOutbound.size),e.cacheSize.set({cache:"streamsInbound"},this.streamsInbound.size),e.cacheSize.set({cache:"acceptFromWhitelist"},this.acceptFromWhitelist.size),e.cacheSize.set({cache:"gossip"},this.gossip.size),e.cacheSize.set({cache:"control"},this.control.size),e.cacheSize.set({cache:"peerhave"},this.peerhave.size),e.cacheSize.set({cache:"outbound"},this.outbound.size);let r=0;const s=Date.now();e.connectedPeersBackoffSec.reset();for(const u of this.backoff.values()){r+=u.size;for(const[h,c]of u.entries())this.peers.has(h)&&e.connectedPeersBackoffSec.observe(Math.max(0,c-s)/1e3)}e.cacheSize.set({cache:"backoff"},r);let i=0;for(const u of this.idontwants.values())i+=u.size;e.cacheSize.set({cache:"idontwants"},i);for(const[u,h]of this.topics)e.topicPeersCount.set({topicStr:u},h.size);for(const[u,h]of this.mesh)e.meshPeerCounts.set({topicStr:u},h.size);const o=[],a=new Map;e.behaviourPenalty.reset();for(const u of this.peers.keys()){const h=this.score.score(u);o.push(h),a.set(u,h),e.behaviourPenalty.observe(this.score.peerStats.get(u)?.behaviourPenalty??0)}e.registerScores(o,this.opts.scoreThresholds),e.registerScorePerMesh(this.mesh,a);const l=BT(this.peers.keys(),this.score.peerStats,this.score.params,this.score.peerIPs,e.topicStrToLabel);e.registerScoreWeights(l)}}p(vw,"multicodec",Su);function SC(n={}){return t=>new vw(t,n)}function bw(n){if(n!=null){if(typeof n[Symbol.iterator]=="function")return n[Symbol.iterator]();if(typeof n[Symbol.asyncIterator]=="function")return n[Symbol.asyncIterator]();if(typeof n.next=="function")return n}throw new Error("argument is not an iterator or iterable")}class ws extends Error{constructor(t="The frame was invalid"){super(t),this.name="InvalidFrameError"}}p(ws,"name","InvalidFrameError");class Bf extends Error{constructor(t="Unrequested ping error"){super(t),this.name="UnrequestedPingError"}}p(Bf,"name","UnrequestedPingError");class Nf extends Error{constructor(t="Unrequested ping error"){super(t),this.name="NotMatchingPingError"}}p(Nf,"name","NotMatchingPingError");class ww extends Error{constructor(t="Invalid state"){super(t),this.name="InvalidStateError"}}p(ww,"name","InvalidStateError");class _w extends Error{constructor(t="Strean already exists"){super(t),this.name="StreamAlreadyExistsError"}}p(_w,"name","StreamAlreadyExistsError");class Sw extends Error{constructor(t="Decode invalid version"){super(t),this.name="DecodeInvalidVersionError"}}p(Sw,"name","DecodeInvalidVersionError");class Ew extends Error{constructor(t="Both clients"){super(t),this.name="BothClientsError"}}p(Ew,"name","BothClientsError");class Rf extends Error{constructor(t="Receive window exceeded"){super(t),this.name="ReceiveWindowExceededError"}}p(Rf,"name","ReceiveWindowExceededError");const EC=new Set([ws.name,Bf.name,Nf.name,_w.name,Sw.name,Ew.name,Rf.name]),Of=256*1024,AC=16*1024*1024,xC={enableKeepAlive:!0,keepAliveInterval:3e4,maxInboundStreams:1e3,maxOutboundStreams:1e3,initialStreamWindowSize:Of,maxStreamWindowSize:AC,maxMessageSize:64*1024};function IC(n){if(n.keepAliveInterval<=0)throw new X("keep-alive interval must be positive");if(n.maxInboundStreams<0)throw new X("max inbound streams must be larger or equal 0");if(n.maxOutboundStreams<0)throw new X("max outbound streams must be larger or equal 0");if(n.initialStreamWindowSize<Of)throw new X("InitialStreamWindowSize must be larger or equal 256 kB");if(n.maxStreamWindowSize<n.initialStreamWindowSize)throw new X("MaxStreamWindowSize must be larger than the InitialStreamWindowSize");if(n.maxStreamWindowSize>2**32-1)throw new X("MaxStreamWindowSize must be less than equal MAX_UINT32");if(n.maxMessageSize<1024)throw new X("MaxMessageSize must be greater than a kilobyte")}var pt;(function(n){n[n.Data=0]="Data",n[n.WindowUpdate=1]="WindowUpdate",n[n.Ping=2]="Ping",n[n.GoAway=3]="GoAway"})(pt||(pt={}));var tt;(function(n){n[n.SYN=1]="SYN",n[n.ACK=2]="ACK",n[n.FIN=4]="FIN",n[n.RST=8]="RST"})(tt||(tt={}));Object.values(tt).filter(n=>typeof n!="string");const kC=0;var Zn;(function(n){n[n.NormalTermination=0]="NormalTermination",n[n.ProtocolError=1]="ProtocolError",n[n.InternalError=2]="InternalError"})(Zn||(Zn={}));const $o=12,bg=2**24;function TC(n){if(n[0]!==kC)throw new ws("Invalid frame version");return{type:n[1],flag:(n[2]<<8)+n[3],streamID:n[4]*bg+(n[5]<<16)+(n[6]<<8)+n[7],length:n[8]*bg+(n[9]<<16)+(n[10]<<8)+n[11]}}class CC{constructor(t){p(this,"source");p(this,"buffer");p(this,"frameInProgress");this.source=PC(t),this.buffer=new We,this.frameInProgress=!1}async*emitFrames(){for await(const t of this.source)for(this.buffer.append(t);;){const e=this.readHeader();if(e===void 0)break;const{type:r,length:s}=e;r===pt.Data?(this.frameInProgress=!0,yield{header:e,readData:this.readBytes.bind(this,s)}):yield{header:e}}}readHeader(){if(this.frameInProgress)throw new ww("decoding frame already in progress");if(this.buffer.length<$o)return;const t=TC(this.buffer.subarray(0,$o));return this.buffer.consume($o),t}async readBytes(t){if(this.buffer.length<t){for await(const r of this.source)if(this.buffer.append(r),this.buffer.length>=t)break}const e=this.buffer.sublist(0,t);return this.buffer.consume(t),this.frameInProgress=!1,e}}function PC(n){if(n[Symbol.iterator]!==void 0){const t=n[Symbol.iterator]();return t.return=void 0,{[Symbol.iterator](){return t}}}else if(n[Symbol.asyncIterator]!==void 0){const t=n[Symbol.asyncIterator]();return t.return=void 0,{[Symbol.asyncIterator](){return t}}}else throw new Error("a source must be either an iterable or an async iterable")}function wg(n){const t=new Uint8Array($o);return t[1]=n.type,t[2]=n.flag>>>8,t[3]=n.flag,t[4]=n.streamID>>>24,t[5]=n.streamID>>>16,t[6]=n.streamID>>>8,t[7]=n.streamID,t[8]=n.length>>>24,t[9]=n.length>>>16,t[10]=n.length>>>8,t[11]=n.length,t}let _g=class extends Error{constructor(e,r,s){super(e??"The operation was aborted");p(this,"type");p(this,"code");this.type="aborted",this.name=s??"AbortError",this.code=r??"ABORT_ERR"}};async function Ir(n,t,e){if(t==null)return n;if(t.aborted){const i=Promise.reject(new _g(e?.errorMessage,e?.errorCode,e?.errorName));return Promise.race([i,Promise.resolve().then(async()=>{try{await n}catch{}return i})])}let r;const s=new _g(e?.errorMessage,e?.errorCode,e?.errorName);try{return await Promise.race([n,new Promise((i,o)=>{r=()=>{o(s)},t.addEventListener("abort",r)})])}finally{r!=null&&t.removeEventListener("abort",r)}}function DC(n){return n==null?!1:typeof n.then=="function"&&typeof n.catch=="function"&&typeof n.finally=="function"}function MC(n,t){const e=bw(n).return?.();DC(e)&&e.catch(r=>{t.error("could not cause iterator to return",r)})}const LC=5e3;function Tu(n){return n==null?!1:typeof n.then=="function"&&typeof n.catch=="function"&&typeof n.finally=="function"}class BC{constructor(t){p(this,"id");p(this,"direction");p(this,"timeline");p(this,"protocol");p(this,"metadata");p(this,"source");p(this,"status");p(this,"readStatus");p(this,"writeStatus");p(this,"log");p(this,"sinkController");p(this,"sinkEnd");p(this,"closed");p(this,"endErr");p(this,"streamSource");p(this,"onEnd");p(this,"onCloseRead");p(this,"onCloseWrite");p(this,"onReset");p(this,"onAbort");p(this,"sendCloseWriteTimeout");p(this,"sendingData");this.sinkController=new AbortController,this.sinkEnd=bt(),this.closed=bt(),this.log=t.log,this.status="open",this.readStatus="ready",this.writeStatus="ready",this.id=t.id,this.metadata=t.metadata??{},this.direction=t.direction,this.timeline={open:Date.now()},this.sendCloseWriteTimeout=t.sendCloseWriteTimeout??LC,this.onEnd=t.onEnd,this.onCloseRead=t?.onCloseRead,this.onCloseWrite=t?.onCloseWrite,this.onReset=t?.onReset,this.onAbort=t?.onAbort,this.source=this.streamSource=us({onEnd:e=>{e!=null?this.log.trace("source ended with error",e):this.log.trace("source ended"),this.onSourceEnd(e)}}),this.sink=this.sink.bind(this)}async sink(t){if(this.writeStatus!=="ready")throw new ob(`writable end state is "${this.writeStatus}" not "ready"`);try{this.writeStatus="writing";const e={signal:this.sinkController.signal};if(this.direction==="outbound"){const s=this.sendNewStream(e);Tu(s)&&await s}const r=()=>{MC(t,this.log)};try{this.sinkController.signal.addEventListener("abort",r),this.log.trace("sink reading from source");for await(let s of t){s=s instanceof Uint8Array?new We(s):s;const i=this.sendData(s,e);Tu(i)&&(this.sendingData=bt(),await i,this.sendingData.resolve(),this.sendingData=void 0)}}finally{this.sinkController.signal.removeEventListener("abort",r)}this.log.trace('sink finished reading from source, write status is "%s"',this.writeStatus),this.writeStatus==="writing"&&(this.writeStatus="closing",this.log.trace("send close write to remote"),await this.sendCloseWrite({signal:AbortSignal.timeout(this.sendCloseWriteTimeout)}),this.writeStatus="closed"),this.onSinkEnd()}catch(e){throw this.log.trace("sink ended with error, calling abort with error",e),this.abort(e),e}finally{this.log.trace("resolve sink end"),this.sinkEnd.resolve()}}onSourceEnd(t){this.timeline.closeRead==null&&(this.timeline.closeRead=Date.now(),this.readStatus="closed",t!=null&&this.endErr==null&&(this.endErr=t),this.onCloseRead?.(),this.timeline.closeWrite!=null?(this.log.trace("source and sink ended"),this.timeline.close=Date.now(),this.status!=="aborted"&&this.status!=="reset"&&(this.status="closed"),this.onEnd!=null&&this.onEnd(this.endErr),this.closed.resolve()):this.log.trace("source ended, waiting for sink to end"))}onSinkEnd(t){this.timeline.closeWrite==null&&(this.timeline.closeWrite=Date.now(),this.writeStatus="closed",t!=null&&this.endErr==null&&(this.endErr=t),this.onCloseWrite?.(),this.timeline.closeRead!=null?(this.log.trace("sink and source ended"),this.timeline.close=Date.now(),this.status!=="aborted"&&this.status!=="reset"&&(this.status="closed"),this.onEnd!=null&&this.onEnd(this.endErr),this.closed.resolve()):this.log.trace("sink ended, waiting for source to end"))}async close(t){this.status==="open"&&(this.log.trace("closing gracefully"),this.status="closing",await Ir(Promise.all([this.closeWrite(t),this.closeRead(t),this.closed.promise]),t?.signal),this.status="closed",this.log.trace("closed gracefully"))}async closeRead(t={}){if(this.readStatus==="closing"||this.readStatus==="closed")return;this.log.trace('closing readable end of stream with starting read status "%s"',this.readStatus);const e=this.readStatus;this.readStatus="closing",this.status!=="reset"&&this.status!=="aborted"&&this.timeline.closeRead==null&&(this.log.trace("send close read to remote"),await this.sendCloseRead(t)),e==="ready"&&(this.log.trace("ending internal source queue with %d queued bytes",this.streamSource.readableLength),this.streamSource.end()),this.log.trace("closed readable end of stream")}async closeWrite(t={}){this.writeStatus==="closing"||this.writeStatus==="closed"||(this.log.trace('closing writable end of stream with starting write status "%s"',this.writeStatus),this.writeStatus==="ready"&&(this.log.trace("sink was never sunk, sink an empty array"),await Ir(this.sink([]),t.signal)),this.writeStatus==="writing"&&(this.sendingData!=null&&await Ir(this.sendingData.promise,t.signal),this.log.trace("aborting source passed to .sink"),this.sinkController.abort(),await Ir(this.sinkEnd.promise,t.signal)),this.writeStatus="closed",this.log.trace("closed writable end of stream"))}abort(t){if(this.status==="closed"||this.status==="aborted"||this.status==="reset")return;this.log("abort with error",t),this.log("try to send reset to remote");const e=this.sendReset();Tu(e)&&e.catch(r=>{this.log.error("error sending reset message",r)}),this.status="aborted",this.timeline.abort=Date.now(),this._closeSinkAndSource(t),this.onAbort?.(t)}reset(){if(this.status==="closed"||this.status==="aborted"||this.status==="reset")return;const t=new ib("stream reset");this.status="reset",this.timeline.reset=Date.now(),this._closeSinkAndSource(t),this.onReset?.()}_closeSinkAndSource(t){this._closeSink(t),this._closeSource(t)}_closeSink(t){this.writeStatus==="writing"&&(this.log.trace("end sink source"),this.sinkController.abort()),this.onSinkEnd(t)}_closeSource(t){this.readStatus!=="closing"&&this.readStatus!=="closed"&&(this.log.trace("ending source with %d bytes to be read by consumer",this.streamSource.readableLength),this.readStatus="closing",this.streamSource.end(t))}remoteCloseWrite(){if(this.readStatus==="closing"||this.readStatus==="closed"){this.log("received remote close write but local source is already closed");return}this.log.trace("remote close write"),this._closeSource()}remoteCloseRead(){if(this.writeStatus==="closing"||this.writeStatus==="closed"){this.log("received remote close read but local sink is already closed");return}this.log.trace("remote close read"),this._closeSink()}destroy(){if(this.status==="closed"||this.status==="aborted"||this.status==="reset"){this.log("received destroy but we are already closed");return}this.log.trace("stream destroyed"),this._closeSinkAndSource()}sourcePush(t){this.streamSource.push(t)}sourceReadableLength(){return this.streamSource.readableLength}}function Aw(n){const[t,e]=n[Symbol.asyncIterator]!=null?[n[Symbol.asyncIterator](),Symbol.asyncIterator]:[n[Symbol.iterator](),Symbol.iterator],r=[];return{peek:()=>t.next(),push:s=>{r.push(s)},next:()=>r.length>0?{done:!1,value:r.shift()}:t.next(),[e](){return this}}}function NC(n){return n[Symbol.asyncIterator]!=null}function Sg(n){return n?.then!=null}function xw(n,t){let e=0;if(NC(n))return async function*(){for await(const l of n){const u=t(l,e++);Sg(u)&&await u,yield l}}();const r=Aw(n),{value:s,done:i}=r.next();if(i===!0)return function*(){}();if(typeof t(s,e++)?.then=="function")return async function*(){yield s;for await(const l of r){const u=t(l,e++);Sg(u)&&await u,yield l}}();const a=t;return function*(){yield s;for(const l of r)a(l,e++),yield l}()}var Fn;(function(n){n[n.Init=0]="Init",n[n.SYNSent=1]="SYNSent",n[n.SYNReceived=2]="SYNReceived",n[n.Established=3]="Established",n[n.Finished=4]="Finished"})(Fn||(Fn={}));class RC extends BC{constructor(e){super({...e,onEnd:r=>{this.state=Fn.Finished,e.onEnd?.(r)}});p(this,"name");p(this,"state");p(this,"config");p(this,"_id");p(this,"sendWindowCapacity");p(this,"sendWindowCapacityUpdate");p(this,"recvWindow");p(this,"recvWindowCapacity");p(this,"epochStart");p(this,"getRTT");p(this,"sendFrame");this.config=e.config,this._id=parseInt(e.id,10),this.name=e.name,this.state=e.state,this.sendWindowCapacity=Of,this.recvWindow=this.config.initialStreamWindowSize,this.recvWindowCapacity=this.recvWindow,this.epochStart=Date.now(),this.getRTT=e.getRTT,this.sendFrame=e.sendFrame,this.source=xw(this.source,()=>{this.sendWindowUpdate()})}async sendNewStream(){}async sendData(e,r={}){for(e=e.sublist();e.byteLength!==0;){if(this.sendWindowCapacity===0&&(this.log?.trace("wait for send window capacity, status %s",this.status),await this.waitForSendWindowCapacity(r),this.status==="closed"||this.status==="aborted"||this.status==="reset")){this.log?.trace("%s while waiting for send window capacity",this.status);return}const s=Math.min(this.sendWindowCapacity,this.config.maxMessageSize-$o,e.length),i=this.getSendFlags();this.sendFrame({type:pt.Data,flag:i,streamID:this._id,length:s},e.sublist(0,s)),this.sendWindowCapacity-=s,e.consume(s)}}async sendReset(){this.sendFrame({type:pt.WindowUpdate,flag:tt.RST,streamID:this._id,length:0})}async sendCloseWrite(){const e=this.getSendFlags()|tt.FIN;this.sendFrame({type:pt.WindowUpdate,flag:e,streamID:this._id,length:0})}async sendCloseRead(){}async waitForSendWindowCapacity(e={}){if(this.sendWindowCapacity>0)return;let r,s;const i=()=>{this.status==="open"||this.status==="closing"?s(new Ls("Stream aborted")):r()};e.signal?.addEventListener("abort",i);try{await new Promise((o,a)=>{this.sendWindowCapacityUpdate=()=>{o()},s=a,r=o})}finally{e.signal?.removeEventListener("abort",i)}}handleWindowUpdate(e){this.log?.trace("stream received window update id=%s",this._id),this.processFlags(e.flag);const r=this.sendWindowCapacity;this.sendWindowCapacity+=e.length,r===0&&e.length>0&&this.sendWindowCapacityUpdate?.()}async handleData(e,r){if(this.log?.trace("stream received data id=%s",this._id),this.processFlags(e.flag),this.recvWindowCapacity<e.length)throw new Rf("Receive window exceeded");const s=await r();this.recvWindowCapacity-=e.length,this.sourcePush(s)}processFlags(e){(e&tt.ACK)===tt.ACK&&this.state===Fn.SYNSent&&(this.state=Fn.Established),(e&tt.FIN)===tt.FIN&&this.remoteCloseWrite(),(e&tt.RST)===tt.RST&&this.reset()}getSendFlags(){switch(this.state){case Fn.Init:return this.state=Fn.SYNSent,tt.SYN;case Fn.SYNReceived:return this.state=Fn.Established,tt.ACK;default:return 0}}sendWindowUpdate(){const e=this.getSendFlags(),r=Date.now(),s=this.getRTT();if(e===0&&s>-1&&r-this.epochStart<s*4&&(this.recvWindow=Math.min(this.recvWindow*2,this.config.maxStreamWindowSize)),this.recvWindowCapacity>=this.recvWindow&&e===0)return;const i=this.recvWindow-this.recvWindowCapacity;this.recvWindowCapacity=this.recvWindow,this.epochStart=r,this.sendFrame({type:pt.WindowUpdate,flag:e,streamID:this._id,length:i})}}const Iw="/yamux/1.0.0",OC=500;var iy,oy;oy=Symbol.toStringTag,iy=Wn;class FC{constructor(t,e={}){p(this,"protocol",Iw);p(this,"_components");p(this,"_init");p(this,oy,"@chainsafe/libp2p-yamux");p(this,iy,["@libp2p/stream-multiplexing"]);this._components=t,this._init=e}createStreamMuxer(t){return new $C(this._components,{...this._init,...t})}}class $C{constructor(t,e){p(this,"protocol",Iw);p(this,"source");p(this,"sink");p(this,"config");p(this,"log");p(this,"logger");p(this,"closeController");p(this,"nextStreamID");p(this,"_streams");p(this,"nextPingID");p(this,"activePing");p(this,"rtt");p(this,"client");p(this,"localGoAway");p(this,"remoteGoAway");p(this,"numInboundStreams");p(this,"numOutboundStreams");p(this,"onIncomingStream");p(this,"onStreamEnd");this.client=e.direction==="outbound",this.config={...xC,...e},this.logger=t.logger,this.log=this.logger.forComponent("libp2p:yamux"),IC(this.config),this.closeController=new AbortController,this.closeController.signal,this.onIncomingStream=e.onIncomingStream,this.onStreamEnd=e.onStreamEnd,this._streams=new Map,this.source=us({onEnd:()=>{this.log?.trace("muxer source ended"),this._streams.forEach(r=>{r.destroy()})}}),this.sink=async r=>{const s=()=>{const a=bw(r);if(a.return!=null){const l=a.return();UC(l)&&l.catch(u=>{this.log?.("could not cause sink source to return",u)})}};let i,o;try{const a=new CC(r);try{this.closeController.signal.addEventListener("abort",s);for await(const l of a.emitFrames())await this.handleFrame(l.header,l.readData)}finally{this.closeController.signal.removeEventListener("abort",s)}i=Zn.NormalTermination}catch(a){EC.has(a.name)?(this.log?.error("protocol error in sink",a),i=Zn.ProtocolError):(this.log?.error("internal error in sink",a),i=Zn.InternalError),o=a}this.log?.trace("muxer sink ended"),o!=null?this.abort(o,i):await this.close({reason:i})},this.numInboundStreams=0,this.numOutboundStreams=0,this.nextStreamID=this.client?1:2,this.nextPingID=0,this.rtt=-1,this.log?.trace("muxer created"),this.config.enableKeepAlive&&this.keepAliveLoop().catch(r=>this.log?.error("keepalive error: %s",r)),this.ping().catch(r=>this.log?.error("ping error: %s",r))}get streams(){return Array.from(this._streams.values())}newStream(t){if(this.remoteGoAway!==void 0)throw new fi("Muxer closed remotely");if(this.localGoAway!==void 0)throw new fi("Muxer closed locally");const e=this.nextStreamID;if(this.nextStreamID+=2,this.numOutboundStreams>=this.config.maxOutboundStreams)throw new rf("max outbound streams exceeded");this.log?.trace("new outgoing stream id=%s",e);const r=this._newStream(e,t,Fn.Init,"outbound");return this._streams.set(e,r),this.numOutboundStreams++,r.sendWindowUpdate(),r}async ping(){if(this.remoteGoAway!==void 0)throw new fi("Muxer closed remotely");if(this.localGoAway!==void 0)throw new fi("Muxer closed locally");if(this.activePing===void 0){let t=()=>{};this.activePing={id:this.nextPingID++,promise:new Promise((s,i)=>{const o=()=>{i(new fi("Muxer closed locally"))};this.closeController.signal.addEventListener("abort",o,{once:!0}),t=()=>{this.closeController.signal.removeEventListener("abort",o),s()}}),resolve:t};const e=Date.now();this.sendPing(this.activePing.id);try{await this.activePing.promise}finally{delete this.activePing}const r=Date.now();this.rtt=r-e}else await this.activePing.promise;return this.rtt}getRTT(){return this.rtt}async close(t={}){if(this.closeController.signal.aborted)return;const e=t?.reason??Zn.NormalTermination;if(this.log?.trace("muxer close reason=%s",e),t.signal==null){const r=AbortSignal.timeout(OC);t={...t,signal:r}}try{await Promise.all([...this._streams.values()].map(async r=>r.close(t))),this.sendGoAway(e),this._closeMuxer()}catch(r){this.abort(r)}}abort(t,e){if(!this.closeController.signal.aborted){e=e??Zn.InternalError,this.log?.error("muxer abort reason=%s error=%s",e,t);for(const r of this._streams.values())r.abort(t);this.sendGoAway(e),this._closeMuxer()}}isClosed(){return this.closeController.signal.aborted}_closeMuxer(){this.closeController.abort(),this.source.end()}_newStream(t,e,r,s){if(this._streams.get(t)!=null)throw new X("Stream already exists with that id");const i=new RC({id:t.toString(),name:e,state:r,direction:s,sendFrame:this.sendFrame.bind(this),onEnd:()=>{this.closeStream(t),this.onStreamEnd?.(i)},log:this.logger.forComponent(`libp2p:yamux:${s}:${t}`),config:this.config,getRTT:this.getRTT.bind(this)});return i}closeStream(t){this.client===(t%2===0)?this.numInboundStreams--:this.numOutboundStreams--,this._streams.delete(t)}async keepAliveLoop(){const t=new Promise((e,r)=>{this.closeController.signal.addEventListener("abort",r,{once:!0})});for(this.log?.trace("muxer keepalive enabled interval=%s",this.config.keepAliveInterval);;){let e;try{await Promise.race([t,new Promise(r=>{e=setTimeout(r,this.config.keepAliveInterval)})]),this.ping().catch(r=>this.log?.error("ping error: %s",r))}catch{clearInterval(e);return}}}async handleFrame(t,e){const{streamID:r,type:s,length:i}=t;if(this.log?.trace("received frame %o",t),r===0)switch(s){case pt.Ping:{this.handlePing(t);return}case pt.GoAway:{this.handleGoAway(i);return}default:throw new ws("Invalid frame type")}else switch(t.type){case pt.Data:case pt.WindowUpdate:{await this.handleStreamMessage(t,e);return}default:throw new ws("Invalid frame type")}}handlePing(t){if(t.flag===tt.SYN)this.log?.trace("received ping request pingId=%s",t.length),this.sendPing(t.length,tt.ACK);else if(t.flag===tt.ACK)this.log?.trace("received ping response pingId=%s",t.length),this.handlePingResponse(t.length);else throw new ws("Invalid frame flag")}handlePingResponse(t){if(this.activePing===void 0)throw new Bf("ping not requested");if(this.activePing.id!==t)throw new Nf("ping doesn't match our id");this.activePing.resolve()}handleGoAway(t){this.log?.trace("received GoAway reason=%s",Zn[t]??"unknown"),this.remoteGoAway=t;for(const e of this._streams.values())e.reset();this._closeMuxer()}async handleStreamMessage(t,e){const{streamID:r,flag:s,type:i}=t;(s&tt.SYN)===tt.SYN&&this.incomingStream(r);const o=this._streams.get(r);if(o===void 0){if(i===pt.Data){if(this.log?.("discarding data for stream id=%s",r),e===void 0)throw new Error("unreachable");await e()}else this.log?.trace("frame for missing stream id=%s",r);return}switch(i){case pt.WindowUpdate:{o.handleWindowUpdate(t);return}case pt.Data:{if(e===void 0)throw new Error("unreachable");await o.handleData(t,e);return}default:throw new Error("unreachable")}}incomingStream(t){if(this.client!==(t%2===0))throw new X("Both endpoints are clients");if(this._streams.has(t))return;if(this.log?.trace("new incoming stream id=%s",t),this.localGoAway!==void 0){this.sendFrame({type:pt.WindowUpdate,flag:tt.RST,streamID:t,length:0});return}if(this.numInboundStreams>=this.config.maxInboundStreams){this.log?.("maxIncomingStreams exceeded, forcing stream reset"),this.sendFrame({type:pt.WindowUpdate,flag:tt.RST,streamID:t,length:0});return}const e=this._newStream(t,void 0,Fn.SYNReceived,"inbound");this.numInboundStreams++,this._streams.set(t,e),this.onIncomingStream?.(e)}sendFrame(t,e){if(this.log?.trace("sending frame %o",t),t.type===pt.Data){if(e===void 0)throw new ws("Invalid frame");this.source.push(new We(wg(t),e))}else this.source.push(wg(t))}sendPing(t,e=tt.SYN){e===tt.SYN?this.log?.trace("sending ping request pingId=%s",t):this.log?.trace("sending ping response pingId=%s",t),this.sendFrame({type:pt.Ping,flag:e,streamID:0,length:t})}sendGoAway(t=Zn.NormalTermination){this.log?.("sending GoAway reason=%s",Zn[t]),this.localGoAway=t,this.sendFrame({type:pt.GoAway,flag:0,streamID:0,length:t})}}function UC(n){return n!=null&&typeof n.then=="function"}function VC(n={}){return t=>new FC(t,n)}function HC(n){n=Wd(n);const t=[],e=[];let r=null;const s=n.split("/").slice(1);if(s.length===1&&s[0]==="")return{bytes:new Uint8Array,string:"/",tuples:[],stringTuples:[],path:null};for(let i=0;i<s.length;i++){const o=s[i],a=pe(o);if(a.size===0){t.push([a.code]),e.push([a.code]);continue}if(i++,i>=s.length)throw new Ff("invalid address: "+n);if(a.path===!0){r=Wd(s.slice(i).join("/")),t.push([a.code,mg(a.code,r)]),e.push([a.code,r]);break}const l=mg(a.code,s[i]);t.push([a.code,l]),e.push([a.code,Mf(a.code,l)])}return{string:kw(e),bytes:Tw(t),tuples:t,stringTuples:e,path:r}}function Eg(n){const t=[],e=[];let r=null,s=0;for(;s<n.length;){const i=Ys(n,s),o=ln(i),a=pe(i),l=zC(a,n.slice(s+o));if(l===0){t.push([i]),e.push([i]),s+=o;continue}const u=n.slice(s+o,s+o+l);if(s+=l+o,s>n.length)throw new Ff("Invalid address Uint8Array: "+de(n,"base16"));t.push([i,u]);const h=Mf(i,u);if(e.push([i,h]),a.path===!0){r=h;break}}return{bytes:Uint8Array.from(n),string:kw(e),tuples:t,stringTuples:e,path:r}}function kw(n){const t=[];return n.map(e=>{const r=pe(e[0]);return t.push(r.name),e.length>1&&e[1]!=null&&t.push(e[1]),null}),Wd(t.join("/"))}function Tw(n){return bn(n.map(t=>{const e=pe(t[0]);let r=Uint8Array.from(Vn(e.code));return t.length>1&&t[1]!=null&&(r=bn([r,t[1]])),r}))}function zC(n,t){if(n.size>0)return n.size/8;if(n.size===0)return 0;{const e=Ys(t instanceof Uint8Array?t:Uint8Array.from(t));return e+ln(e)}}function Wd(n){return"/"+n.trim().split("/").filter(t=>t).join("/")}class Ff extends Error{constructor(e){super(`Error parsing address: ${e}`);p(this,"name","ParseError")}}p(Ff,"name","ParseError");const qC=Symbol.for("nodejs.util.inspect.custom"),Cw=Symbol.for("@multiformats/js-multiaddr/multiaddr"),WC=[pe("dns").code,pe("dns4").code,pe("dns6").code,pe("dnsaddr").code];class GC extends Error{constructor(t="No available resolver"){super(t),this.name="NoAvailableResolverError"}}var ay,Ti,Jr,la,ua;const mi=class mi{constructor(t){p(this,"bytes");_e(this,Ti);_e(this,Jr);_e(this,la);_e(this,ua);p(this,ay,!0);t==null&&(t="");let e;if(t instanceof Uint8Array)e=Eg(t);else if(typeof t=="string"){if(t.length>0&&t.charAt(0)!=="/")throw new Error(`multiaddr "${t}" must start with a "/"`);e=HC(t)}else if(Vl(t))e=Eg(t.bytes);else throw new Error("addr must be a string, Buffer, or another Multiaddr");this.bytes=e.bytes,Pe(this,Ti,e.string),Pe(this,Jr,e.tuples),Pe(this,la,e.stringTuples),Pe(this,ua,e.path)}toString(){return $(this,Ti)}toJSON(){return this.toString()}toOptions(){let t,e,r,s,i="";const o=pe("tcp"),a=pe("udp"),l=pe("ip4"),u=pe("ip6"),h=pe("dns6"),c=pe("ip6zone");for(const[f,g]of this.stringTuples())f===c.code&&(i=`%${g??""}`),WC.includes(f)&&(e=o.name==="tcp"?"tcp":"udp",s=443,r=`${g??""}${i}`,t=f===h.code?6:4),(f===o.code||f===a.code)&&(e=pe(f).name==="tcp"?"tcp":"udp",s=parseInt(g??"")),(f===l.code||f===u.code)&&(e=pe(f).name==="tcp"?"tcp":"udp",r=`${g??""}${i}`,t=f===u.code?6:4);if(t==null||e==null||r==null||s==null)throw new Error('multiaddr must have a valid format: "/{ip4, ip6, dns4, dns6, dnsaddr}/{address}/{tcp, udp}/{port}".');return{family:t,host:r,transport:e,port:s}}protos(){return $(this,Jr).map(([t])=>Object.assign({},pe(t)))}protoCodes(){return $(this,Jr).map(([t])=>t)}protoNames(){return $(this,Jr).map(([t])=>pe(t).name)}tuples(){return $(this,Jr).map(([t,e])=>e==null?[t]:[t,e])}stringTuples(){return $(this,la).map(([t,e])=>e==null?[t]:[t,e])}encapsulate(t){return t=new mi(t),new mi(this.toString()+t.toString())}decapsulate(t){const e=t.toString(),r=this.toString(),s=r.lastIndexOf(e);if(s<0)throw new Error(`Address ${this.toString()} does not contain subaddress: ${t.toString()}`);return new mi(r.slice(0,s))}decapsulateCode(t){const e=this.tuples();for(let r=e.length-1;r>=0;r--)if(e[r][0]===t)return new mi(Tw(e.slice(0,r)));return this}getPeerId(){try{let t=[];this.stringTuples().forEach(([r,s])=>{r===na.p2p.code&&t.push([r,s]),r===na["p2p-circuit"].code&&(t=[])});const e=t.pop();if(e?.[1]!=null){const r=e[1];return r[0]==="Q"||r[0]==="1"?de(ot.decode(`z${r}`),"base58btc"):de(Ye.parse(r).multihash.bytes,"base58btc")}return null}catch{return null}}getPath(){return $(this,ua)}equals(t){return It(this.bytes,t.bytes)}async resolve(t){const e=this.protos().find(i=>i.resolvable);if(e==null)return[this];const r=$f.get(e.name);if(r==null)throw new GC(`no available resolver for ${e.name}`);return(await r(this,t)).map(i=>me(i))}nodeAddress(){const t=this.toOptions();if(t.transport!=="tcp"&&t.transport!=="udp")throw new Error(`multiaddr must have a valid format - no protocol with name: "${t.transport}". Must have a valid transport protocol: "{tcp, udp}"`);return{family:t.family,address:t.host,port:t.port}}isThinWaistAddress(t){const e=(t??this).protos();return!(e.length!==2||e[0].code!==4&&e[0].code!==41||e[1].code!==6&&e[1].code!==273)}[(ay=Cw,qC)](){return`Multiaddr(${$(this,Ti)})`}};Ti=new WeakMap,Jr=new WeakMap,la=new WeakMap,ua=new WeakMap;let Gd=mi;const $f=new Map;function Vl(n){return!!n?.[Cw]}function me(n){return new Gd(n)}const KC=Z("dns4"),YC=Z("dns6"),QC=Z("dnsaddr"),Fs=ct(Z("dns"),QC,KC,YC),Hl=ct(Z("ip4"),Z("ip6")),qi=ct(se(Hl,Z("tcp")),se(Fs,Z("tcp"))),zl=se(Hl,Z("udp")),ZC=se(zl,Z("utp")),XC=se(zl,Z("quic")),jC=se(zl,Z("quic-v1")),Kd=ct(se(qi,Z("ws")),se(Fs,Z("ws"))),Rc=ct(se(Kd,Z("p2p")),Kd),Yd=ct(se(qi,Z("wss")),se(Fs,Z("wss")),se(qi,Z("tls"),Z("ws")),se(Fs,Z("tls"),Z("ws"))),Oc=ct(se(Yd,Z("p2p")),Yd),Qd=ct(se(qi,Z("http")),se(Hl,Z("http")),se(Fs,Z("http"))),Zd=ct(se(qi,Z("https")),se(Hl,Z("https")),se(Fs,Z("https"))),Ag=se(zl,Z("webrtc-direct"),Z("certhash")),Pw=ct(se(Ag,Z("p2p")),Ag),xg=se(jC,Z("webtransport"),Z("certhash"),Z("certhash")),Dw=ct(se(xg,Z("p2p")),xg),Mw=ct(se(Rc,Z("p2p-webrtc-star"),Z("p2p")),se(Oc,Z("p2p-webrtc-star"),Z("p2p")),se(Rc,Z("p2p-webrtc-star")),se(Oc,Z("p2p-webrtc-star")));ct(se(Rc,Z("p2p-websocket-star"),Z("p2p")),se(Oc,Z("p2p-websocket-star"),Z("p2p")),se(Rc,Z("p2p-websocket-star")),se(Oc,Z("p2p-websocket-star")));const Lw=ct(se(Qd,Z("p2p-webrtc-direct"),Z("p2p")),se(Zd,Z("p2p-webrtc-direct"),Z("p2p")),se(Qd,Z("p2p-webrtc-direct")),se(Zd,Z("p2p-webrtc-direct"))),$s=ct(Kd,Yd,Qd,Zd,Mw,Lw,qi,ZC,XC,Fs,Pw,Dw);ct(se($s,Z("p2p-stardust"),Z("p2p")),se($s,Z("p2p-stardust")));const rs=ct(se($s,Z("p2p")),Mw,Lw,Pw,Dw,Z("p2p")),Ig=ct(se(rs,Z("p2p-circuit"),rs),se(rs,Z("p2p-circuit")),se(Z("p2p-circuit"),rs),se($s,Z("p2p-circuit")),se(Z("p2p-circuit"),$s),Z("p2p-circuit")),Bw=()=>ct(se(Ig,Bw),Ig),ys=Bw(),JC=ct(se(ys,rs,ys),se(rs,ys),se(ys,rs),ys,rs);ct(se(ys,Z("webrtc"),Z("p2p")),se(ys,Z("webrtc")),se($s,Z("webrtc"),Z("p2p")),se($s,Z("webrtc")),Z("webrtc"));function Nw(n){function t(e){let r;try{r=me(e)}catch{return!1}const s=n(r.protoNames());return s===null?!1:s===!0||s===!1?s:s.length===0}return t}function se(...n){function t(e){if(e.length<n.length)return null;let r=e;return n.some(s=>(r=typeof s=="function"?s().partialMatch(e):s.partialMatch(e),Array.isArray(r)&&(e=r),r===null)),r}return{toString:function(){return"{ "+n.join(" ")+" }"},input:n,matches:Nw(t),partialMatch:t}}function ct(...n){function t(r){let s=null;return n.some(i=>{const o=typeof i=="function"?i().partialMatch(r):i.partialMatch(r);return o!=null?(s=o,!0):!1}),s}return{toString:function(){return"{ "+n.join(" ")+" }"},input:n,matches:Nw(t),partialMatch:t}}function Z(n){const t=n;function e(s){let i;try{i=me(s)}catch{return!1}const o=i.protoNames();return o.length===1&&o[0]===t}function r(s){return s.length===0?null:s[0]===t?s.slice(1):null}return{toString:function(){return t},matches:e,partialMatch:r}}const eP="bootstrap",tP=50,nP=1e3;var cy,ly,uy,dy;class Rw extends(dy=ar,uy=wc,ly=Symbol.toStringTag,cy=Wn,dy){constructor(e,r={list:[]}){if(r.list==null||r.list.length===0)throw new Error("Bootstrap requires a list of peer addresses");super();p(this,"log");p(this,"timer");p(this,"list");p(this,"timeout");p(this,"components");p(this,"_init");p(this,uy,this);p(this,ly,"@libp2p/bootstrap");p(this,cy,["@libp2p/peer-discovery"]);this.components=e,this.log=e.logger.forComponent("libp2p:bootstrap"),this.timeout=r.timeout??nP,this.list=[];for(const s of r.list){if(!JC.matches(s)){this.log.error("Invalid multiaddr");continue}const i=me(s),o=i.getPeerId();if(o==null){this.log.error("Invalid bootstrap multiaddr without peer id");continue}const a={id:Bt(o),multiaddrs:[i]};this.list.push(a)}this._init=r}isStarted(){return!!this.timer}start(){this.isStarted()||(this.log("Starting bootstrap node discovery, discovering peers after %s ms",this.timeout),this.timer=setTimeout(()=>{this._discoverBootstrapPeers().catch(e=>{this.log.error(e)})},this.timeout))}async _discoverBootstrapPeers(){if(this.timer!=null)for(const e of this.list){if(await this.components.peerStore.merge(e.id,{tags:{[this._init.tagName??eP]:{value:this._init.tagValue??tP,ttl:this._init.tagTTL}},multiaddrs:e.multiaddrs}),this.timer==null)return;this.safeDispatchEvent("peer",{detail:e}),this.components.connectionManager.openConnection(e.id).catch(r=>{this.log.error("could not dial bootstrap peer %p",e.id,r)})}}stop(){this.timer!=null&&clearTimeout(this.timer),this.timer=void 0}}p(Rw,"tag","bootstrap");function rP(n){return t=>new Rw(t,n)}var Fc;(function(n){let t;n.codec=()=>(t==null&&(t=Te((e,r,s={})=>{s.lengthDelimited!==!1&&r.fork(),e.publicKey!=null&&e.publicKey.byteLength>0&&(r.uint32(10),r.bytes(e.publicKey)),e.payloadType!=null&&e.payloadType.byteLength>0&&(r.uint32(18),r.bytes(e.payloadType)),e.payload!=null&&e.payload.byteLength>0&&(r.uint32(26),r.bytes(e.payload)),e.signature!=null&&e.signature.byteLength>0&&(r.uint32(42),r.bytes(e.signature)),s.lengthDelimited!==!1&&r.ldelim()},(e,r,s={})=>{const i={publicKey:Ge(0),payloadType:Ge(0),payload:Ge(0),signature:Ge(0)},o=r==null?e.len:e.pos+r;for(;e.pos<o;){const a=e.uint32();switch(a>>>3){case 1:{i.publicKey=e.bytes();break}case 2:{i.payloadType=e.bytes();break}case 3:{i.payload=e.bytes();break}case 5:{i.signature=e.bytes();break}default:{e.skipType(a&7);break}}}return i})),t),n.encode=e=>ke(e,n.codec()),n.decode=(e,r)=>Ie(e,n.codec(),r)})(Fc||(Fc={}));class sP extends Error{constructor(t="Invalid signature"){super(t),this.name="InvalidSignatureError"}}const Zr=class Zr{constructor(t){p(this,"publicKey");p(this,"payloadType");p(this,"payload");p(this,"signature");p(this,"marshaled");const{publicKey:e,payloadType:r,payload:s,signature:i}=t;this.publicKey=e,this.payloadType=r,this.payload=s,this.signature=i}marshal(){return this.marshaled==null&&(this.marshaled=Fc.encode({publicKey:nr(this.publicKey),payloadType:this.payloadType,payload:this.payload.subarray(),signature:this.signature})),this.marshaled}equals(t){return It(this.marshal(),t.marshal())}async validate(t){const e=kg(t,this.payloadType,this.payload);return this.publicKey.verify(e.subarray(),this.signature)}};p(Zr,"createFromProtobuf",async t=>{const e=Fc.decode(t),r=Lr(e.publicKey);return new Zr({publicKey:r,payloadType:e.payloadType,payload:e.payload,signature:e.signature})}),p(Zr,"seal",async(t,e)=>{if(e==null)throw new Error("Missing private key");const r=t.domain,s=t.codec,i=t.marshal(),o=kg(r,s,i),a=await e.sign(o.subarray());return new Zr({publicKey:e.publicKey,payloadType:s,payload:i,signature:a})}),p(Zr,"openAndCertify",async(t,e)=>{const r=await Zr.createFromProtobuf(t);if(!await r.validate(e))throw new sP("Envelope signature is not valid for the given domain");return r});let Us=Zr;const kg=(n,t,e)=>{const r=te(n),s=Vn(r.byteLength),i=Vn(t.length),o=Vn(e.length);return new We(s,r,i,t,o,e)};function iP(n,t){const e=(r,s)=>r.toString().localeCompare(s.toString());return n.length!==t.length?!1:(t.sort(e),n.sort(e).every((r,s)=>t[s].equals(r)))}const oP="libp2p-peer-record",aP=Uint8Array.from([3,1]);var $c;(function(n){(function(e){let r;e.codec=()=>(r==null&&(r=Te((s,i,o={})=>{o.lengthDelimited!==!1&&i.fork(),s.multiaddr!=null&&s.multiaddr.byteLength>0&&(i.uint32(10),i.bytes(s.multiaddr)),o.lengthDelimited!==!1&&i.ldelim()},(s,i,o={})=>{const a={multiaddr:Ge(0)},l=i==null?s.len:s.pos+i;for(;s.pos<l;){const u=s.uint32();switch(u>>>3){case 1:{a.multiaddr=s.bytes();break}default:{s.skipType(u&7);break}}}return a})),r),e.encode=s=>ke(s,e.codec()),e.decode=(s,i)=>Ie(s,e.codec(),i)})(n.AddressInfo||(n.AddressInfo={}));let t;n.codec=()=>(t==null&&(t=Te((e,r,s={})=>{if(s.lengthDelimited!==!1&&r.fork(),e.peerId!=null&&e.peerId.byteLength>0&&(r.uint32(10),r.bytes(e.peerId)),e.seq!=null&&e.seq!==0n&&(r.uint32(16),r.uint64(e.seq)),e.addresses!=null)for(const i of e.addresses)r.uint32(26),n.AddressInfo.codec().encode(i,r);s.lengthDelimited!==!1&&r.ldelim()},(e,r,s={})=>{const i={peerId:Ge(0),seq:0n,addresses:[]},o=r==null?e.len:e.pos+r;for(;e.pos<o;){const a=e.uint32();switch(a>>>3){case 1:{i.peerId=e.bytes();break}case 2:{i.seq=e.uint64();break}case 3:{if(s.limits?.addresses!=null&&i.addresses.length===s.limits.addresses)throw new gt('Decode error - map field "addresses" had too many elements');i.addresses.push(n.AddressInfo.codec().decode(e,e.uint32(),{limits:s.limits?.addresses$}));break}default:{e.skipType(a&7);break}}}return i})),t),n.encode=e=>ke(e,n.codec()),n.decode=(e,r)=>Ie(e,n.codec(),r)})($c||($c={}));const vr=class vr{constructor(t){p(this,"peerId");p(this,"multiaddrs");p(this,"seqNumber");p(this,"domain",vr.DOMAIN);p(this,"codec",vr.CODEC);p(this,"marshaled");const{peerId:e,multiaddrs:r,seqNumber:s}=t;this.peerId=e,this.multiaddrs=r??[],this.seqNumber=s??BigInt(Date.now())}marshal(){return this.marshaled==null&&(this.marshaled=$c.encode({peerId:this.peerId.toMultihash().bytes,seq:BigInt(this.seqNumber),addresses:this.multiaddrs.map(t=>({multiaddr:t.bytes}))})),this.marshaled}equals(t){return!(!(t instanceof vr)||!this.peerId.equals(t.peerId)||this.seqNumber!==t.seqNumber||!iP(this.multiaddrs,t.multiaddrs))}};p(vr,"createFromProtobuf",t=>{const e=$c.decode(t),r=Qs($r(e.peerId)),s=(e.addresses??[]).map(o=>me(o.multiaddr)),i=e.seq;return new vr({peerId:r,multiaddrs:s,seqNumber:i})}),p(vr,"DOMAIN",oP),p(vr,"CODEC",aP);let Dr=vr;class cP{constructor(){p(this,"readNext");p(this,"haveNext");p(this,"ended");p(this,"nextResult");this.ended=!1,this.readNext=bt(),this.haveNext=bt()}[Symbol.asyncIterator](){return this}async next(){if(this.nextResult==null&&await this.haveNext.promise,this.nextResult==null)throw new Error("HaveNext promise resolved but nextResult was undefined");const t=this.nextResult;return this.nextResult=void 0,this.readNext.resolve(),this.readNext=bt(),t}async throw(t){return this.ended=!0,t!=null&&(this.haveNext.promise.catch(()=>{}),this.haveNext.reject(t)),{done:!0,value:void 0}}async return(){const t={done:!0,value:void 0};return await this._push(void 0),t}async push(t,e){await this._push(t,e)}async end(t,e){t!=null?await this.throw(t):await this._push(void 0,e)}async _push(t,e){if(t!=null&&this.ended)throw new Error("Cannot push value onto an ended pushable");for(;this.nextResult!=null;)await this.readNext.promise;t!=null?this.nextResult={done:!1,value:t}:(this.ended=!0,this.nextResult={done:!0,value:void 0}),this.haveNext.resolve(),this.haveNext=bt(),await Ir(this.readNext.promise,e?.signal,e)}}function lP(){return new cP}class uP extends Error{constructor(){super(...arguments);p(this,"name","UnexpectedEOFError");p(this,"code","ERR_UNEXPECTED_EOF")}}class dP extends Error{constructor(e,r){super(e);p(this,"code");this.code=r}}let hP=class extends dP{constructor(e){super(e,"ABORT_ERR");p(this,"type");this.type="aborted",this.name="AbortError"}};function Ow(n,t){const e=lP();n.sink(e).catch(async o=>{await e.end(o)}),n.sink=async o=>{for await(const a of o)await e.push(a);await e.end()};let r=n.source;n.source[Symbol.iterator]!=null?r=n.source[Symbol.iterator]():n.source[Symbol.asyncIterator]!=null&&(r=n.source[Symbol.asyncIterator]());const s=new We;return{read:async(o,a)=>{a?.signal?.throwIfAborted();let l;const u=new Promise((h,c)=>{l=()=>{c(new hP("Read aborted"))},a?.signal?.addEventListener("abort",l)});try{if(o==null){const{done:c,value:d}=await Promise.race([r.next(),u]);return c===!0?new We:d}for(;s.byteLength<o;){const{value:c,done:d}=await Promise.race([r.next(),u]);if(d===!0)throw new uP("unexpected end of input");s.append(c)}const h=s.sublist(0,o);return s.consume(o),h}finally{l!=null&&a?.signal?.removeEventListener("abort",l)}},write:async(o,a)=>{a?.signal?.throwIfAborted(),o instanceof Uint8Array?await e.push(o,a):await e.push(o.subarray(),a)},unwrap:()=>{if(s.byteLength>0){const o=n.source;n.source=async function*(){t?.yieldBytes===!1?yield s:yield*s,yield*o}()}return n}}}class fP extends Error{constructor(){super(...arguments);p(this,"name","InvalidMessageLengthError");p(this,"code","ERR_INVALID_MSG_LENGTH")}}let pP=class extends Error{constructor(){super(...arguments);p(this,"name","InvalidDataLengthError");p(this,"code","ERR_MSG_DATA_TOO_LONG")}};class gP extends Error{constructor(){super(...arguments);p(this,"name","InvalidDataLengthLengthError");p(this,"code","ERR_MSG_LENGTH_TOO_LONG")}}function ql(n,t={}){const e=Ow(n,t);t.maxDataLength!=null&&t.maxLengthLength==null&&(t.maxLengthLength=ln(t.maxDataLength));const r=t?.lengthDecoder??Ys,s=t?.lengthEncoder??Vn;return{read:async o=>{let a=-1;const l=new We;for(;;){l.append(await e.read(1,o));try{a=r(l)}catch(u){if(u instanceof RangeError)continue;throw u}if(a<0)throw new fP("Invalid message length");if(t?.maxLengthLength!=null&&l.byteLength>t.maxLengthLength)throw new gP("message length length too long");if(a>-1)break}if(t?.maxDataLength!=null&&a>t.maxDataLength)throw new pP("message length too long");return e.read(a,o)},write:async(o,a)=>{await e.write(new We(s(o.byteLength),o),a)},writeV:async(o,a)=>{const l=new We(...o.flatMap(u=>[s(u.byteLength),u]));await e.write(l,a)},unwrap:()=>e.unwrap()}}function Wi(n,t){const e=ql(n,t),r={read:async(s,i)=>{const o=await e.read(i);return s.decode(o)},write:async(s,i,o)=>{await e.write(i.encode(s),o)},writeV:async(s,i,o)=>{await e.writeV(s.map(a=>i.encode(a)),o)},pb:s=>({read:async i=>r.read(s,i),write:async(i,o)=>r.write(i,s,o),writeV:async(i,o)=>r.writeV(i,s,o),unwrap:()=>r}),unwrap:()=>e.unwrap()};return r}const mP=290,yP=1,Fw=2e3,vP=100,$a=`${Zh}-circuit-relay`;BigInt(1<<17);const Uc="/libp2p/circuit/relay/0.2.0/hop",Tg="/libp2p/circuit/relay/0.2.0/stop",Cg=300,bP=4096,wP=.001;var Gi;(function(n){(function(r){r.RESERVE="RESERVE",r.CONNECT="CONNECT",r.STATUS="STATUS"})(n.Type||(n.Type={}));let t;(function(r){r[r.RESERVE=0]="RESERVE",r[r.CONNECT=1]="CONNECT",r[r.STATUS=2]="STATUS"})(t||(t={})),function(r){r.codec=()=>xa(t)}(n.Type||(n.Type={}));let e;n.codec=()=>(e==null&&(e=Te((r,s,i={})=>{i.lengthDelimited!==!1&&s.fork(),r.type!=null&&(s.uint32(8),n.Type.codec().encode(r.type,s)),r.peer!=null&&(s.uint32(18),Ki.codec().encode(r.peer,s)),r.reservation!=null&&(s.uint32(26),Vc.codec().encode(r.reservation,s)),r.limit!=null&&(s.uint32(34),Yi.codec().encode(r.limit,s)),r.status!=null&&(s.uint32(40),Gt.codec().encode(r.status,s)),i.lengthDelimited!==!1&&s.ldelim()},(r,s,i={})=>{const o={},a=s==null?r.len:r.pos+s;for(;r.pos<a;){const l=r.uint32();switch(l>>>3){case 1:{o.type=n.Type.codec().decode(r);break}case 2:{o.peer=Ki.codec().decode(r,r.uint32(),{limits:i.limits?.peer});break}case 3:{o.reservation=Vc.codec().decode(r,r.uint32(),{limits:i.limits?.reservation});break}case 4:{o.limit=Yi.codec().decode(r,r.uint32(),{limits:i.limits?.limit});break}case 5:{o.status=Gt.codec().decode(r);break}default:{r.skipType(l&7);break}}}return o})),e),n.encode=r=>ke(r,n.codec()),n.decode=(r,s)=>Ie(r,n.codec(),s)})(Gi||(Gi={}));var mr;(function(n){(function(r){r.CONNECT="CONNECT",r.STATUS="STATUS"})(n.Type||(n.Type={}));let t;(function(r){r[r.CONNECT=0]="CONNECT",r[r.STATUS=1]="STATUS"})(t||(t={})),function(r){r.codec=()=>xa(t)}(n.Type||(n.Type={}));let e;n.codec=()=>(e==null&&(e=Te((r,s,i={})=>{i.lengthDelimited!==!1&&s.fork(),r.type!=null&&(s.uint32(8),n.Type.codec().encode(r.type,s)),r.peer!=null&&(s.uint32(18),Ki.codec().encode(r.peer,s)),r.limit!=null&&(s.uint32(26),Yi.codec().encode(r.limit,s)),r.status!=null&&(s.uint32(32),Gt.codec().encode(r.status,s)),i.lengthDelimited!==!1&&s.ldelim()},(r,s,i={})=>{const o={},a=s==null?r.len:r.pos+s;for(;r.pos<a;){const l=r.uint32();switch(l>>>3){case 1:{o.type=n.Type.codec().decode(r);break}case 2:{o.peer=Ki.codec().decode(r,r.uint32(),{limits:i.limits?.peer});break}case 3:{o.limit=Yi.codec().decode(r,r.uint32(),{limits:i.limits?.limit});break}case 4:{o.status=Gt.codec().decode(r);break}default:{r.skipType(l&7);break}}}return o})),e),n.encode=r=>ke(r,n.codec()),n.decode=(r,s)=>Ie(r,n.codec(),s)})(mr||(mr={}));var Ki;(function(n){let t;n.codec=()=>(t==null&&(t=Te((e,r,s={})=>{if(s.lengthDelimited!==!1&&r.fork(),e.id!=null&&e.id.byteLength>0&&(r.uint32(10),r.bytes(e.id)),e.addrs!=null)for(const i of e.addrs)r.uint32(18),r.bytes(i);s.lengthDelimited!==!1&&r.ldelim()},(e,r,s={})=>{const i={id:Ge(0),addrs:[]},o=r==null?e.len:e.pos+r;for(;e.pos<o;){const a=e.uint32();switch(a>>>3){case 1:{i.id=e.bytes();break}case 2:{if(s.limits?.addrs!=null&&i.addrs.length===s.limits.addrs)throw new gt('Decode error - map field "addrs" had too many elements');i.addrs.push(e.bytes());break}default:{e.skipType(a&7);break}}}return i})),t),n.encode=e=>ke(e,n.codec()),n.decode=(e,r)=>Ie(e,n.codec(),r)})(Ki||(Ki={}));var Vc;(function(n){let t;n.codec=()=>(t==null&&(t=Te((e,r,s={})=>{if(s.lengthDelimited!==!1&&r.fork(),e.expire!=null&&e.expire!==0n&&(r.uint32(8),r.uint64(e.expire)),e.addrs!=null)for(const i of e.addrs)r.uint32(18),r.bytes(i);e.voucher!=null&&(r.uint32(26),zc.codec().encode(e.voucher,r)),s.lengthDelimited!==!1&&r.ldelim()},(e,r,s={})=>{const i={expire:0n,addrs:[]},o=r==null?e.len:e.pos+r;for(;e.pos<o;){const a=e.uint32();switch(a>>>3){case 1:{i.expire=e.uint64();break}case 2:{if(s.limits?.addrs!=null&&i.addrs.length===s.limits.addrs)throw new gt('Decode error - map field "addrs" had too many elements');i.addrs.push(e.bytes());break}case 3:{i.voucher=zc.codec().decode(e,e.uint32(),{limits:s.limits?.voucher});break}default:{e.skipType(a&7);break}}}return i})),t),n.encode=e=>ke(e,n.codec()),n.decode=(e,r)=>Ie(e,n.codec(),r)})(Vc||(Vc={}));var Yi;(function(n){let t;n.codec=()=>(t==null&&(t=Te((e,r,s={})=>{s.lengthDelimited!==!1&&r.fork(),e.duration!=null&&(r.uint32(8),r.uint32(e.duration)),e.data!=null&&(r.uint32(16),r.uint64(e.data)),s.lengthDelimited!==!1&&r.ldelim()},(e,r,s={})=>{const i={},o=r==null?e.len:e.pos+r;for(;e.pos<o;){const a=e.uint32();switch(a>>>3){case 1:{i.duration=e.uint32();break}case 2:{i.data=e.uint64();break}default:{e.skipType(a&7);break}}}return i})),t),n.encode=e=>ke(e,n.codec()),n.decode=(e,r)=>Ie(e,n.codec(),r)})(Yi||(Yi={}));var Gt;(function(n){n.UNUSED="UNUSED",n.OK="OK",n.RESERVATION_REFUSED="RESERVATION_REFUSED",n.RESOURCE_LIMIT_EXCEEDED="RESOURCE_LIMIT_EXCEEDED",n.PERMISSION_DENIED="PERMISSION_DENIED",n.CONNECTION_FAILED="CONNECTION_FAILED",n.NO_RESERVATION="NO_RESERVATION",n.MALFORMED_MESSAGE="MALFORMED_MESSAGE",n.UNEXPECTED_MESSAGE="UNEXPECTED_MESSAGE"})(Gt||(Gt={}));var Xd;(function(n){n[n.UNUSED=0]="UNUSED",n[n.OK=100]="OK",n[n.RESERVATION_REFUSED=200]="RESERVATION_REFUSED",n[n.RESOURCE_LIMIT_EXCEEDED=201]="RESOURCE_LIMIT_EXCEEDED",n[n.PERMISSION_DENIED=202]="PERMISSION_DENIED",n[n.CONNECTION_FAILED=203]="CONNECTION_FAILED",n[n.NO_RESERVATION=204]="NO_RESERVATION",n[n.MALFORMED_MESSAGE=400]="MALFORMED_MESSAGE",n[n.UNEXPECTED_MESSAGE=401]="UNEXPECTED_MESSAGE"})(Xd||(Xd={}));(function(n){n.codec=()=>xa(Xd)})(Gt||(Gt={}));var Hc;(function(n){let t;n.codec=()=>(t==null&&(t=Te((e,r,s={})=>{s.lengthDelimited!==!1&&r.fork(),e.relay!=null&&e.relay.byteLength>0&&(r.uint32(10),r.bytes(e.relay)),e.peer!=null&&e.peer.byteLength>0&&(r.uint32(18),r.bytes(e.peer)),e.expiration!=null&&e.expiration!==0n&&(r.uint32(24),r.uint64(e.expiration)),s.lengthDelimited!==!1&&r.ldelim()},(e,r,s={})=>{const i={relay:Ge(0),peer:Ge(0),expiration:0n},o=r==null?e.len:e.pos+r;for(;e.pos<o;){const a=e.uint32();switch(a>>>3){case 1:{i.relay=e.bytes();break}case 2:{i.peer=e.bytes();break}case 3:{i.expiration=e.uint64();break}default:{e.skipType(a&7);break}}}return i})),t),n.encode=e=>ke(e,n.codec()),n.decode=(e,r)=>Ie(e,n.codec(),r)})(Hc||(Hc={}));var zc;(function(n){let t;n.codec=()=>(t==null&&(t=Te((e,r,s={})=>{s.lengthDelimited!==!1&&r.fork(),e.publicKey!=null&&e.publicKey.byteLength>0&&(r.uint32(10),r.bytes(e.publicKey)),e.payloadType!=null&&e.payloadType.byteLength>0&&(r.uint32(18),r.bytes(e.payloadType)),e.payload!=null&&(r.uint32(26),Hc.codec().encode(e.payload,r)),e.signature!=null&&e.signature.byteLength>0&&(r.uint32(42),r.bytes(e.signature)),s.lengthDelimited!==!1&&r.ldelim()},(e,r,s={})=>{const i={publicKey:Ge(0),payloadType:Ge(0),signature:Ge(0)},o=r==null?e.len:e.pos+r;for(;e.pos<o;){const a=e.uint32();switch(a>>>3){case 1:{i.publicKey=e.bytes();break}case 2:{i.payloadType=e.bytes();break}case 3:{i.payload=Hc.codec().decode(e,e.uint32(),{limits:s.limits?.payload});break}case 5:{i.signature=e.bytes();break}default:{e.skipType(a&7);break}}}return i})),t),n.encode=e=>ke(e,n.codec()),n.decode=(e,r)=>Ie(e,n.codec(),r)})(zc||(zc={}));const _P=n=>n.toString().split("/").slice(1),Ta=n=>({match:t=>t.length<1?!1:n(t[0])?t.slice(1):!1,pattern:"fn"}),be=n=>({match:t=>Ta(e=>e===n).match(t),pattern:n}),ho=()=>({match:n=>Ta(t=>typeof t=="string").match(n),pattern:"{string}"}),Wl=()=>({match:n=>Ta(t=>!isNaN(parseInt(t))).match(n),pattern:"{number}"}),Ve=()=>({match:n=>{if(n.length<2||n[0]!=="p2p"&&n[0]!=="ipfs")return!1;if(n[1].startsWith("Q")||n[1].startsWith("1"))try{ot.decode(`z${n[1]}`)}catch{return!1}else return!1;return n.slice(2)},pattern:"/p2p/{peerid}"}),qc=()=>({match:n=>{if(n.length<2||n[0]!=="certhash")return!1;try{Rb.decode(n[1])}catch{return!1}return n.slice(2)},pattern:"/certhash/{certhash}"}),Le=n=>({match:t=>{const e=n.match(t);return e===!1?t:e},pattern:`optional(${n.pattern})`}),Kt=(...n)=>({match:t=>{let e;for(const r of n){const s=r.match(t);s!==!1&&(e==null||s.length<e.length)&&(e=s)}return e??!1},pattern:`or(${n.map(t=>t.pattern).join(", ")})`}),Se=(...n)=>({match:t=>{for(const e of n){const r=e.match(t);if(r===!1)return!1;t=r}return t},pattern:`and(${n.map(t=>t.pattern).join(", ")})`});function Xe(...n){function t(s){let i=_P(s);for(const o of n){const a=o.match(i);if(a===!1)return!1;i=a}return i}function e(s){return t(s)!==!1}function r(s){const i=t(s);return i===!1?!1:i.length===0}return{matchers:n,matches:e,exactMatch:r}}const Gl=Se(be("dns4"),ho()),Kl=Se(be("dns6"),ho()),Yl=Se(be("dnsaddr"),ho()),Uf=Se(be("dns"),ho());Xe(Gl,Le(Ve()));Xe(Kl,Le(Ve()));Xe(Yl,Le(Ve()));Xe(Kt(Uf,Yl,Gl,Kl),Le(Ve()));const $w=Se(be("ip4"),Ta(zi)),Uw=Se(be("ip6"),Ta(Df)),Vf=Kt($w,Uw),Mr=Kt(Vf,Uf,Gl,Kl,Yl),SP=Xe(Kt(Vf,Se(Kt(Uf,Yl,Gl,Kl),Le(Ve())))),Pg=Xe($w),Dg=Xe(Uw);Xe(Vf);const Hf=Se(Mr,be("tcp"),Wl()),Ca=Se(Mr,be("udp"),Wl()),Wc=Xe(Se(Hf,Le(Ve())));Xe(Ca);const zf=Se(Ca,be("quic"),Le(Ve())),Ql=Se(Ca,be("quic-v1"),Le(Ve())),EP=Kt(zf,Ql);Xe(zf);const AP=Xe(Ql),jd=Kt(Mr,Hf,Ca,zf,Ql),Vw=Kt(Se(jd,be("ws"),Le(Ve()))),ra=Xe(Vw),Hw=Kt(Se(jd,be("wss"),Le(Ve())),Se(jd,be("tls"),Le(Se(be("sni"),ho())),be("ws"),Le(Ve()))),Gc=Xe(Hw),zw=Se(Ca,be("webrtc-direct"),Le(qc()),Le(qc()),Le(Ve())),Mg=Xe(zw),qw=Se(Ql,be("webtransport"),Le(qc()),Le(qc()),Le(Ve())),Lg=Xe(qw),Kc=Kt(Vw,Hw,Se(Hf,Le(Ve())),Se(EP,Le(Ve())),Se(Mr,Le(Ve())),zw,qw,Ve()),xP=Xe(Kc),IP=Se(Kc,be("p2p-circuit"),Ve()),sa=Xe(IP),kP=Kt(Se(Kc,be("p2p-circuit"),be("webrtc"),Le(Ve())),Se(Kc,be("webrtc"),Le(Ve())),Se(be("webrtc"),Le(Ve()))),Bg=Xe(kP),TP=Kt(Se(Mr,be("tcp"),Wl(),be("http"),Le(Ve())),Se(Mr,be("http"),Le(Ve())));Xe(TP);const CP=Kt(Se(Mr,be("tcp"),Kt(Se(be("443"),be("http")),Se(Wl(),be("https"))),Le(Ve())),Se(Mr,be("tls"),be("http"),Le(Ve())),Se(Mr,be("https"),Le(Ve())));Xe(CP);const PP=Kt(Se(be("memory"),ho(),Le(Ve())));Xe(PP);function Qi(n){const t=new globalThis.AbortController;function e(){t.abort();for(const i of n)i?.removeEventListener!=null&&i.removeEventListener("abort",e)}for(const i of n){if(i?.aborted===!0){e();break}i?.addEventListener!=null&&i.addEventListener("abort",e)}function r(){for(const i of n)i?.removeEventListener!=null&&i.removeEventListener("abort",e)}const s=t.signal;return s.clear=r,s}class Jd extends Error{constructor(){super(...arguments);p(this,"name","HadEnoughRelaysError")}}p(Jd,"name","HadEnoughRelaysError");class Ww extends Error{constructor(){super(...arguments);p(this,"name","DoubleRelayError")}}p(Ww,"name","DoubleRelayError");class Gw extends Error{constructor(){super(...arguments);p(this,"name","RelayQueueFullError")}}p(Gw,"name","RelayQueueFullError");function Ng(n){const t=n*BigInt(1e3),e=new Date().getTime();return Number(t-BigInt(e))}class Rg{constructor(t){p(this,"expires");p(this,"bytes");t?.duration!=null&&t?.duration!==0&&(this.expires=Date.now()+t.duration*1e3),this.bytes=t?.data,this.bytes===0n&&(this.bytes=void 0),this.onData=this.onData.bind(this)}onData(t){this.bytes!=null&&(this.bytes-=BigInt(t.byteLength),this.bytes<0n&&(this.bytes=0n))}getLimits(){if(this.expires==null&&this.bytes==null)return;const t={};if(this.bytes!=null){const e=this;Object.defineProperty(t,"bytes",{get(){return e.bytes}})}if(this.expires!=null){const e=this;Object.defineProperty(t,"seconds",{get(){return Math.round(((e.expires??0)-Date.now())/1e3)}})}return t}}const Kw=Xe(Se(xP.matchers[0],be("p2p-circuit"))),Yw=Xe(be("p2p-circuit"));function Uo(n,t){const e={[Symbol.iterator]:()=>e,next:()=>{const r=n.next(),s=r.value;return r.done===!0||s==null?{done:!0,value:void 0}:{done:!1,value:t(s)}}};return e}function Cu(n){const t=$r(ot.decode(`z${n}`));return Qs(t)}class Zl{constructor(t){p(this,"map");if(this.map=new Map,t!=null)for(const[e,r]of t.entries())this.map.set(e.toString(),{key:e,value:r})}[Symbol.iterator](){return this.entries()}clear(){this.map.clear()}delete(t){return this.map.delete(t.toString())}entries(){return Uo(this.map.entries(),t=>[t[1].key,t[1].value])}forEach(t){this.map.forEach((e,r)=>{t(e.value,e.key,this)})}get(t){return this.map.get(t.toString())?.value}has(t){return this.map.has(t.toString())}set(t,e){this.map.set(t.toString(),{key:t,value:e})}keys(){return Uo(this.map.values(),t=>t.key)}values(){return Uo(this.map.values(),t=>t.value)}get size(){return this.map.size}}class xi{constructor(t){p(this,"set");if(this.set=new Set,t!=null)for(const e of t)this.set.add(e.toString())}get size(){return this.set.size}[Symbol.iterator](){return this.values()}add(t){this.set.add(t.toString())}clear(){this.set.clear()}delete(t){this.set.delete(t.toString())}entries(){return Uo(this.set.entries(),t=>{const e=Cu(t[0]);return[e,e]})}forEach(t){this.set.forEach(e=>{const r=Cu(e);t(r,r,this)})}has(t){return this.set.has(t.toString())}values(){return Uo(this.set.values(),t=>Cu(t))}intersection(t){const e=new xi;for(const r of t)this.has(r)&&e.add(r);return e}difference(t){const e=new xi;for(const r of this)t.has(r)||e.add(r);return e}union(t){const e=new xi;for(const r of t)e.add(r);for(const r of this)e.add(r);return e}}const qf={32:16777619n,64:1099511628211n,128:309485009821345068724781371n,256:374144419156711147060143317175368453031918731002211n,512:35835915874844867368919076489095108449946327955754392558399825615420669938882575126094039892345713852759n,1024:5016456510113118655434598811035278955030765345404790744303017523831112055108147451509157692220295382716162651878526895249385292291816524375083746691371804094271873160484737966720260389217684476157468082573n},Qw={32:2166136261n,64:14695981039346656037n,128:144066263297769815596495629667062367629n,256:100029257958052580907070968620625704837092796014241193945225284501741471925557n,512:9659303129496669498009435400716310466090418745672637896108374329434462657994582932197716438449813051892206539805784495328239340083876191928701583869517785n,1024:14197795064947621068722070641403218320880622795441933960878474914617582723252296732303717722150864096521202355549365628174669108571814760471015076148029755969804077320157692458563003215304957150157403644460363550505412711285966361610267868082893823963790439336411086884584107735010676915n},Zw=new globalThis.TextEncoder;function DP(n,t){const e=qf[t];let r=Qw[t];for(let s=0;s<n.length;s++)r^=BigInt(n[s]),r=BigInt.asUintN(t,r*e);return r}function MP(n,t,e){if(e.length===0)throw new Error("The `utf8Buffer` option must have a length greater than zero");const r=qf[t];let s=Qw[t],i=n;for(;i.length>0;){const o=Zw.encodeInto(i,e);i=i.slice(o.read);for(let a=0;a<o.written;a++)s^=BigInt(e[a]),s=BigInt.asUintN(t,s*r)}return s}function LP(n,{size:t=32,utf8Buffer:e}={}){if(!qf[t])throw new Error("The `size` option must be one of 32, 64, 128, 256, 512, or 1024");if(typeof n=="string"){if(e)return MP(n,t,e);n=Zw.encode(n)}return DP(n,t)}const Wf={hash:n=>Number(LP(n,{size:32})),hashV:(n,t)=>BP(Wf.hash(n,t))};function BP(n){let t=n.toString(16);return t.length%2===1&&(t=`0${t}`),te(t,"base16")}const Xw=64;class _s{constructor(t,e,r,s=2){p(this,"fp");p(this,"h");p(this,"seed");if(s>Xw)throw new TypeError("Invalid Fingerprint Size");const i=e.hashV(t,r),o=Ge(s);for(let a=0;a<o.length;a++)o[a]=i[a];o.length===0&&(o[0]=7),this.fp=o,this.h=e,this.seed=r}hash(){return this.h.hash(this.fp,this.seed)}equals(t){return t?.fp instanceof Uint8Array?It(this.fp,t.fp):!1}}function Yc(n,t){return Math.floor(Math.random()*(t-n))+n}class Ua{constructor(t){p(this,"contents");this.contents=new Array(t).fill(null)}has(t){if(!(t instanceof _s))throw new TypeError("Invalid Fingerprint");return this.contents.some(e=>t.equals(e))}add(t){if(!(t instanceof _s))throw new TypeError("Invalid Fingerprint");for(let e=0;e<this.contents.length;e++)if(this.contents[e]==null)return this.contents[e]=t,!0;return!0}swap(t){if(!(t instanceof _s))throw new TypeError("Invalid Fingerprint");const e=Yc(0,this.contents.length-1),r=this.contents[e];return this.contents[e]=t,r}remove(t){if(!(t instanceof _s))throw new TypeError("Invalid Fingerprint");const e=this.contents.findIndex(r=>t.equals(r));return e>-1?(this.contents[e]=null,!0):!1}}const NP=500;class Og{constructor(t){p(this,"bucketSize");p(this,"filterSize");p(this,"fingerprintSize");p(this,"buckets");p(this,"count");p(this,"hash");p(this,"seed");this.filterSize=t.filterSize,this.bucketSize=t.bucketSize??4,this.fingerprintSize=t.fingerprintSize??2,this.count=0,this.buckets=[],this.hash=t.hash??Wf,this.seed=t.seed??Yc(0,Math.pow(2,10))}add(t){typeof t=="string"&&(t=te(t));const e=new _s(t,this.hash,this.seed,this.fingerprintSize),r=this.hash.hash(t,this.seed)%this.filterSize,s=(r^e.hash())%this.filterSize;if(this.buckets[r]==null&&(this.buckets[r]=new Ua(this.bucketSize)),this.buckets[s]==null&&(this.buckets[s]=new Ua(this.bucketSize)),this.buckets[r].add(e)||this.buckets[s].add(e))return this.count++,!0;const i=[r,s];let o=i[Yc(0,i.length-1)];this.buckets[o]==null&&(this.buckets[o]=new Ua(this.bucketSize));for(let a=0;a<NP;a++){const l=this.buckets[o].swap(e);if(l!=null&&(o=(o^l.hash())%this.filterSize,this.buckets[o]==null&&(this.buckets[o]=new Ua(this.bucketSize)),this.buckets[o].add(l)))return this.count++,!0}return!1}has(t){typeof t=="string"&&(t=te(t));const e=new _s(t,this.hash,this.seed,this.fingerprintSize),r=this.hash.hash(t,this.seed)%this.filterSize,s=this.buckets[r]?.has(e)??!1;if(s)return s;const i=(r^e.hash())%this.filterSize;return this.buckets[i]?.has(e)??!1}remove(t){typeof t=="string"&&(t=te(t));const e=new _s(t,this.hash,this.seed,this.fingerprintSize),r=this.hash.hash(t,this.seed)%this.filterSize,s=this.buckets[r]?.remove(e)??!1;if(s)return this.count--,s;const i=(r^e.hash())%this.filterSize,o=this.buckets[i]?.remove(e)??!1;return o&&this.count--,o}get reliable(){return Math.floor(100*(this.count/this.filterSize))<=90}}const RP={1:.5,2:.84,4:.95,8:.98};function OP(n=.001){return n>.002?2:n>1e-5?4:8}function FP(n,t=.001){const e=OP(t),r=RP[e],s=Math.round(n/r),i=Math.min(Math.ceil(Math.log2(1/t)+Math.log2(2*e)),Xw);return{filterSize:s,bucketSize:e,fingerprintSize:i}}class $P{constructor(t){p(this,"filterSize");p(this,"bucketSize");p(this,"fingerprintSize");p(this,"scale");p(this,"filterSeries");p(this,"hash");p(this,"seed");this.bucketSize=t.bucketSize??4,this.filterSize=t.filterSize??(1<<18)/this.bucketSize,this.fingerprintSize=t.fingerprintSize??2,this.scale=t.scale??2,this.hash=t.hash??Wf,this.seed=t.seed??Yc(0,Math.pow(2,10)),this.filterSeries=[new Og({filterSize:this.filterSize,bucketSize:this.bucketSize,fingerprintSize:this.fingerprintSize,hash:this.hash,seed:this.seed})]}add(t){if(typeof t=="string"&&(t=te(t)),this.has(t))return!0;let e=this.filterSeries.find(r=>r.reliable);if(e==null){const r=this.filterSize*Math.pow(this.scale,this.filterSeries.length);e=new Og({filterSize:r,bucketSize:this.bucketSize,fingerprintSize:this.fingerprintSize,hash:this.hash,seed:this.seed}),this.filterSeries.push(e)}return e.add(t)}has(t){typeof t=="string"&&(t=te(t));for(let e=0;e<this.filterSeries.length;e++)if(this.filterSeries[e].has(t))return!0;return!1}remove(t){typeof t=="string"&&(t=te(t));for(let e=0;e<this.filterSeries.length;e++)if(this.filterSeries[e].remove(t))return!0;return!1}get count(){return this.filterSeries.reduce((t,e)=>t+e.count,0)}}function ia(n,t=.001,e){return new $P({...FP(n,t)})}class UP{constructor(t,e){p(this,"filter");this.filter=ia(t,e)}has(t){return this.filter.has(t.toMultihash().bytes)}add(t){this.filter.add(t.toMultihash().bytes)}remove(t){this.filter.remove?.(t.toMultihash().bytes)}}function VP(n,t=.001){return new UP(n,t)}function Fg(n){const{stream:t,remoteAddr:e,logger:r,onDataRead:s,onDataWrite:i}=n,o=r.forComponent("libp2p:stream:converter");let a=!1,l=!1;const u=t.close.bind(t);t.close=async g=>{await u(g),f(!0)};const h=t.abort.bind(t);t.abort=g=>{h(g),f(!0)};const c=t.sink.bind(t);t.sink=async g=>{try{await c(Br(g,y=>xw(y,m=>i?.(m))))}catch(y){y.type!=="aborted"&&o.error("%s error in sink",e,y)}finally{l=!0,f()}};const d={log:o,sink:t.sink,source:async function*(){try{for await(const g of t.source)s?.(g),yield g}finally{a=!0,f()}}(),remoteAddr:e,timeline:{open:Date.now(),close:void 0},close:t.close,abort:t.abort};function f(g){g===!0&&(a=!0,l=!0),a&&l&&d.timeline.close==null&&(d.timeline.close=Date.now())}return d}class vt extends Event{constructor(e,r){super(e);p(this,"type");p(this,"detail");this.type=e,this.detail=r}}let HP=class extends Error{constructor(e,r){super(e??"The operation was aborted");p(this,"type");p(this,"code");this.type="aborted",this.name="AbortError",this.code=r??"ABORT_ERR"}};async function nc(n,t,e,r){const s=new HP(r?.errorMessage,r?.errorCode);return e?.aborted===!0?Promise.reject(s):new Promise((i,o)=>{function a(){e?.removeEventListener("abort",h),n.removeEventListener(t,l),r?.errorEvent!=null&&n.removeEventListener(r.errorEvent,u)}const l=c=>{try{if(r?.filter?.(c)===!1)return}catch(d){a(),o(d);return}a(),i(c)},u=c=>{a(),o(c.detail)},h=()=>{a(),o(s)};e?.addEventListener("abort",h),n.addEventListener(t,l),r?.errorEvent!=null&&n.addEventListener(r.errorEvent,u)})}class zP extends Error{constructor(e="Rate limit exceeded",r){super(e);p(this,"remainingPoints");p(this,"msBeforeNext");p(this,"consumedPoints");p(this,"isFirstInDuration");this.name="RateLimitError",this.remainingPoints=r.remainingPoints,this.msBeforeNext=r.msBeforeNext,this.consumedPoints=r.consumedPoints,this.isFirstInDuration=r.isFirstInDuration}}class jw extends Error{constructor(t="The queue was full"){super(t),this.name="QueueFullError"}}p(jw,"name","QueueFullError");class qP{constructor(t){p(this,"deferred");p(this,"signal");this.signal=t,this.deferred=bt(),this.onAbort=this.onAbort.bind(this),this.signal?.addEventListener("abort",this.onAbort)}onAbort(){this.deferred.reject(this.signal?.reason??new Ls)}cleanup(){this.signal?.removeEventListener("abort",this.onAbort)}}function WP(){return`${parseInt(String(Math.random()*1e9),10).toString()}${Date.now()}`}class GP{constructor(t,e){p(this,"id");p(this,"fn");p(this,"options");p(this,"recipients");p(this,"status");p(this,"timeline");p(this,"controller");this.id=WP(),this.status="queued",this.fn=t,this.options=e,this.recipients=[],this.timeline={created:Date.now()},this.controller=new AbortController,this.controller.signal,this.onAbort=this.onAbort.bind(this)}abort(t){this.controller.abort(t)}onAbort(){this.recipients.reduce((e,r)=>e&&r.signal?.aborted===!0,!0)&&(this.controller.abort(new Ls),this.cleanup())}async join(t={}){const e=new qP(t.signal);return this.recipients.push(e),t.signal?.addEventListener("abort",this.onAbort),e.deferred.promise}async run(){this.status="running",this.timeline.started=Date.now();try{this.controller.signal.throwIfAborted();const t=await Ir(this.fn({...this.options??{},signal:this.controller.signal}),this.controller.signal);this.recipients.forEach(e=>{e.deferred.resolve(t)}),this.status="complete"}catch(t){this.recipients.forEach(e=>{e.deferred.reject(t)}),this.status="errored"}finally{this.timeline.finished=Date.now(),this.cleanup()}}cleanup(){this.recipients.forEach(t=>{t.cleanup(),t.signal?.removeEventListener("abort",this.onAbort)})}}class Jw extends ar{constructor(e={}){super();p(this,"concurrency");p(this,"maxSize");p(this,"queue");p(this,"pending");p(this,"sort");this.concurrency=e.concurrency??Number.POSITIVE_INFINITY,this.maxSize=e.maxSize??Number.POSITIVE_INFINITY,this.pending=0,e.metricName!=null&&e.metrics?.registerMetricGroup(e.metricName,{calculate:()=>({size:this.queue.length,running:this.pending,queued:this.queue.length-this.pending})}),this.sort=e.sort,this.queue=[]}tryToStartAnother(){if(this.size===0)return queueMicrotask(()=>{this.safeDispatchEvent("empty")}),this.running===0&&queueMicrotask(()=>{this.safeDispatchEvent("idle")}),!1;if(this.pending<this.concurrency){let e;for(const r of this.queue)if(r.status==="queued"){e=r;break}return e==null?!1:(this.safeDispatchEvent("active"),this.pending++,e.run().finally(()=>{for(let r=0;r<this.queue.length;r++)if(this.queue[r]===e){this.queue.splice(r,1);break}this.pending--,this.tryToStartAnother(),this.safeDispatchEvent("next")}),!0)}return!1}enqueue(e){this.queue.push(e),this.sort!=null&&this.queue.sort(this.sort)}async add(e,r){if(r?.signal?.throwIfAborted(),this.size===this.maxSize)throw new jw;const s=new GP(e,r);return this.enqueue(s),this.safeDispatchEvent("add"),this.tryToStartAnother(),s.join(r).then(i=>(this.safeDispatchEvent("completed",{detail:i}),this.safeDispatchEvent("success",{detail:{job:s,result:i}}),i)).catch(i=>{if(s.status==="queued"){for(let o=0;o<this.queue.length;o++)if(this.queue[o]===s){this.queue.splice(o,1);break}}throw this.safeDispatchEvent("error",{detail:i}),this.safeDispatchEvent("failure",{detail:{job:s,error:i}}),i})}clear(){this.queue.splice(0,this.queue.length)}abort(){this.queue.forEach(e=>{e.abort(new Ls)}),this.clear()}async onEmpty(e){this.size!==0&&await nc(this,"empty",e?.signal)}async onSizeLessThan(e,r){this.size<e||await nc(this,"next",r?.signal,{filter:()=>this.size<e})}async onIdle(e){this.pending===0&&this.size===0||await nc(this,"idle",e?.signal)}get size(){return this.queue.length}get queued(){return this.queue.length-this.pending}get running(){return this.pending}async*toGenerator(e){e?.signal?.throwIfAborted();const r=us({objectMode:!0}),s=u=>{u!=null?this.abort():this.clear(),r.end(u)},i=u=>{u.detail!=null&&r.push(u.detail)},o=u=>{s(u.detail)},a=()=>{s()},l=()=>{s(new Ls("Queue aborted"))};this.addEventListener("completed",i),this.addEventListener("error",o),this.addEventListener("idle",a),e?.signal?.addEventListener("abort",l);try{yield*r}finally{this.removeEventListener("completed",i),this.removeEventListener("error",o),this.removeEventListener("idle",a),e?.signal?.removeEventListener("abort",l),s()}}}class Gf extends Jw{has(t){return this.find(t)!=null}find(t){return this.queue.find(e=>t.equals(e.options.peerId))}}class KP extends ar{constructor(e,r={}){super();p(this,"peerStore");p(this,"registrar");p(this,"connectionManager");p(this,"randomWalk");p(this,"started");p(this,"running");p(this,"topologyId");p(this,"log");p(this,"discoveryController");p(this,"filter");p(this,"queue");this.log=e.logger.forComponent("libp2p:circuit-relay:discover-relays"),this.started=!1,this.running=!1,this.peerStore=e.peerStore,this.registrar=e.registrar,this.connectionManager=e.connectionManager,this.randomWalk=e.randomWalk,this.filter=r.filter,this.discoveryController=new AbortController,this.discoveryController.signal}isStarted(){return this.started}async start(){this.topologyId=await this.registrar.register(Uc,{filter:this.filter,onConnect:e=>{this.log.trace("discovered relay %p queue (length: %d, active %d)",e,this.queue?.size,this.queue?.running),this.safeDispatchEvent("relay:discover",{detail:e})}}),this.started=!0}stop(){this.topologyId!=null&&this.registrar.unregister(this.topologyId),this.discoveryController?.abort(),this.started=!1}startDiscovery(){this.running||(this.log("start discovery"),this.running=!0,this.discoveryController=new AbortController,this.discoveryController.signal,Promise.resolve().then(async()=>{this.log("searching peer store for relays");const e=await this.peerStore.all({filters:[s=>s.protocols.includes(Uc)],orders:[()=>Math.random()<.5?1:-1,(s,i)=>{const o=$g(s),a=$g(i);return o>a?-1:a>o?1:0}]});for(const s of e)this.log.trace("found relay peer %p in peer store",s.id),this.safeDispatchEvent("relay:discover",{detail:s.id});this.log("found %d relay peers in peer store",e.length);const r=this.queue=new Gf({concurrency:5});this.log("start random walk");for await(const s of this.randomWalk.walk({signal:this.discoveryController.signal})){if(this.log.trace("found random peer %p",s.id),r.has(s.id)){this.log.trace("random peer %p was already in queue",s.id);continue}if(this.connectionManager.getConnections(s.id)?.length>0){this.log.trace("random peer %p was already connected",s.id);continue}if(!await this.connectionManager.isDialable(s.multiaddrs)){this.log.trace("random peer %p was not dialable",s.id,s.multiaddrs.map(i=>i.toString()));continue}r.queued>10&&(this.log.trace("wait for space in queue for %p",s.id),await r.onSizeLessThan(10,{signal:this.discoveryController.signal})),this.log("adding random peer %p to dial queue (length: %d, active %d)",s.id,r.size,r.running),r.add(async()=>{const i=Qi([this.discoveryController.signal,AbortSignal.timeout(5e3)]);try{await this.connectionManager.openConnection(s.id,{signal:i})}finally{i.clear()}},{peerId:s.id,signal:this.discoveryController.signal}).catch(i=>{this.log.error("error opening connection to random peer %p",s.id,i)})}this.log("stop random walk"),await r.onIdle()}).catch(e=>{this.discoveryController.signal.aborted||this.log.error("failed when finding relays on the network",e)}))}stopDiscovery(){this.log("stop discovery"),this.running=!1,this.discoveryController?.abort()}}function $g(n){const t=n.metadata.get("last-dial-success");return t==null?0:new Date(de(t)).getTime()}class YP extends ar{constructor(e,r={}){super();p(this,"connectionManager");p(this,"addressManager");p(this,"reservationStore");p(this,"listeningAddrs");p(this,"log");p(this,"listenTimeout");p(this,"reservationId");p(this,"relay");p(this,"_onRemoveRelayPeer",e=>{this.log("relay removed %p our relay %p",e.detail.relay,this.relay,this.relay?.equals(e.detail.relay)),this.relay?.equals(e.detail.relay)===!0&&(this.log("relay peer removed %p",e.detail.relay),this.listeningAddrs.forEach(r=>{this.addressManager.removeObservedAddr(r)}),this.listeningAddrs=[],this.safeDispatchEvent("listening"))});p(this,"_onAddRelayPeer",e=>{const{details:r}=e.detail;r.type!=="configured"&&r.id===this.reservationId&&this.addedRelay(e.detail)});this.log=e.logger.forComponent("libp2p:circuit-relay:transport:listener"),this.connectionManager=e.connectionManager,this.addressManager=e.addressManager,this.reservationStore=e.reservationStore,this.listeningAddrs=[],this.listenTimeout=r.listenTimeout??Fw,this.reservationStore.addEventListener("relay:removed",this._onRemoveRelayPeer),this.reservationStore.addEventListener("relay:created-reservation",this._onAddRelayPeer)}async listen(e){if(Yw.exactMatch(e))this.log("searching for circuit relay servers"),this.reservationId=this.reservationStore.reserveRelay();else if(Kw.exactMatch(e)){this.log("listen on specific relay server %a",e);const r=AbortSignal.timeout(this.listenTimeout),s=e.decapsulate("/p2p-circuit"),i=await this.connectionManager.openConnection(s,{signal:r});if(!this.reservationStore.hasReservation(i.remotePeer)){this.log("making reservation on peer %p",i.remotePeer);const o=await this.reservationStore.addRelay(i.remotePeer,"configured");this.addedRelay(o)}}else throw new Ec(`Could not listen on p2p-circuit address "${e}"`)}getAddrs(){return[...this.listeningAddrs.values()].flat()}updateAnnounceAddrs(){}async close(){this.reservationStore.cancelReservations(),this.listeningAddrs=[],this.reservationStore.removeEventListener("relay:removed",this._onRemoveRelayPeer),queueMicrotask(()=>{this.safeDispatchEvent("close")})}addedRelay(e){this.log("relay peer added %p",e.relay),this.relay=e.relay,this.listeningAddrs=e.details.reservation.addrs.map(r=>me(r).encapsulate("/p2p-circuit")),this.listeningAddrs.forEach(r=>{this.addressManager.confirmObservedAddr(r,{type:"transport"})}),queueMicrotask(()=>{this.safeDispatchEvent("listening")})}}function QP(n){return new YP(n)}const ZP="useandom-26T198340PX75pxJACKVERYMINDBUSHWOLF_GQZbfghjklqvwyzrict";let XP=(n=21)=>{let t="",e=crypto.getRandomValues(new Uint8Array(n|=0));for(;n--;)t+=ZP[e[n]&63];return t};const jP=60*1e3*10,JP=60*1e3*5,eD=30*1e3;var on,e0,Po,Do;class tD extends ar{constructor(e,r){super();_e(this,on);p(this,"peerId");p(this,"connectionManager");p(this,"peerStore");p(this,"events");p(this,"reserveQueue");p(this,"reservations");p(this,"pendingReservations");p(this,"maxReservationQueueLength");p(this,"reservationCompletionTimeout");p(this,"started");p(this,"log");p(this,"relayFilter");this.log=e.logger.forComponent("libp2p:circuit-relay:transport:reservation-store"),this.peerId=e.peerId,this.connectionManager=e.connectionManager,this.peerStore=e.peerStore,this.events=e.events,this.reservations=new Zl,this.pendingReservations=[],this.maxReservationQueueLength=r?.maxReservationQueueLength??vP,this.reservationCompletionTimeout=r?.reservationCompletionTimeout??Fw,this.started=!1,this.relayFilter=ia(100),this.reserveQueue=new Gf({concurrency:r?.reservationConcurrency??yP,metricName:"libp2p_relay_reservation_queue",metrics:e.metrics}),this.events.addEventListener("connection:close",s=>{[...this.reservations.values()].find(o=>o.connection===s.detail.id)!=null&&ue(this,on,Po).call(this,s.detail.remotePeer).catch(o=>{this.log("could not remove relay %p - %e",s.detail,o)})})}isStarted(){return this.started}start(){this.started=!0}afterStart(){Promise.resolve().then(async()=>{const e=await this.peerStore.all({filters:[r=>r.tags.has($a)]});this.log("removing tag from %d old relays",e.length),await Promise.all(e.map(async r=>{await this.peerStore.merge(r.id,{tags:{[$a]:void 0}})})),this.log("redialing %d old relays",e.length),await Promise.all(e.map(async r=>this.addRelay(r.id,"discovered"))),ue(this,on,Do).call(this)}).catch(e=>{this.log.error(e)})}stop(){this.reserveQueue.clear(),this.reservations.forEach(({timeout:e})=>{clearTimeout(e)}),this.reservations.clear(),this.started=!1}reserveRelay(){const e=XP();return this.pendingReservations.push(e),ue(this,on,Do).call(this),e}async addRelay(e,r){if(this.peerId.equals(e))throw this.log.trace("not trying to use self as relay"),new Ec("Cannot use self as relay");if(this.reserveQueue.size>this.maxReservationQueueLength)throw new Gw("The reservation queue is full");const s=this.reserveQueue.find(e);if(s!=null)return this.log.trace("potential relay peer %p is already in the reservation queue",e),s.join();if(this.relayFilter.has(e.toMultihash().bytes))throw new Ec("The relay was previously invalid");return this.log.trace("try to reserve relay slot with %p",e),this.reserveQueue.add(async()=>{const i=Date.now();try{const o=this.reservations.get(e);if(o!=null){const y=this.connectionManager.getConnections(e);let m=!1;if(y.length===0&&this.log("already have relay reservation with %p but we are no longer connected",e),y.map(v=>v.id).includes(o.connection)&&(this.log("already have relay reservation with %p and the original connection is still open",e),m=!0),m&&Ng(o.reservation.expire)>jP)return this.log("already have relay reservation with %p but we are still connected and it does not expire soon",e),{relay:e,details:o};await ue(this,on,Po).call(this,e)}if(r==="discovered"&&this.pendingReservations.length===0)throw new Jd("Not making reservation on discovered relay because we do not need any more relays");const a=AbortSignal.timeout(this.reservationCompletionTimeout);const l=await this.connectionManager.openConnection(e,{signal:a});if(sa.matches(l.remoteAddr))throw new Ww("not creating reservation over relayed connection");const u=await ue(this,on,e0).call(this,l,{signal:a}),h=Ng(u.expire);this.log("created reservation on relay peer %p, expiry date is %s",e,new Date(Date.now()+h).toString());const c=Math.min(Math.max(h-JP,eD),Math.pow(2,31)-1),d=setTimeout(()=>{this.log("refresh reservation to relay %p",e),this.addRelay(e,r).catch(async y=>{this.log.error("could not refresh reservation to relay %p - %e",e,y),await ue(this,on,Po).call(this,e)}).catch(y=>{this.log.error("could not remove expired reservation to relay %p - %e",e,y)})},c);let f;if(r==="discovered"){const y=this.pendingReservations.pop();if(y==null)throw new Jd("Made reservation on relay but did not need any more discovered relays");f={timeout:d,reservation:u,type:r,connection:l.id,id:y}}else f={timeout:d,reservation:u,type:r,connection:l.id};this.reservations.set(e,f),await this.peerStore.merge(e,{tags:{[$a]:{value:1,ttl:h}}}),ue(this,on,Do).call(this);const g={relay:e,details:f};return this.safeDispatchEvent("relay:created-reservation",{detail:g}),g}catch(o){throw r==="discovered"&&o.name==="HadEnoughRelaysError"||this.log.error("could not reserve slot on %p after %dms - %e",e,Date.now()-i,o),(o.name==="DialError"||o.name==="UnsupportedProtocolError")&&this.relayFilter.add(e.toMultihash().bytes),ue(this,on,Po).call(this,e).catch(a=>{this.log.error("could not remove reservation on %p after reserving slot failed - %e",e,a)}),o}},{peerId:e})}hasReservation(e){return this.reservations.has(e)}getReservation(e){return this.reservations.get(e)?.reservation}reservationCount(e){return e==null?this.reservations.size:[...this.reservations.values()].reduce((r,s)=>(s.type===e&&r++,r),0)}cancelReservations(){[...this.reservations.values()].forEach(e=>{clearTimeout(e.timeout)}),this.reservations.clear()}}on=new WeakSet,e0=async function(e,r){r.signal?.throwIfAborted(),this.log("requesting reservation from %p",e.remotePeer);const s=await e.newStream(Uc,r),o=Wi(s).pb(Gi);this.log.trace("send RESERVE to %p",e.remotePeer),await o.write({type:Gi.Type.RESERVE},r);let a;try{this.log.trace("reading response from %p",e.remotePeer),a=await o.read(r)}catch(u){throw s.abort(u),u}finally{s.status!=="closed"&&await s.close(r)}if(this.log.trace("read response %o",a),a.status===Gt.OK&&a.reservation!=null){const u=new Set;u.add(e.remoteAddr.toString());for(const h of a.reservation.addrs){let c=me(h);c.getPeerId()==null&&(c=c.encapsulate(`/p2p/${e.remotePeer}`)),c=me(c.toString().replace(`/p2p/${e.remotePeer}/p2p/${e.remotePeer}`,`/p2p/${e.remotePeer}`)),u.add(c.toString())}return a.reservation.addrs=[...u].map(h=>me(h).bytes),a.reservation}const l=`reservation failed with status ${a.status??"undefined"}`;throw this.log.error(l),new Error(l)},Po=async function(e){const r=this.reservations.get(e);r!=null&&(this.log("removing relay reservation with %p from local store",e),clearTimeout(r.timeout),this.reservations.delete(e),r.type==="discovered"&&this.pendingReservations.push(r.id),await this.peerStore.merge(e,{tags:{[$a]:void 0}}),this.safeDispatchEvent("relay:removed",{detail:{relay:e,details:r}}),ue(this,on,Do).call(this))},Do=function(){if(this.pendingReservations.length===0){this.log.trace("have discovered enough relays"),this.reserveQueue.clear(),this.safeDispatchEvent("relay:found-enough-relays");return}this.relayFilter=ia(100),this.log("not discovered enough relays %d/%d",this.reservations.size,this.pendingReservations.length),this.safeDispatchEvent("relay:not-enough-relays")};const nD=n=>{if(n.peer==null)return!1;try{n.peer.addrs.forEach(me)}catch{return!1}return!0},Ug={maxInboundStopStreams:Cg,maxOutboundStopStreams:Cg};var hy,fy,py,gy;class rD{constructor(t,e={}){p(this,"discovery");p(this,"registrar");p(this,"peerStore");p(this,"connectionManager");p(this,"transportManager");p(this,"peerId");p(this,"upgrader");p(this,"addressManager");p(this,"connectionGater");p(this,"reservationStore");p(this,"logger");p(this,"maxInboundStopStreams");p(this,"maxOutboundStopStreams");p(this,"started");p(this,"log");p(this,"shutdownController");p(this,gy,"@libp2p/circuit-relay-v2-transport");p(this,py,["@libp2p/transport","@libp2p/circuit-relay-v2-transport"]);p(this,hy,!0);this.log=t.logger.forComponent("libp2p:circuit-relay:transport"),this.registrar=t.registrar,this.peerStore=t.peerStore,this.connectionManager=t.connectionManager,this.transportManager=t.transportManager,this.logger=t.logger,this.peerId=t.peerId,this.upgrader=t.upgrader,this.addressManager=t.addressManager,this.connectionGater=t.connectionGater,this.maxInboundStopStreams=e.maxInboundStopStreams??Ug.maxInboundStopStreams,this.maxOutboundStopStreams=e.maxOutboundStopStreams??Ug.maxOutboundStopStreams,this.shutdownController=new AbortController,this.discovery=new KP(t,{filter:e.discoveryFilter??VP(bP,wP)}),this.discovery.addEventListener("relay:discover",r=>{this.reservationStore.addRelay(r.detail,"discovered").catch(s=>{s.name!=="HadEnoughRelaysError"&&s.name!=="RelayQueueFullError"&&this.log.error("could not add discovered relay %p",r.detail,s)})}),this.reservationStore=new tD(t,e),this.reservationStore.addEventListener("relay:not-enough-relays",()=>{this.discovery?.startDiscovery()}),this.reservationStore.addEventListener("relay:found-enough-relays",()=>{this.discovery?.stopDiscovery()}),this.started=!1}get[(gy=Symbol.toStringTag,py=Wn,fy=Ac,hy=tb,fy)](){return this.discovery!=null?["@libp2p/identify"]:[]}isStarted(){return this.started}async start(){this.shutdownController=new AbortController,await this.registrar.handle(Tg,t=>{const e=this.upgrader.createInboundAbortSignal(this.shutdownController.signal);this.onStop(t,e).catch(r=>{this.log.error("error while handling STOP protocol",r),t.stream.abort(r)}).finally(()=>{e.clear()})},{maxInboundStreams:this.maxInboundStopStreams,maxOutboundStreams:this.maxOutboundStopStreams,runOnLimitedConnection:!0}),await ub(this.discovery,this.reservationStore),this.started=!0}async stop(){this.shutdownController.abort(),await db(this.discovery,this.reservationStore),await this.registrar.unhandle(Tg),this.started=!1}async dial(t,e){if(t.protoCodes().filter(f=>f===mP).length!==1){const f="Invalid circuit relay address";throw this.log.error(f,t),new Ei(f)}const r=t.toString().split("/p2p-circuit"),s=me(r[0]),i=me(r[r.length-1]),o=s.getPeerId(),a=i.getPeerId();if(o==null||a==null){const f=`ircuit relay dial to ${t.toString()} failed as address did not have both relay and destination PeerIDs`;throw this.log.error(`c${f}`),new Ei(`C${f}`)}const l=Bt(o),u=Bt(a);let c=this.connectionManager.getConnections(l)[0];c==null?(await this.peerStore.merge(l,{multiaddrs:[s]}),e.onProgress?.(new vt("circuit-relay:open-connection")),c=await this.connectionManager.openConnection(l,e)):e.onProgress?.(new vt("circuit-relay:reuse-connection"));let d;try{e.onProgress?.(new vt("circuit-relay:open-hop-stream")),d=await c.newStream(Uc,e);const f=Wi(d),g=f.pb(Gi);e.onProgress?.(new vt("circuit-relay:write-connect-message")),await g.write({type:Gi.Type.CONNECT,peer:{id:u.toMultihash().bytes,addrs:[me(i).bytes]}},e),e.onProgress?.(new vt("circuit-relay:read-connect-response"));const y=await g.read(e);if(y.status!==Gt.OK)throw new jn(`failed to connect via relay with status ${y?.status?.toString()??"undefined"}`);const m=new Rg(y.limit),v=Fg({stream:f.unwrap(),remoteAddr:t,localAddr:s.encapsulate(`/p2p-circuit/p2p/${this.peerId.toString()}`),logger:this.logger,onDataRead:m.onData,onDataWrite:m.onData});return this.log("new outbound relayed connection %a",v.remoteAddr),await this.upgrader.upgradeOutbound(v,{...e,limits:m.getLimits()})}catch(f){throw this.log.error("circuit relay dial to destination %p via relay %p failed",u,l,f),d?.abort(f),f}}createListener(t){return QP({peerId:this.peerId,connectionManager:this.connectionManager,addressManager:this.addressManager,reservationStore:this.reservationStore,logger:this.logger})}listenFilter(t){return t=Array.isArray(t)?t:[t],t.filter(e=>Kw.exactMatch(e)||Yw.exactMatch(e))}dialFilter(t){return t=Array.isArray(t)?t:[t],t.filter(e=>sa.exactMatch(e))}async onStop({connection:t,stream:e},r){if(!this.reservationStore.hasReservation(t.remotePeer))try{this.log("dialed via relay we did not have a reservation on, start listening on that relay address"),await this.transportManager.listen([t.remoteAddr.encapsulate("/p2p-circuit")])}catch(h){this.log.error("failed to listen on a relay peer we were dialed via but did not have a reservation on",h)}const s=Wi(e).pb(mr),i=await s.read({signal:r});if(this.log("new circuit relay v2 stop stream from %p with type %s",t.remotePeer,i.type),i?.type===void 0){this.log.error("type was missing from circuit v2 stop protocol request from %s",t.remotePeer),await s.write({type:mr.Type.STATUS,status:Gt.MALFORMED_MESSAGE},{signal:r}),await e.close();return}if(i.type!==mr.Type.CONNECT){this.log.error("invalid stop connect request via peer %p",t.remotePeer),await s.write({type:mr.Type.STATUS,status:Gt.UNEXPECTED_MESSAGE},{signal:r}),await e.close();return}if(!nD(i)){this.log.error("invalid stop connect request via peer %p",t.remotePeer),await s.write({type:mr.Type.STATUS,status:Gt.MALFORMED_MESSAGE},{signal:r}),await e.close({signal:r});return}const o=Qs($r(i.peer.id));if(await this.connectionGater.denyInboundRelayedConnection?.(t.remotePeer,o)===!0){this.log.error("connection gater denied inbound relayed connection from %p",t.remotePeer),await s.write({type:mr.Type.STATUS,status:Gt.PERMISSION_DENIED},{signal:r}),await e.close({signal:r});return}this.log.trace("sending success response to %p",t.remotePeer),await s.write({type:mr.Type.STATUS,status:Gt.OK},{signal:r});const a=new Rg(i.limit),l=t.remoteAddr.encapsulate(`/p2p-circuit/p2p/${o.toString()}`);this.addressManager.getAddresses()[0];const u=Fg({stream:s.unwrap().unwrap(),remoteAddr:l,logger:this.logger,onDataRead:a.onData,onDataWrite:a.onData});this.log("new inbound relayed connection %a",u.remoteAddr),await this.upgrader.upgradeInbound(u,{limits:a.getLimits(),signal:r}),this.log("%s connection %a upgraded","inbound",u.remoteAddr)}}function sD(n={}){return t=>new rD(t,n)}const pr="/",t0=new TextEncoder().encode(pr),Va=t0[0];class ut{constructor(t,e){p(this,"_buf");if(typeof t=="string")this._buf=te(t);else if(t instanceof Uint8Array)this._buf=t;else throw new Error("Invalid key, should be String of Uint8Array");if(e==null&&(e=!0),e&&this.clean(),this._buf.byteLength===0||this._buf[0]!==Va)throw new Error("Invalid key")}toString(t="utf8"){return de(this._buf,t)}uint8Array(){return this._buf}get[Symbol.toStringTag](){return`Key(${this.toString()})`}static withNamespaces(t){return new ut(t.join(pr))}static random(){return new ut(Math.random().toString().substring(2))}static asKey(t){return t instanceof Uint8Array||typeof t=="string"?new ut(t):typeof t.uint8Array=="function"?new ut(t.uint8Array()):null}clean(){if((this._buf==null||this._buf.byteLength===0)&&(this._buf=t0),this._buf[0]!==Va){const t=new Uint8Array(this._buf.byteLength+1);t.fill(Va,0,1),t.set(this._buf,1),this._buf=t}for(;this._buf.byteLength>1&&this._buf[this._buf.byteLength-1]===Va;)this._buf=this._buf.subarray(0,-1)}less(t){const e=this.list(),r=t.list();for(let s=0;s<e.length;s++){if(r.length<s+1)return!1;const i=e[s],o=r[s];if(i<o)return!0;if(i>o)return!1}return e.length<r.length}reverse(){return ut.withNamespaces(this.list().slice().reverse())}namespaces(){return this.list()}baseNamespace(){const t=this.namespaces();return t[t.length-1]}list(){return this.toString().split(pr).slice(1)}type(){return iD(this.baseNamespace())}name(){return oD(this.baseNamespace())}instance(t){return new ut(this.toString()+":"+t)}path(){let t=this.parent().toString();return t.endsWith(pr)||(t+=pr),t+=this.type(),new ut(t)}parent(){const t=this.list();return t.length===1?new ut(pr):new ut(t.slice(0,-1).join(pr))}child(t){return this.toString()===pr?t:t.toString()===pr?this:new ut(this.toString()+t.toString(),!1)}isAncestorOf(t){return t.toString()===this.toString()?!1:t.toString().startsWith(this.toString())}isDecendantOf(t){return t.toString()===this.toString()?!1:this.toString().startsWith(t.toString())}isTopLevel(){return this.list().length===1}concat(...t){return ut.withNamespaces([...this.namespaces(),...aD(t.map(e=>e.namespaces()))])}}function iD(n){const t=n.split(":");return t.length<2?"":t.slice(0,-1).join(":")}function oD(n){const t=n.split(":");return t[t.length-1]}function aD(n){return[].concat(...n)}var Pu,Vg;function cD(){return Vg||(Vg=1,Pu=n=>{if(Object.prototype.toString.call(n)!=="[object Object]")return!1;const t=Object.getPrototypeOf(n);return t===null||t===Object.prototype}),Pu}var Ha,Hg;function lD(){if(Hg)return Ha;Hg=1;const n=cD(),{hasOwnProperty:t}=Object.prototype,{propertyIsEnumerable:e}=Object,r=(f,g,y)=>Object.defineProperty(f,g,{value:y,writable:!0,enumerable:!0,configurable:!0}),s=Ha,i={concatArrays:!1,ignoreUndefined:!1},o=f=>{const g=[];for(const y in f)t.call(f,y)&&g.push(y);if(Object.getOwnPropertySymbols){const y=Object.getOwnPropertySymbols(f);for(const m of y)e.call(f,m)&&g.push(m)}return g};function a(f){return Array.isArray(f)?l(f):n(f)?u(f):f}function l(f){const g=f.slice(0,0);return o(f).forEach(y=>{r(g,y,a(f[y]))}),g}function u(f){const g=Object.getPrototypeOf(f)===null?Object.create(null):{};return o(f).forEach(y=>{r(g,y,a(f[y]))}),g}const h=(f,g,y,m)=>(y.forEach(v=>{typeof g[v]>"u"&&m.ignoreUndefined||(v in f&&f[v]!==Object.getPrototypeOf(f)?r(f,v,d(f[v],g[v],m)):r(f,v,a(g[v])))}),f),c=(f,g,y)=>{let m=f.slice(0,0),v=0;return[f,g].forEach(_=>{const w=[];for(let S=0;S<_.length;S++)t.call(_,S)&&(w.push(String(S)),_===f?r(m,v++,_[S]):r(m,v++,a(_[S])));m=h(m,_,o(_).filter(S=>!w.includes(S)),y)}),m};function d(f,g,y){return y.concatArrays&&Array.isArray(f)&&Array.isArray(g)?c(f,g,y):!n(g)||!n(f)?a(g):h(f,g,o(g),y)}return Ha=function(...f){const g=d(a(i),this!==s&&this||{},i);let y={_:{}};for(const m of f)if(m!==void 0){if(!n(m))throw new TypeError("`"+m+"` is not an Option Object");y=d(y,{_:m},g)}return y._},Ha}var uD=lD();const Kf=co(uD);var Du,zg;function dD(){if(zg)return Du;zg=1;function n(e){return e>=55296&&e<=56319}function t(e){return e>=56320&&e<=57343}return Du=function(r,s,i){if(typeof s!="string")throw new Error("Input must be string");for(var o=s.length,a=0,l,u,h=0;h<o;h+=1){if(l=s.charCodeAt(h),u=s[h],n(l)&&t(s.charCodeAt(h+1))&&(h+=1,u+=s[h]),a+=r(u),a===i)return s.slice(0,h+1);if(a>i)return s.slice(0,h-u.length+1)}return s},Du}var Mu,qg;function hD(){if(qg)return Mu;qg=1;function n(e){return e>=55296&&e<=56319}function t(e){return e>=56320&&e<=57343}return Mu=function(r){if(typeof r!="string")throw new Error("Input must be string");for(var s=r.length,i=0,o=null,a=null,l=0;l<s;l++)o=r.charCodeAt(l),t(o)?a!=null&&n(a)?i+=1:i+=3:o<=127?i+=1:o>=128&&o<=2047?i+=2:o>=2048&&o<=65535&&(i+=3),a=o;return i},Mu}var Lu,Wg;function fD(){if(Wg)return Lu;Wg=1;var n=dD(),t=hD();return Lu=n.bind(null,t),Lu}var Bu,Gg;function pD(){if(Gg)return Bu;Gg=1;var n=fD(),t=/[\/\?<>\\:\*\|"]/g,e=/[\x00-\x1f\x80-\x9f]/g,r=/^\.+$/,s=/^(con|prn|aux|nul|com[0-9]|lpt[0-9])(\..*)?$/i,i=/[\. ]+$/;function o(a,l){if(typeof a!="string")throw new Error("Input must be string");var u=a.replace(t,l).replace(e,l).replace(r,l).replace(s,l).replace(i,l);return n(u,255)}return Bu=function(a,l){var u=l&&l.replacement||"",h=o(a,u);return u===""?h:o(h,"")},Bu}var gD=pD();const mD=co(gD),Nu={alg:"A128GCM",ext:!0,k:"scm9jmO_4BJAgdwWGVulLg",key_ops:["encrypt","decrypt"],kty:"oct"};function n0(n){const t="AES-GCM";let e=16;const r=12,s="SHA-256",i=16,o=32767,a=lr.get();e*=8;async function l(c,d){const f=a.getRandomValues(new Uint8Array(i)),g=a.getRandomValues(new Uint8Array(r)),y={name:t,iv:g};typeof d=="string"&&(d=te(d));let m;if(d.length===0){m=await a.subtle.importKey("jwk",Nu,{name:"AES-GCM"},!0,["encrypt"]);try{const _={name:"PBKDF2",salt:f,iterations:o,hash:{name:s}},w=await a.subtle.importKey("raw",d,{name:"PBKDF2"},!1,["deriveKey"]);m=await a.subtle.deriveKey(_,w,{name:t,length:e},!0,["encrypt"])}catch{m=await a.subtle.importKey("jwk",Nu,{name:"AES-GCM"},!0,["encrypt"])}}else{const _={name:"PBKDF2",salt:f,iterations:o,hash:{name:s}},w=await a.subtle.importKey("raw",d,{name:"PBKDF2"},!1,["deriveKey"]);m=await a.subtle.deriveKey(_,w,{name:t,length:e},!0,["encrypt"])}const v=await a.subtle.encrypt(y,m,c);return bn([f,y.iv,new Uint8Array(v)])}async function u(c,d){const f=c.subarray(0,i),g=c.subarray(i,i+r),y=c.subarray(i+r),m={name:t,iv:g};typeof d=="string"&&(d=te(d));let v;if(d.length===0)try{const w={name:"PBKDF2",salt:f,iterations:o,hash:{name:s}},S=await a.subtle.importKey("raw",d,{name:"PBKDF2"},!1,["deriveKey"]);v=await a.subtle.deriveKey(w,S,{name:t,length:e},!0,["decrypt"])}catch{v=await a.subtle.importKey("jwk",Nu,{name:"AES-GCM"},!0,["decrypt"])}else{const w={name:"PBKDF2",salt:f,iterations:o,hash:{name:s}},S=await a.subtle.importKey("raw",d,{name:"PBKDF2"},!1,["deriveKey"]);v=await a.subtle.deriveKey(w,S,{name:t,length:e},!0,["decrypt"])}const _=await a.subtle.decrypt(m,v,y);return new Uint8Array(_)}return{encrypt:l,decrypt:u}}/*!
 * MIT License
 * 
 * Copyright (c) 2017-2024 Peculiar Ventures, LLC
 * 
 * Permission is hereby granted, free of charge, to any person obtaining a copy
 * of this software and associated documentation files (the "Software"), to deal
 * in the Software without restriction, including without limitation the rights
 * to use, copy, modify, merge, publish, distribute, sublicense, and/or sell
 * copies of the Software, and to permit persons to whom the Software is
 * furnished to do so, subject to the following conditions:
 * 
 * The above copyright notice and this permission notice shall be included in all
 * copies or substantial portions of the Software.
 * 
 * THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR
 * IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,
 * FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE
 * AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER
 * LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,
 * OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN THE
 * SOFTWARE.
 * 
 */const yD="[object ArrayBuffer]";class He{static isArrayBuffer(t){return Object.prototype.toString.call(t)===yD}static toArrayBuffer(t){return this.isArrayBuffer(t)?t:t.byteLength===t.buffer.byteLength||t.byteOffset===0&&t.byteLength===t.buffer.byteLength?t.buffer:this.toUint8Array(t.buffer).slice(t.byteOffset,t.byteOffset+t.byteLength).buffer}static toUint8Array(t){return this.toView(t,Uint8Array)}static toView(t,e){if(t.constructor===e)return t;if(this.isArrayBuffer(t))return new e(t);if(this.isArrayBufferView(t))return new e(t.buffer,t.byteOffset,t.byteLength);throw new TypeError("The provided value is not of type '(ArrayBuffer or ArrayBufferView)'")}static isBufferSource(t){return this.isArrayBufferView(t)||this.isArrayBuffer(t)}static isArrayBufferView(t){return ArrayBuffer.isView(t)||t&&this.isArrayBuffer(t.buffer)}static isEqual(t,e){const r=He.toUint8Array(t),s=He.toUint8Array(e);if(r.length!==s.byteLength)return!1;for(let i=0;i<r.length;i++)if(r[i]!==s[i])return!1;return!0}static concat(...t){let e;Array.isArray(t[0])&&!(t[1]instanceof Function)||Array.isArray(t[0])&&t[1]instanceof Function?e=t[0]:t[t.length-1]instanceof Function?e=t.slice(0,t.length-1):e=t;let r=0;for(const o of e)r+=o.byteLength;const s=new Uint8Array(r);let i=0;for(const o of e){const a=this.toUint8Array(o);s.set(a,i),i+=a.length}return t[t.length-1]instanceof Function?this.toView(s,t[t.length-1]):s.buffer}}const Ru="string",vD=/^[0-9a-f\s]+$/i,bD=/^(?:[A-Za-z0-9+/]{4})*(?:[A-Za-z0-9+/]{2}==|[A-Za-z0-9+/]{3}=)?$/,wD=/^[a-zA-Z0-9-_]+$/;class Kg{static fromString(t){const e=unescape(encodeURIComponent(t)),r=new Uint8Array(e.length);for(let s=0;s<e.length;s++)r[s]=e.charCodeAt(s);return r.buffer}static toString(t){const e=He.toUint8Array(t);let r="";for(let i=0;i<e.length;i++)r+=String.fromCharCode(e[i]);return decodeURIComponent(escape(r))}}class Qn{static toString(t,e=!1){const r=He.toArrayBuffer(t),s=new DataView(r);let i="";for(let o=0;o<r.byteLength;o+=2){const a=s.getUint16(o,e);i+=String.fromCharCode(a)}return i}static fromString(t,e=!1){const r=new ArrayBuffer(t.length*2),s=new DataView(r);for(let i=0;i<t.length;i++)s.setUint16(i*2,t.charCodeAt(i),e);return r}}class rt{static isHex(t){return typeof t===Ru&&vD.test(t)}static isBase64(t){return typeof t===Ru&&bD.test(t)}static isBase64Url(t){return typeof t===Ru&&wD.test(t)}static ToString(t,e="utf8"){const r=He.toUint8Array(t);switch(e.toLowerCase()){case"utf8":return this.ToUtf8String(r);case"binary":return this.ToBinary(r);case"hex":return this.ToHex(r);case"base64":return this.ToBase64(r);case"base64url":return this.ToBase64Url(r);case"utf16le":return Qn.toString(r,!0);case"utf16":case"utf16be":return Qn.toString(r);default:throw new Error(`Unknown type of encoding '${e}'`)}}static FromString(t,e="utf8"){if(!t)return new ArrayBuffer(0);switch(e.toLowerCase()){case"utf8":return this.FromUtf8String(t);case"binary":return this.FromBinary(t);case"hex":return this.FromHex(t);case"base64":return this.FromBase64(t);case"base64url":return this.FromBase64Url(t);case"utf16le":return Qn.fromString(t,!0);case"utf16":case"utf16be":return Qn.fromString(t);default:throw new Error(`Unknown type of encoding '${e}'`)}}static ToBase64(t){const e=He.toUint8Array(t);if(typeof btoa<"u"){const r=this.ToString(e,"binary");return btoa(r)}else return Buffer.from(e).toString("base64")}static FromBase64(t){const e=this.formatString(t);if(!e)return new ArrayBuffer(0);if(!rt.isBase64(e))throw new TypeError("Argument 'base64Text' is not Base64 encoded");return typeof atob<"u"?this.FromBinary(atob(e)):new Uint8Array(Buffer.from(e,"base64")).buffer}static FromBase64Url(t){const e=this.formatString(t);if(!e)return new ArrayBuffer(0);if(!rt.isBase64Url(e))throw new TypeError("Argument 'base64url' is not Base64Url encoded");return this.FromBase64(this.Base64Padding(e.replace(/\-/g,"+").replace(/\_/g,"/")))}static ToBase64Url(t){return this.ToBase64(t).replace(/\+/g,"-").replace(/\//g,"_").replace(/\=/g,"")}static FromUtf8String(t,e=rt.DEFAULT_UTF8_ENCODING){switch(e){case"ascii":return this.FromBinary(t);case"utf8":return Kg.fromString(t);case"utf16":case"utf16be":return Qn.fromString(t);case"utf16le":case"usc2":return Qn.fromString(t,!0);default:throw new Error(`Unknown type of encoding '${e}'`)}}static ToUtf8String(t,e=rt.DEFAULT_UTF8_ENCODING){switch(e){case"ascii":return this.ToBinary(t);case"utf8":return Kg.toString(t);case"utf16":case"utf16be":return Qn.toString(t);case"utf16le":case"usc2":return Qn.toString(t,!0);default:throw new Error(`Unknown type of encoding '${e}'`)}}static FromBinary(t){const e=t.length,r=new Uint8Array(e);for(let s=0;s<e;s++)r[s]=t.charCodeAt(s);return r.buffer}static ToBinary(t){const e=He.toUint8Array(t);let r="";for(let s=0;s<e.length;s++)r+=String.fromCharCode(e[s]);return r}static ToHex(t){const e=He.toUint8Array(t);let r="";const s=e.length;for(let i=0;i<s;i++){const o=e[i];o<16&&(r+="0"),r+=o.toString(16)}return r}static FromHex(t){let e=this.formatString(t);if(!e)return new ArrayBuffer(0);if(!rt.isHex(e))throw new TypeError("Argument 'hexString' is not HEX encoded");e.length%2&&(e=`0${e}`);const r=new Uint8Array(e.length/2);for(let s=0;s<e.length;s=s+2){const i=e.slice(s,s+2);r[s/2]=parseInt(i,16)}return r.buffer}static ToUtf16String(t,e=!1){return Qn.toString(t,e)}static FromUtf16String(t,e=!1){return Qn.fromString(t,e)}static Base64Padding(t){const e=4-t.length%4;if(e<4)for(let r=0;r<e;r++)t+="=";return t}static formatString(t){return t?.replace(/[\n\r\t ]/g,"")||""}}rt.DEFAULT_UTF8_ENCODING="utf8";/*!
 Copyright (c) Peculiar Ventures, LLC
*/function Zi(n,t){let e=0;if(n.length===1)return n[0];for(let r=n.length-1;r>=0;r--)e+=n[n.length-1-r]*Math.pow(2,t*r);return e}function Vs(n,t,e=-1){const r=e;let s=n,i=0,o=Math.pow(2,t);for(let a=1;a<8;a++){if(n<o){let l;if(r<0)l=new ArrayBuffer(a),i=a;else{if(r<a)return new ArrayBuffer(0);l=new ArrayBuffer(r),i=r}const u=new Uint8Array(l);for(let h=a-1;h>=0;h--){const c=Math.pow(2,h*t);u[i-h-1]=Math.floor(s/c),s-=u[i-h-1]*c}return l}o*=Math.pow(2,t)}return new ArrayBuffer(0)}function eh(...n){let t=0,e=0;for(const i of n)t+=i.length;const r=new ArrayBuffer(t),s=new Uint8Array(r);for(const i of n)s.set(i,e),e+=i.length;return s}function r0(){const n=new Uint8Array(this.valueHex);if(this.valueHex.byteLength>=2){const a=n[0]===255&&n[1]&128,l=n[0]===0&&(n[1]&128)===0;(a||l)&&this.warnings.push("Needlessly long format")}const t=new ArrayBuffer(this.valueHex.byteLength),e=new Uint8Array(t);for(let a=0;a<this.valueHex.byteLength;a++)e[a]=0;e[0]=n[0]&128;const r=Zi(e,8),s=new ArrayBuffer(this.valueHex.byteLength),i=new Uint8Array(s);for(let a=0;a<this.valueHex.byteLength;a++)i[a]=n[a];return i[0]&=127,Zi(i,8)-r}function _D(n){const t=n<0?n*-1:n;let e=128;for(let r=1;r<8;r++){if(t<=e){if(n<0){const o=e-t,a=Vs(o,8,r),l=new Uint8Array(a);return l[0]|=128,a}let s=Vs(t,8,r),i=new Uint8Array(s);if(i[0]&128){const o=s.slice(0),a=new Uint8Array(o);s=new ArrayBuffer(s.byteLength+1),i=new Uint8Array(s);for(let l=0;l<o.byteLength;l++)i[l+1]=a[l];i[0]=0}return s}e*=Math.pow(2,8)}return new ArrayBuffer(0)}function SD(n,t){if(n.byteLength!==t.byteLength)return!1;const e=new Uint8Array(n),r=new Uint8Array(t);for(let s=0;s<e.length;s++)if(e[s]!==r[s])return!1;return!0}function pn(n,t){const e=n.toString(10);if(t<e.length)return"";const r=t-e.length,s=new Array(r);for(let o=0;o<r;o++)s[o]="0";return s.join("").concat(e)}/*!
 * Copyright (c) 2014, GMO GlobalSign
 * Copyright (c) 2015-2022, Peculiar Ventures
 * All rights reserved.
 * 
 * Author 2014-2019, Yury Strozhevsky
 * 
 * Redistribution and use in source and binary forms, with or without modification,
 * are permitted provided that the following conditions are met:
 * 
 * * Redistributions of source code must retain the above copyright notice, this
 *   list of conditions and the following disclaimer.
 * 
 * * Redistributions in binary form must reproduce the above copyright notice, this
 *   list of conditions and the following disclaimer in the documentation and/or
 *   other materials provided with the distribution.
 * 
 * * Neither the name of the copyright holder nor the names of its
 *   contributors may be used to endorse or promote products derived from
 *   this software without specific prior written permission.
 * 
 * THIS SOFTWARE IS PROVIDED BY THE COPYRIGHT HOLDERS AND CONTRIBUTORS "AS IS" AND
 * ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE IMPLIED
 * WARRANTIES OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE ARE
 * DISCLAIMED. IN NO EVENT SHALL THE COPYRIGHT HOLDER OR CONTRIBUTORS BE LIABLE FOR
 * ANY DIRECT, INDIRECT, INCIDENTAL, SPECIAL, EXEMPLARY, OR CONSEQUENTIAL DAMAGES
 * (INCLUDING, BUT NOT LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS OR SERVICES;
 * LOSS OF USE, DATA, OR PROFITS; OR BUSINESS INTERRUPTION) HOWEVER CAUSED AND ON
 * ANY THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT LIABILITY, OR TORT
 * (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY OUT OF THE USE OF THIS
 * SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF SUCH DAMAGE.
 * 
 */function Qc(){if(typeof BigInt>"u")throw new Error("BigInt is not defined. Your environment doesn't implement BigInt.")}function Yf(n){let t=0,e=0;for(let s=0;s<n.length;s++){const i=n[s];t+=i.byteLength}const r=new Uint8Array(t);for(let s=0;s<n.length;s++){const i=n[s];r.set(new Uint8Array(i),e),e+=i.byteLength}return r.buffer}function Ur(n,t,e,r){return t instanceof Uint8Array?t.byteLength?e<0?(n.error="Wrong parameter: inputOffset less than zero",!1):r<0?(n.error="Wrong parameter: inputLength less than zero",!1):t.byteLength-e-r<0?(n.error="End of input reached before message was fully decoded (inconsistent offset and length values)",!1):!0:(n.error="Wrong parameter: inputBuffer has zero length",!1):(n.error="Wrong parameter: inputBuffer must be 'Uint8Array'",!1)}class Qf{constructor(){this.items=[]}write(t){this.items.push(t)}final(){return Yf(this.items)}}const Ao=[new Uint8Array([1])],Yg="0123456789",fo="",Gn=new ArrayBuffer(0),Zf=new Uint8Array(0),oa="EndOfContent",s0="OCTET STRING",i0="BIT STRING";function Vr(n){var t;return t=class extends n{constructor(...r){var s;super(...r);const i=r[0]||{};this.isHexOnly=(s=i.isHexOnly)!==null&&s!==void 0?s:!1,this.valueHexView=i.valueHex?He.toUint8Array(i.valueHex):Zf}get valueHex(){return this.valueHexView.slice().buffer}set valueHex(r){this.valueHexView=new Uint8Array(r)}fromBER(r,s,i){const o=r instanceof ArrayBuffer?new Uint8Array(r):r;if(!Ur(this,o,s,i))return-1;const a=s+i;return this.valueHexView=o.subarray(s,a),this.valueHexView.length?(this.blockLength=i,a):(this.warnings.push("Zero buffer length"),s)}toBER(r=!1){return this.isHexOnly?r?new ArrayBuffer(this.valueHexView.byteLength):this.valueHexView.byteLength===this.valueHexView.buffer.byteLength?this.valueHexView.buffer:this.valueHexView.slice().buffer:(this.error="Flag 'isHexOnly' is not set, abort",Gn)}toJSON(){return{...super.toJSON(),isHexOnly:this.isHexOnly,valueHex:rt.ToHex(this.valueHexView)}}},t.NAME="hexBlock",t}class Zs{constructor({blockLength:t=0,error:e=fo,warnings:r=[],valueBeforeDecode:s=Zf}={}){this.blockLength=t,this.error=e,this.warnings=r,this.valueBeforeDecodeView=He.toUint8Array(s)}static blockName(){return this.NAME}get valueBeforeDecode(){return this.valueBeforeDecodeView.slice().buffer}set valueBeforeDecode(t){this.valueBeforeDecodeView=new Uint8Array(t)}toJSON(){return{blockName:this.constructor.NAME,blockLength:this.blockLength,error:this.error,warnings:this.warnings,valueBeforeDecode:rt.ToHex(this.valueBeforeDecodeView)}}}Zs.NAME="baseBlock";class un extends Zs{fromBER(t,e,r){throw TypeError("User need to make a specific function in a class which extends 'ValueBlock'")}toBER(t,e){throw TypeError("User need to make a specific function in a class which extends 'ValueBlock'")}}un.NAME="valueBlock";class o0 extends Vr(Zs){constructor({idBlock:t={}}={}){var e,r,s,i;super(),t?(this.isHexOnly=(e=t.isHexOnly)!==null&&e!==void 0?e:!1,this.valueHexView=t.valueHex?He.toUint8Array(t.valueHex):Zf,this.tagClass=(r=t.tagClass)!==null&&r!==void 0?r:-1,this.tagNumber=(s=t.tagNumber)!==null&&s!==void 0?s:-1,this.isConstructed=(i=t.isConstructed)!==null&&i!==void 0?i:!1):(this.tagClass=-1,this.tagNumber=-1,this.isConstructed=!1)}toBER(t=!1){let e=0;switch(this.tagClass){case 1:e|=0;break;case 2:e|=64;break;case 3:e|=128;break;case 4:e|=192;break;default:return this.error="Unknown tag class",Gn}if(this.isConstructed&&(e|=32),this.tagNumber<31&&!this.isHexOnly){const s=new Uint8Array(1);if(!t){let i=this.tagNumber;i&=31,e|=i,s[0]=e}return s.buffer}if(!this.isHexOnly){const s=Vs(this.tagNumber,7),i=new Uint8Array(s),o=s.byteLength,a=new Uint8Array(o+1);if(a[0]=e|31,!t){for(let l=0;l<o-1;l++)a[l+1]=i[l]|128;a[o]=i[o-1]}return a.buffer}const r=new Uint8Array(this.valueHexView.byteLength+1);if(r[0]=e|31,!t){const s=this.valueHexView;for(let i=0;i<s.length-1;i++)r[i+1]=s[i]|128;r[this.valueHexView.byteLength]=s[s.length-1]}return r.buffer}fromBER(t,e,r){const s=He.toUint8Array(t);if(!Ur(this,s,e,r))return-1;const i=s.subarray(e,e+r);if(i.length===0)return this.error="Zero buffer length",-1;switch(i[0]&192){case 0:this.tagClass=1;break;case 64:this.tagClass=2;break;case 128:this.tagClass=3;break;case 192:this.tagClass=4;break;default:return this.error="Unknown tag class",-1}this.isConstructed=(i[0]&32)===32,this.isHexOnly=!1;const a=i[0]&31;if(a!==31)this.tagNumber=a,this.blockLength=1;else{let l=1,u=this.valueHexView=new Uint8Array(255),h=255;for(;i[l]&128;){if(u[l-1]=i[l]&127,l++,l>=i.length)return this.error="End of input reached before message was fully decoded",-1;if(l===h){h+=255;const d=new Uint8Array(h);for(let f=0;f<u.length;f++)d[f]=u[f];u=this.valueHexView=new Uint8Array(h)}}this.blockLength=l+1,u[l-1]=i[l]&127;const c=new Uint8Array(l);for(let d=0;d<l;d++)c[d]=u[d];u=this.valueHexView=new Uint8Array(l),u.set(c),this.blockLength<=9?this.tagNumber=Zi(u,7):(this.isHexOnly=!0,this.warnings.push("Tag too long, represented as hex-coded"))}if(this.tagClass===1&&this.isConstructed)switch(this.tagNumber){case 1:case 2:case 5:case 6:case 9:case 13:case 14:case 23:case 24:case 31:case 32:case 33:case 34:return this.error="Constructed encoding used for primitive type",-1}return e+this.blockLength}toJSON(){return{...super.toJSON(),tagClass:this.tagClass,tagNumber:this.tagNumber,isConstructed:this.isConstructed}}}o0.NAME="identificationBlock";class a0 extends Zs{constructor({lenBlock:t={}}={}){var e,r,s;super(),this.isIndefiniteForm=(e=t.isIndefiniteForm)!==null&&e!==void 0?e:!1,this.longFormUsed=(r=t.longFormUsed)!==null&&r!==void 0?r:!1,this.length=(s=t.length)!==null&&s!==void 0?s:0}fromBER(t,e,r){const s=He.toUint8Array(t);if(!Ur(this,s,e,r))return-1;const i=s.subarray(e,e+r);if(i.length===0)return this.error="Zero buffer length",-1;if(i[0]===255)return this.error="Length block 0xFF is reserved by standard",-1;if(this.isIndefiniteForm=i[0]===128,this.isIndefiniteForm)return this.blockLength=1,e+this.blockLength;if(this.longFormUsed=!!(i[0]&128),this.longFormUsed===!1)return this.length=i[0],this.blockLength=1,e+this.blockLength;const o=i[0]&127;if(o>8)return this.error="Too big integer",-1;if(o+1>i.length)return this.error="End of input reached before message was fully decoded",-1;const a=e+1,l=s.subarray(a,a+o);return l[o-1]===0&&this.warnings.push("Needlessly long encoded length"),this.length=Zi(l,8),this.longFormUsed&&this.length<=127&&this.warnings.push("Unnecessary usage of long length form"),this.blockLength=o+1,e+this.blockLength}toBER(t=!1){let e,r;if(this.length>127&&(this.longFormUsed=!0),this.isIndefiniteForm)return e=new ArrayBuffer(1),t===!1&&(r=new Uint8Array(e),r[0]=128),e;if(this.longFormUsed){const s=Vs(this.length,8);if(s.byteLength>127)return this.error="Too big length",Gn;if(e=new ArrayBuffer(s.byteLength+1),t)return e;const i=new Uint8Array(s);r=new Uint8Array(e),r[0]=s.byteLength|128;for(let o=0;o<s.byteLength;o++)r[o+1]=i[o];return e}return e=new ArrayBuffer(1),t===!1&&(r=new Uint8Array(e),r[0]=this.length),e}toJSON(){return{...super.toJSON(),isIndefiniteForm:this.isIndefiniteForm,longFormUsed:this.longFormUsed,length:this.length}}}a0.NAME="lengthBlock";const j={};class Yt extends Zs{constructor({name:t=fo,optional:e=!1,primitiveSchema:r,...s}={},i){super(s),this.name=t,this.optional=e,r&&(this.primitiveSchema=r),this.idBlock=new o0(s),this.lenBlock=new a0(s),this.valueBlock=i?new i(s):new un(s)}fromBER(t,e,r){const s=this.valueBlock.fromBER(t,e,this.lenBlock.isIndefiniteForm?r:this.lenBlock.length);return s===-1?(this.error=this.valueBlock.error,s):(this.idBlock.error.length||(this.blockLength+=this.idBlock.blockLength),this.lenBlock.error.length||(this.blockLength+=this.lenBlock.blockLength),this.valueBlock.error.length||(this.blockLength+=this.valueBlock.blockLength),s)}toBER(t,e){const r=e||new Qf;e||c0(this);const s=this.idBlock.toBER(t);if(r.write(s),this.lenBlock.isIndefiniteForm)r.write(new Uint8Array([128]).buffer),this.valueBlock.toBER(t,r),r.write(new ArrayBuffer(2));else{const i=this.valueBlock.toBER(t);this.lenBlock.length=i.byteLength;const o=this.lenBlock.toBER(t);r.write(o),r.write(i)}return e?Gn:r.final()}toJSON(){const t={...super.toJSON(),idBlock:this.idBlock.toJSON(),lenBlock:this.lenBlock.toJSON(),valueBlock:this.valueBlock.toJSON(),name:this.name,optional:this.optional};return this.primitiveSchema&&(t.primitiveSchema=this.primitiveSchema.toJSON()),t}toString(t="ascii"){return t==="ascii"?this.onAsciiEncoding():rt.ToHex(this.toBER())}onAsciiEncoding(){return`${this.constructor.NAME} : ${rt.ToHex(this.valueBlock.valueBeforeDecodeView)}`}isEqual(t){if(this===t)return!0;if(!(t instanceof this.constructor))return!1;const e=this.toBER(),r=t.toBER();return SD(e,r)}}Yt.NAME="BaseBlock";function c0(n){if(n instanceof j.Constructed)for(const t of n.valueBlock.value)c0(t)&&(n.lenBlock.isIndefiniteForm=!0);return!!n.lenBlock.isIndefiniteForm}class l0 extends Yt{constructor({value:t=fo,...e}={},r){super(e,r),t&&this.fromString(t)}getValue(){return this.valueBlock.value}setValue(t){this.valueBlock.value=t}fromBER(t,e,r){const s=this.valueBlock.fromBER(t,e,this.lenBlock.isIndefiniteForm?r:this.lenBlock.length);return s===-1?(this.error=this.valueBlock.error,s):(this.fromBuffer(this.valueBlock.valueHexView),this.idBlock.error.length||(this.blockLength+=this.idBlock.blockLength),this.lenBlock.error.length||(this.blockLength+=this.lenBlock.blockLength),this.valueBlock.error.length||(this.blockLength+=this.valueBlock.blockLength),s)}onAsciiEncoding(){return`${this.constructor.NAME} : '${this.valueBlock.value}'`}}l0.NAME="BaseStringBlock";class u0 extends Vr(un){constructor({isHexOnly:t=!0,...e}={}){super(e),this.isHexOnly=t}}u0.NAME="PrimitiveValueBlock";var d0;class h0 extends Yt{constructor(t={}){super(t,u0),this.idBlock.isConstructed=!1}}d0=h0;j.Primitive=d0;h0.NAME="PRIMITIVE";function ED(n,t){if(n instanceof t)return n;const e=new t;return e.idBlock=n.idBlock,e.lenBlock=n.lenBlock,e.warnings=n.warnings,e.valueBeforeDecodeView=n.valueBeforeDecodeView,e}function Xl(n,t=0,e=n.length){const r=t;let s=new Yt({},un);const i=new Zs;if(!Ur(i,n,t,e))return s.error=i.error,{offset:-1,result:s};if(!n.subarray(t,t+e).length)return s.error="Zero buffer length",{offset:-1,result:s};let a=s.idBlock.fromBER(n,t,e);if(s.idBlock.warnings.length&&s.warnings.concat(s.idBlock.warnings),a===-1)return s.error=s.idBlock.error,{offset:-1,result:s};if(t=a,e-=s.idBlock.blockLength,a=s.lenBlock.fromBER(n,t,e),s.lenBlock.warnings.length&&s.warnings.concat(s.lenBlock.warnings),a===-1)return s.error=s.lenBlock.error,{offset:-1,result:s};if(t=a,e-=s.lenBlock.blockLength,!s.idBlock.isConstructed&&s.lenBlock.isIndefiniteForm)return s.error="Indefinite length form used for primitive encoding form",{offset:-1,result:s};let l=Yt;switch(s.idBlock.tagClass){case 1:if(s.idBlock.tagNumber>=37&&s.idBlock.isHexOnly===!1)return s.error="UNIVERSAL 37 and upper tags are reserved by ASN.1 standard",{offset:-1,result:s};switch(s.idBlock.tagNumber){case 0:if(s.idBlock.isConstructed&&s.lenBlock.length>0)return s.error="Type [UNIVERSAL 0] is reserved",{offset:-1,result:s};l=j.EndOfContent;break;case 1:l=j.Boolean;break;case 2:l=j.Integer;break;case 3:l=j.BitString;break;case 4:l=j.OctetString;break;case 5:l=j.Null;break;case 6:l=j.ObjectIdentifier;break;case 10:l=j.Enumerated;break;case 12:l=j.Utf8String;break;case 13:l=j.RelativeObjectIdentifier;break;case 14:l=j.TIME;break;case 15:return s.error="[UNIVERSAL 15] is reserved by ASN.1 standard",{offset:-1,result:s};case 16:l=j.Sequence;break;case 17:l=j.Set;break;case 18:l=j.NumericString;break;case 19:l=j.PrintableString;break;case 20:l=j.TeletexString;break;case 21:l=j.VideotexString;break;case 22:l=j.IA5String;break;case 23:l=j.UTCTime;break;case 24:l=j.GeneralizedTime;break;case 25:l=j.GraphicString;break;case 26:l=j.VisibleString;break;case 27:l=j.GeneralString;break;case 28:l=j.UniversalString;break;case 29:l=j.CharacterString;break;case 30:l=j.BmpString;break;case 31:l=j.DATE;break;case 32:l=j.TimeOfDay;break;case 33:l=j.DateTime;break;case 34:l=j.Duration;break;default:{const u=s.idBlock.isConstructed?new j.Constructed:new j.Primitive;u.idBlock=s.idBlock,u.lenBlock=s.lenBlock,u.warnings=s.warnings,s=u}}break;case 2:case 3:case 4:default:l=s.idBlock.isConstructed?j.Constructed:j.Primitive}return s=ED(s,l),a=s.fromBER(n,t,s.lenBlock.isIndefiniteForm?e:s.lenBlock.length),s.valueBeforeDecodeView=n.subarray(r,r+s.blockLength),{offset:a,result:s}}function Ou(n){if(!n.byteLength){const t=new Yt({},un);return t.error="Input buffer has zero length",{offset:-1,result:t}}return Xl(He.toUint8Array(n).slice(),0,n.byteLength)}function AD(n,t){return n?1:t}class is extends un{constructor({value:t=[],isIndefiniteForm:e=!1,...r}={}){super(r),this.value=t,this.isIndefiniteForm=e}fromBER(t,e,r){const s=He.toUint8Array(t);if(!Ur(this,s,e,r))return-1;if(this.valueBeforeDecodeView=s.subarray(e,e+r),this.valueBeforeDecodeView.length===0)return this.warnings.push("Zero buffer length"),e;let i=e;for(;AD(this.isIndefiniteForm,r)>0;){const o=Xl(s,i,r);if(o.offset===-1)return this.error=o.result.error,this.warnings.concat(o.result.warnings),-1;if(i=o.offset,this.blockLength+=o.result.blockLength,r-=o.result.blockLength,this.value.push(o.result),this.isIndefiniteForm&&o.result.constructor.NAME===oa)break}return this.isIndefiniteForm&&(this.value[this.value.length-1].constructor.NAME===oa?this.value.pop():this.warnings.push("No EndOfContent block encoded")),i}toBER(t,e){const r=e||new Qf;for(let s=0;s<this.value.length;s++)this.value[s].toBER(t,r);return e?Gn:r.final()}toJSON(){const t={...super.toJSON(),isIndefiniteForm:this.isIndefiniteForm,value:[]};for(const e of this.value)t.value.push(e.toJSON());return t}}is.NAME="ConstructedValueBlock";var f0;class po extends Yt{constructor(t={}){super(t,is),this.idBlock.isConstructed=!0}fromBER(t,e,r){this.valueBlock.isIndefiniteForm=this.lenBlock.isIndefiniteForm;const s=this.valueBlock.fromBER(t,e,this.lenBlock.isIndefiniteForm?r:this.lenBlock.length);return s===-1?(this.error=this.valueBlock.error,s):(this.idBlock.error.length||(this.blockLength+=this.idBlock.blockLength),this.lenBlock.error.length||(this.blockLength+=this.lenBlock.blockLength),this.valueBlock.error.length||(this.blockLength+=this.valueBlock.blockLength),s)}onAsciiEncoding(){const t=[];for(const r of this.valueBlock.value)t.push(r.toString("ascii").split(`
`).map(s=>`  ${s}`).join(`
`));const e=this.idBlock.tagClass===3?`[${this.idBlock.tagNumber}]`:this.constructor.NAME;return t.length?`${e} :
${t.join(`
`)}`:`${e} :`}}f0=po;j.Constructed=f0;po.NAME="CONSTRUCTED";class p0 extends un{fromBER(t,e,r){return e}toBER(t){return Gn}}p0.override="EndOfContentValueBlock";var g0;class m0 extends Yt{constructor(t={}){super(t,p0),this.idBlock.tagClass=1,this.idBlock.tagNumber=0}}g0=m0;j.EndOfContent=g0;m0.NAME=oa;var y0;class Zc extends Yt{constructor(t={}){super(t,un),this.idBlock.tagClass=1,this.idBlock.tagNumber=5}fromBER(t,e,r){return this.lenBlock.length>0&&this.warnings.push("Non-zero length of value block for Null type"),this.idBlock.error.length||(this.blockLength+=this.idBlock.blockLength),this.lenBlock.error.length||(this.blockLength+=this.lenBlock.blockLength),this.blockLength+=r,e+r>t.byteLength?(this.error="End of input reached before message was fully decoded (inconsistent offset and length values)",-1):e+r}toBER(t,e){const r=new ArrayBuffer(2);if(!t){const s=new Uint8Array(r);s[0]=5,s[1]=0}return e&&e.write(r),r}onAsciiEncoding(){return`${this.constructor.NAME}`}}y0=Zc;j.Null=y0;Zc.NAME="NULL";class v0 extends Vr(un){constructor({value:t,...e}={}){super(e),e.valueHex?this.valueHexView=He.toUint8Array(e.valueHex):this.valueHexView=new Uint8Array(1),t&&(this.value=t)}get value(){for(const t of this.valueHexView)if(t>0)return!0;return!1}set value(t){this.valueHexView[0]=t?255:0}fromBER(t,e,r){const s=He.toUint8Array(t);return Ur(this,s,e,r)?(this.valueHexView=s.subarray(e,e+r),r>1&&this.warnings.push("Boolean value encoded in more then 1 octet"),this.isHexOnly=!0,r0.call(this),this.blockLength=r,e+r):-1}toBER(){return this.valueHexView.slice()}toJSON(){return{...super.toJSON(),value:this.value}}}v0.NAME="BooleanValueBlock";var b0;let w0=class extends Yt{constructor(t={}){super(t,v0),this.idBlock.tagClass=1,this.idBlock.tagNumber=1}getValue(){return this.valueBlock.value}setValue(t){this.valueBlock.value=t}onAsciiEncoding(){return`${this.constructor.NAME} : ${this.getValue}`}};b0=w0;j.Boolean=b0;w0.NAME="BOOLEAN";class _0 extends Vr(is){constructor({isConstructed:t=!1,...e}={}){super(e),this.isConstructed=t}fromBER(t,e,r){let s=0;if(this.isConstructed){if(this.isHexOnly=!1,s=is.prototype.fromBER.call(this,t,e,r),s===-1)return s;for(let i=0;i<this.value.length;i++){const o=this.value[i].constructor.NAME;if(o===oa){if(this.isIndefiniteForm)break;return this.error="EndOfContent is unexpected, OCTET STRING may consists of OCTET STRINGs only",-1}if(o!==s0)return this.error="OCTET STRING may consists of OCTET STRINGs only",-1}}else this.isHexOnly=!0,s=super.fromBER(t,e,r),this.blockLength=r;return s}toBER(t,e){return this.isConstructed?is.prototype.toBER.call(this,t,e):t?new ArrayBuffer(this.valueHexView.byteLength):this.valueHexView.slice().buffer}toJSON(){return{...super.toJSON(),isConstructed:this.isConstructed}}}_0.NAME="OctetStringValueBlock";var S0;class ss extends Yt{constructor({idBlock:t={},lenBlock:e={},...r}={}){var s,i;(s=r.isConstructed)!==null&&s!==void 0||(r.isConstructed=!!(!((i=r.value)===null||i===void 0)&&i.length)),super({idBlock:{isConstructed:r.isConstructed,...t},lenBlock:{...e,isIndefiniteForm:!!r.isIndefiniteForm},...r},_0),this.idBlock.tagClass=1,this.idBlock.tagNumber=4}fromBER(t,e,r){if(this.valueBlock.isConstructed=this.idBlock.isConstructed,this.valueBlock.isIndefiniteForm=this.lenBlock.isIndefiniteForm,r===0)return this.idBlock.error.length===0&&(this.blockLength+=this.idBlock.blockLength),this.lenBlock.error.length===0&&(this.blockLength+=this.lenBlock.blockLength),e;if(!this.valueBlock.isConstructed){const i=(t instanceof ArrayBuffer?new Uint8Array(t):t).subarray(e,e+r);try{if(i.byteLength){const o=Xl(i,0,i.byteLength);o.offset!==-1&&o.offset===r&&(this.valueBlock.value=[o.result])}}catch{}}return super.fromBER(t,e,r)}onAsciiEncoding(){return this.valueBlock.isConstructed||this.valueBlock.value&&this.valueBlock.value.length?po.prototype.onAsciiEncoding.call(this):`${this.constructor.NAME} : ${rt.ToHex(this.valueBlock.valueHexView)}`}getValue(){if(!this.idBlock.isConstructed)return this.valueBlock.valueHexView.slice().buffer;const t=[];for(const e of this.valueBlock.value)e instanceof ss&&t.push(e.valueBlock.valueHexView);return He.concat(t)}}S0=ss;j.OctetString=S0;ss.NAME=s0;class E0 extends Vr(is){constructor({unusedBits:t=0,isConstructed:e=!1,...r}={}){super(r),this.unusedBits=t,this.isConstructed=e,this.blockLength=this.valueHexView.byteLength}fromBER(t,e,r){if(!r)return e;let s=-1;if(this.isConstructed){if(s=is.prototype.fromBER.call(this,t,e,r),s===-1)return s;for(const a of this.value){const l=a.constructor.NAME;if(l===oa){if(this.isIndefiniteForm)break;return this.error="EndOfContent is unexpected, BIT STRING may consists of BIT STRINGs only",-1}if(l!==i0)return this.error="BIT STRING may consists of BIT STRINGs only",-1;const u=a.valueBlock;if(this.unusedBits>0&&u.unusedBits>0)return this.error='Using of "unused bits" inside constructive BIT STRING allowed for least one only',-1;this.unusedBits=u.unusedBits}return s}const i=He.toUint8Array(t);if(!Ur(this,i,e,r))return-1;const o=i.subarray(e,e+r);if(this.unusedBits=o[0],this.unusedBits>7)return this.error="Unused bits for BitString must be in range 0-7",-1;if(!this.unusedBits){const a=o.subarray(1);try{if(a.byteLength){const l=Xl(a,0,a.byteLength);l.offset!==-1&&l.offset===r-1&&(this.value=[l.result])}}catch{}}return this.valueHexView=o.subarray(1),this.blockLength=o.length,e+r}toBER(t,e){if(this.isConstructed)return is.prototype.toBER.call(this,t,e);if(t)return new ArrayBuffer(this.valueHexView.byteLength+1);if(!this.valueHexView.byteLength)return Gn;const r=new Uint8Array(this.valueHexView.length+1);return r[0]=this.unusedBits,r.set(this.valueHexView,1),r.buffer}toJSON(){return{...super.toJSON(),unusedBits:this.unusedBits,isConstructed:this.isConstructed}}}E0.NAME="BitStringValueBlock";var A0;class x0 extends Yt{constructor({idBlock:t={},lenBlock:e={},...r}={}){var s,i;(s=r.isConstructed)!==null&&s!==void 0||(r.isConstructed=!!(!((i=r.value)===null||i===void 0)&&i.length)),super({idBlock:{isConstructed:r.isConstructed,...t},lenBlock:{...e,isIndefiniteForm:!!r.isIndefiniteForm},...r},E0),this.idBlock.tagClass=1,this.idBlock.tagNumber=3}fromBER(t,e,r){return this.valueBlock.isConstructed=this.idBlock.isConstructed,this.valueBlock.isIndefiniteForm=this.lenBlock.isIndefiniteForm,super.fromBER(t,e,r)}onAsciiEncoding(){if(this.valueBlock.isConstructed||this.valueBlock.value&&this.valueBlock.value.length)return po.prototype.onAsciiEncoding.call(this);{const t=[],e=this.valueBlock.valueHexView;for(const s of e)t.push(s.toString(2).padStart(8,"0"));const r=t.join("");return`${this.constructor.NAME} : ${r.substring(0,r.length-this.valueBlock.unusedBits)}`}}}A0=x0;j.BitString=A0;x0.NAME=i0;var I0;function xD(n,t){const e=new Uint8Array([0]),r=new Uint8Array(n),s=new Uint8Array(t);let i=r.slice(0);const o=i.length-1,a=s.slice(0),l=a.length-1;let u=0;const h=l<o?o:l;let c=0;for(let d=h;d>=0;d--,c++){switch(!0){case c<a.length:u=i[o-c]+a[l-c]+e[0];break;default:u=i[o-c]+e[0]}switch(e[0]=u/10,!0){case c>=i.length:i=eh(new Uint8Array([u%10]),i);break;default:i[o-c]=u%10}}return e[0]>0&&(i=eh(e,i)),i}function Qg(n){if(n>=Ao.length)for(let t=Ao.length;t<=n;t++){const e=new Uint8Array([0]);let r=Ao[t-1].slice(0);for(let s=r.length-1;s>=0;s--){const i=new Uint8Array([(r[s]<<1)+e[0]]);e[0]=i[0]/10,r[s]=i[0]%10}e[0]>0&&(r=eh(e,r)),Ao.push(r)}return Ao[n]}function ID(n,t){let e=0;const r=new Uint8Array(n),s=new Uint8Array(t),i=r.slice(0),o=i.length-1,a=s.slice(0),l=a.length-1;let u,h=0;for(let c=l;c>=0;c--,h++)switch(u=i[o-h]-a[l-h]-e,!0){case u<0:e=1,i[o-h]=u+10;break;default:e=0,i[o-h]=u}if(e>0)for(let c=o-l+1;c>=0;c--,h++)if(u=i[o-h]-e,u<0)e=1,i[o-h]=u+10;else{e=0,i[o-h]=u;break}return i.slice()}class Xf extends Vr(un){constructor({value:t,...e}={}){super(e),this._valueDec=0,e.valueHex&&this.setValueHex(),t!==void 0&&(this.valueDec=t)}setValueHex(){this.valueHexView.length>=4?(this.warnings.push("Too big Integer for decoding, hex only"),this.isHexOnly=!0,this._valueDec=0):(this.isHexOnly=!1,this.valueHexView.length>0&&(this._valueDec=r0.call(this)))}set valueDec(t){this._valueDec=t,this.isHexOnly=!1,this.valueHexView=new Uint8Array(_D(t))}get valueDec(){return this._valueDec}fromDER(t,e,r,s=0){const i=this.fromBER(t,e,r);if(i===-1)return i;const o=this.valueHexView;return o[0]===0&&(o[1]&128)!==0?this.valueHexView=o.subarray(1):s!==0&&o.length<s&&(s-o.length>1&&(s=o.length+1),this.valueHexView=o.subarray(s-o.length)),i}toDER(t=!1){const e=this.valueHexView;switch(!0){case(e[0]&128)!==0:{const r=new Uint8Array(this.valueHexView.length+1);r[0]=0,r.set(e,1),this.valueHexView=r}break;case(e[0]===0&&(e[1]&128)===0):this.valueHexView=this.valueHexView.subarray(1);break}return this.toBER(t)}fromBER(t,e,r){const s=super.fromBER(t,e,r);return s===-1||this.setValueHex(),s}toBER(t){return t?new ArrayBuffer(this.valueHexView.length):this.valueHexView.slice().buffer}toJSON(){return{...super.toJSON(),valueDec:this.valueDec}}toString(){const t=this.valueHexView.length*8-1;let e=new Uint8Array(this.valueHexView.length*8/3),r=0,s;const i=this.valueHexView;let o="",a=!1;for(let l=i.byteLength-1;l>=0;l--){s=i[l];for(let u=0;u<8;u++){if((s&1)===1)switch(r){case t:e=ID(Qg(r),e),o="-";break;default:e=xD(e,Qg(r))}r++,s>>=1}}for(let l=0;l<e.length;l++)e[l]&&(a=!0),a&&(o+=Yg.charAt(e[l]));return a===!1&&(o+=Yg.charAt(0)),o}}I0=Xf;Xf.NAME="IntegerValueBlock";Object.defineProperty(I0.prototype,"valueHex",{set:function(n){this.valueHexView=new Uint8Array(n),this.setValueHex()},get:function(){return this.valueHexView.slice().buffer}});var k0;class rr extends Yt{constructor(t={}){super(t,Xf),this.idBlock.tagClass=1,this.idBlock.tagNumber=2}toBigInt(){return Qc(),BigInt(this.valueBlock.toString())}static fromBigInt(t){Qc();const e=BigInt(t),r=new Qf,s=e.toString(16).replace(/^-/,""),i=new Uint8Array(rt.FromHex(s));if(e<0){const a=new Uint8Array(i.length+(i[0]&128?1:0));a[0]|=128;const u=BigInt(`0x${rt.ToHex(a)}`)+e,h=He.toUint8Array(rt.FromHex(u.toString(16)));h[0]|=128,r.write(h)}else i[0]&128&&r.write(new Uint8Array([0])),r.write(i);return new rr({valueHex:r.final()})}convertToDER(){const t=new rr({valueHex:this.valueBlock.valueHexView});return t.valueBlock.toDER(),t}convertFromDER(){return new rr({valueHex:this.valueBlock.valueHexView[0]===0?this.valueBlock.valueHexView.subarray(1):this.valueBlock.valueHexView})}onAsciiEncoding(){return`${this.constructor.NAME} : ${this.valueBlock.toString()}`}}k0=rr;j.Integer=k0;rr.NAME="INTEGER";var T0;class C0 extends rr{constructor(t={}){super(t),this.idBlock.tagClass=1,this.idBlock.tagNumber=10}}T0=C0;j.Enumerated=T0;C0.NAME="ENUMERATED";class th extends Vr(un){constructor({valueDec:t=-1,isFirstSid:e=!1,...r}={}){super(r),this.valueDec=t,this.isFirstSid=e}fromBER(t,e,r){if(!r)return e;const s=He.toUint8Array(t);if(!Ur(this,s,e,r))return-1;const i=s.subarray(e,e+r);this.valueHexView=new Uint8Array(r);for(let a=0;a<r&&(this.valueHexView[a]=i[a]&127,this.blockLength++,(i[a]&128)!==0);a++);const o=new Uint8Array(this.blockLength);for(let a=0;a<this.blockLength;a++)o[a]=this.valueHexView[a];return this.valueHexView=o,(i[this.blockLength-1]&128)!==0?(this.error="End of input reached before message was fully decoded",-1):(this.valueHexView[0]===0&&this.warnings.push("Needlessly long format of SID encoding"),this.blockLength<=8?this.valueDec=Zi(this.valueHexView,7):(this.isHexOnly=!0,this.warnings.push("Too big SID for decoding, hex only")),e+this.blockLength)}set valueBigInt(t){Qc();let e=BigInt(t).toString(2);for(;e.length%7;)e="0"+e;const r=new Uint8Array(e.length/7);for(let s=0;s<r.length;s++)r[s]=parseInt(e.slice(s*7,s*7+7),2)+(s+1<r.length?128:0);this.fromBER(r.buffer,0,r.length)}toBER(t){if(this.isHexOnly){if(t)return new ArrayBuffer(this.valueHexView.byteLength);const s=this.valueHexView,i=new Uint8Array(this.blockLength);for(let o=0;o<this.blockLength-1;o++)i[o]=s[o]|128;return i[this.blockLength-1]=s[this.blockLength-1],i.buffer}const e=Vs(this.valueDec,7);if(e.byteLength===0)return this.error="Error during encoding SID value",Gn;const r=new Uint8Array(e.byteLength);if(!t){const s=new Uint8Array(e),i=e.byteLength-1;for(let o=0;o<i;o++)r[o]=s[o]|128;r[i]=s[i]}return r}toString(){let t="";if(this.isHexOnly)t=rt.ToHex(this.valueHexView);else if(this.isFirstSid){let e=this.valueDec;this.valueDec<=39?t="0.":this.valueDec<=79?(t="1.",e-=40):(t="2.",e-=80),t+=e.toString()}else t=this.valueDec.toString();return t}toJSON(){return{...super.toJSON(),valueDec:this.valueDec,isFirstSid:this.isFirstSid}}}th.NAME="sidBlock";class P0 extends un{constructor({value:t=fo,...e}={}){super(e),this.value=[],t&&this.fromString(t)}fromBER(t,e,r){let s=e;for(;r>0;){const i=new th;if(s=i.fromBER(t,s,r),s===-1)return this.blockLength=0,this.error=i.error,s;this.value.length===0&&(i.isFirstSid=!0),this.blockLength+=i.blockLength,r-=i.blockLength,this.value.push(i)}return s}toBER(t){const e=[];for(let r=0;r<this.value.length;r++){const s=this.value[r].toBER(t);if(s.byteLength===0)return this.error=this.value[r].error,Gn;e.push(s)}return Yf(e)}fromString(t){this.value=[];let e=0,r=0,s="",i=!1;do if(r=t.indexOf(".",e),r===-1?s=t.substring(e):s=t.substring(e,r),e=r+1,i){const o=this.value[0];let a=0;switch(o.valueDec){case 0:break;case 1:a=40;break;case 2:a=80;break;default:this.value=[];return}const l=parseInt(s,10);if(isNaN(l))return;o.valueDec=l+a,i=!1}else{const o=new th;if(s>Number.MAX_SAFE_INTEGER){Qc();const a=BigInt(s);o.valueBigInt=a}else if(o.valueDec=parseInt(s,10),isNaN(o.valueDec))return;this.value.length||(o.isFirstSid=!0,i=!0),this.value.push(o)}while(r!==-1)}toString(){let t="",e=!1;for(let r=0;r<this.value.length;r++){e=this.value[r].isHexOnly;let s=this.value[r].toString();r!==0&&(t=`${t}.`),e?(s=`{${s}}`,this.value[r].isFirstSid?t=`2.{${s} - 80}`:t+=s):t+=s}return t}toJSON(){const t={...super.toJSON(),value:this.toString(),sidArray:[]};for(let e=0;e<this.value.length;e++)t.sidArray.push(this.value[e].toJSON());return t}}P0.NAME="ObjectIdentifierValueBlock";var D0;class vs extends Yt{constructor(t={}){super(t,P0),this.idBlock.tagClass=1,this.idBlock.tagNumber=6}getValue(){return this.valueBlock.toString()}setValue(t){this.valueBlock.fromString(t)}onAsciiEncoding(){return`${this.constructor.NAME} : ${this.valueBlock.toString()||"empty"}`}toJSON(){return{...super.toJSON(),value:this.getValue()}}}D0=vs;j.ObjectIdentifier=D0;vs.NAME="OBJECT IDENTIFIER";class nh extends Vr(Zs){constructor({valueDec:t=0,...e}={}){super(e),this.valueDec=t}fromBER(t,e,r){if(r===0)return e;const s=He.toUint8Array(t);if(!Ur(this,s,e,r))return-1;const i=s.subarray(e,e+r);this.valueHexView=new Uint8Array(r);for(let a=0;a<r&&(this.valueHexView[a]=i[a]&127,this.blockLength++,(i[a]&128)!==0);a++);const o=new Uint8Array(this.blockLength);for(let a=0;a<this.blockLength;a++)o[a]=this.valueHexView[a];return this.valueHexView=o,(i[this.blockLength-1]&128)!==0?(this.error="End of input reached before message was fully decoded",-1):(this.valueHexView[0]===0&&this.warnings.push("Needlessly long format of SID encoding"),this.blockLength<=8?this.valueDec=Zi(this.valueHexView,7):(this.isHexOnly=!0,this.warnings.push("Too big SID for decoding, hex only")),e+this.blockLength)}toBER(t){if(this.isHexOnly){if(t)return new ArrayBuffer(this.valueHexView.byteLength);const s=this.valueHexView,i=new Uint8Array(this.blockLength);for(let o=0;o<this.blockLength-1;o++)i[o]=s[o]|128;return i[this.blockLength-1]=s[this.blockLength-1],i.buffer}const e=Vs(this.valueDec,7);if(e.byteLength===0)return this.error="Error during encoding SID value",Gn;const r=new Uint8Array(e.byteLength);if(!t){const s=new Uint8Array(e),i=e.byteLength-1;for(let o=0;o<i;o++)r[o]=s[o]|128;r[i]=s[i]}return r.buffer}toString(){let t="";return this.isHexOnly?t=rt.ToHex(this.valueHexView):t=this.valueDec.toString(),t}toJSON(){return{...super.toJSON(),valueDec:this.valueDec}}}nh.NAME="relativeSidBlock";class M0 extends un{constructor({value:t=fo,...e}={}){super(e),this.value=[],t&&this.fromString(t)}fromBER(t,e,r){let s=e;for(;r>0;){const i=new nh;if(s=i.fromBER(t,s,r),s===-1)return this.blockLength=0,this.error=i.error,s;this.blockLength+=i.blockLength,r-=i.blockLength,this.value.push(i)}return s}toBER(t,e){const r=[];for(let s=0;s<this.value.length;s++){const i=this.value[s].toBER(t);if(i.byteLength===0)return this.error=this.value[s].error,Gn;r.push(i)}return Yf(r)}fromString(t){this.value=[];let e=0,r=0,s="";do{r=t.indexOf(".",e),r===-1?s=t.substring(e):s=t.substring(e,r),e=r+1;const i=new nh;if(i.valueDec=parseInt(s,10),isNaN(i.valueDec))return!0;this.value.push(i)}while(r!==-1);return!0}toString(){let t="",e=!1;for(let r=0;r<this.value.length;r++){e=this.value[r].isHexOnly;let s=this.value[r].toString();r!==0&&(t=`${t}.`),e&&(s=`{${s}}`),t+=s}return t}toJSON(){const t={...super.toJSON(),value:this.toString(),sidArray:[]};for(let e=0;e<this.value.length;e++)t.sidArray.push(this.value[e].toJSON());return t}}M0.NAME="RelativeObjectIdentifierValueBlock";var L0;class B0 extends Yt{constructor(t={}){super(t,M0),this.idBlock.tagClass=1,this.idBlock.tagNumber=13}getValue(){return this.valueBlock.toString()}setValue(t){this.valueBlock.fromString(t)}onAsciiEncoding(){return`${this.constructor.NAME} : ${this.valueBlock.toString()||"empty"}`}toJSON(){return{...super.toJSON(),value:this.getValue()}}}L0=B0;j.RelativeObjectIdentifier=L0;B0.NAME="RelativeObjectIdentifier";var N0;class On extends po{constructor(t={}){super(t),this.idBlock.tagClass=1,this.idBlock.tagNumber=16}}N0=On;j.Sequence=N0;On.NAME="SEQUENCE";var R0;let O0=class extends po{constructor(t={}){super(t),this.idBlock.tagClass=1,this.idBlock.tagNumber=17}};R0=O0;j.Set=R0;O0.NAME="SET";class F0 extends Vr(un){constructor({...t}={}){super(t),this.isHexOnly=!0,this.value=fo}toJSON(){return{...super.toJSON(),value:this.value}}}F0.NAME="StringValueBlock";class $0 extends F0{}$0.NAME="SimpleStringValueBlock";class _n extends l0{constructor({...t}={}){super(t,$0)}fromBuffer(t){this.valueBlock.value=String.fromCharCode.apply(null,He.toUint8Array(t))}fromString(t){const e=t.length,r=this.valueBlock.valueHexView=new Uint8Array(e);for(let s=0;s<e;s++)r[s]=t.charCodeAt(s);this.valueBlock.value=t}}_n.NAME="SIMPLE STRING";class U0 extends _n{fromBuffer(t){this.valueBlock.valueHexView=He.toUint8Array(t);try{this.valueBlock.value=rt.ToUtf8String(t)}catch(e){this.warnings.push(`Error during "decodeURIComponent": ${e}, using raw string`),this.valueBlock.value=rt.ToBinary(t)}}fromString(t){this.valueBlock.valueHexView=new Uint8Array(rt.FromUtf8String(t)),this.valueBlock.value=t}}U0.NAME="Utf8StringValueBlock";var V0;class Xs extends U0{constructor(t={}){super(t),this.idBlock.tagClass=1,this.idBlock.tagNumber=12}}V0=Xs;j.Utf8String=V0;Xs.NAME="UTF8String";class H0 extends _n{fromBuffer(t){this.valueBlock.value=rt.ToUtf16String(t),this.valueBlock.valueHexView=He.toUint8Array(t)}fromString(t){this.valueBlock.value=t,this.valueBlock.valueHexView=new Uint8Array(rt.FromUtf16String(t))}}H0.NAME="BmpStringValueBlock";var z0;class q0 extends H0{constructor({...t}={}){super(t),this.idBlock.tagClass=1,this.idBlock.tagNumber=30}}z0=q0;j.BmpString=z0;q0.NAME="BMPString";class W0 extends _n{fromBuffer(t){const e=ArrayBuffer.isView(t)?t.slice().buffer:t.slice(0),r=new Uint8Array(e);for(let s=0;s<r.length;s+=4)r[s]=r[s+3],r[s+1]=r[s+2],r[s+2]=0,r[s+3]=0;this.valueBlock.value=String.fromCharCode.apply(null,new Uint32Array(e))}fromString(t){const e=t.length,r=this.valueBlock.valueHexView=new Uint8Array(e*4);for(let s=0;s<e;s++){const i=Vs(t.charCodeAt(s),8),o=new Uint8Array(i);if(o.length>4)continue;const a=4-o.length;for(let l=o.length-1;l>=0;l--)r[s*4+l+a]=o[l]}this.valueBlock.value=t}}W0.NAME="UniversalStringValueBlock";var G0;class K0 extends W0{constructor({...t}={}){super(t),this.idBlock.tagClass=1,this.idBlock.tagNumber=28}}G0=K0;j.UniversalString=G0;K0.NAME="UniversalString";var Y0;class Q0 extends _n{constructor(t={}){super(t),this.idBlock.tagClass=1,this.idBlock.tagNumber=18}}Y0=Q0;j.NumericString=Y0;Q0.NAME="NumericString";var Z0;class X0 extends _n{constructor(t={}){super(t),this.idBlock.tagClass=1,this.idBlock.tagNumber=19}}Z0=X0;j.PrintableString=Z0;X0.NAME="PrintableString";var j0;class J0 extends _n{constructor(t={}){super(t),this.idBlock.tagClass=1,this.idBlock.tagNumber=20}}j0=J0;j.TeletexString=j0;J0.NAME="TeletexString";var e_;class t_ extends _n{constructor(t={}){super(t),this.idBlock.tagClass=1,this.idBlock.tagNumber=21}}e_=t_;j.VideotexString=e_;t_.NAME="VideotexString";var n_;class r_ extends _n{constructor(t={}){super(t),this.idBlock.tagClass=1,this.idBlock.tagNumber=22}}n_=r_;j.IA5String=n_;r_.NAME="IA5String";var s_;class i_ extends _n{constructor(t={}){super(t),this.idBlock.tagClass=1,this.idBlock.tagNumber=25}}s_=i_;j.GraphicString=s_;i_.NAME="GraphicString";var o_;class jf extends _n{constructor(t={}){super(t),this.idBlock.tagClass=1,this.idBlock.tagNumber=26}}o_=jf;j.VisibleString=o_;jf.NAME="VisibleString";var a_;class c_ extends _n{constructor(t={}){super(t),this.idBlock.tagClass=1,this.idBlock.tagNumber=27}}a_=c_;j.GeneralString=a_;c_.NAME="GeneralString";var l_;class u_ extends _n{constructor(t={}){super(t),this.idBlock.tagClass=1,this.idBlock.tagNumber=29}}l_=u_;j.CharacterString=l_;u_.NAME="CharacterString";var d_;class Jf extends jf{constructor({value:t,valueDate:e,...r}={}){if(super(r),this.year=0,this.month=0,this.day=0,this.hour=0,this.minute=0,this.second=0,t){this.fromString(t),this.valueBlock.valueHexView=new Uint8Array(t.length);for(let s=0;s<t.length;s++)this.valueBlock.valueHexView[s]=t.charCodeAt(s)}e&&(this.fromDate(e),this.valueBlock.valueHexView=new Uint8Array(this.toBuffer())),this.idBlock.tagClass=1,this.idBlock.tagNumber=23}fromBuffer(t){this.fromString(String.fromCharCode.apply(null,He.toUint8Array(t)))}toBuffer(){const t=this.toString(),e=new ArrayBuffer(t.length),r=new Uint8Array(e);for(let s=0;s<t.length;s++)r[s]=t.charCodeAt(s);return e}fromDate(t){this.year=t.getUTCFullYear(),this.month=t.getUTCMonth()+1,this.day=t.getUTCDate(),this.hour=t.getUTCHours(),this.minute=t.getUTCMinutes(),this.second=t.getUTCSeconds()}toDate(){return new Date(Date.UTC(this.year,this.month-1,this.day,this.hour,this.minute,this.second))}fromString(t){const r=/(\d{2})(\d{2})(\d{2})(\d{2})(\d{2})(\d{2})Z/ig.exec(t);if(r===null){this.error="Wrong input string for conversion";return}const s=parseInt(r[1],10);s>=50?this.year=1900+s:this.year=2e3+s,this.month=parseInt(r[2],10),this.day=parseInt(r[3],10),this.hour=parseInt(r[4],10),this.minute=parseInt(r[5],10),this.second=parseInt(r[6],10)}toString(t="iso"){if(t==="iso"){const e=new Array(7);return e[0]=pn(this.year<2e3?this.year-1900:this.year-2e3,2),e[1]=pn(this.month,2),e[2]=pn(this.day,2),e[3]=pn(this.hour,2),e[4]=pn(this.minute,2),e[5]=pn(this.second,2),e[6]="Z",e.join("")}return super.toString(t)}onAsciiEncoding(){return`${this.constructor.NAME} : ${this.toDate().toISOString()}`}toJSON(){return{...super.toJSON(),year:this.year,month:this.month,day:this.day,hour:this.hour,minute:this.minute,second:this.second}}}d_=Jf;j.UTCTime=d_;Jf.NAME="UTCTime";var h_;class f_ extends Jf{constructor(t={}){var e;super(t),(e=this.millisecond)!==null&&e!==void 0||(this.millisecond=0),this.idBlock.tagClass=1,this.idBlock.tagNumber=24}fromDate(t){super.fromDate(t),this.millisecond=t.getUTCMilliseconds()}toDate(){return new Date(Date.UTC(this.year,this.month-1,this.day,this.hour,this.minute,this.second,this.millisecond))}fromString(t){let e=!1,r="",s="",i=0,o,a=0,l=0;if(t[t.length-1]==="Z")r=t.substring(0,t.length-1),e=!0;else{const c=new Number(t[t.length-1]);if(isNaN(c.valueOf()))throw new Error("Wrong input string for conversion");r=t}if(e){if(r.indexOf("+")!==-1)throw new Error("Wrong input string for conversion");if(r.indexOf("-")!==-1)throw new Error("Wrong input string for conversion")}else{let c=1,d=r.indexOf("+"),f="";if(d===-1&&(d=r.indexOf("-"),c=-1),d!==-1){if(f=r.substring(d+1),r=r.substring(0,d),f.length!==2&&f.length!==4)throw new Error("Wrong input string for conversion");let g=parseInt(f.substring(0,2),10);if(isNaN(g.valueOf()))throw new Error("Wrong input string for conversion");if(a=c*g,f.length===4){if(g=parseInt(f.substring(2,4),10),isNaN(g.valueOf()))throw new Error("Wrong input string for conversion");l=c*g}}}let u=r.indexOf(".");if(u===-1&&(u=r.indexOf(",")),u!==-1){const c=new Number(`0${r.substring(u)}`);if(isNaN(c.valueOf()))throw new Error("Wrong input string for conversion");i=c.valueOf(),s=r.substring(0,u)}else s=r;switch(!0){case s.length===8:if(o=/(\d{4})(\d{2})(\d{2})/ig,u!==-1)throw new Error("Wrong input string for conversion");break;case s.length===10:if(o=/(\d{4})(\d{2})(\d{2})(\d{2})/ig,u!==-1){let c=60*i;this.minute=Math.floor(c),c=60*(c-this.minute),this.second=Math.floor(c),c=1e3*(c-this.second),this.millisecond=Math.floor(c)}break;case s.length===12:if(o=/(\d{4})(\d{2})(\d{2})(\d{2})(\d{2})/ig,u!==-1){let c=60*i;this.second=Math.floor(c),c=1e3*(c-this.second),this.millisecond=Math.floor(c)}break;case s.length===14:if(o=/(\d{4})(\d{2})(\d{2})(\d{2})(\d{2})(\d{2})/ig,u!==-1){const c=1e3*i;this.millisecond=Math.floor(c)}break;default:throw new Error("Wrong input string for conversion")}const h=o.exec(s);if(h===null)throw new Error("Wrong input string for conversion");for(let c=1;c<h.length;c++)switch(c){case 1:this.year=parseInt(h[c],10);break;case 2:this.month=parseInt(h[c],10);break;case 3:this.day=parseInt(h[c],10);break;case 4:this.hour=parseInt(h[c],10)+a;break;case 5:this.minute=parseInt(h[c],10)+l;break;case 6:this.second=parseInt(h[c],10);break;default:throw new Error("Wrong input string for conversion")}if(e===!1){const c=new Date(this.year,this.month,this.day,this.hour,this.minute,this.second,this.millisecond);this.year=c.getUTCFullYear(),this.month=c.getUTCMonth(),this.day=c.getUTCDay(),this.hour=c.getUTCHours(),this.minute=c.getUTCMinutes(),this.second=c.getUTCSeconds(),this.millisecond=c.getUTCMilliseconds()}}toString(t="iso"){if(t==="iso"){const e=[];return e.push(pn(this.year,4)),e.push(pn(this.month,2)),e.push(pn(this.day,2)),e.push(pn(this.hour,2)),e.push(pn(this.minute,2)),e.push(pn(this.second,2)),this.millisecond!==0&&(e.push("."),e.push(pn(this.millisecond,3))),e.push("Z"),e.join("")}return super.toString(t)}toJSON(){return{...super.toJSON(),millisecond:this.millisecond}}}h_=f_;j.GeneralizedTime=h_;f_.NAME="GeneralizedTime";var p_;class g_ extends Xs{constructor(t={}){super(t),this.idBlock.tagClass=1,this.idBlock.tagNumber=31}}p_=g_;j.DATE=p_;g_.NAME="DATE";var m_;class y_ extends Xs{constructor(t={}){super(t),this.idBlock.tagClass=1,this.idBlock.tagNumber=32}}m_=y_;j.TimeOfDay=m_;y_.NAME="TimeOfDay";var v_;class b_ extends Xs{constructor(t={}){super(t),this.idBlock.tagClass=1,this.idBlock.tagNumber=33}}v_=b_;j.DateTime=v_;b_.NAME="DateTime";var w_;class __ extends Xs{constructor(t={}){super(t),this.idBlock.tagClass=1,this.idBlock.tagNumber=34}}w_=__;j.Duration=w_;__.NAME="Duration";var S_;class E_ extends Xs{constructor(t={}){super(t),this.idBlock.tagClass=1,this.idBlock.tagNumber=14}}S_=E_;j.TIME=S_;E_.NAME="TIME";const kD=16,rh=32,sh=1e4;async function ep(n,t){const r=await n0().encrypt(n,t);return Ea.encode(r)}async function Zg(n,t,e){if(n.type==="RSA")return PD(n,t,e);if(n.type==="Ed25519")return TD(n,t,e);if(n.type==="secp256k1")return CD(n,t,e);throw new Ks}async function TD(n,t,e="libp2p-key"){if(e==="libp2p-key")return ep(Fl(n),t);throw new X(`export format '${e}' is not supported`)}async function CD(n,t,e="libp2p-key"){if(e==="libp2p-key")return ep(Fl(n),t);throw new X("Export format is not supported")}async function PD(n,t,e="pkcs-8"){if(e==="pkcs-8")return DD(n,t);if(e==="libp2p-key")return ep(Fl(n),t);throw new X("Export format is not supported")}async function DD(n,t){const e=lr.get(),s=new On({value:[new rr({value:0}),new On({value:[new vs({value:"1.2.840.113549.1.1.1"}),new Zc]}),new ss({valueHex:n.raw})]}).toBER(),i=new Uint8Array(s,0,s.byteLength),o=Ui(kD),a=await aw(Dl,t,o,{c:sh,dkLen:rh}),l=Ui(16),u=await e.subtle.importKey("raw",a,"AES-CBC",!1,["encrypt"]),h=await e.subtle.encrypt({name:"AES-CBC",iv:l},u,i),c=new On({value:[new ss({valueHex:o}),new rr({value:sh}),new rr({value:rh}),new On({value:[new vs({value:"1.2.840.113549.2.11"}),new Zc]})]}),d=new On({value:[new vs({value:"1.2.840.113549.1.5.13"}),new On({value:[new On({value:[new vs({value:"1.2.840.113549.1.5.12"}),c]}),new On({value:[new vs({value:"2.16.840.1.101.3.4.1.42"}),new ss({valueHex:l})]})]})]}),g=new On({value:[d,new ss({valueHex:h})]}).toBER(),y=new Uint8Array(g,0,g.byteLength);return["-----BEGIN ENCRYPTED PRIVATE KEY-----",...de(y,"base64pad").split(/(.{64})/).filter(Boolean),"-----END ENCRYPTED PRIVATE KEY-----"].join(`
`)}async function Xg(n,t){try{const e=await MD(n,t);return gk(e)}catch{}if(!n.includes("BEGIN"))throw new X("Encrypted key was not a libp2p-key or a PEM file");return LD(n,t)}async function MD(n,t){const e=Ea.decode(n);return n0().decrypt(e,t)}async function LD(n,t){const e=lr.get();let r;if(n.includes("-----BEGIN ENCRYPTED PRIVATE KEY-----")){const i=te(n.replace("-----BEGIN ENCRYPTED PRIVATE KEY-----","").replace("-----END ENCRYPTED PRIVATE KEY-----","").replace(/\n/g,"").trim(),"base64pad"),{result:o}=Ou(i),{iv:a,salt:l,iterations:u,keySize:h,cipherText:c}=BD(o),d=await aw(Dl,t,l,{c:u,dkLen:h}),f=await e.subtle.importKey("raw",d,"AES-CBC",!1,["decrypt"]),g=Vo(await e.subtle.decrypt({name:"AES-CBC",iv:a},f,c)),{result:y}=Ou(g);r=jg(y)}else if(n.includes("-----BEGIN PRIVATE KEY-----")){const i=te(n.replace("-----BEGIN PRIVATE KEY-----","").replace("-----END PRIVATE KEY-----","").replace(/\n/g,"").trim(),"base64pad"),{result:o}=Ou(i);r=jg(o)}else throw new X("Could not parse private key from PEM data");const s=mk(r);if(s.type!=="RSA")throw new X("Could not parse RSA private key from PEM data");return s}function BD(n){const t=n.valueBlock.value[0];if(t.valueBlock.value[0].toString()!=="OBJECT IDENTIFIER : 1.2.840.113549.1.5.13")throw new X("Only pkcs5PBES2 encrypted private keys are supported");const r=t.valueBlock.value[1].valueBlock.value[0];if(r.valueBlock.value[0].toString()!=="OBJECT IDENTIFIER : 1.2.840.113549.1.5.12")throw new X("Only pkcs5PBKDF2 key derivation functions are supported");const i=r.valueBlock.value[1],o=Vo(i.valueBlock.value[0].getValue());let a=sh,l=rh;if(i.valueBlock.value.length===3)a=Number(i.valueBlock.value[1].toBigInt()),l=Number(i.valueBlock.value[2].toBigInt());else if(i.valueBlock.value.length===2)throw new X("Could not derive key size and iterations from PEM file - please use @libp2p/rsa to re-import your key");const u=t.valueBlock.value[1].valueBlock.value[1],h=u.valueBlock.value[0].toString();if(h!=="OBJECT IDENTIFIER : 1.2.840.113549.3.7"){if(h!=="OBJECT IDENTIFIER : 1.3.14.3.2.7"){if(h!=="OBJECT IDENTIFIER : 2.16.840.1.101.3.4.1.2"){if(h!=="OBJECT IDENTIFIER : 2.16.840.1.101.3.4.1.22"){if(h!=="OBJECT IDENTIFIER : 2.16.840.1.101.3.4.1.42")throw new X("Only AES-CBC encryption schemes are supported")}}}}const c=Vo(u.valueBlock.value[1].getValue());return{cipherText:Vo(n.valueBlock.value[1].getValue()),salt:o,iterations:a,keySize:l,iv:c}}function jg(n){return Vo(n.valueBlock.value[2].getValue())}function Vo(n){return new Uint8Array(n,0,n.byteLength)}const ND="/pkcs8/",ih="/info/",xo=new WeakMap,hs={minKeyLength:112/8,minSaltLength:128/8,minIterationCount:1e3},Fu={dek:{keyLength:512/8,iterationCount:1e4,salt:"you should override this value with a crypto secure random number",hash:"sha2-512"}};function ci(n){return n==null||typeof n!="string"?!1:n===mD(n.trim())&&n.length>0}async function Et(){const e=Math.random()*800+200;await new Promise(r=>setTimeout(r,e))}function fs(n){return new ut(ND+n)}function li(n){return new ut(ih+n)}async function RD(n){const t=Fl(n),e=await Aa.digest(t);return ot.encode(e.bytes).substring(1)}var my,yy;yy=Symbol.toStringTag,my=Wn;class OD{constructor(t,e){p(this,"components");p(this,"init");p(this,"log");p(this,"self");p(this,yy,"@libp2p/keychain");p(this,my,["@libp2p/keychain"]);if(this.components=t,this.log=t.logger.forComponent("libp2p:keychain"),this.init=Kf(Fu,e),this.self=e.selfKey??"self",this.init.pass!=null&&this.init.pass?.length<20)throw new Error("pass must be least 20 characters");if(this.init.dek?.keyLength!=null&&this.init.dek.keyLength<hs.minKeyLength)throw new Error(`dek.keyLength must be least ${hs.minKeyLength} bytes`);if(this.init.dek?.salt?.length!=null&&this.init.dek.salt.length<hs.minSaltLength)throw new Error(`dek.saltLength must be least ${hs.minSaltLength} bytes`);if(this.init.dek?.iterationCount!=null&&this.init.dek.iterationCount<hs.minIterationCount)throw new Error(`dek.iterationCount must be least ${hs.minIterationCount}`);const r=this.init.pass!=null&&this.init.dek?.salt!=null?fg(this.init.pass,this.init.dek?.salt,this.init.dek?.iterationCount,this.init.dek?.keyLength,this.init.dek?.hash):"";xo.set(this,{dek:r})}static generateOptions(){const t=Object.assign({},Fu),e=Math.ceil(hs.minSaltLength/3)*3;return t.dek.salt=de(Ui(e),"base64"),t}static get options(){return Fu}async findKeyByName(t){if(!ci(t))throw await Et(),new X(`Invalid key name '${t}'`);const e=li(t);try{const r=await this.components.datastore.get(e);return JSON.parse(de(r))}catch(r){throw await Et(),this.log.error(r),new Sc(`Key '${t}' does not exist.`)}}async findKeyById(t){try{const e={prefix:ih};for await(const r of this.components.datastore.query(e)){const s=JSON.parse(de(r.value));if(s.id===t)return s}throw new X(`Key with id '${t}' does not exist.`)}catch(e){throw await Et(),e}}async importKey(t,e){if(!ci(t))throw await Et(),new X(`Invalid key name '${t}'`);if(e==null)throw await Et(),new X("Key is required");const r=fs(t);if(await this.components.datastore.has(r))throw await Et(),new X(`Key '${t}' already exists`);let i,o;try{i=await RD(e);const u=xo.get(this);if(u==null)throw new X("dek missing");const h=u.dek;o=await Zg(e,h,e.type==="RSA"?"pkcs-8":"libp2p-key")}catch(u){throw await Et(),u}const a={name:t,id:i},l=this.components.datastore.batch();return l.put(r,te(o)),l.put(li(t),te(JSON.stringify(a))),await l.commit(),a}async exportKey(t){if(!ci(t))throw await Et(),new X(`Invalid key name '${t}'`);const e=fs(t);try{const r=await this.components.datastore.get(e),s=de(r),i=xo.get(this);if(i==null)throw new X("dek missing");const o=i.dek;return await Xg(s,o)}catch(r){throw await Et(),r}}async removeKey(t){if(!ci(t)||t===this.self)throw await Et(),new X(`Invalid key name '${t}'`);const e=fs(t),r=await this.findKeyByName(t),s=this.components.datastore.batch();return s.delete(e),s.delete(li(t)),await s.commit(),r}async listKeys(){const t={prefix:ih},e=[];for await(const r of this.components.datastore.query(t))e.push(JSON.parse(de(r.value)));return e}async renameKey(t,e){if(!ci(t)||t===this.self)throw await Et(),new X(`Invalid old key name '${t}'`);if(!ci(e)||e===this.self)throw await Et(),new X(`Invalid new key name '${e}'`);const r=fs(t),s=fs(e),i=li(t),o=li(e);if(await this.components.datastore.has(s))throw await Et(),new X(`Key '${e}' already exists`);try{const l=await this.components.datastore.get(r),u=await this.components.datastore.get(i),h=JSON.parse(de(u));h.name=e;const c=this.components.datastore.batch();return c.put(s,l),c.put(o,te(JSON.stringify(h))),c.delete(r),c.delete(i),await c.commit(),h}catch(l){throw await Et(),l}}async rotateKeychainPass(t,e){if(typeof t!="string")throw await Et(),new X(`Invalid old pass type '${typeof t}'`);if(typeof e!="string")throw await Et(),new X(`Invalid new pass type '${typeof e}'`);if(e.length<20)throw await Et(),new X(`Invalid pass length ${e.length}`);this.log("recreating keychain");const r=xo.get(this);if(r==null)throw new X("dek missing");const s=r.dek;this.init.pass=e;const i=e!=null&&this.init.dek?.salt!=null?fg(e,this.init.dek.salt,this.init.dek?.iterationCount,this.init.dek?.keyLength,this.init.dek?.hash):"";xo.set(this,{dek:i});const o=await this.listKeys();for(const a of o){const l=await this.components.datastore.get(fs(a.name)),u=de(l),h=await Xg(u,s),c=i.toString(),d=await Zg(h,c,h.type==="RSA"?"pkcs-8":"libp2p-key"),f=this.components.datastore.batch(),g={name:a.name,id:a.id};f.put(fs(a.name),te(d)),f.put(li(a.name),te(JSON.stringify(g))),await f.commit()}this.log("keychain reconstructed")}}function A_(n={}){return t=>new OD(t,n)}const Xi=1e3,ji=Xi*60,Ji=ji*60,Hs=Ji*24,FD=Hs*7,$D=Hs*365.25;function x_(n,t){try{if(typeof n=="string"&&n.length>0)return UD(n);if(typeof n=="number"&&isFinite(n))return t?.long?HD(n):VD(n);throw new Error("Value is not a string or number.")}catch(e){const r=zD(e)?`${e.message}. value=${JSON.stringify(n)}`:"An unknown error has occured.";throw new Error(r)}}function UD(n){if(n=String(n),n.length>100)throw new Error("Value exceeds the maximum length of 100 characters.");const t=/^(-?(?:\d+)?\.?\d+) *(milliseconds?|msecs?|ms|seconds?|secs?|s|minutes?|mins?|m|hours?|hrs?|h|days?|d|weeks?|w|years?|yrs?|y)?$/i.exec(n);if(!t)return NaN;const e=parseFloat(t[1]),r=(t[2]||"ms").toLowerCase();switch(r){case"years":case"year":case"yrs":case"yr":case"y":return e*$D;case"weeks":case"week":case"w":return e*FD;case"days":case"day":case"d":return e*Hs;case"hours":case"hour":case"hrs":case"hr":case"h":return e*Ji;case"minutes":case"minute":case"mins":case"min":case"m":return e*ji;case"seconds":case"second":case"secs":case"sec":case"s":return e*Xi;case"milliseconds":case"millisecond":case"msecs":case"msec":case"ms":return e;default:throw new Error(`The unit ${r} was matched, but no matching case exists.`)}}function VD(n){const t=Math.abs(n);return t>=Hs?`${Math.round(n/Hs)}d`:t>=Ji?`${Math.round(n/Ji)}h`:t>=ji?`${Math.round(n/ji)}m`:t>=Xi?`${Math.round(n/Xi)}s`:`${n}ms`}function HD(n){const t=Math.abs(n);return t>=Hs?za(n,t,Hs,"day"):t>=Ji?za(n,t,Ji,"hour"):t>=ji?za(n,t,ji,"minute"):t>=Xi?za(n,t,Xi,"second"):`${n} ms`}function za(n,t,e,r){const s=t>=e*1.5;return`${Math.round(n/e)} ${r}${s?"s":""}`}function zD(n){return typeof n=="object"&&n!==null&&"message"in n}function qD(n){e.debug=e,e.default=e,e.coerce=l,e.disable=i,e.enable=s,e.enabled=o,e.humanize=x_,e.destroy=u,Object.keys(n).forEach(h=>{e[h]=n[h]}),e.names=[],e.skips=[],e.formatters={};function t(h){let c=0;for(let d=0;d<h.length;d++)c=(c<<5)-c+h.charCodeAt(d),c|=0;return e.colors[Math.abs(c)%e.colors.length]}e.selectColor=t;function e(h){let c,d=null,f,g;function y(...m){if(!y.enabled)return;const v=y,_=Number(new Date),w=_-(c||_);v.diff=w,v.prev=c,v.curr=_,c=_,m[0]=e.coerce(m[0]),typeof m[0]!="string"&&m.unshift("%O");let S=0;m[0]=m[0].replace(/%([a-zA-Z%])/g,(A,I)=>{if(A==="%%")return"%";S++;const T=e.formatters[I];if(typeof T=="function"){const x=m[S];A=T.call(v,x),m.splice(S,1),S--}return A}),e.formatArgs.call(v,m),(v.log||e.log).apply(v,m)}return y.namespace=h,y.useColors=e.useColors(),y.color=e.selectColor(h),y.extend=r,y.destroy=e.destroy,Object.defineProperty(y,"enabled",{enumerable:!0,configurable:!1,get:()=>d!==null?d:(f!==e.namespaces&&(f=e.namespaces,g=e.enabled(h)),g),set:m=>{d=m}}),typeof e.init=="function"&&e.init(y),y}function r(h,c){const d=e(this.namespace+(typeof c>"u"?":":c)+h);return d.log=this.log,d}function s(h){e.save(h),e.namespaces=h,e.names=[],e.skips=[];let c;const d=(typeof h=="string"?h:"").split(/[\s,]+/),f=d.length;for(c=0;c<f;c++)d[c]&&(h=d[c].replace(/\*/g,".*?"),h[0]==="-"?e.skips.push(new RegExp("^"+h.substr(1)+"$")):e.names.push(new RegExp("^"+h+"$")))}function i(){const h=[...e.names.map(a),...e.skips.map(a).map(c=>"-"+c)].join(",");return e.enable(""),h}function o(h){if(h[h.length-1]==="*")return!0;let c,d;for(c=0,d=e.skips.length;c<d;c++)if(e.skips[c].test(h))return!1;for(c=0,d=e.names.length;c<d;c++)if(e.names[c].test(h))return!0;return!1}function a(h){return h.toString().substring(2,h.toString().length-2).replace(/\.\*\?$/,"*")}function l(h){return h instanceof Error?h.stack??h.message:h}function u(){console.warn("Instance method `debug.destroy()` is deprecated and no longer does anything. It will be removed in the next major version of `debug`.")}return e.setupFormatters(e.formatters),e.enable(e.load()),e}var WD={};const Xc=jD(),GD=["#0000CC","#0000FF","#0033CC","#0033FF","#0066CC","#0066FF","#0099CC","#0099FF","#00CC00","#00CC33","#00CC66","#00CC99","#00CCCC","#00CCFF","#3300CC","#3300FF","#3333CC","#3333FF","#3366CC","#3366FF","#3399CC","#3399FF","#33CC00","#33CC33","#33CC66","#33CC99","#33CCCC","#33CCFF","#6600CC","#6600FF","#6633CC","#6633FF","#66CC00","#66CC33","#9900CC","#9900FF","#9933CC","#9933FF","#99CC00","#99CC33","#CC0000","#CC0033","#CC0066","#CC0099","#CC00CC","#CC00FF","#CC3300","#CC3333","#CC3366","#CC3399","#CC33CC","#CC33FF","#CC6600","#CC6633","#CC9900","#CC9933","#CCCC00","#CCCC33","#FF0000","#FF0033","#FF0066","#FF0099","#FF00CC","#FF00FF","#FF3300","#FF3333","#FF3366","#FF3399","#FF33CC","#FF33FF","#FF6600","#FF6633","#FF9900","#FF9933","#FFCC00","#FFCC33"];function KD(){return typeof window<"u"&&window.process&&(window.process.type==="renderer"||window.process.__nwjs)?!0:typeof navigator<"u"&&navigator.userAgent?.toLowerCase().match(/(edge|trident)\/(\d+)/)!=null?!1:typeof document<"u"&&document.documentElement?.style?.WebkitAppearance||typeof window<"u"&&window.console&&(window.console.firebug||window.console.exception&&window.console.table)||typeof navigator<"u"&&navigator.userAgent?.toLowerCase().match(/firefox\/(\d+)/)!=null&&parseInt(RegExp.$1,10)>=31||typeof navigator<"u"&&navigator.userAgent?.toLowerCase().match(/applewebkit\/(\d+)/)}function YD(n){if(n[0]=(this.useColors?"%c":"")+this.namespace+(this.useColors?" %c":" ")+n[0]+(this.useColors?"%c ":" ")+"+"+x_(this.diff),!this.useColors)return;const t="color: "+this.color;n.splice(1,0,t,"color: inherit");let e=0,r=0;n[0].replace(/%[a-zA-Z%]/g,s=>{s!=="%%"&&(e++,s==="%c"&&(r=e))}),n.splice(r,0,t)}const QD=console.debug??console.log??(()=>{});function ZD(n){try{n?Xc?.setItem("debug",n):Xc?.removeItem("debug")}catch{}}function XD(){let n;try{n=Xc?.getItem("debug")}catch{}return!n&&typeof globalThis.process<"u"&&"env"in globalThis.process&&(n=WD.DEBUG),n}function jD(){try{return localStorage}catch{}}function JD(n){n.j=function(t){try{return JSON.stringify(t)}catch(e){return"[UnexpectedJSONParseError]: "+e.message}}}const mn=qD({formatArgs:YD,save:ZD,load:XD,useColors:KD,setupFormatters:JD,colors:GD,storage:Xc,log:QD});mn.formatters.b=n=>n==null?"undefined":ot.baseEncode(n);mn.formatters.t=n=>n==null?"undefined":Cr.baseEncode(n);mn.formatters.m=n=>n==null?"undefined":Ea.baseEncode(n);mn.formatters.p=n=>n==null?"undefined":n.toString();mn.formatters.c=n=>n==null?"undefined":n.toString();mn.formatters.k=n=>n==null?"undefined":n.toString();mn.formatters.a=n=>n==null?"undefined":n.toString();mn.formatters.e=n=>n==null?"undefined":Jg(n.stack)??Jg(n.message)??n.toString();function eM(n){const t=()=>{};return t.enabled=!1,t.color="",t.diff=0,t.log=()=>{},t.namespace=n,t.destroy=()=>!0,t.extend=()=>t,t}function tp(){return{forComponent(n){return I_(n)}}}function I_(n){let t=eM(`${n}:trace`);return mn.enabled(`${n}:trace`)&&mn.names.map(e=>e.toString()).find(e=>e.includes(":trace"))!=null&&(t=mn(`${n}:trace`)),Object.assign(mn(n),{error:mn(`${n}:error`),trace:t})}function Jg(n){if(n!=null&&(n=n.trim(),n.length!==0))return n}async function tM(n,t={}){const e=t.selfKey??"self",r=A_(t)({datastore:n,logger:tp()});let s;return await n.has(new ut(`/pkcs8/${e}`))?s=await r.exportKey(e):(s=await Zb(t.keyType??"Ed25519"),await r.importKey(e,s)),s}function nM(n){return n[Symbol.asyncIterator]!=null}function em(n){if(nM(n))return(async()=>{for await(const t of n);})();for(const t of n);}const qa=globalThis.CustomEvent??Event;async function*rM(n,t={}){let e=t.concurrency??1/0;e<1&&(e=1/0);const r=t.ordered==null?!1:t.ordered,s=new EventTarget,i=[];let o=bt(),a=bt(),l=!1,u,h=!1;s.addEventListener("task-complete",()=>{a.resolve()}),Promise.resolve().then(async()=>{try{for await(const g of n){if(i.length===e&&(o=bt(),await o.promise),h)break;const y={done:!1};i.push(y),g().then(m=>{y.done=!0,y.ok=!0,y.value=m,s.dispatchEvent(new qa("task-complete"))},m=>{y.done=!0,y.err=m,s.dispatchEvent(new qa("task-complete"))})}l=!0,s.dispatchEvent(new qa("task-complete"))}catch(g){u=g,s.dispatchEvent(new qa("task-complete"))}});function c(){return r?i[0]?.done:!!i.find(g=>g.done)}function*d(){for(;i.length>0&&i[0].done;){const g=i[0];if(i.shift(),g.ok)yield g.value;else throw h=!0,o.resolve(),g.err;o.resolve()}}function*f(){for(;c();)for(let g=0;g<i.length;g++)if(i[g].done){const y=i[g];if(i.splice(g,1),g--,y.ok)yield y.value;else throw h=!0,o.resolve(),y.err;o.resolve()}}for(;;){if(c()||(a=bt(),await a.promise),u!=null)throw u;if(r?yield*d():yield*f(),l&&i.length===0)break}}const sM="0.1.0",iM="id",oM="1.0.0",aM=1024*8;var jc;(function(n){let t;n.codec=()=>(t==null&&(t=Te((e,r,s={})=>{if(s.lengthDelimited!==!1&&r.fork(),e.protocolVersion!=null&&(r.uint32(42),r.string(e.protocolVersion)),e.agentVersion!=null&&(r.uint32(50),r.string(e.agentVersion)),e.publicKey!=null&&(r.uint32(10),r.bytes(e.publicKey)),e.listenAddrs!=null)for(const i of e.listenAddrs)r.uint32(18),r.bytes(i);if(e.observedAddr!=null&&(r.uint32(34),r.bytes(e.observedAddr)),e.protocols!=null)for(const i of e.protocols)r.uint32(26),r.string(i);e.signedPeerRecord!=null&&(r.uint32(66),r.bytes(e.signedPeerRecord)),s.lengthDelimited!==!1&&r.ldelim()},(e,r,s={})=>{const i={listenAddrs:[],protocols:[]},o=r==null?e.len:e.pos+r;for(;e.pos<o;){const a=e.uint32();switch(a>>>3){case 5:{i.protocolVersion=e.string();break}case 6:{i.agentVersion=e.string();break}case 1:{i.publicKey=e.bytes();break}case 2:{if(s.limits?.listenAddrs!=null&&i.listenAddrs.length===s.limits.listenAddrs)throw new gt('Decode error - map field "listenAddrs" had too many elements');i.listenAddrs.push(e.bytes());break}case 4:{i.observedAddr=e.bytes();break}case 3:{if(s.limits?.protocols!=null&&i.protocols.length===s.limits.protocols)throw new gt('Decode error - map field "protocols" had too many elements');i.protocols.push(e.string());break}case 8:{i.signedPeerRecord=e.bytes();break}default:{e.skipType(a&7);break}}}return i})),t),n.encode=e=>ke(e,n.codec()),n.decode=(e,r)=>Ie(e,n.codec(),r)})(jc||(jc={}));const yr={protocolPrefix:"ipfs",timeout:5e3,maxInboundStreams:1,maxOutboundStreams:1,maxObservedAddresses:10,maxMessageSize:aM,runOnConnectionOpen:!0,runOnLimitedConnection:!0};function cM(n){if(n!=null&&n.length>0)try{return me(n)}catch{}}function lM(n,t){return t??n.userAgent}async function uM(n,t,e,r,s){if(e("received identify from %p",r.remotePeer),s==null)throw new jn("message was null or undefined");const i={};if(s.listenAddrs.length>0&&(i.addresses=s.listenAddrs.map(l=>({isCertified:!1,multiaddr:me(l)}))),s.protocols.length>0&&(i.protocols=s.protocols),s.publicKey!=null){const l=Lr(s.publicKey);if(!ka(l).equals(r.remotePeer))throw new jn("public key did not match remote PeerId");i.publicKey=l}let o;if(s.signedPeerRecord!=null){e.trace("received signedPeerRecord from %p",r.remotePeer);let l=s.signedPeerRecord;const u=await Us.openAndCertify(l,Dr.DOMAIN);let h=Dr.createFromProtobuf(u.payload);const c=$l(u.publicKey.toCID());if(!h.peerId.equals(c))throw new jn("signing key does not match PeerId in the PeerRecord");if(!r.remotePeer.equals(h.peerId))throw new jn("signing key does not match remote PeerId");let d;try{d=await n.get(h.peerId)}catch(f){if(f.name!=="NotFoundError")throw f}if(d!=null&&(i.metadata=d.metadata,d.peerRecordEnvelope!=null)){const f=await Us.createFromProtobuf(d.peerRecordEnvelope),g=Dr.createFromProtobuf(f.payload);g.seqNumber>=h.seqNumber&&(e("sequence number was lower or equal to existing sequence number - stored: %d received: %d",g.seqNumber,h.seqNumber),h=g,l=d.peerRecordEnvelope)}i.peerRecordEnvelope=l,i.addresses=h.multiaddrs.map(f=>({isCertified:!0,multiaddr:f})),o={seq:h.seqNumber,addresses:h.multiaddrs}}else e("%p did not send a signed peer record",r.remotePeer);if(e.trace("patching %p with",r.remotePeer,i),await n.patch(r.remotePeer,i),s.agentVersion!=null||s.protocolVersion!=null){const l={};s.agentVersion!=null&&(l.AgentVersion=te(s.agentVersion)),s.protocolVersion!=null&&(l.ProtocolVersion=te(s.protocolVersion)),e.trace("merging %p metadata",r.remotePeer,l),await n.merge(r.remotePeer,{metadata:l})}const a={peerId:r.remotePeer,protocolVersion:s.protocolVersion,agentVersion:s.agentVersion,publicKey:s.publicKey,listenAddrs:s.listenAddrs.map(l=>me(l)),observedAddr:s.observedAddr==null?void 0:me(s.observedAddr),protocols:s.protocols,signedPeerRecord:o,connection:r};return t.safeDispatchEvent("peer:identify",{detail:a}),a}class dM{constructor(t,e){p(this,"host");p(this,"protocol");p(this,"started");p(this,"timeout");p(this,"peerId");p(this,"privateKey");p(this,"peerStore");p(this,"registrar");p(this,"addressManager");p(this,"maxInboundStreams");p(this,"maxOutboundStreams");p(this,"maxMessageSize");p(this,"maxObservedAddresses");p(this,"events");p(this,"runOnLimitedConnection");p(this,"log");this.protocol=e.protocol,this.started=!1,this.peerId=t.peerId,this.privateKey=t.privateKey,this.peerStore=t.peerStore,this.registrar=t.registrar,this.addressManager=t.addressManager,this.events=t.events,this.log=e.log,this.timeout=e.timeout??yr.timeout,this.maxInboundStreams=e.maxInboundStreams??yr.maxInboundStreams,this.maxOutboundStreams=e.maxOutboundStreams??yr.maxOutboundStreams,this.maxMessageSize=e.maxMessageSize??yr.maxMessageSize,this.maxObservedAddresses=e.maxObservedAddresses??yr.maxObservedAddresses,this.runOnLimitedConnection=e.runOnLimitedConnection??yr.runOnLimitedConnection,this.host={protocolVersion:`${e.protocolPrefix??yr.protocolPrefix}/${sM}`,agentVersion:lM(t.nodeInfo,e.agentVersion)}}isStarted(){return this.started}async start(){this.started||(await this.peerStore.merge(this.peerId,{metadata:{AgentVersion:te(this.host.agentVersion),ProtocolVersion:te(this.host.protocolVersion)}}),await this.registrar.handle(this.protocol,t=>{this.handleProtocol(t).catch(e=>{this.log.error(e)})},{maxInboundStreams:this.maxInboundStreams,maxOutboundStreams:this.maxOutboundStreams,runOnLimitedConnection:this.runOnLimitedConnection}),this.started=!0)}async stop(){await this.registrar.unhandle(this.protocol),this.started=!1}}const hM=41;function fM(n){try{const[[t,e]]=n.stringTuples();if(e==null)return!1;if(t===hM)return sC("2000::/3",e)}catch{}return!1}var ui={},tm;function pM(){return tm||(tm=1,function(){var n,t,e,r,s,i,o,a;a=function(l){var u,h,c,d;return u=(l&255<<24)>>>24,h=(l&255<<16)>>>16,c=(l&65280)>>>8,d=l&255,[u,h,c,d].join(".")},o=function(l){var u,h,c,d,f,g;for(u=[],c=d=0;d<=3&&l.length!==0;c=++d){if(c>0){if(l[0]!==".")throw new Error("Invalid IP");l=l.substring(1)}g=t(l),f=g[0],h=g[1],l=l.substring(h),u.push(f)}if(l.length!==0)throw new Error("Invalid IP");switch(u.length){case 1:if(u[0]>4294967295)throw new Error("Invalid IP");return u[0]>>>0;case 2:if(u[0]>255||u[1]>16777215)throw new Error("Invalid IP");return(u[0]<<24|u[1])>>>0;case 3:if(u[0]>255||u[1]>255||u[2]>65535)throw new Error("Invalid IP");return(u[0]<<24|u[1]<<16|u[2])>>>0;case 4:if(u[0]>255||u[1]>255||u[2]>255||u[3]>255)throw new Error("Invalid IP");return(u[0]<<24|u[1]<<16|u[2]<<8|u[3])>>>0;default:throw new Error("Invalid IP")}},e=function(l){return l.charCodeAt(0)},r=e("0"),i=e("a"),s=e("A"),t=function(l){var u,h,c,d,f;for(d=0,u=10,h="9",c=0,l.length>1&&l[c]==="0"&&(l[c+1]==="x"||l[c+1]==="X"?(c+=2,u=16):"0"<=l[c+1]&&l[c+1]<="9"&&(c++,u=8,h="7")),f=c;c<l.length;){if("0"<=l[c]&&l[c]<=h)d=d*u+(e(l[c])-r)>>>0;else if(u===16)if("a"<=l[c]&&l[c]<="f")d=d*u+(10+e(l[c])-i)>>>0;else if("A"<=l[c]&&l[c]<="F")d=d*u+(10+e(l[c])-s)>>>0;else break;else break;if(d>4294967295)throw new Error("too large");c++}if(c===f)throw new Error("empty octet");return[d,c]},n=function(){function l(u,h){var c,d,f;if(typeof u!="string")throw new Error("Missing `net' parameter");if(h||(f=u.split("/",2),u=f[0],h=f[1]),h||(h=32),typeof h=="string"&&h.indexOf(".")>-1){try{this.maskLong=o(h)}catch{throw new Error("Invalid mask: "+h)}for(c=d=32;d>=0;c=--d)if(this.maskLong===4294967295<<32-c>>>0){this.bitmask=c;break}}else if(h||h===0)this.bitmask=parseInt(h,10),this.maskLong=0,this.bitmask>0&&(this.maskLong=4294967295<<32-this.bitmask>>>0);else throw new Error("Invalid mask: empty");try{this.netLong=(o(u)&this.maskLong)>>>0}catch{throw new Error("Invalid net address: "+u)}if(!(this.bitmask<=32))throw new Error("Invalid mask for ip4: "+h);this.size=Math.pow(2,32-this.bitmask),this.base=a(this.netLong),this.mask=a(this.maskLong),this.hostmask=a(~this.maskLong),this.first=this.bitmask<=30?a(this.netLong+1):this.base,this.last=this.bitmask<=30?a(this.netLong+this.size-2):a(this.netLong+this.size-1),this.broadcast=this.bitmask<=30?a(this.netLong+this.size-1):void 0}return l.prototype.contains=function(u){return typeof u=="string"&&(u.indexOf("/")>0||u.split(".").length!==4)&&(u=new l(u)),u instanceof l?this.contains(u.base)&&this.contains(u.broadcast||u.last):(o(u)&this.maskLong)>>>0===(this.netLong&this.maskLong)>>>0},l.prototype.next=function(u){return u==null&&(u=1),new l(a(this.netLong+this.size*u),this.mask)},l.prototype.forEach=function(u){var h,c,d;for(d=o(this.first),c=o(this.last),h=0;d<=c;)u(a(d),d,h),h++,d++},l.prototype.toString=function(){return this.base+"/"+this.bitmask},l}(),ui.ip2long=o,ui.long2ip=a,ui.Netmask=n}.call(ui)),ui}var gM=pM();const mM=["0.0.0.0/8","10.0.0.0/8","100.64.0.0/10","127.0.0.0/8","169.254.0.0/16","172.16.0.0/12","192.0.0.0/24","192.0.0.0/29","192.0.0.8/32","192.0.0.9/32","192.0.0.10/32","192.0.0.170/32","192.0.0.171/32","192.0.2.0/24","192.31.196.0/24","192.52.193.0/24","192.88.99.0/24","192.168.0.0/16","192.175.48.0/24","198.18.0.0/15","198.51.100.0/24","203.0.113.0/24","240.0.0.0/4","255.255.255.255/32"],yM=mM.map(n=>new gM.Netmask(n));function np(n){for(const t of yM)if(t.contains(n))return!0;return!1}function vM(n){return/^::ffff:([0-9a-fA-F]{1,4}):([0-9a-fA-F]{1,4})$/.test(n)}function bM(n){const t=n.split(":");if(t.length<2)return!1;const e=t[t.length-1].padStart(4,"0"),r=t[t.length-2].padStart(4,"0"),s=`${parseInt(r.substring(0,2),16)}.${parseInt(r.substring(2),16)}.${parseInt(e.substring(0,2),16)}.${parseInt(e.substring(2),16)}`;return np(s)}function wM(n){return/^::ffff:([0-9]{1,3})\.([0-9]{1,3})\.([0-9]{1,3})\.([0-9]{1,3})$/.test(n)}function _M(n){const t=n.split(":"),e=t[t.length-1];return np(e)}function SM(n){return/^::$/.test(n)||/^::1$/.test(n)||/^64:ff9b::([0-9]{1,3})\.([0-9]{1,3})\.([0-9]{1,3})\.([0-9]{1,3})$/.test(n)||/^100::([0-9a-fA-F]{0,4}):?([0-9a-fA-F]{0,4}):?([0-9a-fA-F]{0,4}):?([0-9a-fA-F]{0,4})$/.test(n)||/^2001::([0-9a-fA-F]{0,4}):?([0-9a-fA-F]{0,4}):?([0-9a-fA-F]{0,4}):?([0-9a-fA-F]{0,4}):?([0-9a-fA-F]{0,4}):?([0-9a-fA-F]{0,4})$/.test(n)||/^2001:2[0-9a-fA-F]:([0-9a-fA-F]{0,4}):?([0-9a-fA-F]{0,4}):?([0-9a-fA-F]{0,4}):?([0-9a-fA-F]{0,4}):?([0-9a-fA-F]{0,4}):?([0-9a-fA-F]{0,4})$/.test(n)||/^2001:db8:([0-9a-fA-F]{0,4}):?([0-9a-fA-F]{0,4}):?([0-9a-fA-F]{0,4}):?([0-9a-fA-F]{0,4}):?([0-9a-fA-F]{0,4}):?([0-9a-fA-F]{0,4})$/.test(n)||/^2002:([0-9a-fA-F]{0,4}):?([0-9a-fA-F]{0,4}):?([0-9a-fA-F]{0,4}):?([0-9a-fA-F]{0,4}):?([0-9a-fA-F]{0,4}):?([0-9a-fA-F]{0,4}):?([0-9a-fA-F]{0,4})$/.test(n)||/^f[c-d]([0-9a-fA-F]{2,2}):/i.test(n)||/^fe[8-9a-bA-B][0-9a-fA-F]:/i.test(n)||/^ff([0-9a-fA-F]{2,2}):/i.test(n)}function jl(n){return zi(n)?np(n):vM(n)?bM(n):wM(n)?_M(n):Df(n)?SM(n):void 0}const EM=4,AM=41;function k_(n){try{const[[t]]=n.stringTuples();return t===EM||t===AM}catch{}return!1}function aa(n){try{if(!k_(n))return!1;const[[,t]]=n.stringTuples();return t==null?!1:jl(t)??!1}catch{}return!0}const xM=41;var vy,by;class IM extends(by=dM,vy=Wn,by){constructor(e,r={}){super(e,{...r,protocol:`/${r.protocolPrefix??yr.protocolPrefix}/${iM}/${oM}`,log:e.logger.forComponent("libp2p:identify")});p(this,vy,["@libp2p/identify"]);(r.runOnConnectionOpen??yr.runOnConnectionOpen)&&e.events.addEventListener("connection:open",s=>{const i=s.detail;this.identify(i).catch(o=>{o.name!==Il.name&&this.log.error("error during identify trigged by connection:open",o)})})}async _identify(e,r={}){let s;if(r.signal==null){const i=AbortSignal.timeout(this.timeout);r={...r,signal:i}}try{s=await e.newStream(this.protocol,{...r,runOnLimitedConnection:this.runOnLimitedConnection});const o=await Wi(s,{maxDataLength:this.maxMessageSize}).pb(jc).read(r);return await s.close(r),o}catch(i){throw s?.abort(i),i}}async identify(e,r={}){const s=await this._identify(e,r),{publicKey:i,protocols:o,observedAddr:a}=s;if(i==null)throw new jn("public key was missing from identify message");const l=Lr(i),u=$l(l.toCID());if(!e.remotePeer.equals(u))throw new jn("identified peer does not match the expected peer");if(this.peerId.equals(u))throw new jn("identified peer is our own peer id?");return this.maybeAddObservedAddress(a),this.log("identify completed for peer %p and protocols %o",u,o),uM(this.peerStore,this.events,this.log,e,s)}maybeAddObservedAddress(e){const r=cM(e);if(r==null)return;if(this.log.trace("our observed address was %a",r),aa(r)){this.log.trace("our observed address was private");return}if(r.stringTuples()[0][0]===xM&&!fM(r)){this.log.trace("our observed address was IPv6 but not a global unicast address");return}Wc.exactMatch(r)||(this.log.trace("storing the observed address"),this.addressManager.addObservedAddr(r))}async handleProtocol(e){const{connection:r,stream:s}=e,i=AbortSignal.timeout(this.timeout);try{const o=await this.peerStore.get(this.peerId),a=this.addressManager.getAddresses().map(c=>c.decapsulateCode(pe("p2p").code));let l=o.peerRecordEnvelope;if(a.length>0&&l==null){const c=new Dr({peerId:this.peerId,multiaddrs:a});l=(await Us.seal(c,this.privateKey)).marshal().subarray()}let u=r.remoteAddr.bytes;SP.matches(r.remoteAddr)||(u=void 0),await Wi(s).pb(jc).write({protocolVersion:this.host.protocolVersion,agentVersion:this.host.agentVersion,publicKey:nr(this.privateKey.publicKey),listenAddrs:a.map(c=>c.bytes),signedPeerRecord:l,observedAddr:u,protocols:o.protocols},{signal:i}),await s.close({signal:i})}catch(o){this.log.error("could not respond to identify request",o),s.abort(o)}}}function kM(n={}){return t=>new IM(t,n)}var oh;(function(n){let t;n.codec=()=>(t==null&&(t=Te((e,r,s={})=>{s.lengthDelimited!==!1&&r.fork(),e.id!=null&&(r.uint32(10),r.bytes(e.id)),e.pubkey!=null&&(r.uint32(18),Jc.codec().encode(e.pubkey,r)),s.lengthDelimited!==!1&&r.ldelim()},(e,r,s={})=>{const i={},o=r==null?e.len:e.pos+r;for(;e.pos<o;){const a=e.uint32();switch(a>>>3){case 1:{i.id=e.bytes();break}case 2:{i.pubkey=Jc.codec().decode(e,e.uint32(),{limits:s.limits?.pubkey});break}default:{e.skipType(a&7);break}}}return i})),t),n.encode=e=>ke(e,n.codec()),n.decode=(e,r)=>Ie(e,n.codec(),r)})(oh||(oh={}));var zs;(function(n){n.RSA="RSA",n.Ed25519="Ed25519",n.secp256k1="secp256k1",n.ECDSA="ECDSA"})(zs||(zs={}));var ah;(function(n){n[n.RSA=0]="RSA",n[n.Ed25519=1]="Ed25519",n[n.secp256k1=2]="secp256k1",n[n.ECDSA=3]="ECDSA"})(ah||(ah={}));(function(n){n.codec=()=>xa(ah)})(zs||(zs={}));var Jc;(function(n){let t;n.codec=()=>(t==null&&(t=Te((e,r,s={})=>{s.lengthDelimited!==!1&&r.fork(),e.Type!=null&&(r.uint32(8),zs.codec().encode(e.Type,r)),e.Data!=null&&e.Data.byteLength>0&&(r.uint32(18),r.bytes(e.Data)),s.lengthDelimited!==!1&&r.ldelim()},(e,r,s={})=>{const i={Data:Ge(0)},o=r==null?e.len:e.pos+r;for(;e.pos<o;){const a=e.uint32();switch(a>>>3){case 1:{i.Type=zs.codec().decode(e);break}case 2:{i.Data=e.bytes();break}default:{e.skipType(a&7);break}}}return i})),t),n.encode=e=>ke(e,n.codec()),n.decode=(e,r)=>Ie(e,n.codec(),r)})(Jc||(Jc={}));const TM="/plaintext/2.0.0";var wy,_y;_y=Symbol.toStringTag,wy=Wn;class CM{constructor(t){p(this,"protocol",TM);p(this,"privateKey");p(this,"log");p(this,_y,"@libp2p/plaintext");p(this,wy,["@libp2p/connection-encryption"]);this.privateKey=t.privateKey,this.log=t.logger.forComponent("libp2p:plaintext")}async secureInbound(t,e){return this._encrypt(t,e)}async secureOutbound(t,e){return this._encrypt(t,e)}async _encrypt(t,e){const r=Wi(t).pb(oh);this.log("write pubkey exchange to peer %p",e?.remotePeer);const s=this.privateKey.publicKey,[,i]=await Promise.all([r.write({id:s.toMultihash().bytes,pubkey:{Type:zs[s.type],Data:s.raw}},e),r.read(e)]);let o;try{if(i.pubkey==null)throw new ec("Public key missing");if(i.pubkey.Data.byteLength===0)throw new ec("Public key data too short");if(i.id==null)throw new ec("Remote id missing");const a=fk(i.pubkey.Data);if(o=ka(a),!It(o.toMultihash().bytes,i.id))throw new Id("Public key did not match id")}catch(a){throw this.log.error(a),new Id("Invalid public key - "+a.message)}if(e?.remotePeer!=null&&!o.equals(e?.remotePeer))throw new nb;return this.log("plaintext key exchange completed successfully with peer %p",o),{conn:r.unwrap().unwrap(),remotePeer:o}}}function PM(){return n=>new CM(n)}var el;(function(n){let t;n.codec=()=>(t==null&&(t=Te((e,r,s={})=>{if(s.lengthDelimited!==!1&&r.fork(),e.publicKey!=null&&e.publicKey.byteLength>0&&(r.uint32(10),r.bytes(e.publicKey)),e.addrs!=null)for(const i of e.addrs)r.uint32(18),r.bytes(i);s.lengthDelimited!==!1&&r.ldelim()},(e,r,s={})=>{const i={publicKey:Ge(0),addrs:[]},o=r==null?e.len:e.pos+r;for(;e.pos<o;){const a=e.uint32();switch(a>>>3){case 1:{i.publicKey=e.bytes();break}case 2:{if(s.limits?.addrs!=null&&i.addrs.length===s.limits.addrs)throw new gt('Decode error - map field "addrs" had too many elements');i.addrs.push(e.bytes());break}default:{e.skipType(a&7);break}}}return i})),t),n.encode=e=>ke(e,n.codec()),n.decode=(e,r)=>Ie(e,n.codec(),r)})(el||(el={}));const DM="_peer-discovery._p2p._pubsub";var Sy,Ey,Ay;class MM extends(Ay=ar,Ey=wc,Sy=Symbol.toStringTag,Ay){constructor(e,r={}){super();p(this,Ey,!0);p(this,Sy,"@libp2p/pubsub-peer-discovery");p(this,"interval");p(this,"listenOnly");p(this,"topics");p(this,"intervalId");p(this,"components");p(this,"log");const{interval:s,topics:i,listenOnly:o}=r;this.components=e,this.interval=s??1e4,this.listenOnly=o??!1,this.log=e.logger.forComponent("libp2p:discovery:pubsub"),Array.isArray(i)&&i.length>0?this.topics=i:this.topics=[DM],this._onMessage=this._onMessage.bind(this)}isStarted(){return this.intervalId!=null}start(){}afterStart(){if(this.intervalId!=null)return;const e=this.components.pubsub;if(e==null)throw new Error("PubSub not configured");for(const r of this.topics)e.subscribe(r),e.addEventListener("message",this._onMessage);this.listenOnly||(this._broadcast(),this.intervalId=setInterval(()=>{this._broadcast()},this.interval))}beforeStop(){const e=this.components.pubsub;if(e==null)throw new Error("PubSub not configured");for(const r of this.topics)e.unsubscribe(r),e.removeEventListener("message",this._onMessage)}stop(){this.intervalId!=null&&(clearInterval(this.intervalId),this.intervalId=void 0)}_broadcast(){const e=this.components.peerId;if(e.publicKey==null)throw new Error("PeerId was missing public key");const r={publicKey:nr(e.publicKey),addrs:this.components.addressManager.getAddresses().map(o=>o.bytes)},s=el.encode(r),i=this.components.pubsub;if(i==null)throw new Error("PubSub not configured");for(const o of this.topics){if(i.getSubscribers(o).length===0){this.log("skipping broadcasting our peer data on topic %s because there are no peers present",o);continue}this.log("broadcasting our peer data on topic %s",o),i.publish(o,s)}}_onMessage(e){if(!this.isStarted())return;const r=e.detail;if(this.topics.includes(r.topic))try{const s=el.decode(r.data),i=Lr(s.publicKey),o=ka(i);if(o.equals(this.components.peerId))return;this.log("discovered peer %p on %s",o,r.topic),this.safeDispatchEvent("peer",{detail:{id:o,multiaddrs:s.addrs.map(a=>me(a))}})}catch(s){this.log.error("error handling incoming message",s)}}}function LM(n={}){return t=>new MM(t,n)}const BM=[pe("tcp").code,pe("dns").code,pe("dnsaddr").code,pe("dns4").code,pe("dns6").code];function nm(n){return T_("sni",n)?.[1]}function rm(n){const t=T_("tcp",n)?.[1];return t==null?"":`:${t}`}function T_(n,t){let e;try{e=pe(n).code}catch{return}for(const[r,s]of t)if(r===e&&s!=null)return[r,s]}function sm(n){return n.some(([t,e])=>t===pe("tls").code)}function Nn(n,t,e){const r=C_[pe(n).name];if(r==null)throw new Error(`Can't interpret protocol ${pe(n).name}`);const s=r(t,e);return n===pe("ip6").code?`[${s}]`:s}const C_={ip4:(n,t)=>n,ip6:(n,t)=>t.length===0?n:`[${n}]`,tcp:(n,t)=>{const e=t.pop();if(e==null)throw new Error("Unexpected end of multiaddr");return`tcp://${Nn(e[0],e[1]??"",t)}:${n}`},udp:(n,t)=>{const e=t.pop();if(e==null)throw new Error("Unexpected end of multiaddr");return`udp://${Nn(e[0],e[1]??"",t)}:${n}`},dnsaddr:(n,t)=>n,dns4:(n,t)=>n,dns6:(n,t)=>n,dns:(n,t)=>n,ipfs:(n,t)=>{const e=t.pop();if(e==null)throw new Error("Unexpected end of multiaddr");return`${Nn(e[0],e[1]??"",t)}`},p2p:(n,t)=>{const e=t.pop();if(e==null)throw new Error("Unexpected end of multiaddr");return`${Nn(e[0],e[1]??"",t)}`},http:(n,t)=>{const e=sm(t),r=nm(t),s=rm(t);if(e&&r!=null)return`https://${r}${s}`;const i=e?"https://":"http://",o=t.pop();if(o==null)throw new Error("Unexpected end of multiaddr");let a=Nn(o[0],o[1]??"",t);return a=a.replace("tcp://",""),`${i}${a}`},"http-path":(n,t)=>{const e=t.pop();if(e==null)throw new Error("Unexpected end of multiaddr");const r=Nn(e[0],e[1]??"",t),s=decodeURIComponent(n);return`${r}/${s}`},tls:(n,t)=>{const e=t.pop();if(e==null)throw new Error("Unexpected end of multiaddr");return Nn(e[0],e[1]??"",t)},sni:(n,t)=>{const e=t.pop();if(e==null)throw new Error("Unexpected end of multiaddr");return Nn(e[0],e[1]??"",t)},https:(n,t)=>{const e=t.pop();if(e==null)throw new Error("Unexpected end of multiaddr");let r=Nn(e[0],e[1]??"",t);return r=r.replace("tcp://",""),`https://${r}`},ws:(n,t)=>{const e=sm(t),r=nm(t),s=rm(t);if(e&&r!=null)return`wss://${r}${s}`;const i=e?"wss://":"ws://",o=t.pop();if(o==null)throw new Error("Unexpected end of multiaddr");let a=Nn(o[0],o[1]??"",t);return a=a.replace("tcp://",""),`${i}${a}`},wss:(n,t)=>{const e=t.pop();if(e==null)throw new Error("Unexpected end of multiaddr");let r=Nn(e[0],e[1]??"",t);return r=r.replace("tcp://",""),`wss://${r}`}};function NM(n,t){const r=me(n).stringTuples(),s=r.pop();if(s==null)throw new Error("Unexpected end of multiaddr");const i=pe(s[0]),o=C_[i.name];if(o==null)throw new Error(`No interpreter found for ${i.name}`);let a=o(s[1]??"",r);return BM.includes(s[0])&&(a=a.replace(/^.*:\/\//,""),s[1]==="443"?a=`https://${a}`:a=`http://${a}`),(a.startsWith("http://")||a.startsWith("https://")||a.startsWith("ws://")||a.startsWith("wss://"))&&(a=new URL(a).toString(),a.endsWith("/")&&(a=a.substring(0,a.length-1))),a}const RM=async n=>{if(n.readyState>=2)throw new Error("socket closed");n.readyState!==1&&await new Promise((t,e)=>{function r(){n.removeEventListener("open",s),n.removeEventListener("error",i)}function s(){r(),t()}function i(o){r(),e(o.error??new Error(`connect ECONNREFUSED ${n.url}`))}n.addEventListener("open",s),n.addEventListener("error",i)})},OM=(n,t)=>(t=t??{},t.closeOnEnd=t.closeOnEnd!==!1,async r=>{for await(const s of r){try{await RM(n)}catch(i){if(i.message==="socket closed")break;throw i}if(n.readyState===n.CLOSING||n.readyState===n.CLOSED)break;n.send(s)}t.closeOnEnd!=null&&n.readyState<=1&&await new Promise((s,i)=>{n.addEventListener("close",o=>{if(o.wasClean||o.code===1006)s();else{const a=Object.assign(new Error("ws error"),{event:o});i(a)}}),setTimeout(()=>{n.close()})})});var di={},Io={},im;function FM(){if(im)return Io;im=1,Object.defineProperty(Io,"__esModule",{value:!0});class n{constructor(){this.pullQueue=[],this.pushQueue=[],this.eventHandlers={},this.isPaused=!1,this.isStopped=!1}push(r){if(this.isStopped)return;const s={value:r,done:!1};if(this.pullQueue.length){const i=this.pullQueue.shift();i&&i.resolve(s)}else this.pushQueue.push(Promise.resolve(s)),this.highWaterMark!==void 0&&this.pushQueue.length>=this.highWaterMark&&!this.isPaused&&(this.isPaused=!0,this.eventHandlers.highWater?this.eventHandlers.highWater():console&&console.warn(`EventIterator queue reached ${this.pushQueue.length} items`))}stop(){if(!this.isStopped){this.isStopped=!0,this.remove();for(const r of this.pullQueue)r.resolve({value:void 0,done:!0});this.pullQueue.length=0}}fail(r){if(!this.isStopped)if(this.isStopped=!0,this.remove(),this.pullQueue.length){for(const s of this.pullQueue)s.reject(r);this.pullQueue.length=0}else{const s=Promise.reject(r);s.catch(()=>{}),this.pushQueue.push(s)}}remove(){Promise.resolve().then(()=>{this.removeCallback&&this.removeCallback()})}[Symbol.asyncIterator](){return{next:r=>{const s=this.pushQueue.shift();return s?(this.lowWaterMark!==void 0&&this.pushQueue.length<=this.lowWaterMark&&this.isPaused&&(this.isPaused=!1,this.eventHandlers.lowWater&&this.eventHandlers.lowWater()),s):this.isStopped?Promise.resolve({value:void 0,done:!0}):new Promise((i,o)=>{this.pullQueue.push({resolve:i,reject:o})})},return:()=>(this.isStopped=!0,this.pushQueue.length=0,this.remove(),Promise.resolve({value:void 0,done:!0}))}}}class t{constructor(r,{highWaterMark:s=100,lowWaterMark:i=1}={}){const o=new n;o.highWaterMark=s,o.lowWaterMark=i,o.removeCallback=r({push:a=>o.push(a),stop:()=>o.stop(),fail:a=>o.fail(a),on:(a,l)=>{o.eventHandlers[a]=l}})||(()=>{}),this[Symbol.asyncIterator]=()=>o[Symbol.asyncIterator](),Object.freeze(this)}}return Io.EventIterator=t,Io.default=t,Io}var om;function $M(){if(om)return di;om=1,Object.defineProperty(di,"__esModule",{value:!0});const n=FM();di.EventIterator=n.EventIterator;function t(e,r,s){return new n.EventIterator(({push:i})=>(this.addEventListener(e,i,r),()=>this.removeEventListener(e,i,r)),s)}return di.subscribe=t,di.default=n.EventIterator,di}var UM=$M();function am(n){return n instanceof ArrayBuffer||n?.constructor?.name==="ArrayBuffer"&&typeof n?.byteLength=="number"}const VM=n=>{n.binaryType="arraybuffer";const t=async()=>{await new Promise((i,o)=>{if(r){i();return}if(s!=null){o(s);return}const a=h=>{n.removeEventListener("open",l),n.removeEventListener("error",u),h()},l=()=>{a(i)},u=h=>{a(()=>{o(h.error??new Error(`connect ECONNREFUSED ${n.url}`))})};n.addEventListener("open",l),n.addEventListener("error",u)})},e=async function*(){const i=new UM.EventIterator(({push:o,stop:a,fail:l})=>{const u=c=>{let d=null;typeof c.data=="string"&&(d=te(c.data)),am(c.data)&&(d=new Uint8Array(c.data)),c.data instanceof Uint8Array&&(d=c.data),d!=null&&o(d)},h=c=>{l(c.error??new Error("Socket error"))};return n.addEventListener("message",u),n.addEventListener("error",h),n.addEventListener("close",a),()=>{n.removeEventListener("message",u),n.removeEventListener("error",h),n.removeEventListener("close",a)}},{highWaterMark:1/0});await t();for await(const o of i)yield am(o)?new Uint8Array(o):o}();let r=n.readyState===1,s;return n.addEventListener("open",()=>{r=!0,s=null}),n.addEventListener("close",()=>{r=!1,s=null}),n.addEventListener("error",i=>{r||(s=i.error??new Error(`connect ECONNREFUSED ${n.url}`))}),Object.assign(e,{connected:t})},HM=(n,t)=>{t=t??{};const e=VM(n);let r=t.remoteAddress,s=t.remotePort;if(n.url!=null)try{const o=new URL(n.url);r=o.hostname,s=parseInt(o.port,10)}catch{}if(r==null||s==null)throw new Error("Remote connection did not have address and/or port");return{sink:OM(n,t),source:e,connected:async()=>{await e.connected()},close:async()=>{(n.readyState===n.CONNECTING||n.readyState===n.OPEN)&&await new Promise(o=>{n.addEventListener("close",()=>{o()}),n.close()})},destroy:()=>{n.terminate!=null?n.terminate():n.close()},remoteAddress:r,remotePort:s,socket:n}},zM=WebSocket,qM={"http:":"ws:","https:":"wss:"},cm="ws:",WM=(n,t)=>{if(n.startsWith("//")&&(n=`${t?.protocol??cm}${n}`),n.startsWith("/")&&t!=null){const r=t.protocol??cm,s=t.host,i=t.port!=null&&s?.endsWith(`:${t.port}`)!==!0?`:${t.port}`:"";n=`${r}//${s}${i}${n}`}const e=new URL(n);for(const[r,s]of Object.entries(qM))e.protocol===r&&(e.protocol=s);return e};function GM(n,t){const e=typeof window>"u"?void 0:window.location;t=t??{};const r=WM(n,e),s=new zM(r.toString(),t.websocket);return HM(s,t)}function KM(n){return n.filter(t=>Gc.exactMatch(t)||ra.exactMatch(t))}function YM(){throw new Error("WebSocket Servers can not be created in the browser!")}const QM=500;function ZM(n,t,e){const r=e.logger.forComponent("libp2p:websockets:maconn"),s=e.metrics,i=e.metricPrefix??"",o={log:r,async sink(a){try{await n.sink(async function*(){for await(const l of a)l instanceof Uint8Array?yield l:yield l.subarray()}())}catch(l){l.type!=="aborted"&&r.error(l)}},source:n.source,remoteAddr:t,timeline:{open:Date.now()},async close(a={}){const l=Date.now();if(a.signal==null){const h=AbortSignal.timeout(QM);a={...a,signal:h}}const u=()=>{const{host:h,port:c}=o.remoteAddr.toOptions();r("timeout closing stream to %s:%s after %dms, destroying it manually",h,c,Date.now()-l),this.abort(new Ls("Socket close timeout"))};a.signal?.addEventListener("abort",u);try{await n.close()}catch(h){r.error("error closing WebSocket gracefully",h),this.abort(h)}finally{a.signal?.removeEventListener("abort",u),o.timeline.close=Date.now()}},abort(a){const{host:l,port:u}=o.remoteAddr.toOptions();r("timeout closing stream to %s:%s due to error",l,u,a),n.destroy(),o.timeline.close=Date.now(),s?.increment({[`${i}error`]:!0})}};return n.socket.addEventListener("close",()=>{s?.increment({[`${i}close`]:!0}),o.timeline.close==null&&(o.timeline.close=Date.now())},{once:!0}),o}var xy,Iy,ky;ky=tb,Iy=Symbol.toStringTag,xy=Wn;class XM{constructor(t,e={}){p(this,"log");p(this,"init");p(this,"logger");p(this,"metrics");p(this,"components");p(this,ky,!0);p(this,Iy,"@libp2p/websockets");p(this,xy,["@libp2p/transport"]);this.log=t.logger.forComponent("libp2p:websockets"),this.logger=t.logger,this.components=t,this.init=e,t.metrics!=null&&(this.metrics={dialerEvents:t.metrics.registerCounterGroup("libp2p_websockets_dialer_events_total",{label:"event",help:"Total count of WebSockets dialer events by type"})})}async dial(t,e){this.log("dialing %s",t),e=e??{};const r=await this._connect(t,e),s=ZM(r,t,{logger:this.logger,metrics:this.metrics?.dialerEvents});this.log("new outbound connection %s",s.remoteAddr);const i=await e.upgrader.upgradeOutbound(s,e);return this.log("outbound connection %s upgraded",s.remoteAddr),i}async _connect(t,e){e?.signal?.throwIfAborted();const r=t.toOptions();this.log("dialing %s:%s",r.host,r.port);const s=bt(),i=GM(NM(t),this.init);i.socket.addEventListener("error",()=>{const o=new sb(`Could not connect to ${t.toString()}`);this.log.error("connection error:",o),this.metrics?.dialerEvents.increment({error:!0}),s.reject(o)});try{e.onProgress?.(new vt("websockets:open-connection")),await Ir(Promise.race([i.connected(),s.promise]),e.signal)}catch(o){throw e.signal?.aborted&&this.metrics?.dialerEvents.increment({abort:!0}),i.close().catch(a=>{this.log.error("error closing raw socket",a)}),o}return this.log("connected %s",t),this.metrics?.dialerEvents.increment({connect:!0}),i}createListener(t){return YM({logger:this.logger,events:this.components.events,metrics:this.components.metrics},{...this.init,...t})}listenFilter(t){return t=Array.isArray(t)?t:[t],this.init?.filter!=null?this.init?.filter(t):KM(t)}dialFilter(t){return this.listenFilter(t)}}function jM(n={}){return t=>new XM(t,n)}const JM="SHARDING";function eL(n){return n[Symbol.asyncIterator]!=null}function Qr(n,t){let e=0;if(eL(n))return async function*(){for await(const l of n)await t(l,e++)&&(yield l)}();const r=Aw(n),{value:s,done:i}=r.next();if(i===!0)return function*(){}();const o=t(s,e++);if(typeof o.then=="function")return async function*(){await o&&(yield s);for await(const l of r)await t(l,e++)&&(yield l)}();const a=t;return function*(){o===!0&&(yield s);for(const l of r)a(l,e++)&&(yield l)}()}function tL(n){return n[Symbol.asyncIterator]!=null}function ch(n){if(tL(n))return(async()=>{const e=[];for await(const r of n)e.push(r);return e})();const t=[];for(const e of n)t.push(e);return t}function nL(n){return n[Symbol.asyncIterator]!=null}function tl(n,t){return nL(n)?async function*(){yield*(await ch(n)).sort(t)}():function*(){yield*ch(n).sort(t)}()}function rL(n){return n[Symbol.asyncIterator]!=null}function lm(n,t){return rL(n)?async function*(){let e=0;if(!(t<1)){for await(const r of n)if(yield r,e++,e===t)return}}():function*(){let e=0;if(!(t<1)){for(const r of n)if(yield r,e++,e===t)return}}()}class P_{put(t,e,r){return Promise.reject(new Error(".put is not implemented"))}get(t,e){return Promise.reject(new Error(".get is not implemented"))}has(t,e){return Promise.reject(new Error(".has is not implemented"))}delete(t,e){return Promise.reject(new Error(".delete is not implemented"))}async*putMany(t,e={}){for await(const{key:r,value:s}of t)await this.put(r,s,e),yield r}async*getMany(t,e={}){for await(const r of t)yield{key:r,value:await this.get(r,e)}}async*deleteMany(t,e={}){for await(const r of t)await this.delete(r,e),yield r}batch(){let t=[],e=[];return{put(r,s){t.push({key:r,value:s})},delete(r){e.push(r)},commit:async r=>{await em(this.putMany(t,r)),t=[],await em(this.deleteMany(e,r)),e=[]}}}async*_all(t,e){throw new Error("._all is not implemented")}async*_allKeys(t,e){throw new Error("._allKeys is not implemented")}query(t,e){let r=this._all(t,e);if(t.prefix!=null){const s=t.prefix;r=Qr(r,i=>i.key.toString().startsWith(s))}if(Array.isArray(t.filters)&&(r=t.filters.reduce((s,i)=>Qr(s,i),r)),Array.isArray(t.orders)&&(r=t.orders.reduce((s,i)=>tl(s,i),r)),t.offset!=null){let s=0;const i=t.offset;r=Qr(r,()=>s++>=i)}return t.limit!=null&&(r=lm(r,t.limit)),r}queryKeys(t,e){let r=this._allKeys(t,e);if(t.prefix!=null){const s=t.prefix;r=Qr(r,i=>i.toString().startsWith(s))}if(Array.isArray(t.filters)&&(r=t.filters.reduce((s,i)=>Qr(s,i),r)),Array.isArray(t.orders)&&(r=t.orders.reduce((s,i)=>tl(s,i),r)),t.offset!=null){const s=t.offset;let i=0;r=Qr(r,()=>i++>=s)}return t.limit!=null&&(r=lm(r,t.limit)),r}}const yi=class yi extends Error{constructor(e="Open failed"){super(e);p(this,"name",yi.name);p(this,"code",yi.code)}};p(yi,"name","OpenFailedError"),p(yi,"code","ERR_OPEN_FAILED");let lh=yi;const vi=class vi extends Error{constructor(e="Put failed"){super(e);p(this,"name",vi.name);p(this,"code",vi.code)}};p(vi,"name","PutFailedError"),p(vi,"code","ERR_PUT_FAILED");let uh=vi;const bi=class bi extends Error{constructor(e="Get failed"){super(e);p(this,"name",bi.name);p(this,"code",bi.code)}};p(bi,"name","GetFailedError"),p(bi,"code","ERR_GET_FAILED");let nl=bi;const wi=class wi extends Error{constructor(e="Delete failed"){super(e);p(this,"name",wi.name);p(this,"code",wi.code)}};p(wi,"name","DeleteFailedError"),p(wi,"code","ERR_DELETE_FAILED");let dh=wi;const _i=class _i extends Error{constructor(e="Not Found"){super(e);p(this,"name",_i.name);p(this,"code",_i.code)}};p(_i,"name","NotFoundError"),p(_i,"code","ERR_NOT_FOUND");let rl=_i;class sL extends P_{constructor(){super();p(this,"data");this.data=new Map}put(e,r){return this.data.set(e.toString(),r),e}get(e){const r=this.data.get(e.toString());if(r==null)throw new rl;return r}has(e){return this.data.has(e.toString())}delete(e){this.data.delete(e.toString())}*_all(){for(const[e,r]of this.data.entries())yield{key:new ut(e),value:r}}*_allKeys(){for(const e of this.data.keys())yield new ut(e)}}new ut(JM);I_("datastore:core:tiered");const hh=(n,t)=>t.some(e=>n instanceof e);let um,dm;function iL(){return um||(um=[IDBDatabase,IDBObjectStore,IDBIndex,IDBCursor,IDBTransaction])}function oL(){return dm||(dm=[IDBCursor.prototype.advance,IDBCursor.prototype.continue,IDBCursor.prototype.continuePrimaryKey])}const fh=new WeakMap,$u=new WeakMap,Jl=new WeakMap;function aL(n){const t=new Promise((e,r)=>{const s=()=>{n.removeEventListener("success",i),n.removeEventListener("error",o)},i=()=>{e(os(n.result)),s()},o=()=>{r(n.error),s()};n.addEventListener("success",i),n.addEventListener("error",o)});return Jl.set(t,n),t}function cL(n){if(fh.has(n))return;const t=new Promise((e,r)=>{const s=()=>{n.removeEventListener("complete",i),n.removeEventListener("error",o),n.removeEventListener("abort",o)},i=()=>{e(),s()},o=()=>{r(n.error||new DOMException("AbortError","AbortError")),s()};n.addEventListener("complete",i),n.addEventListener("error",o),n.addEventListener("abort",o)});fh.set(n,t)}let ph={get(n,t,e){if(n instanceof IDBTransaction){if(t==="done")return fh.get(n);if(t==="store")return e.objectStoreNames[1]?void 0:e.objectStore(e.objectStoreNames[0])}return os(n[t])},set(n,t,e){return n[t]=e,!0},has(n,t){return n instanceof IDBTransaction&&(t==="done"||t==="store")?!0:t in n}};function D_(n){ph=n(ph)}function lL(n){return oL().includes(n)?function(...t){return n.apply(gh(this),t),os(this.request)}:function(...t){return os(n.apply(gh(this),t))}}function uL(n){return typeof n=="function"?lL(n):(n instanceof IDBTransaction&&cL(n),hh(n,iL())?new Proxy(n,ph):n)}function os(n){if(n instanceof IDBRequest)return aL(n);if($u.has(n))return $u.get(n);const t=uL(n);return t!==n&&($u.set(n,t),Jl.set(t,n)),t}const gh=n=>Jl.get(n);function dL(n,t,{blocked:e,upgrade:r,blocking:s,terminated:i}={}){const o=indexedDB.open(n,t),a=os(o);return r&&o.addEventListener("upgradeneeded",l=>{r(os(o.result),l.oldVersion,l.newVersion,os(o.transaction),l)}),e&&o.addEventListener("blocked",l=>e(l.oldVersion,l.newVersion,l)),a.then(l=>{i&&l.addEventListener("close",()=>i()),s&&l.addEventListener("versionchange",u=>s(u.oldVersion,u.newVersion,u))}).catch(()=>{}),a}function hL(n,{blocked:t}={}){const e=indexedDB.deleteDatabase(n);return t&&e.addEventListener("blocked",r=>t(r.oldVersion,r)),os(e).then(()=>{})}const fL=["get","getKey","getAll","getAllKeys","count"],pL=["put","add","delete","clear"],Uu=new Map;function hm(n,t){if(!(n instanceof IDBDatabase&&!(t in n)&&typeof t=="string"))return;if(Uu.get(t))return Uu.get(t);const e=t.replace(/FromIndex$/,""),r=t!==e,s=pL.includes(e);if(!(e in(r?IDBIndex:IDBObjectStore).prototype)||!(s||fL.includes(e)))return;const i=async function(o,...a){const l=this.transaction(o,s?"readwrite":"readonly");let u=l.store;return r&&(u=u.index(a.shift())),(await Promise.all([u[e](...a),s&&l.done]))[0]};return Uu.set(t,i),i}D_(n=>({...n,get:(t,e,r)=>hm(t,e)||n.get(t,e,r),has:(t,e)=>!!hm(t,e)||n.has(t,e)}));const gL=["continue","continuePrimaryKey","advance"],fm={},mh=new WeakMap,M_=new WeakMap,mL={get(n,t){if(!gL.includes(t))return n[t];let e=fm[t];return e||(e=fm[t]=function(...r){mh.set(this,M_.get(this)[t](...r))}),e}};async function*yL(...n){let t=this;if(t instanceof IDBCursor||(t=await t.openCursor(...n)),!t)return;t=t;const e=new Proxy(t,mL);for(M_.set(e,t),Jl.set(e,gh(t));t;)yield e,t=await(mh.get(e)||t.continue()),mh.delete(e)}function pm(n,t){return t===Symbol.asyncIterator&&hh(n,[IDBIndex,IDBObjectStore,IDBCursor])||t==="iterate"&&hh(n,[IDBIndex,IDBObjectStore])}D_(n=>({...n,get(t,e,r){return pm(t,e)?yL:n.get(t,e,r)},has(t,e){return pm(t,e)||n.has(t,e)}}));var da,yh;class vL extends P_{constructor(e,r={}){super();_e(this,da);p(this,"location");p(this,"version");p(this,"db");this.location=`${r.prefix??""}${e}`,this.version=r.version??1}async open(){try{const e=this.location;this.db=await dL(e,this.version,{upgrade(r){r.createObjectStore(e)}})}catch(e){throw new lh(String(e))}}async close(){this.db?.close()}async put(e,r){if(this.db==null)throw new Error("Datastore needs to be opened.");try{return await this.db.put(this.location,r,e.toString()),e}catch(s){throw new uh(String(s))}}async get(e){if(this.db==null)throw new Error("Datastore needs to be opened.");let r;try{r=await this.db.get(this.location,e.toString())}catch(s){throw new nl(String(s))}if(r===void 0)throw new rl;return r}async has(e){if(this.db==null)throw new Error("Datastore needs to be opened.");try{return!!await this.db.getKey(this.location,e.toString())}catch(r){throw new nl(String(r))}}async delete(e){if(this.db==null)throw new Error("Datastore needs to be opened.");try{await this.db.delete(this.location,e.toString())}catch(r){throw new dh(String(r))}}batch(){const e=[],r=[];return{put(s,i){e.push({key:s,value:i})},delete(s){r.push(s)},commit:async()=>{if(this.db==null)throw new Error("Datastore needs to be opened.");const s=this.db.transaction(this.location,"readwrite");try{const i=e.filter(({key:o})=>r.find(a=>a.toString()===o.toString())==null).map(o=>async()=>{await s.store.put(o.value,o.key.toString())}).concat(r.map(o=>async()=>{await s.store.delete(o.toString())})).concat(async()=>{await s.done});await Promise.all(i.map(async o=>{await o()}))}catch{s.abort()}}}}async*query(e){let r=ue(this,da,yh).call(this,e,(s,i)=>({key:s,value:i}));Array.isArray(e.filters)&&(r=e.filters.reduce((s,i)=>Qr(s,i),r)),Array.isArray(e.orders)&&(r=e.orders.reduce((s,i)=>tl(s,i),r)),yield*r}async*queryKeys(e){let r=ue(this,da,yh).call(this,e,s=>s);Array.isArray(e.filters)&&(r=e.filters.reduce((s,i)=>Qr(s,i),r)),Array.isArray(e.orders)&&(r=e.orders.reduce((s,i)=>tl(s,i),r)),yield*r}async destroy(){await hL(this.location)}}da=new WeakSet,yh=async function*(e,r){if(this.db==null)throw new Error("Datastore needs to be opened.");let s=0,i=-1;for(const o of await this.db.getAllKeys(this.location)){if(e.prefix!=null&&!o.toString().startsWith(e.prefix))continue;if(e.limit!=null&&s===e.limit)return;if(i++,e.offset!=null&&i<e.offset)continue;const a=new ut(o.toString());let l;try{l=await this.get(a)}catch(u){if(u.name!=="NotFoundError")throw u;continue}l!=null&&(yield r(a,l),s++)}};var Vu={exports:{}},gm;function bL(){return gm||(gm=1,function(n){var t=Object.prototype.hasOwnProperty,e="~";function r(){}Object.create&&(r.prototype=Object.create(null),new r().__proto__||(e=!1));function s(l,u,h){this.fn=l,this.context=u,this.once=h||!1}function i(l,u,h,c,d){if(typeof h!="function")throw new TypeError("The listener must be a function");var f=new s(h,c||l,d),g=e?e+u:u;return l._events[g]?l._events[g].fn?l._events[g]=[l._events[g],f]:l._events[g].push(f):(l._events[g]=f,l._eventsCount++),l}function o(l,u){--l._eventsCount===0?l._events=new r:delete l._events[u]}function a(){this._events=new r,this._eventsCount=0}a.prototype.eventNames=function(){var u=[],h,c;if(this._eventsCount===0)return u;for(c in h=this._events)t.call(h,c)&&u.push(e?c.slice(1):c);return Object.getOwnPropertySymbols?u.concat(Object.getOwnPropertySymbols(h)):u},a.prototype.listeners=function(u){var h=e?e+u:u,c=this._events[h];if(!c)return[];if(c.fn)return[c.fn];for(var d=0,f=c.length,g=new Array(f);d<f;d++)g[d]=c[d].fn;return g},a.prototype.listenerCount=function(u){var h=e?e+u:u,c=this._events[h];return c?c.fn?1:c.length:0},a.prototype.emit=function(u,h,c,d,f,g){var y=e?e+u:u;if(!this._events[y])return!1;var m=this._events[y],v=arguments.length,_,w;if(m.fn){switch(m.once&&this.removeListener(u,m.fn,void 0,!0),v){case 1:return m.fn.call(m.context),!0;case 2:return m.fn.call(m.context,h),!0;case 3:return m.fn.call(m.context,h,c),!0;case 4:return m.fn.call(m.context,h,c,d),!0;case 5:return m.fn.call(m.context,h,c,d,f),!0;case 6:return m.fn.call(m.context,h,c,d,f,g),!0}for(w=1,_=new Array(v-1);w<v;w++)_[w-1]=arguments[w];m.fn.apply(m.context,_)}else{var S=m.length,E;for(w=0;w<S;w++)switch(m[w].once&&this.removeListener(u,m[w].fn,void 0,!0),v){case 1:m[w].fn.call(m[w].context);break;case 2:m[w].fn.call(m[w].context,h);break;case 3:m[w].fn.call(m[w].context,h,c);break;case 4:m[w].fn.call(m[w].context,h,c,d);break;default:if(!_)for(E=1,_=new Array(v-1);E<v;E++)_[E-1]=arguments[E];m[w].fn.apply(m[w].context,_)}}return!0},a.prototype.on=function(u,h,c){return i(this,u,h,c,!1)},a.prototype.once=function(u,h,c){return i(this,u,h,c,!0)},a.prototype.removeListener=function(u,h,c,d){var f=e?e+u:u;if(!this._events[f])return this;if(!h)return o(this,f),this;var g=this._events[f];if(g.fn)g.fn===h&&(!d||g.once)&&(!c||g.context===c)&&o(this,f);else{for(var y=0,m=[],v=g.length;y<v;y++)(g[y].fn!==h||d&&!g[y].once||c&&g[y].context!==c)&&m.push(g[y]);m.length?this._events[f]=m.length===1?m[0]:m:o(this,f)}return this},a.prototype.removeAllListeners=function(u){var h;return u?(h=e?e+u:u,this._events[h]&&o(this,h)):(this._events=new r,this._eventsCount=0),this},a.prototype.off=a.prototype.removeListener,a.prototype.addListener=a.prototype.on,a.prefixed=e,a.EventEmitter=a,n.exports=a}(Vu)),Vu.exports}var wL=bL();const _L=co(wL);class L_ extends Error{constructor(t){super(t),this.name="TimeoutError"}}let SL=class extends Error{constructor(t){super(),this.name="AbortError",this.message=t}};const mm=n=>globalThis.DOMException===void 0?new SL(n):new DOMException(n),ym=n=>{const t=n.reason===void 0?mm("This operation was aborted."):n.reason;return t instanceof Error?t:mm(t)};function B_(n,t){const{milliseconds:e,fallback:r,message:s,customTimers:i={setTimeout,clearTimeout}}=t;let o,a;const u=new Promise((h,c)=>{if(typeof e!="number"||Math.sign(e)!==1)throw new TypeError(`Expected \`milliseconds\` to be a positive number, got \`${e}\``);if(t.signal){const{signal:f}=t;f.aborted&&c(ym(f)),a=()=>{c(ym(f))},f.addEventListener("abort",a,{once:!0})}if(e===Number.POSITIVE_INFINITY){n.then(h,c);return}const d=new L_;o=i.setTimeout.call(void 0,()=>{if(r){try{h(r())}catch(f){c(f)}return}typeof n.cancel=="function"&&n.cancel(),s===!1?h():s instanceof Error?c(s):(d.message=s??`Promise timed out after ${e} milliseconds`,c(d))},e),(async()=>{try{h(await n)}catch(f){c(f)}})()}).finally(()=>{u.clear(),a&&t.signal&&t.signal.removeEventListener("abort",a)});return u.clear=()=>{i.clearTimeout.call(void 0,o),o=void 0},u}function EL(n,t,e){let r=0,s=n.length;for(;s>0;){const i=Math.trunc(s/2);let o=r+i;e(n[o],t)<=0?(r=++o,s-=i+1):s=i}return r}var En,Ty;let AL=(Ty=class{constructor(){_e(this,En,[])}enqueue(t,e){e={priority:0,...e};const r={priority:e.priority,id:e.id,run:t};if(this.size===0||$(this,En)[this.size-1].priority>=e.priority){$(this,En).push(r);return}const s=EL($(this,En),r,(i,o)=>o.priority-i.priority);$(this,En).splice(s,0,r)}setPriority(t,e){const r=$(this,En).findIndex(i=>i.id===t);if(r===-1)throw new ReferenceError(`No promise function with the id "${t}" exists in the queue.`);const[s]=$(this,En).splice(r,1);this.enqueue(s.run,{priority:e,id:t})}dequeue(){return $(this,En).shift()?.run}filter(t){return $(this,En).filter(e=>e.priority===t.priority).map(e=>e.run)}get size(){return $(this,En).length}},En=new WeakMap,Ty);var Ci,Pi,es,ha,Di,fa,An,Mi,qt,pa,xn,Li,Sr,ga,cl,xe,N_,R_,O_,F_,$_,rc,bh,wh,sc,U_,ic;class vh extends _L{constructor(e){super();_e(this,xe);_e(this,Ci);_e(this,Pi);_e(this,es,0);_e(this,ha);_e(this,Di);_e(this,fa,0);_e(this,An);_e(this,Mi);_e(this,qt);_e(this,pa);_e(this,xn,0);_e(this,Li);_e(this,Sr);_e(this,ga);_e(this,cl,1n);p(this,"timeout");if(e={carryoverConcurrencyCount:!1,intervalCap:Number.POSITIVE_INFINITY,interval:0,concurrency:Number.POSITIVE_INFINITY,autoStart:!0,queueClass:AL,...e},!(typeof e.intervalCap=="number"&&e.intervalCap>=1))throw new TypeError(`Expected \`intervalCap\` to be a number from 1 and up, got \`${e.intervalCap?.toString()??""}\` (${typeof e.intervalCap})`);if(e.interval===void 0||!(Number.isFinite(e.interval)&&e.interval>=0))throw new TypeError(`Expected \`interval\` to be a finite number >= 0, got \`${e.interval?.toString()??""}\` (${typeof e.interval})`);Pe(this,Ci,e.carryoverConcurrencyCount),Pe(this,Pi,e.intervalCap===Number.POSITIVE_INFINITY||e.interval===0),Pe(this,ha,e.intervalCap),Pe(this,Di,e.interval),Pe(this,qt,new e.queueClass),Pe(this,pa,e.queueClass),this.concurrency=e.concurrency,this.timeout=e.timeout,Pe(this,ga,e.throwOnTimeout===!0),Pe(this,Sr,e.autoStart===!1)}get concurrency(){return $(this,Li)}set concurrency(e){if(!(typeof e=="number"&&e>=1))throw new TypeError(`Expected \`concurrency\` to be a number from 1 and up, got \`${e}\` (${typeof e})`);Pe(this,Li,e),ue(this,xe,sc).call(this)}setPriority(e,r){$(this,qt).setPriority(e,r)}async add(e,r={}){return r.id??(r.id=(vo(this,cl)._++).toString()),r={timeout:this.timeout,throwOnTimeout:$(this,ga),...r},new Promise((s,i)=>{$(this,qt).enqueue(async()=>{vo(this,xn)._++,vo(this,es)._++;try{r.signal?.throwIfAborted();let o=e({signal:r.signal});r.timeout&&(o=B_(Promise.resolve(o),{milliseconds:r.timeout})),r.signal&&(o=Promise.race([o,ue(this,xe,U_).call(this,r.signal)]));const a=await o;s(a),this.emit("completed",a)}catch(o){if(o instanceof L_&&!r.throwOnTimeout){s();return}i(o),this.emit("error",o)}finally{ue(this,xe,O_).call(this)}},r),this.emit("add"),ue(this,xe,rc).call(this)})}async addAll(e,r){return Promise.all(e.map(async s=>this.add(s,r)))}start(){return $(this,Sr)?(Pe(this,Sr,!1),ue(this,xe,sc).call(this),this):this}pause(){Pe(this,Sr,!0)}clear(){Pe(this,qt,new($(this,pa)))}async onEmpty(){$(this,qt).size!==0&&await ue(this,xe,ic).call(this,"empty")}async onSizeLessThan(e){$(this,qt).size<e||await ue(this,xe,ic).call(this,"next",()=>$(this,qt).size<e)}async onIdle(){$(this,xn)===0&&$(this,qt).size===0||await ue(this,xe,ic).call(this,"idle")}get size(){return $(this,qt).size}sizeBy(e){return $(this,qt).filter(e).length}get pending(){return $(this,xn)}get isPaused(){return $(this,Sr)}}Ci=new WeakMap,Pi=new WeakMap,es=new WeakMap,ha=new WeakMap,Di=new WeakMap,fa=new WeakMap,An=new WeakMap,Mi=new WeakMap,qt=new WeakMap,pa=new WeakMap,xn=new WeakMap,Li=new WeakMap,Sr=new WeakMap,ga=new WeakMap,cl=new WeakMap,xe=new WeakSet,N_=function(){return $(this,Pi)||$(this,es)<$(this,ha)},R_=function(){return $(this,xn)<$(this,Li)},O_=function(){vo(this,xn)._--,ue(this,xe,rc).call(this),this.emit("next")},F_=function(){ue(this,xe,wh).call(this),ue(this,xe,bh).call(this),Pe(this,Mi,void 0)},$_=function(){const e=Date.now();if($(this,An)===void 0){const r=$(this,fa)-e;if(r<0)Pe(this,es,$(this,Ci)?$(this,xn):0);else return $(this,Mi)===void 0&&Pe(this,Mi,setTimeout(()=>{ue(this,xe,F_).call(this)},r)),!0}return!1},rc=function(){if($(this,qt).size===0)return $(this,An)&&clearInterval($(this,An)),Pe(this,An,void 0),this.emit("empty"),$(this,xn)===0&&this.emit("idle"),!1;if(!$(this,Sr)){const e=!$(this,xe,$_);if($(this,xe,N_)&&$(this,xe,R_)){const r=$(this,qt).dequeue();return r?(this.emit("active"),r(),e&&ue(this,xe,bh).call(this),!0):!1}}return!1},bh=function(){$(this,Pi)||$(this,An)!==void 0||(Pe(this,An,setInterval(()=>{ue(this,xe,wh).call(this)},$(this,Di))),Pe(this,fa,Date.now()+$(this,Di)))},wh=function(){$(this,es)===0&&$(this,xn)===0&&$(this,An)&&(clearInterval($(this,An)),Pe(this,An,void 0)),Pe(this,es,$(this,Ci)?$(this,xn):0),ue(this,xe,sc).call(this)},sc=function(){for(;ue(this,xe,rc).call(this););},U_=async function(e){return new Promise((r,s)=>{e.addEventListener("abort",()=>{s(e.reason)},{once:!0})})},ic=async function(e,r){return new Promise(s=>{const i=()=>{r&&!r()||(this.off(e,i),s())};this.on(e,i)})};function V_(n){const t=[ds.A];return n==null?t:Array.isArray(n)?n.length===0?t:n:[n]}const H_=60;function z_(n){return{Status:n.Status??0,TC:n.TC??n.flag_tc??!1,RD:n.RD??n.flag_rd??!1,RA:n.RA??n.flag_ra??!1,AD:n.AD??n.flag_ad??!1,CD:n.CD??n.flag_cd??!1,Question:(n.Question??n.questions??[]).map(t=>({name:t.name,type:ds[t.type]})),Answer:(n.Answer??n.answers??[]).map(t=>({name:t.name,type:ds[t.type],TTL:t.TTL??t.ttl??H_,data:t.data instanceof Uint8Array?de(t.data):t.data}))}}const xL=4;function vm(n,t={}){const e=new vh({concurrency:t.queryConcurrency??xL});return async(r,s={})=>{const i=new URLSearchParams;i.set("name",r),V_(s.types).forEach(a=>{i.append("type",ds[a])}),s.onProgress?.(new vt("dns:query",{detail:r}));const o=await e.add(async()=>{const a=await fetch(`${n}?${i}`,{headers:{accept:"application/dns-json"},signal:s?.signal});if(a.status!==200)throw new Error(`Unexpected HTTP status: ${a.status} - ${a.statusText}`);const l=z_(await a.json());return s.onProgress?.(new vt("dns:response",{detail:l})),l},{signal:s.signal});if(o==null)throw new Error("No DNS response received");return o}}function IL(){return[vm("https://cloudflare-dns.com/dns-query"),vm("https://dns.google/resolve")]}var Hu,bm;function kL(){return bm||(bm=1,Hu=function(n){if(!n)throw Error("hashlru must have a max value, of type number, greater than 0");var t=0,e=Object.create(null),r=Object.create(null);function s(i,o){e[i]=o,t++,t>=n&&(t=0,r=e,e=Object.create(null))}return{has:function(i){return e[i]!==void 0||r[i]!==void 0},remove:function(i){e[i]!==void 0&&(e[i]=void 0),r[i]!==void 0&&(r[i]=void 0)},get:function(i){var o=e[i];if(o!==void 0)return o;if((o=r[i])!==void 0)return s(i,o),o},set:function(i,o){e[i]!==void 0?e[i]=o:s(i,o)},clear:function(){e=Object.create(null),r=Object.create(null)}}}),Hu}var TL=kL();const CL=co(TL);class PL{constructor(t){p(this,"lru");this.lru=CL(t)}get(t,e){let r=!0;const s=[];for(const i of e){const o=this.getAnswers(t,i);if(o.length===0){r=!1;break}s.push(...o)}if(r)return z_({answers:s})}getAnswers(t,e){const r=`${t.toLowerCase()}-${e}`,s=this.lru.get(r);if(s!=null){const i=s.filter(o=>o.expires>Date.now()).map(({expires:o,value:a})=>({...a,TTL:Math.round((o-Date.now())/1e3),type:ds[a.type]}));return i.length===0&&this.lru.remove(r),i}return[]}add(t,e){const r=`${t.toLowerCase()}-${e.type}`,s=this.lru.get(r)??[];s.push({expires:Date.now()+(e.TTL??H_)*1e3,value:e}),this.lru.set(r,s)}remove(t,e){const r=`${t.toLowerCase()}-${e}`;this.lru.remove(r)}clear(){this.lru.clear()}}function DL(n){return new PL(n)}const ML=1e3;class LL{constructor(t){p(this,"resolvers");p(this,"cache");this.resolvers={},this.cache=DL(t.cacheSize??ML),Object.entries(t.resolvers??{}).forEach(([e,r])=>{Array.isArray(r)||(r=[r]),e.endsWith(".")||(e=`${e}.`),this.resolvers[e]=r}),this.resolvers["."]==null&&(this.resolvers["."]=IL())}async query(t,e={}){const r=V_(e.types),s=e.cached!==!1?this.cache.get(t,r):void 0;if(s!=null)return e.onProgress?.(new vt("dns:cache",{detail:s})),s;const i=`${t.split(".").pop()}.`,o=(this.resolvers[i]??this.resolvers["."]).sort(()=>Math.random()>.5?-1:1),a=[];for(const l of o){if(e.signal?.aborted===!0)break;try{const u=await l(t,{...e,types:r});for(const h of u.Answer)this.cache.add(t,h);return u}catch(u){a.push(u),e.onProgress?.(new vt("dns:error",{detail:u}))}}throw a.length===1?a[0]:new AggregateError(a,`DNS lookup of ${t} ${r} failed`)}}var ds;(function(n){n[n.A=1]="A",n[n.CNAME=5]="CNAME",n[n.TXT=16]="TXT",n[n.AAAA=28]="AAAA"})(ds||(ds={}));function BL(n={}){return new LL(n)}const NL=32,{code:RL}=pe("dnsaddr");class OL extends Error{constructor(t="Max recursive depth reached"){super(t),this.name="RecursionLimitError"}}const q_=async function(t,e={}){const r=e.maxRecursiveDepth??NL;if(r===0)throw new OL("Max recursive depth reached");const[,s]=t.stringTuples().find(([u])=>u===RL)??[],o=await(e?.dns??BL()).query(`_dnsaddr.${s}`,{signal:e?.signal,types:[ds.TXT]}),a=t.getPeerId(),l=[];for(const u of o.Answer){const h=u.data.replace(/["']/g,"").trim().split("=")[1];if(h==null||a!=null&&!h.includes(a))continue;const c=me(h);if(h.startsWith("/dnsaddr")){const d=await c.resolve({...e,maxRecursiveDepth:r-1});l.push(...d.map(f=>f.toString()))}else l.push(c.toString())}return l},FL={addresses:{listen:[],announce:[],noAnnounce:[],announceFilter:n=>n},connectionManager:{resolvers:{dnsaddr:q_}},transportManager:{faultTolerance:Yo.FATAL_ALL}};async function $L(n){const t=Kf(FL,n);if(t.connectionProtector===null&&globalThis.process?.env?.LIBP2P_FORCE_PNET!=null)throw new X("Private network is enforced, but no protector was provided");return t}const as={},qs=n=>{n.addEventListener("message",t=>{qs.dispatchEvent("message",n,t)}),n.port!=null&&n.port.addEventListener("message",t=>{qs.dispatchEvent("message",n,t)})};qs.addEventListener=(n,t)=>{as[n]==null&&(as[n]=[]),as[n].push(t)};qs.removeEventListener=(n,t)=>{as[n]!=null&&(as[n]=as[n].filter(e=>e===t))};qs.dispatchEvent=function(n,t,e){as[n]!=null&&as[n].forEach(r=>r(t,e))};const wm="lock:worker:request-read",_m="lock:worker:release-read",Sm="lock:master:grant-read",Em="lock:worker:request-write",Am="lock:worker:release-write",xm="lock:master:grant-write",UL=(n=21)=>Math.random().toString().substring(2),Im=(n,t,e,r,s)=>(i,o)=>{if(o.data.type!==e)return;const a={type:o.data.type,name:o.data.name,identifier:o.data.identifier};n.dispatchEvent(new MessageEvent(t,{data:{name:a.name,handler:async()=>{i.postMessage({type:s,name:a.name,identifier:a.identifier}),await new Promise(l=>{const u=h=>{if(h?.data==null)return;const c={type:h.data.type,name:h.data.name,identifier:h.data.identifier};c.type===r&&c.identifier===a.identifier&&(i.removeEventListener("message",u),l())};i.addEventListener("message",u)})}}}))},km=(n,t,e,r)=>async()=>{const s=UL();return globalThis.postMessage({type:t,identifier:s,name:n}),new Promise(i=>{const o=a=>{if(a?.data==null)return;const l={type:a.data.type,identifier:a.data.identifier};l.type===e&&l.identifier===s&&(globalThis.removeEventListener("message",o),i(()=>{globalThis.postMessage({type:r,identifier:s,name:n})}))};globalThis.addEventListener("message",o)})},VL={singleProcess:!1},HL=n=>{if(n=Object.assign({},VL,n),!!globalThis.document||n.singleProcess){const e=new EventTarget;return qs.addEventListener("message",Im(e,"requestReadLock",wm,_m,Sm)),qs.addEventListener("message",Im(e,"requestWriteLock",Em,Am,xm)),e}return{isWorker:!0,readLock:e=>km(e,wm,Sm,_m),writeLock:e=>km(e,Em,xm,Am)}},ps={};let Xr;async function zu(n,t){let e;const r=new Promise(s=>{e=s});return n.add(async()=>B_((async()=>{await new Promise(s=>{e(()=>{s()})})})(),{milliseconds:t.timeout})),r}const zL=(n,t)=>{if(Xr.isWorker===!0)return{readLock:Xr.readLock(n,t),writeLock:Xr.writeLock(n,t)};const e=new vh({concurrency:1});let r;return{async readLock(){if(r!=null)return zu(r,t);r=new vh({concurrency:t.concurrency,autoStart:!1});const s=r,i=zu(r,t);return e.add(async()=>{s.start(),await s.onIdle().then(()=>{r===s&&(r=null)})}),i},async writeLock(){return r=null,zu(e,t)}}},qL={name:"lock",concurrency:1/0,timeout:846e5,singleProcess:!1};function WL(n){const t=Object.assign({},qL,n);return Xr==null&&(Xr=HL(t),Xr.isWorker!==!0&&(Xr.addEventListener("requestReadLock",e=>{ps[e.data.name]!=null&&ps[e.data.name].readLock().then(async r=>e.data.handler().finally(()=>{r()}))}),Xr.addEventListener("requestWriteLock",async e=>{ps[e.data.name]!=null&&ps[e.data.name].writeLock().then(async r=>e.data.handler().finally(()=>{r()}))}))),ps[t.name]==null&&(ps[t.name]=zL(t.name,t)),ps[t.name]}const GL=36e5,KL=216e5;var Ss;(function(n){(function(e){let r;e.codec=()=>(r==null&&(r=Te((s,i,o={})=>{o.lengthDelimited!==!1&&i.fork(),s.key!=null&&s.key!==""&&(i.uint32(10),i.string(s.key)),s.value!=null&&s.value.byteLength>0&&(i.uint32(18),i.bytes(s.value)),o.lengthDelimited!==!1&&i.ldelim()},(s,i,o={})=>{const a={key:"",value:Ge(0)},l=i==null?s.len:s.pos+i;for(;s.pos<l;){const u=s.uint32();switch(u>>>3){case 1:{a.key=s.string();break}case 2:{a.value=s.bytes();break}default:{s.skipType(u&7);break}}}return a})),r),e.encode=s=>ke(s,e.codec()),e.decode=(s,i)=>Ie(s,e.codec(),i)})(n.Peer$metadataEntry||(n.Peer$metadataEntry={})),function(e){let r;e.codec=()=>(r==null&&(r=Te((s,i,o={})=>{o.lengthDelimited!==!1&&i.fork(),s.key!=null&&s.key!==""&&(i.uint32(10),i.string(s.key)),s.value!=null&&(i.uint32(18),il.codec().encode(s.value,i)),o.lengthDelimited!==!1&&i.ldelim()},(s,i,o={})=>{const a={key:""},l=i==null?s.len:s.pos+i;for(;s.pos<l;){const u=s.uint32();switch(u>>>3){case 1:{a.key=s.string();break}case 2:{a.value=il.codec().decode(s,s.uint32(),{limits:o.limits?.value});break}default:{s.skipType(u&7);break}}}return a})),r),e.encode=s=>ke(s,e.codec()),e.decode=(s,i)=>Ie(s,e.codec(),i)}(n.Peer$tagsEntry||(n.Peer$tagsEntry={}));let t;n.codec=()=>(t==null&&(t=Te((e,r,s={})=>{if(s.lengthDelimited!==!1&&r.fork(),e.addresses!=null)for(const i of e.addresses)r.uint32(10),sl.codec().encode(i,r);if(e.protocols!=null)for(const i of e.protocols)r.uint32(18),r.string(i);if(e.publicKey!=null&&(r.uint32(34),r.bytes(e.publicKey)),e.peerRecordEnvelope!=null&&(r.uint32(42),r.bytes(e.peerRecordEnvelope)),e.metadata!=null&&e.metadata.size!==0)for(const[i,o]of e.metadata.entries())r.uint32(50),n.Peer$metadataEntry.codec().encode({key:i,value:o},r);if(e.tags!=null&&e.tags.size!==0)for(const[i,o]of e.tags.entries())r.uint32(58),n.Peer$tagsEntry.codec().encode({key:i,value:o},r);e.updated!=null&&(r.uint32(64),r.uint64Number(e.updated)),s.lengthDelimited!==!1&&r.ldelim()},(e,r,s={})=>{const i={addresses:[],protocols:[],metadata:new Map,tags:new Map},o=r==null?e.len:e.pos+r;for(;e.pos<o;){const a=e.uint32();switch(a>>>3){case 1:{if(s.limits?.addresses!=null&&i.addresses.length===s.limits.addresses)throw new gt('Decode error - map field "addresses" had too many elements');i.addresses.push(sl.codec().decode(e,e.uint32(),{limits:s.limits?.addresses$}));break}case 2:{if(s.limits?.protocols!=null&&i.protocols.length===s.limits.protocols)throw new gt('Decode error - map field "protocols" had too many elements');i.protocols.push(e.string());break}case 4:{i.publicKey=e.bytes();break}case 5:{i.peerRecordEnvelope=e.bytes();break}case 6:{if(s.limits?.metadata!=null&&i.metadata.size===s.limits.metadata)throw new Kp('Decode error - map field "metadata" had too many elements');const l=n.Peer$metadataEntry.codec().decode(e,e.uint32());i.metadata.set(l.key,l.value);break}case 7:{if(s.limits?.tags!=null&&i.tags.size===s.limits.tags)throw new Kp('Decode error - map field "tags" had too many elements');const l=n.Peer$tagsEntry.codec().decode(e,e.uint32(),{limits:{value:s.limits?.tags$value}});i.tags.set(l.key,l.value);break}case 8:{i.updated=e.uint64Number();break}default:{e.skipType(a&7);break}}}return i})),t),n.encode=e=>ke(e,n.codec()),n.decode=(e,r)=>Ie(e,n.codec(),r)})(Ss||(Ss={}));var sl;(function(n){let t;n.codec=()=>(t==null&&(t=Te((e,r,s={})=>{s.lengthDelimited!==!1&&r.fork(),e.multiaddr!=null&&e.multiaddr.byteLength>0&&(r.uint32(10),r.bytes(e.multiaddr)),e.isCertified!=null&&(r.uint32(16),r.bool(e.isCertified)),e.observed!=null&&(r.uint32(24),r.uint64Number(e.observed)),s.lengthDelimited!==!1&&r.ldelim()},(e,r,s={})=>{const i={multiaddr:Ge(0)},o=r==null?e.len:e.pos+r;for(;e.pos<o;){const a=e.uint32();switch(a>>>3){case 1:{i.multiaddr=e.bytes();break}case 2:{i.isCertified=e.bool();break}case 3:{i.observed=e.uint64Number();break}default:{e.skipType(a&7);break}}}return i})),t),n.encode=e=>ke(e,n.codec()),n.decode=(e,r)=>Ie(e,n.codec(),r)})(sl||(sl={}));var il;(function(n){let t;n.codec=()=>(t==null&&(t=Te((e,r,s={})=>{s.lengthDelimited!==!1&&r.fork(),e.value!=null&&e.value!==0&&(r.uint32(8),r.uint32(e.value)),e.expiry!=null&&(r.uint32(16),r.uint64(e.expiry)),s.lengthDelimited!==!1&&r.ldelim()},(e,r,s={})=>{const i={value:0},o=r==null?e.len:e.pos+r;for(;e.pos<o;){const a=e.uint32();switch(a>>>3){case 1:{i.value=e.uint32();break}case 2:{i.expiry=e.uint64();break}default:{e.skipType(a&7);break}}}return i})),t),n.encode=e=>ke(e,n.codec()),n.decode=(e,r)=>Ie(e,n.codec(),r)})(il||(il={}));function YL(n,t){if(n.publicKey!=null||t.publicKey==null)return n;let e;if(n.type==="RSA"){const s=ot.decode(`z${n}`);e=$r(s)}const r=Lr(t.publicKey,e);return ka(r)}function _h(n,t,e){const r=Ss.decode(t);return Sh(n,r,e)}function Sh(n,t,e){const r=new Map,s=BigInt(Date.now());for(const[i,o]of t.tags.entries())o.expiry!=null&&o.expiry<s||r.set(i,o);return{...t,id:YL(n,t),addresses:t.addresses.filter(({observed:i})=>i!=null&&i>Date.now()-e).map(({multiaddr:i,isCertified:o})=>({multiaddr:me(i),isCertified:o??!1})),metadata:t.metadata,peerRecordEnvelope:t.peerRecordEnvelope??void 0,tags:r}}function QL(n,t){return ZL(n.addresses,t.addresses)&&XL(n.protocols,t.protocols)&&jL(n.publicKey,t.publicKey)&&JL(n.peerRecordEnvelope,t.peerRecordEnvelope)&&eB(n.metadata,t.metadata)&&tB(n.tags,t.tags)}function ZL(n,t){return G_(n,t,(e,r)=>!(e.isCertified!==r.isCertified||!It(e.multiaddr,r.multiaddr)))}function XL(n,t){return G_(n,t,(e,r)=>e===r)}function jL(n,t){return W_(n,t)}function JL(n,t){return W_(n,t)}function eB(n,t){return K_(n,t,(e,r)=>It(e,r))}function tB(n,t){return K_(n,t,(e,r)=>e.value===r.value&&e.expiry===r.expiry)}function W_(n,t){return n==null&&t==null?!0:n!=null&&t!=null?It(n,t):!1}function G_(n,t,e){if(n.length!==t.length)return!1;for(let r=0;r<n.length;r++)if(!e(n[r],t[r]))return!1;return!0}function K_(n,t,e){if(n.size!==t.size)return!1;for(const[r,s]of n.entries()){const i=t.get(r);if(i==null||!e(s,i))return!1}return!0}const Y_="/peers/";function Wa(n){if(!eb(n)||n.type==null)throw new X("Invalid PeerId");const t=n.toCID().toString();return new ut(`${Y_}${t}`)}async function nB(n,t,e,r){const s=new Map;for(const i of e){if(i==null)continue;if(i.multiaddr instanceof Uint8Array&&(i.multiaddr=me(i.multiaddr)),!Vl(i.multiaddr))throw new X("Multiaddr was invalid");if(!await t(n,i.multiaddr))continue;const o=i.isCertified??!1,a=i.multiaddr.toString(),l=s.get(a);l!=null?i.isCertified=l.isCertified||o:s.set(a,{multiaddr:i.multiaddr,isCertified:o})}return[...s.values()].sort((i,o)=>i.multiaddr.toString().localeCompare(o.multiaddr.toString())).map(({isCertified:i,multiaddr:o})=>({isCertified:i,multiaddr:o.bytes}))}async function qu(n,t,e,r){if(t==null)throw new X("Invalid PeerData");if(t.publicKey!=null&&n.publicKey!=null&&!t.publicKey.equals(n.publicKey))throw new X("publicKey bytes do not match peer id publicKey bytes");const s=r.existingPeer?.peer;if(s!=null&&!n.equals(s.id))throw new X("peer id did not match existing peer id");let i=s?.addresses??[],o=new Set(s?.protocols??[]),a=s?.metadata??new Map,l=s?.tags??new Map,u=s?.peerRecordEnvelope;if(e==="patch"){if((t.multiaddrs!=null||t.addresses!=null)&&(i=[],t.multiaddrs!=null&&i.push(...t.multiaddrs.map(d=>({isCertified:!1,multiaddr:d}))),t.addresses!=null&&i.push(...t.addresses)),t.protocols!=null&&(o=new Set(t.protocols)),t.metadata!=null){const d=t.metadata instanceof Map?[...t.metadata.entries()]:Object.entries(t.metadata);a=Ga(d,{validate:Tm})}if(t.tags!=null){const d=t.tags instanceof Map?[...t.tags.entries()]:Object.entries(t.tags);l=Ga(d,{validate:Cm,map:Pm})}t.peerRecordEnvelope!=null&&(u=t.peerRecordEnvelope)}if(e==="merge"){if(t.multiaddrs!=null&&i.push(...t.multiaddrs.map(d=>({isCertified:!1,multiaddr:d}))),t.addresses!=null&&i.push(...t.addresses),t.protocols!=null&&(o=new Set([...o,...t.protocols])),t.metadata!=null){const d=t.metadata instanceof Map?[...t.metadata.entries()]:Object.entries(t.metadata);for(const[f,g]of d)g==null?a.delete(f):a.set(f,g);a=Ga([...a.entries()],{validate:Tm})}if(t.tags!=null){const d=t.tags instanceof Map?[...t.tags.entries()]:Object.entries(t.tags),f=new Map(l);for(const[g,y]of d)y==null?f.delete(g):f.set(g,y);l=Ga([...f.entries()],{validate:Cm,map:Pm})}t.peerRecordEnvelope!=null&&(u=t.peerRecordEnvelope)}let h;s?.id.publicKey!=null?h=nr(s.id.publicKey):t.publicKey!=null?h=nr(t.publicKey):n.publicKey!=null&&(h=nr(n.publicKey));const c={addresses:await nB(n,r.addressFilter??(async()=>!0),i,r.existingPeer?.peerPB.addresses),protocols:[...o.values()].sort((d,f)=>d.localeCompare(f)),metadata:a,tags:l,publicKey:h,peerRecordEnvelope:u};return c.addresses.forEach(d=>{d.observed=r.existingPeer?.peerPB.addresses?.find(f=>It(f.multiaddr,f.multiaddr))?.observed??Date.now()}),n.type!=="RSA"&&delete c.publicKey,c}function Ga(n,t){const e=new Map;for(const[r,s]of n)s!=null&&t.validate(r,s);for(const[r,s]of n.sort(([i],[o])=>i.localeCompare(o)))s!=null&&e.set(r,t.map?.(r,s)??s);return e}function Tm(n,t){if(typeof n!="string")throw new X("Metadata key must be a string");if(!(t instanceof Uint8Array))throw new X("Metadata value must be a Uint8Array")}function Cm(n,t){if(typeof n!="string")throw new X("Tag name must be a string");if(t.value!=null){if(parseInt(`${t.value}`,10)!==t.value)throw new X("Tag value must be an integer");if(t.value<0||t.value>100)throw new X("Tag value must be between 0-100")}if(t.ttl!=null){if(parseInt(`${t.ttl}`,10)!==t.ttl)throw new X("Tag ttl must be an integer");if(t.ttl<0)throw new X("Tag ttl must be between greater than 0")}}function Pm(n,t){let e;return t.expiry!=null&&(e=t.expiry),t.ttl!=null&&(e=BigInt(Date.now()+Number(t.ttl))),{value:t.value??0,expiry:e}}function Q_(n){const t=n.toString().split("/")[2],e=Ye.parse(t,Cr);return $l(e)}function Wu(n,t,e){const r=Q_(n);return _h(r,t,e)}function rB(n,t){return{prefix:Y_,filters:(n.filters??[]).map(e=>({key:r,value:s})=>e(Wu(r,s,t))),orders:(n.orders??[]).map(e=>(r,s)=>e(Wu(r.key,r.value,t),Wu(s.key,s.value,t)))}}var an,oc,ac,cc;class sB{constructor(t,e={}){_e(this,an);p(this,"peerId");p(this,"datastore");p(this,"lock");p(this,"addressFilter");p(this,"log");p(this,"maxAddressAge");p(this,"maxPeerAge");this.log=t.logger.forComponent("libp2p:peer-store"),this.peerId=t.peerId,this.datastore=t.datastore,this.addressFilter=e.addressFilter,this.lock=WL({name:"peer-store",singleProcess:!0}),this.maxAddressAge=e.maxAddressAge??GL,this.maxPeerAge=e.maxPeerAge??KL}async has(t){try{return await this.load(t),!0}catch(e){if(e.name!=="NotFoundError")throw e}return!1}async delete(t){this.peerId.equals(t)||await this.datastore.delete(Wa(t))}async load(t){const e=Wa(t),r=await this.datastore.get(e),s=Ss.decode(r);if(ue(this,an,cc).call(this,s))throw await this.datastore.delete(e),new Sc;return Sh(t,s,this.maxAddressAge)}async save(t,e){const r=await ue(this,an,oc).call(this,t),s=await qu(t,e,"patch",{addressFilter:this.addressFilter});return ue(this,an,ac).call(this,t,s,r)}async patch(t,e){const r=await ue(this,an,oc).call(this,t),s=await qu(t,e,"patch",{addressFilter:this.addressFilter,existingPeer:r});return ue(this,an,ac).call(this,t,s,r)}async merge(t,e){const r=await ue(this,an,oc).call(this,t),s=await qu(t,e,"merge",{addressFilter:this.addressFilter,existingPeer:r});return ue(this,an,ac).call(this,t,s,r)}async*all(t){for await(const{key:e,value:r}of this.datastore.query(rB(t??{},this.maxAddressAge))){const s=Q_(e);if(s.equals(this.peerId))continue;const i=Ss.decode(r);if(ue(this,an,cc).call(this,i)){await this.datastore.delete(e);continue}yield Sh(s,i,this.maxAddressAge)}}}an=new WeakSet,oc=async function(t){try{const e=Wa(t),r=await this.datastore.get(e),s=Ss.decode(r);if(ue(this,an,cc).call(this,s))throw await this.datastore.delete(e),new Sc;return{peerPB:s,peer:_h(t,r,this.maxAddressAge)}}catch(e){e.name!=="NotFoundError"&&this.log.error("invalid peer data found in peer store - %e",e)}},ac=async function(t,e,r){e.updated=Date.now();const s=Ss.encode(e);return await this.datastore.put(Wa(t),s),{peer:_h(t,s,this.maxAddressAge),previous:r?.peer,updated:r==null||!QL(e,r.peerPB)}},cc=function(t){if(t.updated==null)return!0;const e=t.updated<Date.now()-this.maxPeerAge,r=Date.now()-this.maxAddressAge,s=t.addresses.filter(i=>i.observed!=null&&i.observed>r);return e&&s.length===0};var Cy,Bi,lc;Cy=Symbol.toStringTag;class iB{constructor(t,e={}){_e(this,Bi);p(this,"store");p(this,"events");p(this,"peerId");p(this,"log");p(this,Cy,"@libp2p/peer-store");this.log=t.logger.forComponent("libp2p:peer-store"),this.events=t.events,this.peerId=t.peerId,this.store=new sB(t,e)}async forEach(t,e){this.log.trace("forEach await read lock");const r=await this.store.lock.readLock();this.log.trace("forEach got read lock");try{for await(const s of this.store.all(e))t(s)}finally{this.log.trace("forEach release read lock"),r()}}async all(t){this.log.trace("all await read lock");const e=await this.store.lock.readLock();this.log.trace("all got read lock");try{return await ch(this.store.all(t))}finally{this.log.trace("all release read lock"),e()}}async delete(t){this.log.trace("delete await write lock");const e=await this.store.lock.writeLock();this.log.trace("delete got write lock");try{await this.store.delete(t)}finally{this.log.trace("delete release write lock"),e()}}async has(t){this.log.trace("has await read lock");const e=await this.store.lock.readLock();this.log.trace("has got read lock");try{return await this.store.has(t)}finally{this.log.trace("has release read lock"),e()}}async get(t){this.log.trace("get await read lock");const e=await this.store.lock.readLock();this.log.trace("get got read lock");try{return await this.store.load(t)}finally{this.log.trace("get release read lock"),e()}}async save(t,e){this.log.trace("save await write lock");const r=await this.store.lock.writeLock();this.log.trace("save got write lock");try{const s=await this.store.save(t,e);return ue(this,Bi,lc).call(this,t,s),s.peer}finally{this.log.trace("save release write lock"),r()}}async patch(t,e){this.log.trace("patch await write lock");const r=await this.store.lock.writeLock();this.log.trace("patch got write lock");try{const s=await this.store.patch(t,e);return ue(this,Bi,lc).call(this,t,s),s.peer}finally{this.log.trace("patch release write lock"),r()}}async merge(t,e){this.log.trace("merge await write lock");const r=await this.store.lock.writeLock();this.log.trace("merge got write lock");try{const s=await this.store.merge(t,e);return ue(this,Bi,lc).call(this,t,s),s.peer}finally{this.log.trace("merge release write lock"),r()}}async consumePeerRecord(t,e){const r=await Us.openAndCertify(t,Dr.DOMAIN),s=$l(r.publicKey.toCID());if(e?.equals(s)===!1)return this.log("envelope peer id was not the expected peer id - expected: %p received: %p",e,s),!1;const i=Dr.createFromProtobuf(r.payload);let o;try{o=await this.get(s)}catch(a){if(a.name!=="NotFoundError")throw a}if(o?.peerRecordEnvelope!=null){const a=await Us.createFromProtobuf(o.peerRecordEnvelope),l=Dr.createFromProtobuf(a.payload);if(l.seqNumber>=i.seqNumber)return this.log("sequence number was lower or equal to existing sequence number - stored: %d received: %d",l.seqNumber,i.seqNumber),!1}return await this.patch(i.peerId,{peerRecordEnvelope:t,addresses:i.multiaddrs.map(a=>({isCertified:!0,multiaddr:a}))}),!0}}Bi=new WeakSet,lc=function(t,e){e.updated&&(this.peerId.equals(t)?this.events.safeDispatchEvent("self:peer:update",{detail:e}):this.events.safeDispatchEvent("peer:update",{detail:e}))};function oB(n,t={}){return new iB(n,t)}function aB(n,t){let e;const r=function(){const s=function(){e=void 0,n()};clearTimeout(e),e=setTimeout(s,t)};return r.start=()=>{},r.stop=()=>{clearTimeout(e)},r}const Dm=864e13,cB=448,Gu=449,lB=53,uB=54,dB=55,hB=56;class fB{constructor(t,e={}){p(this,"log");p(this,"mappings");this.log=t.logger.forComponent("libp2p:address-manager:dns-mappings"),this.mappings=new Map}has(t){const e=this.findHost(t);for(const r of this.mappings.values())if(r.domain===e)return!0;return!1}add(t,e){e.forEach(r=>{this.log("add DNS mapping %s to %s",r,t);const s=jl(r)===!0;this.mappings.set(r,{domain:t,verified:s,expires:s?Dm-Date.now():0,lastVerified:s?Dm-Date.now():void 0})})}remove(t){const e=this.findHost(t);let r=!1;for(const[s,i]of this.mappings.entries())i.domain===e&&(this.log("removing %s to %s DNS mapping %e",s,i.domain,new Error("where")),this.mappings.delete(s),r=r||i.verified);return r}getAll(t){const e=[];for(let r=0;r<t.length;r++){const i=t[r].multiaddr.stringTuples(),o=i[0][1];if(o!=null)for(const[a,l]of this.mappings.entries()){if(o!==a)continue;this.maybeAddSNITuple(i,l.domain)&&(t.splice(r,1),r--,e.push({multiaddr:me(`/${i.map(h=>[pe(h[0]).name,h[1]].join("/")).join("/")}`),verified:l.verified,type:"dns-mapping",expires:l.expires,lastVerified:l.lastVerified}))}}return e}maybeAddSNITuple(t,e){for(let r=0;r<t.length;r++)if(t[r][0]===cB&&t[r+1]?.[0]!==Gu)return t.splice(r+1,0,[Gu,e]),!0;return!1}confirm(t,e){const r=this.findHost(t);let s=!1;for(const[i,o]of this.mappings.entries())o.domain===r&&(this.log("marking %s to %s DNS mapping as verified",i,o.domain),s=o.verified,o.verified=!0,o.expires=Date.now()+e,o.lastVerified=Date.now());return s}unconfirm(t,e){const r=this.findHost(t);let s=!1;for(const[i,o]of this.mappings.entries())o.domain===r&&(this.log("removing verification of %s to %s DNS mapping",i,o.domain),s=s||o.verified,o.verified=!1,o.expires=Date.now()+e);return s}findHost(t){for(const e of t.stringTuples())if(e[0]===Gu||e[0]===lB||e[0]===uB||e[0]===dB||e[0]===hB)return e[1]}}const Ku=4,Yu=41,Qu=6,pB=273;class gB{constructor(t,e={}){p(this,"log");p(this,"mappings");this.log=t.logger.forComponent("libp2p:address-manager:ip-mappings"),this.mappings=new Map}has(t){const e=t.stringTuples();for(const r of this.mappings.values())for(const s of r)if(s.externalIp===e[0][1])return!0;return!1}add(t,e,r,s=e,i="tcp"){const o=`${t}-${e}-${i}`,a=this.mappings.get(o)??[],l={internalIp:t,internalPort:e,externalIp:r,externalPort:s,externalFamily:zi(r)?4:6,protocol:i,verified:!1,expires:0};a.push(l),this.mappings.set(o,a)}remove(t){const e=t.stringTuples(),r=e[0][1]??"",s=e[1][0]===Qu?"tcp":"udp",i=parseInt(e[1][1]??"0");let o=!1;for(const[a,l]of this.mappings.entries()){for(let u=0;u<l.length;u++){const h=l[u];h.externalIp===r&&h.externalPort===i&&h.protocol===s&&(this.log("removing %s:%s to %s:%s %s IP mapping",h.externalIp,h.externalPort,r,i,s),o=o||h.verified,l.splice(u,1),u--)}l.length===0&&this.mappings.delete(a)}return o}getAll(t){const e=[];for(const{multiaddr:r}of t){const s=r.stringTuples();let i;if((s[0][0]===Ku||s[0][0]===Yu)&&s[1][0]===Qu?i=`${s[0][1]}-${s[1][1]}-tcp`:(s[0][0]===Ku||s[0][0]===Yu)&&s[1][0]===pB&&(i=`${s[0][1]}-${s[1][1]}-udp`),i==null)continue;const o=this.mappings.get(i);if(o!=null)for(const a of o)s[0][0]=a.externalFamily===4?Ku:Yu,s[0][1]=a.externalIp,s[1][1]=`${a.externalPort}`,e.push({multiaddr:me(`/${s.map(l=>[pe(l[0]).name,l[1]].join("/")).join("/")}`),verified:a.verified,type:"ip-mapping",expires:a.expires,lastVerified:a.lastVerified})}return e}confirm(t,e){const s=t.stringTuples()[0][1];let i=!1;for(const o of this.mappings.values())for(const a of o)a.externalIp===s&&(this.log("marking %s to %s IP mapping as verified",a.internalIp,a.externalIp),i=a.verified,a.verified=!0,a.expires=Date.now()+e,a.lastVerified=Date.now());return i}unconfirm(t,e){const r=t.stringTuples(),s=r[0][1]??"",i=r[1][0]===Qu?"tcp":"udp",o=parseInt(r[1][1]??"0");let a=!1;for(const l of this.mappings.values())for(let u=0;u<l.length;u++){const h=l[u];h.externalIp===s&&h.externalPort===o&&h.protocol===i&&(this.log("removing verification of %s:%s to %s:%s %s IP mapping",h.externalIp,h.externalPort,s,o,i),a=a||h.verified,h.verified=!1,h.expires=Date.now()+e)}return a}}const mB=4,yB=41;function vB(n){try{const[[t,e]]=n.stringTuples();if(e==null)return!1;if(t===mB)return e.startsWith("169.254.");if(t===yB)return e.toLowerCase().startsWith("fe80")}catch{}return!1}const bB={maxObservedAddresses:10};class wB{constructor(t,e={}){p(this,"log");p(this,"addresses");p(this,"maxObservedAddresses");this.log=t.logger.forComponent("libp2p:address-manager:observed-addresses"),this.addresses=new Map,this.maxObservedAddresses=e.maxObservedAddresses??bB.maxObservedAddresses}has(t){return this.addresses.has(t.toString())}removePrefixed(t){for(const e of this.addresses.keys())e.toString().startsWith(t)&&this.addresses.delete(e)}add(t){this.addresses.size!==this.maxObservedAddresses&&(aa(t)||vB(t)||(this.log("adding observed address %a",t),this.addresses.set(t.toString(),{verified:!1,expires:0})))}getAll(){return Array.from(this.addresses).map(([t,e])=>({multiaddr:me(t),verified:e.verified,type:"observed",expires:e.expires,lastVerified:e.lastVerified}))}remove(t){const e=this.addresses.get(t.toString())?.verified??!1;return this.log("removing observed address %a",t),this.addresses.delete(t.toString()),e}confirm(t,e){const r=t.toString(),s=this.addresses.get(r)??{verified:!1,expires:Date.now()+e,lastVerified:Date.now()},i=s.verified;return s.verified=!0,s.expires=Date.now()+e,s.lastVerified=Date.now(),this.log("marking observed address %a as verified",r),this.addresses.set(r,s),i}}const _B=4,SB=41,EB=53,AB=54,xB=55,IB=56,kB=[_B,SB,EB,AB,xB,IB];function Mm(n){try{const[[t]]=n.stringTuples();return kB.includes(t)}catch{}return!1}const TB={maxObservedAddresses:10};class CB{constructor(t,e={}){p(this,"log");p(this,"addresses");p(this,"maxObservedAddresses");this.log=t.logger.forComponent("libp2p:address-manager:observed-addresses"),this.addresses=new Map,this.maxObservedAddresses=e.maxObservedAddresses??TB.maxObservedAddresses}get(t,e){if(aa(t))return{multiaddr:t,verified:!0,type:"transport",expires:Date.now()+e,lastVerified:Date.now()};const r=this.toKey(t);let s=this.addresses.get(r);return s==null&&(s={verified:!Mm(t),expires:0},this.addresses.set(r,s)),{multiaddr:t,verified:s.verified,type:"transport",expires:s.expires,lastVerified:s.lastVerified}}has(t){const e=this.toKey(t);return this.addresses.has(e)}remove(t){const e=this.toKey(t),r=this.addresses.get(e)?.verified??!1;return this.log("removing observed address %a",t),this.addresses.delete(e),r}confirm(t,e){const r=this.toKey(t),s=this.addresses.get(r)??{verified:!1,expires:0,lastVerified:0},i=s.verified;return s.verified=!0,s.expires=Date.now()+e,s.lastVerified=Date.now(),this.addresses.set(r,s),i}unconfirm(t,e){const r=this.toKey(t),s=this.addresses.get(r)??{verified:!1,expires:0},i=s.verified;return s.verified=!1,s.expires=Date.now()+e,this.addresses.set(r,s),i}toKey(t){if(Mm(t)){const e=t.toOptions();return`${e.host}-${e.port}-${e.transport}`}return t.toString()}}const Lm=6e4,Bm={addressVerificationTTL:Lm*10,addressVerificationRetry:Lm*5},PB=n=>n;function Zu(n,t){const e=n.getPeerId();return e!=null&&Bt(e).equals(t)&&(n=n.decapsulate(me(`/p2p/${t.toString()}`))),n}var Py;Py=Symbol.toStringTag;class DB{constructor(t,e={}){p(this,"log");p(this,"components");p(this,"listen");p(this,"announce");p(this,"appendAnnounce");p(this,"announceFilter");p(this,"observed");p(this,"dnsMappings");p(this,"ipMappings");p(this,"transportAddresses");p(this,"observedAddressFilter");p(this,"addressVerificationTTL");p(this,"addressVerificationRetry");p(this,Py,"@libp2p/address-manager");const{listen:r=[],announce:s=[],appendAnnounce:i=[]}=e;this.components=t,this.log=t.logger.forComponent("libp2p:address-manager"),this.listen=r.map(o=>o.toString()),this.announce=new Set(s.map(o=>o.toString())),this.appendAnnounce=new Set(i.map(o=>o.toString())),this.observed=new wB(t,e),this.dnsMappings=new fB(t,e),this.ipMappings=new gB(t,e),this.transportAddresses=new CB(t,e),this.announceFilter=e.announceFilter??PB,this.observedAddressFilter=ia(1024),this.addressVerificationTTL=e.addressVerificationTTL??Bm.addressVerificationTTL,this.addressVerificationRetry=e.addressVerificationRetry??Bm.addressVerificationRetry,this._updatePeerStoreAddresses=aB(this._updatePeerStoreAddresses.bind(this),1e3),t.events.addEventListener("transport:listening",()=>{this._updatePeerStoreAddresses()}),t.events.addEventListener("transport:close",()=>{this._updatePeerStoreAddresses()})}_updatePeerStoreAddresses(){const t=this.getAddresses().map(e=>e.getPeerId()===this.components.peerId.toString()?e.decapsulate(`/p2p/${this.components.peerId.toString()}`):e);this.components.peerStore.patch(this.components.peerId,{multiaddrs:t}).catch(e=>{this.log.error("error updating addresses",e)})}getListenAddrs(){return Array.from(this.listen).map(t=>me(t))}getAnnounceAddrs(){return Array.from(this.announce).map(t=>me(t))}getAppendAnnounceAddrs(){return Array.from(this.appendAnnounce).map(t=>me(t))}getObservedAddrs(){return this.observed.getAll().map(t=>t.multiaddr)}addObservedAddr(t){const e=t.stringTuples(),r=`${e[0][1]}:${e[1][1]}`;this.observedAddressFilter.has(r)||(this.observedAddressFilter.add(r),t=Zu(t,this.components.peerId),!this.ipMappings.has(t)&&(this.dnsMappings.has(t)||this.observed.add(t)))}confirmObservedAddr(t,e){t=Zu(t,this.components.peerId);let r=!0;(e?.type==="transport"||this.transportAddresses.has(t))&&!this.transportAddresses.confirm(t,e?.ttl??this.addressVerificationTTL)&&r&&(r=!1),(e?.type==="dns-mapping"||this.dnsMappings.has(t))&&!this.dnsMappings.confirm(t,e?.ttl??this.addressVerificationTTL)&&r&&(r=!1),(e?.type==="ip-mapping"||this.ipMappings.has(t))&&!this.ipMappings.confirm(t,e?.ttl??this.addressVerificationTTL)&&r&&(r=!1),(e?.type==="observed"||this.observed.has(t))&&(this.maybeUpgradeToIPMapping(t)?(this.ipMappings.confirm(t,e?.ttl??this.addressVerificationTTL),r=!1):!this.observed.confirm(t,e?.ttl??this.addressVerificationTTL)&&r&&(r=!1)),r||this._updatePeerStoreAddresses()}removeObservedAddr(t,e){t=Zu(t,this.components.peerId),this.observed.has(t)&&this.observed.remove(t),this.transportAddresses.has(t)&&this.transportAddresses.unconfirm(t,e?.ttl??this.addressVerificationRetry),this.dnsMappings.has(t)&&this.dnsMappings.unconfirm(t,e?.ttl??this.addressVerificationRetry),this.ipMappings.has(t)&&this.ipMappings.unconfirm(t,e?.ttl??this.addressVerificationRetry)}getAddresses(){const t=new Set,e=this.getAddressesWithMetadata().filter(r=>{if(!r.verified)return!1;const s=r.multiaddr.toString();return t.has(s)?!1:(t.add(s),!0)}).map(r=>r.multiaddr);return this.announceFilter(e.map(r=>{const s=me(r);return s.protos().pop()?.path===!0||s.getPeerId()===this.components.peerId.toString()?s:s.encapsulate(`/p2p/${this.components.peerId.toString()}`)}))}getAddressesWithMetadata(){const t=this.getAnnounceAddrs();if(t.length>0)return this.components.transportManager.getListeners().forEach(r=>{r.updateAnnounceAddrs(t)}),t.map(r=>({multiaddr:r,verified:!0,type:"announce",expires:Date.now()+this.addressVerificationTTL,lastVerified:Date.now()}));let e=[];return e=e.concat(this.components.transportManager.getAddrs().map(r=>this.transportAddresses.get(r,this.addressVerificationTTL))),e=e.concat(this.getAppendAnnounceAddrs().map(r=>({multiaddr:r,verified:!0,type:"announce",expires:Date.now()+this.addressVerificationTTL,lastVerified:Date.now()}))),e=e.concat(this.observed.getAll()),e=e.concat(this.ipMappings.getAll(e)),e=e.concat(this.dnsMappings.getAll(e)),e}addDNSMapping(t,e){this.dnsMappings.add(t,e)}removeDNSMapping(t){this.dnsMappings.remove(me(`/dns/${t}`))&&this._updatePeerStoreAddresses()}addPublicAddressMapping(t,e,r,s=e,i="tcp"){this.ipMappings.add(t,e,r,s,i),this.observed.removePrefixed(`/ip${zi(r)?4:6}/${r}/${i}/${s}`)}removePublicAddressMapping(t,e,r,s=e,i="tcp"){this.ipMappings.remove(me(`/ip${zi(r)?4:6}/${r}/${i}/${s}`))&&this._updatePeerStoreAddresses()}maybeUpgradeToIPMapping(t){if(this.ipMappings.has(t))return!1;const e=t.toOptions();if(e.family===6||e.host==="127.0.0.1"||jl(e.host)===!0)return!1;const r=this.components.transportManager.getListeners(),s=[i=>ra.exactMatch(i)||Gc.exactMatch(i),i=>Wc.exactMatch(i),i=>AP.exactMatch(i)];for(const i of s){if(!i(t))continue;const o=r.filter(u=>u.getAddrs().filter(h=>h.toOptions().family===4&&i(h)).length>0);if(o.length!==1)continue;const a=o[0].getAddrs().filter(u=>u.toOptions().host!=="127.0.0.1").pop();if(a==null)continue;const l=a.toOptions();return this.observed.remove(t),this.ipMappings.add(l.host,l.port,e.host,e.port,e.transport),!0}return!1}}var Nm;(function(n){n.NOT_STARTED_YET="The libp2p node is not started yet",n.NOT_FOUND="Not found"})(Nm||(Nm={}));class MB extends Error{constructor(t="Missing service"){super(t),this.name="MissingServiceError"}}class LB extends Error{constructor(t="Unmet service dependencies"){super(t),this.name="UnmetServiceDependenciesError"}}class Xu extends Error{constructor(t="No content routers available"){super(t),this.name="NoContentRoutersError"}}class Rm extends Error{constructor(t="No peer routers available"){super(t),this.name="NoPeerRoutersError"}}class BB extends Error{constructor(t="Should not try to find self"){super(t),this.name="QueriedForSelfError"}}class NB extends Error{constructor(t="Unhandled protocol error"){super(t),this.name="UnhandledProtocolError"}}class RB extends Error{constructor(t="Duplicate protocol handler error"){super(t),this.name="DuplicateProtocolHandlerError"}}class Om extends Error{constructor(t="Dial denied error"){super(t),this.name="DialDeniedError"}}class OB extends Error{constructor(t="No transport was configured to listen on this address"){super(t),this.name="UnsupportedListenAddressError"}}class FB extends Error{constructor(t="Configured listen addresses could not be listened on"){super(t),this.name="UnsupportedListenAddressesError"}}class $B extends Error{constructor(t="No valid addresses"){super(t),this.name="NoValidAddressesError"}}class UB extends Error{constructor(t="Connection intercepted"){super(t),this.name="ConnectionInterceptedError"}}class VB extends Error{constructor(t="Connection denied"){super(t),this.name="ConnectionDeniedError"}}class Ka extends Error{constructor(t="Stream is not multiplexed"){super(t),this.name="MuxerUnavailableError"}}class Ya extends Error{constructor(t="Encryption failed"){super(t),this.name="EncryptionFailedError"}}class HB extends Error{constructor(t="Transport unavailable"){super(t),this.name="TransportUnavailableError"}}class zB{constructor(t={}){p(this,"components",{});p(this,"_started",!1);this.components={};for(const[e,r]of Object.entries(t))this.components[e]=r;this.components.logger==null&&(this.components.logger=tp())}isStarted(){return this._started}async _invokeStartableMethod(t){await Promise.all(Object.values(this.components).filter(e=>sf(e)).map(async e=>{await e[t]?.()}))}async beforeStart(){await this._invokeStartableMethod("beforeStart")}async start(){await this._invokeStartableMethod("start"),this._started=!0}async afterStart(){await this._invokeStartableMethod("afterStart")}async beforeStop(){await this._invokeStartableMethod("beforeStop")}async stop(){await this._invokeStartableMethod("stop"),this._started=!1}async afterStop(){await this._invokeStartableMethod("afterStop")}}const qB=["metrics","connectionProtector","dns"],WB=["components","isStarted","beforeStart","start","afterStart","beforeStop","stop","afterStop","then","_invokeStartableMethod"];function GB(n={}){const t=new zB(n);return new Proxy(t,{get(r,s,i){if(typeof s=="string"&&!WB.includes(s)){const o=t.components[s];if(o==null&&!qB.includes(s))throw new MB(`${s} not set`);return o}return Reflect.get(r,s,i)},set(r,s,i){return typeof s=="string"?t.components[s]=i:Reflect.set(r,s,i),!0}})}function KB(n){const t={};for(const e of Object.values(n.components))for(const r of YB(e))t[r]=!0;for(const e of Object.values(n.components))for(const r of QB(e))if(t[r]!==!0)throw new LB(`Service "${ZB(e)}" required capability "${r}" but it was not provided by any component, you may need to add additional configuration when creating your node.`)}function YB(n){return Array.isArray(n?.[Wn])?n[Wn]:[]}function QB(n){return Array.isArray(n?.[Ac])?n[Ac]:[]}function ZB(n){return n?.[Symbol.toStringTag]??n?.toString()??"unknown"}const XB=4,jB=41;function JB(n={}){return{denyDialPeer:async()=>!1,denyDialMultiaddr:async t=>{if(ra.matches(t))return!1;const e=t.stringTuples();return e[0][0]===XB||e[0][0]===jB?!!jl(`${e[0][1]}`):!1},denyInboundConnection:async()=>!1,denyOutboundConnection:async()=>!1,denyInboundEncryptedConnection:async()=>!1,denyOutboundEncryptedConnection:async()=>!1,denyInboundUpgradedConnection:async()=>!1,denyOutboundUpgradedConnection:async()=>!1,filterMultiaddrForPeer:async()=>!0,...n}}const Fm=()=>{const n=new Error("Delay aborted");return n.name="AbortError",n},eN=new WeakMap;function tN({clearTimeout:n,setTimeout:t}={}){return(e,{value:r,signal:s}={})=>{if(s?.aborted)return Promise.reject(Fm());let i,o,a;const l=n??clearTimeout,u=()=>{l(i),a(Fm())},h=()=>{s&&s.removeEventListener("abort",u)},c=new Promise((d,f)=>{o=()=>{h(),d(r)},a=f,i=(t??setTimeout)(o,e)});return s&&s.addEventListener("abort",u,{once:!0}),eN.set(c,()=>{l(i),i=null,o()}),c}}const nN=tN();class rN{constructor(t={}){p(this,"memoryStorage");p(this,"points");p(this,"duration");p(this,"blockDuration");p(this,"execEvenly");p(this,"execEvenlyMinDelayMs");p(this,"keyPrefix");this.points=t.points??4,this.duration=t.duration??1,this.blockDuration=t.blockDuration??0,this.execEvenly=t.execEvenly??!1,this.execEvenlyMinDelayMs=t.execEvenlyMinDelayMs??this.duration*1e3/this.points,this.keyPrefix=t.keyPrefix??"rlflx",this.memoryStorage=new sN}async consume(t,e=1,r={}){const s=this.getKey(t),i=this._getKeySecDuration(r);let o=this.memoryStorage.incrby(s,e,i);if(o.remainingPoints=Math.max(this.points-o.consumedPoints,0),o.consumedPoints>this.points)throw this.blockDuration>0&&o.consumedPoints<=this.points+e&&(o=this.memoryStorage.set(s,o.consumedPoints,this.blockDuration)),new zP("Rate limit exceeded",o);if(this.execEvenly&&o.msBeforeNext>0&&!o.isFirstInDuration){let a=Math.ceil(o.msBeforeNext/(o.remainingPoints+2));a<this.execEvenlyMinDelayMs&&(a=o.consumedPoints*this.execEvenlyMinDelayMs),await nN(a)}return o}penalty(t,e=1,r={}){const s=this.getKey(t),i=this._getKeySecDuration(r),o=this.memoryStorage.incrby(s,e,i);return o.remainingPoints=Math.max(this.points-o.consumedPoints,0),o}reward(t,e=1,r={}){const s=this.getKey(t),i=this._getKeySecDuration(r),o=this.memoryStorage.incrby(s,-e,i);return o.remainingPoints=Math.max(this.points-o.consumedPoints,0),o}block(t,e){const r=e*1e3,s=this.points+1;return this.memoryStorage.set(this.getKey(t),s,e),{remainingPoints:0,msBeforeNext:r===0?-1:r,consumedPoints:s,isFirstInDuration:!1}}set(t,e,r=0){const s=(r>=0?r:this.duration)*1e3;return this.memoryStorage.set(this.getKey(t),e,r),{remainingPoints:0,msBeforeNext:s===0?-1:s,consumedPoints:e,isFirstInDuration:!1}}get(t){const e=this.memoryStorage.get(this.getKey(t));return e!=null&&(e.remainingPoints=Math.max(this.points-e.consumedPoints,0)),e}delete(t){this.memoryStorage.delete(this.getKey(t))}_getKeySecDuration(t){return t?.customDuration!=null&&t.customDuration>=0?t.customDuration:this.duration}getKey(t){return this.keyPrefix.length>0?`${this.keyPrefix}:${t}`:t}parseKey(t){return t.substring(this.keyPrefix.length)}}class sN{constructor(){p(this,"storage");this.storage=new Map}incrby(t,e,r){const s=this.storage.get(t);if(s!=null){const i=s.expiresAt!=null?s.expiresAt.getTime()-new Date().getTime():-1;return s.expiresAt==null||i>0?(s.value+=e,{remainingPoints:0,msBeforeNext:i,consumedPoints:s.value,isFirstInDuration:!1}):this.set(t,e,r)}return this.set(t,e,r)}set(t,e,r){const s=r*1e3,i=this.storage.get(t);i!=null&&clearTimeout(i.timeoutId);const o={value:e,expiresAt:s>0?new Date(Date.now()+s):void 0};return this.storage.set(t,o),s>0&&(o.timeoutId=setTimeout(()=>{this.storage.delete(t)},s),o.timeoutId.unref!=null&&o.timeoutId.unref()),{remainingPoints:0,msBeforeNext:s===0?-1:s,consumedPoints:o.value,isFirstInDuration:!0}}get(t){const e=this.storage.get(t);if(e!=null)return{remainingPoints:0,msBeforeNext:e.expiresAt!=null?e.expiresAt.getTime()-new Date().getTime():-1,consumedPoints:e.value,isFirstInDuration:!1}}delete(t){const e=this.storage.get(t);return e!=null?(e.timeoutId!=null&&clearTimeout(e.timeoutId),this.storage.delete(t),!0):!1}}function Z_(n){if(eb(n))return{peerId:n,multiaddrs:[]};Array.isArray(n)||(n=[n]);let t;if(n.length>0){const e=n[0].getPeerId();t=e==null?void 0:Bt(e),n.forEach(r=>{if(!Vl(r))throw new xl("Invalid multiaddr");const s=r.getPeerId();if(s==null){if(t!=null)throw new X("Multiaddrs must all have the same peer id or have no peer id")}else{const i=Bt(s);if(t?.equals(i)!==!0)throw new X("Multiaddrs must all have the same peer id or have no peer id")}})}return{peerId:t,multiaddrs:n}}const iN=["/ipfs/id/1.0.0","/ipfs/id/push/1.0.0","/libp2p/autonat/1.0.0","/libp2p/dcutr"];async function oN(n,t){const e=n?.streams?.map(s=>s.protocol)??[],r=t?.closableProtocols??iN;if(!(e.filter(s=>s!=null&&!r.includes(s)).length>0))try{await n?.close(t)}catch(s){n?.abort(s)}}const X_=1e4,aN=1e4,$m=1e4,j_=25,cN=5,lN=10,uN=5,dN="last-dial-failure",hN="last-dial-success",J_=500,e1=100,t1=50;async function fN(n,t){let e=!1;for(const s of $f.keys())if(e=n.protoNames().includes(s),e)break;if(!e)return[n];const r=await n.resolve(t);return t.log("resolved %s to",n,r.map(s=>s.toString())),r}function Eh(n){try{let t;if(typeof n=="string"?t=me(n):t=n,!t.protoNames().includes("ipcidr")){const r=t.protoNames().includes("ip6")?"/ipcidr/128":"/ipcidr/32";t=t.encapsulate(r)}return hC(t)}catch{throw new Error(`Can't convert to IpNet, Invalid multiaddr format: ${n}`)}}const pN={maxConnections:e1};class gN{constructor(t,e={}){p(this,"maxConnections");p(this,"connectionManager");p(this,"peerStore");p(this,"allow");p(this,"events");p(this,"log");this.maxConnections=e.maxConnections??pN.maxConnections,this.allow=(e.allow??[]).map(r=>Eh(r)),this.connectionManager=t.connectionManager,this.peerStore=t.peerStore,this.events=t.events,this.log=t.logger.forComponent("libp2p:connection-manager:connection-pruner"),this.maybePruneConnections=this.maybePruneConnections.bind(this)}start(){this.events.addEventListener("connection:open",this.maybePruneConnections)}stop(){this.events.removeEventListener("connection:open",this.maybePruneConnections)}maybePruneConnections(){this._maybePruneConnections().catch(t=>{this.log.error("error while pruning connections %e",t)})}async _maybePruneConnections(){const t=this.connectionManager.getConnections(),e=t.length;if(this.log("checking max connections limit %d/%d",e,this.maxConnections),e<=this.maxConnections)return;const r=new Zl;for(const a of t){const l=a.remotePeer;if(!r.has(l)){r.set(l,0);try{const u=await this.peerStore.get(l);r.set(l,[...u.tags.values()].reduce((h,c)=>h+c.value,0))}catch(u){u.name!=="NotFoundError"&&this.log.error("error loading peer tags",u)}}}const s=this.sortConnections(t,r),i=Math.max(e-this.maxConnections,0),o=[];for(const a of s)if(this.log("too many connections open - closing a connection to %p",a.remotePeer),this.allow.some(u=>u.contains(a.remoteAddr.nodeAddress().address))||o.push(a),o.length===i)break;await Promise.all(o.map(async a=>{await oN(a,{signal:AbortSignal.timeout(1e3)})})),this.events.safeDispatchEvent("connection:prune",{detail:o})}sortConnections(t,e){return t.sort((r,s)=>{const i=r.timeline.open,o=s.timeline.open;return i<o?1:i>o?-1:0}).sort((r,s)=>r.direction==="outbound"&&s.direction==="inbound"?1:r.direction==="inbound"&&s.direction==="outbound"?-1:0).sort((r,s)=>r.streams.length>s.streams.length?1:r.streams.length<s.streams.length?-1:0).sort((r,s)=>{const i=e.get(r.remotePeer)??0,o=e.get(s.remotePeer)??0;return i>o?1:i<o?-1:0})}}class mN extends Jw{constructor(t={}){super({...t,sort:(e,r)=>e.options.priority>r.options.priority?-1:e.options.priority<r.options.priority?1:0})}}function yN(n){return/^127\.([0-9]{1,3})\.([0-9]{1,3})\.([0-9]{1,3})$/i.test(n)||/^::1$/.test(n)}function Um(n){if(!k_(n))return!1;const{address:t}=n.nodeAddress();return yN(t)}function vN(n,t){const e=Wc.exactMatch(n.multiaddr),r=Wc.exactMatch(t.multiaddr);if(e&&!r)return-1;if(!e&&r)return 1;const s=Gc.exactMatch(n.multiaddr),i=Gc.exactMatch(t.multiaddr);if(s&&!i)return-1;if(!s&&i)return 1;const o=ra.exactMatch(n.multiaddr),a=ra.exactMatch(t.multiaddr);if(o&&!a)return-1;if(!o&&a)return 1;const l=Bg.exactMatch(n.multiaddr),u=Bg.exactMatch(t.multiaddr);if(l&&!u)return-1;if(!l&&u)return 1;const h=Mg.exactMatch(n.multiaddr),c=Mg.exactMatch(t.multiaddr);if(h&&!c)return-1;if(!h&&c)return 1;const d=Lg.exactMatch(n.multiaddr),f=Lg.exactMatch(t.multiaddr);return d&&!f?-1:!d&&f?1:0}function bN(n,t){const e=Um(n.multiaddr),r=Um(t.multiaddr);return e&&!r?1:!e&&r?-1:0}function wN(n,t){const e=aa(n.multiaddr),r=aa(t.multiaddr);return e&&!r?1:!e&&r?-1:0}function _N(n,t){return n.isCertified&&!t.isCertified?-1:!n.isCertified&&t.isCertified?1:0}function SN(n,t){const e=sa.exactMatch(n.multiaddr),r=sa.exactMatch(t.multiaddr);return e&&!r?1:!e&&r?-1:0}function EN(n){return n.sort(vN).sort(_N).sort(SN).sort(wN).sort(bN)}const Qa={maxParallelDials:t1,maxDialQueueLength:J_,maxPeerAddrsToDial:j_,dialTimeout:X_};class AN{constructor(t,e={}){p(this,"queue");p(this,"components");p(this,"addressSorter");p(this,"maxPeerAddrsToDial");p(this,"maxDialQueueLength");p(this,"dialTimeout");p(this,"shutDownController");p(this,"connections");p(this,"log");this.addressSorter=e.addressSorter,this.maxPeerAddrsToDial=e.maxPeerAddrsToDial??Qa.maxPeerAddrsToDial,this.maxDialQueueLength=e.maxDialQueueLength??Qa.maxDialQueueLength,this.dialTimeout=e.dialTimeout??Qa.dialTimeout,this.connections=e.connections??new Zl,this.log=t.logger.forComponent("libp2p:connection-manager:dial-queue"),this.components=t,this.shutDownController=new AbortController,this.shutDownController.signal;for(const[r,s]of Object.entries(e.resolvers??{}))$f.set(r,s);this.queue=new mN({concurrency:e.maxParallelDials??Qa.maxParallelDials,metricName:"libp2p_dial_queue",metrics:t.metrics}),this.queue.addEventListener("error",r=>{r.detail.name!==Ls.name&&this.log.error("error in dial queue - %e",r.detail)})}start(){this.shutDownController=new AbortController,this.shutDownController.signal}stop(){this.shutDownController.abort(),this.queue.abort()}async dial(t,e={}){const{peerId:r,multiaddrs:s}=Z_(t),i=Array.from(this.connections.values()).flat().find(a=>e.force===!0?!1:a.remotePeer.equals(r)?!0:s.find(l=>l.equals(a.remoteAddr)));if(i?.status==="open")return this.log("already connected to %a",i.remoteAddr),e.onProgress?.(new vt("dial-queue:already-connected")),i;const o=this.queue.queue.find(a=>{if(r?.equals(a.options.peerId)===!0)return!0;const l=a.options.multiaddrs;if(l==null)return!1;for(const u of s)if(l.has(u.toString()))return!0;return!1});if(o!=null){this.log("joining existing dial target for %p",r);for(const a of s)o.options.multiaddrs.add(a.toString());return e.onProgress?.(new vt("dial-queue:already-in-dial-queue")),o.join(e)}if(this.queue.size>=this.maxDialQueueLength)throw new Ei("Dial queue is full");return this.log("creating dial target for %p",r,s.map(a=>a.toString())),e.onProgress?.(new vt("dial-queue:add-to-dial-queue")),this.queue.add(async a=>{a.onProgress?.(new vt("dial-queue:start-dial"));const l=Qi([this.shutDownController.signal,a.signal]);try{return await this.dialPeer(a,l)}finally{l.clear()}},{peerId:r,priority:e.priority??n1,multiaddrs:new Set(s.map(a=>a.toString())),signal:e.signal??AbortSignal.timeout(this.dialTimeout),onProgress:e.onProgress})}async dialPeer(t,e){const r=t.peerId,s=t.multiaddrs,i=new Set;let o=t.multiaddrs.size===0,a=0,l=0;const u=[];for(this.log("starting dial to %p",r);o||s.size>0;){l++,o=!1;const h=[],c=new Set(t.multiaddrs);s.clear(),this.log("calculating addrs to dial %p from %s",r,[...c]);const d=await this.calculateMultiaddrs(r,c,{...t,signal:e});for(const f of d){if(i.has(f.multiaddr.toString())){this.log.trace("skipping previously failed multiaddr %a while dialing %p",f.multiaddr,r);continue}h.push(f)}this.log("%s dial to %p with %s",l===1?"starting":"continuing",r,h.map(f=>f.multiaddr.toString())),t?.onProgress?.(new vt("dial-queue:calculated-addresses",h));for(const f of h){if(a===this.maxPeerAddrsToDial)throw this.log("dialed maxPeerAddrsToDial (%d) addresses for %p, not trying any others",a,t.peerId),new Ei("Peer had more than maxPeerAddrsToDial");a++;try{const g=await this.components.transportManager.dial(f.multiaddr,{...t,signal:e});this.log("dial to %a succeeded",f.multiaddr);try{await this.components.peerStore.merge(g.remotePeer,{multiaddrs:[g.remoteAddr],metadata:{[hN]:te(Date.now().toString())}})}catch(y){this.log.error("could not update last dial failure key for %p",r,y)}return g}catch(g){if(this.log.error("dial failed to %a",f.multiaddr,g),i.add(f.multiaddr.toString()),r!=null)try{await this.components.peerStore.merge(r,{metadata:{[dN]:te(Date.now().toString())}})}catch(y){this.log.error("could not update last dial failure key for %p",r,y)}if(e.aborted)throw new mA(g.message);u.push(g)}}}throw u.length===1?u[0]:new AggregateError(u,"All multiaddr dials failed")}async calculateMultiaddrs(t,e=new Set,r={}){const s=[...e].map(c=>({multiaddr:me(c),isCertified:!1}));if(t!=null){if(this.components.peerId.equals(t))throw new Ei("Tried to dial self");if(await this.components.connectionGater.denyDialPeer?.(t)===!0)throw new Om("The dial request is blocked by gater.allowDialPeer");if(s.length===0){this.log("loading multiaddrs for %p",t);try{const c=await this.components.peerStore.get(t);s.push(...c.addresses),this.log("loaded multiaddrs for %p",t,s.map(({multiaddr:d})=>d.toString()))}catch(c){if(c.name!=="NotFoundError")throw c}}if(s.length===0){this.log("looking up multiaddrs for %p in the peer routing",t);try{const c=await this.components.peerRouting.findPeer(t,r);this.log("found multiaddrs for %p in the peer routing",t,s.map(({multiaddr:d})=>d.toString())),s.push(...c.multiaddrs.map(d=>({multiaddr:d,isCertified:!1})))}catch(c){c.name==="NoPeerRoutersError"?this.log("no peer routers configured",t):this.log.error("looking up multiaddrs for %p in the peer routing failed - %e",t,c)}}}let i=(await Promise.all(s.map(async c=>{const d=await fN(c.multiaddr,{dns:this.components.dns,...r,log:this.log});return d.length===1&&d[0].equals(c.multiaddr)?c:d.map(f=>({multiaddr:f,isCertified:!1}))}))).flat();if(t!=null){const c=`/p2p/${t.toString()}`;i=i.map(d=>d.multiaddr.protos().pop()?.path===!0?d:d.multiaddr.getPeerId()==null?{multiaddr:d.multiaddr.encapsulate(c),isCertified:d.isCertified}:d)}const o=i.filter(c=>{if(this.components.transportManager.dialTransportForMultiaddr(c.multiaddr)==null)return!1;const d=c.multiaddr.getPeerId();return t!=null&&d!=null?t.equals(d):!0}),a=new Map;for(const c of o){const d=c.multiaddr.toString(),f=a.get(d);if(f!=null){f.isCertified=f.isCertified||c.isCertified||!1;continue}a.set(d,c)}const l=[...a.values()];if(l.length===0)throw new $B("The dial request has no valid addresses");const u=[];for(const c of l)this.components.connectionGater.denyDialMultiaddr!=null&&await this.components.connectionGater.denyDialMultiaddr(c.multiaddr)||u.push(c);const h=this.addressSorter==null?EN(u):u.sort(this.addressSorter);if(h.length===0)throw new Om("The connection gater denied all addresses in the dial request");return this.log.trace("addresses for %p before filtering",t??"unknown peer",i.map(({multiaddr:c})=>c.toString())),this.log.trace("addresses for %p after filtering",t??"unknown peer",h.map(({multiaddr:c})=>c.toString())),h}async isDialable(t,e={}){Array.isArray(t)||(t=[t]);try{const r=await this.calculateMultiaddrs(void 0,new Set(t.map(s=>s.toString())),e);return e.runOnLimitedConnection===!1?r.find(s=>!sa.matches(s.multiaddr))!=null:!0}catch(r){this.log.trace("error calculating if multiaddr(s) were dialable",r)}return!1}}var ju={},Ju,Vm;function xN(){if(Vm)return Ju;Vm=1;function n(t,e){typeof e=="boolean"&&(e={forever:e}),this._originalTimeouts=JSON.parse(JSON.stringify(t)),this._timeouts=t,this._options=e||{},this._maxRetryTime=e&&e.maxRetryTime||1/0,this._fn=null,this._errors=[],this._attempts=1,this._operationTimeout=null,this._operationTimeoutCb=null,this._timeout=null,this._operationStart=null,this._timer=null,this._options.forever&&(this._cachedTimeouts=this._timeouts.slice(0))}return Ju=n,n.prototype.reset=function(){this._attempts=1,this._timeouts=this._originalTimeouts.slice(0)},n.prototype.stop=function(){this._timeout&&clearTimeout(this._timeout),this._timer&&clearTimeout(this._timer),this._timeouts=[],this._cachedTimeouts=null},n.prototype.retry=function(t){if(this._timeout&&clearTimeout(this._timeout),!t)return!1;var e=new Date().getTime();if(t&&e-this._operationStart>=this._maxRetryTime)return this._errors.push(t),this._errors.unshift(new Error("RetryOperation timeout occurred")),!1;this._errors.push(t);var r=this._timeouts.shift();if(r===void 0)if(this._cachedTimeouts)this._errors.splice(0,this._errors.length-1),r=this._cachedTimeouts.slice(-1);else return!1;var s=this;return this._timer=setTimeout(function(){s._attempts++,s._operationTimeoutCb&&(s._timeout=setTimeout(function(){s._operationTimeoutCb(s._attempts)},s._operationTimeout),s._options.unref&&s._timeout.unref()),s._fn(s._attempts)},r),this._options.unref&&this._timer.unref(),!0},n.prototype.attempt=function(t,e){this._fn=t,e&&(e.timeout&&(this._operationTimeout=e.timeout),e.cb&&(this._operationTimeoutCb=e.cb));var r=this;this._operationTimeoutCb&&(this._timeout=setTimeout(function(){r._operationTimeoutCb()},r._operationTimeout)),this._operationStart=new Date().getTime(),this._fn(this._attempts)},n.prototype.try=function(t){console.log("Using RetryOperation.try() is deprecated"),this.attempt(t)},n.prototype.start=function(t){console.log("Using RetryOperation.start() is deprecated"),this.attempt(t)},n.prototype.start=n.prototype.try,n.prototype.errors=function(){return this._errors},n.prototype.attempts=function(){return this._attempts},n.prototype.mainError=function(){if(this._errors.length===0)return null;for(var t={},e=null,r=0,s=0;s<this._errors.length;s++){var i=this._errors[s],o=i.message,a=(t[o]||0)+1;t[o]=a,a>=r&&(e=i,r=a)}return e},Ju}var Hm;function IN(){return Hm||(Hm=1,function(n){var t=xN();n.operation=function(e){var r=n.timeouts(e);return new t(r,{forever:e&&(e.forever||e.retries===1/0),unref:e&&e.unref,maxRetryTime:e&&e.maxRetryTime})},n.timeouts=function(e){if(e instanceof Array)return[].concat(e);var r={retries:10,factor:2,minTimeout:1*1e3,maxTimeout:1/0,randomize:!1};for(var s in e)r[s]=e[s];if(r.minTimeout>r.maxTimeout)throw new Error("minTimeout is greater than maxTimeout");for(var i=[],o=0;o<r.retries;o++)i.push(this.createTimeout(o,r));return e&&e.forever&&!i.length&&i.push(this.createTimeout(o,r)),i.sort(function(a,l){return a-l}),i},n.createTimeout=function(e,r){var s=r.randomize?Math.random()+1:1,i=Math.round(s*Math.max(r.minTimeout,1)*Math.pow(r.factor,e));return i=Math.min(i,r.maxTimeout),i},n.wrap=function(e,r,s){if(r instanceof Array&&(s=r,r=null),!s){s=[];for(var i in e)typeof e[i]=="function"&&s.push(i)}for(var o=0;o<s.length;o++){var a=s[o],l=e[a];e[a]=function(h){var c=n.operation(r),d=Array.prototype.slice.call(arguments,1),f=d.pop();d.push(function(g){c.retry(g)||(g&&(arguments[0]=c.mainError()),f.apply(this,arguments))}),c.attempt(function(){h.apply(e,d)})}.bind(e,l),e[a].options=r}}}(ju)),ju}var ed,zm;function kN(){return zm||(zm=1,ed=IN()),ed}var TN=kN();const CN=co(TN),PN=Object.prototype.toString,DN=n=>PN.call(n)==="[object Error]",MN=new Set(["network error","Failed to fetch","NetworkError when attempting to fetch resource.","The Internet connection appears to be offline.","Load failed","Network request failed","fetch failed","terminated"]);function LN(n){return n&&DN(n)&&n.name==="TypeError"&&typeof n.message=="string"?n.message==="Load failed"?n.stack===void 0:MN.has(n.message):!1}class BN extends Error{constructor(t){super(),t instanceof Error?(this.originalError=t,{message:t}=t):(this.originalError=new Error(t),this.originalError.stack=this.stack),this.name="AbortError",this.message=t}}const qm=(n,t,e)=>{const r=e.retries-(t-1);return n.attemptNumber=t,n.retriesLeft=r,n};async function NN(n,t){return new Promise((e,r)=>{t={...t},t.onFailedAttempt??(t.onFailedAttempt=()=>{}),t.shouldRetry??(t.shouldRetry=()=>!0),t.retries??(t.retries=10);const s=CN.operation(t),i=()=>{s.stop(),r(t.signal?.reason)};t.signal&&!t.signal.aborted&&t.signal.addEventListener("abort",i,{once:!0});const o=()=>{t.signal?.removeEventListener("abort",i),s.stop()};s.attempt(async a=>{try{const l=await n(a);o(),e(l)}catch(l){try{if(!(l instanceof Error))throw new TypeError(`Non-error was thrown: "${l}". You should only throw errors.`);if(l instanceof BN)throw l.originalError;if(l instanceof TypeError&&!LN(l))throw l;if(qm(l,a,t),await t.shouldRetry(l)||(s.stop(),r(l)),await t.onFailedAttempt(l),!s.retry(l))throw s.mainError()}catch(u){qm(u,a,t),o(),r(u)}}})})}class RN{constructor(t,e={}){p(this,"log");p(this,"queue");p(this,"started");p(this,"peerStore");p(this,"retries");p(this,"retryInterval");p(this,"backoffFactor");p(this,"connectionManager");p(this,"events");this.log=t.logger.forComponent("libp2p:reconnect-queue"),this.peerStore=t.peerStore,this.connectionManager=t.connectionManager,this.queue=new Gf({concurrency:e.maxParallelReconnects??uN,metricName:"libp2p_reconnect_queue",metrics:t.metrics}),this.started=!1,this.retries=e.retries??5,this.backoffFactor=e.backoffFactor,this.retryInterval=e.retryInterval,this.events=t.events,t.events.addEventListener("peer:disconnect",r=>{this.maybeReconnect(r.detail).catch(s=>{this.log.error("failed to maybe reconnect to %p - %e",r.detail,s)})})}async maybeReconnect(t){if(!this.started)return;const e=await this.peerStore.get(t);Wm(e)&&(this.queue.has(t)||this.queue.add(async r=>{await NN(async s=>{if(this.started)try{await this.connectionManager.openConnection(t,{signal:r?.signal})}catch(i){throw this.log("reconnecting to %p attempt %d of %d failed - %e",t,s,this.retries,i),i}},{signal:r?.signal,retries:this.retries,factor:this.backoffFactor,minTimeout:this.retryInterval})},{peerId:t}).catch(async r=>{this.log.error("failed to reconnect to %p - %e",t,r);const s={};[...e.tags.keys()].forEach(i=>{i.startsWith(Zh)&&(s[i]=void 0)}),await this.peerStore.merge(t,{tags:s}),this.events.safeDispatchEvent("peer:reconnect-failure",{detail:t})}).catch(async r=>{this.log.error("failed to remove keep-alive tag from %p - %e",t,r)}))}start(){this.started=!0}async afterStart(){Promise.resolve().then(async()=>{const t=await this.peerStore.all({filters:[e=>Wm(e)]});await Promise.all(t.map(async e=>{await this.connectionManager.openConnection(e.id).catch(r=>{this.log.error(r)})}))}).catch(t=>{this.log.error(t)})}stop(){this.started=!1,this.queue.abort()}}function Wm(n){for(const t of n.tags.keys())if(t.startsWith(Zh))return!0;return!1}const n1=50,td={maxConnections:e1,inboundConnectionThreshold:cN,maxIncomingPendingConnections:lN};var Dy;Dy=Symbol.toStringTag;class ON{constructor(t,e={}){p(this,"started");p(this,"connections");p(this,"allow");p(this,"deny");p(this,"maxIncomingPendingConnections");p(this,"incomingPendingConnections");p(this,"outboundPendingConnections");p(this,"maxConnections");p(this,"dialQueue");p(this,"reconnectQueue");p(this,"connectionPruner");p(this,"inboundConnectionRateLimiter");p(this,"peerStore");p(this,"metrics");p(this,"events");p(this,"log");p(this,"peerId");p(this,Dy,"@libp2p/connection-manager");if(this.maxConnections=e.maxConnections??td.maxConnections,this.maxConnections<1)throw new X("Connection Manager maxConnections must be greater than 0");this.connections=new Zl,this.started=!1,this.peerId=t.peerId,this.peerStore=t.peerStore,this.metrics=t.metrics,this.events=t.events,this.log=t.logger.forComponent("libp2p:connection-manager"),this.onConnect=this.onConnect.bind(this),this.onDisconnect=this.onDisconnect.bind(this),this.allow=(e.allow??[]).map(r=>Eh(r)),this.deny=(e.deny??[]).map(r=>Eh(r)),this.incomingPendingConnections=0,this.maxIncomingPendingConnections=e.maxIncomingPendingConnections??td.maxIncomingPendingConnections,this.outboundPendingConnections=0,this.inboundConnectionRateLimiter=new rN({points:e.inboundConnectionThreshold??td.inboundConnectionThreshold,duration:1}),this.connectionPruner=new gN({connectionManager:this,peerStore:t.peerStore,events:t.events,logger:t.logger},{maxConnections:this.maxConnections,allow:e.allow?.map(r=>me(r))}),this.dialQueue=new AN(t,{addressSorter:e.addressSorter,maxParallelDials:e.maxParallelDials??t1,maxDialQueueLength:e.maxDialQueueLength??J_,maxPeerAddrsToDial:e.maxPeerAddrsToDial??j_,dialTimeout:e.dialTimeout??X_,resolvers:e.resolvers??{dnsaddr:q_},connections:this.connections}),this.reconnectQueue=new RN({events:t.events,peerStore:t.peerStore,logger:t.logger,connectionManager:this},{retries:e.reconnectRetries,retryInterval:e.reconnectRetryInterval,backoffFactor:e.reconnectBackoffFactor,maxParallelReconnects:e.maxParallelReconnects})}async start(){this.metrics?.registerMetricGroup("libp2p_connection_manager_connections",{calculate:()=>{const t={inbound:0,"inbound pending":this.incomingPendingConnections,outbound:0,"outbound pending":this.outboundPendingConnections};for(const e of this.connections.values())for(const r of e)t[r.direction]++;return t}}),this.metrics?.registerMetricGroup("libp2p_protocol_streams_total",{label:"protocol",calculate:()=>{const t={};for(const e of this.connections.values())for(const r of e)for(const s of r.streams){const i=`${s.direction} ${s.protocol??"unnegotiated"}`;t[i]=(t[i]??0)+1}return t}}),this.metrics?.registerMetricGroup("libp2p_connection_manager_protocol_streams_per_connection_90th_percentile",{label:"protocol",calculate:()=>{const t={};for(const r of this.connections.values())for(const s of r){const i={};for(const o of s.streams){const a=`${o.direction} ${o.protocol??"unnegotiated"}`;i[a]=(i[a]??0)+1}for(const[o,a]of Object.entries(i))t[o]=t[o]??[],t[o].push(a)}const e={};for(let[r,s]of Object.entries(t)){s=s.sort((o,a)=>o-a);const i=Math.floor(s.length*.9);e[r]=s[i]}return e}}),this.events.addEventListener("connection:open",this.onConnect),this.events.addEventListener("connection:close",this.onDisconnect),await ub(this.dialQueue,this.reconnectQueue,this.connectionPruner),this.started=!0,this.log("started")}async stop(){this.events.removeEventListener("connection:open",this.onConnect),this.events.removeEventListener("connection:close",this.onDisconnect),await db(this.reconnectQueue,this.dialQueue,this.connectionPruner);const t=[];for(const e of this.connections.values())for(const r of e)t.push((async()=>{try{await r.close()}catch(s){this.log.error(s)}})());this.log("closing %d connections",t.length),await Promise.all(t),this.connections.clear(),this.log("stopped")}getMaxConnections(){return this.maxConnections}onConnect(t){this._onConnect(t).catch(e=>{this.log.error(e)})}async _onConnect(t){const{detail:e}=t;if(!this.started){await e.close();return}if(e.status!=="open")return;const r=e.remotePeer,s=!this.connections.has(r),i=this.connections.get(r)??[];i.push(e),this.connections.set(r,i),r.publicKey!=null&&r.type==="RSA"&&await this.peerStore.patch(r,{publicKey:r.publicKey}),s&&this.events.safeDispatchEvent("peer:connect",{detail:e.remotePeer})}onDisconnect(t){const{detail:e}=t,r=e.remotePeer,i=(this.connections.get(r)??[]).filter(o=>o.id!==e.id);this.connections.set(r,i),i.length===0&&(this.log("onDisconnect remove all connections for peer %p",r),this.connections.delete(r),this.events.safeDispatchEvent("peer:disconnect",{detail:e.remotePeer}))}getConnections(t){if(t!=null)return this.connections.get(t)??[];let e=[];for(const r of this.connections.values())e=e.concat(r);return e}getConnectionsMap(){return this.connections}async openConnection(t,e={}){if(!this.started)throw new Qo("Not started");this.outboundPendingConnections++;try{e.signal?.throwIfAborted();const{peerId:r}=Z_(t);if(this.peerId.equals(r))throw new tf("Can not dial self");if(r!=null&&e.force!==!0){this.log("dial %p",r);const a=this.getConnections(r).find(l=>l.limits==null);if(a!=null)return this.log("had an existing non-limited connection to %p",r),e.onProgress?.(new vt("dial-queue:already-connected")),a}const s=await this.dialQueue.dial(t,{...e,priority:e.priority??n1});if(s.status!=="open")throw new ef("Remote closed connection during opening");let i=this.connections.get(s.remotePeer);i==null&&(i=[],this.connections.set(s.remotePeer,i));let o=!1;for(const a of i)if(a.id===s.id&&(o=!0),e.force!==!0&&a.id!==s.id&&a.remoteAddr.equals(s.remoteAddr))return s.abort(new xl("Duplicate multiaddr connection")),a;return o||i.push(s),s}finally{this.outboundPendingConnections--}}async closeConnections(t,e={}){const r=this.connections.get(t)??[];await Promise.all(r.map(async s=>{try{await s.close(e)}catch(i){s.abort(i)}}))}async acceptIncomingConnection(t){if(this.deny.some(s=>s.contains(t.remoteAddr.nodeAddress().address)))return this.log("connection from %a refused - connection remote address was in deny list",t.remoteAddr),!1;if(this.allow.some(s=>s.contains(t.remoteAddr.nodeAddress().address)))return this.incomingPendingConnections++,!0;if(this.incomingPendingConnections===this.maxIncomingPendingConnections)return this.log("connection from %a refused - incomingPendingConnections exceeded by host",t.remoteAddr),!1;if(t.remoteAddr.isThinWaistAddress()){const s=t.remoteAddr.nodeAddress().address;try{await this.inboundConnectionRateLimiter.consume(s,1)}catch{return this.log("connection from %a refused - inboundConnectionThreshold exceeded by host %s",t.remoteAddr,s),!1}}return this.getConnections().length<this.maxConnections?(this.incomingPendingConnections++,!0):(this.log("connection from %a refused - maxConnections exceeded",t.remoteAddr),!1)}afterUpgradeInbound(){this.incomingPendingConnections--}getDialQueue(){const t={queued:"queued",running:"active",errored:"error",complete:"success"};return this.dialQueue.queue.queue.map(e=>({id:e.id,status:t[e.status],peerId:e.options.peerId,multiaddrs:[...e.options.multiaddrs].map(r=>me(r))}))}async isDialable(t,e={}){return this.dialQueue.isDialable(t,e)}}class nd{constructor(t){p(this,"movingAverage");p(this,"variance");p(this,"deviation");p(this,"forecast");p(this,"timeSpan");p(this,"previousTime");this.timeSpan=t,this.movingAverage=0,this.variance=0,this.deviation=0,this.forecast=0}alpha(t,e){return 1-Math.exp(-(t-e)/this.timeSpan)}push(t,e=Date.now()){if(this.previousTime!=null){const r=this.alpha(e,this.previousTime),s=t-this.movingAverage,i=r*s;this.movingAverage=r*t+(1-r)*this.movingAverage,this.variance=(1-r)*(this.variance+s*i),this.deviation=Math.sqrt(this.variance),this.forecast=this.movingAverage+r*s}else this.movingAverage=t;this.previousTime=e}}const FN=1.2,$N=2,UN=2e3;class VN{constructor(t={}){p(this,"success");p(this,"failure");p(this,"next");p(this,"metric");p(this,"timeoutMultiplier");p(this,"failureMultiplier");p(this,"minTimeout");this.success=new nd(t.interval??5e3),this.failure=new nd(t.interval??5e3),this.next=new nd(t.interval??5e3),this.failureMultiplier=t.failureMultiplier??$N,this.timeoutMultiplier=t.timeoutMultiplier??FN,this.minTimeout=t.minTimeout??UN,t.metricName!=null&&(this.metric=t.metrics?.registerMetricGroup(t.metricName))}getTimeoutSignal(t={}){const e=Math.max(Math.round(this.next.movingAverage*(t.timeoutFactor??this.timeoutMultiplier)),this.minTimeout),r=AbortSignal.timeout(e),s=Qi([t.signal,r]);return s.start=Date.now(),s.timeout=e,s}cleanUp(t){const e=Date.now()-t.start;t.aborted?(this.failure.push(e),this.next.push(e*this.failureMultiplier),this.metric?.update({failureMovingAverage:this.failure.movingAverage,failureDeviation:this.failure.deviation,failureForecast:this.failure.forecast,failureVariance:this.failure.variance,failure:e})):(this.success.push(e),this.next.push(e),this.metric?.update({successMovingAverage:this.success.movingAverage,successDeviation:this.success.deviation,successForecast:this.success.forecast,successVariance:this.success.variance,success:e}))}}const HN=1e4,zN="1.0.0",qN="ping",WN="ipfs",Gm=32,GN=!0;var My,Ly;Ly=Symbol.toStringTag,My=Wn;class KN{constructor(t,e={}){p(this,"protocol");p(this,"components");p(this,"log");p(this,"heartbeatInterval");p(this,"pingIntervalMs");p(this,"abortController");p(this,"timeout");p(this,"abortConnectionOnPingFailure");p(this,Ly,"@libp2p/connection-monitor");p(this,My,["@libp2p/connection-monitor"]);this.components=t,this.protocol=`/${e.protocolPrefix??WN}/${qN}/${zN}`,this.log=t.logger.forComponent("libp2p:connection-monitor"),this.pingIntervalMs=e.pingInterval??HN,this.abortConnectionOnPingFailure=e.abortConnectionOnPingFailure??GN,this.timeout=new VN({...e.pingTimeout??{},metrics:t.metrics,metricName:"libp2p_connection_monitor_ping_time_milliseconds"})}start(){this.abortController=new AbortController,this.abortController.signal,this.heartbeatInterval=setInterval(()=>{this.components.connectionManager.getConnections().forEach(t=>{Promise.resolve().then(async()=>{let e=Date.now();try{const r=this.timeout.getTimeoutSignal({signal:this.abortController?.signal}),s=await t.newStream(this.protocol,{signal:r,runOnLimitedConnection:!0}),i=Ow(s);e=Date.now(),await Promise.all([i.write(Ui(Gm),{signal:r}),i.read(Gm,{signal:r})]),t.rtt=Date.now()-e,await i.unwrap().close({signal:r})}catch(r){if(r.name!=="UnsupportedProtocolError")throw r;t.rtt=(Date.now()-e)/2}}).catch(e=>{this.log.error("error during heartbeat",e),this.abortConnectionOnPingFailure?(this.log.error("aborting connection due to ping failure"),t.abort(e)):this.log("connection ping failed, but not aborting due to abortConnectionOnPingFailure flag")})})},this.pingIntervalMs)}stop(){this.abortController?.abort(),this.heartbeatInterval!=null&&clearInterval(this.heartbeatInterval)}}var By;By=Symbol.toStringTag;class YN{constructor(t,e){p(this,"routers");p(this,"started");p(this,"components");p(this,By,"@libp2p/content-routing");this.routers=e.routers??[],this.started=!1,this.components=t,this.findProviders=t.metrics?.traceFunction("libp2p.contentRouting.findProviders",this.findProviders.bind(this),{optionsIndex:1,getAttributesFromArgs:([r],s)=>({...s,cid:r.toString()}),getAttributesFromYieldedValue:(r,s)=>({...s,providers:[...Array.isArray(s.providers)?s.providers:[],r.id.toString()]})})??this.findProviders,this.provide=t.metrics?.traceFunction("libp2p.contentRouting.provide",this.provide.bind(this),{optionsIndex:1,getAttributesFromArgs:([r],s)=>({...s,cid:r.toString()})})??this.provide,this.cancelReprovide=t.metrics?.traceFunction("libp2p.contentRouting.cancelReprovide",this.cancelReprovide.bind(this),{optionsIndex:1,getAttributesFromArgs:([r],s)=>({...s,cid:r.toString()})})??this.cancelReprovide,this.put=t.metrics?.traceFunction("libp2p.contentRouting.put",this.put.bind(this),{optionsIndex:2,getAttributesFromArgs:([r])=>({key:de(r,"base36")})})??this.put,this.get=t.metrics?.traceFunction("libp2p.contentRouting.get",this.get.bind(this),{optionsIndex:1,getAttributesFromArgs:([r])=>({key:de(r,"base36")})})??this.get}isStarted(){return this.started}async start(){this.started=!0}async stop(){this.started=!1}async*findProviders(t,e={}){if(this.routers.length===0)throw new Xu("No content routers available");const r=this,s=new xi;for await(const i of Lc(...r.routers.map(o=>o.findProviders(t,e))))i!=null&&(i.multiaddrs.length>0&&await this.components.peerStore.merge(i.id,{multiaddrs:i.multiaddrs}),!s.has(i.id)&&(s.add(i.id),yield i))}async provide(t,e={}){if(this.routers.length===0)throw new Xu("No content routers available");await Promise.all(this.routers.map(async r=>{await r.provide(t,e)}))}async cancelReprovide(t,e={}){if(this.routers.length===0)throw new Xu("No content routers available");await Promise.all(this.routers.map(async r=>{await r.cancelReprovide(t,e)}))}async put(t,e,r){if(!this.isStarted())throw new Qo;await Promise.all(this.routers.map(async s=>{await s.put(t,e,r)}))}async get(t,e){if(!this.isStarted())throw new Qo;return Promise.any(this.routers.map(async r=>r.get(t,e)))}}var Ny;Ny=Symbol.toStringTag;class QN{constructor(t,e={}){p(this,"log");p(this,"peerId");p(this,"peerStore");p(this,"routers");p(this,Ny,"@libp2p/peer-routing");this.log=t.logger.forComponent("libp2p:peer-routing"),this.peerId=t.peerId,this.peerStore=t.peerStore,this.routers=e.routers??[],this.findPeer=t.metrics?.traceFunction("libp2p.peerRouting.findPeer",this.findPeer.bind(this),{optionsIndex:1,getAttributesFromArgs:([r],s)=>({...s,peer:r.toString()})})??this.findPeer,this.getClosestPeers=t.metrics?.traceFunction("libp2p.peerRouting.getClosestPeers",this.getClosestPeers.bind(this),{optionsIndex:1,getAttributesFromArgs:([r],s)=>({...s,key:de(r,"base36")}),getAttributesFromYieldedValue:(r,s)=>({...s,peers:[...Array.isArray(s.peers)?s.peers:[],r.id.toString()]})})??this.getClosestPeers}async findPeer(t,e){if(this.routers.length===0)throw new Rm("No peer routers available");if(t.toString()===this.peerId.toString())throw new BB("Should not try to find self");const r=this,s=Lc(...this.routers.map(i=>async function*(){try{yield await i.findPeer(t,e)}catch(o){r.log.error(o)}}()));for await(const i of s)if(i!=null)return i.multiaddrs.length>0&&await this.peerStore.merge(i.id,{multiaddrs:i.multiaddrs}),i;throw new Sc}async*getClosestPeers(t,e={}){if(this.routers.length===0)throw new Rm("No peer routers available");const r=this,s=ia(1024);for await(const i of rM(async function*(){const o=Lc(...r.routers.map(a=>a.getClosestPeers(t,e)));for await(let a of o)yield async()=>{if(a.multiaddrs.length===0)try{a=await r.findPeer(a.id,{...e,useCache:!1})}catch(l){r.log.error("could not find peer multiaddrs",l);return}return a}}()))i!=null&&(i.multiaddrs.length>0&&await this.peerStore.merge(i.id,{multiaddrs:i.multiaddrs}),!s.has(i.id.toMultihash().bytes)&&(s.add(i.id.toMultihash().bytes),yield i))}}var Ry,Oy;class ZN extends(Oy=ar,Ry=Symbol.toStringTag,Oy){constructor(e){super();p(this,"peerRouting");p(this,"log");p(this,"walking");p(this,"walkers");p(this,"shutdownController");p(this,"walkController");p(this,"needNext");p(this,Ry,"@libp2p/random-walk");this.log=e.logger.forComponent("libp2p:random-walk"),this.peerRouting=e.peerRouting,this.walkers=0,this.walking=!1,this.shutdownController=new AbortController,this.shutdownController.signal}start(){this.shutdownController=new AbortController,this.shutdownController.signal}stop(){this.shutdownController.abort()}async*walk(e){this.walking||this.startWalk(),this.walkers++;const r=Qi([this.shutdownController.signal,e?.signal]);try{for(;;)this.needNext?.resolve(),this.needNext=bt(),yield(await nc(this,"walk:peer",r,{errorEvent:"walk:error"})).detail}finally{r.clear(),this.walkers--,this.walkers===0&&(this.walkController?.abort(),this.walkController=void 0)}}startWalk(){this.walking=!0,this.walkController=new AbortController,this.walkController.signal;const e=Qi([this.walkController.signal,this.shutdownController.signal]),r=Date.now();let s=0;Promise.resolve().then(async()=>{for(this.log("start walk");this.walkers>0;)try{const i=Ui(32);let o=Date.now();for await(const a of this.peerRouting.getClosestPeers(i,{signal:e}))e.aborted&&this.log("aborting walk"),e.throwIfAborted(),this.log("found peer %p after %dms for %d walkers",a.id,Date.now()-o,this.walkers),s++,this.safeDispatchEvent("walk:peer",{detail:a}),this.walkers===1&&this.needNext!=null&&(this.log("wait for need next"),await Ir(this.needNext.promise,e)),o=Date.now();this.log("walk iteration for %b and %d walkers finished, found %d peers",i,this.walkers,s)}catch(i){this.log.error("random walk errored",i),this.safeDispatchEvent("walk:error",{detail:i})}this.log("no walkers left, ended walk")}).catch(i=>{this.log.error("random walk errored",i)}).finally(()=>{this.log("finished walk, found %d peers after %dms",s,Date.now()-r),this.walking=!1})}}const r1=32,s1=64;var Fy;Fy=Symbol.toStringTag;class XN{constructor(t){p(this,"log");p(this,"topologies");p(this,"handlers");p(this,"components");p(this,Fy,"@libp2p/registrar");this.log=t.logger.forComponent("libp2p:registrar"),this.topologies=new Map,this.handlers=new Map,this.components=t,this._onDisconnect=this._onDisconnect.bind(this),this._onPeerUpdate=this._onPeerUpdate.bind(this),this._onPeerIdentify=this._onPeerIdentify.bind(this),this.components.events.addEventListener("peer:disconnect",this._onDisconnect),this.components.events.addEventListener("peer:update",this._onPeerUpdate),this.components.events.addEventListener("peer:identify",this._onPeerIdentify)}getProtocols(){return Array.from(new Set([...this.handlers.keys()])).sort()}getHandler(t){const e=this.handlers.get(t);if(e==null)throw new NB(`No handler registered for protocol ${t}`);return e}getTopologies(t){const e=this.topologies.get(t);return e==null?[]:[...e.values()]}async handle(t,e,r){if(this.handlers.has(t)&&r?.force!==!0)throw new RB(`Handler already registered for protocol ${t}`);const s=Kf.bind({ignoreUndefined:!0})({maxInboundStreams:r1,maxOutboundStreams:s1},r);this.handlers.set(t,{handler:e,options:s}),await this.components.peerStore.merge(this.components.peerId,{protocols:[t]})}async unhandle(t){(Array.isArray(t)?t:[t]).forEach(r=>{this.handlers.delete(r)}),await this.components.peerStore.patch(this.components.peerId,{protocols:this.getProtocols()})}async register(t,e){if(e==null)throw new X("invalid topology");const r=`${(Math.random()*1e9).toString(36)}${Date.now()}`;let s=this.topologies.get(t);return s==null&&(s=new Map,this.topologies.set(t,s)),s.set(r,e),r}unregister(t){for(const[e,r]of this.topologies.entries())r.has(t)&&(r.delete(t),r.size===0&&this.topologies.delete(e))}_onDisconnect(t){const e=t.detail;this.components.peerStore.get(e).then(r=>{for(const s of r.protocols){const i=this.topologies.get(s);if(i!=null)for(const o of i.values())o.filter?.has(e)!==!1&&(o.filter?.remove(e),o.onDisconnect?.(e))}}).catch(r=>{r.name!=="NotFoundError"&&this.log.error("could not inform topologies of disconnecting peer %p",e,r)})}_onPeerUpdate(t){const{peer:e,previous:r}=t.detail,s=(r?.protocols??[]).filter(i=>!e.protocols.includes(i));for(const i of s){const o=this.topologies.get(i);if(o!=null)for(const a of o.values())a.filter?.has(e.id)!==!1&&(a.filter?.remove(e.id),a.onDisconnect?.(e.id))}}_onPeerIdentify(t){const e=t.detail.protocols,r=t.detail.connection,s=t.detail.peerId;for(const i of e){const o=this.topologies.get(i);if(o!=null)for(const a of o.values())r.limits!=null&&a.notifyOnLimitedConnection!==!0||a.filter?.has(s)!==!0&&(a.filter?.add(s),a.onConnect?.(s,r))}}}class jN extends Map{constructor(e){super();p(this,"metric");const{name:r,metrics:s}=e;this.metric=s.registerMetric(r),this.updateComponentMetric()}set(e,r){return super.set(e,r),this.updateComponentMetric(),this}delete(e){const r=super.delete(e);return this.updateComponentMetric(),r}clear(){super.clear(),this.updateComponentMetric()}updateComponentMetric(){this.metric.update(this.size)}}function JN(n){const{name:t,metrics:e}=n;let r;return e!=null?r=new jN({name:t,metrics:e}):r=new Map,r}var $y;$y=Symbol.toStringTag;class eR{constructor(t,e={}){p(this,"log");p(this,"components");p(this,"transports");p(this,"listeners");p(this,"faultTolerance");p(this,"started");p(this,$y,"@libp2p/transport-manager");this.log=t.logger.forComponent("libp2p:transports"),this.components=t,this.started=!1,this.transports=new Map,this.listeners=JN({name:"libp2p_transport_manager_listeners",metrics:this.components.metrics}),this.faultTolerance=e.faultTolerance??Yo.FATAL_ALL}add(t){const e=t[Symbol.toStringTag];if(e==null)throw new X("Transport must have a valid tag");if(this.transports.has(e))throw new X(`There is already a transport with the tag ${e}`);this.log("adding transport %s",e),this.transports.set(e,t),this.listeners.has(e)||this.listeners.set(e,[])}isStarted(){return this.started}start(){this.started=!0}async afterStart(){const t=this.components.addressManager.getListenAddrs();await this.listen(t)}async stop(){const t=[];for(const[e,r]of this.listeners)for(this.log("closing listeners for %s",e);r.length>0;){const s=r.pop();s!=null&&t.push(s.close())}await Promise.all(t),this.log("all listeners closed");for(const e of this.listeners.keys())this.listeners.set(e,[]);this.started=!1}async dial(t,e){const r=this.dialTransportForMultiaddr(t);if(r==null)throw new HB(`No transport available for address ${String(t)}`);return e?.onProgress?.(new vt("transport-manager:selected-transport",r[Symbol.toStringTag])),r.dial(t,{...e,upgrader:this.components.upgrader})}getAddrs(){let t=[];for(const e of this.listeners.values())for(const r of e)t=[...t,...r.getAddrs()];return t}getTransports(){return Array.of(...this.transports.values())}getListeners(){return Array.of(...this.listeners.values()).flat()}dialTransportForMultiaddr(t){for(const e of this.transports.values())if(e.dialFilter([t]).length>0)return e}listenTransportForMultiaddr(t){for(const e of this.transports.values())if(e.listenFilter([t]).length>0)return e}async listen(t){if(!this.isStarted())throw new Qo("Not started");if(t==null||t.length===0){this.log("no addresses were provided for listening, this node is dial only");return}const e={errors:new Map,ipv4:{success:0,attempts:0},ipv6:{success:0,attempts:0}};t.forEach(i=>{e.errors.set(i.toString(),new OB)});const r=[];for(const[i,o]of this.transports.entries()){const a=o.listenFilter(t);for(const l of a){this.log("creating listener for %s on %a",i,l);const u=o.createListener({upgrader:this.components.upgrader});let h=this.listeners.get(i)??[];h==null&&(h=[],this.listeners.set(i,h)),h.push(u),u.addEventListener("listening",()=>{this.components.events.safeDispatchEvent("transport:listening",{detail:u})}),u.addEventListener("close",()=>{const c=h.findIndex(d=>d===u);h.splice(c,1),this.components.events.safeDispatchEvent("transport:close",{detail:u})}),Pg.matches(l)?e.ipv4.attempts++:Dg.matches(l)&&e.ipv6.attempts++,r.push(u.listen(l).then(()=>{e.errors.delete(l.toString()),Pg.matches(l)&&e.ipv4.success++,Dg.matches(l)&&e.ipv6.success++},c=>{throw this.log.error("transport %s could not listen on address %a - %e",i,l,c),e.errors.set(l.toString(),c),c}))}}const s=await Promise.allSettled(r);if(!(s.length>0&&s.every(i=>i.status==="fulfilled"))){if(this.ipv6Unsupported(e)){this.log("all IPv4 addresses succeed but all IPv6 failed");return}if(this.faultTolerance===Yo.NO_FATAL){this.log("failed to listen on any address but fault tolerance allows this");return}throw new FB(`Some configured addresses failed to be listened on, you may need to remove one or more listen addresses from your configuration or set \`transportManager.faultTolerance\` to NO_FATAL:
${[...e.errors.entries()].map(([i,o])=>`
  ${i}: ${`${o.stack??o}`.split(`
`).join(`
  `)}
`).join("")}`)}}ipv6Unsupported(t){if(t.ipv4.attempts===0||t.ipv6.attempts===0)return!1;const e=t.ipv4.attempts===t.ipv4.success,r=t.ipv6.success===0;return e&&r}async remove(t){const e=this.listeners.get(t)??[];this.log.trace("removing transport %s",t);const r=[];for(this.log.trace("closing listeners for %s",t);e.length>0;){const s=e.pop();s!=null&&r.push(s.close())}await Promise.all(r),this.transports.delete(t),this.listeners.delete(t)}async removeAll(){const t=[];for(const e of this.transports.keys())t.push(this.remove(e));await Promise.all(t)}}const tn="/multistream/1.0.0",rp=1024,tR=te(`
`);async function Mo(n,t,e){await n.write(t,e)}async function nR(n,t,e){await n.writeV(t,e)}async function rR(n,t){const e=await n.read(t);if(e.byteLength===0||e.get(e.byteLength-1)!==tR[0])throw t.log.error("Invalid mss message - missing newline",e),new jn("Missing newline");return e.sublist(0,-1)}async function Ii(n,t){const e=await rR(n,t);return de(e.subarray())}async function rd(n,t,e){if(t=Array.isArray(t)?[...t]:[t],t.length===1&&e.negotiateFully===!1)return sR(n,t[0],e);const r=ql(n,{...e,maxDataLength:rp}),s=t.shift();if(s==null)throw new Error("At least one protocol must be specified");e.log.trace('select: write ["%s", "%s"]',tn,s);const i=te(`${tn}
`),o=te(`${s}
`);await nR(r,[i,o],e),e.log.trace("select: reading multistream-select header");let a=await Ii(r,e);if(e.log.trace('select: read "%s"',a),a===tn&&(e.log.trace("select: reading protocol response"),a=await Ii(r,e),e.log.trace('select: read "%s"',a)),a===s)return{stream:r.unwrap(),protocol:s};for(const l of t){e.log.trace('select: write "%s"',l),await Mo(r,te(`${l}
`),e),e.log.trace("select: reading protocol response");const u=await Ii(r,e);if(e.log.trace('select: read "%s" for "%s"',u,l),u===l)return{stream:r.unwrap(),protocol:l}}throw new Il("protocol selection failed")}function sR(n,t,e){const r=n.sink.bind(n),s=n.source;let i=!1,o=!1;const a=bt();let l=!1,u=!1;const h=bt();let c=!1,d=!1;const f=bt(),g=ql({sink:r,source:s},{...e,maxDataLength:rp});n.sink=async _=>{const{sink:w}=g.unwrap();await w(async function*(){let S=!1;for await(const E of _){if(u&&await h.promise,l)yield E;else{u=!0,e.log.trace('optimistic: write ["%s", "%s", data(%d)] in sink',tn,t,E.byteLength);const A=`${t}
`;yield new We(Uint8Array.from([19]),te(`${tn}
`),Vn(A.length),te(A),E).subarray(),e.log.trace('optimistic: wrote ["%s", "%s", data(%d)] in sink',tn,t,E.byteLength),l=!0,u=!1,h.resolve(),y().catch(I=>{e.log.error("could not finish optimistic protocol negotiation of %s",t,I)})}S=!0}S||await y()}())};async function y(){if(o){e.log.trace("optimistic: already negotiating %s stream",t),await a.promise;return}o=!0;try{l||(e.log.trace("optimistic: doing send protocol for %s stream",t),await m()),c||(e.log.trace("optimistic: doing read protocol for %s stream",t),await v())}finally{o=!1,i=!0,a.resolve()}}async function m(){if(u){await h.promise;return}u=!0;try{e.log.trace('optimistic: write ["%s", "%s", data] in source',tn,t),await g.writeV([te(`${tn}
`),te(`${t}
`)]),e.log.trace('optimistic: wrote ["%s", "%s", data] in source',tn,t)}finally{l=!0,u=!1,h.resolve()}}async function v(){if(d){await f.promise;return}d=!0;try{e.log.trace("optimistic: reading multistream select header");let _=await Ii(g,e);if(e.log.trace('optimistic: read multistream select header "%s"',_),_===tn&&(_=await Ii(g,e)),e.log.trace('optimistic: read protocol "%s", expecting "%s"',_,t),_!==t)throw new Il("protocol selection failed")}finally{c=!0,d=!1,f.resolve()}}if(n.source=async function*(){await y(),e.log.trace('optimistic: reading data from "%s" stream',t),yield*g.unwrap().source}(),n.closeRead!=null){const _=n.closeRead.bind(n);n.closeRead=async w=>{i||await y().catch(S=>{e.log.error("could not negotiate protocol before close read",S)}),await _(w)}}if(n.closeWrite!=null){const _=n.closeWrite.bind(n);n.closeWrite=async w=>{i||await y().catch(S=>{e.log.error("could not negotiate protocol before close write",S)}),await _(w)}}if(n.close!=null){const _=n.close.bind(n);n.close=async w=>{const S=[];u&&S.push(h.promise),d&&S.push(f.promise),S.length>0?await Ir(Promise.all(S),w?.signal):(i=!0,o=!1,a.resolve()),await _(w)}}return{stream:n,protocol:t}}const i1=1024*1024*4;class iR extends Error{constructor(){super(...arguments);p(this,"name","InvalidDataLengthError");p(this,"code","ERR_MSG_DATA_TOO_LONG")}}function oR(n){return n[Symbol.asyncIterator]!=null}function o1(n,t){if(n.byteLength>t)throw new iR("Message length too long")}const eu=n=>{const t=ln(n),e=cr(t);return Vn(n,e),eu.bytes=t,e};eu.bytes=0;function a1(n,t){t=t??{};const e=t.lengthEncoder??eu,r=t?.maxDataLength??i1;function*s(i){o1(i,r);const o=e(i.byteLength);o instanceof Uint8Array?yield o:yield*o,i instanceof Uint8Array?yield i:yield*i}return oR(n)?async function*(){for await(const i of n)yield*s(i)}():function*(){for(const i of n)yield*s(i)}()}a1.single=(n,t)=>{t=t??{};const e=t.lengthEncoder??eu,r=t?.maxDataLength??i1;return o1(n,r),new We(e(n.byteLength),n)};var Km;(function(n){n[n.LENGTH=0]="LENGTH",n[n.DATA=1]="DATA"})(Km||(Km={}));async function sd(n,t,e){t=Array.isArray(t)?t:[t],e.log.trace("handle: available protocols %s",t);const r=ql(n,{...e,maxDataLength:rp,maxLengthLength:2});for(;;){e.log.trace("handle: reading incoming string");const s=await Ii(r,e);if(e.log.trace('handle: read "%s"',s),s===tn){e.log.trace('handle: respond with "%s" for "%s"',tn,s),await Mo(r,te(`${tn}
`),e),e.log.trace('handle: responded with "%s" for "%s"',tn,s);continue}if(t.includes(s))return e.log.trace('handle: respond with "%s" for "%s"',s,s),await Mo(r,te(`${s}
`),e),e.log.trace('handle: responded with "%s" for "%s"',s,s),{stream:r.unwrap(),protocol:s};if(s==="ls"){const i=new We(...t.map(o=>a1.single(te(`${o}
`))),te(`
`));e.log.trace('handle: respond with "%s" for %s',t,s),await Mo(r,i,e),e.log.trace('handle: responded with "%s" for %s',t,s);continue}e.log.trace('handle: respond with "na" for "%s"',s),await Mo(r,te(`na
`),e),e.log('handle: responded with "na" for "%s"',s)}}const aR=500;var Uy,Vy;Vy=Symbol.toStringTag,Uy=gA;class cR{constructor(t){p(this,"id");p(this,"remoteAddr");p(this,"remotePeer");p(this,"direction");p(this,"timeline");p(this,"multiplexer");p(this,"encryption");p(this,"status");p(this,"limits");p(this,"log");p(this,"tags");p(this,"_newStream");p(this,"_close");p(this,"_abort");p(this,"_getStreams");p(this,Vy,"Connection");p(this,Uy,!0);const{remoteAddr:e,remotePeer:r,newStream:s,close:i,abort:o,getStreams:a}=t;this.id=`${parseInt(String(Math.random()*1e9)).toString(36)}${Date.now()}`,this.remoteAddr=e,this.remotePeer=r,this.direction=t.direction,this.status="open",this.timeline=t.timeline,this.multiplexer=t.multiplexer,this.encryption=t.encryption,this.limits=t.limits,this.log=t.logger.forComponent(`libp2p:connection:${this.direction}:${this.id}`),this.remoteAddr.getPeerId()==null&&(this.remoteAddr=this.remoteAddr.encapsulate(`/p2p/${this.remotePeer}`)),this._newStream=s,this._close=i,this._abort=o,this._getStreams=a,this.tags=[]}get streams(){return this._getStreams()}async newStream(t,e){if(this.status==="closing")throw new rb("the connection is being closed");if(this.status==="closed")throw new ef("the connection is closed");if(Array.isArray(t)||(t=[t]),this.limits!=null&&e?.runOnLimitedConnection!==!0)throw new nf("Cannot open protocol stream on limited connection");const r=await this._newStream(t,e);return r.direction="outbound",r}async close(t={}){if(!(this.status==="closed"||this.status==="closing")){if(this.log("closing connection to %a",this.remoteAddr),this.status="closing",t.signal==null){const e=AbortSignal.timeout(aR);t={...t,signal:e}}try{this.log.trace("closing underlying transport"),await this._close(t),this.log.trace("updating timeline with close time"),this.status="closed",this.timeline.close=Date.now()}catch(e){this.log.error("error encountered during graceful close of connection to %a",this.remoteAddr,e),this.abort(e)}}}abort(t){this.status!=="closed"&&(this.log.error("aborting connection to %a due to error",this.remoteAddr,t),this.status="closing",this._abort(t),this.status="closed",this.timeline.close=Date.now())}}function lR(n){return new cR(n)}function uR(n,t){try{const{options:e}=t.getHandler(n);return e.maxInboundStreams}catch(e){if(e.name!=="UnhandledProtocolError")throw e}return r1}function dR(n,t,e={}){try{const{options:r}=t.getHandler(n);if(r.maxOutboundStreams!=null)return r.maxOutboundStreams}catch(r){if(r.name!=="UnhandledProtocolError")throw r}return e.maxOutboundStreams??s1}function Ym(n,t,e){let r=0;return e.streams.forEach(s=>{s.direction===t&&s.protocol===n&&r++}),r}var Hy;Hy=Symbol.toStringTag;class hR{constructor(t,e){p(this,"components");p(this,"connectionEncrypters");p(this,"streamMuxers");p(this,"inboundUpgradeTimeout");p(this,"inboundStreamProtocolNegotiationTimeout");p(this,"outboundStreamProtocolNegotiationTimeout");p(this,"events");p(this,"metrics");p(this,Hy,"@libp2p/upgrader");this.components=t,this.connectionEncrypters=new Map,e.connectionEncrypters.forEach(r=>{this.connectionEncrypters.set(r.protocol,r)}),this.streamMuxers=new Map,e.streamMuxers.forEach(r=>{this.streamMuxers.set(r.protocol,r)}),this.inboundUpgradeTimeout=e.inboundUpgradeTimeout??aN,this.inboundStreamProtocolNegotiationTimeout=e.inboundStreamProtocolNegotiationTimeout??$m,this.outboundStreamProtocolNegotiationTimeout=e.outboundStreamProtocolNegotiationTimeout??$m,this.events=t.events,this.metrics={dials:t.metrics?.registerCounterGroup("libp2p_connection_manager_dials_total"),errors:t.metrics?.registerCounterGroup("libp2p_connection_manager_dial_errors_total")}}async shouldBlockConnection(t,...e){const r=this.components.connectionGater[t];if(r==null)return;if(await r.apply(this.components.connectionGater,e)===!0)throw new UB(`The multiaddr connection is blocked by gater.${t}`)}createInboundAbortSignal(t){return Qi([AbortSignal.timeout(this.inboundUpgradeTimeout),t])}async upgradeInbound(t,e){let r=!1;const s=this.createInboundAbortSignal(e.signal);try{if(this.metrics.dials?.increment({inbound:!0}),r=await this.components.connectionManager.acceptIncomingConnection(t),!r)throw new VB("Connection denied");await this.shouldBlockConnection("denyInboundConnection",t),await this._performUpgrade(t,"inbound",{...e,signal:s})}catch(i){throw this.metrics.errors?.increment({inbound:!0}),i}finally{s.clear(),r&&this.components.connectionManager.afterUpgradeInbound()}}async upgradeOutbound(t,e){try{this.metrics.dials?.increment({outbound:!0});const r=t.remoteAddr.getPeerId();let s;r!=null&&(s=Bt(r),await this.shouldBlockConnection("denyOutboundConnection",s,t));let i="outbound";return e.initiator===!1&&(i="inbound"),await this._performUpgrade(t,i,e)}catch(r){throw this.metrics.errors?.increment({outbound:!0}),r}}async _performUpgrade(t,e,r){let s,i,o,a,l;this.components.metrics?.trackMultiaddrConnection(t),t.log.trace("starting the %s connection upgrade",e);let u=t;if(r?.skipProtection!==!0){const h=this.components.connectionProtector;h!=null&&(t.log("protecting the %s connection",e),u=await h.protect(t,r))}try{if(s=u,r?.skipEncryption!==!0){r?.onProgress?.(new vt(`upgrader:encrypt-${e}-connection`)),{conn:s,remotePeer:i,protocol:l,streamMuxer:a}=await(e==="inbound"?this._encryptInbound(u,r):this._encryptOutbound(u,r));const h={...u,...s};await this.shouldBlockConnection(e==="inbound"?"denyInboundEncryptedConnection":"denyOutboundEncryptedConnection",i,h)}else{const h=t.remoteAddr.getPeerId();if(h==null)throw new xl(`${e} connection that skipped encryption must have a peer id`);const c=Bt(h);l="native",i=c}if(i.equals(this.components.peerId)){const h=new tf("Can not dial self");throw t.abort(h),h}if(o=s,r?.muxerFactory!=null)a=r.muxerFactory;else if(a==null&&this.streamMuxers.size>0){r?.onProgress?.(new vt(`upgrader:multiplex-${e}-connection`));const h=await(e==="inbound"?this._multiplexInbound({...u,...s},this.streamMuxers,r):this._multiplexOutbound({...u,...s},this.streamMuxers,r));a=h.muxerFactory,o=h.stream}}catch(h){throw t.log.error("failed to upgrade inbound connection %s %a - %e",e==="inbound"?"from":"to",t.remoteAddr,h),h}return await this.shouldBlockConnection(e==="inbound"?"denyInboundUpgradedConnection":"denyOutboundUpgradedConnection",i,t),t.log("successfully upgraded %s connection",e),this._createConnection({cryptoProtocol:l,direction:e,maConn:t,upgradedConn:o,muxerFactory:a,remotePeer:i,limits:r?.limits})}_createConnection(t){const{cryptoProtocol:e,direction:r,maConn:s,upgradedConn:i,remotePeer:o,muxerFactory:a,limits:l}=t;let u,h,c;a!=null&&(u=a.createStreamMuxer({direction:r,onIncomingStream:g=>{c!=null&&Promise.resolve().then(async()=>{const y=this.components.registrar.getProtocols(),m=AbortSignal.timeout(this.inboundStreamProtocolNegotiationTimeout),{stream:v,protocol:_}=await sd(g,y,{signal:m,log:g.log,yieldBytes:!1});if(c==null)return;c.log("incoming stream opened on %s",_);const w=uR(_,this.components.registrar);if(Ym(_,"inbound",c)===w){const E=new lb(`Too many inbound protocol streams for protocol "${_}" - limit ${w}`);throw g.abort(E),E}g.source=v.source,g.sink=v.sink,g.protocol=_,v.closeWrite!=null&&(g.closeWrite=v.closeWrite),v.closeRead!=null&&(g.closeRead=v.closeRead),v.close!=null&&(g.close=v.close),await this.components.peerStore.merge(o,{protocols:[_]}),this.components.metrics?.trackProtocolStream(g,c),this._onStream({connection:c,stream:g,protocol:_})}).catch(async y=>{c.log.error("error handling incoming stream id %s - %e",g.id,y),g.timeline.close==null&&await g.close()})}}),h=async(g,y={})=>{if(u==null)throw new Ka("Connection is not multiplexed");c.log.trace("starting new stream for protocols %s",g);const m=await u.newStream();c.log.trace("started new stream %s for protocols %s",m.id,g);try{if(y.signal==null){m.log("no abort signal was passed while trying to negotiate protocols %s falling back to default timeout",g);const E=AbortSignal.timeout(this.outboundStreamProtocolNegotiationTimeout);y={...y,signal:E}}m.log.trace("selecting protocol from protocols %s",g);const{stream:v,protocol:_}=await rd(m,g,{...y,log:m.log,yieldBytes:!0});m.log.trace("selected protocol %s",_);const w=dR(_,this.components.registrar,y),S=Ym(_,"outbound",c);if(S>=w){const E=new rf(`Too many outbound protocol streams for protocol "${_}" - ${S}/${w}`);throw m.abort(E),E}return await this.components.peerStore.merge(o,{protocols:[_]}),m.source=v.source,m.sink=v.sink,m.protocol=_,v.closeWrite!=null&&(m.closeWrite=v.closeWrite),v.closeRead!=null&&(m.closeRead=v.closeRead),v.close!=null&&(m.close=v.close),this.components.metrics?.trackProtocolStream(m,c),m}catch(v){throw c.log.error("could not create new outbound stream on connection %s %a for protocols %s - %e",r==="inbound"?"from":"to",t.maConn.remoteAddr,g,v),m.timeline.close==null&&m.abort(v),v}},Promise.all([u.sink(i.source),i.sink(u.source)]).catch(g=>{c.log.error("error piping data through muxer - %e",g)}));const d=s.timeline;s.timeline=new Proxy(d,{set:(...g)=>(g[1]==="close"&&g[2]!=null&&d.close==null&&(async()=>{try{c.status==="open"&&await c.close()}catch(y){c.log.error("error closing connection after timeline close %e",y)}finally{this.events.safeDispatchEvent("connection:close",{detail:c})}})().catch(y=>{c.log.error("error thrown while dispatching connection:close event %e",y)}),Reflect.set(...g))}),s.timeline.upgraded=Date.now();const f=()=>{throw new Ka("Connection is not multiplexed")};return c=lR({remoteAddr:s.remoteAddr,remotePeer:o,status:"open",direction:r,timeline:s.timeline,multiplexer:u?.protocol,encryption:e,limits:l,logger:this.components.logger,newStream:h??f,getStreams:()=>u?.streams??[],close:async g=>{await u?.close(g),await s.close(g)},abort:g=>{s.abort(g),u?.abort(g)}}),this.events.safeDispatchEvent("connection:open",{detail:c}),c.__maConnTimeline=d,c}_onStream(t){const{connection:e,stream:r,protocol:s}=t,{handler:i,options:o}=this.components.registrar.getHandler(s);if(e.limits!=null&&o.runOnLimitedConnection!==!0)throw new nf("Cannot open protocol stream on limited connection");i({connection:e,stream:r})}async _encryptInbound(t,e){const r=Array.from(this.connectionEncrypters.keys());try{const{stream:s,protocol:i}=await sd(t,r,{...e,log:t.log}),o=this.connectionEncrypters.get(i);if(o==null)throw new Ya(`no crypto module found for ${i}`);return t.log("encrypting inbound connection to %a using %s",t.remoteAddr,i),{...await o.secureInbound(s,e),protocol:i}}catch(s){throw t.log.error("encrypting inbound connection from %a failed",t.remoteAddr,s),new Ya(s.message)}}async _encryptOutbound(t,e){const r=Array.from(this.connectionEncrypters.keys());try{t.log.trace("selecting encrypter from %s",r);const{stream:s,protocol:i}=await rd(t,r,{...e,log:t.log,yieldBytes:!0}),o=this.connectionEncrypters.get(i);if(o==null)throw new Ya(`no crypto module found for ${i}`);return t.log("encrypting outbound connection to %a using %s",t.remoteAddr,i),{...await o.secureOutbound(s,e),protocol:i}}catch(s){throw t.log.error("encrypting outbound connection to %a failed",t.remoteAddr,s),new Ya(s.message)}}async _multiplexOutbound(t,e,r){const s=Array.from(e.keys());t.log("outbound selecting muxer %s",s);try{t.log.trace("selecting stream muxer from %s",s);const{stream:i,protocol:o}=await rd(t,s,{...r,log:t.log,yieldBytes:!0});t.log("selected %s as muxer protocol",o);const a=e.get(o);return{stream:i,muxerFactory:a}}catch(i){throw t.log.error("error multiplexing outbound connection",i),new Ka(String(i))}}async _multiplexInbound(t,e,r){const s=Array.from(e.keys());t.log("inbound handling muxers %s",s);try{const{stream:i,protocol:o}=await sd(t,s,{...r,log:t.log}),a=e.get(o);return{stream:i,muxerFactory:a}}catch(i){throw t.log.error("error multiplexing inbound connection",i),new Ka(String(i))}}getConnectionEncrypters(){return this.connectionEncrypters}getStreamMuxers(){return this.streamMuxers}}const c1="2.8.0",l1="js-libp2p";function fR(n,t){return`${n??l1}/${t??c1} browser/${globalThis.navigator.userAgent}`}var ma,Ah;class pR extends ar{constructor(e){super();_e(this,ma);p(this,"peerId");p(this,"peerStore");p(this,"contentRouting");p(this,"peerRouting");p(this,"metrics");p(this,"services");p(this,"logger");p(this,"status");p(this,"components");p(this,"log");this.status="stopped";const r=new ar,s=r.dispatchEvent.bind(r);r.dispatchEvent=h=>{const c=s(h),d=this.dispatchEvent(new CustomEvent(h.type,{detail:h.detail}));return c||d},this.peerId=e.peerId,this.logger=e.logger??tp(),this.log=this.logger.forComponent("libp2p"),this.services={};const i=e.nodeInfo?.name??l1,o=e.nodeInfo?.version??c1,a=this.components=GB({peerId:e.peerId,privateKey:e.privateKey,nodeInfo:{name:i,version:o,userAgent:e.nodeInfo?.userAgent??fR(i,o)},logger:this.logger,events:r,datastore:e.datastore??new sL,connectionGater:JB(e.connectionGater),dns:e.dns});this.peerStore=this.configureComponent("peerStore",oB(a,{addressFilter:this.components.connectionGater.filterMultiaddrForPeer,...e.peerStore})),e.metrics!=null&&(this.metrics=this.configureComponent("metrics",e.metrics(this.components))),a.events.addEventListener("peer:update",h=>{if(h.detail.previous==null){const c={id:h.detail.peer.id,multiaddrs:h.detail.peer.addresses.map(d=>d.multiaddr)};a.events.safeDispatchEvent("peer:discovery",{detail:c})}}),e.connectionProtector!=null&&this.configureComponent("connectionProtector",e.connectionProtector(a)),this.components.upgrader=new hR(this.components,{connectionEncrypters:(e.connectionEncrypters??[]).map((h,c)=>this.configureComponent(`connection-encryption-${c}`,h(this.components))),streamMuxers:(e.streamMuxers??[]).map((h,c)=>this.configureComponent(`stream-muxers-${c}`,h(this.components))),inboundUpgradeTimeout:e.connectionManager?.inboundUpgradeTimeout,inboundStreamProtocolNegotiationTimeout:e.connectionManager?.inboundStreamProtocolNegotiationTimeout??e.connectionManager?.protocolNegotiationTimeout,outboundStreamProtocolNegotiationTimeout:e.connectionManager?.outboundStreamProtocolNegotiationTimeout??e.connectionManager?.protocolNegotiationTimeout}),this.configureComponent("transportManager",new eR(this.components,e.transportManager)),this.configureComponent("connectionManager",new ON(this.components,e.connectionManager)),e.connectionMonitor?.enabled!==!1&&this.configureComponent("connectionMonitor",new KN(this.components,e.connectionMonitor)),this.configureComponent("registrar",new XN(this.components)),this.configureComponent("addressManager",new DB(this.components,e.addresses));const l=(e.peerRouters??[]).map((h,c)=>this.configureComponent(`peer-router-${c}`,h(this.components)));this.peerRouting=this.components.peerRouting=this.configureComponent("peerRouting",new QN(this.components,{routers:l}));const u=(e.contentRouters??[]).map((h,c)=>this.configureComponent(`content-router-${c}`,h(this.components)));if(this.contentRouting=this.components.contentRouting=this.configureComponent("contentRouting",new YN(this.components,{routers:u})),this.configureComponent("randomWalk",new ZN(this.components)),(e.peerDiscovery??[]).forEach((h,c)=>{this.configureComponent(`peer-discovery-${c}`,h(this.components)).addEventListener("peer",f=>{ue(this,ma,Ah).call(this,f)})}),e.transports?.forEach((h,c)=>{this.components.transportManager.add(this.configureComponent(`transport-${c}`,h(this.components)))}),e.services!=null)for(const h of Object.keys(e.services)){const c=e.services[h],d=c(this.components);if(d==null){this.log.error("service factory %s returned null or undefined instance",h);continue}this.services[h]=d,this.configureComponent(h,d),d[Dp]!=null&&(this.log("registering service %s for content routing",h),u.push(d[Dp])),d[Mp]!=null&&(this.log("registering service %s for peer routing",h),l.push(d[Mp])),d[wc]!=null&&(this.log("registering service %s for peer discovery",h),d[wc].addEventListener?.("peer",f=>{ue(this,ma,Ah).call(this,f)}))}KB(a)}configureComponent(e,r){return r==null&&this.log.error("component %s was null or undefined",e),this.components[e]=r,r}async start(){if(this.status==="stopped"){this.status="starting",this.log("libp2p is starting");try{await this.components.beforeStart?.(),await this.components.start(),await this.components.afterStart?.(),this.status="started",this.safeDispatchEvent("start",{detail:this}),this.log("libp2p has started")}catch(e){throw this.log.error("An error occurred starting libp2p",e),this.status="started",await this.stop(),e}}}async stop(){this.status==="started"&&(this.log("libp2p is stopping"),this.status="stopping",await this.components.beforeStop?.(),await this.components.stop(),await this.components.afterStop?.(),this.status="stopped",this.safeDispatchEvent("stop",{detail:this}),this.log("libp2p has stopped"))}getConnections(e){return this.components.connectionManager.getConnections(e)}getDialQueue(){return this.components.connectionManager.getDialQueue()}getPeers(){const e=new xi;for(const r of this.components.connectionManager.getConnections())e.add(r.remotePeer);return Array.from(e)}async dial(e,r={}){return this.components.connectionManager.openConnection(e,{priority:75,...r})}async dialProtocol(e,r,s={}){if(r==null)throw new X("no protocols were provided to open a stream");if(r=Array.isArray(r)?r:[r],r.length===0)throw new X("no protocols were provided to open a stream");return(await this.dial(e,s)).newStream(r,s)}getMultiaddrs(){return this.components.addressManager.getAddresses()}getProtocols(){return this.components.registrar.getProtocols()}async hangUp(e,r={}){Vl(e)&&(e=Bt(e.getPeerId()??"")),await this.components.connectionManager.closeConnections(e,r)}async getPublicKey(e,r={}){if(this.log("getPublicKey %p",e),e.publicKey!=null)return e.publicKey;try{const a=await this.peerStore.get(e);if(a.id.publicKey!=null)return a.id.publicKey}catch(a){if(a.name!=="NotFoundError")throw a}const s=bn([te("/pk/"),e.toMultihash().bytes]),i=await this.contentRouting.get(s,r),o=Lr(i);return await this.peerStore.patch(e,{publicKey:o}),o}async handle(e,r,s){Array.isArray(e)||(e=[e]),await Promise.all(e.map(async i=>{await this.components.registrar.handle(i,r,s)}))}async unhandle(e){Array.isArray(e)||(e=[e]),await Promise.all(e.map(async r=>{await this.components.registrar.unhandle(r)}))}async register(e,r){return this.components.registrar.register(e,r)}unregister(e){this.components.registrar.unregister(e)}async isDialable(e,r={}){return this.components.connectionManager.isDialable(e,r)}}ma=new WeakSet,Ah=function(e){const{detail:r}=e;if(r.id.toString()===this.peerId.toString()){this.log.error("peer discovery mechanism discovered self");return}this.components.peerStore.merge(r.id,{multiaddrs:r.multiaddrs}).catch(s=>{this.log.error(s)})};async function gR(n={}){n.privateKey??(n.privateKey=await Zb("Ed25519"));const t=new pR({...await $L(n),peerId:wk(n.privateKey)});return n.start!==!1&&await t.start(),t}function mR({data:n=[],maxSize:t=1/0,compare:e=(s,i)=>s<i?-1:s>i?1:0,extractKey:r=s=>s}={}){this.data=n;const s=new Map(n.map((a,l)=>[r(a),l]));this.indexes=s;const i=a=>{const l=n[a];for(;a>0;){const u=a-1>>1,h=n[u];if(e(l,h)>=0)break;s.set(r(h),a),n[a]=h,a=u}s.set(r(l),a),n[a]=l},o=a=>{const l=n.length>>1,u=n[a];for(;a<l;){let h=(a<<1)+1,c=n[h];const d=h+1;if(d<n.length&&e(n[d],c)<0&&(h=d,c=n[d]),e(c,u)>=0)break;s.set(r(c),a),n[a]=c,a=h}s.set(r(u),a),n[a]=u};if(n.length>0)for(let a=(n.length>>1)-1;a>=0;a--)o(a);this.push=a=>{let l=s.get(r(a));if(l===void 0)return n.push(a),i(n.length-1),n.length<=t?void 0:this.pop();e(n[l],a)>=0||(n[l]=a,o(l))},this.pop=()=>{if(n.length===0)return;const a=n[0],l=n.pop();return n.length>0&&(s.set(r(l),0),n[0]=l,o(0)),s.delete(r(a)),a},this.peek=()=>n[0]}function u1(n){return n.toLowerCase().replace(/[^a-z0-9@&$!?\-+=.:/_]/g,"")}async function d1(n={}){const{type:t,moves:e,playerName:r,timestamp:s,value:i}=n;if(!t||!e||!r||!s||!i)throw new Error(["RECORD VALIDATION: BAD GAME DATA!",n]);if(u1(r)!==r)throw new Error(["RECORD VALIDATION: BAD PLAYER NAME!",n]);return new Promise((o,a)=>{const l=setTimeout(()=>a(["RECORD VALIDATION: TIMEOUT!",n]),3e3),u=Ov({cards:mt(Fe.cards),energy:mt(Fe.energy),log:mt(Fe.log),matchedIndexes:mt(Fe.matchedIndexes),moves:To(e),options:To({playerName:r,cluster:!1,rapid:!0}),phase:mt(Fe.phase),plusIndex:mt(Fe.plusIndex),records:mt({...Fe.records}),score:mt(Fe.score),seed:To(zh(n)),timestamp:To(s)});u.records.subscribe(h=>{const{movesInitial:c,phase:d}=u;if(c!==null&&Ne(d)!==re.gameOver)return;clearTimeout(l);const f=h[t][U.value];n={type:t,moves:e,playerName:r,timestamp:s,value:i},f>=i?(n.value=f,o(n)):a(["RECORD VALIDATION: WRONG VALUE!",n,f])})})}const eo={root:"/digifall/root/1.0",preview:"/digifall/preview/1.0"},sp="12D3KooWP8LPHKp89km1GrGZemAshNGmEUc8KMndHhhAVBMSSKDf",h1="/dns4/relay.digifall.app/tcp/443/wss/p2p/"+sp;let Lt;const f1=new Set,yR=HE(U.digifall,U.leaderboard),tu=Gs.reduce((n,t)=>(n[t]=yR(t,Fe[U.leaderboard][t]),n),{});function ip(n,t){return n.value>t.value?1:n.value<t.value?-1:n.timestamp===t.timestamp?0:n.timestamp<t.timestamp?1:-1}function vR({playerName:n}){return n}const yn=Gs.reduce((n,t)=>(n[t]=new mR({maxSize:lt,compare:ip,extractKey:vR}),n),{}),Ps=Gs.reduce((n,t)=>(n[t]=0,n),{});function op(n){return JSON.parse(de(n.subarray()))}function nu(n){return te(JSON.stringify(n))}async function p1(n){for await(const t of n){const e=op(t),{type:r,playerName:s,value:i}=e,{data:o,indexes:a}=yn[r],l=a.get(s);l in o&&o[l].value>=i||d1(e).then(u=>{yn[r].push(u),tu[r].set(yn[r].data),console.warn("P2P LEADERBOARD UPDATED!",r,s,i)}).catch(u=>vn&&console.error(...u))}}async function bR({stream:n}){vn&&console.log("handlePreview"),Br(n.source,async function*(t){const e=new Set,r=Gs.reduce((i,o)=>(i[o]=new Set,i),{});for await(const i of t){const{type:o,playerName:a,value:l}=op(i);o in Ps&&e.add(o);const u=yn[o].indexes.get(a);u!==void 0&&(yn[o].data[u].value>l||r[o].add(a))}const s=Array.from(e).flatMap(i=>yn[i].data.filter(o=>!r[i].has(o.playerName)).map(nu));for(const i of s)yield i},n.sink).catch(t=>vn&&console.error(t))}async function wR(n,t){vn&&console.log(eo.preview);const e=t.flatMap(r=>yn[r].data.map(({playerName:s,value:i})=>nu({type:r,playerName:s,value:i})));return n.newStream(eo.preview,{runOnLimitedConnection:!0}).then(r=>Br(e,r,p1)).catch(r=>vn&&console.error(r))}async function _R({connection:n,stream:t}){vn&&console.log("handleRoot"),Br(t.source,async function*(e){const r=new Set;for await(const s of e){const[i,o]=op(s);if(o===0){for(const a of yn[i].data)yield nu(a);continue}i in Ps&&o!==Ps[i]&&r.add(i)}r.size===0||n.status!=="open"||wR(n,Array.from(r))},t.sink).catch(e=>vn&&console.error(e))}async function g1(n){vn&&console.log(eo.root);const t=Object.entries(Ps).map(nu);return n.newStream(eo.root,{runOnLimitedConnection:!0}).then(e=>Br(t,e,p1)).catch(e=>{vn&&console.error(e),e.name==="UnsupportedProtocolError"&&f1.add(n.remotePeer.toString()),n.close()})}async function SR({detail:n}){const t=n.remotePeer.toString();vn&&console.log("connection:open",t),t!==sp&&n.status==="open"&&await g1(n)}async function ER({detail:{from:n}}){vn&&console.log("pubsub:message",n.toString(),n===Lt.peerId?"local":"remote"),Lt.dial(n).catch(()=>{})}async function AR(){return Lt.getConnections().length!==0?!1:(vn&&console.log("restoreRelay"),Lt.dial(me(h1)))}(async function(){const t=new vL("keystore");await t.open();const e=await tM(t);Lt=await gR({privateKey:e,addresses:{listen:["/p2p-circuit"]},transports:[jM(),sD({discoverRelays:1})],connectionEncrypters:[PM()],streamMuxers:[VC()],peerDiscovery:[rP({list:[h1]}),LM({interval:13e3,topics:["digifall._peer-discovery"],listenOnly:!1})],connectionGater:{denyDialPeer(r){return f1.has(r.toString())?!0:Lt.getConnections().length>=3},denyInboundConnection(){return Lt.getConnections().length>=5}},services:{identify:kM({protocolPrefix:"digifall"}),pubsub:SC({emitSelf:!0}),keychain:A_()}}),setInterval(()=>AR().catch(()=>{}),73e3),Lt.services.pubsub.addEventListener("message",ER),Lt.addEventListener("connection:open",SR),Lt.handle(eo.root,_R,{runOnLimitedConnection:!0}),Lt.handle(eo.preview,bR,{runOnLimitedConnection:!0}),vn&&(window.libp2p=Lt)})();async function xR(){Lt.getConnections().filter(({remotePeer:n,status:t})=>t==="open"&&n.toString()!==sp).forEach(g1)}Gs.forEach(n=>{const t=tu[n];t.subscribe(async e=>{if(!(!e||e.length===0)){if(yn[n].data.length>0){const r=Ps[n];return Ps[n]=bd(e.slice().sort(ip).map(s=>bd([zh(s),s.value]))),r!==Ps[n]&&Lt&&xR()}Promise.allSettled(e.map(r=>d1(r).then(s=>yn[n].push(s)))).then(()=>t.set(yn[n].data))}})});ba.subscribe(n=>{const t=Ne(Fr);t!==re.idle&&t!==re.gameOver||Gs.forEach(e=>{const r=n[e];r[U.value]!==0&&(r[U.type]=e,yn[e].push(r),tu[e].set(yn[e].data))})});Ft.subscribe(({leaderboard:n})=>{setTimeout(()=>n?Lt.start():Lt.stop(),3e3)});var IR=ce('<div class="virtual-item svelte-16kyil9"><!></div>'),kR=ce('<div class="virtual-scroll svelte-16kyil9"><div class="virtual-list"></div></div>');function m1(n,t){if(new.target)return $t({component:m1,...n});kt(t,!1);const e=Y(),r=Y(),s=Y(),i=Y(),o=Y();let a=At(t,"items",12),l=At(t,"startIndex",12),u=At(t,"endIndex",12),h=Y(0),c=Y(0),d=Y(1),f=Y();const g=18;function y(w){B(h,w.target.scrollTop)}function m(w,S=!0,E=!1){w<0||w>=a().length||b(f)&&(b(f).scrollTo({top:w*b(d),behavior:E?"smooth":"instant"}),!(!S||E)&&setTimeout(()=>{b(f).scrollTo({top:w*b(d),behavior:"instant"})},60))}ae(()=>(b(h),b(d)),()=>{l(Math.floor(b(h)/b(d)))}),ae(()=>(kn(l()),b(c),b(d)),()=>{u(l()+Math.ceil(b(c)/b(d)))}),ae(()=>kn(l()),()=>{B(e,Math.max(0,l()-g))}),ae(()=>(kn(u()),kn(a())),()=>{B(r,Math.min(u()+g,a().length))}),ae(()=>(kn(a()),b(e),b(r)),()=>{B(s,a().slice(b(e),b(r)))}),ae(()=>(b(e),b(d)),()=>{B(i,b(e)*b(d))}),ae(()=>(kn(a()),b(d)),()=>{B(o,a().length*b(d))}),dr(),Ut();var v=kR(),_=W(v);return Is(_,5,()=>b(s),Oi,(w,S)=>{var E=IR(),A=W(E);Ev(A,t,"default",{get item(){return b(S)}}),q(E),Ep(E,"clientHeight",I=>B(d,I)),oe(w,E)}),q(_),q(v),ht(v,w=>B(f,w),()=>b(f)),Ze(()=>{gn(_,"height",`${b(o)??""}px`),gn(_,"padding-top",`${b(i)??""}px`)}),Ep(v,"clientHeight",w=>B(c,w)),Me("scroll",v,y),oe(n,v),Ee(t,"scrollToIndex",m),Tt({scrollToIndex:m,get items(){return a()},set items(w){a(w),yt()},get startIndex(){return l()},set startIndex(w){l(w),yt()},get endIndex(){return u()},set endIndex(w){u(w),yt()},$set:Ht,$on:(w,S)=>Vt(t,w,S)})}var TR=ce("<li> </li>"),CR=ce('<div><div class="place svelte-rxykyg"> </div> <div> </div> <div></div> <div> </div></div>'),PR=ce('<div class="leaderboard content svelte-rxykyg"><div class="section-1"><div class="types svelte-rxykyg" title="[switch leaderboard]" tabindex="0" role="button"><span>combos</span> <span class="high svelte-rxykyg">high</span> <span>scores</span></div></div> <div class="section-2"><ul class="pages svelte-rxykyg" title="[select page]" tabindex="0" role="button"></ul></div> <div class="section-3 board svelte-rxykyg" tabindex="-1"><!></div> <div class="section-4"><div class="col"><button title="[open menu]">menu</button></div></div></div>');function y1(n,t){if(new.target)return $t({component:y1,...n});kt(t,!1);const[e,r]=wn(),s=()=>ge(Ft,"$options",e),i=()=>ge(b(o),"$leaderboardStore",e),o=Y(),a=Y(),l=Y(),u=Y(),h=100,c=Math.ceil(lt/h)+1;let d=Y(0),f=Y(U.highScore),g=Y(),y=Y(),m=Y(null);function v(M){B(f,b(f)===U.highScore?U.highCombo:U.highScore)}function _(M){if(M)return B(d,b(d)<1?c-1:b(d)-1),b(m).scrollToIndex(Math.max(b(d)*h-1,0),!1),b(d);b(m).scrollToIndex(Math.max(b(g)-8,0),!1,!0)}function w(M){if(M)return B(d,b(d)<c-1?b(d)+1:0),b(m).scrollToIndex(Math.max(b(d)*h-1,0),!1),b(d);b(m).scrollToIndex(Math.min(b(g)+8,lt-1),!1,!0)}function S(M){const ie=M.composedPath().find(({dataset:he})=>he&&he.index);if(ie===void 0)return;B(d,Number(ie.dataset.index));const we=b(d)===0?0:b(d)===10?lt-1:ie.dataset.index*100-1;b(m).scrollToIndex(we)}function E(){xt(_t,ye.menu)}function A(M){return M>=lt-2?B(d,10):B(d,I(M))}function I(M){return M>0&&M<lt*.1?0:M>=100&&M<lt*.2?1:M>=200&&M<lt*.3?2:M>=300&&M<lt*.4?3:M>=400&&M<lt*.5?4:M>=500&&M<lt*.6?5:M>=600&&M<lt*.7?6:M>=700&&M<lt*.8?7:M>=800&&M<lt*.9?8:M>=900&&M<lt?9:0}function T(M){return M===0&&b(u)===-1?"???":Array.from({length:3-M.toString().length}).map(()=>"0").join("")+M}function x(M,ie){return ie===0&&b(u)===-1?s()[U.playerName]:M}async function V(M){await dv(),b(m).scrollToIndex(b(u)===-1?lt-1:Math.max(b(u)-7,0))}ae(()=>b(f),()=>{rE(B(o,tu[b(f)]),"$leaderboardStore",e)}),ae(()=>(i(),lt),()=>{B(a,i().slice().sort((M,ie)=>ip(ie,M)).slice(0,lt))}),ae(()=>(b(a),lt),()=>{B(l,[...b(a).map((M,ie)=>({place:ie===999?0:ie+1,...M})),...Array.from({length:lt-b(a).length}).map((M,ie,we)=>({place:ie===we.length-1?0:ie+b(a).length+1,playerName:"",value:0}))])}),ae(()=>(b(a),s(),U),()=>{B(u,b(a).findIndex(({playerName:M})=>M===s()[U.playerName]))}),ae(()=>b(y),()=>{A(b(y))}),ae(()=>b(a),()=>{V(b(a))}),dr(),Ut();var L=PR(),N=W(L),H=W(N),D=W(H);let R;var P=J(D,4);let k;q(H),q(N);var C=J(N,2),O=W(C);Is(O,5,()=>Array.from({length:c}),Oi,(M,ie,we)=>{var he=TR();const ve=Nt(()=>we>9?0:we);let je;Ot(he,"data-index",we);var Q=W(he,!0);q(he),Ze(()=>{je=nt(he,1,"page svelte-rxykyg",null,je,{active:we===b(d)}),gn(he,"--color",`var(--color-${b(ve)??""})`),st(Q,b(ve))}),oe(M,he)}),q(O),q(C);var F=J(C,2),z=W(F);ht(m1(z,{get items(){return b(l)},get startIndex(){return b(g)},set startIndex(M){B(g,M)},get endIndex(){return b(y)},set endIndex(M){B(y,M)},children:uS,$$slots:{default:(M,ie)=>{const we=Nt(()=>ie.item);var he=CR();const ve=Nt(()=>{const{place:ti,playerName:ni,value:ri}=b(we);return{place:ti,playerName:ni,value:ri}}),je=Nt(()=>b(ve).playerName===s()[U.playerName]),Q=Nt(()=>"place: "+b(ve).place+`
name: `+b(ve).playerName.toUpperCase()+`
score: `+b(ve).value);var ne=W(he),Re=W(ne,!0);q(ne);var Pt=J(ne,2);let js;var go=W(Pt,!0);q(Pt);var Js=J(Pt,2);let Pa;var ei=J(Js,2);let mo;var yo=W(ei,!0);q(ei),q(he),Ze((ti,ni,ri)=>{nt(he,1,zS(["grid",{first:b(ve).place===1,second:b(ve).place===2,third:b(ve).place===3}]),"svelte-rxykyg"),Ot(he,"title",b(Q)),gn(ne,"color",`var(--color-${ti??""})`),st(Re,ni),js=nt(Pt,1,"player-name svelte-rxykyg",null,js,{self:b(je)}),st(go,ri),Pa=nt(Js,1,"bar svelte-rxykyg",null,Pa,{self:b(je)}),mo=nt(ei,1,"record svelte-rxykyg",null,mo,{self:b(je)}),st(yo,b(ve).value)},[()=>I(b(ve).place),()=>T(b(ve).place),()=>x(b(ve).playerName,b(ve).place)],Nt),oe(M,he)}},$$legacy:!0}),M=>B(m,M),()=>b(m)),q(F);var G=J(F,2),ee=W(G),K=W(ee);q(ee),q(G),q(L),Ze(()=>{R=nt(D,1,"type svelte-rxykyg",null,R,{active:b(f)===U.highCombo}),k=nt(P,1,"type svelte-rxykyg",null,k,{active:b(f)===U.highScore})}),Ke(5,H,()=>tr,()=>({y:-48})),Me("click",H,v),Me("click",O,S),Me("click",K,E),Ke(1,K,()=>tr,()=>({y:48})),Ke(1,L,()=>Tr),oe(n,L),Ee(t,"prevPage",_),Ee(t,"nextPage",w);var le=Tt({prevPage:_,nextPage:w,$set:Ht,$on:(M,ie)=>Vt(t,M,ie)});return r(),le}var DR=ce('<span class="title"> </span>'),MR=ce('<div class="dialog content"><div class="section-1"><!></div> <div class="section-2"></div> <div class="section-3"><!></div> <div class="section-4"></div></div>');function ru(n,t){if(new.target)return $t({component:ru,...n});kt(t,!1);const e=tE();let r=At(t,"title",12,""),s=At(t,"opened",12,!1);function i(){return s()}function o(){s(!1),e("close")}function a(){s(!0),e("show")}Ut();var l=bl(),u=sn(l);{var h=c=>{var d=MR(),f=W(d),g=W(f);{var y=_=>{var w=DR(),S=W(w,!0);q(w),Ze(()=>st(S,r())),Ke(1,w,()=>tr,()=>({y:-48})),oe(_,w)};Ue(g,_=>{r()&&_(y)})}q(f);var m=J(f,4),v=W(m);Ev(v,t,"default",{}),q(m),hc(2),q(d),Ke(1,m,()=>tr,()=>({y:24})),Ke(1,d,()=>Tr),oe(c,d)};Ue(u,c=>{s()&&c(h)})}return oe(n,l),Ee(t,"isOpened",i),Ee(t,"close",o),Ee(t,"show",a),Tt({isOpened:i,close:o,show:a,get title(){return r()},set title(c){r(c),yt()},get opened(){return s()},set opened(c){s(c),yt()},$set:Ht,$on:(c,d)=>Vt(t,c,d)})}const LR="0.10.0";var BR=ce('<span class="rapid">rapid</span>'),NR=ce("<button>new game</button>"),RR=ce("<button>resume</button> <button>new game</button>",1),OR=ce("<button>p2p leaderboard</button>"),FR=ce('<div class="menu content"><div class="section-1"><h1>digifall <!></h1></div> <div class="section-2"></div> <div class="section-3"><div class="col"><!> <!> <button>options</button></div></div> <div class="section-4"></div></div> <span class="version"></span> <a href="https://github.com/shlavik/digifall" class="github-corner" aria-label="View source on GitHub"><svg viewBox="0 0 250 250" aria-hidden="true"><path d="M0,0 L115,115 L130,115 L142,142 L250,250 L250,0 Z"></path><path class="octo-arm" d="M128.3,109.0 C113.8,99.7 119.0,89.6 119.0,89.6 C122.0,82.7 120.5,78.6 120.5,78.6 C119.2,72.0 123.4,76.3 123.4,76.3 C127.3,80.9 125.5,87.3 125.5,87.3 C122.9,97.6 130.6,101.9 134.4,103.2" fill="currentColor"></path><path class="octo-body" d="M115.0,115.0 C114.9,115.1 118.7,116.5 119.8,115.4 L133.7,101.6 C136.9,99.2 139.9,98.4 142.2,98.6 C133.8,88.0 127.5,74.4 143.8,58.0 C148.5,53.4 154.0,51.2 159.7,51.0 C160.3,49.4 163.2,43.6 171.4,40.1 C171.4,40.1 176.1,42.5 178.8,56.2 C183.1,58.6 187.2,61.8 190.9,65.4 C194.5,69.0 197.7,73.2 200.1,77.6 C213.8,80.2 216.3,84.9 216.3,84.9 C212.7,93.1 206.9,96.0 205.4,96.6 C205.1,102.4 203.0,107.8 198.3,112.5 C181.9,128.9 168.3,122.5 157.7,114.1 C157.9,116.9 156.7,120.9 152.7,124.9 L141.0,136.5 C139.8,137.7 141.6,141.9 141.8,141.8 Z" fill="currentColor"></path></svg></a>',1),$R=ce('<div class="col"><p>start a new game?</p> <div class="row"><button>yes</button> <button>no</button></div></div>'),UR=ce("<!> <!>",1);function v1(n,t){if(new.target)return $t({component:v1,...n});kt(t,!1);const[e,r]=wn(),s=()=>ge(Ft,"$options",e),i=()=>ge(Fr,"$phase",e);let o=Y(null),a=Y(!1);JS(()=>{s().playerName===""&&xt(_t,ye.wellcome)});function l(){return b(o).isOpened()}function u(){b(o).close()}function h(){xt(_t,null)}function c(){b(o).close(),Gh()}function d(){xt(_t,ye.leaderboard)}function f(){xt(_t,ye.options)}Ut();var g=UR(),y=sn(g);{var m=w=>{var S=FR(),E=sn(S),A=W(E),I=W(A),T=J(W(I));{var x=F=>{var z=BR();oe(F,z)};Ue(T,F=>{s().rapid&&F(x)})}q(I),q(A);var V=J(A,4),L=W(V),N=W(L);{var H=F=>{var z=NR();Me("click",z,c),oe(F,z)},D=F=>{var z=RR(),G=sn(z),ee=J(G,2);Me("click",G,h),Me("click",ee,function(...K){b(o).show?.apply(this,K)}),oe(F,z)};Ue(N,F=>{i()===re.gameOver?F(H):F(D,!1)})}var R=J(N,2);{var P=F=>{var z=OR();Me("click",z,d),oe(F,z)};Ue(R,F=>{s()[U.leaderboard]&&F(P)})}var k=J(R,2);q(L),q(V),hc(2),q(E);var C=J(E,2);C.textContent=LR;var O=J(C,2);Me("click",k,f),Ke(5,E,()=>Tr),Ke(5,C,()=>Tr),Ke(5,O,()=>Tr),oe(w,S)};Ue(y,w=>{b(a)||w(m)})}var v=J(y,2);ht(ru(v,{get opened(){return b(a)},set opened(w){B(a,w)},children:(w,S)=>{var E=$R(),A=J(W(E),2),I=W(A),T=J(I,2);q(A),q(E),Me("click",I,c),Me("click",T,function(...x){b(o).close?.apply(this,x)}),oe(w,E)},$$slots:{default:!0},$$legacy:!0}),w=>B(o,w),()=>b(o)),oe(n,g),Ee(t,"isNewGameDialog",l),Ee(t,"closeNewGameDialog",u);var _=Tt({isNewGameDialog:l,closeNewGameDialog:u,$set:Ht,$on:(w,S)=>Vt(t,w,S)});return r(),_}var VR=ce('<span class="symbols">a-z 0-9 @&$!?-+=.:/_</span> <input class="player-name" type="text" inputmode="url" placeholder="player name" spellcheck="false" maxlength="42">',1);function ap(n,t){if(new.target)return $t({component:ap,...n});kt(t,!1);const[e,r]=wn(),s=()=>ge(Ft,"$options",e),i=Y();let o=At(t,"playerName",28,()=>s().playerName),a=Y(null),l=Y("hidden");function u(g=400){B(l,"hidden"),b(a)&&(b(a).classList.toggle("blink"),setTimeout(()=>b(a).classList.toggle("blink"),g))}ae(()=>(kn(o()),b(a)),()=>{let g=o();o(u1(o())),B(l,g!==o()?"visible":"hidden"),o()===""&&b(a)&&b(a).focus()}),ae(()=>kn(o()),()=>{B(i,"player name: "+o().toUpperCase())}),dr(),Ut();var h=VR(),c=sn(h),d=J(c,2);Xa(d),ht(d,g=>B(a,g),()=>b(a)),Ze(()=>{gn(c,"visibility",b(l)),Ot(d,"title",b(i))}),XS(d,o),oe(n,h),Ee(t,"blink",u);var f=Tt({blink:u,get playerName(){return o()},set playerName(g){o(g),yt()},$set:Ht,$on:(g,y)=>Vt(t,g,y)});return r(),f}var HR=ce('<form class="options content"><div class="section-1"><span>options</span></div> <div class="section-2"></div> <div class="section-3"><div class="col"><!> <input type="checkbox" id="leaderboard"> <label for="leaderboard" tabindex="0" role="button">p2p leaderboard</label> <input type="checkbox" id="rapid"> <label for="rapid" tabindex="0" role="button">rapid mode</label> <input type="checkbox" id="sound"> <label for="sound" tabindex="0" role="button">sound effects</label></div></div> <div class="section-4"><div class="col"><button type="submit" title="[open menu]">menu</button></div></div></form>'),zR=ce('<div class="col exclam-fix"><p>new name detected!</p> <p>progress will be lost!</p> <div class="row"><button>accept</button> <button>reject</button></div></div>'),qR=ce("<!> <!>",1);function b1(n,t){if(new.target)return $t({component:b1,...n});kt(t,!1);const[e,r]=wn(),s=()=>ge(Ft,"$options",e);let i=Y(null),o=Y(!1),a=Y(null),l=Y(s().playerName);function u(){return b(o)}function h(){b(i).close(),xt(ba,Fe.records),Gh(b(l))}function c(){b(i).close(),B(l,s().playerName)}function d(){if(b(l)==="")return b(a).blink();if(b(l)===s().playerName)return xt(_t,ye.menu);b(i).show()}Ut();var f=qR(),g=sn(f);{var y=_=>{var w=HR(),S=W(w),E=W(S);q(S);var A=J(S,4),I=W(A),T=W(I);ht(ap(T,{get playerName(){return b(l)},set playerName(C){B(l,C)},$$legacy:!0}),C=>B(a,C),()=>b(a));var x=J(T,2);Xa(x);var V=J(x,2),L=J(V,2);Xa(L);var N=J(L,2),H=J(N,2);Xa(H);var D=J(H,2);q(I),q(A);var R=J(A,2),P=W(R),k=W(P);q(P),q(R),q(w),Ze(()=>{Ot(V,"title",`sharing records ${(s().leaderboard?"enabled":"disabled")??""}`),Ot(N,"title",`boring animations ${(s().rapid?"disabled":"enabled")??""}`),WS(H,s().sound),Ot(D,"title",`making sounds ${(s().sound?"enabled":"disabled")??""}`)}),Ke(5,E,()=>tr,()=>({y:-48})),Sp(x,()=>s().leaderboard,C=>ja(Ft,it(s).leaderboard=C,it(s))),Sp(L,()=>s().rapid,C=>ja(Ft,it(s).rapid=C,it(s))),Me("click",H,()=>ja(Ft,it(s).sound=!s().sound,it(s))),Ke(5,A,()=>tr,()=>({y:24})),Ke(5,k,()=>tr,()=>({y:48})),Ke(5,w,()=>Tr),Me("submit",w,Uh(d)),oe(_,w)};Ue(g,_=>{b(o)||_(y)})}var m=J(g,2);ht(ru(m,{get title(){return b(l)},get opened(){return b(o)},set opened(_){B(o,_)},children:(_,w)=>{var S=zR(),E=J(W(S),4),A=W(E),I=J(A,2);q(E),q(S),Me("click",A,h),Me("click",I,c),oe(_,S)},$$slots:{default:!0},$$legacy:!0}),_=>B(i,_),()=>b(i)),oe(n,f),Ee(t,"isDialogOpened",u);var v=Tt({isDialogOpened:u,$set:Ht,$on:(_,w)=>Vt(t,_,w)});return r(),v}var WR=ce('<form class="wellcome content"><div class="section-1"><h1>digifall</h1></div> <div class="section-2"></div> <div class="section-3"><div class="col"><!> <button type="submit">start</button></div></div> <div class="section-4"></div></form>'),GR=ce(`<div class="col"><p>this game doesn't contain tutorial mode!</p> <p>the rules may not be obvious at first, but they're pretty simple!</p> <button>continue</button></div>`),KR=ce("<!> <!>",1);function w1(n,t){if(new.target)return $t({component:w1,...n});kt(t,!1);const[e,r]=wn(),s=()=>ge(Ft,"$options",e);let i=Y(null),o=Y(!0),a=Y(null),l=Y(s().playerName);function u(){xt(Wh,Date.now()),ja(Ft,it(s).playerName=b(l),it(s))}function h(){if(b(l)==="")return b(a).blink();xt(_t,null)}Ut();var c=KR(),d=sn(c);{var f=m=>{var v=WR(),_=J(W(v),4),w=W(_),S=W(w);ht(ap(S,{get playerName(){return b(l)},set playerName(E){B(l,E)},$$legacy:!0}),E=>B(a,E),()=>b(a)),hc(2),q(w),q(_),hc(2),q(v),Ke(5,v,()=>Tr),Me("input",v,u),Me("submit",v,Uh(h)),oe(m,v)};Ue(d,m=>{b(o)||m(f)})}var g=J(d,2);ht(ru(g,{title:"heads up!",get opened(){return b(o)},set opened(m){B(o,m)},children:(m,v)=>{var _=GR(),w=J(W(_),4);q(_),Me("click",w,function(...S){b(i).close?.apply(this,S)}),oe(m,_)},$$slots:{default:!0},$$legacy:!0}),m=>B(i,m),()=>b(i)),oe(n,c);var y=Tt({$set:Ht,$on:(m,v)=>Vt(t,m,v)});return r(),y}var YR=ce('<div class="overlay"><!></div>');function _1(n,t){if(new.target)return $t({component:_1,...n});kt(t,!1);const[e,r]=wn(),s=()=>ge(_t,"$overlay",e),i=()=>ge(Fr,"$phase",e);let o=Y(null),a=Y(null),l=Y(null),u=Y(null),h=null;async function c(){if(await dv(),b(a)&&b(a).isNewGameDialog())return b(a).closeNewGameDialog();xt(_t,s()===null?ye.menu:s()===ye.menu?null:s()===ye.leaderboard||s()===ye.options?ye.menu:null)}function d(){S(-1)}function f(){S(1)}function g(){if(s()===ye.leaderboard)return h?h.classList.contains("types")?h.click():b(o).prevPage(h.classList.contains("pages")):void 0;(s()!==ye.options||b(l).isDialogOpened())&&S(-1)}function y(){if(s()===ye.leaderboard)return h?h.classList.contains("types")?h.click():b(o).nextPage(h.classList.contains("pages")):void 0;(s()!==ye.options||b(l).isDialogOpened())&&S(-1)}function m(){h&&(b(u)&&b(u).isFocused()?b(u).nextType():h.classList.contains("focus")&&h.click())}function v(){if(h&&h.blur(),s()===ye.options||s()===ye.leaderboard||s()===ye.gameOver)return xt(_t,ye.menu);if(s()===ye.menu&&i()!==re.gameOver)return xt(_t,null)}function _({node:x,selectors:V,shift:L=0}={}){if(!V||V.length<1)return;const N=V.map(P=>".overlay "+P).join(", "),H=Array.from(document.querySelectorAll(N));if(!x)return L<0?H[H.length+L]:H[0];if(L===0)return x;const D=H.indexOf(x);if(D===-1)return L<0?H[H.length+L]:H[0];let R=D+L;return R<0&&(R=H.length+R),R>H.length-1&&(R=R-H.length),H[R]}function w(x){if(x){if(b(u)&&b(u).isFocused()&&b(u).blur(),h&&(h.classList.remove("focus"),h.blur()),x.classList.contains("score"))return b(u)&&b(u).focus();h=x,h.classList.add("focus"),h.focus()}}function S(x){const V=["button:not(.digifall)","[role='button']","input:not([type='checkbox'])","[tabindex='-1']"],L=V.map(D=>".overlay "+D+".focus").join(", "),N=document.querySelector(L),H=_({node:N,selectors:V,shift:x});w(H)}Ut();var E=bl(),A=sn(E);{var I=x=>{var V=YR(),L=W(V);{var N=D=>{Jv(D,{get scoreComponent(){return b(u)},set scoreComponent(R){B(u,R)},$$legacy:!0})},H=(D,R)=>{{var P=C=>{ht(y1(C,{$$legacy:!0}),O=>B(o,O),()=>b(o))},k=(C,O)=>{{var F=G=>{ht(v1(G,{$$legacy:!0}),ee=>B(a,ee),()=>b(a))},z=(G,ee)=>{{var K=M=>{ht(b1(M,{$$legacy:!0}),ie=>B(l,ie),()=>b(l))},le=(M,ie)=>{{var we=he=>{w1(he,{})};Ue(M,he=>{s()===ye.wellcome&&he(we)},ie)}};Ue(G,M=>{s()===ye.options?M(K):M(le,!1)},ee)}};Ue(C,G=>{s()===ye.menu?G(F):G(z,!1)},O)}};Ue(D,C=>{s()===ye.leaderboard?C(P):C(k,!1)},R)}};Ue(L,D=>{s()===ye.gameOver?D(N):D(H,!1)})}q(V),Ke(3,V,()=>Ja,()=>({duration:200})),oe(x,V)};Ue(A,x=>{s()&&x(I)})}oe(n,E),Ee(t,"switchOverlay",c),Ee(t,"moveUp",d),Ee(t,"moveDown",f),Ee(t,"moveLeft",g),Ee(t,"moveRight",y),Ee(t,"perfomAction",m),Ee(t,"blur",v);var T=Tt({switchOverlay:c,moveUp:d,moveDown:f,moveLeft:g,moveRight:y,perfomAction:m,blur:v,$set:Ht,$on:(x,V)=>Vt(t,x,V)});return r(),T}var QR=ce('<div class="app"><!> <!></div>');function S1(n,t){if(new.target)return $t({component:S1,...n});kt(t,!1);const[e,r]=wn(),s=()=>ge(Fr,"$phase",e),i=()=>ge(_t,"$overlay",e),o=()=>ge(El,"$energy",e),a=()=>ge(wa,"$seed",e);let l=Y(null),u=Y(null);Ip>0&&setTimeout(()=>location=location,Ip*1e3),onstorage=function(){document.hasFocus()||(document.location=document.location)};function h(){const{style:v,offsetHeight:_,offsetWidth:w}=document.documentElement,A=_/w<1.5?_/192:w/128,I=A%.25;v.setProperty("font-size",A-I+"px")}h(),onresize=h,document.addEventListener("visibilitychange",h);function c(v){document.documentElement.classList[v?"add":"remove"]("random-color")}function d(v){const _=i()===null?b(l):b(u);switch(v.code){case"Escape":return v.preventDefault(),_.blur();case"Tab":return v.preventDefault(),!a()||i()===ye.wellcome||i()===ye.gameOver?void 0:b(u).switchOverlay();case"ArrowUp":return _.moveUp();case"ArrowDown":return _.moveDown();case"ArrowLeft":return _.moveLeft();case"ArrowRight":return _.moveRight();case"Enter":case"Space":case"KeyF":case"KeyJ":return _.perfomAction()}}ae(()=>(s(),ye),()=>{s()===re.gameOver&&xt(_t,ye.gameOver)}),ae(()=>(o(),s(),i(),ye),()=>{c(o().value>100||s()===re.extra||s()===re.combo||i()===ye.leaderboard||i()===ye.gameOver)}),dr(),Ut();var f=QR();Me("keydown",ud,d);var g=W(f);ht(jv(g,{$$legacy:!0}),v=>B(l,v),()=>b(l));var y=J(g,2);ht(_1(y,{$$legacy:!0}),v=>B(u,v),()=>b(u)),q(f),oe(n,f);var m=Tt({$set:Ht,$on:(v,_)=>Vt(t,v,_)});return r(),m}Ov(Ms,VE);new S1({target:document.body});
