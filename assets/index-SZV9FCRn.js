var k1=Object.defineProperty;var up=n=>{throw TypeError(n)};var T1=(n,t,e)=>t in n?k1(n,t,{enumerable:!0,configurable:!0,writable:!0,value:e}):n[t]=e;var p=(n,t,e)=>T1(n,typeof t!="symbol"?t+"":t,e),ou=(n,t,e)=>t.has(n)||up("Cannot "+e);var F=(n,t,e)=>(ou(n,t,"read from private field"),e?e.call(n):t.get(n)),_e=(n,t,e)=>t.has(n)?up("Cannot add the same private member more than once"):t instanceof WeakSet?t.add(n):t.set(n,e),Me=(n,t,e,r)=>(ou(n,t,"write to private field"),r?r.call(n,e):t.set(n,e),e),de=(n,t,e)=>(ou(n,t,"access private method"),e);var vo=(n,t,e,r)=>({set _(s){Me(n,t,s,e)},get _(){return F(n,t,r)}});(function(){const t=document.createElement("link").relList;if(t&&t.supports&&t.supports("modulepreload"))return;for(const s of document.querySelectorAll('link[rel="modulepreload"]'))r(s);new MutationObserver(s=>{for(const i of s)if(i.type==="childList")for(const o of i.addedNodes)o.tagName==="LINK"&&o.rel==="modulepreload"&&r(o)}).observe(document,{childList:!0,subtree:!0});function e(s){const i={};return s.integrity&&(i.integrity=s.integrity),s.referrerPolicy&&(i.referrerPolicy=s.referrerPolicy),s.crossOrigin==="use-credentials"?i.credentials="include":s.crossOrigin==="anonymous"?i.credentials="omit":i.credentials="same-origin",i}function r(s){if(s.ep)return;s.ep=!0;const i=e(s);fetch(s.href,i)}})();const zn=2,zy=4,ul=8,dl=16,Nr=32,ya=64,dc=128,Dn=256,hc=512,$t=1024,Rr=2048,Ks=4096,kr=8192,hl=16384,qy=32768,fl=65536,C1=1<<17,P1=1<<19,Wy=1<<20,xs=Symbol("$state"),Gy=Symbol("legacy props"),D1=Symbol(""),dp=!1;var pl=Array.isArray,M1=Array.prototype.indexOf,kh=Array.from,Th=Object.defineProperty,Is=Object.getOwnPropertyDescriptor,Ky=Object.getOwnPropertyDescriptors,L1=Object.prototype,B1=Array.prototype,Ch=Object.getPrototypeOf;function N1(n){return typeof n=="function"}const sn=()=>{};function R1(n){return n()}function Ho(n){for(var t=0;t<n.length;t++)n[t]()}const O1=typeof requestIdleCallback>"u"?n=>setTimeout(n,1):requestIdleCallback;let zo=[],qo=[];function Yy(){var n=zo;zo=[],Ho(n)}function Qy(){var n=qo;qo=[],Ho(n)}function gl(n){zo.length===0&&queueMicrotask(Yy),zo.push(n)}function F1(n){qo.length===0&&O1(Qy),qo.push(n)}function hp(){zo.length>0&&Yy(),qo.length>0&&Qy()}function jy(n){return n===this.v}function Ph(n,t){return n!=n?t==t:n!==t||n!==null&&typeof n=="object"||typeof n=="function"}function $1(n,t){return n!==t}function Dh(n){return!Ph(n,this.v)}function U1(n){throw new Error("https://svelte.dev/e/effect_in_teardown")}function V1(){throw new Error("https://svelte.dev/e/effect_in_unowned_derived")}function H1(n){throw new Error("https://svelte.dev/e/effect_orphan")}function z1(){throw new Error("https://svelte.dev/e/effect_update_depth_exceeded")}function q1(){throw new Error("https://svelte.dev/e/hydration_failed")}function W1(n){throw new Error("https://svelte.dev/e/props_invalid_value")}function G1(){throw new Error("https://svelte.dev/e/state_descriptors_fixed")}function K1(){throw new Error("https://svelte.dev/e/state_prototype_fixed")}function Y1(){throw new Error("https://svelte.dev/e/state_unsafe_local_read")}function Q1(){throw new Error("https://svelte.dev/e/state_unsafe_mutation")}let to=!1,j1=!1;function Z1(){to=!0}const Mh=1,Lh=2,Zy=4,X1=8,J1=16,eS=1,tS=2,nS=4,rS=8,sS=16,iS=1,oS=2,aS=4,cS=1,lS=2,Bh="[",Nh="[!",Rh="]",Lo={},qt=Symbol();function Oh(n){console.warn("https://svelte.dev/e/hydration_mismatch")}function uS(){throw new Error("https://svelte.dev/e/invalid_default_snippet")}function Xy(n){throw new Error("https://svelte.dev/e/lifecycle_outside_component")}let We=null;function fp(n){We=n}function kt(n,t=!1,e){We={p:We,c:null,e:null,m:!1,s:n,x:null,l:null},to&&!t&&(We.l={s:null,u:null,r1:[],r2:In(!1)})}function Tt(n){const t=We;if(t!==null){n!==void 0&&(t.x=n);const o=t.e;if(o!==null){var e=Pe,r=Re;t.e=null;try{for(var s=0;s<o.length;s++){var i=o[s];ir(i.effect),sr(i.reaction),Tn(i.fn)}}finally{ir(e),sr(r)}}We=t.p,t.m=!0}return n||{}}function no(){return!to||We!==null&&We.l===null}function In(n,t){var e={f:0,v:n,reactions:null,equals:jy,rv:0,wv:0};return e}function va(n,t=!1){var r;const e=In(n);return t||(e.equals=Dh),to&&We!==null&&We.l!==null&&((r=We.l).s??(r.s=[])).push(e),e}function Q(n,t=!1){return dS(va(n,t))}function dS(n){return Re!==null&&!$n&&(Re.f&zn)!==0&&(er===null?pS([n]):er.push(n)),n}function _s(n,t){return M(n,it(()=>b(n))),t}function M(n,t){return Re!==null&&!$n&&no()&&(Re.f&(zn|dl))!==0&&(er===null||!er.includes(n))&&Q1(),ud(n,t)}function ud(n,t){return n.equals(t)||(n.v,n.v=t,n.wv=av(),Jy(n,Rr),no()&&Pe!==null&&(Pe.f&$t)!==0&&(Pe.f&(Nr|ya))===0&&(br===null?gS([n]):br.push(n))),t}function Jy(n,t){var e=n.reactions;if(e!==null)for(var r=no(),s=e.length,i=0;i<s;i++){var o=e[i],a=o.f;(a&Rr)===0&&(!r&&o===Pe||(qn(o,t),(a&($t|Dn))!==0&&((a&zn)!==0?Jy(o,Ks):vl(o))))}}function Wo(n){var t=zn|Rr,e=Re!==null&&(Re.f&zn)!==0?Re:null;return Pe===null||e!==null&&(e.f&Dn)!==0?t|=Dn:Pe.f|=Wy,{ctx:We,deps:null,effects:null,equals:jy,f:t,fn:n,reactions:null,rv:0,v:null,wv:0,parent:e??Pe}}function Nt(n){const t=Wo(n);return t.equals=Dh,t}function ev(n){var t=n.effects;if(t!==null){n.effects=null;for(var e=0;e<t.length;e+=1)ls(t[e])}}function hS(n){for(var t=n.parent;t!==null;){if((t.f&zn)===0)return t;t=t.parent}return null}function fS(n){var t,e=Pe;ir(hS(n));try{ev(n),t=lv(n)}finally{ir(e)}return t}function tv(n){var t=fS(n),e=(ns||(n.f&Dn)!==0)&&n.deps!==null?Ks:$t;qn(n,e),n.equals(t)||(n.v=t,n.wv=av())}let xe=!1;function xr(n){xe=n}let Ue;function Un(n){if(n===null)throw Oh(),Lo;return Ue=n}function ro(){return Un(Or(Ue))}function W(n){if(xe){if(Or(Ue)!==null)throw Oh(),Lo;Ue=n}}function fc(n=1){if(xe){for(var t=n,e=Ue;t--;)e=Or(e);Ue=e}}function dd(){for(var n=0,t=Ue;;){if(t.nodeType===8){var e=t.data;if(e===Rh){if(n===0)return t;n-=1}else(e===Bh||e===Nh)&&(n+=1)}var r=Or(t);t.remove(),t=r}}function hi(n,t=null,e){if(typeof n!="object"||n===null||xs in n)return n;const r=Ch(n);if(r!==L1&&r!==B1)return n;var s=new Map,i=pl(n),o=In(0);i&&s.set("length",In(n.length));var a;return new Proxy(n,{defineProperty(l,u,h){(!("value"in h)||h.configurable===!1||h.enumerable===!1||h.writable===!1)&&G1();var c=s.get(u);return c===void 0?(c=In(h.value),s.set(u,c)):M(c,hi(h.value,a)),!0},deleteProperty(l,u){var h=s.get(u);if(h===void 0)u in l&&s.set(u,In(qt));else{if(i&&typeof u=="string"){var c=s.get("length"),d=Number(u);Number.isInteger(d)&&d<c.v&&M(c,d)}M(h,qt),pp(o)}return!0},get(l,u,h){if(u===xs)return n;var c=s.get(u),d=u in l;if(c===void 0&&(!d||Is(l,u)?.writable)&&(c=In(hi(d?l[u]:qt,a)),s.set(u,c)),c!==void 0){var f=b(c);return f===qt?void 0:f}return Reflect.get(l,u,h)},getOwnPropertyDescriptor(l,u){var h=Reflect.getOwnPropertyDescriptor(l,u);if(h&&"value"in h){var c=s.get(u);c&&(h.value=b(c))}else if(h===void 0){var d=s.get(u),f=d?.v;if(d!==void 0&&f!==qt)return{enumerable:!0,configurable:!0,value:f,writable:!0}}return h},has(l,u){if(u===xs)return!0;var h=s.get(u),c=h!==void 0&&h.v!==qt||Reflect.has(l,u);if(h!==void 0||Pe!==null&&(!c||Is(l,u)?.writable)){h===void 0&&(h=In(c?hi(l[u],a):qt),s.set(u,h));var d=b(h);if(d===qt)return!1}return c},set(l,u,h,c){var d=s.get(u),f=u in l;if(i&&u==="length")for(var g=h;g<d.v;g+=1){var y=s.get(g+"");y!==void 0?M(y,qt):g in l&&(y=In(qt),s.set(g+"",y))}d===void 0?(!f||Is(l,u)?.writable)&&(d=In(void 0),M(d,hi(h,a)),s.set(u,d)):(f=d.v!==qt,M(d,hi(h,a)));var m=Reflect.getOwnPropertyDescriptor(l,u);if(m?.set&&m.set.call(c,h),!f){if(i&&typeof u=="string"){var v=s.get("length"),_=Number(u);Number.isInteger(_)&&_>=v.v&&M(v,_+1)}pp(o)}return!0},ownKeys(l){b(o);var u=Reflect.ownKeys(l).filter(d=>{var f=s.get(d);return f===void 0||f.v!==qt});for(var[h,c]of s)c.v!==qt&&!(h in l)&&u.push(h);return u},setPrototypeOf(){K1()}})}function pp(n,t=1){M(n,n.v+t)}var hd,nv,rv,sv;function fd(){if(hd===void 0){hd=window,nv=/Firefox/.test(navigator.userAgent);var n=Element.prototype,t=Node.prototype;rv=Is(t,"firstChild").get,sv=Is(t,"nextSibling").get,n.__click=void 0,n.__className=void 0,n.__attributes=null,n.__styles=null,n.__e=void 0,Text.prototype.__t=void 0}}function Ni(n=""){return document.createTextNode(n)}function Ls(n){return rv.call(n)}function Or(n){return sv.call(n)}function G(n,t){if(!xe)return Ls(n);var e=Ls(Ue);if(e===null)e=Ue.appendChild(Ni());else if(t&&e.nodeType!==3){var r=Ni();return e?.before(r),Un(r),r}return Un(e),e}function on(n,t){if(!xe){var e=Ls(n);return e instanceof Comment&&e.data===""?Or(e):e}return Ue}function J(n,t=1,e=!1){let r=xe?Ue:n;for(var s;t--;)s=r,r=Or(r);if(!xe)return r;var i=r?.nodeType;if(e&&i!==3){var o=Ni();return r===null?s?.after(o):r.before(o),Un(o),o}return Un(r),r}function iv(n){n.textContent=""}let Za=!1,pc=!1,gc=null,ks=!1,Fh=!1;function gp(n){Fh=n}let Bo=[];let Re=null,$n=!1;function sr(n){Re=n}let Pe=null;function ir(n){Pe=n}let er=null;function pS(n){er=n}let Gt=null,hn=0,br=null;function gS(n){br=n}let ov=1,mc=0,ns=!1;function av(){return++ov}function so(n){var t=n.f;if((t&Rr)!==0)return!0;if((t&Ks)!==0){var e=n.deps,r=(t&Dn)!==0;if(e!==null){var s,i,o=(t&hc)!==0,a=r&&Pe!==null&&!ns,l=e.length;if(o||a){var u=n,h=u.parent;for(s=0;s<l;s++)i=e[s],(o||!i?.reactions?.includes(u))&&(i.reactions??(i.reactions=[])).push(u);o&&(u.f^=hc),a&&h!==null&&(h.f&Dn)===0&&(u.f^=Dn)}for(s=0;s<l;s++)if(i=e[s],so(i)&&tv(i),i.wv>n.wv)return!0}(!r||Pe!==null&&!ns)&&qn(n,$t)}return!1}function mS(n,t){for(var e=t;e!==null;){if((e.f&dc)!==0)try{e.fn(n);return}catch{e.f^=dc}e=e.parent}throw Za=!1,n}function yS(n){return(n.f&hl)===0&&(n.parent===null||(n.parent.f&dc)===0)}function ml(n,t,e,r){if(Za){if(e===null&&(Za=!1),yS(t))throw n;return}e!==null&&(Za=!0);{mS(n,t);return}}function cv(n,t,e=!0){var r=n.reactions;if(r!==null)for(var s=0;s<r.length;s++){var i=r[s];(i.f&zn)!==0?cv(i,t,!1):t===i&&(e?qn(i,Rr):(i.f&$t)!==0&&qn(i,Ks),vl(i))}}function lv(n){var f;var t=Gt,e=hn,r=br,s=Re,i=ns,o=er,a=We,l=$n,u=n.f;Gt=null,hn=0,br=null,ns=(u&Dn)!==0&&($n||!ks||Re===null),Re=(u&(Nr|ya))===0?n:null,er=null,fp(n.ctx),$n=!1,mc++;try{var h=(0,n.fn)(),c=n.deps;if(Gt!==null){var d;if(yc(n,hn),c!==null&&hn>0)for(c.length=hn+Gt.length,d=0;d<Gt.length;d++)c[hn+d]=Gt[d];else n.deps=c=Gt;if(!ns)for(d=hn;d<c.length;d++)((f=c[d]).reactions??(f.reactions=[])).push(n)}else c!==null&&hn<c.length&&(yc(n,hn),c.length=hn);if(no()&&br!==null&&!$n&&c!==null&&(n.f&(zn|Ks|Rr))===0)for(d=0;d<br.length;d++)cv(br[d],n);return s!==null&&mc++,h}finally{Gt=t,hn=e,br=r,Re=s,ns=i,er=o,fp(a),$n=l}}function vS(n,t){let e=t.reactions;if(e!==null){var r=M1.call(e,n);if(r!==-1){var s=e.length-1;s===0?e=t.reactions=null:(e[r]=e[s],e.pop())}}e===null&&(t.f&zn)!==0&&(Gt===null||!Gt.includes(t))&&(qn(t,Ks),(t.f&(Dn|hc))===0&&(t.f^=hc),ev(t),yc(t,0))}function yc(n,t){var e=n.deps;if(e!==null)for(var r=t;r<e.length;r++)vS(n,e[r])}function yl(n){var t=n.f;if((t&hl)===0){qn(n,$t);var e=Pe,r=We,s=ks;Pe=n,ks=!0;try{(t&dl)!==0?kS(n):pv(n),fv(n);var i=lv(n);n.teardown=typeof i=="function"?i:null,n.wv=ov;var o=n.deps,a;dp&&j1&&n.f&Rr}catch(l){ml(l,n,e,r||n.ctx)}finally{ks=s,Pe=e}}}function bS(){try{z1()}catch(n){if(gc!==null)ml(n,gc,null);else throw n}}function uv(){var n=ks;try{var t=0;for(ks=!0;Bo.length>0;){t++>1e3&&bS();var e=Bo,r=e.length;Bo=[];for(var s=0;s<r;s++){var i=e[s];(i.f&$t)===0&&(i.f^=$t);var o=_S(i);wS(o)}}}finally{pc=!1,ks=n,gc=null}}function wS(n){var t=n.length;if(t!==0)for(var e=0;e<t;e++){var r=n[e];if((r.f&(hl|kr))===0)try{so(r)&&(yl(r),r.deps===null&&r.first===null&&r.nodes_start===null&&(r.teardown===null?gv(r):r.fn=null))}catch(s){ml(s,r,null,r.ctx)}}}function vl(n){pc||(pc=!0,queueMicrotask(uv));for(var t=gc=n;t.parent!==null;){t=t.parent;var e=t.f;if((e&(ya|Nr))!==0){if((e&$t)===0)return;t.f^=$t}}Bo.push(t)}function _S(n){for(var t=[],e=n.first;e!==null;){var r=e.f,s=(r&Nr)!==0,i=s&&(r&$t)!==0;if(!i&&(r&kr)===0){if((r&zy)!==0)t.push(e);else if(s)e.f^=$t;else{var o=Re;try{Re=e,so(e)&&yl(e)}catch(u){ml(u,e,null,e.ctx)}finally{Re=o}}var a=e.first;if(a!==null){e=a;continue}}var l=e.parent;for(e=e.next;e===null&&l!==null;)e=l.next,l=l.parent}return t}function yt(n){var t;for(hp();Bo.length>0;)pc=!0,uv(),hp();return t}async function dv(){await Promise.resolve(),yt()}function b(n){var t=n.f,e=(t&zn)!==0;if(Re!==null&&!$n){er!==null&&er.includes(n)&&Y1();var r=Re.deps;n.rv<mc&&(n.rv=mc,Gt===null&&r!==null&&r[hn]===n?hn++:Gt===null?Gt=[n]:(!ns||!Gt.includes(n))&&Gt.push(n))}else if(e&&n.deps===null&&n.effects===null){var s=n,i=s.parent;i!==null&&(i.f&Dn)===0&&(s.f^=Dn)}return e&&(s=n,so(s)&&tv(s)),n.v}function it(n){var t=$n;try{return $n=!0,n()}finally{$n=t}}const SS=-7169;function qn(n,t){n.f=n.f&SS|t}function ES(n,t){var e={};for(var r in n)t.includes(r)||(e[r]=n[r]);return e}function kn(n){if(!(typeof n!="object"||!n||n instanceof EventTarget)){if(xs in n)pd(n);else if(!Array.isArray(n))for(let t in n){const e=n[t];typeof e=="object"&&e&&xs in e&&pd(e)}}}function pd(n,t=new Set){if(typeof n=="object"&&n!==null&&!(n instanceof EventTarget)&&!t.has(n)){t.add(n),n instanceof Date&&n.getTime();for(let r in n)try{pd(n[r],t)}catch{}const e=Ch(n);if(e!==Object.prototype&&e!==Array.prototype&&e!==Map.prototype&&e!==Set.prototype&&e!==Date.prototype){const r=Ky(e);for(let s in r){const i=r[s].get;if(i)try{i.call(n)}catch{}}}}}function hv(n){Pe===null&&Re===null&&H1(),Re!==null&&(Re.f&Dn)!==0&&Pe===null&&V1(),Fh&&U1()}function AS(n,t){var e=t.last;e===null?t.last=t.first=n:(e.next=n,n.prev=e,t.last=n)}function io(n,t,e,r=!0){var s=(n&ya)!==0,i=Pe,o={ctx:We,deps:null,nodes_start:null,nodes_end:null,f:n|Rr,first:null,fn:t,last:null,next:null,parent:s?null:i,prev:null,teardown:null,transitions:null,wv:0};if(e)try{yl(o),o.f|=qy}catch(u){throw ls(o),u}else t!==null&&vl(o);var a=e&&o.deps===null&&o.first===null&&o.nodes_start===null&&o.teardown===null&&(o.f&(Wy|dc))===0;if(!a&&!s&&r&&(i!==null&&AS(o,i),Re!==null&&(Re.f&zn)!==0)){var l=Re;(l.effects??(l.effects=[])).push(o)}return o}function $h(n){const t=io(ul,null,!1);return qn(t,$t),t.teardown=n,t}function gd(n){hv();var t=Pe!==null&&(Pe.f&Nr)!==0&&We!==null&&!We.m;if(t){var e=We;(e.e??(e.e=[])).push({fn:n,effect:Pe,reaction:Re})}else{var r=Tn(n);return r}}function xS(n){return hv(),oo(n)}function IS(n){const t=io(ya,n,!0);return(e={})=>new Promise(r=>{e.outro?Go(t,()=>{ls(t),r(void 0)}):(ls(t),r(void 0))})}function Tn(n){return io(zy,n,!1)}function ae(n,t){var e=We,r={effect:null,ran:!1};e.l.r1.push(r),r.effect=oo(()=>{n(),!r.ran&&(r.ran=!0,M(e.l.r2,!0),it(t))})}function dr(){var n=We;oo(()=>{if(b(n.l.r2)){for(var t of n.l.r1){var e=t.effect;(e.f&$t)!==0&&qn(e,Ks),so(e)&&yl(e),t.ran=!1}n.l.r2.v=!1}})}function oo(n){return io(ul,n,!0)}function Ze(n,t=[],e=Wo){const r=t.map(e);return bl(()=>n(...r.map(b)))}function bl(n,t=0){return io(ul|dl|t,n,!0)}function Ri(n,t=!0){return io(ul|Nr,n,!0,t)}function fv(n){var t=n.teardown;if(t!==null){const e=Fh,r=Re;gp(!0),sr(null);try{t.call(null)}finally{gp(e),sr(r)}}}function pv(n,t=!1){var e=n.first;for(n.first=n.last=null;e!==null;){var r=e.next;ls(e,t),e=r}}function kS(n){for(var t=n.first;t!==null;){var e=t.next;(t.f&Nr)===0&&ls(t),t=e}}function ls(n,t=!0){var e=!1;if((t||(n.f&P1)!==0)&&n.nodes_start!==null){for(var r=n.nodes_start,s=n.nodes_end;r!==null;){var i=r===s?null:Or(r);r.remove(),r=i}e=!0}pv(n,t&&!e),yc(n,0),qn(n,hl);var o=n.transitions;if(o!==null)for(const l of o)l.stop();fv(n);var a=n.parent;a!==null&&a.first!==null&&gv(n),n.next=n.prev=n.teardown=n.ctx=n.deps=n.fn=n.nodes_start=n.nodes_end=null}function gv(n){var t=n.parent,e=n.prev,r=n.next;e!==null&&(e.next=r),r!==null&&(r.prev=e),t!==null&&(t.first===n&&(t.first=r),t.last===n&&(t.last=e))}function Go(n,t){var e=[];Uh(n,e,!0),mv(e,()=>{ls(n),t&&t()})}function mv(n,t){var e=n.length;if(e>0){var r=()=>--e||t();for(var s of n)s.out(r)}else t()}function Uh(n,t,e){if((n.f&kr)===0){if(n.f^=kr,n.transitions!==null)for(const o of n.transitions)(o.is_global||e)&&t.push(o);for(var r=n.first;r!==null;){var s=r.next,i=(r.f&fl)!==0||(r.f&Nr)!==0;Uh(r,t,i?e:!1),r=s}}}function vc(n){yv(n,!0)}function yv(n,t){if((n.f&kr)!==0){n.f^=kr,(n.f&$t)===0&&(n.f^=$t),so(n)&&(qn(n,Rr),vl(n));for(var e=n.first;e!==null;){var r=e.next,s=(e.f&fl)!==0||(e.f&Nr)!==0;yv(e,s?t:!1),e=r}if(n.transitions!==null)for(const i of n.transitions)(i.is_global||t)&&i.in()}}let mp=!1;function vv(){mp||(mp=!0,document.addEventListener("reset",n=>{Promise.resolve().then(()=>{if(!n.defaultPrevented)for(const t of n.target.elements)t.__on_r?.()})},{capture:!0}))}function Vh(n){var t=Re,e=Pe;sr(null),ir(null);try{return n()}finally{sr(t),ir(e)}}function bv(n,t,e,r=e){n.addEventListener(t,()=>Vh(e));const s=n.__on_r;s?n.__on_r=()=>{s(),r(!0)}:n.__on_r=()=>r(!0),vv()}const TS=new Set,yp=new Set;function CS(n,t,e,r={}){function s(i){if(r.capture||ko.call(t,i),!i.cancelBubble)return Vh(()=>e?.call(this,i))}return n.startsWith("pointer")||n.startsWith("touch")||n==="wheel"?gl(()=>{t.addEventListener(n,s,r)}):t.addEventListener(n,s,r),s}function Be(n,t,e,r,s){var i={capture:r,passive:s},o=CS(n,t,e,i);(t===document.body||t===window||t===document)&&$h(()=>{t.removeEventListener(n,o,i)})}function ko(n){var t=this,e=t.ownerDocument,r=n.type,s=n.composedPath?.()||[],i=s[0]||n.target,o=0,a=n.__root;if(a){var l=s.indexOf(a);if(l!==-1&&(t===document||t===window)){n.__root=t;return}var u=s.indexOf(t);if(u===-1)return;l<=u&&(o=l)}if(i=s[o]||n.target,i!==t){Th(n,"currentTarget",{configurable:!0,get(){return i||e}});var h=Re,c=Pe;sr(null),ir(null);try{for(var d,f=[];i!==null;){var g=i.assignedSlot||i.parentNode||i.host||null;try{var y=i["__"+r];if(y!==void 0&&(!i.disabled||n.target===i))if(pl(y)){var[m,...v]=y;m.apply(i,[n,...v])}else y.call(i,n)}catch(_){d?f.push(_):d=_}if(n.cancelBubble||g===t||g===null)break;i=g}if(d){for(let _ of f)queueMicrotask(()=>{throw _});throw d}}finally{n.__root=t,delete n.currentTarget,sr(h),ir(c)}}}function PS(n){var t=document.createElement("template");return t.innerHTML=n,t.content}function Si(n,t){var e=Pe;e.nodes_start===null&&(e.nodes_start=n,e.nodes_end=t)}function ce(n,t){var e=(t&cS)!==0,r=(t&lS)!==0,s,i=!n.startsWith("<!>");return()=>{if(xe)return Si(Ue,null),Ue;s===void 0&&(s=PS(i?n:"<!>"+n),e||(s=Ls(s)));var o=r||nv?document.importNode(s,!0):s.cloneNode(!0);if(e){var a=Ls(o),l=o.lastChild;Si(a,l)}else Si(o,o);return o}}function wl(){if(xe)return Si(Ue,null),Ue;var n=document.createDocumentFragment(),t=document.createComment(""),e=Ni();return n.append(t,e),Si(t,e),n}function oe(n,t){if(xe){Pe.nodes_end=Ue,ro();return}n!==null&&n.before(t)}const DS=["touchstart","touchmove"];function MS(n){return DS.includes(n)}let md=!0;function st(n,t){var e=t==null?"":typeof t=="object"?t+"":t;e!==(n.__t??(n.__t=n.nodeValue))&&(n.__t=e,n.nodeValue=e+"")}function wv(n,t){return _v(n,t)}function LS(n,t){fd(),t.intro=t.intro??!1;const e=t.target,r=xe,s=Ue;try{for(var i=Ls(e);i&&(i.nodeType!==8||i.data!==Bh);)i=Or(i);if(!i)throw Lo;xr(!0),Un(i),ro();const o=_v(n,{...t,anchor:i});if(Ue===null||Ue.nodeType!==8||Ue.data!==Rh)throw Oh(),Lo;return xr(!1),o}catch(o){if(o===Lo)return t.recover===!1&&q1(),fd(),iv(e),xr(!1),wv(n,t);throw o}finally{xr(r),Un(s)}}const si=new Map;function _v(n,{target:t,anchor:e,props:r={},events:s,context:i,intro:o=!0}){fd();var a=new Set,l=c=>{for(var d=0;d<c.length;d++){var f=c[d];if(!a.has(f)){a.add(f);var g=MS(f);t.addEventListener(f,ko,{passive:g});var y=si.get(f);y===void 0?(document.addEventListener(f,ko,{passive:g}),si.set(f,1)):si.set(f,y+1)}}};l(kh(TS)),yp.add(l);var u=void 0,h=IS(()=>{var c=e??t.appendChild(Ni());return Ri(()=>{if(i){kt({});var d=We;d.c=i}s&&(r.$$events=s),xe&&Si(c,null),md=o,u=n(c,r)||{},md=!0,xe&&(Pe.nodes_end=Ue),i&&Tt()}),()=>{for(var d of a){t.removeEventListener(d,ko);var f=si.get(d);--f===0?(document.removeEventListener(d,ko),si.delete(d)):si.set(d,f)}yp.delete(l),c!==e&&c.parentNode?.removeChild(c)}});return yd.set(u,h),u}let yd=new WeakMap;function BS(n,t){const e=yd.get(n);return e?(yd.delete(n),e(t)):Promise.resolve()}function Hh(n){return function(...t){var e=t[0];return e.preventDefault(),n?.apply(this,t)}}function Ut(n){return new NS(n)}var _r,Sn;class NS{constructor(t){_e(this,_r);_e(this,Sn);var e=new Map,r=(i,o)=>{var a=va(o);return e.set(i,a),a};const s=new Proxy({...t.props||{},$$events:{}},{get(i,o){return b(e.get(o)??r(o,Reflect.get(i,o)))},has(i,o){return o===Gy?!0:(b(e.get(o)??r(o,Reflect.get(i,o))),Reflect.has(i,o))},set(i,o,a){return M(e.get(o)??r(o,a),a),Reflect.set(i,o,a)}});Me(this,Sn,(t.hydrate?LS:wv)(t.component,{target:t.target,anchor:t.anchor,props:s,context:t.context,intro:t.intro??!1,recover:t.recover})),(!t?.props?.$$host||t.sync===!1)&&yt(),Me(this,_r,s.$$events);for(const i of Object.keys(F(this,Sn)))i==="$set"||i==="$destroy"||i==="$on"||Th(this,i,{get(){return F(this,Sn)[i]},set(o){F(this,Sn)[i]=o},enumerable:!0});F(this,Sn).$set=i=>{Object.assign(s,i)},F(this,Sn).$destroy=()=>{BS(F(this,Sn))}}$set(t){F(this,Sn).$set(t)}$on(t,e){F(this,_r)[t]=F(this,_r)[t]||[];const r=(...s)=>e.call(this,...s);return F(this,_r)[t].push(r),()=>{F(this,_r)[t]=F(this,_r)[t].filter(s=>s!==r)}}$destroy(){F(this,Sn).$destroy()}}_r=new WeakMap,Sn=new WeakMap;const RS="5";var Qm;typeof window<"u"&&((Qm=window.__svelte??(window.__svelte={})).v??(Qm.v=new Set)).add(RS);Z1();function Ve(n,t,[e,r]=[0,0]){xe&&e===0&&ro();var s=n,i=null,o=null,a=qt,l=e>0?fl:0,u=!1;const h=(d,f=!0)=>{u=!0,c(f,d)},c=(d,f)=>{if(a===(a=d))return;let g=!1;if(xe&&r!==-1){if(e===0){const m=s.data;m===Bh?r=0:m===Nh?r=1/0:(r=parseInt(m.substring(1)),r!==r&&(r=a?1/0:-1))}const y=r>e;!!a===y&&(s=dd(),Un(s),xr(!1),g=!0,r=-1)}a?(i?vc(i):f&&(i=Ri(()=>f(s))),o&&Go(o,()=>{o=null})):(o?vc(o):f&&(o=Ri(()=>f(s,[e+1,r]))),i&&Go(i,()=>{i=null})),g&&xr(!0)};bl(()=>{u=!1,t(h),u||c(null,null)},l),xe&&(s=Ue)}function OS(n,t,e){xe&&ro();var r=n,s=qt,i,o=no()?$1:Ph;bl(()=>{o(s,s=t())&&(i&&Go(i),i=Ri(()=>e(r)))}),xe&&(r=Ue)}function Oi(n,t){return t}function FS(n,t,e,r){for(var s=[],i=t.length,o=0;o<i;o++)Uh(t[o].e,s,!0);var a=i>0&&s.length===0&&e!==null;if(a){var l=e.parentNode;iv(l),l.append(e),r.clear(),Yr(n,t[0].prev,t[i-1].next)}mv(s,()=>{for(var u=0;u<i;u++){var h=t[u];a||(r.delete(h.k),Yr(n,h.prev,h.next)),ls(h.e,!a)}})}function Ts(n,t,e,r,s,i=null){var o=n,a={flags:t,items:new Map,first:null},l=(t&Zy)!==0;if(l){var u=n;o=xe?Un(Ls(u)):u.appendChild(Ni())}xe&&ro();var h=null,c=!1,d=Nt(()=>{var f=e();return pl(f)?f:f==null?[]:kh(f)});bl(()=>{var f=b(d),g=f.length;if(c&&g===0)return;c=g===0;let y=!1;if(xe){var m=o.data===Nh;m!==(g===0)&&(o=dd(),Un(o),xr(!1),y=!0)}if(xe){for(var v=null,_,w=0;w<g;w++){if(Ue.nodeType===8&&Ue.data===Rh){o=Ue,y=!0,xr(!1);break}var S=f[w],A=r(S,w);_=Sv(Ue,a,v,null,S,A,w,s,t,e),a.items.set(A,_),v=_}g>0&&Un(dd())}xe||$S(f,a,o,s,t,r,e),i!==null&&(g===0?h?vc(h):h=Ri(()=>i(o)):h!==null&&Go(h,()=>{h=null})),y&&xr(!0),b(d)}),xe&&(o=Ue)}function $S(n,t,e,r,s,i,o){var a=(s&X1)!==0,l=(s&(Mh|Lh))!==0,u=n.length,h=t.items,c=t.first,d=c,f,g=null,y,m=[],v=[],_,w,S,A;if(a)for(A=0;A<u;A+=1)_=n[A],w=i(_,A),S=h.get(w),S!==void 0&&(S.a?.measure(),(y??(y=new Set)).add(S));for(A=0;A<u;A+=1){if(_=n[A],w=i(_,A),S=h.get(w),S===void 0){var E=d?d.e.nodes_start:e;g=Sv(E,t,g,g===null?t.first:g.next,_,w,A,r,s,o),h.set(w,g),m=[],v=[],d=g.next;continue}if(l&&US(S,_,A,s),(S.e.f&kr)!==0&&(vc(S.e),a&&(S.a?.unfix(),(y??(y=new Set)).delete(S))),S!==d){if(f!==void 0&&f.has(S)){if(m.length<v.length){var I=v[0],k;g=I.prev;var x=m[0],U=m[m.length-1];for(k=0;k<m.length;k+=1)vp(m[k],I,e);for(k=0;k<v.length;k+=1)f.delete(v[k]);Yr(t,x.prev,U.next),Yr(t,g,x),Yr(t,U,I),d=I,g=U,A-=1,m=[],v=[]}else f.delete(S),vp(S,d,e),Yr(t,S.prev,S.next),Yr(t,S,g===null?t.first:g.next),Yr(t,g,S),g=S;continue}for(m=[],v=[];d!==null&&d.k!==w;)(d.e.f&kr)===0&&(f??(f=new Set)).add(d),v.push(d),d=d.next;if(d===null)continue;S=d}m.push(S),g=S,d=S.next}if(d!==null||f!==void 0){for(var B=f===void 0?[]:kh(f);d!==null;)(d.e.f&kr)===0&&B.push(d),d=d.next;var N=B.length;if(N>0){var z=(s&Zy)!==0&&u===0?e:null;if(a){for(A=0;A<N;A+=1)B[A].a?.measure();for(A=0;A<N;A+=1)B[A].a?.fix()}FS(t,B,z,h)}}a&&gl(()=>{if(y!==void 0)for(S of y)S.a?.apply()}),Pe.first=t.first&&t.first.e,Pe.last=g&&g.e}function US(n,t,e,r){(r&Mh)!==0&&ud(n.v,t),(r&Lh)!==0?ud(n.i,e):n.i=e}function Sv(n,t,e,r,s,i,o,a,l,u){var h=(l&Mh)!==0,c=(l&J1)===0,d=h?c?va(s):In(s):s,f=(l&Lh)===0?o:In(o),g={i:f,v:d,k:i,a:null,e:null,prev:e,next:r};try{return g.e=Ri(()=>a(n,d,f,u),xe),g.e.prev=e&&e.e,g.e.next=r&&r.e,e===null?t.first=g:(e.next=g,e.e.next=g.e),r!==null&&(r.prev=g,r.e.prev=g.e),g}finally{}}function vp(n,t,e){for(var r=n.next?n.next.e.nodes_start:e,s=t?t.e.nodes_start:e,i=n.e.nodes_start;i!==r;){var o=Or(i);s.before(i),i=o}}function Yr(n,t,e){t===null?n.first=e:(t.next=e,t.e.next=e&&e.e),e!==null&&(e.prev=t,e.e.prev=t&&t.e)}function Ev(n,t,e,r,s){xe&&ro();var i=t.$$slots?.[e],o=!1;i===!0&&(i=t.children,o=!0),i===void 0||i(n,o?()=>r:r)}function VS(n,t,e){Tn(()=>{var r=it(()=>t(n,e?.())||{});if(r?.destroy)return()=>r.destroy()})}function Av(n){var t,e,r="";if(typeof n=="string"||typeof n=="number")r+=n;else if(typeof n=="object")if(Array.isArray(n)){var s=n.length;for(t=0;t<s;t++)n[t]&&(e=Av(n[t]))&&(r&&(r+=" "),r+=e)}else for(e in n)n[e]&&(r&&(r+=" "),r+=e);return r}function HS(){for(var n,t,e=0,r="",s=arguments.length;e<s;e++)(n=arguments[e])&&(t=Av(n))&&(r&&(r+=" "),r+=t);return r}function zS(n){return typeof n=="object"?HS(n):n??""}const bp=[...` 	
\r\fÂ \v\uFEFF`];function qS(n,t,e){var r=n==null?"":""+n;if(t&&(r=r?r+" "+t:t),e){for(var s in e)if(e[s])r=r?r+" "+s:s;else if(r.length)for(var i=s.length,o=0;(o=r.indexOf(s,o))>=0;){var a=o+i;(o===0||bp.includes(r[o-1]))&&(a===r.length||bp.includes(r[a]))?r=(o===0?"":r.substring(0,o))+r.substring(a+1):o=a}}return r===""?null:r}function nt(n,t,e,r,s,i){var o=n.__className;if(xe||o!==e){var a=qS(e,r,i);(!xe||a!==n.getAttribute("class"))&&(a==null?n.removeAttribute("class"):n.className=a),n.__className=e}else if(i)for(var l in i){var u=!!i[l];(s==null||u!==!!s[l])&&n.classList.toggle(l,u)}return i}function Xa(n){if(xe){var t=!1,e=()=>{if(!t){if(t=!0,n.hasAttribute("value")){var r=n.value;Ot(n,"value",null),n.value=r}if(n.hasAttribute("checked")){var s=n.checked;Ot(n,"checked",null),n.checked=s}}};n.__on_r=e,F1(e),vv()}}function WS(n,t){var e=n.__attributes??(n.__attributes={});e.checked!==(e.checked=t??void 0)&&(n.checked=t)}function Ot(n,t,e,r){var s=n.__attributes??(n.__attributes={});xe&&(s[t]=n.getAttribute(t),t==="src"||t==="srcset"||t==="href"&&n.nodeName==="LINK")||s[t]!==(s[t]=e)&&(t==="style"&&"__styles"in n&&(n.__styles={}),t==="loading"&&(n[D1]=e),e==null?n.removeAttribute(t):typeof e!="string"&&GS(n).includes(t)?n[t]=e:n.setAttribute(t,e))}var wp=new Map;function GS(n){var t=wp.get(n.nodeName);if(t)return t;wp.set(n.nodeName,t=[]);for(var e,r=n,s=Element.prototype;s!==r;){e=Ky(r);for(var i in e)e[i].set&&t.push(i);r=Ch(r)}return t}function gn(n,t,e,r){var s=n.__styles??(n.__styles={});s[t]!==e&&(s[t]=e,e==null?n.style.removeProperty(t):n.style.setProperty(t,e,""))}const KS=()=>performance.now(),Er={tick:n=>requestAnimationFrame(n),now:()=>KS(),tasks:new Set};function xv(){const n=Er.now();Er.tasks.forEach(t=>{t.c(n)||(Er.tasks.delete(t),t.f())}),Er.tasks.size!==0&&Er.tick(xv)}function YS(n){let t;return Er.tasks.size===0&&Er.tick(xv),{promise:new Promise(e=>{Er.tasks.add(t={c:n,f:e})}),abort(){Er.tasks.delete(t)}}}function Ma(n,t){Vh(()=>{n.dispatchEvent(new CustomEvent(t))})}function QS(n){if(n==="float")return"cssFloat";if(n==="offset")return"cssOffset";if(n.startsWith("--"))return n;const t=n.split("-");return t.length===1?t[0]:t[0]+t.slice(1).map(e=>e[0].toUpperCase()+e.slice(1)).join("")}function _p(n){const t={},e=n.split(";");for(const r of e){const[s,i]=r.split(":");if(!s||i===void 0)break;const o=QS(s.trim());t[o]=i.trim()}return t}const jS=n=>n;function Ye(n,t,e,r){var s=(n&iS)!==0,i=(n&oS)!==0,o=s&&i,a=(n&aS)!==0,l=o?"both":s?"in":"out",u,h=t.inert,c=t.style.overflow,d,f;function g(){var w=Re,S=Pe;sr(null),ir(null);try{return u??(u=e()(t,r?.()??{},{direction:l}))}finally{sr(w),ir(S)}}var y={is_global:a,in(){if(t.inert=h,!s){f?.abort(),f?.reset?.();return}i||d?.abort(),Ma(t,"introstart"),d=vd(t,g(),f,1,()=>{Ma(t,"introend"),d?.abort(),d=u=void 0,t.style.overflow=c})},out(w){if(!i){w?.(),u=void 0;return}t.inert=!0,Ma(t,"outrostart"),f=vd(t,g(),d,0,()=>{Ma(t,"outroend"),w?.()})},stop:()=>{d?.abort(),f?.abort()}},m=Pe;if((m.transitions??(m.transitions=[])).push(y),s&&md){var v=a;if(!v){for(var _=m.parent;_&&(_.f&fl)!==0;)for(;(_=_.parent)&&(_.f&dl)===0;);v=!_||(_.f&qy)!==0}v&&Tn(()=>{it(()=>y.in())})}}function vd(n,t,e,r,s){var i=r===1;if(N1(t)){var o,a=!1;return gl(()=>{if(!a){var m=t({direction:i?"in":"out"});o=vd(n,m,e,r,s)}}),{abort:()=>{a=!0,o?.abort()},deactivate:()=>o.deactivate(),reset:()=>o.reset(),t:()=>o.t()}}if(e?.deactivate(),!t?.duration)return s(),{abort:sn,deactivate:sn,reset:sn,t:()=>r};const{delay:l=0,css:u,tick:h,easing:c=jS}=t;var d=[];if(i&&e===void 0&&(h&&h(0,1),u)){var f=_p(u(0,1));d.push(f,f)}var g=()=>1-r,y=n.animate(d,{duration:l});return y.onfinish=()=>{var m=e?.t()??1-r;e?.abort();var v=r-m,_=t.duration*Math.abs(v),w=[];if(_>0){var S=!1;if(u)for(var A=Math.ceil(_/16.666666666666668),E=0;E<=A;E+=1){var I=m+v*c(E/A),k=_p(u(I,1-I));w.push(k),S||(S=k.overflow==="hidden")}S&&(n.style.overflow="hidden"),g=()=>{var x=y.currentTime;return m+v*c(x/_)},h&&YS(()=>{if(y.playState!=="running")return!1;var x=g();return h(x,1-x),!0})}y=n.animate(w,{duration:_,fill:"forwards"}),y.onfinish=()=>{g=()=>r,h?.(r,1-r),s()}},{abort:()=>{y&&(y.cancel(),y.effect=null,y.onfinish=sn)},deactivate:()=>{s=sn},reset:()=>{r===0&&h?.(1,0)},t:()=>g()}}function ZS(n,t,e=t){var r=no();bv(n,"input",s=>{var i=s?n.defaultValue:n.value;if(i=au(n)?cu(i):i,e(i),r&&i!==(i=t())){var o=n.selectionStart,a=n.selectionEnd;n.value=i??"",a!==null&&(n.selectionStart=o,n.selectionEnd=Math.min(a,n.value.length))}}),(xe&&n.defaultValue!==n.value||it(t)==null&&n.value)&&e(au(n)?cu(n.value):n.value),oo(()=>{var s=t();au(n)&&s===cu(n.value)||n.type==="date"&&!s&&!n.value||s!==n.value&&(n.value=s??"")})}function Sp(n,t,e=t){bv(n,"change",r=>{var s=r?n.defaultChecked:n.checked;e(s)}),(xe&&n.defaultChecked!==n.checked||it(t)==null)&&e(n.checked),oo(()=>{var r=t();n.checked=!!r})}function au(n){var t=n.type;return t==="number"||t==="range"}function cu(n){return n===""?null:+n}function Ae(n,t,e){var r=Is(n,t);r&&r.set&&(n[t]=e,$h(()=>{n[t]=null}))}var Jr,ki,ca,al,Iv;const cl=class cl{constructor(t){_e(this,al);_e(this,Jr,new WeakMap);_e(this,ki);_e(this,ca);Me(this,ca,t)}observe(t,e){var r=F(this,Jr).get(t)||new Set;return r.add(e),F(this,Jr).set(t,r),de(this,al,Iv).call(this).observe(t,F(this,ca)),()=>{var s=F(this,Jr).get(t);s.delete(e),s.size===0&&(F(this,Jr).delete(t),F(this,ki).unobserve(t))}}};Jr=new WeakMap,ki=new WeakMap,ca=new WeakMap,al=new WeakSet,Iv=function(){return F(this,ki)??Me(this,ki,new ResizeObserver(t=>{for(var e of t){cl.entries.set(e.target,e);for(var r of F(this,Jr).get(e.target)||[])r(e)}}))},p(cl,"entries",new WeakMap);let bd=cl;var XS=new bd({box:"border-box"});function Ep(n,t,e){var r=XS.observe(n,()=>e(n[t]));Tn(()=>(it(()=>e(n[t])),r))}function Ap(n,t){return n===t||n?.[xs]===t}function ht(n={},t,e,r){return Tn(()=>{var s,i;return oo(()=>{s=i,i=[],it(()=>{n!==e(...i)&&(t(n,...i),s&&Ap(e(...s),n)&&t(null,...s))})}),()=>{gl(()=>{i&&Ap(e(...i),n)&&t(null,...i)})}}),n}function Vt(n=!1){const t=We,e=t.l.u;if(!e)return;let r=()=>kn(t.s);if(n){let s=0,i={};const o=Wo(()=>{let a=!1;const l=t.s;for(const u in l)l[u]!==i[u]&&(i[u]=l[u],a=!0);return a&&s++,s});r=()=>b(o)}e.b.length&&xS(()=>{xp(t,r),Ho(e.b)}),gd(()=>{const s=it(()=>e.m.map(R1));return()=>{for(const i of s)typeof i=="function"&&i()}}),e.a.length&&gd(()=>{xp(t,r),Ho(e.a)})}function xp(n,t){if(n.l.s)for(const e of n.l.s)b(e);t()}function Ht(n,t,e){var r;n.$$events||(n.$$events={}),(r=n.$$events)[t]||(r[t]=[]),n.$$events[t].push(e)}function zt(n){for(var t in n)t in this&&(this[t]=n[t])}function JS(n){We===null&&Xy(),to&&We.l!==null?nE(We).m.push(n):gd(()=>{const t=it(n);if(typeof t=="function")return t})}function eE(n,t,{bubbles:e=!1,cancelable:r=!1}={}){return new CustomEvent(n,{detail:t,bubbles:e,cancelable:r})}function tE(){const n=We;return n===null&&Xy(),(t,e,r)=>{const s=n.s.$$events?.[t];if(s){const i=pl(s)?s.slice():[s],o=eE(t,e,r);for(const a of i)a.call(n.x,o);return!o.defaultPrevented}return!0}}function nE(n){var t=n.l;return t.u??(t.u={a:[],b:[],m:[]})}function zh(n,t,e){if(n==null)return t(void 0),e&&e(void 0),sn;const r=it(()=>n.subscribe(t,e));return r.unsubscribe?()=>r.unsubscribe():r}const ii=[];function To(n,t){return{subscribe:mt(n,t).subscribe}}function mt(n,t=sn){let e=null;const r=new Set;function s(a){if(Ph(n,a)&&(n=a,e)){const l=!ii.length;for(const u of r)u[1](),ii.push(u,n);if(l){for(let u=0;u<ii.length;u+=2)ii[u][0](ii[u+1]);ii.length=0}}}function i(a){s(a(n))}function o(a,l=sn){const u=[a,l];return r.add(u),r.size===1&&(e=t(s,i)||sn),a(n),()=>{r.delete(u),r.size===0&&e&&(e(),e=null)}}return{set:s,update:i,subscribe:o}}function kv(n,t,e){const r=!Array.isArray(n),s=r?[n]:n;if(!s.every(Boolean))throw new Error("derived() expects stores as input, got a falsy value");const i=t.length<2;return To(e,(o,a)=>{let l=!1;const u=[];let h=0,c=sn;const d=()=>{if(h)return;c();const g=t(r?u[0]:u,o,a);i?o(g):c=typeof g=="function"?g:sn},f=s.map((g,y)=>zh(g,m=>{u[y]=m,h&=~(1<<y),l&&d()},()=>{h|=1<<y}));return l=!0,d(),function(){Ho(f),c(),l=!1}})}function Oe(n){let t;return zh(n,e=>t=e)(),t}let La=!1,wd=Symbol();function ge(n,t,e){const r=e[t]??(e[t]={store:null,source:va(void 0),unsubscribe:sn});if(r.store!==n&&!(wd in e))if(r.unsubscribe(),r.store=n??null,n==null)r.source.v=void 0,r.unsubscribe=sn;else{var s=!0;r.unsubscribe=zh(n,i=>{s?r.source.v=i:M(r.source,i)}),s=!1}return n&&wd in e?Oe(n):b(r.source)}function rE(n,t,e){let r=e[t];return r&&r.store!==n&&(r.unsubscribe(),r.unsubscribe=sn),n}function xt(n,t){return n.set(t),t}function wn(){const n={};function t(){$h(()=>{for(var e in n)n[e].unsubscribe();Th(n,wd,{enumerable:!1,value:!0})})}return[n,t]}function Ja(n,t,e){return n.set(e),t}function sE(n){var t=La;try{return La=!1,[n(),La]}finally{La=t}}function At(n,t,e,r){var s=(e&eS)!==0,i=!to||(e&tS)!==0,o=(e&rS)!==0,a=(e&sS)!==0,l=!1,u;o?[u,l]=sE(()=>n[t]):u=n[t];var h=xs in n||Gy in n,c=o&&(Is(n,t)?.set??(h&&t in n&&(E=>n[t]=E)))||void 0,d=r,f=!0,g=!1,y=()=>(g=!0,f&&(f=!1,a?d=it(r):d=r),d);u===void 0&&r!==void 0&&(c&&i&&W1(),u=y(),c&&c(u));var m;if(i)m=()=>{var E=n[t];return E===void 0?y():(f=!0,g=!1,E)};else{var v=(s?Wo:Nt)(()=>n[t]);v.f|=C1,m=()=>{var E=b(v);return E!==void 0&&(d=void 0),E===void 0?d:E}}if((e&nS)===0)return m;if(c){var _=n.$$legacy;return function(E,I){return arguments.length>0?((!i||!I||_||l)&&c(I?m():E),E):m()}}var w=!1,S=va(u),A=Wo(()=>{var E=m(),I=b(S);return w?(w=!1,I):S.v=E});return s||(A.equals=Dh),function(E,I){if(arguments.length>0){const k=I?b(A):i&&o?hi(E):E;return A.equals(k)||(w=!0,M(S,k),g&&d!==void 0&&(d=k),it(()=>b(A))),E}return b(A)}}const vn=!!localStorage.getItem("debug"),Ip=Number(localStorage.getItem("reload")),lt=1e3,qe=Object.freeze({columns:6,rows:6,maxValue:9}),$=Object.freeze({digifall:"digifall",highCombo:"highCombo",highComboPrev:"highComboPrev",highScore:"highScore",highScorePrev:"highScorePrev",leaderboard:"leaderboard",local:"local",moves:"moves",options:"options",peerId:"peerId",playerName:"playerName",records:"records",score:"score",timestamp:"timestamp",type:"type",value:"value"}),ye=Object.freeze({gameOver:"gameOver",leaderboard:"leaderboard",menu:"menu",options:"options",wellcome:"wellcome"}),se=Object.freeze({blink:"blink",combo:"combo",extra:"extra",fall:"fall",gameOver:"gameOver",idle:"idle",initial:"initial",match:"match",plus:"plus",score:"score"}),Ys=Object.freeze([$.highCombo,$.highScore]),$e=Object.freeze({cards:[],energy:{buffer:0,value:100},[$.leaderboard]:{highCombo:[],highScore:[]},log:[],matchedIndexes:new Set,[$.moves]:"",[$.options]:{[$.playerName]:"",[$.leaderboard]:!0,cluster:!0,rapid:!1,sound:!0},overlay:ye.menu,phase:se.initial,plusIndex:void 0,[$.records]:Ys.reduce((n,t)=>(n[t]={[$.playerName]:"",[$.timestamp]:0,[$.moves]:"",[$.value]:0},n),{}),[$.score]:{buffer:0,value:0}}),{abs:Tv,sign:qh,trunc:Cv}=Math;function bc(n=0){return(n*16807+19487171)%2147483647}function iE(n){return btoa(String.fromCodePoint(...n))}function Pv(n){return Array.from(atob(n)).map(t=>t.charCodeAt())}function _d(n){const t=BigInt(Number.MAX_SAFE_INTEGER),e=n.reduce((r,s)=>(r=BigInt(`${r}${s}`),r>t&&(r=r%t),r),0);return Number(e)}function Mn(n,t,e=0){const{rapid:r}=Oe(n.options),s=!r&&n.movesInitial===null&&e>0;switch(typeof t){case"undefined":return{duration:s?0:400};case"function":return s?setTimeout(()=>t(n),e):t(n);case"object":return s?{duration:0}:t;default:return s?0:t}}function or(n,t,{muteRapid:e=!1}={}){if(!t)return;const{sound:r,rapid:s}=Oe(n.options);if(!(e&&s)&&!(!r||n.movesInitial!==null||!n.ready)){if(Array.isArray(t)){t.forEach(i=>i&&i());return}t()}}function wc(n,t,e){const r=Oe(n.records);r[t][$.value]>=e||(r[t]={[$.moves]:Oe(n.moves),[$.playerName]:Oe(n.options).playerName,[$.timestamp]:Oe(n.timestamp),[$.value]:e},n.records.set(r))}function Ko(n){return n<qe.maxValue?n+1:0}function _l(n){const t=Array.from({length:qe.columns},()=>Array.from({length:2*qe.rows}));return n.forEach(({x:e,y:r},s)=>t[e][r]=s),t}function Dv(n,t){const e=Oe(n.phase),{rapid:r}=Oe(n.options),s=_l(t),i=[],o=new Set;return s.forEach(a=>{let l=0;a.forEach((u,h)=>{if(u===void 0)return++l;const{x:c,value:d}=t[u],f=r||n.movesInitial||e!==se.fall?0:100*(2*l)**.5;i[u]={x:c,y:h-l,value:d,nextValue:Ko(d),duration:f},l>0&&f>0&&!o.has(f)&&o.add(f)})}),or(n,()=>o.forEach(a=>setTimeout(n.sounds.playKick,a)),{muteRapid:!0}),i}function Mv(n){const t=_l(n),e=new Set,r=[],s=(i,o,a)=>{if(e.has(o))return;const{x:l,y:u,value:h}=n[o];a!==void 0&&a!==h||(r[i]||(r[i]={value:h,indexes:new Set}),r[i].indexes.add(o),e.add(o),u<qe.columns-1&&s(i,t[l][u+1],h),l<qe.columns-1&&s(i,t[l+1][u],h),u>0&&s(i,t[l][u-1],h),l>0&&s(i,t[l-1][u],h))};return n.forEach((i,o)=>s(o,o)),r.reduce((i,o)=>(o.value===o.indexes.size&&(i.counts++,i.digits.add(o.value),o.indexes.forEach(i.indexes.add,i.indexes)),i),{counts:0,digits:new Set,indexes:new Set})}function Lv(n,t,e){const r=[0,0,0,0,0,0],s=i=>r[i]+t.filter(({x:o})=>o===i).sort(({y:o},{y:a})=>a-o)[0].y;return t.map((i,o)=>i.y<qe.rows&&e.has(o)?(++r[i.x],{x:i.x,y:s(i.x),value:n.getNextCardValue(i.x),duration:0}):i)}function Sl(n,t){if(!Oe(n.options).cluster)return t;const e=_l(t);return t.map(r=>({...r,cluster:oE(t,e,r)}))}function oE(n,t,{x:e,y:r,value:s}){const i=r===qe.rows-1?-1:t[e][r+1],o=e===qe.columns-1?-1:t[e+1][r],a=r===0?-1:t[e][r-1],l=e===0?-1:t[e-1][r],u=i>-1?n[i].value:NaN,h=o>-1?n[o].value:NaN,c=a>-1?n[a].value:NaN,d=l>-1?n[l].value:NaN;return{top:u===s,right:h===s,bottom:c===s,left:d===s}}function Bv(n){return qh(n)*Cv(Tv(n)**.5)}function aE(n,{buffer:t,value:e}){const r=Oe(n.phase),{rapid:s}=Oe(n.options),i=s||n.movesInitial?t:r===se.gameOver?qh(t):Bv(t);if(r===se.extra){if(t===0){Mn(n,()=>n.phase.set(se.combo),800);return}n.log.update(o=>{const a=o.length-1,{extra:l}=o[a];return o[a]={extra:l-i},o})}if(t===0){r===se.gameOver&&or(n,()=>setTimeout(n.sounds.playGameOver,600));return}Mn(n,()=>{n.energy.set({buffer:t-i,value:e+i})},r===se.gameOver?200:32)}function cE(n){setTimeout(()=>n.phase.set(se.idle),0)}function lE(n){if(n.movesInitial!==null){if(n.moveCount<n.movesInitial.length){n.plusIndex.set(n.movesInitial[n.moveCount++]),n.energy.update(({buffer:t,value:e})=>({buffer:t,value:e-10})),n.phase.set(se.plus);return}n.movesInitial=null,wc(n,$.highScore,Oe(n.score).value);return}n.cards.update(t=>t.map(e=>(e.duration=0,e))),wc(n,$.highScore,Oe(n.score).value),or(n,n.sounds.reset)}function uE(n){n.plusIndex.update(t=>{n.cards.update(e=>Sl(n,e.map((r,s)=>{if(s!==t)return r;const i=Ko(r.value);return{...r,value:i,nextValue:Ko(i),duration:0}})))}),n.phase.set(se.blink)}function dE(n){const t=Oe(n.cards);let{counts:e,digits:r,indexes:s}=Mv(t);n.matchedIndexes.set(s);const{value:i}=Oe(n.energy);if(s.size>0){const o=Array.from(s);n.log.update(l=>l.concat(o.reduce((u,h)=>{const c=t[h];return u[c.value]=(u[c.value]||0)+c.value,u.sum=(u.sum||0)+c.value,u.counts=e,u.digits=Array.from(r),u},{})));const a=o.reduce((l,u)=>l+t[u].value,0);Mn(n,()=>n.energy.set({buffer:a,value:i}),400),Mn(n,()=>n.phase.set(se.match),800),or(n,[n.sounds.playWordUp,n.sounds.playBlink],{muteRapid:!0});return}if(i>100){n.phase.set(se.extra);return}if(Oe(n.log).length>0){n.phase.set(se.combo);return}if(i<10){n.phase.set(se.gameOver);return}n.phase.set(se.idle)}function hE(n){n.matchedIndexes.update(t=>(n.cards.update(e=>Sl(n,Lv(n,e,t))),new Set)),Mn(n,()=>n.phase.set(se.fall),400)}function fE(n){n.cards.update(t=>Sl(n,Dv(n,t))),Mn(n,()=>n.phase.set(se.blink),400)}function pE(n){n.energy.update(({value:t})=>({buffer:100-t,value:t})),n.log.update(t=>t.concat({extra:100})),or(n,n.sounds.playWordUp,{muteRapid:!0})}function Nv(n){return n.reduce((t,{counts:e,extra:r,sum:s},i)=>t+(i+1)*(s||r)*(e||1),0)}function gE(n){const t=Oe(n.log),e=Nv(t);n.score.update(({value:r})=>({buffer:e,value:r})),wc(n,$.highCombo,e),Mn(n,()=>n.phase.set(se.score),t.length>1?800:0),or(n,n.sounds.playWordUp,{muteRapid:!0})}function mE(n){Oe(n.log).length<2||n.score.update(t=>({...t}))}function yE(n){Mn(n,()=>{n.energy.update(({value:t})=>({buffer:-t,value:t})),n.score.update(({value:t})=>({buffer:Oe(n.energy).value,value:t}))},400)}const vE={[se.initial]:cE,[se.idle]:lE,[se.plus]:uE,[se.blink]:dE,[se.match]:hE,[se.fall]:fE,[se.extra]:pE,[se.combo]:gE,[se.score]:mE,[se.gameOver]:yE};function bE(n,t){vE[t](n)}function wE(n,t){if(t===void 0||n.movesInitial!==null)return;let e=Oe(n.moves);e=Array.isArray(e)?e:Pv(e),e.push(t),n.moves.set(iE(e)),n.energy.update(r=>({...r,buffer:-10})),Mn(n,()=>n.phase.set(se.plus),400)}function _E(n){switch(Tv(n)){case 1:return 130;case 2:case 3:return 80;case 4:case 5:case 6:return 50;case 7:case 8:case 9:case 10:case 11:return 30;default:return 20}}function SE(n,{buffer:t,value:e}){const r=Oe(n.phase);if(r!==se.gameOver&&r!==se.score)return;if(t===0){if(r===se.gameOver){wc(n,$.highScore,e);return}Mn(n,()=>{n.log.set([]),n.phase.set(Oe(n.energy).value<10?se.gameOver:se.idle),or(n,n.sounds.playTurnOn)},200);return}const{rapid:s}=Oe(n.options),i=s||n.movesInitial?t:r===se.gameOver?qh(t):Bv(t);Mn(n,()=>{n.score.set({buffer:t-i,value:e+i})},r===se.gameOver?200:_E(i)),or(n,n.sounds.playBleep,{muteRapid:!0})}function Wh({playerName:n,timestamp:t}){return n&&typeof n=="string"&&t&&typeof t=="number"&&t<1/0&&_d([t,...Array.from(n).map(e=>e.charCodeAt())])}function EE(n){let t=0;const e=[bc(n)];for(;t<qe.columns-1;)e.push(bc(2*e[t++]));return e}function AE(n){let t=EE(n);return e=>{if(e<0||qe.columns-1<e)return;let r=t[e];return t[e]=bc(r),r%10}}function xE(n){return Array.from({length:qe.columns*qe.rows},(t,e,r,s)=>(r=Cv(e/qe.columns),s=n.getNextCardValue(r),{x:r,y:e%qe.rows,value:s,nextValue:Ko(s),duration:0}))}function IE(n,t){for(;;){const e=Mv(t).indexes;if(e.size===0)return t;const r=Lv(n,t,e);t=Dv(n,r)}}function kE(n,t){if(!t)return;n.getNextCardValue=AE(t),n.cards.set(Sl(n,IE(n,xE(n))));let e=Oe(n.moves);if(e){if(e=Array.isArray(e)?e:Pv(e),e.length>0){n.moveCount=0,n.movesInitial=e;return}n.movesInitial=null}}function Rv(n){const t=Oe(n.records);n[$.highComboPrev]=t[$.highCombo][$.value],n[$.highScorePrev]=t[$.highScore][$.value]}function Ov(n,t){return Rv(n),n.sounds=t||{},n.getNextCardValue=()=>0,n.moveCount=0,n.movesInitial=null,n.energy.subscribe(e=>aE(n,e)),n.phase.subscribe(e=>bE(n,e)),n.plusIndex.subscribe(e=>wE(n,e)),n.score.subscribe(e=>SE(n,e)),n.seed.subscribe(e=>kE(n,e)),n}function Fv(n,t,e){if(t<0)return n.ready=!0;setTimeout(()=>{n.log.set($e.log),n.plusIndex.set($e.plusIndex),n.matchedIndexes.set($e.matchedIndexes),n.moves.set($e.moves),n.score.set($e.score),n.energy.set($e.energy),n.phase.set($e.phase),n.timestamp.set(Date.now()),Fv(n,--t),e&&n.options.update(r=>({...r,playerName:e}))},64)}function TE(n,t){Rv(n),or(n,n.sounds.playGenerate),n.ready=!1,Fv(n,8,t)}var CE=ce('<div><div class="value"><div> </div> <div class="next"> </div></div></div>');function $v(n,t){if(new.target)return Ut({component:$v,...n});kt(t,!1);const e=Q();let r=At(t,"card",12),s=At(t,"index",12),i=At(t,"blink",12),o=At(t,"focus",12),a=At(t,"longpress",12),l=At(t,"plus",12);ae(()=>kn(r()),()=>{M(e,Ko(r().value))}),dr(),Vt();var u=CE();let h;var c=G(u),d=G(c);let f;var g=G(d,!0);W(d);var y=J(d,2),m=G(y,!0);return W(y),W(c),W(u),Ze(()=>{h=nt(u,1,"card",null,h,{blink:i(),focus:o(),longpress:a(),plus:l()}),Ot(u,"data-index",s()),gn(u,"--card-x",r().x),gn(u,"--card-y",r().y),gn(u,"--card-duration",r().duration),f=nt(d,1,"current",null,f,{"cluster-top":r().cluster&&r().cluster.top,"cluster-right":r().cluster&&r().cluster.right,"cluster-bottom":r().cluster&&r().cluster.bottom,"cluster-left":r().cluster&&r().cluster.left}),gn(d,"--color",`var(--color-${r().value??""})`),st(g,r().value),gn(y,"--color",`var(--color-${b(e)??""})`),st(m,b(e))}),oe(n,u),Tt({get card(){return r()},set card(v){r(v),yt()},get index(){return s()},set index(v){s(v),yt()},get blink(){return i()},set blink(v){i(v),yt()},get focus(){return o()},set focus(v){o(v),yt()},get longpress(){return a()},set longpress(v){a(v),yt()},get plus(){return l()},set plus(v){l(v),yt()},$set:zt,$on:(v,_)=>Ht(t,v,_)})}function PE(n,{duration:t=400}={}){let e;const r=(i={})=>{n.dispatchEvent(new CustomEvent("longpressstart",{bubbles:!0,detail:i})),e=window.setTimeout(()=>{n.dispatchEvent(new CustomEvent("longpressfire",{bubbles:!0,detail:i}))},t)},s=(i={})=>{clearTimeout(e),n.dispatchEvent(new CustomEvent("longpressend",{bubbles:!0,detail:i}))};return n.addEventListener("mousedown",r,{passive:!0}),n.addEventListener("touchstart",r,{passive:!0}),n.addEventListener("touchend",s,{passive:!0}),window.addEventListener("mouseup",s,{passive:!0}),{update(i){clearTimeout(e),t=i.duration||t},destroy(){clearTimeout(e),n.removeEventListener("mousedown",r),n.removeEventListener("touchstart",r),n.removeEventListener("touchend",s),window.removeEventListener("mouseup",s)}}}var bo=typeof globalThis<"u"?globalThis:typeof window<"u"?window:typeof global<"u"?global:typeof self<"u"?self:{};function ao(n){return n&&n.__esModule&&Object.prototype.hasOwnProperty.call(n,"default")?n.default:n}var lu={};/*!
 *  howler.js v2.2.4
 *  howlerjs.com
 *
 *  (c) 2013-2020, James Simpson of GoldFire Studios
 *  goldfirestudios.com
 *
 *  MIT License
 */var kp;function DE(){return kp||(kp=1,function(n){(function(){var t=function(){this.init()};t.prototype={init:function(){var c=this||e;return c._counter=1e3,c._html5AudioPool=[],c.html5PoolSize=10,c._codecs={},c._howls=[],c._muted=!1,c._volume=1,c._canPlayEvent="canplaythrough",c._navigator=typeof window<"u"&&window.navigator?window.navigator:null,c.masterGain=null,c.noAudio=!1,c.usingWebAudio=!0,c.autoSuspend=!0,c.ctx=null,c.autoUnlock=!0,c._setup(),c},volume:function(c){var d=this||e;if(c=parseFloat(c),d.ctx||h(),typeof c<"u"&&c>=0&&c<=1){if(d._volume=c,d._muted)return d;d.usingWebAudio&&d.masterGain.gain.setValueAtTime(c,e.ctx.currentTime);for(var f=0;f<d._howls.length;f++)if(!d._howls[f]._webAudio)for(var g=d._howls[f]._getSoundIds(),y=0;y<g.length;y++){var m=d._howls[f]._soundById(g[y]);m&&m._node&&(m._node.volume=m._volume*c)}return d}return d._volume},mute:function(c){var d=this||e;d.ctx||h(),d._muted=c,d.usingWebAudio&&d.masterGain.gain.setValueAtTime(c?0:d._volume,e.ctx.currentTime);for(var f=0;f<d._howls.length;f++)if(!d._howls[f]._webAudio)for(var g=d._howls[f]._getSoundIds(),y=0;y<g.length;y++){var m=d._howls[f]._soundById(g[y]);m&&m._node&&(m._node.muted=c?!0:m._muted)}return d},stop:function(){for(var c=this||e,d=0;d<c._howls.length;d++)c._howls[d].stop();return c},unload:function(){for(var c=this||e,d=c._howls.length-1;d>=0;d--)c._howls[d].unload();return c.usingWebAudio&&c.ctx&&typeof c.ctx.close<"u"&&(c.ctx.close(),c.ctx=null,h()),c},codecs:function(c){return(this||e)._codecs[c.replace(/^x-/,"")]},_setup:function(){var c=this||e;if(c.state=c.ctx&&c.ctx.state||"suspended",c._autoSuspend(),!c.usingWebAudio)if(typeof Audio<"u")try{var d=new Audio;typeof d.oncanplaythrough>"u"&&(c._canPlayEvent="canplay")}catch{c.noAudio=!0}else c.noAudio=!0;try{var d=new Audio;d.muted&&(c.noAudio=!0)}catch{}return c.noAudio||c._setupCodecs(),c},_setupCodecs:function(){var c=this||e,d=null;try{d=typeof Audio<"u"?new Audio:null}catch{return c}if(!d||typeof d.canPlayType!="function")return c;var f=d.canPlayType("audio/mpeg;").replace(/^no$/,""),g=c._navigator?c._navigator.userAgent:"",y=g.match(/OPR\/(\d+)/g),m=y&&parseInt(y[0].split("/")[1],10)<33,v=g.indexOf("Safari")!==-1&&g.indexOf("Chrome")===-1,_=g.match(/Version\/(.*?) /),w=v&&_&&parseInt(_[1],10)<15;return c._codecs={mp3:!!(!m&&(f||d.canPlayType("audio/mp3;").replace(/^no$/,""))),mpeg:!!f,opus:!!d.canPlayType('audio/ogg; codecs="opus"').replace(/^no$/,""),ogg:!!d.canPlayType('audio/ogg; codecs="vorbis"').replace(/^no$/,""),oga:!!d.canPlayType('audio/ogg; codecs="vorbis"').replace(/^no$/,""),wav:!!(d.canPlayType('audio/wav; codecs="1"')||d.canPlayType("audio/wav")).replace(/^no$/,""),aac:!!d.canPlayType("audio/aac;").replace(/^no$/,""),caf:!!d.canPlayType("audio/x-caf;").replace(/^no$/,""),m4a:!!(d.canPlayType("audio/x-m4a;")||d.canPlayType("audio/m4a;")||d.canPlayType("audio/aac;")).replace(/^no$/,""),m4b:!!(d.canPlayType("audio/x-m4b;")||d.canPlayType("audio/m4b;")||d.canPlayType("audio/aac;")).replace(/^no$/,""),mp4:!!(d.canPlayType("audio/x-mp4;")||d.canPlayType("audio/mp4;")||d.canPlayType("audio/aac;")).replace(/^no$/,""),weba:!!(!w&&d.canPlayType('audio/webm; codecs="vorbis"').replace(/^no$/,"")),webm:!!(!w&&d.canPlayType('audio/webm; codecs="vorbis"').replace(/^no$/,"")),dolby:!!d.canPlayType('audio/mp4; codecs="ec-3"').replace(/^no$/,""),flac:!!(d.canPlayType("audio/x-flac;")||d.canPlayType("audio/flac;")).replace(/^no$/,"")},c},_unlockAudio:function(){var c=this||e;if(!(c._audioUnlocked||!c.ctx)){c._audioUnlocked=!1,c.autoUnlock=!1,!c._mobileUnloaded&&c.ctx.sampleRate!==44100&&(c._mobileUnloaded=!0,c.unload()),c._scratchBuffer=c.ctx.createBuffer(1,1,22050);var d=function(f){for(;c._html5AudioPool.length<c.html5PoolSize;)try{var g=new Audio;g._unlocked=!0,c._releaseHtml5Audio(g)}catch{c.noAudio=!0;break}for(var y=0;y<c._howls.length;y++)if(!c._howls[y]._webAudio)for(var m=c._howls[y]._getSoundIds(),v=0;v<m.length;v++){var _=c._howls[y]._soundById(m[v]);_&&_._node&&!_._node._unlocked&&(_._node._unlocked=!0,_._node.load())}c._autoResume();var w=c.ctx.createBufferSource();w.buffer=c._scratchBuffer,w.connect(c.ctx.destination),typeof w.start>"u"?w.noteOn(0):w.start(0),typeof c.ctx.resume=="function"&&c.ctx.resume(),w.onended=function(){w.disconnect(0),c._audioUnlocked=!0,document.removeEventListener("touchstart",d,!0),document.removeEventListener("touchend",d,!0),document.removeEventListener("click",d,!0),document.removeEventListener("keydown",d,!0);for(var S=0;S<c._howls.length;S++)c._howls[S]._emit("unlock")}};return document.addEventListener("touchstart",d,!0),document.addEventListener("touchend",d,!0),document.addEventListener("click",d,!0),document.addEventListener("keydown",d,!0),c}},_obtainHtml5Audio:function(){var c=this||e;if(c._html5AudioPool.length)return c._html5AudioPool.pop();var d=new Audio().play();return d&&typeof Promise<"u"&&(d instanceof Promise||typeof d.then=="function")&&d.catch(function(){console.warn("HTML5 Audio pool exhausted, returning potentially locked audio object.")}),new Audio},_releaseHtml5Audio:function(c){var d=this||e;return c._unlocked&&d._html5AudioPool.push(c),d},_autoSuspend:function(){var c=this;if(!(!c.autoSuspend||!c.ctx||typeof c.ctx.suspend>"u"||!e.usingWebAudio)){for(var d=0;d<c._howls.length;d++)if(c._howls[d]._webAudio){for(var f=0;f<c._howls[d]._sounds.length;f++)if(!c._howls[d]._sounds[f]._paused)return c}return c._suspendTimer&&clearTimeout(c._suspendTimer),c._suspendTimer=setTimeout(function(){if(c.autoSuspend){c._suspendTimer=null,c.state="suspending";var g=function(){c.state="suspended",c._resumeAfterSuspend&&(delete c._resumeAfterSuspend,c._autoResume())};c.ctx.suspend().then(g,g)}},3e4),c}},_autoResume:function(){var c=this;if(!(!c.ctx||typeof c.ctx.resume>"u"||!e.usingWebAudio))return c.state==="running"&&c.ctx.state!=="interrupted"&&c._suspendTimer?(clearTimeout(c._suspendTimer),c._suspendTimer=null):c.state==="suspended"||c.state==="running"&&c.ctx.state==="interrupted"?(c.ctx.resume().then(function(){c.state="running";for(var d=0;d<c._howls.length;d++)c._howls[d]._emit("resume")}),c._suspendTimer&&(clearTimeout(c._suspendTimer),c._suspendTimer=null)):c.state==="suspending"&&(c._resumeAfterSuspend=!0),c}};var e=new t,r=function(c){var d=this;if(!c.src||c.src.length===0){console.error("An array of source files must be passed with any new Howl.");return}d.init(c)};r.prototype={init:function(c){var d=this;return e.ctx||h(),d._autoplay=c.autoplay||!1,d._format=typeof c.format!="string"?c.format:[c.format],d._html5=c.html5||!1,d._muted=c.mute||!1,d._loop=c.loop||!1,d._pool=c.pool||5,d._preload=typeof c.preload=="boolean"||c.preload==="metadata"?c.preload:!0,d._rate=c.rate||1,d._sprite=c.sprite||{},d._src=typeof c.src!="string"?c.src:[c.src],d._volume=c.volume!==void 0?c.volume:1,d._xhr={method:c.xhr&&c.xhr.method?c.xhr.method:"GET",headers:c.xhr&&c.xhr.headers?c.xhr.headers:null,withCredentials:c.xhr&&c.xhr.withCredentials?c.xhr.withCredentials:!1},d._duration=0,d._state="unloaded",d._sounds=[],d._endTimers={},d._queue=[],d._playLock=!1,d._onend=c.onend?[{fn:c.onend}]:[],d._onfade=c.onfade?[{fn:c.onfade}]:[],d._onload=c.onload?[{fn:c.onload}]:[],d._onloaderror=c.onloaderror?[{fn:c.onloaderror}]:[],d._onplayerror=c.onplayerror?[{fn:c.onplayerror}]:[],d._onpause=c.onpause?[{fn:c.onpause}]:[],d._onplay=c.onplay?[{fn:c.onplay}]:[],d._onstop=c.onstop?[{fn:c.onstop}]:[],d._onmute=c.onmute?[{fn:c.onmute}]:[],d._onvolume=c.onvolume?[{fn:c.onvolume}]:[],d._onrate=c.onrate?[{fn:c.onrate}]:[],d._onseek=c.onseek?[{fn:c.onseek}]:[],d._onunlock=c.onunlock?[{fn:c.onunlock}]:[],d._onresume=[],d._webAudio=e.usingWebAudio&&!d._html5,typeof e.ctx<"u"&&e.ctx&&e.autoUnlock&&e._unlockAudio(),e._howls.push(d),d._autoplay&&d._queue.push({event:"play",action:function(){d.play()}}),d._preload&&d._preload!=="none"&&d.load(),d},load:function(){var c=this,d=null;if(e.noAudio){c._emit("loaderror",null,"No audio support.");return}typeof c._src=="string"&&(c._src=[c._src]);for(var f=0;f<c._src.length;f++){var g,y;if(c._format&&c._format[f])g=c._format[f];else{if(y=c._src[f],typeof y!="string"){c._emit("loaderror",null,"Non-string found in selected audio sources - ignoring.");continue}g=/^data:audio\/([^;,]+);/i.exec(y),g||(g=/\.([^.]+)$/.exec(y.split("?",1)[0])),g&&(g=g[1].toLowerCase())}if(g||console.warn('No file extension was found. Consider using the "format" property or specify an extension.'),g&&e.codecs(g)){d=c._src[f];break}}if(!d){c._emit("loaderror",null,"No codec support for selected audio sources.");return}return c._src=d,c._state="loading",window.location.protocol==="https:"&&d.slice(0,5)==="http:"&&(c._html5=!0,c._webAudio=!1),new s(c),c._webAudio&&o(c),c},play:function(c,d){var f=this,g=null;if(typeof c=="number")g=c,c=null;else{if(typeof c=="string"&&f._state==="loaded"&&!f._sprite[c])return null;if(typeof c>"u"&&(c="__default",!f._playLock)){for(var y=0,m=0;m<f._sounds.length;m++)f._sounds[m]._paused&&!f._sounds[m]._ended&&(y++,g=f._sounds[m]._id);y===1?c=null:g=null}}var v=g?f._soundById(g):f._inactiveSound();if(!v)return null;if(g&&!c&&(c=v._sprite||"__default"),f._state!=="loaded"){v._sprite=c,v._ended=!1;var _=v._id;return f._queue.push({event:"play",action:function(){f.play(_)}}),_}if(g&&!v._paused)return d||f._loadQueue("play"),v._id;f._webAudio&&e._autoResume();var w=Math.max(0,v._seek>0?v._seek:f._sprite[c][0]/1e3),S=Math.max(0,(f._sprite[c][0]+f._sprite[c][1])/1e3-w),A=S*1e3/Math.abs(v._rate),E=f._sprite[c][0]/1e3,I=(f._sprite[c][0]+f._sprite[c][1])/1e3;v._sprite=c,v._ended=!1;var k=function(){v._paused=!1,v._seek=w,v._start=E,v._stop=I,v._loop=!!(v._loop||f._sprite[c][2])};if(w>=I){f._ended(v);return}var x=v._node;if(f._webAudio){var U=function(){f._playLock=!1,k(),f._refreshBuffer(v);var D=v._muted||f._muted?0:v._volume;x.gain.setValueAtTime(D,e.ctx.currentTime),v._playStart=e.ctx.currentTime,typeof x.bufferSource.start>"u"?v._loop?x.bufferSource.noteGrainOn(0,w,86400):x.bufferSource.noteGrainOn(0,w,S):v._loop?x.bufferSource.start(0,w,86400):x.bufferSource.start(0,w,S),A!==1/0&&(f._endTimers[v._id]=setTimeout(f._ended.bind(f,v),A)),d||setTimeout(function(){f._emit("play",v._id),f._loadQueue()},0)};e.state==="running"&&e.ctx.state!=="interrupted"?U():(f._playLock=!0,f.once("resume",U),f._clearTimer(v._id))}else{var B=function(){x.currentTime=w,x.muted=v._muted||f._muted||e._muted||x.muted,x.volume=v._volume*e.volume(),x.playbackRate=v._rate;try{var D=x.play();if(D&&typeof Promise<"u"&&(D instanceof Promise||typeof D.then=="function")?(f._playLock=!0,k(),D.then(function(){f._playLock=!1,x._unlocked=!0,d?f._loadQueue():f._emit("play",v._id)}).catch(function(){f._playLock=!1,f._emit("playerror",v._id,"Playback was unable to start. This is most commonly an issue on mobile devices and Chrome where playback was not within a user interaction."),v._ended=!0,v._paused=!0})):d||(f._playLock=!1,k(),f._emit("play",v._id)),x.playbackRate=v._rate,x.paused){f._emit("playerror",v._id,"Playback was unable to start. This is most commonly an issue on mobile devices and Chrome where playback was not within a user interaction.");return}c!=="__default"||v._loop?f._endTimers[v._id]=setTimeout(f._ended.bind(f,v),A):(f._endTimers[v._id]=function(){f._ended(v),x.removeEventListener("ended",f._endTimers[v._id],!1)},x.addEventListener("ended",f._endTimers[v._id],!1))}catch(L){f._emit("playerror",v._id,L)}};x.src==="data:audio/wav;base64,UklGRigAAABXQVZFZm10IBIAAAABAAEARKwAAIhYAQACABAAAABkYXRhAgAAAAEA"&&(x.src=f._src,x.load());var N=window&&window.ejecta||!x.readyState&&e._navigator.isCocoonJS;if(x.readyState>=3||N)B();else{f._playLock=!0,f._state="loading";var z=function(){f._state="loaded",B(),x.removeEventListener(e._canPlayEvent,z,!1)};x.addEventListener(e._canPlayEvent,z,!1),f._clearTimer(v._id)}}return v._id},pause:function(c){var d=this;if(d._state!=="loaded"||d._playLock)return d._queue.push({event:"pause",action:function(){d.pause(c)}}),d;for(var f=d._getSoundIds(c),g=0;g<f.length;g++){d._clearTimer(f[g]);var y=d._soundById(f[g]);if(y&&!y._paused&&(y._seek=d.seek(f[g]),y._rateSeek=0,y._paused=!0,d._stopFade(f[g]),y._node))if(d._webAudio){if(!y._node.bufferSource)continue;typeof y._node.bufferSource.stop>"u"?y._node.bufferSource.noteOff(0):y._node.bufferSource.stop(0),d._cleanBuffer(y._node)}else(!isNaN(y._node.duration)||y._node.duration===1/0)&&y._node.pause();arguments[1]||d._emit("pause",y?y._id:null)}return d},stop:function(c,d){var f=this;if(f._state!=="loaded"||f._playLock)return f._queue.push({event:"stop",action:function(){f.stop(c)}}),f;for(var g=f._getSoundIds(c),y=0;y<g.length;y++){f._clearTimer(g[y]);var m=f._soundById(g[y]);m&&(m._seek=m._start||0,m._rateSeek=0,m._paused=!0,m._ended=!0,f._stopFade(g[y]),m._node&&(f._webAudio?m._node.bufferSource&&(typeof m._node.bufferSource.stop>"u"?m._node.bufferSource.noteOff(0):m._node.bufferSource.stop(0),f._cleanBuffer(m._node)):(!isNaN(m._node.duration)||m._node.duration===1/0)&&(m._node.currentTime=m._start||0,m._node.pause(),m._node.duration===1/0&&f._clearSound(m._node))),d||f._emit("stop",m._id))}return f},mute:function(c,d){var f=this;if(f._state!=="loaded"||f._playLock)return f._queue.push({event:"mute",action:function(){f.mute(c,d)}}),f;if(typeof d>"u")if(typeof c=="boolean")f._muted=c;else return f._muted;for(var g=f._getSoundIds(d),y=0;y<g.length;y++){var m=f._soundById(g[y]);m&&(m._muted=c,m._interval&&f._stopFade(m._id),f._webAudio&&m._node?m._node.gain.setValueAtTime(c?0:m._volume,e.ctx.currentTime):m._node&&(m._node.muted=e._muted?!0:c),f._emit("mute",m._id))}return f},volume:function(){var c=this,d=arguments,f,g;if(d.length===0)return c._volume;if(d.length===1||d.length===2&&typeof d[1]>"u"){var y=c._getSoundIds(),m=y.indexOf(d[0]);m>=0?g=parseInt(d[0],10):f=parseFloat(d[0])}else d.length>=2&&(f=parseFloat(d[0]),g=parseInt(d[1],10));var v;if(typeof f<"u"&&f>=0&&f<=1){if(c._state!=="loaded"||c._playLock)return c._queue.push({event:"volume",action:function(){c.volume.apply(c,d)}}),c;typeof g>"u"&&(c._volume=f),g=c._getSoundIds(g);for(var _=0;_<g.length;_++)v=c._soundById(g[_]),v&&(v._volume=f,d[2]||c._stopFade(g[_]),c._webAudio&&v._node&&!v._muted?v._node.gain.setValueAtTime(f,e.ctx.currentTime):v._node&&!v._muted&&(v._node.volume=f*e.volume()),c._emit("volume",v._id))}else return v=g?c._soundById(g):c._sounds[0],v?v._volume:0;return c},fade:function(c,d,f,g){var y=this;if(y._state!=="loaded"||y._playLock)return y._queue.push({event:"fade",action:function(){y.fade(c,d,f,g)}}),y;c=Math.min(Math.max(0,parseFloat(c)),1),d=Math.min(Math.max(0,parseFloat(d)),1),f=parseFloat(f),y.volume(c,g);for(var m=y._getSoundIds(g),v=0;v<m.length;v++){var _=y._soundById(m[v]);if(_){if(g||y._stopFade(m[v]),y._webAudio&&!_._muted){var w=e.ctx.currentTime,S=w+f/1e3;_._volume=c,_._node.gain.setValueAtTime(c,w),_._node.gain.linearRampToValueAtTime(d,S)}y._startFadeInterval(_,c,d,f,m[v],typeof g>"u")}}return y},_startFadeInterval:function(c,d,f,g,y,m){var v=this,_=d,w=f-d,S=Math.abs(w/.01),A=Math.max(4,S>0?g/S:g),E=Date.now();c._fadeTo=f,c._interval=setInterval(function(){var I=(Date.now()-E)/g;E=Date.now(),_+=w*I,_=Math.round(_*100)/100,w<0?_=Math.max(f,_):_=Math.min(f,_),v._webAudio?c._volume=_:v.volume(_,c._id,!0),m&&(v._volume=_),(f<d&&_<=f||f>d&&_>=f)&&(clearInterval(c._interval),c._interval=null,c._fadeTo=null,v.volume(f,c._id),v._emit("fade",c._id))},A)},_stopFade:function(c){var d=this,f=d._soundById(c);return f&&f._interval&&(d._webAudio&&f._node.gain.cancelScheduledValues(e.ctx.currentTime),clearInterval(f._interval),f._interval=null,d.volume(f._fadeTo,c),f._fadeTo=null,d._emit("fade",c)),d},loop:function(){var c=this,d=arguments,f,g,y;if(d.length===0)return c._loop;if(d.length===1)if(typeof d[0]=="boolean")f=d[0],c._loop=f;else return y=c._soundById(parseInt(d[0],10)),y?y._loop:!1;else d.length===2&&(f=d[0],g=parseInt(d[1],10));for(var m=c._getSoundIds(g),v=0;v<m.length;v++)y=c._soundById(m[v]),y&&(y._loop=f,c._webAudio&&y._node&&y._node.bufferSource&&(y._node.bufferSource.loop=f,f&&(y._node.bufferSource.loopStart=y._start||0,y._node.bufferSource.loopEnd=y._stop,c.playing(m[v])&&(c.pause(m[v],!0),c.play(m[v],!0)))));return c},rate:function(){var c=this,d=arguments,f,g;if(d.length===0)g=c._sounds[0]._id;else if(d.length===1){var y=c._getSoundIds(),m=y.indexOf(d[0]);m>=0?g=parseInt(d[0],10):f=parseFloat(d[0])}else d.length===2&&(f=parseFloat(d[0]),g=parseInt(d[1],10));var v;if(typeof f=="number"){if(c._state!=="loaded"||c._playLock)return c._queue.push({event:"rate",action:function(){c.rate.apply(c,d)}}),c;typeof g>"u"&&(c._rate=f),g=c._getSoundIds(g);for(var _=0;_<g.length;_++)if(v=c._soundById(g[_]),v){c.playing(g[_])&&(v._rateSeek=c.seek(g[_]),v._playStart=c._webAudio?e.ctx.currentTime:v._playStart),v._rate=f,c._webAudio&&v._node&&v._node.bufferSource?v._node.bufferSource.playbackRate.setValueAtTime(f,e.ctx.currentTime):v._node&&(v._node.playbackRate=f);var w=c.seek(g[_]),S=(c._sprite[v._sprite][0]+c._sprite[v._sprite][1])/1e3-w,A=S*1e3/Math.abs(v._rate);(c._endTimers[g[_]]||!v._paused)&&(c._clearTimer(g[_]),c._endTimers[g[_]]=setTimeout(c._ended.bind(c,v),A)),c._emit("rate",v._id)}}else return v=c._soundById(g),v?v._rate:c._rate;return c},seek:function(){var c=this,d=arguments,f,g;if(d.length===0)c._sounds.length&&(g=c._sounds[0]._id);else if(d.length===1){var y=c._getSoundIds(),m=y.indexOf(d[0]);m>=0?g=parseInt(d[0],10):c._sounds.length&&(g=c._sounds[0]._id,f=parseFloat(d[0]))}else d.length===2&&(f=parseFloat(d[0]),g=parseInt(d[1],10));if(typeof g>"u")return 0;if(typeof f=="number"&&(c._state!=="loaded"||c._playLock))return c._queue.push({event:"seek",action:function(){c.seek.apply(c,d)}}),c;var v=c._soundById(g);if(v)if(typeof f=="number"&&f>=0){var _=c.playing(g);_&&c.pause(g,!0),v._seek=f,v._ended=!1,c._clearTimer(g),!c._webAudio&&v._node&&!isNaN(v._node.duration)&&(v._node.currentTime=f);var w=function(){_&&c.play(g,!0),c._emit("seek",g)};if(_&&!c._webAudio){var S=function(){c._playLock?setTimeout(S,0):w()};setTimeout(S,0)}else w()}else if(c._webAudio){var A=c.playing(g)?e.ctx.currentTime-v._playStart:0,E=v._rateSeek?v._rateSeek-v._seek:0;return v._seek+(E+A*Math.abs(v._rate))}else return v._node.currentTime;return c},playing:function(c){var d=this;if(typeof c=="number"){var f=d._soundById(c);return f?!f._paused:!1}for(var g=0;g<d._sounds.length;g++)if(!d._sounds[g]._paused)return!0;return!1},duration:function(c){var d=this,f=d._duration,g=d._soundById(c);return g&&(f=d._sprite[g._sprite][1]/1e3),f},state:function(){return this._state},unload:function(){for(var c=this,d=c._sounds,f=0;f<d.length;f++)d[f]._paused||c.stop(d[f]._id),c._webAudio||(c._clearSound(d[f]._node),d[f]._node.removeEventListener("error",d[f]._errorFn,!1),d[f]._node.removeEventListener(e._canPlayEvent,d[f]._loadFn,!1),d[f]._node.removeEventListener("ended",d[f]._endFn,!1),e._releaseHtml5Audio(d[f]._node)),delete d[f]._node,c._clearTimer(d[f]._id);var g=e._howls.indexOf(c);g>=0&&e._howls.splice(g,1);var y=!0;for(f=0;f<e._howls.length;f++)if(e._howls[f]._src===c._src||c._src.indexOf(e._howls[f]._src)>=0){y=!1;break}return i&&y&&delete i[c._src],e.noAudio=!1,c._state="unloaded",c._sounds=[],c=null,null},on:function(c,d,f,g){var y=this,m=y["_on"+c];return typeof d=="function"&&m.push(g?{id:f,fn:d,once:g}:{id:f,fn:d}),y},off:function(c,d,f){var g=this,y=g["_on"+c],m=0;if(typeof d=="number"&&(f=d,d=null),d||f)for(m=0;m<y.length;m++){var v=f===y[m].id;if(d===y[m].fn&&v||!d&&v){y.splice(m,1);break}}else if(c)g["_on"+c]=[];else{var _=Object.keys(g);for(m=0;m<_.length;m++)_[m].indexOf("_on")===0&&Array.isArray(g[_[m]])&&(g[_[m]]=[])}return g},once:function(c,d,f){var g=this;return g.on(c,d,f,1),g},_emit:function(c,d,f){for(var g=this,y=g["_on"+c],m=y.length-1;m>=0;m--)(!y[m].id||y[m].id===d||c==="load")&&(setTimeout(function(v){v.call(this,d,f)}.bind(g,y[m].fn),0),y[m].once&&g.off(c,y[m].fn,y[m].id));return g._loadQueue(c),g},_loadQueue:function(c){var d=this;if(d._queue.length>0){var f=d._queue[0];f.event===c&&(d._queue.shift(),d._loadQueue()),c||f.action()}return d},_ended:function(c){var d=this,f=c._sprite;if(!d._webAudio&&c._node&&!c._node.paused&&!c._node.ended&&c._node.currentTime<c._stop)return setTimeout(d._ended.bind(d,c),100),d;var g=!!(c._loop||d._sprite[f][2]);if(d._emit("end",c._id),!d._webAudio&&g&&d.stop(c._id,!0).play(c._id),d._webAudio&&g){d._emit("play",c._id),c._seek=c._start||0,c._rateSeek=0,c._playStart=e.ctx.currentTime;var y=(c._stop-c._start)*1e3/Math.abs(c._rate);d._endTimers[c._id]=setTimeout(d._ended.bind(d,c),y)}return d._webAudio&&!g&&(c._paused=!0,c._ended=!0,c._seek=c._start||0,c._rateSeek=0,d._clearTimer(c._id),d._cleanBuffer(c._node),e._autoSuspend()),!d._webAudio&&!g&&d.stop(c._id,!0),d},_clearTimer:function(c){var d=this;if(d._endTimers[c]){if(typeof d._endTimers[c]!="function")clearTimeout(d._endTimers[c]);else{var f=d._soundById(c);f&&f._node&&f._node.removeEventListener("ended",d._endTimers[c],!1)}delete d._endTimers[c]}return d},_soundById:function(c){for(var d=this,f=0;f<d._sounds.length;f++)if(c===d._sounds[f]._id)return d._sounds[f];return null},_inactiveSound:function(){var c=this;c._drain();for(var d=0;d<c._sounds.length;d++)if(c._sounds[d]._ended)return c._sounds[d].reset();return new s(c)},_drain:function(){var c=this,d=c._pool,f=0,g=0;if(!(c._sounds.length<d)){for(g=0;g<c._sounds.length;g++)c._sounds[g]._ended&&f++;for(g=c._sounds.length-1;g>=0;g--){if(f<=d)return;c._sounds[g]._ended&&(c._webAudio&&c._sounds[g]._node&&c._sounds[g]._node.disconnect(0),c._sounds.splice(g,1),f--)}}},_getSoundIds:function(c){var d=this;if(typeof c>"u"){for(var f=[],g=0;g<d._sounds.length;g++)f.push(d._sounds[g]._id);return f}else return[c]},_refreshBuffer:function(c){var d=this;return c._node.bufferSource=e.ctx.createBufferSource(),c._node.bufferSource.buffer=i[d._src],c._panner?c._node.bufferSource.connect(c._panner):c._node.bufferSource.connect(c._node),c._node.bufferSource.loop=c._loop,c._loop&&(c._node.bufferSource.loopStart=c._start||0,c._node.bufferSource.loopEnd=c._stop||0),c._node.bufferSource.playbackRate.setValueAtTime(c._rate,e.ctx.currentTime),d},_cleanBuffer:function(c){var d=this,f=e._navigator&&e._navigator.vendor.indexOf("Apple")>=0;if(!c.bufferSource)return d;if(e._scratchBuffer&&c.bufferSource&&(c.bufferSource.onended=null,c.bufferSource.disconnect(0),f))try{c.bufferSource.buffer=e._scratchBuffer}catch{}return c.bufferSource=null,d},_clearSound:function(c){var d=/MSIE |Trident\//.test(e._navigator&&e._navigator.userAgent);d||(c.src="data:audio/wav;base64,UklGRigAAABXQVZFZm10IBIAAAABAAEARKwAAIhYAQACABAAAABkYXRhAgAAAAEA")}};var s=function(c){this._parent=c,this.init()};s.prototype={init:function(){var c=this,d=c._parent;return c._muted=d._muted,c._loop=d._loop,c._volume=d._volume,c._rate=d._rate,c._seek=0,c._paused=!0,c._ended=!0,c._sprite="__default",c._id=++e._counter,d._sounds.push(c),c.create(),c},create:function(){var c=this,d=c._parent,f=e._muted||c._muted||c._parent._muted?0:c._volume;return d._webAudio?(c._node=typeof e.ctx.createGain>"u"?e.ctx.createGainNode():e.ctx.createGain(),c._node.gain.setValueAtTime(f,e.ctx.currentTime),c._node.paused=!0,c._node.connect(e.masterGain)):e.noAudio||(c._node=e._obtainHtml5Audio(),c._errorFn=c._errorListener.bind(c),c._node.addEventListener("error",c._errorFn,!1),c._loadFn=c._loadListener.bind(c),c._node.addEventListener(e._canPlayEvent,c._loadFn,!1),c._endFn=c._endListener.bind(c),c._node.addEventListener("ended",c._endFn,!1),c._node.src=d._src,c._node.preload=d._preload===!0?"auto":d._preload,c._node.volume=f*e.volume(),c._node.load()),c},reset:function(){var c=this,d=c._parent;return c._muted=d._muted,c._loop=d._loop,c._volume=d._volume,c._rate=d._rate,c._seek=0,c._rateSeek=0,c._paused=!0,c._ended=!0,c._sprite="__default",c._id=++e._counter,c},_errorListener:function(){var c=this;c._parent._emit("loaderror",c._id,c._node.error?c._node.error.code:0),c._node.removeEventListener("error",c._errorFn,!1)},_loadListener:function(){var c=this,d=c._parent;d._duration=Math.ceil(c._node.duration*10)/10,Object.keys(d._sprite).length===0&&(d._sprite={__default:[0,d._duration*1e3]}),d._state!=="loaded"&&(d._state="loaded",d._emit("load"),d._loadQueue()),c._node.removeEventListener(e._canPlayEvent,c._loadFn,!1)},_endListener:function(){var c=this,d=c._parent;d._duration===1/0&&(d._duration=Math.ceil(c._node.duration*10)/10,d._sprite.__default[1]===1/0&&(d._sprite.__default[1]=d._duration*1e3),d._ended(c)),c._node.removeEventListener("ended",c._endFn,!1)}};var i={},o=function(c){var d=c._src;if(i[d]){c._duration=i[d].duration,u(c);return}if(/^data:[^;]+;base64,/.test(d)){for(var f=atob(d.split(",")[1]),g=new Uint8Array(f.length),y=0;y<f.length;++y)g[y]=f.charCodeAt(y);l(g.buffer,c)}else{var m=new XMLHttpRequest;m.open(c._xhr.method,d,!0),m.withCredentials=c._xhr.withCredentials,m.responseType="arraybuffer",c._xhr.headers&&Object.keys(c._xhr.headers).forEach(function(v){m.setRequestHeader(v,c._xhr.headers[v])}),m.onload=function(){var v=(m.status+"")[0];if(v!=="0"&&v!=="2"&&v!=="3"){c._emit("loaderror",null,"Failed loading audio file with status: "+m.status+".");return}l(m.response,c)},m.onerror=function(){c._webAudio&&(c._html5=!0,c._webAudio=!1,c._sounds=[],delete i[d],c.load())},a(m)}},a=function(c){try{c.send()}catch{c.onerror()}},l=function(c,d){var f=function(){d._emit("loaderror",null,"Decoding audio data failed.")},g=function(y){y&&d._sounds.length>0?(i[d._src]=y,u(d,y)):f()};typeof Promise<"u"&&e.ctx.decodeAudioData.length===1?e.ctx.decodeAudioData(c).then(g).catch(f):e.ctx.decodeAudioData(c,g,f)},u=function(c,d){d&&!c._duration&&(c._duration=d.duration),Object.keys(c._sprite).length===0&&(c._sprite={__default:[0,c._duration*1e3]}),c._state!=="loaded"&&(c._state="loaded",c._emit("load"),c._loadQueue())},h=function(){if(e.usingWebAudio){try{typeof AudioContext<"u"?e.ctx=new AudioContext:typeof webkitAudioContext<"u"?e.ctx=new webkitAudioContext:e.usingWebAudio=!1}catch{e.usingWebAudio=!1}e.ctx||(e.usingWebAudio=!1);var c=/iP(hone|od|ad)/.test(e._navigator&&e._navigator.platform),d=e._navigator&&e._navigator.appVersion.match(/OS (\d+)_(\d+)_?(\d+)?/),f=d?parseInt(d[1],10):null;if(c&&f&&f<9){var g=/safari/.test(e._navigator&&e._navigator.userAgent.toLowerCase());e._navigator&&!g&&(e.usingWebAudio=!1)}e.usingWebAudio&&(e.masterGain=typeof e.ctx.createGain>"u"?e.ctx.createGainNode():e.ctx.createGain(),e.masterGain.gain.setValueAtTime(e._muted?0:e._volume,e.ctx.currentTime),e.masterGain.connect(e.ctx.destination)),e._setup()}};n.Howler=e,n.Howl=r,typeof bo<"u"?(bo.HowlerGlobal=t,bo.Howler=e,bo.Howl=r,bo.Sound=s):typeof window<"u"&&(window.HowlerGlobal=t,window.Howler=e,window.Howl=r,window.Sound=s)})();/*!
 *  Spatial Plugin - Adds support for stereo and 3D audio where Web Audio is supported.
 *  
 *  howler.js v2.2.4
 *  howlerjs.com
 *
 *  (c) 2013-2020, James Simpson of GoldFire Studios
 *  goldfirestudios.com
 *
 *  MIT License
 */(function(){HowlerGlobal.prototype._pos=[0,0,0],HowlerGlobal.prototype._orientation=[0,0,-1,0,1,0],HowlerGlobal.prototype.stereo=function(e){var r=this;if(!r.ctx||!r.ctx.listener)return r;for(var s=r._howls.length-1;s>=0;s--)r._howls[s].stereo(e);return r},HowlerGlobal.prototype.pos=function(e,r,s){var i=this;if(!i.ctx||!i.ctx.listener)return i;if(r=typeof r!="number"?i._pos[1]:r,s=typeof s!="number"?i._pos[2]:s,typeof e=="number")i._pos=[e,r,s],typeof i.ctx.listener.positionX<"u"?(i.ctx.listener.positionX.setTargetAtTime(i._pos[0],Howler.ctx.currentTime,.1),i.ctx.listener.positionY.setTargetAtTime(i._pos[1],Howler.ctx.currentTime,.1),i.ctx.listener.positionZ.setTargetAtTime(i._pos[2],Howler.ctx.currentTime,.1)):i.ctx.listener.setPosition(i._pos[0],i._pos[1],i._pos[2]);else return i._pos;return i},HowlerGlobal.prototype.orientation=function(e,r,s,i,o,a){var l=this;if(!l.ctx||!l.ctx.listener)return l;var u=l._orientation;if(r=typeof r!="number"?u[1]:r,s=typeof s!="number"?u[2]:s,i=typeof i!="number"?u[3]:i,o=typeof o!="number"?u[4]:o,a=typeof a!="number"?u[5]:a,typeof e=="number")l._orientation=[e,r,s,i,o,a],typeof l.ctx.listener.forwardX<"u"?(l.ctx.listener.forwardX.setTargetAtTime(e,Howler.ctx.currentTime,.1),l.ctx.listener.forwardY.setTargetAtTime(r,Howler.ctx.currentTime,.1),l.ctx.listener.forwardZ.setTargetAtTime(s,Howler.ctx.currentTime,.1),l.ctx.listener.upX.setTargetAtTime(i,Howler.ctx.currentTime,.1),l.ctx.listener.upY.setTargetAtTime(o,Howler.ctx.currentTime,.1),l.ctx.listener.upZ.setTargetAtTime(a,Howler.ctx.currentTime,.1)):l.ctx.listener.setOrientation(e,r,s,i,o,a);else return u;return l},Howl.prototype.init=function(e){return function(r){var s=this;return s._orientation=r.orientation||[1,0,0],s._stereo=r.stereo||null,s._pos=r.pos||null,s._pannerAttr={coneInnerAngle:typeof r.coneInnerAngle<"u"?r.coneInnerAngle:360,coneOuterAngle:typeof r.coneOuterAngle<"u"?r.coneOuterAngle:360,coneOuterGain:typeof r.coneOuterGain<"u"?r.coneOuterGain:0,distanceModel:typeof r.distanceModel<"u"?r.distanceModel:"inverse",maxDistance:typeof r.maxDistance<"u"?r.maxDistance:1e4,panningModel:typeof r.panningModel<"u"?r.panningModel:"HRTF",refDistance:typeof r.refDistance<"u"?r.refDistance:1,rolloffFactor:typeof r.rolloffFactor<"u"?r.rolloffFactor:1},s._onstereo=r.onstereo?[{fn:r.onstereo}]:[],s._onpos=r.onpos?[{fn:r.onpos}]:[],s._onorientation=r.onorientation?[{fn:r.onorientation}]:[],e.call(this,r)}}(Howl.prototype.init),Howl.prototype.stereo=function(e,r){var s=this;if(!s._webAudio)return s;if(s._state!=="loaded")return s._queue.push({event:"stereo",action:function(){s.stereo(e,r)}}),s;var i=typeof Howler.ctx.createStereoPanner>"u"?"spatial":"stereo";if(typeof r>"u")if(typeof e=="number")s._stereo=e,s._pos=[e,0,0];else return s._stereo;for(var o=s._getSoundIds(r),a=0;a<o.length;a++){var l=s._soundById(o[a]);if(l)if(typeof e=="number")l._stereo=e,l._pos=[e,0,0],l._node&&(l._pannerAttr.panningModel="equalpower",(!l._panner||!l._panner.pan)&&t(l,i),i==="spatial"?typeof l._panner.positionX<"u"?(l._panner.positionX.setValueAtTime(e,Howler.ctx.currentTime),l._panner.positionY.setValueAtTime(0,Howler.ctx.currentTime),l._panner.positionZ.setValueAtTime(0,Howler.ctx.currentTime)):l._panner.setPosition(e,0,0):l._panner.pan.setValueAtTime(e,Howler.ctx.currentTime)),s._emit("stereo",l._id);else return l._stereo}return s},Howl.prototype.pos=function(e,r,s,i){var o=this;if(!o._webAudio)return o;if(o._state!=="loaded")return o._queue.push({event:"pos",action:function(){o.pos(e,r,s,i)}}),o;if(r=typeof r!="number"?0:r,s=typeof s!="number"?-.5:s,typeof i>"u")if(typeof e=="number")o._pos=[e,r,s];else return o._pos;for(var a=o._getSoundIds(i),l=0;l<a.length;l++){var u=o._soundById(a[l]);if(u)if(typeof e=="number")u._pos=[e,r,s],u._node&&((!u._panner||u._panner.pan)&&t(u,"spatial"),typeof u._panner.positionX<"u"?(u._panner.positionX.setValueAtTime(e,Howler.ctx.currentTime),u._panner.positionY.setValueAtTime(r,Howler.ctx.currentTime),u._panner.positionZ.setValueAtTime(s,Howler.ctx.currentTime)):u._panner.setPosition(e,r,s)),o._emit("pos",u._id);else return u._pos}return o},Howl.prototype.orientation=function(e,r,s,i){var o=this;if(!o._webAudio)return o;if(o._state!=="loaded")return o._queue.push({event:"orientation",action:function(){o.orientation(e,r,s,i)}}),o;if(r=typeof r!="number"?o._orientation[1]:r,s=typeof s!="number"?o._orientation[2]:s,typeof i>"u")if(typeof e=="number")o._orientation=[e,r,s];else return o._orientation;for(var a=o._getSoundIds(i),l=0;l<a.length;l++){var u=o._soundById(a[l]);if(u)if(typeof e=="number")u._orientation=[e,r,s],u._node&&(u._panner||(u._pos||(u._pos=o._pos||[0,0,-.5]),t(u,"spatial")),typeof u._panner.orientationX<"u"?(u._panner.orientationX.setValueAtTime(e,Howler.ctx.currentTime),u._panner.orientationY.setValueAtTime(r,Howler.ctx.currentTime),u._panner.orientationZ.setValueAtTime(s,Howler.ctx.currentTime)):u._panner.setOrientation(e,r,s)),o._emit("orientation",u._id);else return u._orientation}return o},Howl.prototype.pannerAttr=function(){var e=this,r=arguments,s,i,o;if(!e._webAudio)return e;if(r.length===0)return e._pannerAttr;if(r.length===1)if(typeof r[0]=="object")s=r[0],typeof i>"u"&&(s.pannerAttr||(s.pannerAttr={coneInnerAngle:s.coneInnerAngle,coneOuterAngle:s.coneOuterAngle,coneOuterGain:s.coneOuterGain,distanceModel:s.distanceModel,maxDistance:s.maxDistance,refDistance:s.refDistance,rolloffFactor:s.rolloffFactor,panningModel:s.panningModel}),e._pannerAttr={coneInnerAngle:typeof s.pannerAttr.coneInnerAngle<"u"?s.pannerAttr.coneInnerAngle:e._coneInnerAngle,coneOuterAngle:typeof s.pannerAttr.coneOuterAngle<"u"?s.pannerAttr.coneOuterAngle:e._coneOuterAngle,coneOuterGain:typeof s.pannerAttr.coneOuterGain<"u"?s.pannerAttr.coneOuterGain:e._coneOuterGain,distanceModel:typeof s.pannerAttr.distanceModel<"u"?s.pannerAttr.distanceModel:e._distanceModel,maxDistance:typeof s.pannerAttr.maxDistance<"u"?s.pannerAttr.maxDistance:e._maxDistance,refDistance:typeof s.pannerAttr.refDistance<"u"?s.pannerAttr.refDistance:e._refDistance,rolloffFactor:typeof s.pannerAttr.rolloffFactor<"u"?s.pannerAttr.rolloffFactor:e._rolloffFactor,panningModel:typeof s.pannerAttr.panningModel<"u"?s.pannerAttr.panningModel:e._panningModel});else return o=e._soundById(parseInt(r[0],10)),o?o._pannerAttr:e._pannerAttr;else r.length===2&&(s=r[0],i=parseInt(r[1],10));for(var a=e._getSoundIds(i),l=0;l<a.length;l++)if(o=e._soundById(a[l]),o){var u=o._pannerAttr;u={coneInnerAngle:typeof s.coneInnerAngle<"u"?s.coneInnerAngle:u.coneInnerAngle,coneOuterAngle:typeof s.coneOuterAngle<"u"?s.coneOuterAngle:u.coneOuterAngle,coneOuterGain:typeof s.coneOuterGain<"u"?s.coneOuterGain:u.coneOuterGain,distanceModel:typeof s.distanceModel<"u"?s.distanceModel:u.distanceModel,maxDistance:typeof s.maxDistance<"u"?s.maxDistance:u.maxDistance,refDistance:typeof s.refDistance<"u"?s.refDistance:u.refDistance,rolloffFactor:typeof s.rolloffFactor<"u"?s.rolloffFactor:u.rolloffFactor,panningModel:typeof s.panningModel<"u"?s.panningModel:u.panningModel};var h=o._panner;h||(o._pos||(o._pos=e._pos||[0,0,-.5]),t(o,"spatial"),h=o._panner),h.coneInnerAngle=u.coneInnerAngle,h.coneOuterAngle=u.coneOuterAngle,h.coneOuterGain=u.coneOuterGain,h.distanceModel=u.distanceModel,h.maxDistance=u.maxDistance,h.refDistance=u.refDistance,h.rolloffFactor=u.rolloffFactor,h.panningModel=u.panningModel}return e},Sound.prototype.init=function(e){return function(){var r=this,s=r._parent;r._orientation=s._orientation,r._stereo=s._stereo,r._pos=s._pos,r._pannerAttr=s._pannerAttr,e.call(this),r._stereo?s.stereo(r._stereo):r._pos&&s.pos(r._pos[0],r._pos[1],r._pos[2],r._id)}}(Sound.prototype.init),Sound.prototype.reset=function(e){return function(){var r=this,s=r._parent;return r._orientation=s._orientation,r._stereo=s._stereo,r._pos=s._pos,r._pannerAttr=s._pannerAttr,r._stereo?s.stereo(r._stereo):r._pos?s.pos(r._pos[0],r._pos[1],r._pos[2],r._id):r._panner&&(r._panner.disconnect(0),r._panner=void 0,s._refreshBuffer(r)),e.call(this)}}(Sound.prototype.reset);var t=function(e,r){r=r||"spatial",r==="spatial"?(e._panner=Howler.ctx.createPanner(),e._panner.coneInnerAngle=e._pannerAttr.coneInnerAngle,e._panner.coneOuterAngle=e._pannerAttr.coneOuterAngle,e._panner.coneOuterGain=e._pannerAttr.coneOuterGain,e._panner.distanceModel=e._pannerAttr.distanceModel,e._panner.maxDistance=e._pannerAttr.maxDistance,e._panner.refDistance=e._pannerAttr.refDistance,e._panner.rolloffFactor=e._pannerAttr.rolloffFactor,e._panner.panningModel=e._pannerAttr.panningModel,typeof e._panner.positionX<"u"?(e._panner.positionX.setValueAtTime(e._pos[0],Howler.ctx.currentTime),e._panner.positionY.setValueAtTime(e._pos[1],Howler.ctx.currentTime),e._panner.positionZ.setValueAtTime(e._pos[2],Howler.ctx.currentTime)):e._panner.setPosition(e._pos[0],e._pos[1],e._pos[2]),typeof e._panner.orientationX<"u"?(e._panner.orientationX.setValueAtTime(e._orientation[0],Howler.ctx.currentTime),e._panner.orientationY.setValueAtTime(e._orientation[1],Howler.ctx.currentTime),e._panner.orientationZ.setValueAtTime(e._orientation[2],Howler.ctx.currentTime)):e._panner.setOrientation(e._orientation[0],e._orientation[1],e._orientation[2])):(e._panner=Howler.ctx.createStereoPanner(),e._panner.pan.setValueAtTime(e._stereo,Howler.ctx.currentTime)),e._panner.connect(e._node),e._paused||e._parent.pause(e._id,!0).play(e._id,!0)}})()}(lu)),lu}var jt=DE();const{random:Sd,round:ME}=Math,Uv=.6,ft={bleep:new jt.Howl({src:"/sounds/bleep.wav"}),blink:new jt.Howl({src:"/sounds/blink.wav",rate:Uv}),gameOver:new jt.Howl({src:"/sounds/game-over.wav"}),generate:new jt.Howl({src:"/sounds/generate.wav"}),hit:new jt.Howl({src:"/sounds/hit.wav"}),kicks:[new jt.Howl({src:"/sounds/kick-1.wav"}),new jt.Howl({src:"/sounds/kick-2.wav"})],lowEnergy:new jt.Howl({src:"/sounds/low-energy.wav"}),plus:new jt.Howl({src:"/sounds/plus.wav"}),slideIn:new jt.Howl({src:"/sounds/slide-in.wav"}),slideMove:new jt.Howl({src:"/sounds/slide-move.wav"}),slideOut:new jt.Howl({src:"/sounds/slide-out.wav"}),turnOn:new jt.Howl({src:"/sounds/turn-on.wav"}),wordUp:new jt.Howl({src:"/sounds/word-up.wav"})};function LE(){ft.bleep.play()}function BE(){const n=(t=.02)=>{ft.blink.rate(ft.blink.rate()+t),ft.blink.play()};n(),setTimeout(n,200),setTimeout(()=>n(.04),400)}function Ed(){ft.lowEnergy.play()}function Vv(){ft.plus.play()}function NE(){ft.gameOver.play()}function RE(){ft.generate.play()}function Hv(n=0){ft.hit.rate(1-(n||10)/36),ft.hit.play()}function OE(){const n=ft.kicks[ME(Sd())];n.rate(1-(Sd()-.5)/2),n.play()}function FE(){ft.newRecord.play()}function Ad(){ft.slideIn.play()}function xd(n=0){ft.slideMove.rate(1+n/27),ft.slideMove.play()}function zv(){ft.slideOut.play()}function $E(){ft.turnOn.rate(1-(Sd()-.5)/10),ft.turnOn.play()}function qv(){ft.wordUp.play()}function UE(){ft.blink.rate(Uv)}const VE=Object.freeze(Object.defineProperty({__proto__:null,playBleep:LE,playBlink:BE,playGameOver:NE,playGenerate:RE,playHit:Hv,playKick:OE,playLowEnergy:Ed,playNewRecord:FE,playPlus:Vv,playSlideIn:Ad,playSlideMove:xd,playSlideOut:zv,playTurnOn:$E,playWordUp:qv,reset:UE},Symbol.toStringTag,{value:"Module"}));function Gh(n){return new Promise((t,e)=>{n.oncomplete=n.onsuccess=()=>t(n.result),n.onabort=n.onerror=()=>e(n.error)})}function Wv(n,t){const e=indexedDB.open(n);e.onupgradeneeded=()=>e.result.createObjectStore(t);const r=Gh(e);return(s,i)=>r.then(o=>i(o.transaction(t,s).objectStore(t)))}let uu;function Gv(){return uu||(uu=Wv("keyval-store","keyval")),uu}function Tp(n,t=Gv()){return t("readonly",e=>Gh(e.get(n)))}function Cp(n,t,e=Gv()){return e("readwrite",r=>(r.put(t,n),Gh(r.transaction)))}function El(n,t){const e=mt(t),r=localStorage.getItem(n);return r?e.set(JSON.parse(r)):localStorage.setItem(n,JSON.stringify(t)),{set(s){localStorage.setItem(n,JSON.stringify(s)),e.set(s)},update(s){this.set(s(Oe(this)))},subscribe:e.subscribe}}function HE(n,t){const e=Wv(n,t);return function(s,i){const o=mt(i);return Tp(s,e).then(a=>{if(a===void 0&&i!==void 0){Cp(s,i,e);return}a!==i&&o.set(a)}),{set(a){Cp(s,a,e).then(()=>o.set(a))},update(a){Tp(s,e).then(l=>this.set(a(l)))},subscribe:o.subscribe}}}const Kv=mt($e.cards),Al=mt($e.energy),ba=mt($e.log),Yv=mt($e.matchedIndexes),zE=El($.moves,$e.moves),Ft=El($.options,$e.options),Fr=mt($e.phase),Id=mt($e.plusIndex),wa=El($.records,$e.records),xl=mt($e.score),Kh=El($.timestamp,Date.now()),_a=kv([Ft,Kh],([{playerName:n},t])=>Wh({playerName:n,timestamp:t})),Bs={cards:Kv,energy:Al,log:ba,matchedIndexes:Yv,moves:zE,options:Ft,phase:Fr,plusIndex:Id,records:wa,score:xl,seed:_a,timestamp:Kh,ready:!0};function wo(n,t=0){return Mn(Bs,n,t)}function gr(n,{muteRapid:t=!1}={}){return or(Bs,n,{muteRapid:t})}function Yh(n){_t.set(null),TE(Bs,n)}const Xt=kv([ba,Ft,_a],([n,{rapid:t},e])=>{if(!t)return[];if(e!==Xt.seed&&(Xt.seed=e,Xt.prev=[],Xt.rows=[]),n.length===0){const r=Nv(Xt.prev);r&&(Xt.rows=[...Xt.rows,{combo:r,key:performance.now()}],gr(qv),Xt.rows.length>7&&(Xt.rows=Xt.rows.slice(-7)))}else Xt.prev=n;return Xt.rows}),_t=mt($e.overlay);var qE=ce('<div tabindex="0" role="button"><!> <div></div> <div></div></div>');function Qv(n,t){if(new.target)return Ut({component:Qv,...n});kt(t,!1);const[e,r]=wn(),s=()=>ge(Kv,"$cards",e),i=()=>ge(Id,"$plusIndex",e),o=()=>ge(Fr,"$phase",e),a=()=>ge(Yv,"$matchedIndexes",e),l=()=>ge(Ft,"$options",e),u=()=>ge(ba,"$log",e),h=Q(),c=Q(),d=Q(),f=Q(),g=Q(),y=Q(),m=Q(),v=Q(),_=Q();let w=Q(null),S=null,A=Q(void 0),E=Q(null),I=Q(null),k=Q(null);function x(){return!!b(w)}function U({x:H=0,y:ne=0}={}){if(!b(c))return{};if(D(),b(w)){S=b(w),H+=b(w).x,ne+=b(w).y;const De=H<0?qe.columns-1:H%qe.columns,Pt=ne<0?qe.rows-1:ne%qe.rows;return N({x:De,y:Pt,topEdge:Pt===0&&S&&S.y===qe.rows-1,bottomEdge:Pt===qe.rows-1&&S&&S.y===0})}if(H!==0)return S?(newValue={x:H>0?0:qe.columns-1,y:S.y},S=null,N(newValue)):N({x:Math.round(qe.columns/2)+H+(H>0?-1:0),y:Math.round(qe.rows/2)+(H>0?0:-1)});if(ne!==0){if(S){const De={x:S.x,y:ne>0?0:qe.rows-1};return S=null,N(De)}return N({x:Math.round(qe.columns/2)+(ne>0?-1:0),y:Math.round(qe.rows/2)+ne+(ne>0?-1:0)})}return b(w)||{}}function B(){if(!x())return;S=null;const H=s().findIndex(({x:ne,y:De})=>ne===b(w).x&&De===b(w).y);H!==-1&&(xt(Id,H),!b(g)&&gr(Vv,{muteRapid:!0}))}function N(H){x()||gr(Ad);const ne=b(_)[H.x][H.y];return gr(()=>xd(s()[ne].value)),M(w,H)}function z({savePrev:H=!1,muteSound:ne=!1}={}){x()&&(S=H?b(w):null,M(w,null),ne||gr(zv))}function D(){_s(I,b(I).style.animation="none"),b(I).offsetHeight,_s(I,b(I).style.animation=null),_s(k,b(k).style.animation="none"),b(k).offsetHeight,_s(k,b(k).style.animation=null)}function L(H){if(b(g)||b(A)!==void 0)return;x()||gr(Ad);const ne=s()[H];ne!==b(w)&&(D(),gr(()=>xd(ne.value)),S=b(w),M(w,ne))}function P(H){if(H===b(E))return;if(H.classList.contains("card"))return H;const ne=H.querySelector(".card");if(ne)return ne;let De=H.parentElement;for(;De;){if(De.classList.contains("card"))return De;De=De.parentElement}}function T(H){const ne=P(H.target);return ne&&Number(ne.dataset.index)}function C(H){if(!Bs.ready)return;const ne=T(H);ne>-1&&L(ne)}function R(H){z({muteSound:o()!==se.idle})}function O(H){if(b(g))return;const ne=T(H.detail);ne!==void 0&&(L(ne),b(h)||M(A,ne),H.detail.type==="mousedown"&&(gr(()=>Hv(s()[ne].value),{}),b(h)&&B()))}function V(H){b(h)||T(H.detail)!==b(A)||(M(A,void 0),B(),z())}function K(H){b(h)||M(A,void 0)}function ee(H){H.preventDefault()}_a.subscribe(()=>z({muteSound:!0})),ae(()=>a(),()=>{a().size>0&&z({muteSound:!0})}),ae(()=>(b(h),l()),()=>{(H=>M(h,H.rapid))(l())}),ae(()=>(o(),se),()=>{M(c,o()===se.idle)}),ae(()=>(a(),u()),()=>{M(d,a().size>0&&u().length===1)}),ae(()=>(b(c),b(d)),()=>{M(f,!b(c)&&!b(d))}),ae(()=>(b(c),i()),()=>{M(g,!b(c)||i()!==void 0)}),ae(()=>(s(),i()),()=>{M(y,s()[i()])}),ae(()=>(b(m),b(y),b(w)),()=>{M(m,b(y)||b(w)||b(m))}),ae(()=>(b(y),b(w),b(d)),()=>{M(v,b(y)||b(w)||b(d))}),ae(()=>s(),()=>{M(_,_l(s()))}),dr(),Vt();var Y=qE();let le;var re=G(Y);Ts(re,1,s,Oi,(H,ne,De)=>{const Pt=Nt(()=>b(ne).x===(b(w)&&b(w).x)&&b(ne).y===(b(w)&&b(w).y)),po=Nt(()=>a().has(De)),Hr=Nt(()=>b(A)===De),ei=Nt(()=>i()===De);$v(H,{get card(){return b(ne)},index:De,get focus(){return b(Pt)},get blink(){return b(po)},get longpress(){return b(Hr)},get plus(){return b(ei)}})});var be=J(re,2);let q;ht(be,H=>M(I,H),()=>b(I));var ue=J(be,2);let Ee;ht(ue,H=>M(k,H),()=>b(k)),W(Y),Tn(()=>Be("mousemove",Y,C)),Tn(()=>Be("mouseleave",Y,R)),Tn(()=>Be("longpressstart",Y,O)),Tn(()=>Be("longpressfire",Y,V)),Tn(()=>Be("longpressend",Y,K)),Tn(()=>Be("dblclick",Y,ee)),VS(Y,H=>PE?.(H)),ht(Y,H=>M(E,H),()=>b(E)),Ze(()=>{le=nt(Y,1,"board",null,le,{overflow:b(f),progress:b(g)}),gn(Y,"--focus-x",b(m)&&b(m).x),gn(Y,"--focus-y",b(m)&&b(m).y),q=nt(be,1,"slider horizontal",null,q,{blink:b(d),focus:b(v)}),Ee=nt(ue,1,"slider vertical",null,Ee,{blink:b(d),focus:b(v)})}),oe(n,Y),Ae(t,"isFocused",x),Ae(t,"shiftFocus",U),Ae(t,"plusFocusedCard",B),Ae(t,"focusCard",N),Ae(t,"blur",z);var we=Tt({isFocused:x,shiftFocus:U,plusFocusedCard:B,focusCard:N,blur:z,$set:zt,$on:(H,ne)=>Ht(t,H,ne)});return r(),we}var WE=ce('<div class="energy"><div><span> </span></div> <div><span> </span></div></div>');function Qh(n,t){if(new.target)return Ut({component:Qh,...n});kt(t,!1);const[e,r]=wn(),s=()=>ge(Al,"$energy",e),i=()=>ge(Fr,"$phase",e),o=Q(),a=Q(),l=Q(),u=Q(),h=Q(),c=Q(),d=Q();ae(()=>(b(o),s()),()=>{(x=>M(o,x.value))(s())}),ae(()=>b(o),()=>{M(a,b(o)>100)}),ae(()=>(b(o),i(),se),()=>{M(l,b(o)<20&&i()===se.idle)}),ae(()=>(b(l),Ed),()=>{b(l)&&gr(Ed)}),ae(()=>(b(a),b(o)),()=>{M(u,`
    z-index: ${b(a)?0:1};
    flex: ${(b(a)?200-b(o):b(o))/100};
  `)}),ae(()=>b(a),()=>{M(h,`
    position: ${b(a)?"absolute":"relative"};
  `)}),ae(()=>(b(a),b(o)),()=>{M(c,`
    z-index: ${b(a)?1:0};
    flex: ${b(a)?(b(o)-100)/100:0};
  `)}),ae(()=>(b(a),b(o)),()=>{M(d,`
    position: ${b(a)?"relative":"absolute"};
    left: ${b(a)?`calc(${b(o)>119?0:(b(o)-120)/100} * 128rem)`:0};
  `)}),dr(),Vt();var f=WE(),g=G(f);let y;var m=G(g);let v;var _=G(m,!0);W(m),W(g);var w=J(g,2);let S;var A=G(w);let E;var I=G(A,!0);W(A),W(w),W(f),Ze(()=>{y=nt(g,1,"left-bar",null,y,{warning:b(l)}),Ot(g,"style",b(u)),v=nt(m,1,"left-value",null,v,{warning:b(l)}),Ot(m,"style",b(h)),st(_,b(o)),S=nt(w,1,"right-bar",null,S,{extra:b(a)}),Ot(w,"style",b(c)),E=nt(A,1,"right-value",null,E,{warning:b(l)}),Ot(A,"style",b(d)),st(I,b(o))}),oe(n,f);var k=Tt({$set:zt,$on:(x,U)=>Ht(t,x,U)});return r(),k}const GE=n=>n;function jv(n){const t=n-1;return t*t*t+1}function KE(n){return n<.5?4*n*n*n:.5*Math.pow(2*n-2,3)+1}function kd(n){const t=typeof n=="string"&&n.match(/^\s*(-?[\d.]+)([^\s]*)\s*$/);return t?[parseFloat(t[1]),t[2]||"px"]:[n,"px"]}function Tr(n,{delay:t=0,duration:e=400,easing:r=KE,amount:s=5,opacity:i=0}={}){const o=getComputedStyle(n),a=+o.opacity,l=o.filter==="none"?"":o.filter,u=a*(1-i),[h,c]=kd(s);return{delay:t,duration:e,easing:r,css:(d,f)=>`opacity: ${a-u*f}; filter: ${l} blur(${f*h}${c});`}}function ec(n,{delay:t=0,duration:e=400,easing:r=GE}={}){const s=+getComputedStyle(n).opacity;return{delay:t,duration:e,easing:r,css:i=>`opacity: ${i*s}`}}function tr(n,{delay:t=0,duration:e=400,easing:r=jv,x:s=0,y:i=0,opacity:o=0}={}){const a=getComputedStyle(n),l=+a.opacity,u=a.transform==="none"?"":a.transform,h=l*(1-o),[c,d]=kd(s),[f,g]=kd(i);return{delay:t,duration:e,easing:r,css:(y,m)=>`
			transform: ${u} translate(${(1-y)*c}${d}, ${(1-y)*f}${g});
			opacity: ${l-h*m}`}}function Pp(n,{delay:t=0,duration:e=400,easing:r=jv,axis:s="y"}={}){const i=getComputedStyle(n),o=+i.opacity,a=s==="y"?"height":"width",l=parseFloat(i[a]),u=s==="y"?["top","bottom"]:["left","right"],h=u.map(v=>`${v[0].toUpperCase()}${v.slice(1)}`),c=parseFloat(i[`padding${h[0]}`]),d=parseFloat(i[`padding${h[1]}`]),f=parseFloat(i[`margin${h[0]}`]),g=parseFloat(i[`margin${h[1]}`]),y=parseFloat(i[`border${h[0]}Width`]),m=parseFloat(i[`border${h[1]}Width`]);return{delay:t,duration:e,easing:r,css:v=>`overflow: hidden;opacity: ${Math.min(v*20,1)*o};${a}: ${v*l}px;padding-${u[0]}: ${v*c}px;padding-${u[1]}: ${v*d}px;margin-${u[0]}: ${v*f}px;margin-${u[1]}: ${v*g}px;border-${u[0]}-width: ${v*y}px;border-${u[1]}-width: ${v*m}px;min-${a}: 0`}}var YE=ce('<span class="plus">+</span>'),QE=ce('<span class="value"> </span> <!>',1),jE=ce('<span class="counts"> </span>'),ZE=ce('<span>]</span> <!> <span>=</span> <span class="sum svelte-1tsj7my"> </span>',1),XE=ce('<span class="extra svelte-1tsj7my"> </span> <span>]=</span> <span class="sum svelte-1tsj7my"> </span>',1),JE=ce('<li class="row svelte-1tsj7my"><span></span> <span>[</span> <!> <!></li>'),eA=ce("<span> </span>"),tA=ce('<li><!> <span class="sum svelte-1tsj7my"> </span></li>'),nA=ce('<span class="combo svelte-1tsj7my"> </span>'),rA=ce('<ol class="log svelte-1tsj7my"><!> <!> <!></ol>');function Zv(n,t){if(new.target)return Ut({component:Zv,...n});kt(t,!1);const[e,r]=wn(),s=()=>ge(Fr,"$phase",e),i=()=>ge(ba,"$log",e),o=()=>ge(xl,"$score",e),a=()=>ge(Xt,"$combos",e);function l(m=[]){let{length:v}=m;return v<1?"":(v>4&&(v=4),m.reduce((_,w,S)=>_+`--clr-${S+1}: var(--color-${w});`,`animation: colors-${v} ${200+200*v}ms steps(2, end) infinite;`))}Vt();var u=rA(),h=G(u);{var c=m=>{var v=wl(),_=on(v);Ts(_,1,i,Oi,(w,S,A)=>{let E=()=>b(S).digits,I=()=>b(S).counts,k=()=>b(S).extra,x=()=>b(S).sum,U=()=>ES(b(S),["digits","counts","extra","sum"]);var B=JE();const N=Nt(()=>Object.keys(U()));var z=G(B);z.textContent=A+1;var D=J(z,4);Ts(D,1,()=>b(N),Oi,(C,R,O)=>{var V=QE(),K=on(V),ee=G(K,!0);W(K);var Y=J(K,2);{var le=re=>{var be=YE();oe(re,be)};Ve(Y,re=>{O<b(N).length-1&&re(le)})}Ze(()=>{gn(K,"color",`var(--color-${b(R)??""})`),st(ee,U()[b(R)])}),oe(C,V)});var L=J(D,2);{var P=C=>{var R=ZE(),O=J(on(R),2);{var V=Y=>{var le=jE(),re=G(le,!0);W(le),Ze(be=>{Ot(le,"style",be),st(re,I())},[()=>l(E())],Nt),oe(Y,le)};Ve(O,Y=>{I()>1&&Y(V)})}var K=J(O,4),ee=G(K,!0);W(K),Ze(()=>st(ee,(A+1)*x()*I())),oe(C,R)},T=C=>{var R=XE(),O=on(R),V=G(O,!0);W(O);var K=J(O,4),ee=G(K,!0);W(K),Ze(()=>{st(V,k()),st(ee,(A+1)*k())}),oe(C,R)};Ve(L,C=>{k()===void 0?C(P):C(T,!1)})}W(B),Ye(1,B,()=>Pp,()=>wo({duration:100})),Ye(2,B,()=>ec,()=>wo({duration:200})),oe(w,B)}),oe(m,v)};Ve(h,m=>{s()!==se.score&&m(c)})}var d=J(h,2);{var f=m=>{var v=tA();const _=Nt(()=>i().length===1);let w;var S=G(v);{var A=k=>{var x=eA(),U=G(x,!0);W(x),Ze(()=>st(U,b(_)?"":"combo:")),Ye(2,x,()=>ec,()=>wo({duration:200})),oe(k,x)};Ve(S,k=>{s()===se.combo&&k(A)})}var E=J(S,2),I=G(E);W(E),W(v),Ze(()=>{w=nt(v,1,"svelte-1tsj7my",null,w,{collapse:b(_)}),st(I,`${(s()===se.score&&o().buffer>0?"+":"")??""}${o().buffer??""}`)}),Ye(1,v,()=>Pp,()=>wo({duration:b(_)?0:100})),Ye(2,v,()=>ec,()=>wo({duration:200})),oe(m,v)};Ve(d,m=>{(s()===se.combo||s()===se.score)&&m(f)})}var g=J(d,2);Ts(g,1,a,({combo:m,key:v})=>v,(m,v)=>{let _=()=>b(v).combo;var w=nA(),S=G(w);W(w),Ze(()=>st(S,`+${_()??""}`)),oe(m,w)}),W(u),oe(n,u);var y=Tt({$set:zt,$on:(m,v)=>Ht(t,m,v)});return r(),y}var sA=ce('<span class="value"> </span>'),iA=ce('<span tabindex="0" role="button"><span> </span> <!></span>');function jh(n,t){if(new.target)return Ut({component:jh,...n});kt(t,!1);const[e,r]=wn(),s=()=>ge(xl,"$score",e),i=()=>ge(wa,"$records",e),o=()=>ge(Fr,"$phase",e),a=Q(),l=Q();let u=At(t,"newRecordHighCombo",12,!1),h=At(t,"newRecordHighScore",12,!1),c=At(t,"newRecord",12,!1),d=At(t,"overlaid",12,!1);const f={[$.highCombo]:"hi-combo",[$.highScore]:"hi-score",[$.score]:"score"};let g=Q($.score),y,m=Q(!1),v=Q(!1);function _(){return b(v)}function w(){M(v,!0)}function S(){M(v,!1)}function A(){M(g,I(b(g))),k()}function E(){M(g,I(b(g),!0)),k()}function I(N,z=!1){return c()?{[$.highScore]:u()?$.highCombo:$.highScore,[$.highCombo]:h()?$.highScore:$.highCombo}[N]:z?{[$.score]:$.highCombo,[$.highScore]:$.score,[$.highCombo]:$.highScore}[N]:{[$.score]:$.highScore,[$.highScore]:$.highCombo,[$.highCombo]:$.score}[N]}function k(){M(m,!0),clearTimeout(y),!c()&&(y=setTimeout(()=>{M(g,$.score),M(m,c())},3200))}ae(()=>(kn(c()),kn(h()),$),()=>{c()&&(M(g,h()?$.highScore:$.highCombo),M(m,!0))}),ae(()=>(b(g),s(),i()),()=>{M(a,b(g)===$.score?s().value:i()[b(g)][$.value])}),ae(()=>(b(a),i(),$),()=>{M(l,"score: "+b(a)+`
high score: `+i()[$.highScore][$.value]+`
high combo: `+i()[$.highCombo][$.value])}),dr(),Vt();var x=wl(),U=on(x);OS(U,()=>b(g),N=>{var z=iA();let D;var L=G(z);let P;var T=G(L);W(L);var C=J(L,2);{var R=O=>{var V=sA(),K=G(V,!0);W(V),Ze(()=>st(K,b(a))),oe(O,V)};Ve(C,O=>{(d()||o()!==se.gameOver)&&O(R)})}W(z),Ze(()=>{D=nt(z,1,"score",null,D,{focus:b(v)}),Ot(z,"title",b(l)),P=nt(L,1,"type",null,P,{visible:b(m)}),st(T,`${f[b(g)]??""}:`)}),Ye(1,z,()=>Tr),Be("click",z,Hh(A)),oe(N,z)}),oe(n,x),Ae(t,"isFocused",_),Ae(t,"focus",w),Ae(t,"blur",S),Ae(t,"nextType",A),Ae(t,"prevType",E);var B=Tt({isFocused:_,focus:w,blur:S,nextType:A,prevType:E,get newRecordHighCombo(){return u()},set newRecordHighCombo(N){u(N),yt()},get newRecordHighScore(){return h()},set newRecordHighScore(N){h(N),yt()},get newRecord(){return c()},set newRecord(N){c(N),yt()},get overlaid(){return d()},set overlaid(N){d(N),yt()},$set:zt,$on:(N,z)=>Ht(t,N,z)});return r(),B}var oA=ce('<span class="rapid">rapid</span>'),aA=ce('<div class="section-1"><button title="[open menu]"><h1>digifall <!></h1> <!></button></div> <div class="section-2"><!></div> <div class="section-3"><!></div> <div class="section-4"><!></div>',1),cA=ce('<div><div class="seedground"></div> <div class="content"><!></div></div>');function Xv(n,t){if(new.target)return Ut({component:Xv,...n});kt(t,!1);const[e,r]=wn(),s=()=>ge(ba,"$log",e),i=()=>ge(Xt,"$combos",e),o=()=>ge(_t,"$overlay",e),a=()=>ge(_a,"$seed",e),l=()=>ge(Ft,"$options",e),u=Q();let h=Q(null),c=Q(null),d=Q(null);function f(){b(h).isFocused()?(b(h).blur(),b(d).shiftFocus({y:1})):b(c).isFocused()?(b(c).blur(),b(h).focus()):b(d).shiftFocus({y:1}).topEdge&&(b(d).blur({savePrev:!0}),b(c).focus())}function g(){b(h).isFocused()?(b(h).blur(),b(c).focus()):b(c).isFocused()?(b(c).blur(),b(d).shiftFocus({y:-1})):b(d).shiftFocus({y:-1}).bottomEdge&&(b(d).blur({savePrev:!0}),b(h).focus())}function y(){b(h).isFocused()||(b(c).isFocused()?b(c).prevType():b(d).shiftFocus({x:-1}))}function m(){b(h).isFocused()||(b(c).isFocused()?b(c).nextType():b(d).shiftFocus({x:1}))}function v(){b(h).isFocused()?(b(h).click(),b(h).blur(),b(d).blur({savePrev:!0})):b(c).isFocused()?b(c).nextType():b(d).plusFocusedCard()}function _(){b(h).blur(),b(c).blur(),b(d).blur()}function w(B){if(!B)return;const N=()=>B=bc(B),z=(V=13)=>`hsl(${N()%360},50%,${V}%)`,D=[2,3,5,7,11,13,17,19,23,29,31,37,41,43,47,53,59,61,67,71,73,79,83,89,97,101,103,107,109,113,127,131,137,139,149];let L=4;const P=[];for(;L--;){const[V]=D.splice(N()%D.length,1);P.push(V)}const[T,C,R,O]=P;return`
      background-color: var(--color-dark);
      background-image:
        linear-gradient(90deg, ${z()} 50%, transparent 50%),
        linear-gradient(90deg, ${z()} 50%, transparent 50%),
        linear-gradient(90deg, transparent 50%, ${z()} 50%),
        linear-gradient(90deg, transparent 50%, ${z()} 50%);
      background-size: ${T}rem, ${C}rem, ${R}rem, ${O}rem;`}ae(()=>b(h),()=>{b(h)&&(_s(h,b(h).isFocused=()=>b(h).classList.contains("focus")),_s(h,b(h).focus=()=>b(h).classList.add("focus")),_s(h,b(h).blur=()=>b(h).classList.remove("focus")))}),ae(()=>(s(),i()),()=>{M(u,s().length>0||i().length>0)}),dr(),Vt();var S=cA();let A;var E=G(S),I=J(E,2),k=G(I);{var x=B=>{var N=aA(),z=on(N),D=G(z);let L;var P=G(D),T=J(G(P));{var C=re=>{var be=oA();oe(re,be)};Ve(T,re=>{l().rapid&&re(C)})}W(P);var R=J(P,2);Zv(R,{}),W(D),ht(D,re=>M(h,re),()=>b(h)),W(z);var O=J(z,2),V=G(O);ht(jh(V,{$$legacy:!0}),re=>M(c,re),()=>b(c)),W(O);var K=J(O,2),ee=G(K);ht(Qv(ee,{$$legacy:!0}),re=>M(d,re),()=>b(d)),W(K);var Y=J(K,2),le=G(Y);Qh(le,{}),W(Y),Ze(()=>L=nt(D,1,"digifall",null,L,{screen:b(u)})),Be("click",D,()=>xt(_t,ye.menu)),oe(B,N)};Ve(k,B=>{a()&&B(x)})}W(I),W(S),Ze(B=>{A=nt(S,1,"game",null,A,{blur:o()}),Ot(E,"style",B)},[()=>w(a())],Nt),oe(n,S),Ae(t,"moveUp",f),Ae(t,"moveDown",g),Ae(t,"moveLeft",y),Ae(t,"moveRight",m),Ae(t,"perfomAction",v),Ae(t,"blur",_);var U=Tt({moveUp:f,moveDown:g,moveLeft:y,moveRight:m,perfomAction:v,blur:_,$set:zt,$on:(B,N)=>Ht(t,B,N)});return r(),U}var lA=ce("<h1> </h1>"),uA=ce("<button>p2p leaderboard</button>"),dA=ce('<div class="col"><button>new game</button> <!> <button>options</button></div>'),hA=ce('<span class="letter"> </span>'),fA=ce('<span class="energy-out"></span>'),pA=ce('<div><div class="section-1"><!></div> <div class="section-2"><!></div> <div class="section-3"><!></div> <div class="section-4"><!> <!></div></div>');function Jv(n,t){if(new.target)return Ut({component:Jv,...n});kt(t,!1);const[e,r]=wn(),s=()=>ge(Al,"$energy",e),i=()=>ge(wa,"$records",e),o=()=>ge(xl,"$score",e),a=()=>ge(Ft,"$options",e),l=Q(),u=Q(),h=Q(),c=Q(),d=Q(),f=Q();let g=At(t,"scoreComponent",12);function y(){Yh()}function m(){xt(_t,ye.leaderboard)}function v(){xt(_t,ye.options)}ae(()=>s(),()=>{M(l,s().value===0)}),ae(()=>(b(l),s()),()=>{M(u,b(l)&&s().buffer===0)}),ae(()=>(i(),$),()=>{M(h,i()[$.highCombo][$.value])}),ae(()=>(b(u),b(h),$),()=>{M(c,b(u)&&b(h)>Bs[$.highComboPrev])}),ae(()=>(b(u),o(),$),()=>{M(d,b(u)&&o().value>Bs[$.highScorePrev])}),ae(()=>(b(c),b(d)),()=>{M(f,b(c)||b(d))}),dr(),Vt();var _=pA();let w;var S=G(_),A=G(S);{var E=T=>{var C=lA(),R=G(C,!0);W(C),Ze(()=>st(R,b(f)?"new record!":"game over")),Ye(5,C,()=>tr,()=>({delay:600,y:-48})),oe(T,C)};Ve(A,T=>{b(u)&&T(E)})}W(S);var I=J(S,2),k=G(I);ht(jh(k,{get newRecordHighCombo(){return b(c)},get newRecordHighScore(){return b(d)},get newRecord(){return b(f)},overlaid:!0,$$legacy:!0}),T=>g(T),()=>g()),W(I);var x=J(I,2),U=G(x);{var B=T=>{var C=dA(),R=G(C),O=J(R,2);{var V=ee=>{var Y=uA();Be("click",Y,m),oe(ee,Y)};Ve(O,ee=>{a()[$.leaderboard]&&ee(V)})}var K=J(O,2);W(C),Be("click",R,y),Be("click",K,v),Ye(5,C,()=>tr,()=>({delay:600,y:24})),oe(T,C)};Ve(U,T=>{b(u)&&T(B)})}W(x);var N=J(x,2),z=G(N);Qh(z,{});var D=J(z,2);{var L=T=>{var C=fA();Ts(C,4,()=>"ut of energy",Oi,(R,O,V)=>{var K=hA(),ee=G(K,!0);W(K),Ze(()=>st(ee,O)),Ye(5,K,()=>tr,()=>({delay:V*48,duration:200,y:48})),oe(R,K)}),W(C),oe(T,C)};Ve(D,T=>{b(l)&&T(L)})}W(N),W(_),Ze(()=>w=nt(_,1,"game-over content",null,w,{"new-record":b(f)})),Ye(1,_,()=>Tr),oe(n,_);var P=Tt({get scoreComponent(){return g()},set scoreComponent(T){g(T),yt()},$set:zt,$on:(T,C)=>Ht(t,T,C)});return r(),P}const gA=Symbol.for("@libp2p/connection"),Dp=Symbol.for("@libp2p/content-routing"),_c=Symbol.for("@libp2p/peer-discovery"),Zh=Symbol.for("@libp2p/peer-id");function eb(n){return!!n?.[Zh]}const Mp=Symbol.for("@libp2p/peer-routing"),Xh="keep-alive",Sc="StrictSign",Jh="StrictNoSign";var Cn;(function(n){n.Accept="accept",n.Ignore="ignore",n.Reject="reject"})(Cn||(Cn={}));const tb=Symbol.for("@libp2p/transport");var Yo;(function(n){n[n.FATAL_ALL=0]="FATAL_ALL",n[n.NO_FATAL=1]="NO_FATAL"})(Yo||(Yo={}));var ad;let Ns=(ad=class extends Error{constructor(t="The operation was aborted"){super(t),this.name="AbortError"}},p(ad,"name","AbortError"),ad);class nb extends Error{constructor(t="Unexpected Peer"){super(t),this.name="UnexpectedPeerError"}}p(nb,"name","UnexpectedPeerError");class Td extends Error{constructor(t="Invalid crypto exchange"){super(t),this.name="InvalidCryptoExchangeError"}}p(Td,"name","InvalidCryptoExchangeError");class Z extends Error{constructor(t="Invalid parameters"){super(t),this.name="InvalidParametersError"}}p(Z,"name","InvalidParametersError");class ef extends Error{constructor(t="Invalid public key"){super(t),this.name="InvalidPublicKeyError"}}p(ef,"name","InvalidPublicKeyError");class tf extends Error{constructor(t="Invalid private key"){super(t),this.name="InvalidPrivateKeyError"}}p(tf,"name","InvalidPrivateKeyError");class rb extends Error{constructor(t="The connection is closing"){super(t),this.name="ConnectionClosingError"}}p(rb,"name","ConnectionClosingError");class nf extends Error{constructor(t="The connection is closed"){super(t),this.name="ConnectionClosedError"}}p(nf,"name","ConnectionClosedError");class sb extends Error{constructor(t="Connection failed"){super(t),this.name="ConnectionFailedError"}}p(sb,"name","ConnectionFailedError");class fi extends Error{constructor(t="The muxer is closed"){super(t),this.name="MuxerClosedError"}}p(fi,"name","MuxerClosedError");class ib extends Error{constructor(t="The stream has been reset"){super(t),this.name="StreamResetError"}}p(ib,"name","StreamResetError");class ob extends Error{constructor(t="The stream is in an invalid state"){super(t),this.name="StreamStateError"}}p(ob,"name","StreamStateError");var cd;let Ec=(cd=class extends Error{constructor(t="Not found"){super(t),this.name="NotFoundError"}},p(cd,"name","NotFoundError"),cd);class rf extends Error{constructor(t="Invalid PeerID"){super(t),this.name="InvalidPeerIdError"}}p(rf,"name","InvalidPeerIdError");class Il extends Error{constructor(t="Invalid multiaddr"){super(t),this.name="InvalidMultiaddrError"}}p(Il,"name","InvalidMultiaddrError");class ab extends Error{constructor(t="Invalid CID"){super(t),this.name="InvalidCIDError"}}p(ab,"name","InvalidCIDError");class cb extends Error{constructor(t="Invalid Multihash"){super(t),this.name="InvalidMultihashError"}}p(cb,"name","InvalidMultihashError");class kl extends Error{constructor(t="Unsupported protocol error"){super(t),this.name="UnsupportedProtocolError"}}p(kl,"name","UnsupportedProtocolError");class Xn extends Error{constructor(t="Invalid message"){super(t),this.name="InvalidMessageError"}}p(Xn,"name","InvalidMessageError");class tc extends Error{constructor(t="Protocol error"){super(t),this.name="ProtocolError"}}p(tc,"name","ProtocolError");var ld;let mA=(ld=class extends Error{constructor(t="Timed out"){super(t),this.name="TimeoutError"}},p(ld,"name","TimeoutError"),ld);class Qo extends Error{constructor(t="Not started"){super(t),this.name="NotStartedError"}}p(Qo,"name","NotStartedError");class Ei extends Error{constructor(t="Dial error"){super(t),this.name="DialError"}}p(Ei,"name","DialError");class Ac extends Error{constructor(t="Listen error"){super(t),this.name="ListenError"}}p(Ac,"name","ListenError");class sf extends Error{constructor(t="Limited connection"){super(t),this.name="LimitedConnectionError"}}p(sf,"name","LimitedConnectionError");class lb extends Error{constructor(t="Too many inbound protocol streams"){super(t),this.name="TooManyInboundProtocolStreamsError"}}p(lb,"name","TooManyInboundProtocolStreamsError");class of extends Error{constructor(t="Too many outbound protocol streams"){super(t),this.name="TooManyOutboundProtocolStreamsError"}}p(of,"name","TooManyOutboundProtocolStreamsError");class Qs extends Error{constructor(t="Unsupported key type"){super(t),this.name="UnsupportedKeyTypeError"}}p(Qs,"name","UnsupportedKeyTypeError");var Zn;class ar extends EventTarget{constructor(){super();_e(this,Zn,new Map)}listenerCount(e){const r=F(this,Zn).get(e);return r==null?0:r.length}addEventListener(e,r,s){super.addEventListener(e,r,s);let i=F(this,Zn).get(e);i==null&&(i=[],F(this,Zn).set(e,i)),i.push({callback:r,once:(s!==!0&&s!==!1&&s?.once)??!1})}removeEventListener(e,r,s){super.removeEventListener(e.toString(),r??null,s);let i=F(this,Zn).get(e);i!=null&&(i=i.filter(({callback:o})=>o!==r),F(this,Zn).set(e,i))}dispatchEvent(e){const r=super.dispatchEvent(e);let s=F(this,Zn).get(e.type);return s==null||(s=s.filter(({once:i})=>!i),F(this,Zn).set(e.type,s)),r}safeDispatchEvent(e,r={}){return this.dispatchEvent(new CustomEvent(e,r))}}Zn=new WeakMap;function af(n){return n!=null&&typeof n.start=="function"&&typeof n.stop=="function"}async function ub(...n){const t=[];for(const e of n)af(e)&&t.push(e);await Promise.all(t.map(async e=>{e.beforeStart!=null&&await e.beforeStart()})),await Promise.all(t.map(async e=>{await e.start()})),await Promise.all(t.map(async e=>{e.afterStart!=null&&await e.afterStart()}))}async function db(...n){const t=[];for(const e of n)af(e)&&t.push(e);await Promise.all(t.map(async e=>{e.beforeStop!=null&&await e.beforeStop()})),await Promise.all(t.map(async e=>{await e.stop()})),await Promise.all(t.map(async e=>{e.afterStop!=null&&await e.afterStop()}))}const Wn=Symbol.for("@libp2p/service-capabilities"),xc=Symbol.for("@libp2p/service-dependencies");function yA(n,t){if(n===t)return!0;if(n.byteLength!==t.byteLength)return!1;for(let e=0;e<n.byteLength;e++)if(n[e]!==t[e])return!1;return!0}function Tl(n){if(n instanceof Uint8Array&&n.constructor.name==="Uint8Array")return n;if(n instanceof ArrayBuffer)return new Uint8Array(n);if(ArrayBuffer.isView(n))return new Uint8Array(n.buffer,n.byteOffset,n.byteLength);throw new Error("Unknown type, must be binary type")}function vA(n){return new TextEncoder().encode(n)}function bA(n){return new TextDecoder().decode(n)}function wA(n,t){if(n.length>=255)throw new TypeError("Alphabet too long");for(var e=new Uint8Array(256),r=0;r<e.length;r++)e[r]=255;for(var s=0;s<n.length;s++){var i=n.charAt(s),o=i.charCodeAt(0);if(e[o]!==255)throw new TypeError(i+" is ambiguous");e[o]=s}var a=n.length,l=n.charAt(0),u=Math.log(a)/Math.log(256),h=Math.log(256)/Math.log(a);function c(g){if(g instanceof Uint8Array||(ArrayBuffer.isView(g)?g=new Uint8Array(g.buffer,g.byteOffset,g.byteLength):Array.isArray(g)&&(g=Uint8Array.from(g))),!(g instanceof Uint8Array))throw new TypeError("Expected Uint8Array");if(g.length===0)return"";for(var y=0,m=0,v=0,_=g.length;v!==_&&g[v]===0;)v++,y++;for(var w=(_-v)*h+1>>>0,S=new Uint8Array(w);v!==_;){for(var A=g[v],E=0,I=w-1;(A!==0||E<m)&&I!==-1;I--,E++)A+=256*S[I]>>>0,S[I]=A%a>>>0,A=A/a>>>0;if(A!==0)throw new Error("Non-zero carry");m=E,v++}for(var k=w-m;k!==w&&S[k]===0;)k++;for(var x=l.repeat(y);k<w;++k)x+=n.charAt(S[k]);return x}function d(g){if(typeof g!="string")throw new TypeError("Expected String");if(g.length===0)return new Uint8Array;var y=0;if(g[y]!==" "){for(var m=0,v=0;g[y]===l;)m++,y++;for(var _=(g.length-y)*u+1>>>0,w=new Uint8Array(_);g[y];){var S=e[g.charCodeAt(y)];if(S===255)return;for(var A=0,E=_-1;(S!==0||A<v)&&E!==-1;E--,A++)S+=a*w[E]>>>0,w[E]=S%256>>>0,S=S/256>>>0;if(S!==0)throw new Error("Non-zero carry");v=A,y++}if(g[y]!==" "){for(var I=_-v;I!==_&&w[I]===0;)I++;for(var k=new Uint8Array(m+(_-I)),x=m;I!==_;)k[x++]=w[I++];return k}}}function f(g){var y=d(g);if(y)return y;throw new Error(`Non-${t} character`)}return{encode:c,decodeUnsafe:d,decode:f}}var _A=wA,SA=_A;class EA{constructor(t,e,r){p(this,"name");p(this,"prefix");p(this,"baseEncode");this.name=t,this.prefix=e,this.baseEncode=r}encode(t){if(t instanceof Uint8Array)return`${this.prefix}${this.baseEncode(t)}`;throw Error("Unknown type, must be binary type")}}let AA=class{constructor(t,e,r){p(this,"name");p(this,"prefix");p(this,"baseDecode");p(this,"prefixCodePoint");this.name=t,this.prefix=e;const s=e.codePointAt(0);if(s===void 0)throw new Error("Invalid prefix character");this.prefixCodePoint=s,this.baseDecode=r}decode(t){if(typeof t=="string"){if(t.codePointAt(0)!==this.prefixCodePoint)throw Error(`Unable to decode multibase string ${JSON.stringify(t)}, ${this.name} decoder only supports inputs prefixed with ${this.prefix}`);return this.baseDecode(t.slice(this.prefix.length))}else throw Error("Can only multibase decode strings")}or(t){return hb(this,t)}};class xA{constructor(t){p(this,"decoders");this.decoders=t}or(t){return hb(this,t)}decode(t){const e=t[0],r=this.decoders[e];if(r!=null)return r.decode(t);throw RangeError(`Unable to decode multibase string ${JSON.stringify(t)}, only inputs prefixed with ${Object.keys(this.decoders)} are supported`)}}function hb(n,t){return new xA({...n.decoders??{[n.prefix]:n},...t.decoders??{[t.prefix]:t}})}class IA{constructor(t,e,r,s){p(this,"name");p(this,"prefix");p(this,"baseEncode");p(this,"baseDecode");p(this,"encoder");p(this,"decoder");this.name=t,this.prefix=e,this.baseEncode=r,this.baseDecode=s,this.encoder=new EA(t,e,r),this.decoder=new AA(t,e,s)}encode(t){return this.encoder.encode(t)}decode(t){return this.decoder.decode(t)}}function Cl({name:n,prefix:t,encode:e,decode:r}){return new IA(n,t,e,r)}function Sa({name:n,prefix:t,alphabet:e}){const{encode:r,decode:s}=SA(e,n);return Cl({prefix:t,name:n,encode:r,decode:i=>Tl(s(i))})}function kA(n,t,e,r){const s={};for(let h=0;h<t.length;++h)s[t[h]]=h;let i=n.length;for(;n[i-1]==="=";)--i;const o=new Uint8Array(i*e/8|0);let a=0,l=0,u=0;for(let h=0;h<i;++h){const c=s[n[h]];if(c===void 0)throw new SyntaxError(`Non-${r} character`);l=l<<e|c,a+=e,a>=8&&(a-=8,o[u++]=255&l>>a)}if(a>=e||(255&l<<8-a)!==0)throw new SyntaxError("Unexpected end of data");return o}function TA(n,t,e){const r=t[t.length-1]==="=",s=(1<<e)-1;let i="",o=0,a=0;for(let l=0;l<n.length;++l)for(a=a<<8|n[l],o+=8;o>e;)o-=e,i+=t[s&a>>o];if(o!==0&&(i+=t[s&a<<e-o]),r)for(;(i.length*e&7)!==0;)i+="=";return i}function Ct({name:n,prefix:t,bitsPerChar:e,alphabet:r}){return Cl({prefix:t,name:n,encode(s){return TA(s,r,e)},decode(s){return kA(s,r,e,n)}})}const ot=Sa({name:"base58btc",prefix:"z",alphabet:"123456789ABCDEFGHJKLMNPQRSTUVWXYZabcdefghijkmnopqrstuvwxyz"}),CA=Sa({name:"base58flickr",prefix:"Z",alphabet:"123456789abcdefghijkmnopqrstuvwxyzABCDEFGHJKLMNPQRSTUVWXYZ"}),PA=Object.freeze(Object.defineProperty({__proto__:null,base58btc:ot,base58flickr:CA},Symbol.toStringTag,{value:"Module"})),Cr=Ct({prefix:"b",name:"base32",alphabet:"abcdefghijklmnopqrstuvwxyz234567",bitsPerChar:5}),DA=Ct({prefix:"B",name:"base32upper",alphabet:"ABCDEFGHIJKLMNOPQRSTUVWXYZ234567",bitsPerChar:5}),MA=Ct({prefix:"c",name:"base32pad",alphabet:"abcdefghijklmnopqrstuvwxyz234567=",bitsPerChar:5}),LA=Ct({prefix:"C",name:"base32padupper",alphabet:"ABCDEFGHIJKLMNOPQRSTUVWXYZ234567=",bitsPerChar:5}),BA=Ct({prefix:"v",name:"base32hex",alphabet:"0123456789abcdefghijklmnopqrstuv",bitsPerChar:5}),NA=Ct({prefix:"V",name:"base32hexupper",alphabet:"0123456789ABCDEFGHIJKLMNOPQRSTUV",bitsPerChar:5}),RA=Ct({prefix:"t",name:"base32hexpad",alphabet:"0123456789abcdefghijklmnopqrstuv=",bitsPerChar:5}),OA=Ct({prefix:"T",name:"base32hexpadupper",alphabet:"0123456789ABCDEFGHIJKLMNOPQRSTUV=",bitsPerChar:5}),FA=Ct({prefix:"h",name:"base32z",alphabet:"ybndrfg8ejkmcpqxot1uwisza345h769",bitsPerChar:5}),$A=Object.freeze(Object.defineProperty({__proto__:null,base32:Cr,base32hex:BA,base32hexpad:RA,base32hexpadupper:OA,base32hexupper:NA,base32pad:MA,base32padupper:LA,base32upper:DA,base32z:FA},Symbol.toStringTag,{value:"Module"})),nc=Sa({prefix:"k",name:"base36",alphabet:"0123456789abcdefghijklmnopqrstuvwxyz"}),UA=Sa({prefix:"K",name:"base36upper",alphabet:"0123456789ABCDEFGHIJKLMNOPQRSTUVWXYZ"}),VA=Object.freeze(Object.defineProperty({__proto__:null,base36:nc,base36upper:UA},Symbol.toStringTag,{value:"Module"}));var HA=fb,Lp=128,zA=-128,qA=Math.pow(2,31);function fb(n,t,e){t=t||[],e=e||0;for(var r=e;n>=qA;)t[e++]=n&255|Lp,n/=128;for(;n&zA;)t[e++]=n&255|Lp,n>>>=7;return t[e]=n|0,fb.bytes=e-r+1,t}var WA=Cd,GA=128,Bp=127;function Cd(n,r){var e=0,r=r||0,s=0,i=r,o,a=n.length;do{if(i>=a)throw Cd.bytes=0,new RangeError("Could not decode varint");o=n[i++],e+=s<28?(o&Bp)<<s:(o&Bp)*Math.pow(2,s),s+=7}while(o>=GA);return Cd.bytes=i-r,e}var KA=Math.pow(2,7),YA=Math.pow(2,14),QA=Math.pow(2,21),jA=Math.pow(2,28),ZA=Math.pow(2,35),XA=Math.pow(2,42),JA=Math.pow(2,49),ex=Math.pow(2,56),tx=Math.pow(2,63),nx=function(n){return n<KA?1:n<YA?2:n<QA?3:n<jA?4:n<ZA?5:n<XA?6:n<JA?7:n<ex?8:n<tx?9:10},rx={encode:HA,decode:WA,encodingLength:nx},Ic=rx;function Pd(n,t=0){return[Ic.decode(n,t),Ic.decode.bytes]}function kc(n,t,e=0){return Ic.encode(n,t,e),t}function Tc(n){return Ic.encodingLength(n)}function Rs(n,t){const e=t.byteLength,r=Tc(n),s=r+Tc(e),i=new Uint8Array(s+e);return kc(n,i,0),kc(e,i,r),i.set(t,s),new cf(n,e,t,i)}function $r(n){const t=Tl(n),[e,r]=Pd(t),[s,i]=Pd(t.subarray(r)),o=t.subarray(r+i);if(o.byteLength!==s)throw new Error("Incorrect length");return new cf(e,s,o,t)}function sx(n,t){if(n===t)return!0;{const e=t;return n.code===e.code&&n.size===e.size&&e.bytes instanceof Uint8Array&&yA(n.bytes,e.bytes)}}class cf{constructor(t,e,r,s){p(this,"code");p(this,"size");p(this,"digest");p(this,"bytes");this.code=t,this.size=e,this.digest=r,this.bytes=s}}function Np(n,t){const{bytes:e,version:r}=n;switch(r){case 0:return ox(e,Dd(n),t??ot.encoder);default:return ax(e,Dd(n),t??Cr.encoder)}}const Rp=new WeakMap;function Dd(n){const t=Rp.get(n);if(t==null){const e=new Map;return Rp.set(n,e),e}return t}var jm;class Qe{constructor(t,e,r,s){p(this,"code");p(this,"version");p(this,"multihash");p(this,"bytes");p(this,"/");p(this,jm,"CID");this.code=e,this.version=t,this.multihash=r,this.bytes=s,this["/"]=s}get asCID(){return this}get byteOffset(){return this.bytes.byteOffset}get byteLength(){return this.bytes.byteLength}toV0(){switch(this.version){case 0:return this;case 1:{const{code:t,multihash:e}=this;if(t!==_o)throw new Error("Cannot convert a non dag-pb CID to CIDv0");if(e.code!==cx)throw new Error("Cannot convert non sha2-256 multihash CID to CIDv0");return Qe.createV0(e)}default:throw Error(`Can not convert CID version ${this.version} to version 0. This is a bug please report`)}}toV1(){switch(this.version){case 0:{const{code:t,digest:e}=this.multihash,r=Rs(t,e);return Qe.createV1(this.code,r)}case 1:return this;default:throw Error(`Can not convert CID version ${this.version} to version 1. This is a bug please report`)}}equals(t){return Qe.equals(this,t)}static equals(t,e){const r=e;return r!=null&&t.code===r.code&&t.version===r.version&&sx(t.multihash,r.multihash)}toString(t){return Np(this,t)}toJSON(){return{"/":Np(this)}}link(){return this}[(jm=Symbol.toStringTag,Symbol.for("nodejs.util.inspect.custom"))](){return`CID(${this.toString()})`}static asCID(t){if(t==null)return null;const e=t;if(e instanceof Qe)return e;if(e["/"]!=null&&e["/"]===e.bytes||e.asCID===e){const{version:r,code:s,multihash:i,bytes:o}=e;return new Qe(r,s,i,o??Op(r,s,i.bytes))}else if(e[lx]===!0){const{version:r,multihash:s,code:i}=e,o=$r(s);return Qe.create(r,i,o)}else return null}static create(t,e,r){if(typeof e!="number")throw new Error("String codecs are no longer supported");if(!(r.bytes instanceof Uint8Array))throw new Error("Invalid digest");switch(t){case 0:{if(e!==_o)throw new Error(`Version 0 CID must use dag-pb (code: ${_o}) block encoding`);return new Qe(t,e,r,r.bytes)}case 1:{const s=Op(t,e,r.bytes);return new Qe(t,e,r,s)}default:throw new Error("Invalid version")}}static createV0(t){return Qe.create(0,_o,t)}static createV1(t,e){return Qe.create(1,t,e)}static decode(t){const[e,r]=Qe.decodeFirst(t);if(r.length!==0)throw new Error("Incorrect length");return e}static decodeFirst(t){const e=Qe.inspectBytes(t),r=e.size-e.multihashSize,s=Tl(t.subarray(r,r+e.multihashSize));if(s.byteLength!==e.multihashSize)throw new Error("Incorrect length");const i=s.subarray(e.multihashSize-e.digestSize),o=new cf(e.multihashCode,e.digestSize,i,s);return[e.version===0?Qe.createV0(o):Qe.createV1(e.codec,o),t.subarray(e.size)]}static inspectBytes(t){let e=0;const r=()=>{const[c,d]=Pd(t.subarray(e));return e+=d,c};let s=r(),i=_o;if(s===18?(s=0,e=0):i=r(),s!==0&&s!==1)throw new RangeError(`Invalid CID version ${s}`);const o=e,a=r(),l=r(),u=e+l,h=u-o;return{version:s,codec:i,multihashCode:a,digestSize:l,multihashSize:h,size:u}}static parse(t,e){const[r,s]=ix(t,e),i=Qe.decode(s);if(i.version===0&&t[0]!=="Q")throw Error("Version 0 CID string must not include multibase prefix");return Dd(i).set(r,t),i}}function ix(n,t){switch(n[0]){case"Q":{const e=t??ot;return[ot.prefix,e.decode(`${ot.prefix}${n}`)]}case ot.prefix:{const e=t??ot;return[ot.prefix,e.decode(n)]}case Cr.prefix:{const e=t??Cr;return[Cr.prefix,e.decode(n)]}case nc.prefix:{const e=t??nc;return[nc.prefix,e.decode(n)]}default:{if(t==null)throw Error("To parse non base32, base36 or base58btc encoded CID multibase decoder must be provided");return[n[0],t.decode(n)]}}}function ox(n,t,e){const{prefix:r}=e;if(r!==ot.prefix)throw Error(`Cannot string encode V0 in ${e.name} encoding`);const s=t.get(r);if(s==null){const i=e.encode(n).slice(1);return t.set(r,i),i}else return s}function ax(n,t,e){const{prefix:r}=e,s=t.get(r);if(s==null){const i=e.encode(n);return t.set(r,i),i}else return s}const _o=112,cx=18;function Op(n,t,e){const r=Tc(n),s=r+Tc(t),i=new Uint8Array(s+e.byteLength);return kc(n,i,0),kc(t,i,r),i.set(e,s),i}const lx=Symbol.for("@ipld/js-cid/CID"),pb=0,ux="identity",gb=Tl;function dx(n){return Rs(pb,gb(n))}const Pl={code:pb,name:ux,encode:gb,digest:dx};function It(n,t){if(n===t)return!0;if(n.byteLength!==t.byteLength)return!1;for(let e=0;e<n.byteLength;e++)if(n[e]!==t[e])return!1;return!0}function No(n){if(!Number.isSafeInteger(n)||n<0)throw new Error("positive integer expected, got "+n)}function hx(n){return n instanceof Uint8Array||ArrayBuffer.isView(n)&&n.constructor.name==="Uint8Array"}function Dl(n,...t){if(!hx(n))throw new Error("Uint8Array expected");if(t.length>0&&!t.includes(n.length))throw new Error("Uint8Array expected of length "+t+", got length="+n.length)}function mb(n){if(typeof n!="function"||typeof n.create!="function")throw new Error("Hash should be wrapped by utils.wrapConstructor");No(n.outputLen),No(n.blockLen)}function Cc(n,t=!0){if(n.destroyed)throw new Error("Hash instance has been destroyed");if(t&&n.finished)throw new Error("Hash#digest() has already been called")}function fx(n,t){Dl(n);const e=t.outputLen;if(n.length<e)throw new Error("digestInto() expects output buffer of length at least "+e)}const oi=typeof globalThis=="object"&&"crypto"in globalThis?globalThis.crypto:void 0;/*! noble-hashes - MIT License (c) 2022 Paul Miller (paulmillr.com) */function Ro(n){return new DataView(n.buffer,n.byteOffset,n.byteLength)}function Kn(n,t){return n<<32-t|n>>>t}function du(n,t){return n<<t|n>>>32-t>>>0}const px=async()=>{};async function gx(n,t,e){let r=Date.now();for(let s=0;s<n;s++){e(s);const i=Date.now()-r;i>=0&&i<t||(await px(),r+=i)}}function mx(n){if(typeof n!="string")throw new Error("utf8ToBytes expected string, got "+typeof n);return new Uint8Array(new TextEncoder().encode(n))}function jo(n){return typeof n=="string"&&(n=mx(n)),Dl(n),n}function yx(...n){let t=0;for(let r=0;r<n.length;r++){const s=n[r];Dl(s),t+=s.length}const e=new Uint8Array(t);for(let r=0,s=0;r<n.length;r++){const i=n[r];e.set(i,s),s+=i.length}return e}class yb{clone(){return this._cloneInto()}}function vx(n,t){if(t!==void 0&&{}.toString.call(t)!=="[object Object]")throw new Error("Options should be object or undefined");return Object.assign(n,t)}function lf(n){const t=r=>n().update(jo(r)).digest(),e=n();return t.outputLen=e.outputLen,t.blockLen=e.blockLen,t.create=()=>n(),t}function uf(n=32){if(oi&&typeof oi.getRandomValues=="function")return oi.getRandomValues(new Uint8Array(n));if(oi&&typeof oi.randomBytes=="function")return oi.randomBytes(n);throw new Error("crypto.getRandomValues must be defined")}function bx(n,t,e,r){if(typeof n.setBigUint64=="function")return n.setBigUint64(t,e,r);const s=BigInt(32),i=BigInt(4294967295),o=Number(e>>s&i),a=Number(e&i),l=r?4:0,u=r?0:4;n.setUint32(t+l,o,r),n.setUint32(t+u,a,r)}function vb(n,t,e){return n&t^~n&e}function bb(n,t,e){return n&t^n&e^t&e}class df extends yb{constructor(t,e,r,s){super(),this.blockLen=t,this.outputLen=e,this.padOffset=r,this.isLE=s,this.finished=!1,this.length=0,this.pos=0,this.destroyed=!1,this.buffer=new Uint8Array(t),this.view=Ro(this.buffer)}update(t){Cc(this);const{view:e,buffer:r,blockLen:s}=this;t=jo(t);const i=t.length;for(let o=0;o<i;){const a=Math.min(s-this.pos,i-o);if(a===s){const l=Ro(t);for(;s<=i-o;o+=s)this.process(l,o);continue}r.set(t.subarray(o,o+a),this.pos),this.pos+=a,o+=a,this.pos===s&&(this.process(e,0),this.pos=0)}return this.length+=t.length,this.roundClean(),this}digestInto(t){Cc(this),fx(t,this),this.finished=!0;const{buffer:e,view:r,blockLen:s,isLE:i}=this;let{pos:o}=this;e[o++]=128,this.buffer.subarray(o).fill(0),this.padOffset>s-o&&(this.process(r,0),o=0);for(let c=o;c<s;c++)e[c]=0;bx(r,s-8,BigInt(this.length*8),i),this.process(r,0);const a=Ro(t),l=this.outputLen;if(l%4)throw new Error("_sha2: outputLen should be aligned to 32bit");const u=l/4,h=this.get();if(u>h.length)throw new Error("_sha2: outputLen bigger than state");for(let c=0;c<u;c++)a.setUint32(4*c,h[c],i)}digest(){const{buffer:t,outputLen:e}=this;this.digestInto(t);const r=t.slice(0,e);return this.destroy(),r}_cloneInto(t){t||(t=new this.constructor),t.set(...this.get());const{blockLen:e,buffer:r,length:s,finished:i,destroyed:o,pos:a}=this;return t.length=s,t.pos=a,t.finished=i,t.destroyed=o,s%e&&t.buffer.set(r),t}}const Ba=BigInt(2**32-1),Md=BigInt(32);function wb(n,t=!1){return t?{h:Number(n&Ba),l:Number(n>>Md&Ba)}:{h:Number(n>>Md&Ba)|0,l:Number(n&Ba)|0}}function wx(n,t=!1){let e=new Uint32Array(n.length),r=new Uint32Array(n.length);for(let s=0;s<n.length;s++){const{h:i,l:o}=wb(n[s],t);[e[s],r[s]]=[i,o]}return[e,r]}const _x=(n,t)=>BigInt(n>>>0)<<Md|BigInt(t>>>0),Sx=(n,t,e)=>n>>>e,Ex=(n,t,e)=>n<<32-e|t>>>e,Ax=(n,t,e)=>n>>>e|t<<32-e,xx=(n,t,e)=>n<<32-e|t>>>e,Ix=(n,t,e)=>n<<64-e|t>>>e-32,kx=(n,t,e)=>n>>>e-32|t<<64-e,Tx=(n,t)=>t,Cx=(n,t)=>n,Px=(n,t,e)=>n<<e|t>>>32-e,Dx=(n,t,e)=>t<<e|n>>>32-e,Mx=(n,t,e)=>t<<e-32|n>>>64-e,Lx=(n,t,e)=>n<<e-32|t>>>64-e;function Bx(n,t,e,r){const s=(t>>>0)+(r>>>0);return{h:n+e+(s/2**32|0)|0,l:s|0}}const Nx=(n,t,e)=>(n>>>0)+(t>>>0)+(e>>>0),Rx=(n,t,e,r)=>t+e+r+(n/2**32|0)|0,Ox=(n,t,e,r)=>(n>>>0)+(t>>>0)+(e>>>0)+(r>>>0),Fx=(n,t,e,r,s)=>t+e+r+s+(n/2**32|0)|0,$x=(n,t,e,r,s)=>(n>>>0)+(t>>>0)+(e>>>0)+(r>>>0)+(s>>>0),Ux=(n,t,e,r,s,i)=>t+e+r+s+i+(n/2**32|0)|0,fe={fromBig:wb,split:wx,toBig:_x,shrSH:Sx,shrSL:Ex,rotrSH:Ax,rotrSL:xx,rotrBH:Ix,rotrBL:kx,rotr32H:Tx,rotr32L:Cx,rotlSH:Px,rotlSL:Dx,rotlBH:Mx,rotlBL:Lx,add:Bx,add3L:Nx,add3H:Rx,add4L:Ox,add4H:Fx,add5H:Ux,add5L:$x},[Vx,Hx]=fe.split(["0x428a2f98d728ae22","0x7137449123ef65cd","0xb5c0fbcfec4d3b2f","0xe9b5dba58189dbbc","0x3956c25bf348b538","0x59f111f1b605d019","0x923f82a4af194f9b","0xab1c5ed5da6d8118","0xd807aa98a3030242","0x12835b0145706fbe","0x243185be4ee4b28c","0x550c7dc3d5ffb4e2","0x72be5d74f27b896f","0x80deb1fe3b1696b1","0x9bdc06a725c71235","0xc19bf174cf692694","0xe49b69c19ef14ad2","0xefbe4786384f25e3","0x0fc19dc68b8cd5b5","0x240ca1cc77ac9c65","0x2de92c6f592b0275","0x4a7484aa6ea6e483","0x5cb0a9dcbd41fbd4","0x76f988da831153b5","0x983e5152ee66dfab","0xa831c66d2db43210","0xb00327c898fb213f","0xbf597fc7beef0ee4","0xc6e00bf33da88fc2","0xd5a79147930aa725","0x06ca6351e003826f","0x142929670a0e6e70","0x27b70a8546d22ffc","0x2e1b21385c26c926","0x4d2c6dfc5ac42aed","0x53380d139d95b3df","0x650a73548baf63de","0x766a0abb3c77b2a8","0x81c2c92e47edaee6","0x92722c851482353b","0xa2bfe8a14cf10364","0xa81a664bbc423001","0xc24b8b70d0f89791","0xc76c51a30654be30","0xd192e819d6ef5218","0xd69906245565a910","0xf40e35855771202a","0x106aa07032bbd1b8","0x19a4c116b8d2d0c8","0x1e376c085141ab53","0x2748774cdf8eeb99","0x34b0bcb5e19b48a8","0x391c0cb3c5c95a63","0x4ed8aa4ae3418acb","0x5b9cca4f7763e373","0x682e6ff3d6b2b8a3","0x748f82ee5defb2fc","0x78a5636f43172f60","0x84c87814a1f0ab72","0x8cc702081a6439ec","0x90befffa23631e28","0xa4506cebde82bde9","0xbef9a3f7b2c67915","0xc67178f2e372532b","0xca273eceea26619c","0xd186b8c721c0c207","0xeada7dd6cde0eb1e","0xf57d4f7fee6ed178","0x06f067aa72176fba","0x0a637dc5a2c898a6","0x113f9804bef90dae","0x1b710b35131c471b","0x28db77f523047d84","0x32caab7b40c72493","0x3c9ebe0a15c9bebc","0x431d67c49c100d4c","0x4cc5d4becb3e42b6","0x597f299cfc657e2a","0x5fcb6fab3ad6faec","0x6c44198c4a475817"].map(n=>BigInt(n))),zr=new Uint32Array(80),qr=new Uint32Array(80);class zx extends df{constructor(){super(128,64,16,!1),this.Ah=1779033703,this.Al=-205731576,this.Bh=-1150833019,this.Bl=-2067093701,this.Ch=1013904242,this.Cl=-23791573,this.Dh=-1521486534,this.Dl=1595750129,this.Eh=1359893119,this.El=-1377402159,this.Fh=-1694144372,this.Fl=725511199,this.Gh=528734635,this.Gl=-79577749,this.Hh=1541459225,this.Hl=327033209}get(){const{Ah:t,Al:e,Bh:r,Bl:s,Ch:i,Cl:o,Dh:a,Dl:l,Eh:u,El:h,Fh:c,Fl:d,Gh:f,Gl:g,Hh:y,Hl:m}=this;return[t,e,r,s,i,o,a,l,u,h,c,d,f,g,y,m]}set(t,e,r,s,i,o,a,l,u,h,c,d,f,g,y,m){this.Ah=t|0,this.Al=e|0,this.Bh=r|0,this.Bl=s|0,this.Ch=i|0,this.Cl=o|0,this.Dh=a|0,this.Dl=l|0,this.Eh=u|0,this.El=h|0,this.Fh=c|0,this.Fl=d|0,this.Gh=f|0,this.Gl=g|0,this.Hh=y|0,this.Hl=m|0}process(t,e){for(let w=0;w<16;w++,e+=4)zr[w]=t.getUint32(e),qr[w]=t.getUint32(e+=4);for(let w=16;w<80;w++){const S=zr[w-15]|0,A=qr[w-15]|0,E=fe.rotrSH(S,A,1)^fe.rotrSH(S,A,8)^fe.shrSH(S,A,7),I=fe.rotrSL(S,A,1)^fe.rotrSL(S,A,8)^fe.shrSL(S,A,7),k=zr[w-2]|0,x=qr[w-2]|0,U=fe.rotrSH(k,x,19)^fe.rotrBH(k,x,61)^fe.shrSH(k,x,6),B=fe.rotrSL(k,x,19)^fe.rotrBL(k,x,61)^fe.shrSL(k,x,6),N=fe.add4L(I,B,qr[w-7],qr[w-16]),z=fe.add4H(N,E,U,zr[w-7],zr[w-16]);zr[w]=z|0,qr[w]=N|0}let{Ah:r,Al:s,Bh:i,Bl:o,Ch:a,Cl:l,Dh:u,Dl:h,Eh:c,El:d,Fh:f,Fl:g,Gh:y,Gl:m,Hh:v,Hl:_}=this;for(let w=0;w<80;w++){const S=fe.rotrSH(c,d,14)^fe.rotrSH(c,d,18)^fe.rotrBH(c,d,41),A=fe.rotrSL(c,d,14)^fe.rotrSL(c,d,18)^fe.rotrBL(c,d,41),E=c&f^~c&y,I=d&g^~d&m,k=fe.add5L(_,A,I,Hx[w],qr[w]),x=fe.add5H(k,v,S,E,Vx[w],zr[w]),U=k|0,B=fe.rotrSH(r,s,28)^fe.rotrBH(r,s,34)^fe.rotrBH(r,s,39),N=fe.rotrSL(r,s,28)^fe.rotrBL(r,s,34)^fe.rotrBL(r,s,39),z=r&i^r&a^i&a,D=s&o^s&l^o&l;v=y|0,_=m|0,y=f|0,m=g|0,f=c|0,g=d|0,{h:c,l:d}=fe.add(u|0,h|0,x|0,U|0),u=a|0,h=l|0,a=i|0,l=o|0,i=r|0,o=s|0;const L=fe.add3L(U,N,D);r=fe.add3H(L,x,B,z),s=L|0}({h:r,l:s}=fe.add(this.Ah|0,this.Al|0,r|0,s|0)),{h:i,l:o}=fe.add(this.Bh|0,this.Bl|0,i|0,o|0),{h:a,l}=fe.add(this.Ch|0,this.Cl|0,a|0,l|0),{h:u,l:h}=fe.add(this.Dh|0,this.Dl|0,u|0,h|0),{h:c,l:d}=fe.add(this.Eh|0,this.El|0,c|0,d|0),{h:f,l:g}=fe.add(this.Fh|0,this.Fl|0,f|0,g|0),{h:y,l:m}=fe.add(this.Gh|0,this.Gl|0,y|0,m|0),{h:v,l:_}=fe.add(this.Hh|0,this.Hl|0,v|0,_|0),this.set(r,s,i,o,a,l,u,h,c,d,f,g,y,m,v,_)}roundClean(){zr.fill(0),qr.fill(0)}destroy(){this.buffer.fill(0),this.set(0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0)}}const Ml=lf(()=>new zx);/*! noble-curves - MIT License (c) 2022 Paul Miller (paulmillr.com) */const Ll=BigInt(0),Bl=BigInt(1),qx=BigInt(2);function Os(n){return n instanceof Uint8Array||ArrayBuffer.isView(n)&&n.constructor.name==="Uint8Array"}function Ea(n){if(!Os(n))throw new Error("Uint8Array expected")}function Pr(n,t){if(typeof t!="boolean")throw new Error(n+" boolean expected, got "+t)}const Wx=Array.from({length:256},(n,t)=>t.toString(16).padStart(2,"0"));function Fs(n){Ea(n);let t="";for(let e=0;e<n.length;e++)t+=Wx[n[e]];return t}function pi(n){const t=n.toString(16);return t.length&1?"0"+t:t}function hf(n){if(typeof n!="string")throw new Error("hex string expected, got "+typeof n);return n===""?Ll:BigInt("0x"+n)}const hr={_0:48,_9:57,A:65,F:70,a:97,f:102};function Fp(n){if(n>=hr._0&&n<=hr._9)return n-hr._0;if(n>=hr.A&&n<=hr.F)return n-(hr.A-10);if(n>=hr.a&&n<=hr.f)return n-(hr.a-10)}function Fi(n){if(typeof n!="string")throw new Error("hex string expected, got "+typeof n);const t=n.length,e=t/2;if(t%2)throw new Error("hex string expected, got unpadded hex of length "+t);const r=new Uint8Array(e);for(let s=0,i=0;s<e;s++,i+=2){const o=Fp(n.charCodeAt(i)),a=Fp(n.charCodeAt(i+1));if(o===void 0||a===void 0){const l=n[i]+n[i+1];throw new Error('hex string expected, got non-hex character "'+l+'" at index '+i)}r[s]=o*16+a}return r}function Cs(n){return hf(Fs(n))}function Ai(n){return Ea(n),hf(Fs(Uint8Array.from(n).reverse()))}function $i(n,t){return Fi(n.toString(16).padStart(t*2,"0"))}function Zo(n,t){return $i(n,t).reverse()}function Gx(n){return Fi(pi(n))}function dt(n,t,e){let r;if(typeof t=="string")try{r=Fi(t)}catch(i){throw new Error(n+" must be hex string or Uint8Array, cause: "+i)}else if(Os(t))r=Uint8Array.from(t);else throw new Error(n+" must be hex string or Uint8Array");const s=r.length;if(typeof e=="number"&&s!==e)throw new Error(n+" of length "+e+" expected, got "+s);return r}function $s(...n){let t=0;for(let r=0;r<n.length;r++){const s=n[r];Ea(s),t+=s.length}const e=new Uint8Array(t);for(let r=0,s=0;r<n.length;r++){const i=n[r];e.set(i,s),s+=i.length}return e}function Kx(n,t){if(n.length!==t.length)return!1;let e=0;for(let r=0;r<n.length;r++)e|=n[r]^t[r];return e===0}function Yx(n){if(typeof n!="string")throw new Error("string expected");return new Uint8Array(new TextEncoder().encode(n))}const hu=n=>typeof n=="bigint"&&Ll<=n;function Nl(n,t,e){return hu(n)&&hu(t)&&hu(e)&&t<=n&&n<e}function Pn(n,t,e,r){if(!Nl(t,e,r))throw new Error("expected valid "+n+": "+e+" <= n < "+r+", got "+t)}function _b(n){let t;for(t=0;n>Ll;n>>=Bl,t+=1);return t}function Qx(n,t){return n>>BigInt(t)&Bl}function jx(n,t,e){return n|(e?Bl:Ll)<<BigInt(t)}const ff=n=>(qx<<BigInt(n-1))-Bl,fu=n=>new Uint8Array(n),$p=n=>Uint8Array.from(n);function Sb(n,t,e){if(typeof n!="number"||n<2)throw new Error("hashLen must be a number");if(typeof t!="number"||t<2)throw new Error("qByteLen must be a number");if(typeof e!="function")throw new Error("hmacFn must be a function");let r=fu(n),s=fu(n),i=0;const o=()=>{r.fill(1),s.fill(0),i=0},a=(...c)=>e(s,r,...c),l=(c=fu())=>{s=a($p([0]),c),r=a(),c.length!==0&&(s=a($p([1]),c),r=a())},u=()=>{if(i++>=1e3)throw new Error("drbg: tried 1000 values");let c=0;const d=[];for(;c<t;){r=a();const f=r.slice();d.push(f),c+=r.length}return $s(...d)};return(c,d)=>{o(),l(c);let f;for(;!(f=d(u()));)l();return o(),f}}const Zx={bigint:n=>typeof n=="bigint",function:n=>typeof n=="function",boolean:n=>typeof n=="boolean",string:n=>typeof n=="string",stringOrUint8Array:n=>typeof n=="string"||Os(n),isSafeInteger:n=>Number.isSafeInteger(n),array:n=>Array.isArray(n),field:(n,t)=>t.Fp.isValid(n),hash:n=>typeof n=="function"&&Number.isSafeInteger(n.outputLen)};function co(n,t,e={}){const r=(s,i,o)=>{const a=Zx[i];if(typeof a!="function")throw new Error("invalid validator function");const l=n[s];if(!(o&&l===void 0)&&!a(l,n))throw new Error("param "+String(s)+" is invalid. Expected "+i+", got "+l)};for(const[s,i]of Object.entries(t))r(s,i,!1);for(const[s,i]of Object.entries(e))r(s,i,!0);return n}const Xx=()=>{throw new Error("not implemented")};function Xo(n){const t=new WeakMap;return(e,...r)=>{const s=t.get(e);if(s!==void 0)return s;const i=n(e,...r);return t.set(e,i),i}}const Jx=Object.freeze(Object.defineProperty({__proto__:null,aInRange:Pn,abool:Pr,abytes:Ea,bitGet:Qx,bitLen:_b,bitMask:ff,bitSet:jx,bytesToHex:Fs,bytesToNumberBE:Cs,bytesToNumberLE:Ai,concatBytes:$s,createHmacDrbg:Sb,ensureBytes:dt,equalBytes:Kx,hexToBytes:Fi,hexToNumber:hf,inRange:Nl,isBytes:Os,memoized:Xo,notImplemented:Xx,numberToBytesBE:$i,numberToBytesLE:Zo,numberToHexUnpadded:pi,numberToVarBytesBE:Gx,utf8ToBytes:Yx,validateObject:co},Symbol.toStringTag,{value:"Module"}));/*! noble-curves - MIT License (c) 2022 Paul Miller (paulmillr.com) */const St=BigInt(0),Je=BigInt(1),ys=BigInt(2),e2=BigInt(3),Ld=BigInt(4),Up=BigInt(5),Vp=BigInt(8);function je(n,t){const e=n%t;return e>=St?e:t+e}function t2(n,t,e){if(t<St)throw new Error("invalid exponent, negatives unsupported");if(e<=St)throw new Error("invalid modulus");if(e===Je)return St;let r=Je;for(;t>St;)t&Je&&(r=r*n%e),n=n*n%e,t>>=Je;return r}function et(n,t,e){let r=n;for(;t-- >St;)r*=r,r%=e;return r}function Bd(n,t){if(n===St)throw new Error("invert: expected non-zero number");if(t<=St)throw new Error("invert: expected positive modulus, got "+t);let e=je(n,t),r=t,s=St,i=Je;for(;e!==St;){const a=r/e,l=r%e,u=s-i*a;r=e,e=l,s=i,i=u}if(r!==Je)throw new Error("invert: does not exist");return je(s,t)}function n2(n){const t=(n-Je)/ys;let e,r,s;for(e=n-Je,r=0;e%ys===St;e/=ys,r++);for(s=ys;s<n&&t2(s,t,n)!==n-Je;s++)if(s>1e3)throw new Error("Cannot find square root: likely non-prime P");if(r===1){const o=(n+Je)/Ld;return function(l,u){const h=l.pow(u,o);if(!l.eql(l.sqr(h),u))throw new Error("Cannot find square root");return h}}const i=(e+Je)/ys;return function(a,l){if(a.pow(l,t)===a.neg(a.ONE))throw new Error("Cannot find square root");let u=r,h=a.pow(a.mul(a.ONE,s),e),c=a.pow(l,i),d=a.pow(l,e);for(;!a.eql(d,a.ONE);){if(a.eql(d,a.ZERO))return a.ZERO;let f=1;for(let y=a.sqr(d);f<u&&!a.eql(y,a.ONE);f++)y=a.sqr(y);const g=a.pow(h,Je<<BigInt(u-f-1));h=a.sqr(g),c=a.mul(c,g),d=a.mul(d,h),u=f}return c}}function r2(n){if(n%Ld===e2){const t=(n+Je)/Ld;return function(r,s){const i=r.pow(s,t);if(!r.eql(r.sqr(i),s))throw new Error("Cannot find square root");return i}}if(n%Vp===Up){const t=(n-Up)/Vp;return function(r,s){const i=r.mul(s,ys),o=r.pow(i,t),a=r.mul(s,o),l=r.mul(r.mul(a,ys),o),u=r.mul(a,r.sub(l,r.ONE));if(!r.eql(r.sqr(u),s))throw new Error("Cannot find square root");return u}}return n2(n)}const s2=(n,t)=>(je(n,t)&Je)===Je,i2=["create","isValid","is0","neg","inv","sqrt","sqr","eql","add","sub","mul","pow","div","addN","subN","mulN","sqrN"];function o2(n){const t={ORDER:"bigint",MASK:"bigint",BYTES:"isSafeInteger",BITS:"isSafeInteger"},e=i2.reduce((r,s)=>(r[s]="function",r),t);return co(n,e)}function a2(n,t,e){if(e<St)throw new Error("invalid exponent, negatives unsupported");if(e===St)return n.ONE;if(e===Je)return t;let r=n.ONE,s=t;for(;e>St;)e&Je&&(r=n.mul(r,s)),s=n.sqr(s),e>>=Je;return r}function c2(n,t){const e=new Array(t.length),r=t.reduce((i,o,a)=>n.is0(o)?i:(e[a]=i,n.mul(i,o)),n.ONE),s=n.inv(r);return t.reduceRight((i,o,a)=>n.is0(o)?i:(e[a]=n.mul(i,e[a]),n.mul(i,o)),s),e}function Eb(n,t){const e=t!==void 0?t:n.toString(2).length,r=Math.ceil(e/8);return{nBitLength:e,nByteLength:r}}function Rl(n,t,e=!1,r={}){if(n<=St)throw new Error("invalid field: expected ORDER > 0, got "+n);const{nBitLength:s,nByteLength:i}=Eb(n,t);if(i>2048)throw new Error("invalid field: expected ORDER of <= 2048 bytes");let o;const a=Object.freeze({ORDER:n,isLE:e,BITS:s,BYTES:i,MASK:ff(s),ZERO:St,ONE:Je,create:l=>je(l,n),isValid:l=>{if(typeof l!="bigint")throw new Error("invalid field element: expected bigint, got "+typeof l);return St<=l&&l<n},is0:l=>l===St,isOdd:l=>(l&Je)===Je,neg:l=>je(-l,n),eql:(l,u)=>l===u,sqr:l=>je(l*l,n),add:(l,u)=>je(l+u,n),sub:(l,u)=>je(l-u,n),mul:(l,u)=>je(l*u,n),pow:(l,u)=>a2(a,l,u),div:(l,u)=>je(l*Bd(u,n),n),sqrN:l=>l*l,addN:(l,u)=>l+u,subN:(l,u)=>l-u,mulN:(l,u)=>l*u,inv:l=>Bd(l,n),sqrt:r.sqrt||(l=>(o||(o=r2(n)),o(a,l))),invertBatch:l=>c2(a,l),cmov:(l,u,h)=>h?u:l,toBytes:l=>e?Zo(l,i):$i(l,i),fromBytes:l=>{if(l.length!==i)throw new Error("Field.fromBytes: expected "+i+" bytes, got "+l.length);return e?Ai(l):Cs(l)}});return Object.freeze(a)}function Ab(n){if(typeof n!="bigint")throw new Error("field order must be bigint");const t=n.toString(2).length;return Math.ceil(t/8)}function xb(n){const t=Ab(n);return t+Math.ceil(t/2)}function l2(n,t,e=!1){const r=n.length,s=Ab(t),i=xb(t);if(r<16||r<i||r>1024)throw new Error("expected "+i+"-1024 bytes of input, got "+r);const o=e?Ai(n):Cs(n),a=je(o,t-Je)+Je;return e?Zo(a,s):$i(a,s)}/*! noble-curves - MIT License (c) 2022 Paul Miller (paulmillr.com) */const Hp=BigInt(0),Na=BigInt(1);function pu(n,t){const e=t.negate();return n?e:t}function Ib(n,t){if(!Number.isSafeInteger(n)||n<=0||n>t)throw new Error("invalid window size, expected [1.."+t+"], got W="+n)}function gu(n,t){Ib(n,t);const e=Math.ceil(t/n)+1,r=2**(n-1);return{windows:e,windowSize:r}}function u2(n,t){if(!Array.isArray(n))throw new Error("array expected");n.forEach((e,r)=>{if(!(e instanceof t))throw new Error("invalid point at index "+r)})}function d2(n,t){if(!Array.isArray(n))throw new Error("array of scalars expected");n.forEach((e,r)=>{if(!t.isValid(e))throw new Error("invalid scalar at index "+r)})}const mu=new WeakMap,kb=new WeakMap;function yu(n){return kb.get(n)||1}function Tb(n,t){return{constTimeNegate:pu,hasPrecomputes(e){return yu(e)!==1},unsafeLadder(e,r,s=n.ZERO){let i=e;for(;r>Hp;)r&Na&&(s=s.add(i)),i=i.double(),r>>=Na;return s},precomputeWindow(e,r){const{windows:s,windowSize:i}=gu(r,t),o=[];let a=e,l=a;for(let u=0;u<s;u++){l=a,o.push(l);for(let h=1;h<i;h++)l=l.add(a),o.push(l);a=l.double()}return o},wNAF(e,r,s){const{windows:i,windowSize:o}=gu(e,t);let a=n.ZERO,l=n.BASE;const u=BigInt(2**e-1),h=2**e,c=BigInt(e);for(let d=0;d<i;d++){const f=d*o;let g=Number(s&u);s>>=c,g>o&&(g-=h,s+=Na);const y=f,m=f+Math.abs(g)-1,v=d%2!==0,_=g<0;g===0?l=l.add(pu(v,r[y])):a=a.add(pu(_,r[m]))}return{p:a,f:l}},wNAFUnsafe(e,r,s,i=n.ZERO){const{windows:o,windowSize:a}=gu(e,t),l=BigInt(2**e-1),u=2**e,h=BigInt(e);for(let c=0;c<o;c++){const d=c*a;if(s===Hp)break;let f=Number(s&l);if(s>>=h,f>a&&(f-=u,s+=Na),f===0)continue;let g=r[d+Math.abs(f)-1];f<0&&(g=g.negate()),i=i.add(g)}return i},getPrecomputes(e,r,s){let i=mu.get(r);return i||(i=this.precomputeWindow(r,e),e!==1&&mu.set(r,s(i))),i},wNAFCached(e,r,s){const i=yu(e);return this.wNAF(i,this.getPrecomputes(i,e,s),r)},wNAFCachedUnsafe(e,r,s,i){const o=yu(e);return o===1?this.unsafeLadder(e,r,i):this.wNAFUnsafe(o,this.getPrecomputes(o,e,s),r,i)},setWindowSize(e,r){Ib(r,t),kb.set(e,r),mu.delete(e)}}}function Cb(n,t,e,r){if(u2(e,n),d2(r,t),e.length!==r.length)throw new Error("arrays of points and scalars must have equal length");const s=n.ZERO,i=_b(BigInt(e.length)),o=i>12?i-3:i>4?i-2:i?2:1,a=(1<<o)-1,l=new Array(a+1).fill(s),u=Math.floor((t.BITS-1)/o)*o;let h=s;for(let c=u;c>=0;c-=o){l.fill(s);for(let f=0;f<r.length;f++){const g=r[f],y=Number(g>>BigInt(c)&BigInt(a));l[y]=l[y].add(e[f])}let d=s;for(let f=l.length-1,g=s;f>0;f--)g=g.add(l[f]),d=d.add(g);if(h=h.add(d),c!==0)for(let f=0;f<o;f++)h=h.double()}return h}function pf(n){return o2(n.Fp),co(n,{n:"bigint",h:"bigint",Gx:"field",Gy:"field"},{nBitLength:"isSafeInteger",nByteLength:"isSafeInteger"}),Object.freeze({...Eb(n.n,n.nBitLength),...n,p:n.Fp.ORDER})}/*! noble-curves - MIT License (c) 2022 Paul Miller (paulmillr.com) */const Ln=BigInt(0),Zt=BigInt(1),Ra=BigInt(2),h2=BigInt(8),f2={zip215:!0};function p2(n){const t=pf(n);return co(n,{hash:"function",a:"bigint",d:"bigint",randomBytes:"function"},{adjustScalarBytes:"function",domain:"function",uvRatio:"function",mapToCurve:"function"}),Object.freeze({...t})}function g2(n){const t=p2(n),{Fp:e,n:r,prehash:s,hash:i,randomBytes:o,nByteLength:a,h:l}=t,u=Ra<<BigInt(a*8)-Zt,h=e.create,c=Rl(t.n,t.nBitLength),d=t.uvRatio||((P,T)=>{try{return{isValid:!0,value:e.sqrt(P*e.inv(T))}}catch{return{isValid:!1,value:Ln}}}),f=t.adjustScalarBytes||(P=>P),g=t.domain||((P,T,C)=>{if(Pr("phflag",C),T.length||C)throw new Error("Contexts/pre-hash are not supported");return P});function y(P,T){Pn("coordinate "+P,T,Ln,u)}function m(P){if(!(P instanceof w))throw new Error("ExtendedPoint expected")}const v=Xo((P,T)=>{const{ex:C,ey:R,ez:O}=P,V=P.is0();T==null&&(T=V?h2:e.inv(O));const K=h(C*T),ee=h(R*T),Y=h(O*T);if(V)return{x:Ln,y:Zt};if(Y!==Zt)throw new Error("invZ was invalid");return{x:K,y:ee}}),_=Xo(P=>{const{a:T,d:C}=t;if(P.is0())throw new Error("bad point: ZERO");const{ex:R,ey:O,ez:V,et:K}=P,ee=h(R*R),Y=h(O*O),le=h(V*V),re=h(le*le),be=h(ee*T),q=h(le*h(be+Y)),ue=h(re+h(C*h(ee*Y)));if(q!==ue)throw new Error("bad point: equation left != right (1)");const Ee=h(R*O),we=h(V*K);if(Ee!==we)throw new Error("bad point: equation left != right (2)");return!0});class w{constructor(T,C,R,O){this.ex=T,this.ey=C,this.ez=R,this.et=O,y("x",T),y("y",C),y("z",R),y("t",O),Object.freeze(this)}get x(){return this.toAffine().x}get y(){return this.toAffine().y}static fromAffine(T){if(T instanceof w)throw new Error("extended point not allowed");const{x:C,y:R}=T||{};return y("x",C),y("y",R),new w(C,R,Zt,h(C*R))}static normalizeZ(T){const C=e.invertBatch(T.map(R=>R.ez));return T.map((R,O)=>R.toAffine(C[O])).map(w.fromAffine)}static msm(T,C){return Cb(w,c,T,C)}_setWindowSize(T){E.setWindowSize(this,T)}assertValidity(){_(this)}equals(T){m(T);const{ex:C,ey:R,ez:O}=this,{ex:V,ey:K,ez:ee}=T,Y=h(C*ee),le=h(V*O),re=h(R*ee),be=h(K*O);return Y===le&&re===be}is0(){return this.equals(w.ZERO)}negate(){return new w(h(-this.ex),this.ey,this.ez,h(-this.et))}double(){const{a:T}=t,{ex:C,ey:R,ez:O}=this,V=h(C*C),K=h(R*R),ee=h(Ra*h(O*O)),Y=h(T*V),le=C+R,re=h(h(le*le)-V-K),be=Y+K,q=be-ee,ue=Y-K,Ee=h(re*q),we=h(be*ue),H=h(re*ue),ne=h(q*be);return new w(Ee,we,ne,H)}add(T){m(T);const{a:C,d:R}=t,{ex:O,ey:V,ez:K,et:ee}=this,{ex:Y,ey:le,ez:re,et:be}=T;if(C===BigInt(-1)){const go=h((V-O)*(le+Y)),mo=h((V+O)*(le-Y)),fs=h(mo-go);if(fs===Ln)return this.double();const yo=h(K*Ra*be),Da=h(ee*Ra*re),ti=Da+yo,ni=mo+go,ri=Da-yo,E1=h(ti*fs),A1=h(ni*ri),x1=h(ti*ri),I1=h(fs*ni);return new w(E1,A1,I1,x1)}const q=h(O*Y),ue=h(V*le),Ee=h(ee*R*be),we=h(K*re),H=h((O+V)*(Y+le)-q-ue),ne=we-Ee,De=we+Ee,Pt=h(ue-C*q),po=h(H*ne),Hr=h(De*Pt),ei=h(H*Pt),iu=h(ne*De);return new w(po,Hr,iu,ei)}subtract(T){return this.add(T.negate())}wNAF(T){return E.wNAFCached(this,T,w.normalizeZ)}multiply(T){const C=T;Pn("scalar",C,Zt,r);const{p:R,f:O}=this.wNAF(C);return w.normalizeZ([R,O])[0]}multiplyUnsafe(T,C=w.ZERO){const R=T;return Pn("scalar",R,Ln,r),R===Ln?A:this.is0()||R===Zt?this:E.wNAFCachedUnsafe(this,R,w.normalizeZ,C)}isSmallOrder(){return this.multiplyUnsafe(l).is0()}isTorsionFree(){return E.unsafeLadder(this,r).is0()}toAffine(T){return v(this,T)}clearCofactor(){const{h:T}=t;return T===Zt?this:this.multiplyUnsafe(T)}static fromHex(T,C=!1){const{d:R,a:O}=t,V=e.BYTES;T=dt("pointHex",T,V),Pr("zip215",C);const K=T.slice(),ee=T[V-1];K[V-1]=ee&-129;const Y=Ai(K),le=C?u:e.ORDER;Pn("pointHex.y",Y,Ln,le);const re=h(Y*Y),be=h(re-Zt),q=h(R*re-O);let{isValid:ue,value:Ee}=d(be,q);if(!ue)throw new Error("Point.fromHex: invalid y coordinate");const we=(Ee&Zt)===Zt,H=(ee&128)!==0;if(!C&&Ee===Ln&&H)throw new Error("Point.fromHex: x=0 and x_0=1");return H!==we&&(Ee=h(-Ee)),w.fromAffine({x:Ee,y:Y})}static fromPrivateKey(T){return x(T).point}toRawBytes(){const{x:T,y:C}=this.toAffine(),R=Zo(C,e.BYTES);return R[R.length-1]|=T&Zt?128:0,R}toHex(){return Fs(this.toRawBytes())}}w.BASE=new w(t.Gx,t.Gy,Zt,h(t.Gx*t.Gy)),w.ZERO=new w(Ln,Zt,Zt,Ln);const{BASE:S,ZERO:A}=w,E=Tb(w,a*8);function I(P){return je(P,r)}function k(P){return I(Ai(P))}function x(P){const T=e.BYTES;P=dt("private key",P,T);const C=dt("hashed private key",i(P),2*T),R=f(C.slice(0,T)),O=C.slice(T,2*T),V=k(R),K=S.multiply(V),ee=K.toRawBytes();return{head:R,prefix:O,scalar:V,point:K,pointBytes:ee}}function U(P){return x(P).pointBytes}function B(P=new Uint8Array,...T){const C=$s(...T);return k(i(g(C,dt("context",P),!!s)))}function N(P,T,C={}){P=dt("message",P),s&&(P=s(P));const{prefix:R,scalar:O,pointBytes:V}=x(T),K=B(C.context,R,P),ee=S.multiply(K).toRawBytes(),Y=B(C.context,ee,V,P),le=I(K+Y*O);Pn("signature.s",le,Ln,r);const re=$s(ee,Zo(le,e.BYTES));return dt("result",re,e.BYTES*2)}const z=f2;function D(P,T,C,R=z){const{context:O,zip215:V}=R,K=e.BYTES;P=dt("signature",P,2*K),T=dt("message",T),C=dt("publicKey",C,K),V!==void 0&&Pr("zip215",V),s&&(T=s(T));const ee=Ai(P.slice(K,2*K));let Y,le,re;try{Y=w.fromHex(C,V),le=w.fromHex(P.slice(0,K),V),re=S.multiplyUnsafe(ee)}catch{return!1}if(!V&&Y.isSmallOrder())return!1;const be=B(O,le.toRawBytes(),Y.toRawBytes(),T);return le.add(Y.multiplyUnsafe(be)).subtract(re).clearCofactor().equals(w.ZERO)}return S._setWindowSize(8),{CURVE:t,getPublicKey:U,sign:N,verify:D,ExtendedPoint:w,utils:{getExtendedPublicKey:x,randomPrivateKey:()=>o(e.BYTES),precompute(P=8,T=w.BASE){return T._setWindowSize(P),T.multiply(BigInt(3)),T}}}}/*! noble-curves - MIT License (c) 2022 Paul Miller (paulmillr.com) */const gf=BigInt("57896044618658097711785492504343953926634992332820282019728792003956564819949"),zp=BigInt("19681161376707505956807079304988542015446066515923890162744021073123829784752");BigInt(0);const m2=BigInt(1),qp=BigInt(2);BigInt(3);const y2=BigInt(5),v2=BigInt(8);function b2(n){const t=BigInt(10),e=BigInt(20),r=BigInt(40),s=BigInt(80),i=gf,a=n*n%i*n%i,l=et(a,qp,i)*a%i,u=et(l,m2,i)*n%i,h=et(u,y2,i)*u%i,c=et(h,t,i)*h%i,d=et(c,e,i)*c%i,f=et(d,r,i)*d%i,g=et(f,s,i)*f%i,y=et(g,s,i)*f%i,m=et(y,t,i)*h%i;return{pow_p_5_8:et(m,qp,i)*n%i,b2:a}}function w2(n){return n[0]&=248,n[31]&=127,n[31]|=64,n}function _2(n,t){const e=gf,r=je(t*t*t,e),s=je(r*r*t,e),i=b2(n*s).pow_p_5_8;let o=je(n*r*i,e);const a=je(t*o*o,e),l=o,u=je(o*zp,e),h=a===n,c=a===je(-n,e),d=a===je(-n*zp,e);return h&&(o=l),(c||d)&&(o=u),s2(o,e)&&(o=je(-o,e)),{isValid:h||c,value:o}}const S2=Rl(gf,void 0,!0),E2={a:BigInt(-1),d:BigInt("37095705934669439343138083508754565189542113879843219016388785533085940283555"),Fp:S2,n:BigInt("7237005577332262213973186563042994240857116359379907606001950938285454250989"),h:v2,Gx:BigInt("15112221349535400772501151409588531511454012693041857206046113283949847762202"),Gy:BigInt("46316835694926478169428394003475163141307993866256225615783033603165251855960"),hash:Ml,randomBytes:uf,adjustScalarBytes:w2,uvRatio:_2},Pc=g2(E2),Dc=32,Qr=64,Nd=32;function A2(){const n=Pc.utils.randomPrivateKey(),t=Pc.getPublicKey(n);return{privateKey:k2(n,t),publicKey:t}}function x2(n,t){const e=n.subarray(0,Nd);return Pc.sign(t instanceof Uint8Array?t:t.subarray(),e)}function I2(n,t,e){return Pc.verify(t,e instanceof Uint8Array?e:e.subarray(),n)}function k2(n,t){const e=new Uint8Array(Qr);for(let r=0;r<Nd;r++)e[r]=n[r],e[Nd+r]=t[r];return e}class Pb{constructor(t){p(this,"type","Ed25519");p(this,"raw");this.raw=Jo(t,Dc)}toMultihash(){return Pl.digest(nr(this))}toCID(){return Qe.createV1(114,this.toMultihash())}toString(){return ot.encode(this.toMultihash().bytes).substring(1)}equals(t){return t==null||!(t.raw instanceof Uint8Array)?!1:It(this.raw,t.raw)}verify(t,e){return I2(this.raw,e,t)}}class Rd{constructor(t,e){p(this,"type","Ed25519");p(this,"raw");p(this,"publicKey");this.raw=Jo(t,Qr),this.publicKey=new Pb(e)}equals(t){return t==null||!(t.raw instanceof Uint8Array)?!1:It(this.raw,t.raw)}sign(t){return x2(this.raw,t)}}function Db(n){if(n.length>Qr){n=Jo(n,Qr+Dc);const r=n.subarray(0,Qr),s=n.subarray(Qr,n.length);return new Rd(r,s)}n=Jo(n,Qr);const t=n.subarray(0,Qr),e=n.subarray(Dc);return new Rd(t,e)}function mf(n){return n=Jo(n,Dc),new Pb(n)}async function T2(){const{privateKey:n,publicKey:t}=A2();return new Rd(n,t)}function Jo(n,t){if(n=Uint8Array.from(n??[]),n.length!==t)throw new Z(`Key must be a Uint8Array of length ${t}, got ${n.length}`);return n}function Ke(n=0){return new Uint8Array(n)}function cr(n=0){return new Uint8Array(n)}const C2=Math.pow(2,7),P2=Math.pow(2,14),D2=Math.pow(2,21),yf=Math.pow(2,28),vf=Math.pow(2,35),bf=Math.pow(2,42),wf=Math.pow(2,49),Le=128,Dt=127;function ln(n){if(n<C2)return 1;if(n<P2)return 2;if(n<D2)return 3;if(n<yf)return 4;if(n<vf)return 5;if(n<bf)return 6;if(n<wf)return 7;if(Number.MAX_SAFE_INTEGER!=null&&n>Number.MAX_SAFE_INTEGER)throw new RangeError("Could not encode varint");return 8}function Mb(n,t,e=0){switch(ln(n)){case 8:t[e++]=n&255|Le,n/=128;case 7:t[e++]=n&255|Le,n/=128;case 6:t[e++]=n&255|Le,n/=128;case 5:t[e++]=n&255|Le,n/=128;case 4:t[e++]=n&255|Le,n>>>=7;case 3:t[e++]=n&255|Le,n>>>=7;case 2:t[e++]=n&255|Le,n>>>=7;case 1:{t[e++]=n&255,n>>>=7;break}default:throw new Error("unreachable")}return t}function M2(n,t,e=0){switch(ln(n)){case 8:t.set(e++,n&255|Le),n/=128;case 7:t.set(e++,n&255|Le),n/=128;case 6:t.set(e++,n&255|Le),n/=128;case 5:t.set(e++,n&255|Le),n/=128;case 4:t.set(e++,n&255|Le),n>>>=7;case 3:t.set(e++,n&255|Le),n>>>=7;case 2:t.set(e++,n&255|Le),n>>>=7;case 1:{t.set(e++,n&255),n>>>=7;break}default:throw new Error("unreachable")}return t}function Lb(n,t){let e=n[t],r=0;if(r+=e&Dt,e<Le||(e=n[t+1],r+=(e&Dt)<<7,e<Le)||(e=n[t+2],r+=(e&Dt)<<14,e<Le)||(e=n[t+3],r+=(e&Dt)<<21,e<Le)||(e=n[t+4],r+=(e&Dt)*yf,e<Le)||(e=n[t+5],r+=(e&Dt)*vf,e<Le)||(e=n[t+6],r+=(e&Dt)*bf,e<Le)||(e=n[t+7],r+=(e&Dt)*wf,e<Le))return r;throw new RangeError("Could not decode varint")}function L2(n,t){let e=n.get(t),r=0;if(r+=e&Dt,e<Le||(e=n.get(t+1),r+=(e&Dt)<<7,e<Le)||(e=n.get(t+2),r+=(e&Dt)<<14,e<Le)||(e=n.get(t+3),r+=(e&Dt)<<21,e<Le)||(e=n.get(t+4),r+=(e&Dt)*yf,e<Le)||(e=n.get(t+5),r+=(e&Dt)*vf,e<Le)||(e=n.get(t+6),r+=(e&Dt)*bf,e<Le)||(e=n.get(t+7),r+=(e&Dt)*wf,e<Le))return r;throw new RangeError("Could not decode varint")}function Vn(n,t,e=0){return t==null&&(t=cr(ln(n))),t instanceof Uint8Array?Mb(n,t,e):M2(n,t,e)}function js(n,t=0){return n instanceof Uint8Array?Lb(n,t):L2(n,t)}const _f=new Float32Array([-0]),rs=new Uint8Array(_f.buffer);function B2(n,t,e){_f[0]=n,t[e]=rs[0],t[e+1]=rs[1],t[e+2]=rs[2],t[e+3]=rs[3]}function N2(n,t){return rs[0]=n[t],rs[1]=n[t+1],rs[2]=n[t+2],rs[3]=n[t+3],_f[0]}const Sf=new Float64Array([-0]),Mt=new Uint8Array(Sf.buffer);function R2(n,t,e){Sf[0]=n,t[e]=Mt[0],t[e+1]=Mt[1],t[e+2]=Mt[2],t[e+3]=Mt[3],t[e+4]=Mt[4],t[e+5]=Mt[5],t[e+6]=Mt[6],t[e+7]=Mt[7]}function O2(n,t){return Mt[0]=n[t],Mt[1]=n[t+1],Mt[2]=n[t+2],Mt[3]=n[t+3],Mt[4]=n[t+4],Mt[5]=n[t+5],Mt[6]=n[t+6],Mt[7]=n[t+7],Sf[0]}const F2=BigInt(Number.MAX_SAFE_INTEGER),$2=BigInt(Number.MIN_SAFE_INTEGER);class Rt{constructor(t,e){p(this,"lo");p(this,"hi");this.lo=t|0,this.hi=e|0}toNumber(t=!1){if(!t&&this.hi>>>31>0){const e=~this.lo+1>>>0;let r=~this.hi>>>0;return e===0&&(r=r+1>>>0),-(e+r*4294967296)}return this.lo+this.hi*4294967296}toBigInt(t=!1){if(t)return BigInt(this.lo>>>0)+(BigInt(this.hi>>>0)<<32n);if(this.hi>>>31){const e=~this.lo+1>>>0;let r=~this.hi>>>0;return e===0&&(r=r+1>>>0),-(BigInt(e)+(BigInt(r)<<32n))}return BigInt(this.lo>>>0)+(BigInt(this.hi>>>0)<<32n)}toString(t=!1){return this.toBigInt(t).toString()}zzEncode(){const t=this.hi>>31;return this.hi=((this.hi<<1|this.lo>>>31)^t)>>>0,this.lo=(this.lo<<1^t)>>>0,this}zzDecode(){const t=-(this.lo&1);return this.lo=((this.lo>>>1|this.hi<<31)^t)>>>0,this.hi=(this.hi>>>1^t)>>>0,this}length(){const t=this.lo,e=(this.lo>>>28|this.hi<<4)>>>0,r=this.hi>>>24;return r===0?e===0?t<16384?t<128?1:2:t<2097152?3:4:e<16384?e<128?5:6:e<2097152?7:8:r<128?9:10}static fromBigInt(t){if(t===0n)return Ps;if(t<F2&&t>$2)return this.fromNumber(Number(t));const e=t<0n;e&&(t=-t);let r=t>>32n,s=t-(r<<32n);return e&&(r=~r|0n,s=~s|0n,++s>Wp&&(s=0n,++r>Wp&&(r=0n))),new Rt(Number(s),Number(r))}static fromNumber(t){if(t===0)return Ps;const e=t<0;e&&(t=-t);let r=t>>>0,s=(t-r)/4294967296>>>0;return e&&(s=~s>>>0,r=~r>>>0,++r>4294967295&&(r=0,++s>4294967295&&(s=0))),new Rt(r,s)}static from(t){return typeof t=="number"?Rt.fromNumber(t):typeof t=="bigint"?Rt.fromBigInt(t):typeof t=="string"?Rt.fromBigInt(BigInt(t)):t.low!=null||t.high!=null?new Rt(t.low>>>0,t.high>>>0):Ps}}const Ps=new Rt(0,0);Ps.toBigInt=function(){return 0n};Ps.zzEncode=Ps.zzDecode=function(){return this};Ps.length=function(){return 1};const Wp=4294967296n;function U2(n){let t=0,e=0;for(let r=0;r<n.length;++r)e=n.charCodeAt(r),e<128?t+=1:e<2048?t+=2:(e&64512)===55296&&(n.charCodeAt(r+1)&64512)===56320?(++r,t+=4):t+=3;return t}function V2(n,t,e){if(e-t<1)return"";let s;const i=[];let o=0,a;for(;t<e;)a=n[t++],a<128?i[o++]=a:a>191&&a<224?i[o++]=(a&31)<<6|n[t++]&63:a>239&&a<365?(a=((a&7)<<18|(n[t++]&63)<<12|(n[t++]&63)<<6|n[t++]&63)-65536,i[o++]=55296+(a>>10),i[o++]=56320+(a&1023)):i[o++]=(a&15)<<12|(n[t++]&63)<<6|n[t++]&63,o>8191&&((s??(s=[])).push(String.fromCharCode.apply(String,i)),o=0);return s!=null?(o>0&&s.push(String.fromCharCode.apply(String,i.slice(0,o))),s.join("")):String.fromCharCode.apply(String,i.slice(0,o))}function Bb(n,t,e){const r=e;let s,i;for(let o=0;o<n.length;++o)s=n.charCodeAt(o),s<128?t[e++]=s:s<2048?(t[e++]=s>>6|192,t[e++]=s&63|128):(s&64512)===55296&&((i=n.charCodeAt(o+1))&64512)===56320?(s=65536+((s&1023)<<10)+(i&1023),++o,t[e++]=s>>18|240,t[e++]=s>>12&63|128,t[e++]=s>>6&63|128,t[e++]=s&63|128):(t[e++]=s>>12|224,t[e++]=s>>6&63|128,t[e++]=s&63|128);return e-r}function Bn(n,t){return RangeError(`index out of range: ${n.pos} + ${t??1} > ${n.len}`)}function Oa(n,t){return(n[t-4]|n[t-3]<<8|n[t-2]<<16|n[t-1]<<24)>>>0}class H2{constructor(t){p(this,"buf");p(this,"pos");p(this,"len");p(this,"_slice",Uint8Array.prototype.subarray);this.buf=t,this.pos=0,this.len=t.length}uint32(){let t=4294967295;if(t=(this.buf[this.pos]&127)>>>0,this.buf[this.pos++]<128||(t=(t|(this.buf[this.pos]&127)<<7)>>>0,this.buf[this.pos++]<128)||(t=(t|(this.buf[this.pos]&127)<<14)>>>0,this.buf[this.pos++]<128)||(t=(t|(this.buf[this.pos]&127)<<21)>>>0,this.buf[this.pos++]<128)||(t=(t|(this.buf[this.pos]&15)<<28)>>>0,this.buf[this.pos++]<128))return t;if((this.pos+=5)>this.len)throw this.pos=this.len,Bn(this,10);return t}int32(){return this.uint32()|0}sint32(){const t=this.uint32();return t>>>1^-(t&1)|0}bool(){return this.uint32()!==0}fixed32(){if(this.pos+4>this.len)throw Bn(this,4);return Oa(this.buf,this.pos+=4)}sfixed32(){if(this.pos+4>this.len)throw Bn(this,4);return Oa(this.buf,this.pos+=4)|0}float(){if(this.pos+4>this.len)throw Bn(this,4);const t=N2(this.buf,this.pos);return this.pos+=4,t}double(){if(this.pos+8>this.len)throw Bn(this,4);const t=O2(this.buf,this.pos);return this.pos+=8,t}bytes(){const t=this.uint32(),e=this.pos,r=this.pos+t;if(r>this.len)throw Bn(this,t);return this.pos+=t,e===r?new Uint8Array(0):this.buf.subarray(e,r)}string(){const t=this.bytes();return V2(t,0,t.length)}skip(t){if(typeof t=="number"){if(this.pos+t>this.len)throw Bn(this,t);this.pos+=t}else do if(this.pos>=this.len)throw Bn(this);while((this.buf[this.pos++]&128)!==0);return this}skipType(t){switch(t){case 0:this.skip();break;case 1:this.skip(8);break;case 2:this.skip(this.uint32());break;case 3:for(;(t=this.uint32()&7)!==4;)this.skipType(t);break;case 5:this.skip(4);break;default:throw Error(`invalid wire type ${t} at offset ${this.pos}`)}return this}readLongVarint(){const t=new Rt(0,0);let e=0;if(this.len-this.pos>4){for(;e<4;++e)if(t.lo=(t.lo|(this.buf[this.pos]&127)<<e*7)>>>0,this.buf[this.pos++]<128)return t;if(t.lo=(t.lo|(this.buf[this.pos]&127)<<28)>>>0,t.hi=(t.hi|(this.buf[this.pos]&127)>>4)>>>0,this.buf[this.pos++]<128)return t;e=0}else{for(;e<3;++e){if(this.pos>=this.len)throw Bn(this);if(t.lo=(t.lo|(this.buf[this.pos]&127)<<e*7)>>>0,this.buf[this.pos++]<128)return t}return t.lo=(t.lo|(this.buf[this.pos++]&127)<<e*7)>>>0,t}if(this.len-this.pos>4){for(;e<5;++e)if(t.hi=(t.hi|(this.buf[this.pos]&127)<<e*7+3)>>>0,this.buf[this.pos++]<128)return t}else for(;e<5;++e){if(this.pos>=this.len)throw Bn(this);if(t.hi=(t.hi|(this.buf[this.pos]&127)<<e*7+3)>>>0,this.buf[this.pos++]<128)return t}throw Error("invalid varint encoding")}readFixed64(){if(this.pos+8>this.len)throw Bn(this,8);const t=Oa(this.buf,this.pos+=4),e=Oa(this.buf,this.pos+=4);return new Rt(t,e)}int64(){return this.readLongVarint().toBigInt()}int64Number(){return this.readLongVarint().toNumber()}int64String(){return this.readLongVarint().toString()}uint64(){return this.readLongVarint().toBigInt(!0)}uint64Number(){const t=Lb(this.buf,this.pos);return this.pos+=ln(t),t}uint64String(){return this.readLongVarint().toString(!0)}sint64(){return this.readLongVarint().zzDecode().toBigInt()}sint64Number(){return this.readLongVarint().zzDecode().toNumber()}sint64String(){return this.readLongVarint().zzDecode().toString()}fixed64(){return this.readFixed64().toBigInt()}fixed64Number(){return this.readFixed64().toNumber()}fixed64String(){return this.readFixed64().toString()}sfixed64(){return this.readFixed64().toBigInt()}sfixed64Number(){return this.readFixed64().toNumber()}sfixed64String(){return this.readFixed64().toString()}}function z2(n){return new H2(n instanceof Uint8Array?n:n.subarray())}function ke(n,t,e){const r=z2(n);return t.decode(r,void 0,e)}const q2=Sa({prefix:"9",name:"base10",alphabet:"0123456789"}),W2=Object.freeze(Object.defineProperty({__proto__:null,base10:q2},Symbol.toStringTag,{value:"Module"})),G2=Ct({prefix:"f",name:"base16",alphabet:"0123456789abcdef",bitsPerChar:4}),K2=Ct({prefix:"F",name:"base16upper",alphabet:"0123456789ABCDEF",bitsPerChar:4}),Y2=Object.freeze(Object.defineProperty({__proto__:null,base16:G2,base16upper:K2},Symbol.toStringTag,{value:"Module"})),Q2=Ct({prefix:"0",name:"base2",alphabet:"01",bitsPerChar:1}),j2=Object.freeze(Object.defineProperty({__proto__:null,base2:Q2},Symbol.toStringTag,{value:"Module"})),Nb=Array.from("ððªâð°ðððððððððððððâð»ð¥ð¾ð¿ðâ¤ðð¤£ðððð­ðððððð¥ð¥°ðððð¢ð¤ðððªðâºðð¤ððððð¹ð¤¦ððââ¨ð¤·ð±ðð¸ððððððððð¤©ððð¤ðð¯ððð¶ðð¤­â£ððððªðð¥ððð©ð¡ð¤ªðð¥³ð¥ð¤¤ððð³âððð´ðð¬ððð·ð»ðâ­âð¥ºððð¤ð¦âð£ððâ¹ððð âððºðð»ððððð¹ð£ð«ðððµð¤ðð´ð¤ð¼ð«â½ð¤âðð¤«ðð®ðð»ðð¶ðð²ð¿ð§¡ðâ¡ððââðð°ð¤¨ð¶ð¤ð¶ð°ðð¢ð¤ðð¨ð¨ð¤¬âððºð¤ððð±ðð¶ð¥´â¶â¡âðð¸â¬ð¨ðð¦ð·ðºâ ðððµðð¤²ð¤ ð¤§ððµðð§ð¾ððð¤ðð¤¯ð·âð§ð¯ððð¤ððâð´ð£ð¸ððð¥ð¤¢ðð¡ð©ðð¸ð»ð¤ð¤®ð¼ð¥µð©ððð¼ðð£ð¥"),Z2=Nb.reduce((n,t,e)=>(n[e]=t,n),[]),X2=Nb.reduce((n,t,e)=>{const r=t.codePointAt(0);if(r==null)throw new Error(`Invalid character: ${t}`);return n[r]=e,n},[]);function J2(n){return n.reduce((t,e)=>(t+=Z2[e],t),"")}function eI(n){const t=[];for(const e of n){const r=e.codePointAt(0);if(r==null)throw new Error(`Invalid character: ${e}`);const s=X2[r];if(s==null)throw new Error(`Non-base256emoji character: ${e}`);t.push(s)}return new Uint8Array(t)}const tI=Cl({prefix:"ð",name:"base256emoji",encode:J2,decode:eI}),nI=Object.freeze(Object.defineProperty({__proto__:null,base256emoji:tI},Symbol.toStringTag,{value:"Module"})),Aa=Ct({prefix:"m",name:"base64",alphabet:"ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/",bitsPerChar:6}),rI=Ct({prefix:"M",name:"base64pad",alphabet:"ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/=",bitsPerChar:6}),Rb=Ct({prefix:"u",name:"base64url",alphabet:"ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789-_",bitsPerChar:6}),sI=Ct({prefix:"U",name:"base64urlpad",alphabet:"ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789-_=",bitsPerChar:6}),iI=Object.freeze(Object.defineProperty({__proto__:null,base64:Aa,base64pad:rI,base64url:Rb,base64urlpad:sI},Symbol.toStringTag,{value:"Module"})),oI=Ct({prefix:"7",name:"base8",alphabet:"01234567",bitsPerChar:3}),aI=Object.freeze(Object.defineProperty({__proto__:null,base8:oI},Symbol.toStringTag,{value:"Module"})),cI=Cl({prefix:"\0",name:"identity",encode:n=>bA(n),decode:n=>vA(n)}),lI=Object.freeze(Object.defineProperty({__proto__:null,identity:cI},Symbol.toStringTag,{value:"Module"}));new TextEncoder;new TextDecoder;function uI({name:n,code:t,encode:e}){return new dI(n,t,e)}class dI{constructor(t,e,r){p(this,"name");p(this,"code");p(this,"encode");this.name=t,this.code=e,this.encode=r}digest(t){if(t instanceof Uint8Array){const e=this.encode(t);return e instanceof Uint8Array?Rs(this.code,e):e.then(r=>Rs(this.code,r))}else throw Error("Unknown type, must be binary type")}}function hI(n){return async t=>new Uint8Array(await crypto.subtle.digest(n,t))}const xa=uI({name:"sha2-256",code:18,encode:hI("SHA-256")}),Od={...lI,...j2,...aI,...W2,...Y2,...$A,...VA,...PA,...iI,...nI};function Ob(n,t,e,r){return{name:n,prefix:t,encoder:{name:n,prefix:t,encode:e},decoder:{decode:r}}}const Gp=Ob("utf8","u",n=>"u"+new TextDecoder("utf8").decode(n),n=>new TextEncoder().encode(n.substring(1))),vu=Ob("ascii","a",n=>{let t="a";for(let e=0;e<n.length;e++)t+=String.fromCharCode(n[e]);return t},n=>{n=n.substring(1);const t=cr(n.length);for(let e=0;e<n.length;e++)t[e]=n.charCodeAt(e);return t}),Fb={utf8:Gp,"utf-8":Gp,hex:Od.base16,latin1:vu,ascii:vu,binary:vu,...Od};function te(n,t="utf8"){const e=Fb[t];if(e==null)throw new Error(`Unsupported encoding "${t}"`);return e.decoder.decode(`${e.prefix}${n}`)}function fI(n){let r,s=8192;return function(o){if(o<1||o>4096)return cr(o);s+o>8192&&(r=cr(8192),s=0);const a=r.subarray(s,s+=o);return(s&7)!==0&&(s=(s|7)+1),a}}class Co{constructor(t,e,r){p(this,"fn");p(this,"len");p(this,"next");p(this,"val");this.fn=t,this.len=e,this.next=void 0,this.val=r}}function bu(){}class pI{constructor(t){p(this,"head");p(this,"tail");p(this,"len");p(this,"next");this.head=t.head,this.tail=t.tail,this.len=t.len,this.next=t.states}}const gI=fI();function mI(n){return globalThis.Buffer!=null?cr(n):gI(n)}class Fd{constructor(){p(this,"len");p(this,"head");p(this,"tail");p(this,"states");this.len=0,this.head=new Co(bu,0,0),this.tail=this.head,this.states=null}_push(t,e,r){return this.tail=this.tail.next=new Co(t,e,r),this.len+=e,this}uint32(t){return this.len+=(this.tail=this.tail.next=new vI((t=t>>>0)<128?1:t<16384?2:t<2097152?3:t<268435456?4:5,t)).len,this}int32(t){return t<0?this._push(Fa,10,Rt.fromNumber(t)):this.uint32(t)}sint32(t){return this.uint32((t<<1^t>>31)>>>0)}uint64(t){const e=Rt.fromBigInt(t);return this._push(Fa,e.length(),e)}uint64Number(t){return this._push(Mb,ln(t),t)}uint64String(t){return this.uint64(BigInt(t))}int64(t){return this.uint64(t)}int64Number(t){return this.uint64Number(t)}int64String(t){return this.uint64String(t)}sint64(t){const e=Rt.fromBigInt(t).zzEncode();return this._push(Fa,e.length(),e)}sint64Number(t){const e=Rt.fromNumber(t).zzEncode();return this._push(Fa,e.length(),e)}sint64String(t){return this.sint64(BigInt(t))}bool(t){return this._push(wu,1,t?1:0)}fixed32(t){return this._push(So,4,t>>>0)}sfixed32(t){return this.fixed32(t)}fixed64(t){const e=Rt.fromBigInt(t);return this._push(So,4,e.lo)._push(So,4,e.hi)}fixed64Number(t){const e=Rt.fromNumber(t);return this._push(So,4,e.lo)._push(So,4,e.hi)}fixed64String(t){return this.fixed64(BigInt(t))}sfixed64(t){return this.fixed64(t)}sfixed64Number(t){return this.fixed64Number(t)}sfixed64String(t){return this.fixed64String(t)}float(t){return this._push(B2,4,t)}double(t){return this._push(R2,8,t)}bytes(t){const e=t.length>>>0;return e===0?this._push(wu,1,0):this.uint32(e)._push(bI,e,t)}string(t){const e=U2(t);return e!==0?this.uint32(e)._push(Bb,e,t):this._push(wu,1,0)}fork(){return this.states=new pI(this),this.head=this.tail=new Co(bu,0,0),this.len=0,this}reset(){return this.states!=null?(this.head=this.states.head,this.tail=this.states.tail,this.len=this.states.len,this.states=this.states.next):(this.head=this.tail=new Co(bu,0,0),this.len=0),this}ldelim(){const t=this.head,e=this.tail,r=this.len;return this.reset().uint32(r),r!==0&&(this.tail.next=t.next,this.tail=e,this.len+=r),this}finish(){let t=this.head.next;const e=mI(this.len);let r=0;for(;t!=null;)t.fn(t.val,e,r),r+=t.len,t=t.next;return e}}function wu(n,t,e){t[e]=n&255}function yI(n,t,e){for(;n>127;)t[e++]=n&127|128,n>>>=7;t[e]=n}class vI extends Co{constructor(e,r){super(yI,e,r);p(this,"next");this.next=void 0}}function Fa(n,t,e){for(;n.hi!==0;)t[e++]=n.lo&127|128,n.lo=(n.lo>>>7|n.hi<<25)>>>0,n.hi>>>=7;for(;n.lo>127;)t[e++]=n.lo&127|128,n.lo=n.lo>>>7;t[e++]=n.lo}function So(n,t,e){t[e]=n&255,t[e+1]=n>>>8&255,t[e+2]=n>>>16&255,t[e+3]=n>>>24}function bI(n,t,e){t.set(n,e)}globalThis.Buffer!=null&&(Fd.prototype.bytes=function(n){const t=n.length>>>0;return this.uint32(t),t>0&&this._push(wI,t,n),this},Fd.prototype.string=function(n){const t=globalThis.Buffer.byteLength(n);return this.uint32(t),t>0&&this._push(_I,t,n),this});function wI(n,t,e){t.set(n,e)}function _I(n,t,e){n.length<40?Bb(n,t,e):t.utf8Write!=null?t.utf8Write(n,e):t.set(te(n),e)}function SI(){return new Fd}function Te(n,t){const e=SI();return t.encode(n,e,{lengthDelimited:!1}),e.finish()}var Mc;(function(n){n[n.VARINT=0]="VARINT",n[n.BIT64=1]="BIT64",n[n.LENGTH_DELIMITED=2]="LENGTH_DELIMITED",n[n.START_GROUP=3]="START_GROUP",n[n.END_GROUP=4]="END_GROUP",n[n.BIT32=5]="BIT32"})(Mc||(Mc={}));function $b(n,t,e,r){return{name:n,type:t,encode:e,decode:r}}function Ia(n){function t(s){if(n[s.toString()]==null)throw new Error("Invalid enum value");return n[s]}const e=function(i,o){const a=t(i);o.int32(a)},r=function(i){const o=i.int32();return t(o)};return $b("enum",Mc.VARINT,e,r)}function Ce(n,t){return $b("message",Mc.LENGTH_DELIMITED,n,t)}class gt extends Error{constructor(){super(...arguments);p(this,"code","ERR_MAX_LENGTH");p(this,"name","MaxLengthError")}}class Kp extends Error{constructor(){super(...arguments);p(this,"code","ERR_MAX_SIZE");p(this,"name","MaxSizeError")}}var at;(function(n){n.RSA="RSA",n.Ed25519="Ed25519",n.secp256k1="secp256k1"})(at||(at={}));var $d;(function(n){n[n.RSA=0]="RSA",n[n.Ed25519=1]="Ed25519",n[n.secp256k1=2]="secp256k1"})($d||($d={}));(function(n){n.codec=()=>Ia($d)})(at||(at={}));var us;(function(n){let t;n.codec=()=>(t==null&&(t=Ce((e,r,s={})=>{s.lengthDelimited!==!1&&r.fork(),e.Type!=null&&(r.uint32(8),at.codec().encode(e.Type,r)),e.Data!=null&&(r.uint32(18),r.bytes(e.Data)),s.lengthDelimited!==!1&&r.ldelim()},(e,r,s={})=>{const i={},o=r==null?e.len:e.pos+r;for(;e.pos<o;){const a=e.uint32();switch(a>>>3){case 1:{i.Type=at.codec().decode(e);break}case 2:{i.Data=e.bytes();break}default:{e.skipType(a&7);break}}}return i})),t),n.encode=e=>Te(e,n.codec()),n.decode=(e,r)=>ke(e,n.codec(),r)})(us||(us={}));var Lc;(function(n){let t;n.codec=()=>(t==null&&(t=Ce((e,r,s={})=>{s.lengthDelimited!==!1&&r.fork(),e.Type!=null&&(r.uint32(8),at.codec().encode(e.Type,r)),e.Data!=null&&(r.uint32(18),r.bytes(e.Data)),s.lengthDelimited!==!1&&r.ldelim()},(e,r,s={})=>{const i={},o=r==null?e.len:e.pos+r;for(;e.pos<o;){const a=e.uint32();switch(a>>>3){case 1:{i.Type=at.codec().decode(e);break}case 2:{i.Data=e.bytes();break}default:{e.skipType(a&7);break}}}return i})),t),n.encode=e=>Te(e,n.codec()),n.decode=(e,r)=>ke(e,n.codec(),r)})(Lc||(Lc={}));const EI=new Uint32Array([1116352408,1899447441,3049323471,3921009573,961987163,1508970993,2453635748,2870763221,3624381080,310598401,607225278,1426881987,1925078388,2162078206,2614888103,3248222580,3835390401,4022224774,264347078,604807628,770255983,1249150122,1555081692,1996064986,2554220882,2821834349,2952996808,3210313671,3336571891,3584528711,113926993,338241895,666307205,773529912,1294757372,1396182291,1695183700,1986661051,2177026350,2456956037,2730485921,2820302411,3259730800,3345764771,3516065817,3600352804,4094571909,275423344,430227734,506948616,659060556,883997877,958139571,1322822218,1537002063,1747873779,1955562222,2024104815,2227730452,2361852424,2428436474,2756734187,3204031479,3329325298]),Wr=new Uint32Array([1779033703,3144134277,1013904242,2773480762,1359893119,2600822924,528734635,1541459225]),Gr=new Uint32Array(64);class AI extends df{constructor(){super(64,32,8,!1),this.A=Wr[0]|0,this.B=Wr[1]|0,this.C=Wr[2]|0,this.D=Wr[3]|0,this.E=Wr[4]|0,this.F=Wr[5]|0,this.G=Wr[6]|0,this.H=Wr[7]|0}get(){const{A:t,B:e,C:r,D:s,E:i,F:o,G:a,H:l}=this;return[t,e,r,s,i,o,a,l]}set(t,e,r,s,i,o,a,l){this.A=t|0,this.B=e|0,this.C=r|0,this.D=s|0,this.E=i|0,this.F=o|0,this.G=a|0,this.H=l|0}process(t,e){for(let c=0;c<16;c++,e+=4)Gr[c]=t.getUint32(e,!1);for(let c=16;c<64;c++){const d=Gr[c-15],f=Gr[c-2],g=Kn(d,7)^Kn(d,18)^d>>>3,y=Kn(f,17)^Kn(f,19)^f>>>10;Gr[c]=y+Gr[c-7]+g+Gr[c-16]|0}let{A:r,B:s,C:i,D:o,E:a,F:l,G:u,H:h}=this;for(let c=0;c<64;c++){const d=Kn(a,6)^Kn(a,11)^Kn(a,25),f=h+d+vb(a,l,u)+EI[c]+Gr[c]|0,y=(Kn(r,2)^Kn(r,13)^Kn(r,22))+bb(r,s,i)|0;h=u,u=l,l=a,a=o+f|0,o=i,i=s,s=r,r=f+y|0}r=r+this.A|0,s=s+this.B|0,i=i+this.C|0,o=o+this.D|0,a=a+this.E|0,l=l+this.F|0,u=u+this.G|0,h=h+this.H|0,this.set(r,s,i,o,a,l,u,h)}roundClean(){Gr.fill(0)}destroy(){this.set(0,0,0,0,0,0,0,0),this.buffer.fill(0)}}const ka=lf(()=>new AI);function he(n,t="utf8"){const e=Fb[t];if(e==null)throw new Error(`Unsupported encoding "${t}"`);return e.encoder.encode(n).substring(1)}function bn(n,t){t==null&&(t=n.reduce((s,i)=>s+i.length,0));const e=cr(t);let r=0;for(const s of n)e.set(s,r),r+=s.length;return e}const Ub=Symbol.for("@achingbrain/uint8arraylist");function Yp(n,t){if(t==null||t<0)throw new RangeError("index is out of bounds");let e=0;for(const r of n){const s=e+r.byteLength;if(t<s)return{buf:r,index:t-e};e=s}throw new RangeError("index is out of bounds")}function $a(n){return!!n?.[Ub]}var Zm;class Ge{constructor(...t){p(this,"bufs");p(this,"length");p(this,Zm,!0);this.bufs=[],this.length=0,t.length>0&&this.appendAll(t)}*[(Zm=Ub,Symbol.iterator)](){yield*this.bufs}get byteLength(){return this.length}append(...t){this.appendAll(t)}appendAll(t){let e=0;for(const r of t)if(r instanceof Uint8Array)e+=r.byteLength,this.bufs.push(r);else if($a(r))e+=r.byteLength,this.bufs.push(...r.bufs);else throw new Error("Could not append value, must be an Uint8Array or a Uint8ArrayList");this.length+=e}prepend(...t){this.prependAll(t)}prependAll(t){let e=0;for(const r of t.reverse())if(r instanceof Uint8Array)e+=r.byteLength,this.bufs.unshift(r);else if($a(r))e+=r.byteLength,this.bufs.unshift(...r.bufs);else throw new Error("Could not prepend value, must be an Uint8Array or a Uint8ArrayList");this.length+=e}get(t){const e=Yp(this.bufs,t);return e.buf[e.index]}set(t,e){const r=Yp(this.bufs,t);r.buf[r.index]=e}write(t,e=0){if(t instanceof Uint8Array)for(let r=0;r<t.length;r++)this.set(e+r,t[r]);else if($a(t))for(let r=0;r<t.length;r++)this.set(e+r,t.get(r));else throw new Error("Could not write value, must be an Uint8Array or a Uint8ArrayList")}consume(t){if(t=Math.trunc(t),!(Number.isNaN(t)||t<=0)){if(t===this.byteLength){this.bufs=[],this.length=0;return}for(;this.bufs.length>0;)if(t>=this.bufs[0].byteLength)t-=this.bufs[0].byteLength,this.length-=this.bufs[0].byteLength,this.bufs.shift();else{this.bufs[0]=this.bufs[0].subarray(t),this.length-=t;break}}}slice(t,e){const{bufs:r,length:s}=this._subList(t,e);return bn(r,s)}subarray(t,e){const{bufs:r,length:s}=this._subList(t,e);return r.length===1?r[0]:bn(r,s)}sublist(t,e){const{bufs:r,length:s}=this._subList(t,e),i=new Ge;return i.length=s,i.bufs=[...r],i}_subList(t,e){if(t=t??0,e=e??this.length,t<0&&(t=this.length+t),e<0&&(e=this.length+e),t<0||e>this.length)throw new RangeError("index is out of bounds");if(t===e)return{bufs:[],length:0};if(t===0&&e===this.length)return{bufs:this.bufs,length:this.length};const r=[];let s=0;for(let i=0;i<this.bufs.length;i++){const o=this.bufs[i],a=s,l=a+o.byteLength;if(s=l,t>=l)continue;const u=t>=a&&t<l,h=e>a&&e<=l;if(u&&h){if(t===a&&e===l){r.push(o);break}const c=t-a;r.push(o.subarray(c,c+(e-t)));break}if(u){if(t===0){r.push(o);continue}r.push(o.subarray(t-a));continue}if(h){if(e===l){r.push(o);break}r.push(o.subarray(0,e-a));break}r.push(o)}return{bufs:r,length:e-t}}indexOf(t,e=0){if(!$a(t)&&!(t instanceof Uint8Array))throw new TypeError('The "value" argument must be a Uint8ArrayList or Uint8Array');const r=t instanceof Uint8Array?t:t.subarray();if(e=Number(e??0),isNaN(e)&&(e=0),e<0&&(e=this.length+e),e<0&&(e=0),t.length===0)return e>this.length?this.length:e;const s=r.byteLength;if(s===0)throw new TypeError("search must be at least 1 byte long");const i=256,o=new Int32Array(i);for(let c=0;c<i;c++)o[c]=-1;for(let c=0;c<s;c++)o[r[c]]=c;const a=o,l=this.byteLength-r.byteLength,u=r.byteLength-1;let h;for(let c=e;c<=l;c+=h){h=0;for(let d=u;d>=0;d--){const f=this.get(c+d);if(r[d]!==f){h=Math.max(1,d-a[f]);break}}if(h===0)return c}return-1}getInt8(t){const e=this.subarray(t,t+1);return new DataView(e.buffer,e.byteOffset,e.byteLength).getInt8(0)}setInt8(t,e){const r=cr(1);new DataView(r.buffer,r.byteOffset,r.byteLength).setInt8(0,e),this.write(r,t)}getInt16(t,e){const r=this.subarray(t,t+2);return new DataView(r.buffer,r.byteOffset,r.byteLength).getInt16(0,e)}setInt16(t,e,r){const s=Ke(2);new DataView(s.buffer,s.byteOffset,s.byteLength).setInt16(0,e,r),this.write(s,t)}getInt32(t,e){const r=this.subarray(t,t+4);return new DataView(r.buffer,r.byteOffset,r.byteLength).getInt32(0,e)}setInt32(t,e,r){const s=Ke(4);new DataView(s.buffer,s.byteOffset,s.byteLength).setInt32(0,e,r),this.write(s,t)}getBigInt64(t,e){const r=this.subarray(t,t+8);return new DataView(r.buffer,r.byteOffset,r.byteLength).getBigInt64(0,e)}setBigInt64(t,e,r){const s=Ke(8);new DataView(s.buffer,s.byteOffset,s.byteLength).setBigInt64(0,e,r),this.write(s,t)}getUint8(t){const e=this.subarray(t,t+1);return new DataView(e.buffer,e.byteOffset,e.byteLength).getUint8(0)}setUint8(t,e){const r=cr(1);new DataView(r.buffer,r.byteOffset,r.byteLength).setUint8(0,e),this.write(r,t)}getUint16(t,e){const r=this.subarray(t,t+2);return new DataView(r.buffer,r.byteOffset,r.byteLength).getUint16(0,e)}setUint16(t,e,r){const s=Ke(2);new DataView(s.buffer,s.byteOffset,s.byteLength).setUint16(0,e,r),this.write(s,t)}getUint32(t,e){const r=this.subarray(t,t+4);return new DataView(r.buffer,r.byteOffset,r.byteLength).getUint32(0,e)}setUint32(t,e,r){const s=Ke(4);new DataView(s.buffer,s.byteOffset,s.byteLength).setUint32(0,e,r),this.write(s,t)}getBigUint64(t,e){const r=this.subarray(t,t+8);return new DataView(r.buffer,r.byteOffset,r.byteLength).getBigUint64(0,e)}setBigUint64(t,e,r){const s=Ke(8);new DataView(s.buffer,s.byteOffset,s.byteLength).setBigUint64(0,e,r),this.write(s,t)}getFloat32(t,e){const r=this.subarray(t,t+4);return new DataView(r.buffer,r.byteOffset,r.byteLength).getFloat32(0,e)}setFloat32(t,e,r){const s=Ke(4);new DataView(s.buffer,s.byteOffset,s.byteLength).setFloat32(0,e,r),this.write(s,t)}getFloat64(t,e){const r=this.subarray(t,t+8);return new DataView(r.buffer,r.byteOffset,r.byteLength).getFloat64(0,e)}setFloat64(t,e,r){const s=Ke(8);new DataView(s.buffer,s.byteOffset,s.byteLength).setFloat64(0,e,r),this.write(s,t)}equals(t){if(t==null||!(t instanceof Ge)||t.bufs.length!==this.bufs.length)return!1;for(let e=0;e<this.bufs.length;e++)if(!It(this.bufs[e],t.bufs[e]))return!1;return!0}static fromUint8Arrays(t,e){const r=new Ge;return r.bufs=t,e==null&&(e=t.reduce((s,i)=>s+i.byteLength,0)),r.length=e,r}}const xI=parseInt("11111",2),Ud=parseInt("10000000",2),II=parseInt("01111111",2),Qp={2:kI,3:PI,5:CI,6:TI,16:_u,22:_u,48:_u};function Ol(n,t={offset:0}){const e=n[t.offset]&xI;if(t.offset++,Qp[e]!=null)return Qp[e](n,t);throw new Error("No decoder for tag "+e)}function Fl(n,t){let e=0;if((n[t.offset]&Ud)===Ud){const r=n[t.offset]&II;let s="0x";t.offset++;for(let i=0;i<r;i++,t.offset++)s+=n[t.offset].toString(16).padStart(2,"0");e=parseInt(s,16)}else e=n[t.offset],t.offset++;return e}function _u(n,t){Fl(n,t);const e=[];for(;!(t.offset>=n.byteLength);){const r=Ol(n,t);if(r===null)break;e.push(r)}return e}function kI(n,t){const e=Fl(n,t),r=t.offset,s=t.offset+e,i=[];for(let o=r;o<s;o++)o===r&&n[o]===0||i.push(n[o]);return t.offset+=e,Uint8Array.from(i)}function TI(n,t){const e=Fl(n,t);return t.offset+=e,["oid-unimplemented"]}function CI(n,t){return t.offset++,null}function PI(n,t){const e=Fl(n,t),r=n[t.offset];t.offset++;const s=n.subarray(t.offset,t.offset+e);if(t.offset+=e,r!==0)throw new Error("Unused bits in bit string is unimplemented");return Ol(s,{offset:0})}function DI(n){let t=n.toString(16);t.length%2===1&&(t="0"+t);const e=new Ge;for(let r=0;r<t.length;r+=2)e.append(Uint8Array.from([parseInt(`${t[r]}${t[r+1]}`,16)]));return e}function Ef(n){if(n.byteLength<128)return Uint8Array.from([n.byteLength]);const t=DI(n.byteLength);return new Ge(Uint8Array.from([t.byteLength|Ud]),t)}function Rn(n){const t=new Ge,e=parseInt("10000000",2);return(n.subarray()[0]&e)===e&&t.append(Uint8Array.from([0])),t.append(n),new Ge(Uint8Array.from([2]),Ef(t),t)}function MI(n){const t=Uint8Array.from([0]),e=new Ge(t,n);return new Ge(Uint8Array.from([3]),Ef(e),e)}function Vd(n){const t=new Ge;for(const e of n)t.append(e);return new Ge(Uint8Array.from([48]),Ef(t),t)}function Ui(n){if(isNaN(n)||n<=0)throw new Z("random bytes length must be a Number bigger than 0");return uf(n)}class jp extends Error{constructor(t="An error occurred while signing a message"){super(t),this.name="SigningError"}}class Zp extends Error{constructor(t="An error occurred while verifying a message"){super(t),this.name="VerificationError"}}class LI extends Error{constructor(t="Missing Web Crypto API"){super(t),this.name="WebCryptoMissingError"}}const lr={get(n=globalThis){const t=n.crypto;if(t?.subtle==null)throw new LI("Missing Web Crypto API. The most likely cause of this error is that this page is being accessed from an insecure context (i.e. not HTTPS). For more information and possible resolutions see https://github.com/libp2p/js-libp2p/blob/main/packages/crypto/README.md#web-crypto-api");return t}};async function BI(n){const t=await lr.get().subtle.generateKey({name:"RSASSA-PKCS1-v1_5",modulusLength:n,publicExponent:new Uint8Array([1,0,1]),hash:{name:"SHA-256"}},!0,["sign","verify"]),e=await OI(t);return{privateKey:e[0],publicKey:e[1]}}async function NI(n,t){const e=await lr.get().subtle.importKey("jwk",n,{name:"RSASSA-PKCS1-v1_5",hash:{name:"SHA-256"}},!1,["sign"]),r=await lr.get().subtle.sign({name:"RSASSA-PKCS1-v1_5"},e,t instanceof Uint8Array?t:t.subarray());return new Uint8Array(r,0,r.byteLength)}async function RI(n,t,e){const r=await lr.get().subtle.importKey("jwk",n,{name:"RSASSA-PKCS1-v1_5",hash:{name:"SHA-256"}},!1,["verify"]);return lr.get().subtle.verify({name:"RSASSA-PKCS1-v1_5"},r,t,e instanceof Uint8Array?e:e.subarray())}async function OI(n){if(n.privateKey==null||n.publicKey==null)throw new Z("Private and public key are required");return Promise.all([lr.get().subtle.exportKey("jwk",n.privateKey),lr.get().subtle.exportKey("jwk",n.publicKey)])}function FI(n){if(n.kty!=="RSA")throw new Z("invalid key type");if(n.n==null)throw new Z("invalid key modulus");return te(n.n,"base64url").length*8}class Af{constructor(t,e){p(this,"type","RSA");p(this,"_key");p(this,"_raw");p(this,"_multihash");this._key=t,this._multihash=e}get raw(){return this._raw==null&&(this._raw=If(this._key)),this._raw}toMultihash(){return this._multihash}toCID(){return Qe.createV1(114,this._multihash)}toString(){return ot.encode(this.toMultihash().bytes).substring(1)}equals(t){return t==null||!(t.raw instanceof Uint8Array)?!1:It(this.raw,t.raw)}verify(t,e){return RI(this._key,e,t)}}class Vb{constructor(t,e){p(this,"type","RSA");p(this,"_key");p(this,"_raw");p(this,"publicKey");this._key=t,this.publicKey=e}get raw(){return this._raw==null&&(this._raw=zI(this._key)),this._raw}equals(t){return t==null||!(t.raw instanceof Uint8Array)?!1:It(this.raw,t.raw)}sign(t){return NI(this._key,t)}}const $I=8192,xf=18,UI=1062,VI=Uint8Array.from([48,13,6,9,42,134,72,134,247,13,1,1,1,5,0]);function HI(n){const t=Ol(n);return{n:he(t[1],"base64url"),e:he(t[2],"base64url"),d:he(t[3],"base64url"),p:he(t[4],"base64url"),q:he(t[5],"base64url"),dp:he(t[6],"base64url"),dq:he(t[7],"base64url"),qi:he(t[8],"base64url"),kty:"RSA"}}function zI(n){if(n.n==null||n.e==null||n.d==null||n.p==null||n.q==null||n.dp==null||n.dq==null||n.qi==null)throw new Z("JWK was missing components");return Vd([Rn(Uint8Array.from([0])),Rn(te(n.n,"base64url")),Rn(te(n.e,"base64url")),Rn(te(n.d,"base64url")),Rn(te(n.p,"base64url")),Rn(te(n.q,"base64url")),Rn(te(n.dp,"base64url")),Rn(te(n.dq,"base64url")),Rn(te(n.qi,"base64url"))]).subarray()}function qI(n){const t=Ol(n,{offset:0});return{kty:"RSA",n:he(t[1][0],"base64url"),e:he(t[1][1],"base64url")}}function If(n){if(n.n==null||n.e==null)throw new Z("JWK was missing components");return Vd([VI,MI(Vd([Rn(te(n.n,"base64url")),Rn(te(n.e,"base64url"))]))]).subarray()}function Hb(n){const t=HI(n);return WI(t)}function zb(n,t){if(n.byteLength>=UI)throw new ef("Key size is too large");const e=qI(n);if(t==null){const r=ka(us.encode({Type:at.RSA,Data:n}));t=Rs(xf,r)}return new Af(e,t)}function WI(n){if(FI(n)>$I)throw new Z("Key size is too large");const t=KI(n),e=ka(us.encode({Type:at.RSA,Data:If(t.publicKey)})),r=Rs(xf,e);return new Vb(t.privateKey,new Af(t.publicKey,r))}async function GI(n){const t=await BI(n),e=ka(us.encode({Type:at.RSA,Data:If(t.publicKey)})),r=Rs(xf,e);return new Vb(t.privateKey,new Af(t.publicKey,r))}function KI(n){if(n==null)throw new Z("Missing key parameter");return{privateKey:n,publicKey:{kty:n.kty,n:n.n,e:n.e}}}class qb extends yb{constructor(t,e){super(),this.finished=!1,this.destroyed=!1,mb(t);const r=jo(e);if(this.iHash=t.create(),typeof this.iHash.update!="function")throw new Error("Expected instance of class which extends utils.Hash");this.blockLen=this.iHash.blockLen,this.outputLen=this.iHash.outputLen;const s=this.blockLen,i=new Uint8Array(s);i.set(r.length>s?t.create().update(r).digest():r);for(let o=0;o<i.length;o++)i[o]^=54;this.iHash.update(i),this.oHash=t.create();for(let o=0;o<i.length;o++)i[o]^=106;this.oHash.update(i),i.fill(0)}update(t){return Cc(this),this.iHash.update(t),this}digestInto(t){Cc(this),Dl(t,this.outputLen),this.finished=!0,this.iHash.digestInto(t),this.oHash.update(t),this.oHash.digestInto(t),this.destroy()}digest(){const t=new Uint8Array(this.oHash.outputLen);return this.digestInto(t),t}_cloneInto(t){t||(t=Object.create(Object.getPrototypeOf(this),{}));const{oHash:e,iHash:r,finished:s,destroyed:i,blockLen:o,outputLen:a}=this;return t=t,t.finished=s,t.destroyed=i,t.blockLen=o,t.outputLen=a,t.oHash=e._cloneInto(t.oHash),t.iHash=r._cloneInto(t.iHash),t}destroy(){this.destroyed=!0,this.oHash.destroy(),this.iHash.destroy()}}const kf=(n,t,e)=>new qb(n,t).update(e).digest();kf.create=(n,t)=>new qb(n,t);/*! noble-curves - MIT License (c) 2022 Paul Miller (paulmillr.com) */function Xp(n){n.lowS!==void 0&&Pr("lowS",n.lowS),n.prehash!==void 0&&Pr("prehash",n.prehash)}function YI(n){const t=pf(n);co(t,{a:"field",b:"field"},{allowedPrivateKeyLengths:"array",wrapPrivateKey:"boolean",isTorsionFree:"function",clearCofactor:"function",allowInfinityPoint:"boolean",fromBytes:"function",toBytes:"function"});const{endo:e,Fp:r,a:s}=t;if(e){if(!r.eql(s,r.ZERO))throw new Error("invalid endomorphism, can only be defined for Koblitz curves that have a=0");if(typeof e!="object"||typeof e.beta!="bigint"||typeof e.splitScalar!="function")throw new Error("invalid endomorphism, expected beta: bigint and splitScalar: function")}return Object.freeze({...t})}const{bytesToNumberBE:QI,hexToBytes:jI}=Jx;class ZI extends Error{constructor(t=""){super(t)}}const wr={Err:ZI,_tlv:{encode:(n,t)=>{const{Err:e}=wr;if(n<0||n>256)throw new e("tlv.encode: wrong tag");if(t.length&1)throw new e("tlv.encode: unpadded data");const r=t.length/2,s=pi(r);if(s.length/2&128)throw new e("tlv.encode: long form length too big");const i=r>127?pi(s.length/2|128):"";return pi(n)+i+s+t},decode(n,t){const{Err:e}=wr;let r=0;if(n<0||n>256)throw new e("tlv.encode: wrong tag");if(t.length<2||t[r++]!==n)throw new e("tlv.decode: wrong tlv");const s=t[r++],i=!!(s&128);let o=0;if(!i)o=s;else{const l=s&127;if(!l)throw new e("tlv.decode(long): indefinite length not supported");if(l>4)throw new e("tlv.decode(long): byte length is too big");const u=t.subarray(r,r+l);if(u.length!==l)throw new e("tlv.decode: length bytes not complete");if(u[0]===0)throw new e("tlv.decode(long): zero leftmost byte");for(const h of u)o=o<<8|h;if(r+=l,o<128)throw new e("tlv.decode(long): not minimal encoding")}const a=t.subarray(r,r+o);if(a.length!==o)throw new e("tlv.decode: wrong value length");return{v:a,l:t.subarray(r+o)}}},_int:{encode(n){const{Err:t}=wr;if(n<Ar)throw new t("integer: negative integers are not allowed");let e=pi(n);if(Number.parseInt(e[0],16)&8&&(e="00"+e),e.length&1)throw new t("unexpected DER parsing assertion: unpadded hex");return e},decode(n){const{Err:t}=wr;if(n[0]&128)throw new t("invalid signature integer: negative");if(n[0]===0&&!(n[1]&128))throw new t("invalid signature integer: unnecessary leading zero");return QI(n)}},toSig(n){const{Err:t,_int:e,_tlv:r}=wr,s=typeof n=="string"?jI(n):n;Ea(s);const{v:i,l:o}=r.decode(48,s);if(o.length)throw new t("invalid signature: left bytes after parsing");const{v:a,l}=r.decode(2,i),{v:u,l:h}=r.decode(2,l);if(h.length)throw new t("invalid signature: left bytes after parsing");return{r:e.decode(a),s:e.decode(u)}},hexFromSig(n){const{_tlv:t,_int:e}=wr,r=t.encode(2,e.encode(n.r)),s=t.encode(2,e.encode(n.s)),i=r+s;return t.encode(48,i)}},Ar=BigInt(0),wt=BigInt(1);BigInt(2);const Jp=BigInt(3);BigInt(4);function XI(n){const t=YI(n),{Fp:e}=t,r=Rl(t.n,t.nBitLength),s=t.toBytes||((y,m,v)=>{const _=m.toAffine();return $s(Uint8Array.from([4]),e.toBytes(_.x),e.toBytes(_.y))}),i=t.fromBytes||(y=>{const m=y.subarray(1),v=e.fromBytes(m.subarray(0,e.BYTES)),_=e.fromBytes(m.subarray(e.BYTES,2*e.BYTES));return{x:v,y:_}});function o(y){const{a:m,b:v}=t,_=e.sqr(y),w=e.mul(_,y);return e.add(e.add(w,e.mul(y,m)),v)}if(!e.eql(e.sqr(t.Gy),o(t.Gx)))throw new Error("bad generator point: equation left != right");function a(y){return Nl(y,wt,t.n)}function l(y){const{allowedPrivateKeyLengths:m,nByteLength:v,wrapPrivateKey:_,n:w}=t;if(m&&typeof y!="bigint"){if(Os(y)&&(y=Fs(y)),typeof y!="string"||!m.includes(y.length))throw new Error("invalid private key");y=y.padStart(v*2,"0")}let S;try{S=typeof y=="bigint"?y:Cs(dt("private key",y,v))}catch{throw new Error("invalid private key, expected hex or "+v+" bytes, got "+typeof y)}return _&&(S=je(S,w)),Pn("private key",S,wt,w),S}function u(y){if(!(y instanceof d))throw new Error("ProjectivePoint expected")}const h=Xo((y,m)=>{const{px:v,py:_,pz:w}=y;if(e.eql(w,e.ONE))return{x:v,y:_};const S=y.is0();m==null&&(m=S?e.ONE:e.inv(w));const A=e.mul(v,m),E=e.mul(_,m),I=e.mul(w,m);if(S)return{x:e.ZERO,y:e.ZERO};if(!e.eql(I,e.ONE))throw new Error("invZ was invalid");return{x:A,y:E}}),c=Xo(y=>{if(y.is0()){if(t.allowInfinityPoint&&!e.is0(y.py))return;throw new Error("bad point: ZERO")}const{x:m,y:v}=y.toAffine();if(!e.isValid(m)||!e.isValid(v))throw new Error("bad point: x or y not FE");const _=e.sqr(v),w=o(m);if(!e.eql(_,w))throw new Error("bad point: equation left != right");if(!y.isTorsionFree())throw new Error("bad point: not in prime-order subgroup");return!0});class d{constructor(m,v,_){if(this.px=m,this.py=v,this.pz=_,m==null||!e.isValid(m))throw new Error("x required");if(v==null||!e.isValid(v))throw new Error("y required");if(_==null||!e.isValid(_))throw new Error("z required");Object.freeze(this)}static fromAffine(m){const{x:v,y:_}=m||{};if(!m||!e.isValid(v)||!e.isValid(_))throw new Error("invalid affine point");if(m instanceof d)throw new Error("projective point not allowed");const w=S=>e.eql(S,e.ZERO);return w(v)&&w(_)?d.ZERO:new d(v,_,e.ONE)}get x(){return this.toAffine().x}get y(){return this.toAffine().y}static normalizeZ(m){const v=e.invertBatch(m.map(_=>_.pz));return m.map((_,w)=>_.toAffine(v[w])).map(d.fromAffine)}static fromHex(m){const v=d.fromAffine(i(dt("pointHex",m)));return v.assertValidity(),v}static fromPrivateKey(m){return d.BASE.multiply(l(m))}static msm(m,v){return Cb(d,r,m,v)}_setWindowSize(m){g.setWindowSize(this,m)}assertValidity(){c(this)}hasEvenY(){const{y:m}=this.toAffine();if(e.isOdd)return!e.isOdd(m);throw new Error("Field doesn't support isOdd")}equals(m){u(m);const{px:v,py:_,pz:w}=this,{px:S,py:A,pz:E}=m,I=e.eql(e.mul(v,E),e.mul(S,w)),k=e.eql(e.mul(_,E),e.mul(A,w));return I&&k}negate(){return new d(this.px,e.neg(this.py),this.pz)}double(){const{a:m,b:v}=t,_=e.mul(v,Jp),{px:w,py:S,pz:A}=this;let E=e.ZERO,I=e.ZERO,k=e.ZERO,x=e.mul(w,w),U=e.mul(S,S),B=e.mul(A,A),N=e.mul(w,S);return N=e.add(N,N),k=e.mul(w,A),k=e.add(k,k),E=e.mul(m,k),I=e.mul(_,B),I=e.add(E,I),E=e.sub(U,I),I=e.add(U,I),I=e.mul(E,I),E=e.mul(N,E),k=e.mul(_,k),B=e.mul(m,B),N=e.sub(x,B),N=e.mul(m,N),N=e.add(N,k),k=e.add(x,x),x=e.add(k,x),x=e.add(x,B),x=e.mul(x,N),I=e.add(I,x),B=e.mul(S,A),B=e.add(B,B),x=e.mul(B,N),E=e.sub(E,x),k=e.mul(B,U),k=e.add(k,k),k=e.add(k,k),new d(E,I,k)}add(m){u(m);const{px:v,py:_,pz:w}=this,{px:S,py:A,pz:E}=m;let I=e.ZERO,k=e.ZERO,x=e.ZERO;const U=t.a,B=e.mul(t.b,Jp);let N=e.mul(v,S),z=e.mul(_,A),D=e.mul(w,E),L=e.add(v,_),P=e.add(S,A);L=e.mul(L,P),P=e.add(N,z),L=e.sub(L,P),P=e.add(v,w);let T=e.add(S,E);return P=e.mul(P,T),T=e.add(N,D),P=e.sub(P,T),T=e.add(_,w),I=e.add(A,E),T=e.mul(T,I),I=e.add(z,D),T=e.sub(T,I),x=e.mul(U,P),I=e.mul(B,D),x=e.add(I,x),I=e.sub(z,x),x=e.add(z,x),k=e.mul(I,x),z=e.add(N,N),z=e.add(z,N),D=e.mul(U,D),P=e.mul(B,P),z=e.add(z,D),D=e.sub(N,D),D=e.mul(U,D),P=e.add(P,D),N=e.mul(z,P),k=e.add(k,N),N=e.mul(T,P),I=e.mul(L,I),I=e.sub(I,N),N=e.mul(L,z),x=e.mul(T,x),x=e.add(x,N),new d(I,k,x)}subtract(m){return this.add(m.negate())}is0(){return this.equals(d.ZERO)}wNAF(m){return g.wNAFCached(this,m,d.normalizeZ)}multiplyUnsafe(m){const{endo:v,n:_}=t;Pn("scalar",m,Ar,_);const w=d.ZERO;if(m===Ar)return w;if(this.is0()||m===wt)return this;if(!v||g.hasPrecomputes(this))return g.wNAFCachedUnsafe(this,m,d.normalizeZ);let{k1neg:S,k1:A,k2neg:E,k2:I}=v.splitScalar(m),k=w,x=w,U=this;for(;A>Ar||I>Ar;)A&wt&&(k=k.add(U)),I&wt&&(x=x.add(U)),U=U.double(),A>>=wt,I>>=wt;return S&&(k=k.negate()),E&&(x=x.negate()),x=new d(e.mul(x.px,v.beta),x.py,x.pz),k.add(x)}multiply(m){const{endo:v,n:_}=t;Pn("scalar",m,wt,_);let w,S;if(v){const{k1neg:A,k1:E,k2neg:I,k2:k}=v.splitScalar(m);let{p:x,f:U}=this.wNAF(E),{p:B,f:N}=this.wNAF(k);x=g.constTimeNegate(A,x),B=g.constTimeNegate(I,B),B=new d(e.mul(B.px,v.beta),B.py,B.pz),w=x.add(B),S=U.add(N)}else{const{p:A,f:E}=this.wNAF(m);w=A,S=E}return d.normalizeZ([w,S])[0]}multiplyAndAddUnsafe(m,v,_){const w=d.BASE,S=(E,I)=>I===Ar||I===wt||!E.equals(w)?E.multiplyUnsafe(I):E.multiply(I),A=S(this,v).add(S(m,_));return A.is0()?void 0:A}toAffine(m){return h(this,m)}isTorsionFree(){const{h:m,isTorsionFree:v}=t;if(m===wt)return!0;if(v)return v(d,this);throw new Error("isTorsionFree() has not been declared for the elliptic curve")}clearCofactor(){const{h:m,clearCofactor:v}=t;return m===wt?this:v?v(d,this):this.multiplyUnsafe(t.h)}toRawBytes(m=!0){return Pr("isCompressed",m),this.assertValidity(),s(d,this,m)}toHex(m=!0){return Pr("isCompressed",m),Fs(this.toRawBytes(m))}}d.BASE=new d(t.Gx,t.Gy,e.ONE),d.ZERO=new d(e.ZERO,e.ONE,e.ZERO);const f=t.nBitLength,g=Tb(d,t.endo?Math.ceil(f/2):f);return{CURVE:t,ProjectivePoint:d,normPrivateKeyToScalar:l,weierstrassEquation:o,isWithinCurveOrder:a}}function JI(n){const t=pf(n);return co(t,{hash:"hash",hmac:"function",randomBytes:"function"},{bits2int:"function",bits2int_modN:"function",lowS:"boolean"}),Object.freeze({lowS:!0,...t})}function ek(n){const t=JI(n),{Fp:e,n:r}=t,s=e.BYTES+1,i=2*e.BYTES+1;function o(D){return je(D,r)}function a(D){return Bd(D,r)}const{ProjectivePoint:l,normPrivateKeyToScalar:u,weierstrassEquation:h,isWithinCurveOrder:c}=XI({...t,toBytes(D,L,P){const T=L.toAffine(),C=e.toBytes(T.x),R=$s;return Pr("isCompressed",P),P?R(Uint8Array.from([L.hasEvenY()?2:3]),C):R(Uint8Array.from([4]),C,e.toBytes(T.y))},fromBytes(D){const L=D.length,P=D[0],T=D.subarray(1);if(L===s&&(P===2||P===3)){const C=Cs(T);if(!Nl(C,wt,e.ORDER))throw new Error("Point is not on curve");const R=h(C);let O;try{O=e.sqrt(R)}catch(ee){const Y=ee instanceof Error?": "+ee.message:"";throw new Error("Point is not on curve"+Y)}const V=(O&wt)===wt;return(P&1)===1!==V&&(O=e.neg(O)),{x:C,y:O}}else if(L===i&&P===4){const C=e.fromBytes(T.subarray(0,e.BYTES)),R=e.fromBytes(T.subarray(e.BYTES,2*e.BYTES));return{x:C,y:R}}else{const C=s,R=i;throw new Error("invalid Point, expected length of "+C+", or uncompressed "+R+", got "+L)}}}),d=D=>Fs($i(D,t.nByteLength));function f(D){const L=r>>wt;return D>L}function g(D){return f(D)?o(-D):D}const y=(D,L,P)=>Cs(D.slice(L,P));class m{constructor(L,P,T){this.r=L,this.s=P,this.recovery=T,this.assertValidity()}static fromCompact(L){const P=t.nByteLength;return L=dt("compactSignature",L,P*2),new m(y(L,0,P),y(L,P,2*P))}static fromDER(L){const{r:P,s:T}=wr.toSig(dt("DER",L));return new m(P,T)}assertValidity(){Pn("r",this.r,wt,r),Pn("s",this.s,wt,r)}addRecoveryBit(L){return new m(this.r,this.s,L)}recoverPublicKey(L){const{r:P,s:T,recovery:C}=this,R=E(dt("msgHash",L));if(C==null||![0,1,2,3].includes(C))throw new Error("recovery id invalid");const O=C===2||C===3?P+t.n:P;if(O>=e.ORDER)throw new Error("recovery id 2 or 3 invalid");const V=(C&1)===0?"02":"03",K=l.fromHex(V+d(O)),ee=a(O),Y=o(-R*ee),le=o(T*ee),re=l.BASE.multiplyAndAddUnsafe(K,Y,le);if(!re)throw new Error("point at infinify");return re.assertValidity(),re}hasHighS(){return f(this.s)}normalizeS(){return this.hasHighS()?new m(this.r,o(-this.s),this.recovery):this}toDERRawBytes(){return Fi(this.toDERHex())}toDERHex(){return wr.hexFromSig({r:this.r,s:this.s})}toCompactRawBytes(){return Fi(this.toCompactHex())}toCompactHex(){return d(this.r)+d(this.s)}}const v={isValidPrivateKey(D){try{return u(D),!0}catch{return!1}},normPrivateKeyToScalar:u,randomPrivateKey:()=>{const D=xb(t.n);return l2(t.randomBytes(D),t.n)},precompute(D=8,L=l.BASE){return L._setWindowSize(D),L.multiply(BigInt(3)),L}};function _(D,L=!0){return l.fromPrivateKey(D).toRawBytes(L)}function w(D){const L=Os(D),P=typeof D=="string",T=(L||P)&&D.length;return L?T===s||T===i:P?T===2*s||T===2*i:D instanceof l}function S(D,L,P=!0){if(w(D))throw new Error("first arg must be private key");if(!w(L))throw new Error("second arg must be public key");return l.fromHex(L).multiply(u(D)).toRawBytes(P)}const A=t.bits2int||function(D){if(D.length>8192)throw new Error("input is too large");const L=Cs(D),P=D.length*8-t.nBitLength;return P>0?L>>BigInt(P):L},E=t.bits2int_modN||function(D){return o(A(D))},I=ff(t.nBitLength);function k(D){return Pn("num < 2^"+t.nBitLength,D,Ar,I),$i(D,t.nByteLength)}function x(D,L,P=U){if(["recovered","canonical"].some(q=>q in P))throw new Error("sign() legacy options not supported");const{hash:T,randomBytes:C}=t;let{lowS:R,prehash:O,extraEntropy:V}=P;R==null&&(R=!0),D=dt("msgHash",D),Xp(P),O&&(D=dt("prehashed msgHash",T(D)));const K=E(D),ee=u(L),Y=[k(ee),k(K)];if(V!=null&&V!==!1){const q=V===!0?C(e.BYTES):V;Y.push(dt("extraEntropy",q))}const le=$s(...Y),re=K;function be(q){const ue=A(q);if(!c(ue))return;const Ee=a(ue),we=l.BASE.multiply(ue).toAffine(),H=o(we.x);if(H===Ar)return;const ne=o(Ee*o(re+H*ee));if(ne===Ar)return;let De=(we.x===H?0:2)|Number(we.y&wt),Pt=ne;return R&&f(ne)&&(Pt=g(ne),De^=1),new m(H,Pt,De)}return{seed:le,k2sig:be}}const U={lowS:t.lowS,prehash:!1},B={lowS:t.lowS,prehash:!1};function N(D,L,P=U){const{seed:T,k2sig:C}=x(D,L,P),R=t;return Sb(R.hash.outputLen,R.nByteLength,R.hmac)(T,C)}l.BASE._setWindowSize(8);function z(D,L,P,T=B){const C=D;L=dt("msgHash",L),P=dt("publicKey",P);const{lowS:R,prehash:O,format:V}=T;if(Xp(T),"strict"in T)throw new Error("options.strict was renamed to lowS");if(V!==void 0&&V!=="compact"&&V!=="der")throw new Error("format must be compact or der");const K=typeof C=="string"||Os(C),ee=!K&&!V&&typeof C=="object"&&C!==null&&typeof C.r=="bigint"&&typeof C.s=="bigint";if(!K&&!ee)throw new Error("invalid signature, expected Uint8Array, hex string or Signature instance");let Y,le;try{if(ee&&(Y=new m(C.r,C.s)),K){try{V!=="compact"&&(Y=m.fromDER(C))}catch(De){if(!(De instanceof wr.Err))throw De}!Y&&V!=="der"&&(Y=m.fromCompact(C))}le=l.fromHex(P)}catch{return!1}if(!Y||R&&Y.hasHighS())return!1;O&&(L=t.hash(L));const{r:re,s:be}=Y,q=E(L),ue=a(be),Ee=o(q*ue),we=o(re*ue),H=l.BASE.multiplyAndAddUnsafe(le,Ee,we)?.toAffine();return H?o(H.x)===re:!1}return{CURVE:t,getPublicKey:_,getSharedSecret:S,sign:N,verify:z,ProjectivePoint:l,Signature:m,utils:v}}/*! noble-curves - MIT License (c) 2022 Paul Miller (paulmillr.com) */function tk(n){return{hash:n,hmac:(t,...e)=>kf(n,t,yx(...e)),randomBytes:uf}}function nk(n,t){const e=r=>ek({...n,...tk(r)});return{...e(t),create:e}}/*! noble-curves - MIT License (c) 2022 Paul Miller (paulmillr.com) */const Wb=BigInt("0xfffffffffffffffffffffffffffffffffffffffffffffffffffffffefffffc2f"),eg=BigInt("0xfffffffffffffffffffffffffffffffebaaedce6af48a03bbfd25e8cd0364141"),rk=BigInt(1),Hd=BigInt(2),tg=(n,t)=>(n+t/Hd)/t;function sk(n){const t=Wb,e=BigInt(3),r=BigInt(6),s=BigInt(11),i=BigInt(22),o=BigInt(23),a=BigInt(44),l=BigInt(88),u=n*n*n%t,h=u*u*n%t,c=et(h,e,t)*h%t,d=et(c,e,t)*h%t,f=et(d,Hd,t)*u%t,g=et(f,s,t)*f%t,y=et(g,i,t)*g%t,m=et(y,a,t)*y%t,v=et(m,l,t)*m%t,_=et(v,a,t)*y%t,w=et(_,e,t)*h%t,S=et(w,o,t)*g%t,A=et(S,r,t)*u%t,E=et(A,Hd,t);if(!zd.eql(zd.sqr(E),n))throw new Error("Cannot find square root");return E}const zd=Rl(Wb,void 0,void 0,{sqrt:sk}),ur=nk({a:BigInt(0),b:BigInt(7),Fp:zd,n:eg,Gx:BigInt("55066263022277343669578718895168534326250603453777594175500187360389116729240"),Gy:BigInt("32670510020758816978083085130507043184471273380659243275938904335757337482424"),h:BigInt(1),lowS:!0,endo:{beta:BigInt("0x7ae96a2b657c07106e64479eac3434e99cf0497512f58995c1396c28719501ee"),splitScalar:n=>{const t=eg,e=BigInt("0x3086d221a7d46bcde86c90e49284eb15"),r=-rk*BigInt("0xe4437ed6010e88286f547fa90abfe4c3"),s=BigInt("0x114ca50f7a8e2f3f657c1108d9d44cfd8"),i=e,o=BigInt("0x100000000000000000000000000000000"),a=tg(i*n,t),l=tg(-r*n,t);let u=je(n-a*e-l*s,t),h=je(-a*r-l*i,t);const c=u>o,d=h>o;if(c&&(u=t-u),d&&(h=t-h),u>o||h>o)throw new Error("splitScalar: Endomorphism failed, k="+n);return{k1neg:c,k1:u,k2neg:d,k2:h}}}},ka);BigInt(0);ur.ProjectivePoint;function Gb(n){return n==null?!1:typeof n.then=="function"&&typeof n.catch=="function"&&typeof n.finally=="function"}function ik(n,t){const e=xa.digest(t instanceof Uint8Array?t:t.subarray());if(Gb(e))return e.then(({digest:r})=>ur.sign(r,n).toDERRawBytes()).catch(r=>{throw new jp(String(r))});try{return ur.sign(e.digest,n).toDERRawBytes()}catch(r){throw new jp(String(r))}}function ok(n,t,e){const r=xa.digest(e instanceof Uint8Array?e:e.subarray());if(Gb(r))return r.then(({digest:s})=>ur.verify(t,s,n)).catch(s=>{throw new Zp(String(s))});try{return ur.verify(t,r.digest,n)}catch(s){throw new Zp(String(s))}}class Kb{constructor(t){p(this,"type","secp256k1");p(this,"raw");p(this,"_key");this._key=uk(t),this.raw=ck(this._key)}toMultihash(){return Pl.digest(nr(this))}toCID(){return Qe.createV1(114,this.toMultihash())}toString(){return ot.encode(this.toMultihash().bytes).substring(1)}equals(t){return t==null||!(t.raw instanceof Uint8Array)?!1:It(this.raw,t.raw)}verify(t,e){return ok(this._key,e,t)}}class Yb{constructor(t,e){p(this,"type","secp256k1");p(this,"raw");p(this,"publicKey");this.raw=lk(t),this.publicKey=new Kb(e??dk(t))}equals(t){return t==null||!(t.raw instanceof Uint8Array)?!1:It(this.raw,t.raw)}sign(t){return ik(this.raw,t)}}function Qb(n){return new Yb(n)}function Tf(n){return new Kb(n)}async function ak(){const n=hk();return new Yb(n)}function ck(n){return ur.ProjectivePoint.fromHex(n).toRawBytes(!0)}function lk(n){try{return ur.getPublicKey(n,!0),n}catch(t){throw new tf(String(t))}}function uk(n){try{return ur.ProjectivePoint.fromHex(n),n}catch(t){throw new ef(String(t))}}function dk(n){try{return ur.getPublicKey(n,!0)}catch(t){throw new tf(String(t))}}function hk(){return ur.utils.randomPrivateKey()}async function jb(n,t){if(n==="Ed25519")return T2();if(n==="secp256k1")return ak();if(n==="RSA")return GI(2048);throw new Qs}function Lr(n,t){const{Type:e,Data:r}=us.decode(n),s=r??new Uint8Array;switch(e){case at.RSA:return zb(s,t);case at.Ed25519:return mf(s);case at.secp256k1:return Tf(s);default:throw new Qs}}function fk(n){return n.byteLength===32?mf(n):n.byteLength===33?Tf(n):zb(n)}function pk(n){const{Type:t,Data:e}=us.decode(n.digest),r=e??new Uint8Array;switch(t){case at.Ed25519:return mf(r);case at.secp256k1:return Tf(r);default:throw new Qs}}function nr(n){return us.encode({Type:at[n.type],Data:n.raw})}function gk(n){const t=Lc.decode(n),e=t.Data??new Uint8Array;switch(t.Type){case at.RSA:return Hb(e);case at.Ed25519:return Db(e);case at.secp256k1:return Qb(e);default:throw new Qs}}function mk(n){return n.byteLength===64?Db(n):n.byteLength===32?Qb(n):Hb(n)}function $l(n){return Lc.encode({Type:at[n.type],Data:n.raw})}const Zb=Symbol.for("nodejs.util.inspect.custom"),yk=114;var Xm;class Cf{constructor(t){p(this,"type");p(this,"multihash");p(this,"publicKey");p(this,"string");p(this,Xm,!0);this.type=t.type,this.multihash=t.multihash,Object.defineProperty(this,"string",{enumerable:!1,writable:!0})}get[Symbol.toStringTag](){return`PeerId(${this.toString()})`}toString(){return this.string==null&&(this.string=ot.encode(this.multihash.bytes).slice(1)),this.string}toMultihash(){return this.multihash}toCID(){return Qe.createV1(yk,this.multihash)}toJSON(){return this.toString()}equals(t){if(t==null)return!1;if(t instanceof Uint8Array)return It(this.multihash.bytes,t);if(typeof t=="string")return this.toString()===t;if(t?.toMultihash()?.bytes!=null)return It(this.multihash.bytes,t.toMultihash().bytes);throw new Error("not valid Id")}[(Xm=Zh,Zb)](){return`PeerId(${this.toString()})`}}class Xb extends Cf{constructor(e){super({...e,type:"RSA"});p(this,"type","RSA");p(this,"publicKey");this.publicKey=e.publicKey}}class Jb extends Cf{constructor(e){super({...e,type:"Ed25519"});p(this,"type","Ed25519");p(this,"publicKey");this.publicKey=e.publicKey}}class ew extends Cf{constructor(e){super({...e,type:"secp256k1"});p(this,"type","secp256k1");p(this,"publicKey");this.publicKey=e.publicKey}}const vk=2336;var Jm,ey;class tw{constructor(t){p(this,"type","url");p(this,"multihash");p(this,"publicKey");p(this,"url");p(this,Jm,!0);this.url=t.toString(),this.multihash=Pl.digest(te(this.url))}[(ey=Zb,Jm=Zh,ey)](){return`PeerId(${this.url})`}toString(){return this.toCID().toString()}toMultihash(){return this.multihash}toCID(){return Qe.createV1(vk,this.toMultihash())}toJSON(){return this.toString()}equals(t){return t==null?!1:(t instanceof Uint8Array&&(t=he(t)),t.toString()===this.toString())}}const bk=114,ng=2336;function Bt(n,t){let e;if(n.charAt(0)==="1"||n.charAt(0)==="Q")e=$r(ot.decode(`z${n}`));else throw new Z('Please pass a multibase decoder for strings that do not start with "1" or "Q"');return Zs(e)}function Ta(n){if(n.type==="Ed25519")return new Jb({multihash:n.toCID().multihash,publicKey:n});if(n.type==="secp256k1")return new ew({multihash:n.toCID().multihash,publicKey:n});if(n.type==="RSA")return new Xb({multihash:n.toCID().multihash,publicKey:n});throw new Qs}function wk(n){return Ta(n.publicKey)}function Zs(n){if(Sk(n))return new Xb({multihash:n});if(_k(n))try{const t=pk(n);if(t.type==="Ed25519")return new Jb({multihash:n,publicKey:t});if(t.type==="secp256k1")return new ew({multihash:n,publicKey:t})}catch{const e=he(n.digest);return new tw(new URL(e))}throw new cb("Supplied PeerID Multihash is invalid")}function Ul(n){if(n?.multihash==null||n.version==null||n.version===1&&n.code!==bk&&n.code!==ng)throw new ab("Supplied PeerID CID is invalid");if(n.code===ng){const t=he(n.multihash.digest);return new tw(new URL(t))}return Zs(n.multihash)}function _k(n){return n.code===Pl.code}function Sk(n){return n.code===xa.code}function nw(n){return n[Symbol.asyncIterator]!=null}const Vl=n=>{const t=ln(n),e=cr(t);return Vn(n,e),Vl.bytes=t,e};Vl.bytes=0;function Pf(n,t){t=t??{};const e=t.lengthEncoder??Vl;function*r(s){const i=e(s.byteLength);i instanceof Uint8Array?yield i:yield*i,s instanceof Uint8Array?yield s:yield*s}return nw(n)?async function*(){for await(const s of n)yield*r(s)}():function*(){for(const s of n)yield*r(s)}()}Pf.single=(n,t)=>{t=t??{};const e=t.lengthEncoder??Vl;return new Ge(e(n.byteLength),n)};let Ek=class extends Error{constructor(){super(...arguments);p(this,"name","InvalidMessageLengthError");p(this,"code","ERR_INVALID_MSG_LENGTH")}},Ak=class extends Error{constructor(){super(...arguments);p(this,"name","InvalidDataLengthError");p(this,"code","ERR_MSG_DATA_TOO_LONG")}},xk=class extends Error{constructor(){super(...arguments);p(this,"name","InvalidDataLengthLengthError");p(this,"code","ERR_MSG_LENGTH_TOO_LONG")}},rg=class extends Error{constructor(){super(...arguments);p(this,"name","UnexpectedEOFError");p(this,"code","ERR_UNEXPECTED_EOF")}};const Ik=8,kk=1024*1024*4;var vs;(function(n){n[n.LENGTH=0]="LENGTH",n[n.DATA=1]="DATA"})(vs||(vs={}));const Df=n=>{const t=js(n);return Df.bytes=ln(t),t};Df.bytes=0;function qd(n,t){const e=new Ge;let r=vs.LENGTH,s=-1;const i=t?.lengthDecoder??Df,o=t?.maxLengthLength??Ik,a=t?.maxDataLength??kk;function*l(){for(;e.byteLength>0;){if(r===vs.LENGTH)try{if(s=i(e),s<0)throw new Ek("Invalid message length");if(s>a)throw new Ak("Message length too long");const u=i.bytes;e.consume(u),t?.onLength!=null&&t.onLength(s),r=vs.DATA}catch(u){if(u instanceof RangeError){if(e.byteLength>o)throw new xk("Message length length too long");break}throw u}if(r===vs.DATA){if(e.byteLength<s)break;const u=e.sublist(0,s);e.consume(s),t?.onData!=null&&t.onData(u),yield u,r=vs.LENGTH}}}return nw(n)?async function*(){for await(const u of n)e.append(u),yield*l();if(e.byteLength>0)throw new rg("Unexpected end of input")}():function*(){for(const u of n)e.append(u),yield*l();if(e.byteLength>0)throw new rg("Unexpected end of input")}()}qd.fromReader=(n,t)=>{let e=1;const r=async function*(){for(;;)try{const{done:i,value:o}=await n.next(e);if(i===!0)return;o!=null&&(yield o)}catch(i){if(i.code==="ERR_UNDER_READ")return{done:!0,value:null};throw i}finally{e=1}}();return qd(r,{...t??{},onLength:i=>{e=i}})};function bt(){const n={};return n.promise=new Promise((t,e)=>{n.resolve=t,n.reject=e}),n}class sg{constructor(t){p(this,"buffer");p(this,"mask");p(this,"top");p(this,"btm");p(this,"next");if(!(t>0)||(t-1&t)!==0)throw new Error("Max size for a FixedFIFO should be a power of two");this.buffer=new Array(t),this.mask=t-1,this.top=0,this.btm=0,this.next=null}push(t){return this.buffer[this.top]!==void 0?!1:(this.buffer[this.top]=t,this.top=this.top+1&this.mask,!0)}shift(){const t=this.buffer[this.btm];if(t!==void 0)return this.buffer[this.btm]=void 0,this.btm=this.btm+1&this.mask,t}isEmpty(){return this.buffer[this.btm]===void 0}}class Su{constructor(t={}){p(this,"size");p(this,"hwm");p(this,"head");p(this,"tail");this.hwm=t.splitLimit??16,this.head=new sg(this.hwm),this.tail=this.head,this.size=0}calculateSize(t){return t?.byteLength!=null?t.byteLength:1}push(t){if(t?.value!=null&&(this.size+=this.calculateSize(t.value)),!this.head.push(t)){const e=this.head;this.head=e.next=new sg(2*this.head.buffer.length),this.head.push(t)}}shift(){let t=this.tail.shift();if(t===void 0&&this.tail.next!=null){const e=this.tail.next;this.tail.next=null,this.tail=e,t=this.tail.shift()}return t?.value!=null&&(this.size-=this.calculateSize(t.value)),t}isEmpty(){return this.head.isEmpty()}}let Tk=class extends Error{constructor(e,r){super(e??"The operation was aborted");p(this,"type");p(this,"code");this.type="aborted",this.code=r??"ABORT_ERR"}};function ds(n={}){return Ck(e=>{const r=e.shift();if(r==null)return{done:!0};if(r.error!=null)throw r.error;return{done:r.done===!0,value:r.value}},n)}function Ck(n,t){t=t??{};let e=t.onEnd,r=new Su,s,i,o,a=bt();const l=async()=>{try{return r.isEmpty()?o?{done:!0}:await new Promise((m,v)=>{i=_=>{i=null,r.push(_);try{m(n(r))}catch(w){v(w)}return s}}):n(r)}finally{r.isEmpty()&&queueMicrotask(()=>{a.resolve(),a=bt()})}},u=m=>i!=null?i(m):(r.push(m),s),h=m=>(r=new Su,i!=null?i({error:m}):(r.push({error:m}),s)),c=m=>{if(o)return s;if(t?.objectMode!==!0&&m?.byteLength==null)throw new Error("objectMode was not true but tried to push non-Uint8Array value");return u({done:!1,value:m})},d=m=>o?s:(o=!0,m!=null?h(m):u({done:!0})),f=()=>(r=new Su,d(),{done:!0}),g=m=>(d(m),{done:!0});if(s={[Symbol.asyncIterator](){return this},next:l,return:f,throw:g,push:c,end:d,get readableLength(){return r.size},onEmpty:async m=>{const v=m?.signal;if(v?.throwIfAborted(),r.isEmpty())return;let _,w;v!=null&&(_=new Promise((S,A)=>{w=()=>{A(new Tk)},v.addEventListener("abort",w)}));try{await Promise.race([a.promise,_])}finally{w!=null&&v!=null&&v?.removeEventListener("abort",w)}}},e==null)return s;const y=s;return s={[Symbol.asyncIterator](){return this},next(){return y.next()},throw(m){return y.throw(m),e!=null&&(e(m),e=void 0),{done:!0}},return(){return y.return(),e!=null&&(e(),e=void 0),{done:!0}},push:c,end(m){return y.end(m),e!=null&&(e(m),e=void 0),s},get readableLength(){return y.readableLength},onEmpty:m=>y.onEmpty(m)},s}function Pk(n){return n[Symbol.asyncIterator]!=null}async function Dk(n,t){try{await Promise.all(n.map(async e=>{for await(const r of e)t.push(r)})),t.end()}catch(e){t.end(e)}}async function*Mk(n){const t=ds({objectMode:!0});Dk(n,t).catch(()=>{}),yield*t}function*Lk(n){for(const t of n)yield*t}function Bc(...n){const t=[];for(const e of n)Pk(e)||t.push(e);return t.length===n.length?Lk(t):Mk(n)}function Br(n,...t){if(n==null)throw new Error("Empty pipeline");if(Eu(n)){const r=n;n=()=>r.source}else if(sw(n)||rw(n)){const r=n;n=()=>r}const e=[n,...t];if(e.length>1&&Eu(e[e.length-1])&&(e[e.length-1]=e[e.length-1].sink),e.length>2)for(let r=1;r<e.length-1;r++)Eu(e[r])&&(e[r]=Nk(e[r]));return Bk(...e)}const Bk=(...n)=>{let t;for(;n.length>0;)t=n.shift()(t);return t},rw=n=>n?.[Symbol.asyncIterator]!=null,sw=n=>n?.[Symbol.iterator]!=null,Eu=n=>n==null?!1:n.sink!=null&&n.source!=null,Nk=n=>t=>{const e=n.sink(t);if(e?.then!=null){const r=ds({objectMode:!0});e.then(()=>{r.end()},o=>{r.end(o)});let s;const i=n.source;if(rw(i))s=async function*(){yield*i,r.end()};else if(sw(i))s=function*(){yield*i,r.end()};else throw new Error("Unknown duplex source type - must be Iterable or AsyncIterable");return Bc(r,s())}return n.source},lo=1e3,Mf=60*lo,ig="/floodsub/1.0.0",og="/meshsub/1.0.0",Rk="/meshsub/1.1.0",Au="/meshsub/1.2.0",Ok=6,Fk=4,$k=12,Uk=4,Vk=2,Hk=5,zk=3,qk=6,Wk=.25,Gk=3,ag=100,Kk=lo,Yk=Mf,Qk=16,jk=Mf,Zk=10*lo,Xk=15,Jk=300,eT=lo,tT=60,nT=2,rT=10*lo,ai=5e3,sT=10,iT=3*lo,oT=2*Mf,aT=120*1e3,cT="ERR_TOPIC_VALIDATOR_REJECT",lT="ERR_TOPIC_VALIDATOR_IGNORE",uT=0,dT=128,hT=1e3,fT=1e3,pT=1,gT=512,mT=512,yT={maxSubscriptions:1/0,maxMessages:1/0,maxIhaveMessageIDs:1/0,maxIwantMessageIDs:1/0,maxIdontwantMessageIDs:1/0,maxControlMessages:1/0,maxPeerInfos:1/0};var Ds;(function(n){(function(e){let r;e.codec=()=>(r==null&&(r=Ce((s,i,o={})=>{o.lengthDelimited!==!1&&i.fork(),s.subscribe!=null&&(i.uint32(8),i.bool(s.subscribe)),s.topic!=null&&(i.uint32(18),i.string(s.topic)),o.lengthDelimited!==!1&&i.ldelim()},(s,i,o={})=>{const a={},l=i==null?s.len:s.pos+i;for(;s.pos<l;){const u=s.uint32();switch(u>>>3){case 1:{a.subscribe=s.bool();break}case 2:{a.topic=s.string();break}default:{s.skipType(u&7);break}}}return a})),r),e.encode=s=>Te(s,e.codec()),e.decode=(s,i)=>ke(s,e.codec(),i)})(n.SubOpts||(n.SubOpts={})),function(e){let r;e.codec=()=>(r==null&&(r=Ce((s,i,o={})=>{o.lengthDelimited!==!1&&i.fork(),s.from!=null&&(i.uint32(10),i.bytes(s.from)),s.data!=null&&(i.uint32(18),i.bytes(s.data)),s.seqno!=null&&(i.uint32(26),i.bytes(s.seqno)),s.topic!=null&&s.topic!==""&&(i.uint32(34),i.string(s.topic)),s.signature!=null&&(i.uint32(42),i.bytes(s.signature)),s.key!=null&&(i.uint32(50),i.bytes(s.key)),o.lengthDelimited!==!1&&i.ldelim()},(s,i,o={})=>{const a={topic:""},l=i==null?s.len:s.pos+i;for(;s.pos<l;){const u=s.uint32();switch(u>>>3){case 1:{a.from=s.bytes();break}case 2:{a.data=s.bytes();break}case 3:{a.seqno=s.bytes();break}case 4:{a.topic=s.string();break}case 5:{a.signature=s.bytes();break}case 6:{a.key=s.bytes();break}default:{s.skipType(u&7);break}}}return a})),r),e.encode=s=>Te(s,e.codec()),e.decode=(s,i)=>ke(s,e.codec(),i)}(n.Message||(n.Message={})),function(e){let r;e.codec=()=>(r==null&&(r=Ce((s,i,o={})=>{if(o.lengthDelimited!==!1&&i.fork(),s.ihave!=null)for(const a of s.ihave)i.uint32(10),n.ControlIHave.codec().encode(a,i);if(s.iwant!=null)for(const a of s.iwant)i.uint32(18),n.ControlIWant.codec().encode(a,i);if(s.graft!=null)for(const a of s.graft)i.uint32(26),n.ControlGraft.codec().encode(a,i);if(s.prune!=null)for(const a of s.prune)i.uint32(34),n.ControlPrune.codec().encode(a,i);if(s.idontwant!=null)for(const a of s.idontwant)i.uint32(42),n.ControlIDontWant.codec().encode(a,i);o.lengthDelimited!==!1&&i.ldelim()},(s,i,o={})=>{const a={ihave:[],iwant:[],graft:[],prune:[],idontwant:[]},l=i==null?s.len:s.pos+i;for(;s.pos<l;){const u=s.uint32();switch(u>>>3){case 1:{if(o.limits?.ihave!=null&&a.ihave.length===o.limits.ihave)throw new gt('Decode error - map field "ihave" had too many elements');a.ihave.push(n.ControlIHave.codec().decode(s,s.uint32(),{limits:o.limits?.ihave$}));break}case 2:{if(o.limits?.iwant!=null&&a.iwant.length===o.limits.iwant)throw new gt('Decode error - map field "iwant" had too many elements');a.iwant.push(n.ControlIWant.codec().decode(s,s.uint32(),{limits:o.limits?.iwant$}));break}case 3:{if(o.limits?.graft!=null&&a.graft.length===o.limits.graft)throw new gt('Decode error - map field "graft" had too many elements');a.graft.push(n.ControlGraft.codec().decode(s,s.uint32(),{limits:o.limits?.graft$}));break}case 4:{if(o.limits?.prune!=null&&a.prune.length===o.limits.prune)throw new gt('Decode error - map field "prune" had too many elements');a.prune.push(n.ControlPrune.codec().decode(s,s.uint32(),{limits:o.limits?.prune$}));break}case 5:{if(o.limits?.idontwant!=null&&a.idontwant.length===o.limits.idontwant)throw new gt('Decode error - map field "idontwant" had too many elements');a.idontwant.push(n.ControlIDontWant.codec().decode(s,s.uint32(),{limits:o.limits?.idontwant$}));break}default:{s.skipType(u&7);break}}}return a})),r),e.encode=s=>Te(s,e.codec()),e.decode=(s,i)=>ke(s,e.codec(),i)}(n.ControlMessage||(n.ControlMessage={})),function(e){let r;e.codec=()=>(r==null&&(r=Ce((s,i,o={})=>{if(o.lengthDelimited!==!1&&i.fork(),s.topicID!=null&&(i.uint32(10),i.string(s.topicID)),s.messageIDs!=null)for(const a of s.messageIDs)i.uint32(18),i.bytes(a);o.lengthDelimited!==!1&&i.ldelim()},(s,i,o={})=>{const a={messageIDs:[]},l=i==null?s.len:s.pos+i;for(;s.pos<l;){const u=s.uint32();switch(u>>>3){case 1:{a.topicID=s.string();break}case 2:{if(o.limits?.messageIDs!=null&&a.messageIDs.length===o.limits.messageIDs)throw new gt('Decode error - map field "messageIDs" had too many elements');a.messageIDs.push(s.bytes());break}default:{s.skipType(u&7);break}}}return a})),r),e.encode=s=>Te(s,e.codec()),e.decode=(s,i)=>ke(s,e.codec(),i)}(n.ControlIHave||(n.ControlIHave={})),function(e){let r;e.codec=()=>(r==null&&(r=Ce((s,i,o={})=>{if(o.lengthDelimited!==!1&&i.fork(),s.messageIDs!=null)for(const a of s.messageIDs)i.uint32(10),i.bytes(a);o.lengthDelimited!==!1&&i.ldelim()},(s,i,o={})=>{const a={messageIDs:[]},l=i==null?s.len:s.pos+i;for(;s.pos<l;){const u=s.uint32();switch(u>>>3){case 1:{if(o.limits?.messageIDs!=null&&a.messageIDs.length===o.limits.messageIDs)throw new gt('Decode error - map field "messageIDs" had too many elements');a.messageIDs.push(s.bytes());break}default:{s.skipType(u&7);break}}}return a})),r),e.encode=s=>Te(s,e.codec()),e.decode=(s,i)=>ke(s,e.codec(),i)}(n.ControlIWant||(n.ControlIWant={})),function(e){let r;e.codec=()=>(r==null&&(r=Ce((s,i,o={})=>{o.lengthDelimited!==!1&&i.fork(),s.topicID!=null&&(i.uint32(10),i.string(s.topicID)),o.lengthDelimited!==!1&&i.ldelim()},(s,i,o={})=>{const a={},l=i==null?s.len:s.pos+i;for(;s.pos<l;){const u=s.uint32();switch(u>>>3){case 1:{a.topicID=s.string();break}default:{s.skipType(u&7);break}}}return a})),r),e.encode=s=>Te(s,e.codec()),e.decode=(s,i)=>ke(s,e.codec(),i)}(n.ControlGraft||(n.ControlGraft={})),function(e){let r;e.codec=()=>(r==null&&(r=Ce((s,i,o={})=>{if(o.lengthDelimited!==!1&&i.fork(),s.topicID!=null&&(i.uint32(10),i.string(s.topicID)),s.peers!=null)for(const a of s.peers)i.uint32(18),n.PeerInfo.codec().encode(a,i);s.backoff!=null&&(i.uint32(24),i.uint64Number(s.backoff)),o.lengthDelimited!==!1&&i.ldelim()},(s,i,o={})=>{const a={peers:[]},l=i==null?s.len:s.pos+i;for(;s.pos<l;){const u=s.uint32();switch(u>>>3){case 1:{a.topicID=s.string();break}case 2:{if(o.limits?.peers!=null&&a.peers.length===o.limits.peers)throw new gt('Decode error - map field "peers" had too many elements');a.peers.push(n.PeerInfo.codec().decode(s,s.uint32(),{limits:o.limits?.peers$}));break}case 3:{a.backoff=s.uint64Number();break}default:{s.skipType(u&7);break}}}return a})),r),e.encode=s=>Te(s,e.codec()),e.decode=(s,i)=>ke(s,e.codec(),i)}(n.ControlPrune||(n.ControlPrune={})),function(e){let r;e.codec=()=>(r==null&&(r=Ce((s,i,o={})=>{o.lengthDelimited!==!1&&i.fork(),s.peerID!=null&&(i.uint32(10),i.bytes(s.peerID)),s.signedPeerRecord!=null&&(i.uint32(18),i.bytes(s.signedPeerRecord)),o.lengthDelimited!==!1&&i.ldelim()},(s,i,o={})=>{const a={},l=i==null?s.len:s.pos+i;for(;s.pos<l;){const u=s.uint32();switch(u>>>3){case 1:{a.peerID=s.bytes();break}case 2:{a.signedPeerRecord=s.bytes();break}default:{s.skipType(u&7);break}}}return a})),r),e.encode=s=>Te(s,e.codec()),e.decode=(s,i)=>ke(s,e.codec(),i)}(n.PeerInfo||(n.PeerInfo={})),function(e){let r;e.codec=()=>(r==null&&(r=Ce((s,i,o={})=>{if(o.lengthDelimited!==!1&&i.fork(),s.messageIDs!=null)for(const a of s.messageIDs)i.uint32(10),i.bytes(a);o.lengthDelimited!==!1&&i.ldelim()},(s,i,o={})=>{const a={messageIDs:[]},l=i==null?s.len:s.pos+i;for(;s.pos<l;){const u=s.uint32();switch(u>>>3){case 1:{if(o.limits?.messageIDs!=null&&a.messageIDs.length===o.limits.messageIDs)throw new gt('Decode error - map field "messageIDs" had too many elements');a.messageIDs.push(s.bytes());break}default:{s.skipType(u&7);break}}}return a})),r),e.encode=s=>Te(s,e.codec()),e.decode=(s,i)=>ke(s,e.codec(),i)}(n.ControlIDontWant||(n.ControlIDontWant={}));let t;n.codec=()=>(t==null&&(t=Ce((e,r,s={})=>{if(s.lengthDelimited!==!1&&r.fork(),e.subscriptions!=null)for(const i of e.subscriptions)r.uint32(10),n.SubOpts.codec().encode(i,r);if(e.messages!=null)for(const i of e.messages)r.uint32(18),n.Message.codec().encode(i,r);e.control!=null&&(r.uint32(26),n.ControlMessage.codec().encode(e.control,r)),s.lengthDelimited!==!1&&r.ldelim()},(e,r,s={})=>{const i={subscriptions:[],messages:[]},o=r==null?e.len:e.pos+r;for(;e.pos<o;){const a=e.uint32();switch(a>>>3){case 1:{if(s.limits?.subscriptions!=null&&i.subscriptions.length===s.limits.subscriptions)throw new gt('Decode error - map field "subscriptions" had too many elements');i.subscriptions.push(n.SubOpts.codec().decode(e,e.uint32(),{limits:s.limits?.subscriptions$}));break}case 2:{if(s.limits?.messages!=null&&i.messages.length===s.limits.messages)throw new gt('Decode error - map field "messages" had too many elements');i.messages.push(n.Message.codec().decode(e,e.uint32(),{limits:s.limits?.messages$}));break}case 3:{i.control=n.ControlMessage.codec().decode(e,e.uint32(),{limits:s.limits?.control});break}default:{e.skipType(a&7);break}}}return i})),t),n.encode=e=>Te(e,n.codec()),n.decode=(e,r)=>ke(e,n.codec(),r)})(Ds||(Ds={}));class vT{constructor(t,e,r){p(this,"gossip");p(this,"msgs",new Map);p(this,"msgIdToStrFn");p(this,"history",[]);p(this,"notValidatedCount",0);this.gossip=t,this.msgIdToStrFn=r;for(let s=0;s<e;s++)this.history[s]=[]}get size(){return this.msgs.size}put(t,e,r=!1){const{msgIdStr:s}=t;return this.msgs.has(s)?!1:(this.msgs.set(s,{message:e,validated:r,originatingPeers:new Set,iwantCounts:new Map}),this.history[0].push({...t,topic:e.topic}),r||this.notValidatedCount++,!0)}observeDuplicate(t,e){const r=this.msgs.get(t);r!=null&&!r.validated&&r.originatingPeers.add(e)}get(t){return this.msgs.get(this.msgIdToStrFn(t))?.message}getWithIWantCount(t,e){const r=this.msgs.get(t);if(r==null)return null;const s=(r.iwantCounts.get(e)??0)+1;return r.iwantCounts.set(e,s),{msg:r.message,count:s}}getGossipIDs(t){const e=new Map;for(let r=0;r<this.gossip;r++)this.history[r].forEach(s=>{if((this.msgs.get(s.msgIdStr)?.validated??!1)&&t.has(s.topic)){let o=e.get(s.topic);o==null&&(o=[],e.set(s.topic,o)),o.push(s.msgId)}});return e}validate(t){const e=this.msgs.get(t);if(e==null)return null;e.validated||this.notValidatedCount--;const{message:r,originatingPeers:s}=e;return e.validated=!0,e.originatingPeers=new Set,{message:r,originatingPeers:s}}shift(){this.history[this.history.length-1].forEach(e=>{const r=this.msgs.get(e.msgIdStr);r!=null&&(this.msgs.delete(e.msgIdStr),r.validated||this.notValidatedCount--)}),this.history.pop(),this.history.unshift([])}remove(t){const e=this.msgs.get(t);return e==null?null:(this.msgs.delete(t),e)}}var cg;(function(n){n.StrictSign="StrictSign",n.StrictNoSign="StrictNoSign"})(cg||(cg={}));var Vi;(function(n){n[n.Signing=0]="Signing",n[n.Anonymous=1]="Anonymous"})(Vi||(Vi={}));var Hn;(function(n){n.Error="error",n.Ignore="ignore",n.Reject="reject",n.Blacklisted="blacklisted"})(Hn||(Hn={}));var Jt;(function(n){n.InvalidSignature="invalid_signature",n.InvalidSeqno="invalid_seqno",n.InvalidPeerId="invalid_peerid",n.SignaturePresent="signature_present",n.SeqnoPresent="seqno_present",n.FromPresent="from_present",n.TransformFailed="transform_failed"})(Jt||(Jt={}));var tn;(function(n){n.duplicate="duplicate",n.invalid="invalid",n.valid="valid"})(tn||(tn={}));function lg(n){switch(n){case Cn.Ignore:return Hn.Ignore;case Cn.Reject:return Hn.Reject;default:throw new Error("Unreachable")}}var ug;(function(n){n.forward="forward",n.publish="publish"})(ug||(ug={}));var rn;(function(n){n.Fanout="fanout",n.Random="random",n.Subscribed="subscribed",n.Outbound="outbound",n.NotEnough="not_enough",n.Opportunistic="opportunistic"})(rn||(rn={}));var Jn;(function(n){n.Dc="disconnected",n.BadScore="bad_score",n.Prune="prune",n.Excess="excess"})(Jn||(Jn={}));var Oo;(function(n){n.GraftBackoff="graft_backoff",n.BrokenPromise="broken_promise",n.MessageDeficit="message_deficit",n.IPColocation="IP_colocation"})(Oo||(Oo={}));var Fo;(function(n){n.LowScore="low_score",n.MaxIhave="max_ihave",n.MaxIasked="max_iasked"})(Fo||(Fo={}));var gi;(function(n){n.graylist="graylist",n.publish="publish",n.gossip="gossip",n.mesh="mesh"})(gi||(gi={}));function bT(n,t,e){return{protocolsEnabled:n.gauge({name:"gossipsub_protocol",help:"Status of enabled protocols",labelNames:["protocol"]}),topicSubscriptionStatus:n.gauge({name:"gossipsub_topic_subscription_status",help:"Status of our subscription to this topic",labelNames:["topicStr"]}),topicPeersCount:n.gauge({name:"gossipsub_topic_peer_count",help:"Number of peers subscribed to each topic",labelNames:["topicStr"]}),meshPeerCounts:n.gauge({name:"gossipsub_mesh_peer_count",help:"Number of peers in our mesh",labelNames:["topicStr"]}),meshPeerInclusionEventsFanout:n.gauge({name:"gossipsub_mesh_peer_inclusion_events_fanout_total",help:"Number of times we include peers in a topic mesh for fanout reasons",labelNames:["topic"]}),meshPeerInclusionEventsRandom:n.gauge({name:"gossipsub_mesh_peer_inclusion_events_random_total",help:"Number of times we include peers in a topic mesh for random reasons",labelNames:["topic"]}),meshPeerInclusionEventsSubscribed:n.gauge({name:"gossipsub_mesh_peer_inclusion_events_subscribed_total",help:"Number of times we include peers in a topic mesh for subscribed reasons",labelNames:["topic"]}),meshPeerInclusionEventsOutbound:n.gauge({name:"gossipsub_mesh_peer_inclusion_events_outbound_total",help:"Number of times we include peers in a topic mesh for outbound reasons",labelNames:["topic"]}),meshPeerInclusionEventsNotEnough:n.gauge({name:"gossipsub_mesh_peer_inclusion_events_not_enough_total",help:"Number of times we include peers in a topic mesh for not_enough reasons",labelNames:["topic"]}),meshPeerInclusionEventsOpportunistic:n.gauge({name:"gossipsub_mesh_peer_inclusion_events_opportunistic_total",help:"Number of times we include peers in a topic mesh for opportunistic reasons",labelNames:["topic"]}),meshPeerInclusionEventsUnknown:n.gauge({name:"gossipsub_mesh_peer_inclusion_events_unknown_total",help:"Number of times we include peers in a topic mesh for unknown reasons",labelNames:["topic"]}),meshPeerChurnEventsDisconnected:n.gauge({name:"gossipsub_peer_churn_events_disconnected_total",help:"Number of times we remove peers in a topic mesh for disconnected reasons",labelNames:["topic"]}),meshPeerChurnEventsBadScore:n.gauge({name:"gossipsub_peer_churn_events_bad_score_total",help:"Number of times we remove peers in a topic mesh for bad_score reasons",labelNames:["topic"]}),meshPeerChurnEventsPrune:n.gauge({name:"gossipsub_peer_churn_events_prune_total",help:"Number of times we remove peers in a topic mesh for prune reasons",labelNames:["topic"]}),meshPeerChurnEventsExcess:n.gauge({name:"gossipsub_peer_churn_events_excess_total",help:"Number of times we remove peers in a topic mesh for excess reasons",labelNames:["topic"]}),meshPeerChurnEventsUnknown:n.gauge({name:"gossipsub_peer_churn_events_unknown_total",help:"Number of times we remove peers in a topic mesh for unknown reasons",labelNames:["topic"]}),peersPerProtocol:n.gauge({name:"gossipsub_peers_per_protocol_count",help:"Peers connected for each topic",labelNames:["protocol"]}),heartbeatDuration:n.histogram({name:"gossipsub_heartbeat_duration_seconds",help:"The time it takes to complete one iteration of the heartbeat",buckets:[.01,.1,1]}),heartbeatSkipped:n.gauge({name:"gossipsub_heartbeat_skipped",help:"Heartbeat run took longer than heartbeat interval so next is skipped"}),acceptedMessagesTotal:n.gauge({name:"gossipsub_accepted_messages_total",help:"Total accepted messages for each topic",labelNames:["topic"]}),ignoredMessagesTotal:n.gauge({name:"gossipsub_ignored_messages_total",help:"Total ignored messages for each topic",labelNames:["topic"]}),rejectedMessagesTotal:n.gauge({name:"gossipsub_rejected_messages_total",help:"Total rejected messages for each topic",labelNames:["topic"]}),unknownValidationResultsTotal:n.gauge({name:"gossipsub_unknown_validation_results_total",help:"Total unknown validation results for each topic",labelNames:["topic"]}),asyncValidationMcacheHit:n.gauge({name:"gossipsub_async_validation_mcache_hit_total",help:"Async validation result reported by the user layer",labelNames:["hit"]}),asyncValidationDelayFromFirstSeenSec:n.histogram({name:"gossipsub_async_validation_delay_from_first_seen",help:"Async validation report delay from first seen in second",buckets:[.01,.03,.1,.3,1,3,10]}),asyncValidationUnknownFirstSeen:n.gauge({name:"gossipsub_async_validation_unknown_first_seen_count_total",help:"Async validation report unknown first seen value for message"}),peerReadStreamError:n.gauge({name:"gossipsub_peer_read_stream_err_count_total",help:"Peer read stream error"}),rpcRecvBytes:n.gauge({name:"gossipsub_rpc_recv_bytes_total",help:"RPC recv"}),rpcRecvCount:n.gauge({name:"gossipsub_rpc_recv_count_total",help:"RPC recv"}),rpcRecvSubscription:n.gauge({name:"gossipsub_rpc_recv_subscription_total",help:"RPC recv"}),rpcRecvMessage:n.gauge({name:"gossipsub_rpc_recv_message_total",help:"RPC recv"}),rpcRecvControl:n.gauge({name:"gossipsub_rpc_recv_control_total",help:"RPC recv"}),rpcRecvIHave:n.gauge({name:"gossipsub_rpc_recv_ihave_total",help:"RPC recv"}),rpcRecvIWant:n.gauge({name:"gossipsub_rpc_recv_iwant_total",help:"RPC recv"}),rpcRecvGraft:n.gauge({name:"gossipsub_rpc_recv_graft_total",help:"RPC recv"}),rpcRecvPrune:n.gauge({name:"gossipsub_rpc_recv_prune_total",help:"RPC recv"}),rpcDataError:n.gauge({name:"gossipsub_rpc_data_err_count_total",help:"RPC data error"}),rpcRecvError:n.gauge({name:"gossipsub_rpc_recv_err_count_total",help:"RPC recv error"}),rpcRecvNotAccepted:n.gauge({name:"gossipsub_rpc_rcv_not_accepted_total",help:"Total count of RPC dropped because acceptFrom() == false"}),rpcSentBytes:n.gauge({name:"gossipsub_rpc_sent_bytes_total",help:"RPC sent"}),rpcSentCount:n.gauge({name:"gossipsub_rpc_sent_count_total",help:"RPC sent"}),rpcSentSubscription:n.gauge({name:"gossipsub_rpc_sent_subscription_total",help:"RPC sent"}),rpcSentMessage:n.gauge({name:"gossipsub_rpc_sent_message_total",help:"RPC sent"}),rpcSentControl:n.gauge({name:"gossipsub_rpc_sent_control_total",help:"RPC sent"}),rpcSentIHave:n.gauge({name:"gossipsub_rpc_sent_ihave_total",help:"RPC sent"}),rpcSentIWant:n.gauge({name:"gossipsub_rpc_sent_iwant_total",help:"RPC sent"}),rpcSentGraft:n.gauge({name:"gossipsub_rpc_sent_graft_total",help:"RPC sent"}),rpcSentPrune:n.gauge({name:"gossipsub_rpc_sent_prune_total",help:"RPC sent"}),rpcSentIDontWant:n.gauge({name:"gossipsub_rpc_sent_idontwant_total",help:"RPC sent"}),msgPublishCount:n.gauge({name:"gossipsub_msg_publish_count_total",help:"Total count of msg published by topic",labelNames:["topic"]}),msgPublishPeersByTopic:n.gauge({name:"gossipsub_msg_publish_peers_total",help:"Total count of peers that we publish a msg to",labelNames:["topic"]}),directPeersPublishedTotal:n.gauge({name:"gossipsub_direct_peers_published_total",help:"Total direct peers that we publish a msg to",labelNames:["topic"]}),floodsubPeersPublishedTotal:n.gauge({name:"gossipsub_floodsub_peers_published_total",help:"Total floodsub peers that we publish a msg to",labelNames:["topic"]}),meshPeersPublishedTotal:n.gauge({name:"gossipsub_mesh_peers_published_total",help:"Total mesh peers that we publish a msg to",labelNames:["topic"]}),fanoutPeersPublishedTotal:n.gauge({name:"gossipsub_fanout_peers_published_total",help:"Total fanout peers that we publish a msg to",labelNames:["topic"]}),msgPublishBytes:n.gauge({name:"gossipsub_msg_publish_bytes_total",help:"Total count of msg publish data.length bytes",labelNames:["topic"]}),msgPublishTime:n.histogram({name:"gossipsub_msg_publish_seconds",help:"Total time in seconds to publish a message",buckets:[.001,.002,.005,.01,.1,.5,1],labelNames:["topic"]}),msgForwardCount:n.gauge({name:"gossipsub_msg_forward_count_total",help:"Total count of msg forwarded by topic",labelNames:["topic"]}),msgForwardPeers:n.gauge({name:"gossipsub_msg_forward_peers_total",help:"Total count of peers that we forward a msg to",labelNames:["topic"]}),msgReceivedPreValidation:n.gauge({name:"gossipsub_msg_received_prevalidation_total",help:"Total count of recv msgs before any validation",labelNames:["topic"]}),msgReceivedError:n.gauge({name:"gossipsub_msg_received_error_total",help:"Total count of recv msgs error",labelNames:["topic"]}),prevalidationInvalidTotal:n.gauge({name:"gossipsub_pre_validation_invalid_total",help:"Total count of invalid messages received",labelNames:["topic"]}),prevalidationValidTotal:n.gauge({name:"gossipsub_pre_validation_valid_total",help:"Total count of valid messages received",labelNames:["topic"]}),prevalidationDuplicateTotal:n.gauge({name:"gossipsub_pre_validation_duplicate_total",help:"Total count of duplicate messages received",labelNames:["topic"]}),prevalidationUnknownTotal:n.gauge({name:"gossipsub_pre_validation_unknown_status_total",help:"Total count of unknown_status messages received",labelNames:["topic"]}),msgReceivedInvalid:n.gauge({name:"gossipsub_msg_received_invalid_total",help:"Tracks specific reason of invalid",labelNames:["error"]}),msgReceivedInvalidByTopic:n.gauge({name:"gossipsub_msg_received_invalid_by_topic_total",help:"Tracks specific invalid message by topic",labelNames:["topic"]}),duplicateMsgDeliveryDelay:n.histogram({name:"gossisub_duplicate_msg_delivery_delay_seconds",help:"Time since the 1st duplicated message validated",labelNames:["topic"],buckets:[.25*e.maxMeshMessageDeliveriesWindowSec,.5*e.maxMeshMessageDeliveriesWindowSec,Number(e.maxMeshMessageDeliveriesWindowSec),2*e.maxMeshMessageDeliveriesWindowSec,4*e.maxMeshMessageDeliveriesWindowSec]}),duplicateMsgLateDelivery:n.gauge({name:"gossisub_duplicate_msg_late_delivery_total",help:"Total count of late duplicate message delivery by topic, which triggers P3 penalty",labelNames:["topic"]}),duplicateMsgIgnored:n.gauge({name:"gossisub_ignored_published_duplicate_msgs_total",help:"Total count of published duplicate message ignored by topic",labelNames:["topic"]}),scoreFnCalls:n.gauge({name:"gossipsub_score_fn_calls_total",help:"Total times score() is called"}),scoreFnRuns:n.gauge({name:"gossipsub_score_fn_runs_total",help:"Total times score() call actually computed computeScore(), no cache"}),scoreCachedDelta:n.histogram({name:"gossipsub_score_cache_delta",help:"Delta of score between cached values that expired",buckets:[10,100,1e3]}),peersByScoreThreshold:n.gauge({name:"gossipsub_peers_by_score_threshold_count",help:"Current count of peers by score threshold",labelNames:["threshold"]}),score:n.avgMinMax({name:"gossipsub_score",help:"Avg min max of gossip scores"}),scoreWeights:n.avgMinMax({name:"gossipsub_score_weights",help:"Separate score weights",labelNames:["topic","p"]}),scorePerMesh:n.avgMinMax({name:"gossipsub_score_per_mesh",help:"Histogram of the scores for each mesh topic",labelNames:["topic"]}),scoringPenalties:n.gauge({name:"gossipsub_scoring_penalties_total",help:"A counter of the kind of penalties being applied to peers",labelNames:["penalty"]}),behaviourPenalty:n.histogram({name:"gossipsub_peer_stat_behaviour_penalty",help:"Current peer stat behaviour_penalty at each scrape",buckets:[.25*e.behaviourPenaltyThreshold,.5*e.behaviourPenaltyThreshold,Number(e.behaviourPenaltyThreshold),2*e.behaviourPenaltyThreshold,4*e.behaviourPenaltyThreshold]}),ihaveRcvIgnored:n.gauge({name:"gossipsub_ihave_rcv_ignored_total",help:"Total received IHAVE messages that we ignore for some reason",labelNames:["reason"]}),ihaveRcvMsgids:n.gauge({name:"gossipsub_ihave_rcv_msgids_total",help:"Total received IHAVE messages by topic",labelNames:["topic"]}),ihaveRcvNotSeenMsgids:n.gauge({name:"gossipsub_ihave_rcv_not_seen_msgids_total",help:"Total messages per topic we do not have, not actual requests",labelNames:["topic"]}),iwantRcvMsgids:n.gauge({name:"gossipsub_iwant_rcv_msgids_total",help:"Total received IWANT messages by topic",labelNames:["topic"]}),iwantRcvDonthaveMsgids:n.gauge({name:"gossipsub_iwant_rcv_dont_have_msgids_total",help:"Total requested messageIDs that we do not have"}),idontwantRcvMsgids:n.gauge({name:"gossipsub_idontwant_rcv_msgids_total",help:"Total received IDONTWANT messages"}),idontwantRcvDonthaveMsgids:n.gauge({name:"gossipsub_idontwant_rcv_dont_have_msgids_total",help:"Total received IDONTWANT messageIDs that we do not have in mcache"}),iwantPromiseStarted:n.gauge({name:"gossipsub_iwant_promise_sent_total",help:"Total count of started IWANT promises"}),iwantPromiseResolved:n.gauge({name:"gossipsub_iwant_promise_resolved_total",help:"Total count of resolved IWANT promises"}),iwantPromiseResolvedFromDuplicate:n.gauge({name:"gossipsub_iwant_promise_resolved_from_duplicate_total",help:"Total count of resolved IWANT promises from duplicate messages"}),iwantPromiseResolvedPeers:n.gauge({name:"gossipsub_iwant_promise_resolved_peers",help:"Total count of peers we have asked IWANT promises that are resolved"}),iwantPromiseBroken:n.gauge({name:"gossipsub_iwant_promise_broken",help:"Total count of broken IWANT promises"}),iwantMessagePruned:n.gauge({name:"gossipsub_iwant_message_pruned",help:"Total count of pruned IWANT messages"}),iwantPromiseDeliveryTime:n.histogram({name:"gossipsub_iwant_promise_delivery_seconds",help:"Histogram of delivery time of resolved IWANT promises",buckets:[.5*e.gossipPromiseExpireSec,Number(e.gossipPromiseExpireSec),2*e.gossipPromiseExpireSec,4*e.gossipPromiseExpireSec]}),iwantPromiseUntracked:n.gauge({name:"gossip_iwant_promise_untracked",help:"Total count of untracked IWANT promise"}),connectedPeersBackoffSec:n.histogram({name:"gossipsub_connected_peers_backoff_seconds",help:"Backoff time in seconds",buckets:[1,2,4,10,20,60,120]}),cacheSize:n.gauge({name:"gossipsub_cache_size",help:"Unbounded cache sizes",labelNames:["cache"]}),mcacheSize:n.gauge({name:"gossipsub_mcache_size",help:"Current mcache msg count"}),mcacheNotValidatedCount:n.gauge({name:"gossipsub_mcache_not_validated_count",help:"Current mcache msg count not validated"}),fastMsgIdCacheCollision:n.gauge({name:"gossipsub_fastmsgid_cache_collision_total",help:"Total count of key collisions on fastmsgid cache put"}),newConnectionCount:n.gauge({name:"gossipsub_new_connection_total",help:"Total new connection by status",labelNames:["status"]}),topicStrToLabel:t,toTopic(r){return this.topicStrToLabel.get(r)??r},onJoin(r){this.topicSubscriptionStatus.set({topicStr:r},1),this.meshPeerCounts.set({topicStr:r},0)},onLeave(r){this.topicSubscriptionStatus.set({topicStr:r},0),this.meshPeerCounts.set({topicStr:r},0)},onAddToMesh(r,s,i){const o=this.toTopic(r);switch(s){case rn.Fanout:this.meshPeerInclusionEventsFanout.inc({topic:o},i);break;case rn.Random:this.meshPeerInclusionEventsRandom.inc({topic:o},i);break;case rn.Subscribed:this.meshPeerInclusionEventsSubscribed.inc({topic:o},i);break;case rn.Outbound:this.meshPeerInclusionEventsOutbound.inc({topic:o},i);break;case rn.NotEnough:this.meshPeerInclusionEventsNotEnough.inc({topic:o},i);break;case rn.Opportunistic:this.meshPeerInclusionEventsOpportunistic.inc({topic:o},i);break;default:this.meshPeerInclusionEventsUnknown.inc({topic:o},i);break}},onRemoveFromMesh(r,s,i){const o=this.toTopic(r);switch(s){case Jn.Dc:this.meshPeerChurnEventsDisconnected.inc({topic:o},i);break;case Jn.BadScore:this.meshPeerChurnEventsBadScore.inc({topic:o},i);break;case Jn.Prune:this.meshPeerChurnEventsPrune.inc({topic:o},i);break;case Jn.Excess:this.meshPeerChurnEventsExcess.inc({topic:o},i);break;default:this.meshPeerChurnEventsUnknown.inc({topic:o},i);break}},onReportValidation(r,s,i){if(this.asyncValidationMcacheHit.inc({hit:r!=null?"hit":"miss"}),r!=null){const o=this.toTopic(r.message.topic);switch(s){case Cn.Accept:this.acceptedMessagesTotal.inc({topic:o});break;case Cn.Ignore:this.ignoredMessagesTotal.inc({topic:o});break;case Cn.Reject:this.rejectedMessagesTotal.inc({topic:o});break;default:this.unknownValidationResultsTotal.inc({topic:o});break}}i!=null?this.asyncValidationDelayFromFirstSeenSec.observe((Date.now()-i)/1e3):this.asyncValidationUnknownFirstSeen.inc()},onScorePenalty(r){this.scoringPenalties.inc({penalty:r},1)},onIhaveRcv(r,s,i){const o=this.toTopic(r);this.ihaveRcvMsgids.inc({topic:o},s),this.ihaveRcvNotSeenMsgids.inc({topic:o},i)},onIwantRcv(r,s){for(const[i,o]of r){const a=this.toTopic(i);this.iwantRcvMsgids.inc({topic:a},o)}this.iwantRcvDonthaveMsgids.inc(s)},onIdontwantRcv(r,s){this.idontwantRcvMsgids.inc(r),this.idontwantRcvDonthaveMsgids.inc(s)},onForwardMsg(r,s){const i=this.toTopic(r);this.msgForwardCount.inc({topic:i},1),this.msgForwardPeers.inc({topic:i},s)},onPublishMsg(r,s,i,o,a){const l=this.toTopic(r);this.msgPublishCount.inc({topic:l},1),this.msgPublishBytes.inc({topic:l},i*o),this.msgPublishPeersByTopic.inc({topic:l},i),this.directPeersPublishedTotal.inc({topic:l},s.direct),this.floodsubPeersPublishedTotal.inc({topic:l},s.floodsub),this.meshPeersPublishedTotal.inc({topic:l},s.mesh),this.fanoutPeersPublishedTotal.inc({topic:l},s.fanout),this.msgPublishTime.observe({topic:l},a/1e3)},onMsgRecvPreValidation(r){const s=this.toTopic(r);this.msgReceivedPreValidation.inc({topic:s},1)},onMsgRecvError(r){const s=this.toTopic(r);this.msgReceivedError.inc({topic:s},1)},onPrevalidationResult(r,s){const i=this.toTopic(r);switch(s){case tn.duplicate:this.prevalidationDuplicateTotal.inc({topic:i});break;case tn.invalid:this.prevalidationInvalidTotal.inc({topic:i});break;case tn.valid:this.prevalidationValidTotal.inc({topic:i});break;default:this.prevalidationUnknownTotal.inc({topic:i});break}},onMsgRecvInvalid(r,s){const i=this.toTopic(r),o=s.reason===Hn.Error?s.error:s.reason;this.msgReceivedInvalid.inc({error:o},1),this.msgReceivedInvalidByTopic.inc({topic:i},1)},onDuplicateMsgDelivery(r,s,i){const o=this.toTopic(r);this.duplicateMsgDeliveryDelay.observe({topic:o},s/1e3),i&&this.duplicateMsgLateDelivery.inc({topic:o},1)},onPublishDuplicateMsg(r){const s=this.toTopic(r);this.duplicateMsgIgnored.inc({topic:s},1)},onPeerReadStreamError(){this.peerReadStreamError.inc(1)},onRpcRecvError(){this.rpcRecvError.inc(1)},onRpcDataError(){this.rpcDataError.inc(1)},onRpcRecv(r,s){this.rpcRecvBytes.inc(s),this.rpcRecvCount.inc(1),r.subscriptions!=null&&this.rpcRecvSubscription.inc(r.subscriptions.length),r.messages!=null&&this.rpcRecvMessage.inc(r.messages.length),r.control!=null&&(this.rpcRecvControl.inc(1),r.control.ihave!=null&&this.rpcRecvIHave.inc(r.control.ihave.length),r.control.iwant!=null&&this.rpcRecvIWant.inc(r.control.iwant.length),r.control.graft!=null&&this.rpcRecvGraft.inc(r.control.graft.length),r.control.prune!=null&&this.rpcRecvPrune.inc(r.control.prune.length))},onRpcSent(r,s){if(this.rpcSentBytes.inc(s),this.rpcSentCount.inc(1),r.subscriptions!=null&&this.rpcSentSubscription.inc(r.subscriptions.length),r.messages!=null&&this.rpcSentMessage.inc(r.messages.length),r.control!=null){const i=r.control.ihave?.length??0,o=r.control.iwant?.length??0,a=r.control.graft?.length??0,l=r.control.prune?.length??0,u=r.control.idontwant?.length??0;i>0&&this.rpcSentIHave.inc(i),o>0&&this.rpcSentIWant.inc(o),a>0&&this.rpcSentGraft.inc(a),l>0&&this.rpcSentPrune.inc(l),u>0&&this.rpcSentIDontWant.inc(u),(i>0||o>0||a>0||l>0||u>0)&&this.rpcSentControl.inc(1)}},registerScores(r,s){let i=0,o=0,a=0,l=0;for(const u of r)u>=s.graylistThreshold&&i++,u>=s.publishThreshold&&o++,u>=s.gossipThreshold&&a++,u>=0&&l++;this.peersByScoreThreshold.set({threshold:gi.graylist},i),this.peersByScoreThreshold.set({threshold:gi.publish},o),this.peersByScoreThreshold.set({threshold:gi.gossip},a),this.peersByScoreThreshold.set({threshold:gi.mesh},l),this.score.set(r)},registerScoreWeights(r){for(const[s,i]of r.byTopic)this.scoreWeights.set({topic:s,p:"p1"},i.p1w),this.scoreWeights.set({topic:s,p:"p2"},i.p2w),this.scoreWeights.set({topic:s,p:"p3"},i.p3w),this.scoreWeights.set({topic:s,p:"p3b"},i.p3bw),this.scoreWeights.set({topic:s,p:"p4"},i.p4w);this.scoreWeights.set({p:"p5"},r.p5w),this.scoreWeights.set({p:"p6"},r.p6w),this.scoreWeights.set({p:"p7"},r.p7w)},registerScorePerMesh(r,s){const i=new Map;r.forEach((o,a)=>{const l=this.topicStrToLabel.get(a)??"unknown";let u=i.get(l);u==null&&(u=new Set,i.set(l,u)),o.forEach(h=>u?.add(h))});for(const[o,a]of i){const l=[];a.forEach(u=>{l.push(s.get(u)??0)}),this.scorePerMesh.set({topic:o},l)}}}}class Fe extends Error{constructor(t="Invalid peer score params"){super(t),this.name="InvalidPeerScoreParamsError"}}p(Fe,"name","InvalidPeerScoreParamsError");const wT={topics:{},topicScoreCap:10,appSpecificScore:()=>0,appSpecificWeight:10,IPColocationFactorWeight:-5,IPColocationFactorThreshold:10,IPColocationFactorWhitelist:new Set,behaviourPenaltyWeight:-10,behaviourPenaltyThreshold:0,behaviourPenaltyDecay:.2,decayInterval:1e3,decayToZero:.1,retainScore:3600*1e3},_T={topicWeight:.5,timeInMeshWeight:1,timeInMeshQuantum:1,timeInMeshCap:3600,firstMessageDeliveriesWeight:1,firstMessageDeliveriesDecay:.5,firstMessageDeliveriesCap:2e3,meshMessageDeliveriesWeight:-1,meshMessageDeliveriesDecay:.5,meshMessageDeliveriesCap:100,meshMessageDeliveriesThreshold:20,meshMessageDeliveriesWindow:10,meshMessageDeliveriesActivation:5e3,meshFailurePenaltyWeight:-1,meshFailurePenaltyDecay:.5,invalidMessageDeliveriesWeight:-1,invalidMessageDeliveriesDecay:.3};function ST(n={}){return{...wT,...n,topics:n.topics!=null?Object.entries(n.topics).reduce((t,[e,r])=>(t[e]=ET(r),t),{}):{}}}function ET(n={}){return{..._T,...n}}function AT(n){for(const[t,e]of Object.entries(n.topics))try{xT(e)}catch(r){throw new Fe(`invalid score parameters for topic ${t}: ${r.message}`)}if(n.topicScoreCap<0)throw new Fe("invalid topic score cap; must be positive (or 0 for no cap)");if(n.appSpecificScore===null||n.appSpecificScore===void 0)throw new Fe("missing application specific score function");if(n.IPColocationFactorWeight>0)throw new Fe("invalid IPColocationFactorWeight; must be negative (or 0 to disable)");if(n.IPColocationFactorWeight!==0&&n.IPColocationFactorThreshold<1)throw new Fe("invalid IPColocationFactorThreshold; must be at least 1");if(n.behaviourPenaltyWeight>0)throw new Fe("invalid BehaviourPenaltyWeight; must be negative (or 0 to disable)");if(n.behaviourPenaltyWeight!==0&&(n.behaviourPenaltyDecay<=0||n.behaviourPenaltyDecay>=1))throw new Fe("invalid BehaviourPenaltyDecay; must be between 0 and 1");if(n.decayInterval<1e3)throw new Fe("invalid DecayInterval; must be at least 1s");if(n.decayToZero<=0||n.decayToZero>=1)throw new Fe("invalid DecayToZero; must be between 0 and 1")}function xT(n){if(n.topicWeight<0)throw new Fe("invalid topic weight; must be >= 0");if(n.timeInMeshQuantum===0)throw new Fe("invalid TimeInMeshQuantum; must be non zero");if(n.timeInMeshWeight<0)throw new Fe("invalid TimeInMeshWeight; must be positive (or 0 to disable)");if(n.timeInMeshWeight!==0&&n.timeInMeshQuantum<=0)throw new Fe("invalid TimeInMeshQuantum; must be positive");if(n.timeInMeshWeight!==0&&n.timeInMeshCap<=0)throw new Fe("invalid TimeInMeshCap; must be positive");if(n.firstMessageDeliveriesWeight<0)throw new Fe("invallid FirstMessageDeliveriesWeight; must be positive (or 0 to disable)");if(n.firstMessageDeliveriesWeight!==0&&(n.firstMessageDeliveriesDecay<=0||n.firstMessageDeliveriesDecay>=1))throw new Fe("invalid FirstMessageDeliveriesDecay; must be between 0 and 1");if(n.firstMessageDeliveriesWeight!==0&&n.firstMessageDeliveriesCap<=0)throw new Fe("invalid FirstMessageDeliveriesCap; must be positive");if(n.meshMessageDeliveriesWeight>0)throw new Fe("invalid MeshMessageDeliveriesWeight; must be negative (or 0 to disable)");if(n.meshMessageDeliveriesWeight!==0&&(n.meshMessageDeliveriesDecay<=0||n.meshMessageDeliveriesDecay>=1))throw new Fe("invalid MeshMessageDeliveriesDecay; must be between 0 and 1");if(n.meshMessageDeliveriesWeight!==0&&n.meshMessageDeliveriesCap<=0)throw new Fe("invalid MeshMessageDeliveriesCap; must be positive");if(n.meshMessageDeliveriesWeight!==0&&n.meshMessageDeliveriesThreshold<=0)throw new Fe("invalid MeshMessageDeliveriesThreshold; must be positive");if(n.meshMessageDeliveriesWindow<0)throw new Fe("invalid MeshMessageDeliveriesWindow; must be non-negative");if(n.meshMessageDeliveriesWeight!==0&&n.meshMessageDeliveriesActivation<1e3)throw new Fe("invalid MeshMessageDeliveriesActivation; must be at least 1s");if(n.meshFailurePenaltyWeight>0)throw new Fe("invalid MeshFailurePenaltyWeight; must be negative (or 0 to disable)");if(n.meshFailurePenaltyWeight!==0&&(n.meshFailurePenaltyDecay<=0||n.meshFailurePenaltyDecay>=1))throw new Fe("invalid MeshFailurePenaltyDecay; must be between 0 and 1");if(n.invalidMessageDeliveriesWeight>0)throw new Fe("invalid InvalidMessageDeliveriesWeight; must be negative (or 0 to disable)");if(n.invalidMessageDeliveriesDecay<=0||n.invalidMessageDeliveriesDecay>=1)throw new Fe("invalid InvalidMessageDeliveriesDecay; must be between 0 and 1")}const IT={gossipThreshold:-10,publishThreshold:-50,graylistThreshold:-80,acceptPXThreshold:10,opportunisticGraftThreshold:20};function kT(n={}){return{...IT,...n}}function Wd(n,t,e=()=>!0){const r=new Set;if(t<=0)return r;for(const s of n){if(r.size>=t)break;e(s)&&(r.add(s),n.delete(s))}return r}function TT(n,t){return Wd(n,t,()=>!0)}class CT extends Map{constructor(e){super();p(this,"getDefault");this.getDefault=e}getOrDefault(e){let r=super.get(e);return r===void 0&&(r=this.getDefault(),this.set(e,r)),r}}function PT(n,t,e,r){let s=0;Object.entries(t.topics).forEach(([o,a])=>{const l=e.topics[o];if(l===void 0)return;let u=0;if(a.inMesh){let f=a.meshTime/l.timeInMeshQuantum;f>l.timeInMeshCap&&(f=l.timeInMeshCap),u+=f*l.timeInMeshWeight}let h=a.firstMessageDeliveries;if(h>l.firstMessageDeliveriesCap&&(h=l.firstMessageDeliveriesCap),u+=h*l.firstMessageDeliveriesWeight,a.meshMessageDeliveriesActive&&a.meshMessageDeliveries<l.meshMessageDeliveriesThreshold){const f=l.meshMessageDeliveriesThreshold-a.meshMessageDeliveries,g=f*f;u+=g*l.meshMessageDeliveriesWeight}const c=a.meshFailurePenalty;u+=c*l.meshFailurePenaltyWeight;const d=a.invalidMessageDeliveries*a.invalidMessageDeliveries;u+=d*l.invalidMessageDeliveriesWeight,s+=u*l.topicWeight}),e.topicScoreCap>0&&s>e.topicScoreCap&&(s=e.topicScoreCap);const i=e.appSpecificScore(n);if(s+=i*e.appSpecificWeight,t.knownIPs.forEach(o=>{if(e.IPColocationFactorWhitelist.has(o))return;const a=r.get(o),l=a!=null?a.size:0;if(l>e.IPColocationFactorThreshold){const u=l-e.IPColocationFactorThreshold,h=u*u;s+=h*e.IPColocationFactorWeight}}),t.behaviourPenalty>e.behaviourPenaltyThreshold){const o=t.behaviourPenalty-e.behaviourPenaltyThreshold,a=o*o;s+=a*e.behaviourPenaltyWeight}return s}var xu,dg;function DT(){if(dg)return xu;dg=1;function n(t,r){var r=r||{};this._capacity=r.capacity,this._head=0,this._tail=0,Array.isArray(t)?this._fromArray(t):(this._capacityMask=3,this._list=new Array(4))}return n.prototype.peekAt=function(e){var r=e;if(r===(r|0)){var s=this.size();if(!(r>=s||r<-s))return r<0&&(r+=s),r=this._head+r&this._capacityMask,this._list[r]}},n.prototype.get=function(e){return this.peekAt(e)},n.prototype.peek=function(){if(this._head!==this._tail)return this._list[this._head]},n.prototype.peekFront=function(){return this.peek()},n.prototype.peekBack=function(){return this.peekAt(-1)},Object.defineProperty(n.prototype,"length",{get:function(){return this.size()}}),n.prototype.size=function(){return this._head===this._tail?0:this._head<this._tail?this._tail-this._head:this._capacityMask+1-(this._head-this._tail)},n.prototype.unshift=function(e){if(arguments.length===0)return this.size();var r=this._list.length;return this._head=this._head-1+r&this._capacityMask,this._list[this._head]=e,this._tail===this._head&&this._growArray(),this._capacity&&this.size()>this._capacity&&this.pop(),this._head<this._tail?this._tail-this._head:this._capacityMask+1-(this._head-this._tail)},n.prototype.shift=function(){var e=this._head;if(e!==this._tail){var r=this._list[e];return this._list[e]=void 0,this._head=e+1&this._capacityMask,e<2&&this._tail>1e4&&this._tail<=this._list.length>>>2&&this._shrinkArray(),r}},n.prototype.push=function(e){if(arguments.length===0)return this.size();var r=this._tail;return this._list[r]=e,this._tail=r+1&this._capacityMask,this._tail===this._head&&this._growArray(),this._capacity&&this.size()>this._capacity&&this.shift(),this._head<this._tail?this._tail-this._head:this._capacityMask+1-(this._head-this._tail)},n.prototype.pop=function(){var e=this._tail;if(e!==this._head){var r=this._list.length;this._tail=e-1+r&this._capacityMask;var s=this._list[this._tail];return this._list[this._tail]=void 0,this._head<2&&e>1e4&&e<=r>>>2&&this._shrinkArray(),s}},n.prototype.removeOne=function(e){var r=e;if(r===(r|0)&&this._head!==this._tail){var s=this.size(),i=this._list.length;if(!(r>=s||r<-s)){r<0&&(r+=s),r=this._head+r&this._capacityMask;var o=this._list[r],a;if(e<s/2){for(a=e;a>0;a--)this._list[r]=this._list[r=r-1+i&this._capacityMask];this._list[r]=void 0,this._head=this._head+1+i&this._capacityMask}else{for(a=s-1-e;a>0;a--)this._list[r]=this._list[r=r+1+i&this._capacityMask];this._list[r]=void 0,this._tail=this._tail-1+i&this._capacityMask}return o}}},n.prototype.remove=function(e,r){var s=e,i,o=r;if(s===(s|0)&&this._head!==this._tail){var a=this.size(),l=this._list.length;if(!(s>=a||s<-a||r<1)){if(s<0&&(s+=a),r===1||!r)return i=new Array(1),i[0]=this.removeOne(s),i;if(s===0&&s+r>=a)return i=this.toArray(),this.clear(),i;s+r>a&&(r=a-s);var u;for(i=new Array(r),u=0;u<r;u++)i[u]=this._list[this._head+s+u&this._capacityMask];if(s=this._head+s&this._capacityMask,e+r===a){for(this._tail=this._tail-r+l&this._capacityMask,u=r;u>0;u--)this._list[s=s+1+l&this._capacityMask]=void 0;return i}if(e===0){for(this._head=this._head+r+l&this._capacityMask,u=r-1;u>0;u--)this._list[s=s+1+l&this._capacityMask]=void 0;return i}if(s<a/2){for(this._head=this._head+e+r+l&this._capacityMask,u=e;u>0;u--)this.unshift(this._list[s=s-1+l&this._capacityMask]);for(s=this._head-1+l&this._capacityMask;o>0;)this._list[s=s-1+l&this._capacityMask]=void 0,o--;e<0&&(this._tail=s)}else{for(this._tail=s,s=s+r+l&this._capacityMask,u=a-(r+e);u>0;u--)this.push(this._list[s++]);for(s=this._tail;o>0;)this._list[s=s+1+l&this._capacityMask]=void 0,o--}return this._head<2&&this._tail>1e4&&this._tail<=l>>>2&&this._shrinkArray(),i}}},n.prototype.splice=function(e,r){var s=e;if(s===(s|0)){var i=this.size();if(s<0&&(s+=i),!(s>i))if(arguments.length>2){var o,a,l,u=arguments.length,h=this._list.length,c=2;if(!i||s<i/2){for(a=new Array(s),o=0;o<s;o++)a[o]=this._list[this._head+o&this._capacityMask];for(r===0?(l=[],s>0&&(this._head=this._head+s+h&this._capacityMask)):(l=this.remove(s,r),this._head=this._head+s+h&this._capacityMask);u>c;)this.unshift(arguments[--u]);for(o=s;o>0;o--)this.unshift(a[o-1])}else{a=new Array(i-(s+r));var d=a.length;for(o=0;o<d;o++)a[o]=this._list[this._head+s+r+o&this._capacityMask];for(r===0?(l=[],s!=i&&(this._tail=this._head+s+h&this._capacityMask)):(l=this.remove(s,r),this._tail=this._tail-d+h&this._capacityMask);c<u;)this.push(arguments[c++]);for(o=0;o<d;o++)this.push(a[o])}return l}else return this.remove(s,r)}},n.prototype.clear=function(){this._list=new Array(this._list.length),this._head=0,this._tail=0},n.prototype.isEmpty=function(){return this._head===this._tail},n.prototype.toArray=function(){return this._copyArray(!1)},n.prototype._fromArray=function(e){var r=e.length,s=this._nextPowerOf2(r);this._list=new Array(s),this._capacityMask=s-1,this._tail=r;for(var i=0;i<r;i++)this._list[i]=e[i]},n.prototype._copyArray=function(e,r){var s=this._list,i=s.length,o=this.length;if(r=r|o,r==o&&this._head<this._tail)return this._list.slice(this._head,this._tail);var a=new Array(r),l=0,u;if(e||this._head>this._tail){for(u=this._head;u<i;u++)a[l++]=s[u];for(u=0;u<this._tail;u++)a[l++]=s[u]}else for(u=this._head;u<this._tail;u++)a[l++]=s[u];return a},n.prototype._growArray=function(){if(this._head!=0){var e=this._copyArray(!0,this._list.length<<1);this._tail=this._list.length,this._head=0,this._list=e}else this._tail=this._list.length,this._list.length<<=1;this._capacityMask=this._capacityMask<<1|1},n.prototype._shrinkArray=function(){this._list.length>>>=1,this._capacityMask>>>=1},n.prototype._nextPowerOf2=function(e){var r=Math.log(e)/Math.log(2),s=1<<r+1;return Math.max(s,4)},xu=n,xu}var MT=DT();const LT=ao(MT);var en;(function(n){n[n.unknown=0]="unknown",n[n.valid=1]="valid",n[n.invalid=2]="invalid",n[n.ignored=3]="ignored"})(en||(en={}));class BT{constructor(){p(this,"records");p(this,"queue");this.records=new Map,this.queue=new LT}getRecord(t){return this.records.get(t)}ensureRecord(t){let e=this.records.get(t);if(e!=null)return e;e={status:en.unknown,firstSeenTsMs:Date.now(),validated:0,peers:new Set},this.records.set(t,e);const r={msgId:t,expire:Date.now()+aT};return this.queue.push(r),e}gc(){const t=Date.now();let e=this.queue.peekFront();for(;e!=null&&e.expire<t;)this.records.delete(e.msgId),this.queue.shift(),e=this.queue.peekFront()}clear(){this.records.clear(),this.queue.clear()}}class NT{constructor(t,e,r,s){p(this,"params");p(this,"metrics");p(this,"peerStats",new Map);p(this,"peerIPs",new CT(()=>new Set));p(this,"scoreCache",new Map);p(this,"deliveryRecords",new BT);p(this,"_backgroundInterval");p(this,"scoreCacheValidityMs");p(this,"computeScore");p(this,"log");this.params=t,this.metrics=e,AT(t),this.scoreCacheValidityMs=s.scoreCacheValidityMs,this.computeScore=s.computeScore??PT,this.log=r.forComponent("libp2p:gossipsub:score")}get size(){return this.peerStats.size}start(){if(this._backgroundInterval!=null){this.log("Peer score already running");return}this._backgroundInterval=setInterval(()=>{this.background()},this.params.decayInterval),this.log("started")}stop(){if(this._backgroundInterval==null){this.log("Peer score already stopped");return}clearInterval(this._backgroundInterval),delete this._backgroundInterval,this.peerIPs.clear(),this.peerStats.clear(),this.deliveryRecords.clear(),this.log("stopped")}background(){this.refreshScores(),this.deliveryRecords.gc()}dumpPeerScoreStats(){return Object.fromEntries(Array.from(this.peerStats.entries()).map(([t,e])=>[t,e]))}messageFirstSeenTimestampMs(t){const e=this.deliveryRecords.getRecord(t);return e!=null?e.firstSeenTsMs:null}refreshScores(){const t=Date.now(),e=this.params.decayToZero;this.peerStats.forEach((r,s)=>{if(!r.connected){t>r.expire&&(this.removeIPsForPeer(s,r.knownIPs),this.peerStats.delete(s),this.scoreCache.delete(s));return}Object.entries(r.topics).forEach(([i,o])=>{const a=this.params.topics[i];a!==void 0&&(o.firstMessageDeliveries*=a.firstMessageDeliveriesDecay,o.firstMessageDeliveries<e&&(o.firstMessageDeliveries=0),o.meshMessageDeliveries*=a.meshMessageDeliveriesDecay,o.meshMessageDeliveries<e&&(o.meshMessageDeliveries=0),o.meshFailurePenalty*=a.meshFailurePenaltyDecay,o.meshFailurePenalty<e&&(o.meshFailurePenalty=0),o.invalidMessageDeliveries*=a.invalidMessageDeliveriesDecay,o.invalidMessageDeliveries<e&&(o.invalidMessageDeliveries=0),o.inMesh&&(o.meshTime=t-o.graftTime,o.meshTime>a.meshMessageDeliveriesActivation&&(o.meshMessageDeliveriesActive=!0)))}),r.behaviourPenalty*=this.params.behaviourPenaltyDecay,r.behaviourPenalty<e&&(r.behaviourPenalty=0)})}score(t){this.metrics?.scoreFnCalls.inc();const e=this.peerStats.get(t);if(e==null)return 0;const r=Date.now(),s=this.scoreCache.get(t);if(s!=null&&s.cacheUntil>r)return s.score;this.metrics?.scoreFnRuns.inc();const i=this.computeScore(t,e,this.params,this.peerIPs),o=r+this.scoreCacheValidityMs;return s!=null?(this.metrics?.scoreCachedDelta.observe(Math.abs(i-s.score)),s.score=i,s.cacheUntil=o):this.scoreCache.set(t,{score:i,cacheUntil:o}),i}addPenalty(t,e,r){const s=this.peerStats.get(t);s!=null&&(s.behaviourPenalty+=e,this.metrics?.onScorePenalty(r))}addPeer(t){const e={connected:!0,expire:0,topics:{},knownIPs:new Set,behaviourPenalty:0};this.peerStats.set(t,e)}addIP(t,e){const r=this.peerStats.get(t);r?.knownIPs.add(e),this.peerIPs.getOrDefault(e).add(t)}removeIP(t,e){const r=this.peerStats.get(t);r?.knownIPs.delete(e);const s=this.peerIPs.get(e);s!=null&&(s.delete(t),s.size===0&&this.peerIPs.delete(e))}removePeer(t){const e=this.peerStats.get(t);if(e!=null){if(this.score(t)>0){this.removeIPsForPeer(t,e.knownIPs),this.peerStats.delete(t);return}Object.entries(e.topics).forEach(([r,s])=>{s.firstMessageDeliveries=0;const i=this.params.topics[r].meshMessageDeliveriesThreshold;if(s.inMesh&&s.meshMessageDeliveriesActive&&s.meshMessageDeliveries<i){const o=i-s.meshMessageDeliveries;s.meshFailurePenalty+=o*o}s.inMesh=!1,s.meshMessageDeliveriesActive=!1}),e.connected=!1,e.expire=Date.now()+this.params.retainScore}}graft(t,e){const r=this.peerStats.get(t);if(r!=null){const s=this.getPtopicStats(r,e);s!=null&&(s.inMesh=!0,s.graftTime=Date.now(),s.meshTime=0,s.meshMessageDeliveriesActive=!1)}}prune(t,e){const r=this.peerStats.get(t);if(r!=null){const s=this.getPtopicStats(r,e);if(s!=null){const i=this.params.topics[e].meshMessageDeliveriesThreshold;if(s.meshMessageDeliveriesActive&&s.meshMessageDeliveries<i){const o=i-s.meshMessageDeliveries;s.meshFailurePenalty+=o*o}s.meshMessageDeliveriesActive=!1,s.inMesh=!1}}}validateMessage(t){this.deliveryRecords.ensureRecord(t)}deliverMessage(t,e,r){this.markFirstMessageDelivery(t,r);const s=this.deliveryRecords.ensureRecord(e),i=Date.now();if(s.status!==en.unknown){this.log("unexpected delivery: message from %s was first seen %s ago and has delivery status %s",t,i-s.firstSeenTsMs,en[s.status]);return}s.status=en.valid,s.validated=i,s.peers.forEach(o=>{o!==t.toString()&&this.markDuplicateMessageDelivery(o,r)})}rejectInvalidMessage(t,e){this.markInvalidMessageDelivery(t,e)}rejectMessage(t,e,r,s){switch(s){case Hn.Error:this.markInvalidMessageDelivery(t,r);return;case Hn.Blacklisted:return}const i=this.deliveryRecords.ensureRecord(e);if(i.status!==en.unknown){this.log("unexpected rejection: message from %s was first seen %s ago and has delivery status %d",t,Date.now()-i.firstSeenTsMs,en[i.status]);return}if(s===Hn.Ignore){i.status=en.ignored,i.peers.clear();return}i.status=en.invalid,this.markInvalidMessageDelivery(t,r),i.peers.forEach(o=>{this.markInvalidMessageDelivery(o,r)}),i.peers.clear()}duplicateMessage(t,e,r){const s=this.deliveryRecords.ensureRecord(e);if(!s.peers.has(t))switch(s.status){case en.unknown:s.peers.add(t);break;case en.valid:s.peers.add(t),this.markDuplicateMessageDelivery(t,r,s.validated);break;case en.invalid:this.markInvalidMessageDelivery(t,r);break;case en.ignored:break}}markInvalidMessageDelivery(t,e){const r=this.peerStats.get(t);if(r!=null){const s=this.getPtopicStats(r,e);s!=null&&(s.invalidMessageDeliveries+=1)}}markFirstMessageDelivery(t,e){const r=this.peerStats.get(t);if(r!=null){const s=this.getPtopicStats(r,e);if(s!=null){let i=this.params.topics[e].firstMessageDeliveriesCap;s.firstMessageDeliveries=Math.min(i,s.firstMessageDeliveries+1),s.inMesh&&(i=this.params.topics[e].meshMessageDeliveriesCap,s.meshMessageDeliveries=Math.min(i,s.meshMessageDeliveries+1))}}}markDuplicateMessageDelivery(t,e,r){const s=this.peerStats.get(t);if(s!=null){const i=r!==void 0?Date.now():0,o=this.getPtopicStats(s,e);if(o!=null&&o.inMesh){const a=this.params.topics[e];if(r!==void 0){const u=i-r,h=u>a.meshMessageDeliveriesWindow;if(this.metrics?.onDuplicateMsgDelivery(e,u,h),h)return}const l=a.meshMessageDeliveriesCap;o.meshMessageDeliveries=Math.min(l,o.meshMessageDeliveries+1)}}}removeIPsForPeer(t,e){for(const r of e){const s=this.peerIPs.get(r);s!=null&&(s.delete(t),s.size===0&&this.peerIPs.delete(r))}}getPtopicStats(t,e){let r=t.topics[e];return r!==void 0?r:this.params.topics[e]!==void 0?(r={inMesh:!1,graftTime:0,meshTime:0,firstMessageDeliveries:0,meshMessageDeliveries:0,meshMessageDeliveriesActive:!1,meshFailurePenalty:0,invalidMessageDeliveries:0},t.topics[e]=r,r):null}}function RT(n,t,e,r,s){let i=0;const o=new Map;if(Object.entries(t.topics).forEach(([d,f])=>{const g=s.get(d)??"unknown",y=e.topics[d];if(y===void 0)return;let m=o.get(g);m==null&&(m={p1w:0,p2w:0,p3w:0,p3bw:0,p4w:0},o.set(g,m));let v=0,_=0,w=0,S=0,A=0;if(f.inMesh){const x=Math.max(f.meshTime/y.timeInMeshQuantum,y.timeInMeshCap);v+=x*y.timeInMeshWeight}let E=f.firstMessageDeliveries;if(E>y.firstMessageDeliveriesCap&&(E=y.firstMessageDeliveriesCap),_+=E*y.firstMessageDeliveriesWeight,f.meshMessageDeliveriesActive&&f.meshMessageDeliveries<y.meshMessageDeliveriesThreshold){const x=y.meshMessageDeliveriesThreshold-f.meshMessageDeliveries,U=x*x;w+=U*y.meshMessageDeliveriesWeight}const I=f.meshFailurePenalty;S+=I*y.meshFailurePenaltyWeight;const k=f.invalidMessageDeliveries*f.invalidMessageDeliveries;A+=k*y.invalidMessageDeliveriesWeight,i+=(v+_+w+S+A)*y.topicWeight,m.p1w+=v,m.p2w+=_,m.p3w+=w,m.p3bw+=S,m.p4w+=A}),e.topicScoreCap>0&&i>e.topicScoreCap){i=e.topicScoreCap;const d=e.topicScoreCap/i;for(const f of o.values())f.p1w*=d,f.p2w*=d,f.p3w*=d,f.p3bw*=d,f.p4w*=d}let a=0,l=0,u=0;const h=e.appSpecificScore(n);a+=h*e.appSpecificWeight,t.knownIPs.forEach(d=>{if(e.IPColocationFactorWhitelist.has(d))return;const f=r.get(d),g=f!=null?f.size:0;if(g>e.IPColocationFactorThreshold){const y=g-e.IPColocationFactorThreshold,m=y*y;l+=m*e.IPColocationFactorWeight}});const c=t.behaviourPenalty*t.behaviourPenalty;return u+=c*e.behaviourPenaltyWeight,i+=a+l+u,{byTopic:o,p5w:a,p6w:l,p7w:u,score:i}}function OT(n,t,e,r,s){const i={byTopic:new Map,p5w:[],p6w:[],p7w:[],score:[]};for(const o of n){const a=t.get(o);if(a!=null){const l=RT(o,a,e,r,s);for(const[u,h]of l.byTopic){let c=i.byTopic.get(u);c==null&&(c={p1w:[],p2w:[],p3w:[],p3bw:[],p4w:[]},i.byTopic.set(u,c)),c.p1w.push(h.p1w),c.p2w.push(h.p2w),c.p3w.push(h.p3w),c.p3bw.push(h.p3bw),c.p4w.push(h.p4w)}i.p5w.push(l.p5w),i.p6w.push(l.p6w),i.p7w.push(l.p7w),i.score.push(l.score)}else i.p5w.push(0),i.p6w.push(0),i.p7w.push(0),i.score.push(0)}return i}class FT{constructor(t,e,r){p(this,"rawStream");p(this,"pushable");p(this,"closeController");p(this,"maxBufferSize");this.rawStream=t,this.pushable=ds(),this.closeController=new AbortController,this.maxBufferSize=r.maxBufferSize??1/0,this.closeController.signal.addEventListener("abort",()=>{t.close().catch(s=>{t.abort(s)})}),Br(this.pushable,this.rawStream).catch(e)}get protocol(){return this.rawStream.protocol}push(t){if(this.pushable.readableLength>this.maxBufferSize)throw Error(`OutboundStream buffer full, size > ${this.maxBufferSize}`);this.pushable.push(Pf.single(t))}pushPrefixed(t){if(this.pushable.readableLength>this.maxBufferSize)throw Error(`OutboundStream buffer full, size > ${this.maxBufferSize}`);this.pushable.push(t)}async close(){this.closeController.abort(),await this.pushable.return()}}class $T{constructor(t,e={}){p(this,"source");p(this,"rawStream");p(this,"closeController");this.rawStream=t,this.closeController=new AbortController,this.closeController.signal.addEventListener("abort",()=>{t.close().catch(r=>{t.abort(r)})}),this.source=Br(this.rawStream,r=>qd(r,e))}async close(){this.closeController.abort()}}class UT{constructor(t,e,r){p(this,"gossipsubIWantFollowupMs");p(this,"msgIdToStrFn");p(this,"metrics");p(this,"promises",new Map);p(this,"requestMsByMsg",new Map);p(this,"requestMsByMsgExpire");this.gossipsubIWantFollowupMs=t,this.msgIdToStrFn=e,this.metrics=r,this.requestMsByMsgExpire=10*t}get size(){return this.promises.size}get requestMsByMsgSize(){return this.requestMsByMsg.size}addPromise(t,e){const r=Math.floor(Math.random()*e.length),s=e[r],i=this.msgIdToStrFn(s);let o=this.promises.get(i);o==null&&(o=new Map,this.promises.set(i,o));const a=Date.now();o.has(t)||(o.set(t,a+this.gossipsubIWantFollowupMs),this.metrics!=null&&(this.metrics.iwantPromiseStarted.inc(1),this.requestMsByMsg.has(i)||this.requestMsByMsg.set(i,a)))}getBrokenPromises(){const t=Date.now(),e=new Map;let r=0;return this.promises.forEach((s,i)=>{s.forEach((o,a)=>{o<t&&(e.set(a,(e.get(a)??0)+1),s.delete(a),r++)}),s.size===0&&this.promises.delete(i)}),this.metrics?.iwantPromiseBroken.inc(r),e}deliverMessage(t,e=!1){this.trackMessage(t);const r=this.promises.get(t);r!=null&&(this.promises.delete(t),this.metrics!=null&&(this.metrics.iwantPromiseResolved.inc(1),e&&this.metrics.iwantPromiseResolvedFromDuplicate.inc(1),this.metrics.iwantPromiseResolvedPeers.inc(r.size)))}rejectMessage(t,e){switch(this.trackMessage(t),e){case Hn.Error:return}this.promises.delete(t)}clear(){this.promises.clear()}prune(){const t=Date.now()-this.requestMsByMsgExpire;let e=0;for(const[r,s]of this.requestMsByMsg.entries())if(s<t)this.requestMsByMsg.delete(r),e++;else break;this.metrics?.iwantMessagePruned.inc(e)}trackMessage(t){if(this.metrics!=null){const e=this.requestMsByMsg.get(t);e!==void 0&&(this.metrics.iwantPromiseDeliveryTime.observe((Date.now()-e)/1e3),this.requestMsByMsg.delete(t))}}}function iw(n,t,e,r){mb(n);const s=vx({dkLen:32,asyncTick:10},r),{c:i,dkLen:o,asyncTick:a}=s;if(No(i),No(o),No(a),i<1)throw new Error("PBKDF2: iterations (c) should be >= 1");const l=jo(t),u=jo(e),h=new Uint8Array(o),c=kf.create(n,l),d=c._cloneInto().update(u);return{c:i,dkLen:o,asyncTick:a,DK:h,PRF:c,PRFSalt:d}}function ow(n,t,e,r,s){return n.destroy(),t.destroy(),r&&r.destroy(),s.fill(0),e}function VT(n,t,e,r){const{c:s,dkLen:i,DK:o,PRF:a,PRFSalt:l}=iw(n,t,e,r);let u;const h=new Uint8Array(4),c=Ro(h),d=new Uint8Array(a.outputLen);for(let f=1,g=0;g<i;f++,g+=a.outputLen){const y=o.subarray(g,g+a.outputLen);c.setInt32(0,f,!1),(u=l._cloneInto(u)).update(h).digestInto(d),y.set(d.subarray(0,y.length));for(let m=1;m<s;m++){a._cloneInto(u).update(d).digestInto(d);for(let v=0;v<y.length;v++)y[v]^=d[v]}}return ow(a,l,o,u,d)}async function aw(n,t,e,r){const{c:s,dkLen:i,asyncTick:o,DK:a,PRF:l,PRFSalt:u}=iw(n,t,e,r);let h;const c=new Uint8Array(4),d=Ro(c),f=new Uint8Array(l.outputLen);for(let g=1,y=0;y<i;g++,y+=l.outputLen){const m=a.subarray(y,y+l.outputLen);d.setInt32(0,g,!1),(h=u._cloneInto(h)).update(c).digestInto(f),m.set(f.subarray(0,m.length)),await gx(s-1,o,()=>{l._cloneInto(h).update(f).digestInto(f);for(let v=0;v<m.length;v++)m[v]^=f[v]})}return ow(l,u,a,h,f)}const Eo=new Uint32Array([1732584193,4023233417,2562383102,271733878,3285377520]),Kr=new Uint32Array(80);class HT extends df{constructor(){super(64,20,8,!1),this.A=Eo[0]|0,this.B=Eo[1]|0,this.C=Eo[2]|0,this.D=Eo[3]|0,this.E=Eo[4]|0}get(){const{A:t,B:e,C:r,D:s,E:i}=this;return[t,e,r,s,i]}set(t,e,r,s,i){this.A=t|0,this.B=e|0,this.C=r|0,this.D=s|0,this.E=i|0}process(t,e){for(let l=0;l<16;l++,e+=4)Kr[l]=t.getUint32(e,!1);for(let l=16;l<80;l++)Kr[l]=du(Kr[l-3]^Kr[l-8]^Kr[l-14]^Kr[l-16],1);let{A:r,B:s,C:i,D:o,E:a}=this;for(let l=0;l<80;l++){let u,h;l<20?(u=vb(s,i,o),h=1518500249):l<40?(u=s^i^o,h=1859775393):l<60?(u=bb(s,i,o),h=2400959708):(u=s^i^o,h=3395469782);const c=du(r,5)+u+a+h+Kr[l]|0;a=o,o=i,i=du(s,30),s=r,r=c}r=r+this.A|0,s=s+this.B|0,i=i+this.C|0,o=o+this.D|0,a=a+this.E|0,this.set(r,s,i,o,a)}roundClean(){Kr.fill(0)}destroy(){this.set(0,0,0,0,0),this.buffer.fill(0)}}const zT=lf(()=>new HT),hg={sha1:zT,"sha2-256":ka,"sha2-512":Ml};function fg(n,t,e,r,s){if(s!=="sha1"&&s!=="sha2-256"&&s!=="sha2-512"){const a=Object.keys(hg).join(" / ");throw new Z(`Hash '${s}' is unknown or not supported. Must be ${a}`)}const i=hg[s],o=VT(i,n,t,{c:e,dkLen:r});return Aa.encode(o).substring(1)}const cw=te("libp2p-pubsub:");async function qT(n,t,e,r){switch(n.type){case Vi.Signing:{const s={from:n.author.toMultihash().bytes,data:r,seqno:Ui(8),topic:t,signature:void 0,key:void 0},i=bn([cw,Ds.Message.encode(s)]);s.signature=await n.privateKey.sign(i),s.key=n.key;const o={type:"signed",from:n.author,data:e,sequenceNumber:BigInt(`0x${he(s.seqno??new Uint8Array(0),"base16")}`),topic:t,signature:s.signature,key:Lr(s.key)};return{raw:s,msg:o}}case Vi.Anonymous:return{raw:{from:void 0,data:r,seqno:void 0,topic:t,signature:void 0,key:void 0},msg:{type:"unsigned",data:e,topic:t}};default:throw new Error("Unreachable")}}async function WT(n,t){switch(n){case Jh:return t.signature!=null?{valid:!1,error:Jt.SignaturePresent}:t.seqno!=null?{valid:!1,error:Jt.SeqnoPresent}:t.key!=null?{valid:!1,error:Jt.FromPresent}:{valid:!0,message:{type:"unsigned",topic:t.topic,data:t.data??new Uint8Array(0)}};case Sc:{if(t.seqno==null)return{valid:!1,error:Jt.InvalidSeqno};if(t.seqno.length!==8)return{valid:!1,error:Jt.InvalidSeqno};if(t.signature==null)return{valid:!1,error:Jt.InvalidSignature};if(t.from==null)return{valid:!1,error:Jt.InvalidPeerId};let e;try{e=Zs($r(t.from))}catch{return{valid:!1,error:Jt.InvalidPeerId}}let r;if(t.key!=null){if(r=Lr(t.key),e.publicKey!==void 0&&!r.equals(e.publicKey))return{valid:!1,error:Jt.InvalidPeerId}}else{if(e.publicKey==null)return{valid:!1,error:Jt.InvalidPeerId};r=e.publicKey}const s={from:t.from,data:t.data,seqno:t.seqno,topic:t.topic,signature:void 0,key:void 0},i=bn([cw,Ds.Message.encode(s)]);return await r.verify(i,t.signature)?{valid:!0,message:{type:"signed",from:e,data:t.data??new Uint8Array(0),sequenceNumber:BigInt(`0x${he(t.seqno,"base16")}`),topic:t.topic,signature:t.signature,key:t.key!=null?Lr(t.key):r}}:{valid:!1,error:Jt.InvalidSignature}}default:throw new Error("Unreachable")}}function Yn(n=[],t){return{subscriptions:[],messages:n,control:t!==void 0?{graft:t.graft??[],prune:t.prune??[],ihave:t.ihave??[],iwant:t.iwant??[],idontwant:t.idontwant??[]}:void 0}}function pg(n){return n.control===void 0&&(n.control={graft:[],prune:[],ihave:[],iwant:[],idontwant:[]}),n}function fr(n){if(n.length<=1)return n;const t=()=>Math.floor(Math.random()*Math.floor(n.length));for(let e=0;e<n.length;e++){const r=t(),s=n[e];n[e]=n[r],n[r]=s}return n}function GT(n){return he(n,"base64")}function KT(n,t,e){switch(n){case Sc:return{type:Vi.Signing,author:t,key:nr(e.publicKey),privateKey:e};case Jh:return{type:Vi.Anonymous};default:throw new Error(`Unknown signature policy "${n}"`)}}const YT=(n,t)=>{const e=te(t.toString(16).padStart(16,"0"),"base16"),r=nr(n),s=new Uint8Array(r.byteLength+e.length);return s.set(r,0),s.set(e,r.byteLength),s};function QT(n){if(n.type!=="signed")throw new Error("expected signed message type");if(n.sequenceNumber==null)throw Error("missing seqno field");return YT(n.from.publicKey??n.key,n.sequenceNumber)}async function jT(n){return xa.encode(n.data)}class ZT{constructor(){p(this,"index",0);p(this,"input","")}new(t){return this.index=0,this.input=t,this}readAtomically(t){const e=this.index,r=t();return r===void 0&&(this.index=e),r}parseWith(t){const e=t();if(this.index===this.input.length)return e}peekChar(){if(!(this.index>=this.input.length))return this.input[this.index]}readChar(){if(!(this.index>=this.input.length))return this.input[this.index++]}readGivenChar(t){return this.readAtomically(()=>{const e=this.readChar();if(e===t)return e})}readSeparator(t,e,r){return this.readAtomically(()=>{if(!(e>0&&this.readGivenChar(t)===void 0))return r()})}readNumber(t,e,r,s){return this.readAtomically(()=>{let i=0,o=0;const a=this.peekChar();if(a===void 0)return;const l=a==="0",u=2**(8*s)-1;for(;;){const h=this.readAtomically(()=>{const c=this.readChar();if(c===void 0)return;const d=Number.parseInt(c,t);if(!Number.isNaN(d))return d});if(h===void 0)break;if(i*=t,i+=h,i>u||(o+=1,e!==void 0&&o>e))return}if(o!==0)return!r&&l&&o>1?void 0:i})}readIPv4Addr(){return this.readAtomically(()=>{const t=new Uint8Array(4);for(let e=0;e<t.length;e++){const r=this.readSeparator(".",e,()=>this.readNumber(10,3,!1,1));if(r===void 0)return;t[e]=r}return t})}readIPv6Addr(){const t=e=>{for(let r=0;r<e.length/2;r++){const s=r*2;if(r<e.length-3){const o=this.readSeparator(":",r,()=>this.readIPv4Addr());if(o!==void 0)return e[s]=o[0],e[s+1]=o[1],e[s+2]=o[2],e[s+3]=o[3],[s+4,!0]}const i=this.readSeparator(":",r,()=>this.readNumber(16,4,!0,2));if(i===void 0)return[s,!1];e[s]=i>>8,e[s+1]=i&255}return[e.length,!1]};return this.readAtomically(()=>{const e=new Uint8Array(16),[r,s]=t(e);if(r===16)return e;if(s||this.readGivenChar(":")===void 0||this.readGivenChar(":")===void 0)return;const i=new Uint8Array(14),o=16-(r+2),[a]=t(i.subarray(0,o));return e.set(i.subarray(0,a),16-a),e})}readIPAddr(){return this.readIPv4Addr()??this.readIPv6Addr()}}const lw=45,XT=15,Hi=new ZT;function uw(n){if(!(n.length>XT))return Hi.new(n).parseWith(()=>Hi.readIPv4Addr())}function dw(n){if(n.includes("%")&&(n=n.split("%")[0]),!(n.length>lw))return Hi.new(n).parseWith(()=>Hi.readIPv6Addr())}function Nc(n,t=!1){if(n.includes("%")&&(n=n.split("%")[0]),n.length>lw)return;const e=Hi.new(n).parseWith(()=>Hi.readIPAddr());if(e)return t&&e.length===4?Uint8Array.from([0,0,0,0,0,0,0,0,0,0,255,255,e[0],e[1],e[2],e[3]]):e}function JT(n,t,e){let r=0;for(const s of n)if(!(r<t)){if(r>e)break;if(s!==255)return!1;r++}return!0}function eC(n,t,e,r){let s=0;for(const i of n)if(!(s<e)){if(s>r)break;if(i!==t[s])return!1;s++}return!0}function tC(n){switch(n.length){case ea:return n.join(".");case ta:{const t=[];for(let e=0;e<n.length;e++)e%2===0&&t.push(n[e].toString(16).padStart(2,"0")+n[e+1].toString(16).padStart(2,"0"));return t.join(":")}default:throw new Error("Invalid ip length")}}function nC(n){let t=0;for(let[e,r]of n.entries()){if(r===255){t+=8;continue}for(;(r&128)!=0;)t++,r=r<<1;if((r&128)!=0)return-1;for(let s=e+1;s<n.length;s++)if(n[s]!=0)return-1;break}return t}function rC(n){let t="0x";for(const e of n)t+=(e>>4).toString(16)+(e&15).toString(16);return t}const ea=4,ta=16,sC=new Uint8Array([0,0,0,0,0,0,0,0,0,0,255,255]);function hw(n,t){t.length===ta&&n.length===ea&&JT(t,0,11)&&(t=t.slice(12)),t.length===ea&&n.length===ta&&eC(n,sC,0,11)&&(n=n.slice(12));const e=n.length;if(e!=t.length)throw new Error("Failed to mask ip");const r=new Uint8Array(e);for(let s=0;s<e;s++)r[s]=n[s]&t[s];return r}function iC(n,t){if(typeof t=="string"&&(t=Nc(t)),t==null)throw new Error("Invalid ip");if(t.length!==n.network.length)return!1;for(let e=0;e<t.length;e++)if((n.network[e]&n.mask[e])!==(t[e]&n.mask[e]))return!1;return!0}function oC(n){const[t,e]=n.split("/");if(!t||!e)throw new Error("Failed to parse given CIDR: "+n);let r=ea,s=uw(t);if(s==null&&(r=ta,s=dw(t),s==null))throw new Error("Failed to parse given CIDR: "+n);const i=parseInt(e,10);if(Number.isNaN(i)||String(i).length!==e.length||i<0||i>r*8)throw new Error("Failed to parse given CIDR: "+n);const o=fw(i,8*r);return{network:hw(s,o),mask:o}}function fw(n,t){if(t!==8*ea&&t!==8*ta)throw new Error("Invalid CIDR mask");if(n<0||n>t)throw new Error("Invalid CIDR mask");const e=t/8,r=new Uint8Array(e);for(let s=0;s<e;s++){if(n>=8){r[s]=255,n-=8;continue}r[s]=255-(255>>n),n=0}return r}class pw{constructor(t,e){if(e==null)({network:this.network,mask:this.mask}=oC(t));else{const r=Nc(t);if(r==null)throw new Error("Failed to parse network");e=String(e);const s=parseInt(e,10);if(Number.isNaN(s)||String(s).length!==e.length||s<0||s>r.length*8){const i=Nc(e);if(i==null)throw new Error("Failed to parse mask");this.mask=i}else this.mask=fw(s,8*r.length);this.network=hw(r,this.mask)}}contains(t){return iC({network:this.network,mask:this.mask},t)}toString(){const t=nC(this.mask),e=t!==-1?String(t):rC(this.mask);return tC(this.network)+"/"+e}}function aC(n,t){return new pw(n).contains(t)}function zi(n){return!!uw(n)}function Lf(n){return!!dw(n)}function gw(n){return!!Nc(n)}const gg=zi,cC=Lf,mw=function(n){let t=0;if(n=n.toString().trim(),gg(n)){const e=new Uint8Array(t+4);return n.split(/\./g).forEach(r=>{e[t++]=parseInt(r,10)&255}),e}if(cC(n)){const e=n.split(":",8);let r;for(r=0;r<e.length;r++){const i=gg(e[r]);let o;i&&(o=mw(e[r]),e[r]=he(o.slice(0,2),"base16")),o!=null&&++r<8&&e.splice(r,0,he(o.slice(2,4),"base16"))}if(e[0]==="")for(;e.length<8;)e.unshift("0");else if(e[e.length-1]==="")for(;e.length<8;)e.push("0");else if(e.length<8){for(r=0;r<e.length&&e[r]!=="";r++);const i=[r,1];for(r=9-e.length;r>0;r--)i.push("0");e.splice.apply(e,i)}const s=new Uint8Array(t+16);for(r=0;r<e.length;r++){const i=parseInt(e[r],16);s[t++]=i>>8&255,s[t++]=i&255}return s}throw new Error("invalid ip address")},lC=function(n,t=0,e){t=~~t,e=e??n.length-t;const r=new DataView(n.buffer);if(e===4){const s=[];for(let i=0;i<e;i++)s.push(n[t+i]);return s.join(".")}if(e===16){const s=[];for(let i=0;i<e;i+=2)s.push(r.getUint16(t+i).toString(16));return s.join(":").replace(/(^|:)0(:0)*:0(:|$)/,"$1::$3").replace(/:{3,4}/,"::")}return""},dn=-1,na={},Gd={},uC=[[4,32,"ip4"],[6,16,"tcp"],[33,16,"dccp"],[41,128,"ip6"],[42,dn,"ip6zone"],[43,8,"ipcidr"],[53,dn,"dns",!0],[54,dn,"dns4",!0],[55,dn,"dns6",!0],[56,dn,"dnsaddr",!0],[132,16,"sctp"],[273,16,"udp"],[275,0,"p2p-webrtc-star"],[276,0,"p2p-webrtc-direct"],[277,0,"p2p-stardust"],[280,0,"webrtc-direct"],[281,0,"webrtc"],[290,0,"p2p-circuit"],[301,0,"udt"],[302,0,"utp"],[400,dn,"unix",!1,!0],[421,dn,"ipfs"],[421,dn,"p2p"],[443,0,"https"],[444,96,"onion"],[445,296,"onion3"],[446,dn,"garlic64"],[448,0,"tls"],[449,dn,"sni"],[460,0,"quic"],[461,0,"quic-v1"],[465,0,"webtransport"],[466,dn,"certhash"],[477,0,"ws"],[478,0,"wss"],[479,0,"p2p-websocket-star"],[480,0,"http"],[481,dn,"http-path"],[777,dn,"memory"]];uC.forEach(n=>{const t=dC(...n);Gd[t.code]=t,na[t.name]=t});function dC(n,t,e,r,s){return{code:n,size:t,name:e,resolvable:!!r,path:!!s}}function pe(n){if(typeof n=="number"){if(Gd[n]!=null)return Gd[n];throw new Error(`no protocol with code: ${n}`)}else if(typeof n=="string"){if(na[n]!=null)return na[n];throw new Error(`no protocol with name: ${n}`)}throw new Error(`invalid protocol id type: ${typeof n}`)}const hC=pe("ip4"),fC=pe("ip6"),pC=pe("ipcidr");function Bf(n,t){switch(pe(n).code){case 4:case 41:return yC(t);case 42:return Tu(t);case 43:return he(t,"base10");case 6:case 273:case 33:case 132:return yw(t).toString();case 53:case 54:case 55:case 56:case 400:case 449:case 777:return Tu(t);case 421:return _C(t);case 444:return vg(t);case 445:return vg(t);case 466:return wC(t);case 481:return globalThis.encodeURIComponent(Tu(t));default:return he(t,"base16")}}function mg(n,t){switch(pe(n).code){case 4:return yg(t);case 41:return yg(t);case 42:return ku(t);case 43:return te(t,"base10");case 6:case 273:case 33:case 132:return Nf(parseInt(t,10));case 53:case 54:case 55:case 56:case 400:case 449:case 777:return ku(t);case 421:return vC(t);case 444:return SC(t);case 445:return EC(t);case 466:return bC(t);case 481:return ku(globalThis.decodeURIComponent(t));default:return te(t,"base16")}}function gC(n){let t,e;if(n.stringTuples().forEach(([r,s])=>{(r===hC.code||r===fC.code)&&(e=s),r===pC.code&&(t=s)}),t==null||e==null)throw new Error("Invalid multiaddr");return new pw(e,t)}const Iu=Object.values(Od).map(n=>n.decoder),mC=function(){let n=Iu[0].or(Iu[1]);return Iu.slice(2).forEach(t=>n=n.or(t)),n}();function yg(n){if(!gw(n))throw new Error("invalid ip address");return mw(n)}function yC(n){const t=lC(n,0,n.length);if(t==null)throw new Error("ipBuff is required");if(!gw(t))throw new Error("invalid ip address");return t}function Nf(n){const t=new ArrayBuffer(2);return new DataView(t).setUint16(0,n),new Uint8Array(t)}function yw(n){return new DataView(n.buffer).getUint16(n.byteOffset)}function ku(n){const t=te(n),e=Uint8Array.from(Vn(t.length));return bn([e,t],e.length+t.length)}function Tu(n){const t=js(n);if(n=n.slice(ln(t)),n.length!==t)throw new Error("inconsistent lengths");return he(n)}function vC(n){let t;n[0]==="Q"||n[0]==="1"?t=$r(ot.decode(`z${n}`)).bytes:t=Qe.parse(n).multihash.bytes;const e=Uint8Array.from(Vn(t.length));return bn([e,t],e.length+t.length)}function bC(n){const t=mC.decode(n),e=Uint8Array.from(Vn(t.length));return bn([e,t],e.length+t.length)}function wC(n){const t=js(n),e=n.slice(ln(t));if(e.length!==t)throw new Error("inconsistent lengths");return"u"+he(e,"base64url")}function _C(n){const t=js(n),e=n.slice(ln(t));if(e.length!==t)throw new Error("inconsistent lengths");return he(e,"base58btc")}function SC(n){const t=n.split(":");if(t.length!==2)throw new Error(`failed to parse onion addr: ["'${t.join('", "')}'"]' does not contain a port number`);if(t[0].length!==16)throw new Error(`failed to parse onion addr: ${t[0]} not a Tor onion address.`);const e=Cr.decode("b"+t[0]),r=parseInt(t[1],10);if(r<1||r>65536)throw new Error("Port number is not in range(1, 65536)");const s=Nf(r);return bn([e,s],e.length+s.length)}function EC(n){const t=n.split(":");if(t.length!==2)throw new Error(`failed to parse onion addr: ["'${t.join('", "')}'"]' does not contain a port number`);if(t[0].length!==56)throw new Error(`failed to parse onion addr: ${t[0]} not a Tor onion3 address.`);const e=Cr.decode(`b${t[0]}`),r=parseInt(t[1],10);if(r<1||r>65536)throw new Error("Port number is not in range(1, 65536)");const s=Nf(r);return bn([e,s],e.length+s.length)}function vg(n){const t=n.slice(0,n.length-2),e=n.slice(n.length-2),r=he(t,"base32"),s=yw(e);return`${r}:${s}`}var Rc;(function(n){n[n.ip4=4]="ip4",n[n.ip6=41]="ip6"})(Rc||(Rc={}));function AC(n){for(const t of n.tuples())switch(t[0]){case Rc.ip4:case Rc.ip6:return Bf(t[0],t[1])}return null}class Cu{constructor(t){p(this,"entries",new Map);p(this,"validityMs");this.validityMs=t.validityMs}get size(){return this.entries.size}put(t,e){return this.entries.has(t)?!0:(this.entries.set(t,{value:e,validUntilMs:Date.now()+this.validityMs}),!1)}prune(){const t=Date.now();for(const[e,r]of this.entries.entries())if(r.validUntilMs<t)this.entries.delete(e);else break}has(t){return this.entries.has(t)}get(t){const e=this.entries.get(t);return e!=null&&e.validUntilMs>=Date.now()?e.value:void 0}clear(){this.entries.clear()}}var fn;(function(n){n[n.started=0]="started",n[n.stopped=1]="stopped"})(fn||(fn={}));var ty,ny,ry,sy;class vw extends(sy=ar,ry=Symbol.toStringTag,ny=Wn,ty=xc,sy){constructor(e,r={}){super();p(this,"globalSignaturePolicy");p(this,"multicodecs",[Au,Rk,og]);p(this,"publishConfig");p(this,"dataTransform");p(this,"peers",new Set);p(this,"streamsInbound",new Map);p(this,"streamsOutbound",new Map);p(this,"outboundInflightQueue",ds({objectMode:!0}));p(this,"direct",new Set);p(this,"floodsubPeers",new Set);p(this,"seenCache");p(this,"acceptFromWhitelist",new Map);p(this,"topics",new Map);p(this,"subscriptions",new Set);p(this,"mesh",new Map);p(this,"fanout",new Map);p(this,"fanoutLastpub",new Map);p(this,"gossip",new Map);p(this,"control",new Map);p(this,"peerhave",new Map);p(this,"iasked",new Map);p(this,"backoff",new Map);p(this,"outbound",new Map);p(this,"msgIdFn");p(this,"fastMsgIdFn");p(this,"msgIdToStrFn");p(this,"fastMsgIdCache");p(this,"publishedMessageIds");p(this,"mcache");p(this,"score");p(this,"topicValidators",new Map);p(this,"log");p(this,"heartbeatTicks",0);p(this,"gossipTracer");p(this,"idontwantCounts",new Map);p(this,"idontwants",new Map);p(this,"components");p(this,"directPeerInitial",null);p(this,"opts");p(this,"decodeRpcLimits");p(this,"metrics");p(this,"status",{code:fn.stopped});p(this,"maxInboundStreams");p(this,"maxOutboundStreams");p(this,"runOnLimitedConnection");p(this,"allowedTopics");p(this,"heartbeatTimer",null);p(this,ry,"@chainsafe/libp2p-gossipsub");p(this,ny,["@libp2p/pubsub"]);p(this,ty,["@libp2p/identify"]);p(this,"runHeartbeat",()=>{const e=this.metrics?.heartbeatDuration.startTimer();this.heartbeat().catch(r=>{this.log("Error running heartbeat",r)}).finally(()=>{if(e?.(),this.status.code===fn.started){clearTimeout(this.status.heartbeatTimeout);let r=this.opts.heartbeatInterval-(Date.now()-this.status.hearbeatStartMs)%this.opts.heartbeatInterval;r<this.opts.heartbeatInterval*.25&&(r+=this.opts.heartbeatInterval,this.metrics?.heartbeatSkipped.inc()),this.status.heartbeatTimeout=setTimeout(this.runHeartbeat,r)}})});p(this,"tagMeshPeer",e=>{const{peerId:r,topic:s}=e.detail;this.components.peerStore.merge(Bt(r),{tags:{[s]:{value:100}}}).catch(i=>{this.log.error("Error tagging peer %s with topic %s",r,s,i)})});p(this,"untagMeshPeer",e=>{const{peerId:r,topic:s}=e.detail;this.components.peerStore.merge(Bt(r),{tags:{[s]:void 0}}).catch(i=>{this.log.error("Error untagging peer %s with topic %s",r,s,i)})});const s={fallbackToFloodsub:!0,floodPublish:!0,batchPublish:!1,tagMeshPeers:!0,doPX:!1,directPeers:[],D:Ok,Dlo:Fk,Dhi:$k,Dscore:Uk,Dout:Vk,Dlazy:qk,heartbeatInterval:Kk,fanoutTTL:Yk,mcacheLength:Hk,mcacheGossip:zk,seenTTL:oT,gossipsubIWantFollowupMs:iT,prunePeers:Qk,pruneBackoff:jk,unsubcribeBackoff:Zk,graftFloodThreshold:rT,opportunisticGraftPeers:nT,opportunisticGraftTicks:tT,directConnectTicks:Jk,gossipFactor:Wk,idontwantMinDataSize:gT,idontwantMaxMessages:mT,...r,scoreParams:ST(r.scoreParams),scoreThresholds:kT(r.scoreThresholds)};if(this.components=e,this.decodeRpcLimits=s.decodeRpcLimits??yT,this.globalSignaturePolicy=s.globalSignaturePolicy??Sc,s.fallbackToFloodsub&&this.multicodecs.push(ig),this.log=e.logger.forComponent(s.debugName??"libp2p:gossipsub"),this.opts=s,this.direct=new Set(s.directPeers.map(i=>i.id.toString())),this.seenCache=new Cu({validityMs:s.seenTTL}),this.publishedMessageIds=new Cu({validityMs:s.seenTTL}),r.msgIdFn!=null)this.msgIdFn=r.msgIdFn;else switch(this.globalSignaturePolicy){case Sc:this.msgIdFn=QT;break;case Jh:this.msgIdFn=jT;break;default:throw new Error(`Invalid globalSignaturePolicy: ${this.globalSignaturePolicy}`)}if(r.fastMsgIdFn!=null&&(this.fastMsgIdFn=r.fastMsgIdFn,this.fastMsgIdCache=new Cu({validityMs:s.seenTTL})),this.msgIdToStrFn=r.msgIdToStrFn??GT,this.mcache=r.messageCache??new vT(s.mcacheGossip,s.mcacheLength,this.msgIdToStrFn),r.dataTransform!=null&&(this.dataTransform=r.dataTransform),r.metricsRegister!=null){if(r.metricsTopicStrToLabel==null)throw Error("Must set metricsTopicStrToLabel with metrics");const i=Math.max(...Object.values(s.scoreParams.topics).map(a=>a.meshMessageDeliveriesWindow),fT),o=bT(r.metricsRegister,r.metricsTopicStrToLabel,{gossipPromiseExpireSec:this.opts.gossipsubIWantFollowupMs/1e3,behaviourPenaltyThreshold:s.scoreParams.behaviourPenaltyThreshold,maxMeshMessageDeliveriesWindowSec:i/1e3});o.mcacheSize.addCollect(()=>{this.onScrapeMetrics(o)});for(const a of this.multicodecs)o.protocolsEnabled.set({protocol:a},1);this.metrics=o}else this.metrics=null;this.gossipTracer=new UT(this.opts.gossipsubIWantFollowupMs,this.msgIdToStrFn,this.metrics),this.score=new NT(this.opts.scoreParams,this.metrics,this.components.logger,{scoreCacheValidityMs:s.heartbeatInterval}),this.maxInboundStreams=r.maxInboundStreams,this.maxOutboundStreams=r.maxOutboundStreams,this.runOnLimitedConnection=r.runOnLimitedConnection,this.allowedTopics=s.allowedTopics!=null?new Set(s.allowedTopics):null}getPeers(){return[...this.peers.keys()].map(e=>Bt(e))}isStarted(){return this.status.code===fn.started}async start(){if(this.isStarted())return;this.log("starting"),this.publishConfig=KT(this.globalSignaturePolicy,this.components.peerId,this.components.privateKey),this.outboundInflightQueue=ds({objectMode:!0}),Br(this.outboundInflightQueue,async o=>{for await(const{peerId:a,connection:l}of o)await this.createOutboundStream(a,l)}).catch(o=>{this.log.error("outbound inflight queue error",o)}),await Promise.all(this.opts.directPeers.map(async o=>{await this.components.peerStore.merge(o.id,{multiaddrs:o.addrs})}));const e=this.components.registrar;await Promise.all(this.multicodecs.map(async o=>e.handle(o,this.onIncomingStream.bind(this),{maxInboundStreams:this.maxInboundStreams,maxOutboundStreams:this.maxOutboundStreams,runOnLimitedConnection:this.runOnLimitedConnection})));const r={onConnect:this.onPeerConnected.bind(this),onDisconnect:this.onPeerDisconnected.bind(this),notifyOnLimitedConnection:this.runOnLimitedConnection},s=await Promise.all(this.multicodecs.map(async o=>e.register(o,r))),i=setTimeout(this.runHeartbeat,ag);this.status={code:fn.started,registrarTopologyIds:s,heartbeatTimeout:i,hearbeatStartMs:Date.now()+ag},this.score.start(),this.directPeerInitial=setTimeout(()=>{Promise.resolve().then(async()=>{await Promise.all(Array.from(this.direct).map(async o=>this.connect(o)))}).catch(o=>{this.log(o)})},eT),this.opts.tagMeshPeers&&(this.addEventListener("gossipsub:graft",this.tagMeshPeer),this.addEventListener("gossipsub:prune",this.untagMeshPeer)),this.log("started")}async stop(){if(this.log("stopping"),this.status.code!==fn.started)return;const{registrarTopologyIds:e}=this.status;this.status={code:fn.stopped},this.opts.tagMeshPeers&&(this.removeEventListener("gossipsub:graft",this.tagMeshPeer),this.removeEventListener("gossipsub:prune",this.untagMeshPeer));const r=this.components.registrar;await Promise.all(this.multicodecs.map(async i=>r.unhandle(i))),e.forEach(i=>{r.unregister(i)}),this.outboundInflightQueue.end();const s=[];for(const i of this.streamsOutbound.values())s.push(i.close());this.streamsOutbound.clear();for(const i of this.streamsInbound.values())s.push(i.close());this.streamsInbound.clear(),await Promise.all(s),this.peers.clear(),this.subscriptions.clear(),this.heartbeatTimer!=null&&(this.heartbeatTimer.cancel(),this.heartbeatTimer=null),this.score.stop(),this.mesh.clear(),this.fanout.clear(),this.fanoutLastpub.clear(),this.gossip.clear(),this.control.clear(),this.peerhave.clear(),this.iasked.clear(),this.backoff.clear(),this.outbound.clear(),this.gossipTracer.clear(),this.seenCache.clear(),this.fastMsgIdCache!=null&&this.fastMsgIdCache.clear(),this.directPeerInitial!=null&&clearTimeout(this.directPeerInitial),this.idontwantCounts.clear(),this.idontwants.clear(),this.log("stopped")}dumpPeerScoreStats(){return this.score.dumpPeerScoreStats()}onIncomingStream({stream:e,connection:r}){if(!this.isStarted())return;const s=r.remotePeer;this.addPeer(s,r.direction,r.remoteAddr),this.createInboundStream(s,e),this.outboundInflightQueue.push({peerId:s,connection:r})}onPeerConnected(e,r){this.metrics?.newConnectionCount.inc({status:r.status}),!(!this.isStarted()||r.status!=="open")&&(this.addPeer(e,r.direction,r.remoteAddr),this.outboundInflightQueue.push({peerId:e,connection:r}))}onPeerDisconnected(e){this.log("connection ended %p",e),this.removePeer(e)}async createOutboundStream(e,r){if(!this.isStarted())return;const s=e.toString();if(this.peers.has(s)&&!this.streamsOutbound.has(s))try{const i=new FT(await r.newStream(this.multicodecs,{runOnLimitedConnection:this.runOnLimitedConnection}),a=>{this.log.error("outbound pipe error",a)},{maxBufferSize:this.opts.maxOutboundBufferSize});this.log("create outbound stream %p",e),this.streamsOutbound.set(s,i);const o=i.protocol;o===ig&&this.floodsubPeers.add(s),this.metrics?.peersPerProtocol.inc({protocol:o},1),this.subscriptions.size>0&&(this.log("send subscriptions to",s),this.sendSubscriptions(s,Array.from(this.subscriptions),!0))}catch(i){this.log.error("createOutboundStream error",i)}}createInboundStream(e,r){if(!this.isStarted())return;const s=e.toString();if(!this.peers.has(s))return;const i=this.streamsInbound.get(s);i!==void 0&&(this.log("replacing existing inbound steam %s",s),i.close().catch(a=>{this.log.error(a)})),this.log("create inbound stream %s",s);const o=new $T(r,{maxDataLength:this.opts.maxInboundDataLength});this.streamsInbound.set(s,o),this.pipePeerReadStream(e,o.source).catch(a=>{this.log(a)})}addPeer(e,r,s){const i=e.toString();if(!this.peers.has(i)){this.log("new peer %p",e),this.peers.add(i),this.score.addPeer(i);const o=AC(s);o!==null?this.score.addIP(i,o):this.log("Added peer has no IP in current address %s %s",i,s.toString()),this.outbound.has(i)||this.outbound.set(i,r==="outbound")}}removePeer(e){const r=e.toString();if(!this.peers.has(r))return;this.log("delete peer %p",e),this.peers.delete(r);const s=this.streamsOutbound.get(r),i=this.streamsInbound.get(r);s!=null&&this.metrics?.peersPerProtocol.inc({protocol:s.protocol},-1),s?.close().catch(o=>{this.log.error(o)}),i?.close().catch(o=>{this.log.error(o)}),this.streamsOutbound.delete(r),this.streamsInbound.delete(r);for(const o of this.topics.values())o.delete(r);for(const[o,a]of this.mesh)a.delete(r)&&this.metrics?.onRemoveFromMesh(o,Jn.Dc,1);for(const o of this.fanout.values())o.delete(r);this.floodsubPeers.delete(r),this.gossip.delete(r),this.control.delete(r),this.outbound.delete(r),this.idontwantCounts.delete(r),this.idontwants.delete(r),this.score.removePeer(r),this.acceptFromWhitelist.delete(r)}get started(){return this.status.code===fn.started}getMeshPeers(e){const r=this.mesh.get(e);return r!=null?Array.from(r):[]}getSubscribers(e){const r=this.topics.get(e);return(r!=null?Array.from(r):[]).map(s=>Bt(s))}getTopics(){return Array.from(this.subscriptions)}async pipePeerReadStream(e,r){try{await Br(r,async s=>{for await(const i of s)try{const o=i.subarray(),a=Ds.decode(o,{limits:{subscriptions:this.decodeRpcLimits.maxSubscriptions,messages:this.decodeRpcLimits.maxMessages,control$:{ihave:this.decodeRpcLimits.maxIhaveMessageIDs,iwant:this.decodeRpcLimits.maxIwantMessageIDs,graft:this.decodeRpcLimits.maxControlMessages,prune:this.decodeRpcLimits.maxControlMessages,prune$:{peers:this.decodeRpcLimits.maxPeerInfos},idontwant:this.decodeRpcLimits.maxControlMessages,idontwant$:{messageIDs:this.decodeRpcLimits.maxIdontwantMessageIDs}}}});if(this.metrics?.onRpcRecv(a,o.length),this.opts.awaitRpcHandler)try{await this.handleReceivedRpc(e,a)}catch(l){this.metrics?.onRpcRecvError(),this.log(l)}else this.handleReceivedRpc(e,a).catch(l=>{this.metrics?.onRpcRecvError(),this.log(l)})}catch(o){this.metrics?.onRpcDataError(),this.log(o)}})}catch(s){this.metrics?.onPeerReadStreamError(),this.handlePeerReadStreamError(s,e)}}handlePeerReadStreamError(e,r){this.log.error(e),this.onPeerDisconnected(r)}async handleReceivedRpc(e,r){if(!this.acceptFrom(e.toString())){this.log("received message from unacceptable peer %p",e),this.metrics?.rpcRecvNotAccepted.inc();return}const s=r.subscriptions!=null?r.subscriptions.length:0,i=r.messages!=null?r.messages.length:0;let o=0,a=0,l=0,u=0;if(r.control!=null&&(r.control.ihave!=null&&(o=r.control.ihave.length),r.control.iwant!=null&&(a=r.control.iwant.length),r.control.graft!=null&&(l=r.control.graft.length),r.control.prune!=null&&(u=r.control.prune.length)),this.log(`rpc.from ${e.toString()} subscriptions ${s} messages ${i} ihave ${o} iwant ${a} graft ${l} prune ${u}`),r.subscriptions!=null&&r.subscriptions.length>0){const h=[];r.subscriptions.forEach(c=>{const d=c.topic,f=c.subscribe===!0;if(d!=null){if(this.allowedTopics!=null&&!this.allowedTopics.has(d))return;this.handleReceivedSubscription(e,d,f),h.push({topic:d,subscribe:f})}}),this.safeDispatchEvent("subscription-change",{detail:{peerId:e,subscriptions:h}})}for(const h of r.messages){if(this.allowedTopics!=null&&!this.allowedTopics.has(h.topic))continue;const c=this.handleReceivedMessage(e,h).catch(d=>{this.metrics?.onMsgRecvError(h.topic),this.log(d)});this.opts.awaitRpcMessageHandler&&await c}r.control!=null&&await this.handleControlMessage(e.toString(),r.control)}handleReceivedSubscription(e,r,s){this.log("subscription update from %p topic %s",e,r);let i=this.topics.get(r);i==null&&(i=new Set,this.topics.set(r,i)),s?i.add(e.toString()):i.delete(e.toString())}async handleReceivedMessage(e,r){this.metrics?.onMsgRecvPreValidation(r.topic);const s=await this.validateReceivedMessage(e,r);this.metrics?.onPrevalidationResult(r.topic,s.code);const i=s.code;switch(i){case tn.duplicate:this.score.duplicateMessage(e.toString(),s.msgIdStr,r.topic),this.gossipTracer.deliverMessage(s.msgIdStr,!0),this.mcache.observeDuplicate(s.msgIdStr,e.toString());return;case tn.invalid:if(s.msgIdStr!=null){const o=s.msgIdStr;this.score.rejectMessage(e.toString(),o,r.topic,s.reason),this.gossipTracer.rejectMessage(o,s.reason)}else this.score.rejectInvalidMessage(e.toString(),r.topic);this.metrics?.onMsgRecvInvalid(r.topic,s);return;case tn.valid:this.score.validateMessage(s.messageId.msgIdStr),this.gossipTracer.deliverMessage(s.messageId.msgIdStr),this.mcache.put(s.messageId,r,!this.opts.asyncValidation),this.subscriptions.has(r.topic)&&(!this.components.peerId.equals(e)||this.opts.emitSelf)&&(super.dispatchEvent(new CustomEvent("gossipsub:message",{detail:{propagationSource:e,msgId:s.messageId.msgIdStr,msg:s.msg}})),super.dispatchEvent(new CustomEvent("message",{detail:s.msg}))),this.opts.asyncValidation||this.forwardMessage(s.messageId.msgIdStr,r,e.toString());break;default:throw new Error(`Invalid validation result: ${i}`)}}async validateReceivedMessage(e,r){const s=this.fastMsgIdFn?.(r),i=s!==void 0?this.fastMsgIdCache?.get(s):void 0;if(i!=null)return{code:tn.duplicate,msgIdStr:i};const o=await WT(this.globalSignaturePolicy,r);if(!o.valid)return{code:tn.invalid,reason:Hn.Error,error:o.error};const a=o.message;try{this.dataTransform!=null&&(a.data=this.dataTransform.inboundTransform(r.topic,a.data))}catch(d){return this.log("Invalid message, transform failed",d),{code:tn.invalid,reason:Hn.Error,error:Jt.TransformFailed}}const l=await this.msgIdFn(a),u=this.msgIdToStrFn(l),h={msgId:l,msgIdStr:u};if(s!==void 0&&this.fastMsgIdCache!=null&&this.fastMsgIdCache.put(s,u)&&this.metrics?.fastMsgIdCacheCollision.inc(),this.seenCache.has(u))return{code:tn.duplicate,msgIdStr:u};this.seenCache.put(u),(r.data?.length??0)>=this.opts.idontwantMinDataSize&&this.sendIDontWants(l,r.topic,e.toString());const c=this.topicValidators.get(r.topic);if(c!=null){let d;try{d=await c(e,a)}catch(f){const g=f.code;g===lT&&(d=Cn.Ignore),g===cT?d=Cn.Reject:d=Cn.Ignore}if(d!==Cn.Accept)return{code:tn.invalid,reason:lg(d),msgIdStr:u}}return{code:tn.valid,messageId:h,msg:a}}getScore(e){return this.score.score(e)}sendSubscriptions(e,r,s){this.sendRpc(e,{subscriptions:r.map(i=>({topic:i,subscribe:s})),messages:[]})}async handleControlMessage(e,r){if(r===void 0)return;const s=r.ihave?.length>0?this.handleIHave(e,r.ihave):[],i=r.iwant?.length>0?this.handleIWant(e,r.iwant):[],o=r.graft?.length>0?await this.handleGraft(e,r.graft):[];if(r.prune?.length>0&&await this.handlePrune(e,r.prune),r.idontwant?.length>0&&this.handleIdontwant(e,r.idontwant),s.length===0&&i.length===0&&o.length===0)return;const a=this.sendRpc(e,Yn(i,{iwant:s,prune:o})),l=s[0]?.messageIDs;l!=null&&(a?this.gossipTracer.addPromise(e,l):this.metrics?.iwantPromiseUntracked.inc(1))}acceptFrom(e){if(this.direct.has(e))return!0;const r=Date.now(),s=this.acceptFromWhitelist.get(e);if(s!=null&&s.messagesAccepted<dT&&s.acceptUntil>=r)return s.messagesAccepted+=1,!0;const i=this.score.score(e);return i>=uT?this.acceptFromWhitelist.set(e,{messagesAccepted:0,acceptUntil:r+hT}):this.acceptFromWhitelist.delete(e),i>=this.opts.scoreThresholds.graylistThreshold}handleIHave(e,r){if(r.length===0)return[];const s=this.score.score(e);if(s<this.opts.scoreThresholds.gossipThreshold)return this.log("IHAVE: ignoring peer %s with score below threshold [ score = %d ]",e,s),this.metrics?.ihaveRcvIgnored.inc({reason:Fo.LowScore}),[];const i=(this.peerhave.get(e)??0)+1;if(this.peerhave.set(e,i),i>sT)return this.log("IHAVE: peer %s has advertised too many times (%d) within this heartbeat interval; ignoring",e,i),this.metrics?.ihaveRcvIgnored.inc({reason:Fo.MaxIhave}),[];const o=this.iasked.get(e)??0;if(o>=ai)return this.log("IHAVE: peer %s has already advertised too many messages (%d); ignoring",e,o),this.metrics?.ihaveRcvIgnored.inc({reason:Fo.MaxIasked}),[];const a=new Map;if(r.forEach(({topicID:h,messageIDs:c})=>{if(h==null||c==null||!this.mesh.has(h))return;let d=0;c.forEach(f=>{const g=this.msgIdToStrFn(f);this.seenCache.has(g)||(a.set(g,f),d++)}),this.metrics?.onIhaveRcv(h,c.length,d)}),a.size===0)return[];let l=a.size;l+o>ai&&(l=ai-o),this.log("IHAVE: Asking for %d out of %d messages from %s",l,a.size,e);let u=Array.from(a.values());return fr(u),u=u.slice(0,l),this.iasked.set(e,o+l),[{messageIDs:u}]}handleIWant(e,r){if(r.length===0)return[];const s=this.score.score(e);if(s<this.opts.scoreThresholds.gossipThreshold)return this.log("IWANT: ignoring peer %s with score below threshold [score = %d]",e,s),[];const i=new Map,o=new Map;let a=0;return r.forEach(({messageIDs:l})=>{l?.forEach(u=>{const h=this.msgIdToStrFn(u),c=this.mcache.getWithIWantCount(h,e);if(c==null){a++;return}if(o.set(c.msg.topic,1+(o.get(c.msg.topic)??0)),c.count>Gk){this.log("IWANT: Peer %s has asked for message %s too many times: ignoring request",e,u);return}i.set(h,c.msg)})}),this.metrics?.onIwantRcv(o,a),i.size===0?(this.log("IWANT: Could not provide any wanted messages to %s",e),[]):(this.log("IWANT: Sending %d messages to %s",i.size,e),Array.from(i.values()))}async handleGraft(e,r){const s=[],i=this.score.score(e),o=Date.now();let a=this.opts.doPX;if(r.forEach(({topicID:u})=>{if(u==null)return;const h=this.mesh.get(u);if(h==null){a=!1;return}if(h.has(e))return;const c=this.backoff.get(u)?.get(e);if(this.direct.has(e))this.log("GRAFT: ignoring request from direct peer %s",e),s.push(u),a=!1;else if(typeof c=="number"&&o<c){this.log("GRAFT: ignoring backed off peer %s",e),this.score.addPenalty(e,1,Oo.GraftBackoff),a=!1;const d=c+this.opts.graftFloodThreshold-this.opts.pruneBackoff;o<d&&this.score.addPenalty(e,1,Oo.GraftBackoff),this.addBackoff(e,u),s.push(u)}else i<0?(this.log("GRAFT: ignoring peer %s with negative score: score=%d, topic=%s",e,i,u),s.push(u),a=!1,this.addBackoff(e,u)):h.size>=this.opts.Dhi&&!(this.outbound.get(e)??!1)?(s.push(u),this.addBackoff(e,u)):(this.log("GRAFT: Add mesh link from %s in %s",e,u),this.score.graft(e,u),h.add(e),this.metrics?.onAddToMesh(u,rn.Subscribed,1));this.safeDispatchEvent("gossipsub:graft",{detail:{peerId:e,topic:u,direction:"inbound"}})}),s.length===0)return[];const l=!1;return Promise.all(s.map(async u=>this.makePrune(e,u,a,l)))}async handlePrune(e,r){const s=this.score.score(e);for(const{topicID:i,backoff:o,peers:a}of r){if(i==null)continue;const l=this.mesh.get(i);if(l==null)return;this.log("PRUNE: Remove mesh link to %s in %s",e,i),this.score.prune(e,i),l.has(e)&&(l.delete(e),this.metrics?.onRemoveFromMesh(i,Jn.Prune,1)),typeof o=="number"&&o>0?this.doAddBackoff(e,i,o*1e3):this.addBackoff(e,i),a!=null&&a.length>0&&(s<this.opts.scoreThresholds.acceptPXThreshold?this.log("PRUNE: ignoring PX from peer %s with insufficient score [score = %d, topic = %s]",e,s,i):await this.pxConnect(a)),this.safeDispatchEvent("gossipsub:prune",{detail:{peerId:e,topic:i,direction:"inbound"}})}}handleIdontwant(e,r){let s=this.idontwantCounts.get(e)??0;if(s>=this.opts.idontwantMaxMessages)return;const i=s;let o=this.idontwants.get(e);o==null&&(o=new Map,this.idontwants.set(e,o));let a=0;e:for(const{messageIDs:u}of r)for(const h of u){if(s>=this.opts.idontwantMaxMessages)break e;s++;const c=this.msgIdToStrFn(h);o.set(c,this.heartbeatTicks),this.mcache.msgs.has(c)||a++}this.idontwantCounts.set(e,s);const l=s-i;this.metrics?.onIdontwantRcv(l,a)}addBackoff(e,r){this.doAddBackoff(e,r,this.opts.pruneBackoff)}doAddBackoff(e,r,s){let i=this.backoff.get(r);i==null&&(i=new Map,this.backoff.set(r,i));const o=Date.now()+s;(i.get(e)??0)<o&&i.set(e,o)}applyIwantPenalties(){this.gossipTracer.getBrokenPromises().forEach((e,r)=>{this.log("peer %s didn't follow up in %d IWANT requests; adding penalty",r,e),this.score.addPenalty(r,e,Oo.BrokenPromise)})}clearBackoff(){if(this.heartbeatTicks%Xk!==0)return;const e=Date.now();this.backoff.forEach((r,s)=>{r.forEach((i,o)=>{i+pT*this.opts.heartbeatInterval<e&&r.delete(o)}),r.size===0&&this.backoff.delete(s)})}async directConnect(){const e=[];this.direct.forEach(r=>{this.streamsOutbound.has(r)||e.push(r)}),await Promise.all(e.map(async r=>this.connect(r)))}async pxConnect(e){e.length>this.opts.prunePeers&&(fr(e),e=e.slice(0,this.opts.prunePeers));const r=[];await Promise.all(e.map(async s=>{if(s.peerID==null)return;const i=Zs($r(s.peerID)),o=i.toString();if(!this.peers.has(o)){if(s.signedPeerRecord==null){r.push(o);return}try{if(!await this.components.peerStore.consumePeerRecord(s.signedPeerRecord,i)){this.log("bogus peer record obtained through px: could not add peer record to address book");return}r.push(o)}catch{this.log("bogus peer record obtained through px: invalid signature or not a peer record")}}})),r.length!==0&&await Promise.all(r.map(async s=>this.connect(s)))}async connect(e){this.log("Initiating connection with %s",e);const r=Bt(e),s=await this.components.connectionManager.openConnection(r);for(const i of this.multicodecs)for(const o of this.components.registrar.getTopologies(i))o.onConnect?.(r,s)}subscribe(e){if(this.status.code!==fn.started)throw new Error("Pubsub has not started");if(!this.subscriptions.has(e)){this.subscriptions.add(e);for(const r of this.peers.keys())this.sendSubscriptions(r,[e],!0)}this.join(e)}unsubscribe(e){if(this.status.code!==fn.started)throw new Error("Pubsub is not started");const r=this.subscriptions.delete(e);if(this.log("unsubscribe from %s - am subscribed %s",e,r),r)for(const s of this.peers.keys())this.sendSubscriptions(s,[e],!1);this.leave(e)}join(e){if(this.status.code!==fn.started)throw new Error("Gossipsub has not started");if(this.mesh.has(e))return;this.log("JOIN %s",e),this.metrics?.onJoin(e);const r=new Set,s=this.backoff.get(e),i=this.fanout.get(e);if(i!=null&&(this.fanout.delete(e),this.fanoutLastpub.delete(e),i.forEach(o=>{!this.direct.has(o)&&this.score.score(o)>=0&&s?.has(o)!==!0&&r.add(o)}),this.metrics?.onAddToMesh(e,rn.Fanout,r.size)),r.size<this.opts.D){const o=r.size;this.getRandomGossipPeers(e,this.opts.D,l=>!r.has(l)&&!this.direct.has(l)&&this.score.score(l)>=0&&s?.has(l)!==!0).forEach(l=>{r.add(l)}),this.metrics?.onAddToMesh(e,rn.Random,r.size-o)}this.mesh.set(e,r),r.forEach(o=>{this.log("JOIN: Add mesh link to %s in %s",o,e),this.sendGraft(o,e)})}leave(e){if(this.status.code!==fn.started)throw new Error("Gossipsub has not started");this.log("LEAVE %s",e),this.metrics?.onLeave(e);const r=this.mesh.get(e);r!=null&&(Promise.all(Array.from(r).map(async s=>{this.log("LEAVE: Remove mesh link to %s in %s",s,e),await this.sendPrune(s,e)})).catch(s=>{this.log("Error sending prunes to mesh peers",s)}),this.mesh.delete(e))}selectPeersToForward(e,r,s){const i=new Set,o=this.topics.get(e);o!=null&&(this.direct.forEach(l=>{o.has(l)&&r!==l&&!(s?.has(l)??!1)&&i.add(l)}),this.floodsubPeers.forEach(l=>{o.has(l)&&r!==l&&!(s?.has(l)??!1)&&this.score.score(l)>=this.opts.scoreThresholds.publishThreshold&&i.add(l)}));const a=this.mesh.get(e);return a!=null&&a.size>0&&a.forEach(l=>{r!==l&&!(s?.has(l)??!1)&&i.add(l)}),i}selectPeersToPublish(e){const r=new Set,s={direct:0,floodsub:0,mesh:0,fanout:0},i=this.topics.get(e);if(i!=null)if(this.opts.floodPublish)i.forEach(o=>{this.direct.has(o)?(r.add(o),s.direct++):this.score.score(o)>=this.opts.scoreThresholds.publishThreshold&&(r.add(o),s.floodsub++)});else{this.direct.forEach(a=>{i.has(a)&&(r.add(a),s.direct++)}),this.floodsubPeers.forEach(a=>{i.has(a)&&this.score.score(a)>=this.opts.scoreThresholds.publishThreshold&&(r.add(a),s.floodsub++)});const o=this.mesh.get(e);if(o!=null&&o.size>0)o.forEach(a=>{r.add(a),s.mesh++}),o.size<this.opts.D&&this.getRandomGossipPeers(e,this.opts.D-o.size,l=>!o.has(l)&&!this.direct.has(l)&&!this.floodsubPeers.has(l)&&this.score.score(l)>=this.opts.scoreThresholds.publishThreshold).forEach(l=>{r.add(l),s.mesh++});else{const a=this.fanout.get(e);if(a!=null&&a.size>0)a.forEach(l=>{r.add(l),s.fanout++});else{const l=this.getRandomGossipPeers(e,this.opts.D,u=>this.score.score(u)>=this.opts.scoreThresholds.publishThreshold);l.size>0&&(this.fanout.set(e,l),l.forEach(u=>{r.add(u),s.fanout++}))}this.fanoutLastpub.set(e,Date.now())}}return{tosend:r,tosendCount:s}}forwardMessage(e,r,s,i){s!=null&&this.score.deliverMessage(s,e,r.topic);const o=this.selectPeersToForward(r.topic,s,i);o.forEach(a=>{this.sendRpc(a,Yn([r]))}),this.metrics?.onForwardMsg(r.topic,o.size)}async publish(e,r,s){const i=Date.now(),o=this.dataTransform!=null?this.dataTransform.outboundTransform(e,r):r;if(this.publishConfig==null)throw Error("PublishError.Uninitialized");const{raw:a,msg:l}=await qT(this.publishConfig,e,r,o),u=await this.msgIdFn(l),h=this.msgIdToStrFn(u),c=s?.ignoreDuplicatePublishError??this.opts.ignoreDuplicatePublishError;if(this.seenCache.has(h)){if(c)return this.metrics?.onPublishDuplicateMsg(e),{recipients:[]};throw Error("PublishError.Duplicate")}const{tosend:d,tosendCount:f}=this.selectPeersToPublish(e),g=this.opts.emitSelf&&this.subscriptions.has(e),y=s?.allowPublishToZeroTopicPeers??this.opts.allowPublishToZeroTopicPeers;if(d.size===0&&!y&&!g)throw Error("PublishError.NoPeersSubscribedToTopic");this.seenCache.put(h),this.mcache.put({msgId:u,msgIdStr:h},a,!0),this.publishedMessageIds.put(h);const m=s?.batchPublish??this.opts.batchPublish,v=Yn([a]);if(m)this.sendRpcInBatch(d,v);else for(const w of d)this.sendRpc(w,v)||d.delete(w);const _=Date.now()-i;return this.metrics?.onPublishMsg(e,f,d.size,a.data!=null?a.data.length:0,_),g&&(d.add(this.components.peerId.toString()),super.dispatchEvent(new CustomEvent("gossipsub:message",{detail:{propagationSource:this.components.peerId,msgId:h,msg:l}})),super.dispatchEvent(new CustomEvent("message",{detail:l}))),{recipients:Array.from(d.values()).map(w=>Bt(w))}}sendRpcInBatch(e,r){const s=Ds.encode(r),i=Pf.single(s);for(const o of e){const a=this.streamsOutbound.get(o);if(a==null){this.log(`Cannot send RPC to ${o} as there is no open stream to it available`),e.delete(o);continue}try{a.pushPrefixed(i)}catch(l){e.delete(o),this.log.error(`Cannot send rpc to ${o}`,l)}this.metrics?.onRpcSent(r,s.length)}}reportMessageValidationResult(e,r,s){let i;if(s===Cn.Accept){if(i=this.mcache.validate(e),i!=null){const{message:a,originatingPeers:l}=i;this.score.deliverMessage(r,e,a.topic),this.forwardMessage(e,i.message,r,l)}}else if(i=this.mcache.remove(e),i!=null){const a=lg(s),{message:l,originatingPeers:u}=i;this.score.rejectMessage(r,e,l.topic,a);for(const h of u)this.score.rejectMessage(h,e,l.topic,a)}const o=this.score.messageFirstSeenTimestampMs(e);this.metrics?.onReportValidation(i,s,o)}sendGraft(e,r){const i=Yn([],{graft:[{topicID:r}]});this.sendRpc(e,i)}async sendPrune(e,r){const i=[await this.makePrune(e,r,this.opts.doPX,!0)],o=Yn([],{prune:i});this.sendRpc(e,o)}sendIDontWants(e,r,s){const i=this.mesh.get(r);if(i==null)return;const o=new Set(i);o.delete(s);for(const l of o)this.streamsOutbound.get(l)?.protocol!==Au&&o.delete(l);const a=Yn([],{idontwant:[{messageIDs:[e]}]});this.sendRpcInBatch(o,a)}sendRpc(e,r){const s=this.streamsOutbound.get(e);if(s==null)return this.log(`Cannot send RPC to ${e} as there is no open stream to it available`),!1;const i=this.control.get(e);i!=null&&(this.piggybackControl(e,r,i),this.control.delete(e));const o=this.gossip.get(e);o!=null&&(this.piggybackGossip(e,r,o),this.gossip.delete(e));const a=Ds.encode(r);try{s.push(a)}catch(l){return this.log.error(`Cannot send rpc to ${e}`,l),i!=null&&this.control.set(e,i),o!=null&&this.gossip.set(e,o),!1}if(this.metrics?.onRpcSent(r,a.length),r.control?.graft!=null)for(const l of r.control?.graft)l.topicID!=null&&this.safeDispatchEvent("gossipsub:graft",{detail:{peerId:e,topic:l.topicID,direction:"outbound"}});if(r.control?.prune!=null)for(const l of r.control?.prune)l.topicID!=null&&this.safeDispatchEvent("gossipsub:prune",{detail:{peerId:e,topic:l.topicID,direction:"outbound"}});return!0}piggybackControl(e,r,s){const i=pg(r);for(const o of s.graft)o.topicID!=null&&(this.mesh.get(o.topicID)?.has(e)??!1)&&i.control.graft.push(o);for(const o of s.prune)o.topicID!=null&&!(this.mesh.get(o.topicID)?.has(e)??!1)&&i.control.prune.push(o)}piggybackGossip(e,r,s){const i=pg(r);i.control.ihave=s}async sendGraftPrune(e,r,s){const i=this.opts.doPX,o=!1;for(const[a,l]of e){const u=l.map(d=>({topicID:d}));let h=[];const c=r.get(a);c!=null&&(h=await Promise.all(c.map(async d=>this.makePrune(a,d,i&&!(s.get(a)??!1),o))),r.delete(a)),this.sendRpc(a,Yn([],{graft:u,prune:h}))}for(const[a,l]of r){const u=await Promise.all(l.map(async h=>this.makePrune(a,h,i&&!(s.get(a)??!1),o)));this.sendRpc(a,Yn([],{prune:u}))}}emitGossip(e){const r=this.mcache.getGossipIDs(new Set(e.keys()));for(const[s,i]of e)this.doEmitGossip(s,i,r.get(s)??[])}doEmitGossip(e,r,s){if(s.length===0||(fr(s),s.length>ai&&this.log("too many messages for gossip; will truncate IHAVE list (%d messages)",s.length),r.size===0))return;let i=this.opts.Dlazy;const a=this.opts.gossipFactor*r.size;let l=r;a>i&&(i=a),i>l.size?i=l.size:l=fr(Array.from(l)).slice(0,i),l.forEach(u=>{let h=s;s.length>ai&&(h=fr(h.slice()).slice(0,ai)),this.pushGossip(u,{topicID:e,messageIDs:h})})}flush(){for(const[e,r]of this.gossip.entries())this.gossip.delete(e),this.sendRpc(e,Yn([],{ihave:r}));for(const[e,r]of this.control.entries()){this.control.delete(e);const s=Yn([],{graft:r.graft,prune:r.prune});this.sendRpc(e,s)}}pushGossip(e,r){this.log("Add gossip to %s",e);const s=this.gossip.get(e)??[];this.gossip.set(e,s.concat(r))}async makePrune(e,r,s,i){if(this.score.prune(e,r),this.streamsOutbound.get(e)?.protocol===og)return{topicID:r,peers:[]};const o=i?this.opts.unsubcribeBackoff:this.opts.pruneBackoff,a=o/1e3;if(this.doAddBackoff(e,r,o),!s)return{topicID:r,peers:[],backoff:a};const l=this.getRandomGossipPeers(r,this.opts.prunePeers,h=>h!==e&&this.score.score(h)>=0),u=await Promise.all(Array.from(l).map(async h=>{const c=Bt(h);let d;try{d=await this.components.peerStore.get(c)}catch(f){if(f.name!=="NotFoundError")throw f}return{peerID:c.toMultihash().bytes,signedPeerRecord:d?.peerRecordEnvelope}}));return{topicID:r,peers:u,backoff:a}}async heartbeat(){const{D:e,Dlo:r,Dhi:s,Dscore:i,Dout:o,fanoutTTL:a}=this.opts;this.heartbeatTicks++;const l=new Map,u=y=>{let m=l.get(y);return m===void 0&&(m=this.score.score(y),l.set(y,m)),m},h=new Map,c=new Map,d=new Map;this.clearBackoff(),this.peerhave.clear(),this.metrics?.cacheSize.set({cache:"iasked"},this.iasked.size),this.iasked.clear(),this.applyIwantPenalties(),this.idontwantCounts.clear();for(const y of this.idontwants.values())for(const[m,v]of y)this.heartbeatTicks-v>=this.opts.mcacheLength&&y.delete(m);this.heartbeatTicks%this.opts.directConnectTicks===0&&await this.directConnect(),this.fastMsgIdCache?.prune(),this.seenCache.prune(),this.gossipTracer.prune(),this.publishedMessageIds.prune();const f=new Map;this.mesh.forEach((y,m)=>{const v=this.topics.get(m),_=new Set,w=new Set;if(f.set(m,w),v!=null){const E=fr(Array.from(v)),I=this.backoff.get(m);for(const k of E){const x=this.streamsOutbound.get(k);if(x!=null&&this.multicodecs.includes(x.protocol)&&!y.has(k)&&!this.direct.has(k)){const U=u(k);I?.has(k)!==!0&&U>=0&&_.add(k),U>=this.opts.scoreThresholds.gossipThreshold&&w.add(k)}}}const S=(E,I)=>{this.log("HEARTBEAT: Remove mesh link to %s in %s",E,m),this.addBackoff(E,m),y.delete(E),u(E)>=this.opts.scoreThresholds.gossipThreshold&&w.add(E),this.metrics?.onRemoveFromMesh(m,I,1);const k=c.get(E);k==null?c.set(E,[m]):k.push(m)},A=(E,I)=>{this.log("HEARTBEAT: Add mesh link to %s in %s",E,m),this.score.graft(E,m),y.add(E),w.delete(E),this.metrics?.onAddToMesh(m,I,1);const k=h.get(E);k==null?h.set(E,[m]):k.push(m)};if(y.forEach(E=>{const I=u(E);I<0&&(this.log("HEARTBEAT: Prune peer %s with negative score: score=%d, topic=%s",E,I,m),S(E,Jn.BadScore),d.set(E,!0))}),y.size<r){const E=e-y.size;TT(_,E).forEach(k=>{A(k,rn.NotEnough)})}if(y.size>s){let E=Array.from(y);E.sort((k,x)=>u(x)-u(k)),E=E.slice(0,i).concat(fr(E.slice(i)));let I=0;if(E.slice(0,e).forEach(k=>{(this.outbound.get(k)??!1)&&I++}),I<o){const k=U=>{const B=E[U];for(let N=U;N>0;N--)E[N]=E[N-1];E[0]=B};if(I>0){let U=I;for(let B=1;B<e&&U>0;B++)(this.outbound.get(E[B])??!1)&&(k(B),U--)}let x=e-I;for(let U=e;U<E.length&&x>0;U++)(this.outbound.get(E[U])??!1)&&(k(U),x--)}E.slice(e).forEach(k=>{S(k,Jn.Excess)})}if(y.size>=r){let E=0;if(y.forEach(I=>{(this.outbound.get(I)??!1)&&E++}),E<o){const I=o-E;Wd(_,I,x=>this.outbound.get(x)===!0).forEach(x=>{A(x,rn.Outbound)})}}if(this.heartbeatTicks%this.opts.opportunisticGraftTicks===0&&y.size>1){const E=Array.from(y).sort((x,U)=>u(x)-u(U)),I=Math.floor(y.size/2),k=u(E[I]);if(k<this.opts.scoreThresholds.opportunisticGraftThreshold){const x=this.opts.opportunisticGraftPeers,U=Wd(_,x,B=>u(B)>k);for(const B of U)this.log("HEARTBEAT: Opportunistically graft peer %s on topic %s",B,m),A(B,rn.Opportunistic)}}});const g=Date.now();this.fanoutLastpub.forEach((y,m)=>{y+a<g&&(this.fanout.delete(m),this.fanoutLastpub.delete(m))}),this.fanout.forEach((y,m)=>{const v=this.topics.get(m);y.forEach(A=>{(!(v?.has(A)??!1)||u(A)<this.opts.scoreThresholds.publishThreshold)&&y.delete(A)});const _=this.topics.get(m),w=[],S=new Set;if(f.set(m,S),_!=null){const A=fr(Array.from(_));for(const E of A){const I=this.streamsOutbound.get(E);if(I!=null&&this.multicodecs.includes(I.protocol)&&!y.has(E)&&!this.direct.has(E)){const k=u(E);k>=this.opts.scoreThresholds.publishThreshold&&w.push(E),k>=this.opts.scoreThresholds.gossipThreshold&&S.add(E)}}}if(y.size<e){const A=e-y.size;w.slice(0,A).forEach(E=>{y.add(E),S?.delete(E)})}}),this.emitGossip(f),await this.sendGraftPrune(h,c,d),this.flush(),this.mcache.shift(),this.dispatchEvent(new CustomEvent("gossipsub:heartbeat"))}getRandomGossipPeers(e,r,s=()=>!0){const i=this.topics.get(e);if(i==null)return new Set;let o=[];return i.forEach(a=>{const l=this.streamsOutbound.get(a);l!=null&&this.multicodecs.includes(l.protocol)&&s(a)&&o.push(a)}),o=fr(o),r>0&&o.length>r&&(o=o.slice(0,r)),new Set(o)}onScrapeMetrics(e){e.mcacheSize.set(this.mcache.size),e.mcacheNotValidatedCount.set(this.mcache.notValidatedCount),e.cacheSize.set({cache:"direct"},this.direct.size),e.cacheSize.set({cache:"seenCache"},this.seenCache.size),e.cacheSize.set({cache:"fastMsgIdCache"},this.fastMsgIdCache?.size??0),e.cacheSize.set({cache:"publishedMessageIds"},this.publishedMessageIds.size),e.cacheSize.set({cache:"mcache"},this.mcache.size),e.cacheSize.set({cache:"score"},this.score.size),e.cacheSize.set({cache:"gossipTracer.promises"},this.gossipTracer.size),e.cacheSize.set({cache:"gossipTracer.requests"},this.gossipTracer.requestMsByMsgSize),e.cacheSize.set({cache:"topics"},this.topics.size),e.cacheSize.set({cache:"subscriptions"},this.subscriptions.size),e.cacheSize.set({cache:"mesh"},this.mesh.size),e.cacheSize.set({cache:"fanout"},this.fanout.size),e.cacheSize.set({cache:"peers"},this.peers.size),e.cacheSize.set({cache:"streamsOutbound"},this.streamsOutbound.size),e.cacheSize.set({cache:"streamsInbound"},this.streamsInbound.size),e.cacheSize.set({cache:"acceptFromWhitelist"},this.acceptFromWhitelist.size),e.cacheSize.set({cache:"gossip"},this.gossip.size),e.cacheSize.set({cache:"control"},this.control.size),e.cacheSize.set({cache:"peerhave"},this.peerhave.size),e.cacheSize.set({cache:"outbound"},this.outbound.size);let r=0;const s=Date.now();e.connectedPeersBackoffSec.reset();for(const u of this.backoff.values()){r+=u.size;for(const[h,c]of u.entries())this.peers.has(h)&&e.connectedPeersBackoffSec.observe(Math.max(0,c-s)/1e3)}e.cacheSize.set({cache:"backoff"},r);let i=0;for(const u of this.idontwants.values())i+=u.size;e.cacheSize.set({cache:"idontwants"},i);for(const[u,h]of this.topics)e.topicPeersCount.set({topicStr:u},h.size);for(const[u,h]of this.mesh)e.meshPeerCounts.set({topicStr:u},h.size);const o=[],a=new Map;e.behaviourPenalty.reset();for(const u of this.peers.keys()){const h=this.score.score(u);o.push(h),a.set(u,h),e.behaviourPenalty.observe(this.score.peerStats.get(u)?.behaviourPenalty??0)}e.registerScores(o,this.opts.scoreThresholds),e.registerScorePerMesh(this.mesh,a);const l=OT(this.peers.keys(),this.score.peerStats,this.score.params,this.score.peerIPs,e.topicStrToLabel);e.registerScoreWeights(l)}}p(vw,"multicodec",Au);function xC(n={}){return t=>new vw(t,n)}function bw(n){if(n!=null){if(typeof n[Symbol.iterator]=="function")return n[Symbol.iterator]();if(typeof n[Symbol.asyncIterator]=="function")return n[Symbol.asyncIterator]();if(typeof n.next=="function")return n}throw new Error("argument is not an iterator or iterable")}class Ss extends Error{constructor(t="The frame was invalid"){super(t),this.name="InvalidFrameError"}}p(Ss,"name","InvalidFrameError");class Rf extends Error{constructor(t="Unrequested ping error"){super(t),this.name="UnrequestedPingError"}}p(Rf,"name","UnrequestedPingError");class Of extends Error{constructor(t="Unrequested ping error"){super(t),this.name="NotMatchingPingError"}}p(Of,"name","NotMatchingPingError");class ww extends Error{constructor(t="Invalid state"){super(t),this.name="InvalidStateError"}}p(ww,"name","InvalidStateError");class _w extends Error{constructor(t="Strean already exists"){super(t),this.name="StreamAlreadyExistsError"}}p(_w,"name","StreamAlreadyExistsError");class Sw extends Error{constructor(t="Decode invalid version"){super(t),this.name="DecodeInvalidVersionError"}}p(Sw,"name","DecodeInvalidVersionError");class Ew extends Error{constructor(t="Both clients"){super(t),this.name="BothClientsError"}}p(Ew,"name","BothClientsError");class Ff extends Error{constructor(t="Receive window exceeded"){super(t),this.name="ReceiveWindowExceededError"}}p(Ff,"name","ReceiveWindowExceededError");const IC=new Set([Ss.name,Rf.name,Of.name,_w.name,Sw.name,Ew.name,Ff.name]),$f=256*1024,kC=16*1024*1024,TC={enableKeepAlive:!0,keepAliveInterval:3e4,maxInboundStreams:1e3,maxOutboundStreams:1e3,initialStreamWindowSize:$f,maxStreamWindowSize:kC,maxMessageSize:64*1024};function CC(n){if(n.keepAliveInterval<=0)throw new Z("keep-alive interval must be positive");if(n.maxInboundStreams<0)throw new Z("max inbound streams must be larger or equal 0");if(n.maxOutboundStreams<0)throw new Z("max outbound streams must be larger or equal 0");if(n.initialStreamWindowSize<$f)throw new Z("InitialStreamWindowSize must be larger or equal 256 kB");if(n.maxStreamWindowSize<n.initialStreamWindowSize)throw new Z("MaxStreamWindowSize must be larger than the InitialStreamWindowSize");if(n.maxStreamWindowSize>2**32-1)throw new Z("MaxStreamWindowSize must be less than equal MAX_UINT32");if(n.maxMessageSize<1024)throw new Z("MaxMessageSize must be greater than a kilobyte")}var pt;(function(n){n[n.Data=0]="Data",n[n.WindowUpdate=1]="WindowUpdate",n[n.Ping=2]="Ping",n[n.GoAway=3]="GoAway"})(pt||(pt={}));var tt;(function(n){n[n.SYN=1]="SYN",n[n.ACK=2]="ACK",n[n.FIN=4]="FIN",n[n.RST=8]="RST"})(tt||(tt={}));Object.values(tt).filter(n=>typeof n!="string");const PC=0;var jn;(function(n){n[n.NormalTermination=0]="NormalTermination",n[n.ProtocolError=1]="ProtocolError",n[n.InternalError=2]="InternalError"})(jn||(jn={}));const $o=12,bg=2**24;function DC(n){if(n[0]!==PC)throw new Ss("Invalid frame version");return{type:n[1],flag:(n[2]<<8)+n[3],streamID:n[4]*bg+(n[5]<<16)+(n[6]<<8)+n[7],length:n[8]*bg+(n[9]<<16)+(n[10]<<8)+n[11]}}class MC{constructor(t){p(this,"source");p(this,"buffer");p(this,"frameInProgress");this.source=LC(t),this.buffer=new Ge,this.frameInProgress=!1}async*emitFrames(){for await(const t of this.source)for(this.buffer.append(t);;){const e=this.readHeader();if(e===void 0)break;const{type:r,length:s}=e;r===pt.Data?(this.frameInProgress=!0,yield{header:e,readData:this.readBytes.bind(this,s)}):yield{header:e}}}readHeader(){if(this.frameInProgress)throw new ww("decoding frame already in progress");if(this.buffer.length<$o)return;const t=DC(this.buffer.subarray(0,$o));return this.buffer.consume($o),t}async readBytes(t){if(this.buffer.length<t){for await(const r of this.source)if(this.buffer.append(r),this.buffer.length>=t)break}const e=this.buffer.sublist(0,t);return this.buffer.consume(t),this.frameInProgress=!1,e}}function LC(n){if(n[Symbol.iterator]!==void 0){const t=n[Symbol.iterator]();return t.return=void 0,{[Symbol.iterator](){return t}}}else if(n[Symbol.asyncIterator]!==void 0){const t=n[Symbol.asyncIterator]();return t.return=void 0,{[Symbol.asyncIterator](){return t}}}else throw new Error("a source must be either an iterable or an async iterable")}function wg(n){const t=new Uint8Array($o);return t[1]=n.type,t[2]=n.flag>>>8,t[3]=n.flag,t[4]=n.streamID>>>24,t[5]=n.streamID>>>16,t[6]=n.streamID>>>8,t[7]=n.streamID,t[8]=n.length>>>24,t[9]=n.length>>>16,t[10]=n.length>>>8,t[11]=n.length,t}let _g=class extends Error{constructor(e,r,s){super(e??"The operation was aborted");p(this,"type");p(this,"code");this.type="aborted",this.name=s??"AbortError",this.code=r??"ABORT_ERR"}};async function Ir(n,t,e){if(t==null)return n;if(t.aborted)return n.catch(()=>{}),Promise.reject(new _g(e?.errorMessage,e?.errorCode,e?.errorName));let r;const s=new _g(e?.errorMessage,e?.errorCode,e?.errorName);try{return await Promise.race([n,new Promise((i,o)=>{r=()=>{o(s)},t.addEventListener("abort",r)})])}finally{r!=null&&t.removeEventListener("abort",r)}}function BC(n){return n==null?!1:typeof n.then=="function"&&typeof n.catch=="function"&&typeof n.finally=="function"}function NC(n,t){const e=bw(n).return?.();BC(e)&&e.catch(r=>{t.error("could not cause iterator to return",r)})}const RC=5e3;function Pu(n){return n==null?!1:typeof n.then=="function"&&typeof n.catch=="function"&&typeof n.finally=="function"}class OC{constructor(t){p(this,"id");p(this,"direction");p(this,"timeline");p(this,"protocol");p(this,"metadata");p(this,"source");p(this,"status");p(this,"readStatus");p(this,"writeStatus");p(this,"log");p(this,"sinkController");p(this,"sinkEnd");p(this,"closed");p(this,"endErr");p(this,"streamSource");p(this,"onEnd");p(this,"onCloseRead");p(this,"onCloseWrite");p(this,"onReset");p(this,"onAbort");p(this,"sendCloseWriteTimeout");p(this,"sendingData");this.sinkController=new AbortController,this.sinkEnd=bt(),this.closed=bt(),this.log=t.log,this.status="open",this.readStatus="ready",this.writeStatus="ready",this.id=t.id,this.metadata=t.metadata??{},this.direction=t.direction,this.timeline={open:Date.now()},this.sendCloseWriteTimeout=t.sendCloseWriteTimeout??RC,this.onEnd=t.onEnd,this.onCloseRead=t?.onCloseRead,this.onCloseWrite=t?.onCloseWrite,this.onReset=t?.onReset,this.onAbort=t?.onAbort,this.source=this.streamSource=ds({onEnd:e=>{e!=null?this.log.trace("source ended with error",e):this.log.trace("source ended"),this.onSourceEnd(e)}}),this.sink=this.sink.bind(this)}async sink(t){if(this.writeStatus!=="ready")throw new ob(`writable end state is "${this.writeStatus}" not "ready"`);try{this.writeStatus="writing";const e={signal:this.sinkController.signal};if(this.direction==="outbound"){const s=this.sendNewStream(e);Pu(s)&&await s}const r=()=>{NC(t,this.log)};try{this.sinkController.signal.addEventListener("abort",r),this.log.trace("sink reading from source");for await(let s of t){s=s instanceof Uint8Array?new Ge(s):s;const i=this.sendData(s,e);Pu(i)&&(this.sendingData=bt(),await i,this.sendingData.resolve(),this.sendingData=void 0)}}finally{this.sinkController.signal.removeEventListener("abort",r)}this.log.trace('sink finished reading from source, write status is "%s"',this.writeStatus),this.writeStatus==="writing"&&(this.writeStatus="closing",this.log.trace("send close write to remote"),await this.sendCloseWrite({signal:AbortSignal.timeout(this.sendCloseWriteTimeout)}),this.writeStatus="closed"),this.onSinkEnd()}catch(e){throw this.log.trace("sink ended with error, calling abort with error",e),this.abort(e),e}finally{this.log.trace("resolve sink end"),this.sinkEnd.resolve()}}onSourceEnd(t){this.timeline.closeRead==null&&(this.timeline.closeRead=Date.now(),this.readStatus="closed",t!=null&&this.endErr==null&&(this.endErr=t),this.onCloseRead?.(),this.timeline.closeWrite!=null?(this.log.trace("source and sink ended"),this.timeline.close=Date.now(),this.status!=="aborted"&&this.status!=="reset"&&(this.status="closed"),this.onEnd!=null&&this.onEnd(this.endErr),this.closed.resolve()):this.log.trace("source ended, waiting for sink to end"))}onSinkEnd(t){this.timeline.closeWrite==null&&(this.timeline.closeWrite=Date.now(),this.writeStatus="closed",t!=null&&this.endErr==null&&(this.endErr=t),this.onCloseWrite?.(),this.timeline.closeRead!=null?(this.log.trace("sink and source ended"),this.timeline.close=Date.now(),this.status!=="aborted"&&this.status!=="reset"&&(this.status="closed"),this.onEnd!=null&&this.onEnd(this.endErr),this.closed.resolve()):this.log.trace("sink ended, waiting for source to end"))}async close(t){this.status==="open"&&(this.log.trace("closing gracefully"),this.status="closing",await Ir(Promise.all([this.closeWrite(t),this.closeRead(t),this.closed.promise]),t?.signal),this.status="closed",this.log.trace("closed gracefully"))}async closeRead(t={}){if(this.readStatus==="closing"||this.readStatus==="closed")return;this.log.trace('closing readable end of stream with starting read status "%s"',this.readStatus);const e=this.readStatus;this.readStatus="closing",this.status!=="reset"&&this.status!=="aborted"&&this.timeline.closeRead==null&&(this.log.trace("send close read to remote"),await this.sendCloseRead(t)),e==="ready"&&(this.log.trace("ending internal source queue with %d queued bytes",this.streamSource.readableLength),this.streamSource.end()),this.log.trace("closed readable end of stream")}async closeWrite(t={}){this.writeStatus==="closing"||this.writeStatus==="closed"||(this.log.trace('closing writable end of stream with starting write status "%s"',this.writeStatus),this.writeStatus==="ready"&&(this.log.trace("sink was never sunk, sink an empty array"),await Ir(this.sink([]),t.signal)),this.writeStatus==="writing"&&(this.sendingData!=null&&await Ir(this.sendingData.promise,t.signal),this.log.trace("aborting source passed to .sink"),this.sinkController.abort(),await Ir(this.sinkEnd.promise,t.signal)),this.writeStatus="closed",this.log.trace("closed writable end of stream"))}abort(t){if(this.status==="closed"||this.status==="aborted"||this.status==="reset")return;this.log("abort with error",t),this.log("try to send reset to remote");const e=this.sendReset();Pu(e)&&e.catch(r=>{this.log.error("error sending reset message",r)}),this.status="aborted",this.timeline.abort=Date.now(),this._closeSinkAndSource(t),this.onAbort?.(t)}reset(){if(this.status==="closed"||this.status==="aborted"||this.status==="reset")return;const t=new ib("stream reset");this.status="reset",this.timeline.reset=Date.now(),this._closeSinkAndSource(t),this.onReset?.()}_closeSinkAndSource(t){this._closeSink(t),this._closeSource(t)}_closeSink(t){this.writeStatus==="writing"&&(this.log.trace("end sink source"),this.sinkController.abort()),this.onSinkEnd(t)}_closeSource(t){this.readStatus!=="closing"&&this.readStatus!=="closed"&&(this.log.trace("ending source with %d bytes to be read by consumer",this.streamSource.readableLength),this.readStatus="closing",this.streamSource.end(t))}remoteCloseWrite(){if(this.readStatus==="closing"||this.readStatus==="closed"){this.log("received remote close write but local source is already closed");return}this.log.trace("remote close write"),this._closeSource()}remoteCloseRead(){if(this.writeStatus==="closing"||this.writeStatus==="closed"){this.log("received remote close read but local sink is already closed");return}this.log.trace("remote close read"),this._closeSink()}destroy(){if(this.status==="closed"||this.status==="aborted"||this.status==="reset"){this.log("received destroy but we are already closed");return}this.log.trace("stream destroyed"),this._closeSinkAndSource()}sourcePush(t){this.streamSource.push(t)}sourceReadableLength(){return this.streamSource.readableLength}}function Aw(n){const[t,e]=n[Symbol.asyncIterator]!=null?[n[Symbol.asyncIterator](),Symbol.asyncIterator]:[n[Symbol.iterator](),Symbol.iterator],r=[];return{peek:()=>t.next(),push:s=>{r.push(s)},next:()=>r.length>0?{done:!1,value:r.shift()}:t.next(),[e](){return this}}}function FC(n){return n[Symbol.asyncIterator]!=null}function Sg(n){return n?.then!=null}function xw(n,t){let e=0;if(FC(n))return async function*(){for await(const l of n){const u=t(l,e++);Sg(u)&&await u,yield l}}();const r=Aw(n),{value:s,done:i}=r.next();if(i===!0)return function*(){}();if(typeof t(s,e++)?.then=="function")return async function*(){yield s;for await(const l of r){const u=t(l,e++);Sg(u)&&await u,yield l}}();const a=t;return function*(){yield s;for(const l of r)a(l,e++),yield l}()}var Fn;(function(n){n[n.Init=0]="Init",n[n.SYNSent=1]="SYNSent",n[n.SYNReceived=2]="SYNReceived",n[n.Established=3]="Established",n[n.Finished=4]="Finished"})(Fn||(Fn={}));class $C extends OC{constructor(e){super({...e,onEnd:r=>{this.state=Fn.Finished,e.onEnd?.(r)}});p(this,"name");p(this,"state");p(this,"config");p(this,"_id");p(this,"sendWindowCapacity");p(this,"sendWindowCapacityUpdate");p(this,"recvWindow");p(this,"recvWindowCapacity");p(this,"epochStart");p(this,"getRTT");p(this,"sendFrame");this.config=e.config,this._id=parseInt(e.id,10),this.name=e.name,this.state=e.state,this.sendWindowCapacity=$f,this.recvWindow=this.config.initialStreamWindowSize,this.recvWindowCapacity=this.recvWindow,this.epochStart=Date.now(),this.getRTT=e.getRTT,this.sendFrame=e.sendFrame,this.source=xw(this.source,()=>{this.sendWindowUpdate()})}async sendNewStream(){}async sendData(e,r={}){for(e=e.sublist();e.byteLength!==0;){if(this.sendWindowCapacity===0&&(this.log?.trace("wait for send window capacity, status %s",this.status),await this.waitForSendWindowCapacity(r),this.status==="closed"||this.status==="aborted"||this.status==="reset")){this.log?.trace("%s while waiting for send window capacity",this.status);return}const s=Math.min(this.sendWindowCapacity,this.config.maxMessageSize-$o,e.length),i=this.getSendFlags();this.sendFrame({type:pt.Data,flag:i,streamID:this._id,length:s},e.sublist(0,s)),this.sendWindowCapacity-=s,e.consume(s)}}async sendReset(){this.sendFrame({type:pt.WindowUpdate,flag:tt.RST,streamID:this._id,length:0})}async sendCloseWrite(){const e=this.getSendFlags()|tt.FIN;this.sendFrame({type:pt.WindowUpdate,flag:e,streamID:this._id,length:0})}async sendCloseRead(){}async waitForSendWindowCapacity(e={}){if(this.sendWindowCapacity>0)return;let r,s;const i=()=>{this.status==="open"||this.status==="closing"?s(new Ns("Stream aborted")):r()};e.signal?.addEventListener("abort",i);try{await new Promise((o,a)=>{this.sendWindowCapacityUpdate=()=>{o()},s=a,r=o})}finally{e.signal?.removeEventListener("abort",i)}}handleWindowUpdate(e){this.log?.trace("stream received window update id=%s",this._id),this.processFlags(e.flag);const r=this.sendWindowCapacity;this.sendWindowCapacity+=e.length,r===0&&e.length>0&&this.sendWindowCapacityUpdate?.()}async handleData(e,r){if(this.log?.trace("stream received data id=%s",this._id),this.processFlags(e.flag),this.recvWindowCapacity<e.length)throw new Ff("Receive window exceeded");const s=await r();this.recvWindowCapacity-=e.length,this.sourcePush(s)}processFlags(e){(e&tt.ACK)===tt.ACK&&this.state===Fn.SYNSent&&(this.state=Fn.Established),(e&tt.FIN)===tt.FIN&&this.remoteCloseWrite(),(e&tt.RST)===tt.RST&&this.reset()}getSendFlags(){switch(this.state){case Fn.Init:return this.state=Fn.SYNSent,tt.SYN;case Fn.SYNReceived:return this.state=Fn.Established,tt.ACK;default:return 0}}sendWindowUpdate(){const e=this.getSendFlags(),r=Date.now(),s=this.getRTT();if(e===0&&s>-1&&r-this.epochStart<s*4&&(this.recvWindow=Math.min(this.recvWindow*2,this.config.maxStreamWindowSize)),this.recvWindowCapacity>=this.recvWindow&&e===0)return;const i=this.recvWindow-this.recvWindowCapacity;this.recvWindowCapacity=this.recvWindow,this.epochStart=r,this.sendFrame({type:pt.WindowUpdate,flag:e,streamID:this._id,length:i})}}const Iw="/yamux/1.0.0",UC=500;var iy,oy;oy=Symbol.toStringTag,iy=Wn;class VC{constructor(t,e={}){p(this,"protocol",Iw);p(this,"_components");p(this,"_init");p(this,oy,"@chainsafe/libp2p-yamux");p(this,iy,["@libp2p/stream-multiplexing"]);this._components=t,this._init=e}createStreamMuxer(t){return new HC(this._components,{...this._init,...t})}}class HC{constructor(t,e){p(this,"protocol",Iw);p(this,"source");p(this,"sink");p(this,"config");p(this,"log");p(this,"logger");p(this,"closeController");p(this,"nextStreamID");p(this,"_streams");p(this,"nextPingID");p(this,"activePing");p(this,"rtt");p(this,"client");p(this,"localGoAway");p(this,"remoteGoAway");p(this,"numInboundStreams");p(this,"numOutboundStreams");p(this,"onIncomingStream");p(this,"onStreamEnd");this.client=e.direction==="outbound",this.config={...TC,...e},this.logger=t.logger,this.log=this.logger.forComponent("libp2p:yamux"),CC(this.config),this.closeController=new AbortController,this.closeController.signal,this.onIncomingStream=e.onIncomingStream,this.onStreamEnd=e.onStreamEnd,this._streams=new Map,this.source=ds({onEnd:()=>{this.log?.trace("muxer source ended"),this._streams.forEach(r=>{r.destroy()})}}),this.sink=async r=>{const s=()=>{const a=bw(r);if(a.return!=null){const l=a.return();zC(l)&&l.catch(u=>{this.log?.("could not cause sink source to return",u)})}};let i,o;try{const a=new MC(r);try{this.closeController.signal.addEventListener("abort",s);for await(const l of a.emitFrames())await this.handleFrame(l.header,l.readData)}finally{this.closeController.signal.removeEventListener("abort",s)}i=jn.NormalTermination}catch(a){IC.has(a.name)?(this.log?.error("protocol error in sink",a),i=jn.ProtocolError):(this.log?.error("internal error in sink",a),i=jn.InternalError),o=a}this.log?.trace("muxer sink ended"),o!=null?this.abort(o,i):await this.close({reason:i})},this.numInboundStreams=0,this.numOutboundStreams=0,this.nextStreamID=this.client?1:2,this.nextPingID=0,this.rtt=-1,this.log?.trace("muxer created"),this.config.enableKeepAlive&&this.keepAliveLoop().catch(r=>this.log?.error("keepalive error: %s",r)),this.ping().catch(r=>this.log?.error("ping error: %s",r))}get streams(){return Array.from(this._streams.values())}newStream(t){if(this.remoteGoAway!==void 0)throw new fi("Muxer closed remotely");if(this.localGoAway!==void 0)throw new fi("Muxer closed locally");const e=this.nextStreamID;if(this.nextStreamID+=2,this.numOutboundStreams>=this.config.maxOutboundStreams)throw new of("max outbound streams exceeded");this.log?.trace("new outgoing stream id=%s",e);const r=this._newStream(e,t,Fn.Init,"outbound");return this._streams.set(e,r),this.numOutboundStreams++,r.sendWindowUpdate(),r}async ping(){if(this.remoteGoAway!==void 0)throw new fi("Muxer closed remotely");if(this.localGoAway!==void 0)throw new fi("Muxer closed locally");if(this.activePing===void 0){let t=()=>{};this.activePing={id:this.nextPingID++,promise:new Promise((s,i)=>{const o=()=>{i(new fi("Muxer closed locally"))};this.closeController.signal.addEventListener("abort",o,{once:!0}),t=()=>{this.closeController.signal.removeEventListener("abort",o),s()}}),resolve:t};const e=Date.now();this.sendPing(this.activePing.id);try{await this.activePing.promise}finally{delete this.activePing}const r=Date.now();this.rtt=r-e}else await this.activePing.promise;return this.rtt}getRTT(){return this.rtt}async close(t={}){if(this.closeController.signal.aborted)return;const e=t?.reason??jn.NormalTermination;if(this.log?.trace("muxer close reason=%s",e),t.signal==null){const r=AbortSignal.timeout(UC);t={...t,signal:r}}try{await Promise.all([...this._streams.values()].map(async r=>r.close(t))),this.sendGoAway(e),this._closeMuxer()}catch(r){this.abort(r)}}abort(t,e){if(!this.closeController.signal.aborted){e=e??jn.InternalError,this.log?.error("muxer abort reason=%s error=%s",e,t);for(const r of this._streams.values())r.abort(t);this.sendGoAway(e),this._closeMuxer()}}isClosed(){return this.closeController.signal.aborted}_closeMuxer(){this.closeController.abort(),this.source.end()}_newStream(t,e,r,s){if(this._streams.get(t)!=null)throw new Z("Stream already exists with that id");const i=new $C({id:t.toString(),name:e,state:r,direction:s,sendFrame:this.sendFrame.bind(this),onEnd:()=>{this.closeStream(t),this.onStreamEnd?.(i)},log:this.logger.forComponent(`libp2p:yamux:${s}:${t}`),config:this.config,getRTT:this.getRTT.bind(this)});return i}closeStream(t){this.client===(t%2===0)?this.numInboundStreams--:this.numOutboundStreams--,this._streams.delete(t)}async keepAliveLoop(){const t=new Promise((e,r)=>{this.closeController.signal.addEventListener("abort",r,{once:!0})});for(this.log?.trace("muxer keepalive enabled interval=%s",this.config.keepAliveInterval);;){let e;try{await Promise.race([t,new Promise(r=>{e=setTimeout(r,this.config.keepAliveInterval)})]),this.ping().catch(r=>this.log?.error("ping error: %s",r))}catch{clearInterval(e);return}}}async handleFrame(t,e){const{streamID:r,type:s,length:i}=t;if(this.log?.trace("received frame %o",t),r===0)switch(s){case pt.Ping:{this.handlePing(t);return}case pt.GoAway:{this.handleGoAway(i);return}default:throw new Ss("Invalid frame type")}else switch(t.type){case pt.Data:case pt.WindowUpdate:{await this.handleStreamMessage(t,e);return}default:throw new Ss("Invalid frame type")}}handlePing(t){if(t.flag===tt.SYN)this.log?.trace("received ping request pingId=%s",t.length),this.sendPing(t.length,tt.ACK);else if(t.flag===tt.ACK)this.log?.trace("received ping response pingId=%s",t.length),this.handlePingResponse(t.length);else throw new Ss("Invalid frame flag")}handlePingResponse(t){if(this.activePing===void 0)throw new Rf("ping not requested");if(this.activePing.id!==t)throw new Of("ping doesn't match our id");this.activePing.resolve()}handleGoAway(t){this.log?.trace("received GoAway reason=%s",jn[t]??"unknown"),this.remoteGoAway=t;for(const e of this._streams.values())e.reset();this._closeMuxer()}async handleStreamMessage(t,e){const{streamID:r,flag:s,type:i}=t;(s&tt.SYN)===tt.SYN&&this.incomingStream(r);const o=this._streams.get(r);if(o===void 0){if(i===pt.Data){if(this.log?.("discarding data for stream id=%s",r),e===void 0)throw new Error("unreachable");await e()}else this.log?.trace("frame for missing stream id=%s",r);return}switch(i){case pt.WindowUpdate:{o.handleWindowUpdate(t);return}case pt.Data:{if(e===void 0)throw new Error("unreachable");await o.handleData(t,e);return}default:throw new Error("unreachable")}}incomingStream(t){if(this.client!==(t%2===0))throw new Z("Both endpoints are clients");if(this._streams.has(t))return;if(this.log?.trace("new incoming stream id=%s",t),this.localGoAway!==void 0){this.sendFrame({type:pt.WindowUpdate,flag:tt.RST,streamID:t,length:0});return}if(this.numInboundStreams>=this.config.maxInboundStreams){this.log?.("maxIncomingStreams exceeded, forcing stream reset"),this.sendFrame({type:pt.WindowUpdate,flag:tt.RST,streamID:t,length:0});return}const e=this._newStream(t,void 0,Fn.SYNReceived,"inbound");this.numInboundStreams++,this._streams.set(t,e),this.onIncomingStream?.(e)}sendFrame(t,e){if(this.log?.trace("sending frame %o",t),t.type===pt.Data){if(e===void 0)throw new Ss("Invalid frame");this.source.push(new Ge(wg(t),e))}else this.source.push(wg(t))}sendPing(t,e=tt.SYN){e===tt.SYN?this.log?.trace("sending ping request pingId=%s",t):this.log?.trace("sending ping response pingId=%s",t),this.sendFrame({type:pt.Ping,flag:e,streamID:0,length:t})}sendGoAway(t=jn.NormalTermination){this.log?.("sending GoAway reason=%s",jn[t]),this.localGoAway=t,this.sendFrame({type:pt.GoAway,flag:0,streamID:0,length:t})}}function zC(n){return n!=null&&typeof n.then=="function"}function qC(n={}){return t=>new VC(t,n)}function WC(n){n=Kd(n);const t=[],e=[];let r=null;const s=n.split("/").slice(1);if(s.length===1&&s[0]==="")return{bytes:new Uint8Array,string:"/",tuples:[],stringTuples:[],path:null};for(let i=0;i<s.length;i++){const o=s[i],a=pe(o);if(a.size===0){t.push([a.code]),e.push([a.code]);continue}if(i++,i>=s.length)throw new Uf("invalid address: "+n);if(a.path===!0){r=Kd(s.slice(i).join("/")),t.push([a.code,mg(a.code,r)]),e.push([a.code,r]);break}const l=mg(a.code,s[i]);t.push([a.code,l]),e.push([a.code,Bf(a.code,l)])}return{string:kw(e),bytes:Tw(t),tuples:t,stringTuples:e,path:r}}function Eg(n){const t=[],e=[];let r=null,s=0;for(;s<n.length;){const i=js(n,s),o=ln(i),a=pe(i),l=GC(a,n.slice(s+o));if(l===0){t.push([i]),e.push([i]),s+=o;continue}const u=n.slice(s+o,s+o+l);if(s+=l+o,s>n.length)throw new Uf("Invalid address Uint8Array: "+he(n,"base16"));t.push([i,u]);const h=Bf(i,u);if(e.push([i,h]),a.path===!0){r=h;break}}return{bytes:Uint8Array.from(n),string:kw(e),tuples:t,stringTuples:e,path:r}}function kw(n){const t=[];return n.map(e=>{const r=pe(e[0]);return t.push(r.name),e.length>1&&e[1]!=null&&t.push(e[1]),null}),Kd(t.join("/"))}function Tw(n){return bn(n.map(t=>{const e=pe(t[0]);let r=Uint8Array.from(Vn(e.code));return t.length>1&&t[1]!=null&&(r=bn([r,t[1]])),r}))}function GC(n,t){if(n.size>0)return n.size/8;if(n.size===0)return 0;{const e=js(t instanceof Uint8Array?t:Uint8Array.from(t));return e+ln(e)}}function Kd(n){return"/"+n.trim().split("/").filter(t=>t).join("/")}class Uf extends Error{constructor(e){super(`Error parsing address: ${e}`);p(this,"name","ParseError")}}p(Uf,"name","ParseError");const KC=Symbol.for("nodejs.util.inspect.custom"),Cw=Symbol.for("@multiformats/js-multiaddr/multiaddr"),YC=[pe("dns").code,pe("dns4").code,pe("dns6").code,pe("dnsaddr").code];class QC extends Error{constructor(t="No available resolver"){super(t),this.name="NoAvailableResolverError"}}var ay,Ti,es,la,ua;const mi=class mi{constructor(t){p(this,"bytes");_e(this,Ti);_e(this,es);_e(this,la);_e(this,ua);p(this,ay,!0);t==null&&(t="");let e;if(t instanceof Uint8Array)e=Eg(t);else if(typeof t=="string"){if(t.length>0&&t.charAt(0)!=="/")throw new Error(`multiaddr "${t}" must start with a "/"`);e=WC(t)}else if(Hl(t))e=Eg(t.bytes);else throw new Error("addr must be a string, Buffer, or another Multiaddr");this.bytes=e.bytes,Me(this,Ti,e.string),Me(this,es,e.tuples),Me(this,la,e.stringTuples),Me(this,ua,e.path)}toString(){return F(this,Ti)}toJSON(){return this.toString()}toOptions(){let t,e,r,s,i="";const o=pe("tcp"),a=pe("udp"),l=pe("ip4"),u=pe("ip6"),h=pe("dns6"),c=pe("ip6zone");for(const[f,g]of this.stringTuples())f===c.code&&(i=`%${g??""}`),YC.includes(f)&&(e=o.name==="tcp"?"tcp":"udp",s=443,r=`${g??""}${i}`,t=f===h.code?6:4),(f===o.code||f===a.code)&&(e=pe(f).name==="tcp"?"tcp":"udp",s=parseInt(g??"")),(f===l.code||f===u.code)&&(e=pe(f).name==="tcp"?"tcp":"udp",r=`${g??""}${i}`,t=f===u.code?6:4);if(t==null||e==null||r==null||s==null)throw new Error('multiaddr must have a valid format: "/{ip4, ip6, dns4, dns6, dnsaddr}/{address}/{tcp, udp}/{port}".');return{family:t,host:r,transport:e,port:s}}protos(){return F(this,es).map(([t])=>Object.assign({},pe(t)))}protoCodes(){return F(this,es).map(([t])=>t)}protoNames(){return F(this,es).map(([t])=>pe(t).name)}tuples(){return F(this,es).map(([t,e])=>e==null?[t]:[t,e])}stringTuples(){return F(this,la).map(([t,e])=>e==null?[t]:[t,e])}encapsulate(t){return t=new mi(t),new mi(this.toString()+t.toString())}decapsulate(t){const e=t.toString(),r=this.toString(),s=r.lastIndexOf(e);if(s<0)throw new Error(`Address ${this.toString()} does not contain subaddress: ${t.toString()}`);return new mi(r.slice(0,s))}decapsulateCode(t){const e=this.tuples();for(let r=e.length-1;r>=0;r--)if(e[r][0]===t)return new mi(Tw(e.slice(0,r)));return this}getPeerId(){try{let t=[];this.stringTuples().forEach(([r,s])=>{r===na.p2p.code&&t.push([r,s]),r===na["p2p-circuit"].code&&(t=[])});const e=t.pop();if(e?.[1]!=null){const r=e[1];return r[0]==="Q"||r[0]==="1"?he(ot.decode(`z${r}`),"base58btc"):he(Qe.parse(r).multihash.bytes,"base58btc")}return null}catch{return null}}getPath(){return F(this,ua)}equals(t){return It(this.bytes,t.bytes)}async resolve(t){const e=this.protos().find(i=>i.resolvable);if(e==null)return[this];const r=Vf.get(e.name);if(r==null)throw new QC(`no available resolver for ${e.name}`);return(await r(this,t)).map(i=>me(i))}nodeAddress(){const t=this.toOptions();if(t.transport!=="tcp"&&t.transport!=="udp")throw new Error(`multiaddr must have a valid format - no protocol with name: "${t.transport}". Must have a valid transport protocol: "{tcp, udp}"`);return{family:t.family,address:t.host,port:t.port}}isThinWaistAddress(t){const e=(t??this).protos();return!(e.length!==2||e[0].code!==4&&e[0].code!==41||e[1].code!==6&&e[1].code!==273)}[(ay=Cw,KC)](){return`Multiaddr(${F(this,Ti)})`}};Ti=new WeakMap,es=new WeakMap,la=new WeakMap,ua=new WeakMap;let Yd=mi;const Vf=new Map;function Hl(n){return!!n?.[Cw]}function me(n){return new Yd(n)}const jC=j("dns4"),ZC=j("dns6"),XC=j("dnsaddr"),Us=ct(j("dns"),XC,jC,ZC),zl=ct(j("ip4"),j("ip6")),qi=ct(ie(zl,j("tcp")),ie(Us,j("tcp"))),ql=ie(zl,j("udp")),JC=ie(ql,j("utp")),eP=ie(ql,j("quic")),tP=ie(ql,j("quic-v1")),Qd=ct(ie(qi,j("ws")),ie(Us,j("ws"))),Oc=ct(ie(Qd,j("p2p")),Qd),jd=ct(ie(qi,j("wss")),ie(Us,j("wss")),ie(qi,j("tls"),j("ws")),ie(Us,j("tls"),j("ws"))),Fc=ct(ie(jd,j("p2p")),jd),Zd=ct(ie(qi,j("http")),ie(zl,j("http")),ie(Us,j("http"))),Xd=ct(ie(qi,j("https")),ie(zl,j("https")),ie(Us,j("https"))),Ag=ie(ql,j("webrtc-direct"),j("certhash")),Pw=ct(ie(Ag,j("p2p")),Ag),xg=ie(tP,j("webtransport"),j("certhash"),j("certhash")),Dw=ct(ie(xg,j("p2p")),xg),Mw=ct(ie(Oc,j("p2p-webrtc-star"),j("p2p")),ie(Fc,j("p2p-webrtc-star"),j("p2p")),ie(Oc,j("p2p-webrtc-star")),ie(Fc,j("p2p-webrtc-star")));ct(ie(Oc,j("p2p-websocket-star"),j("p2p")),ie(Fc,j("p2p-websocket-star"),j("p2p")),ie(Oc,j("p2p-websocket-star")),ie(Fc,j("p2p-websocket-star")));const Lw=ct(ie(Zd,j("p2p-webrtc-direct"),j("p2p")),ie(Xd,j("p2p-webrtc-direct"),j("p2p")),ie(Zd,j("p2p-webrtc-direct")),ie(Xd,j("p2p-webrtc-direct"))),Vs=ct(Qd,jd,Zd,Xd,Mw,Lw,qi,JC,eP,Us,Pw,Dw);ct(ie(Vs,j("p2p-stardust"),j("p2p")),ie(Vs,j("p2p-stardust")));const ss=ct(ie(Vs,j("p2p")),Mw,Lw,Pw,Dw,j("p2p")),Ig=ct(ie(ss,j("p2p-circuit"),ss),ie(ss,j("p2p-circuit")),ie(j("p2p-circuit"),ss),ie(Vs,j("p2p-circuit")),ie(j("p2p-circuit"),Vs),j("p2p-circuit")),Bw=()=>ct(ie(Ig,Bw),Ig),bs=Bw(),nP=ct(ie(bs,ss,bs),ie(ss,bs),ie(bs,ss),bs,ss);ct(ie(bs,j("webrtc"),j("p2p")),ie(bs,j("webrtc")),ie(Vs,j("webrtc"),j("p2p")),ie(Vs,j("webrtc")),j("webrtc"));function Nw(n){function t(e){let r;try{r=me(e)}catch{return!1}const s=n(r.protoNames());return s===null?!1:s===!0||s===!1?s:s.length===0}return t}function ie(...n){function t(e){if(e.length<n.length)return null;let r=e;return n.some(s=>(r=typeof s=="function"?s().partialMatch(e):s.partialMatch(e),Array.isArray(r)&&(e=r),r===null)),r}return{toString:function(){return"{ "+n.join(" ")+" }"},input:n,matches:Nw(t),partialMatch:t}}function ct(...n){function t(r){let s=null;return n.some(i=>{const o=typeof i=="function"?i().partialMatch(r):i.partialMatch(r);return o!=null?(s=o,!0):!1}),s}return{toString:function(){return"{ "+n.join(" ")+" }"},input:n,matches:Nw(t),partialMatch:t}}function j(n){const t=n;function e(s){let i;try{i=me(s)}catch{return!1}const o=i.protoNames();return o.length===1&&o[0]===t}function r(s){return s.length===0?null:s[0]===t?s.slice(1):null}return{toString:function(){return t},matches:e,partialMatch:r}}const rP="bootstrap",sP=50,iP=1e3;var cy,ly,uy,dy;class Rw extends(dy=ar,uy=_c,ly=Symbol.toStringTag,cy=Wn,dy){constructor(e,r={list:[]}){if(r.list==null||r.list.length===0)throw new Error("Bootstrap requires a list of peer addresses");super();p(this,"log");p(this,"timer");p(this,"list");p(this,"timeout");p(this,"components");p(this,"_init");p(this,uy,this);p(this,ly,"@libp2p/bootstrap");p(this,cy,["@libp2p/peer-discovery"]);this.components=e,this.log=e.logger.forComponent("libp2p:bootstrap"),this.timeout=r.timeout??iP,this.list=[];for(const s of r.list){if(!nP.matches(s)){this.log.error("Invalid multiaddr");continue}const i=me(s),o=i.getPeerId();if(o==null){this.log.error("Invalid bootstrap multiaddr without peer id");continue}const a={id:Bt(o),multiaddrs:[i]};this.list.push(a)}this._init=r}isStarted(){return!!this.timer}start(){this.isStarted()||(this.log("Starting bootstrap node discovery, discovering peers after %s ms",this.timeout),this.timer=setTimeout(()=>{this._discoverBootstrapPeers().catch(e=>{this.log.error(e)})},this.timeout))}async _discoverBootstrapPeers(){if(this.timer!=null)for(const e of this.list){if(await this.components.peerStore.merge(e.id,{tags:{[this._init.tagName??rP]:{value:this._init.tagValue??sP,ttl:this._init.tagTTL}},multiaddrs:e.multiaddrs}),this.timer==null)return;this.safeDispatchEvent("peer",{detail:e}),this.components.connectionManager.openConnection(e.id).catch(r=>{this.log.error("could not dial bootstrap peer %p",e.id,r)})}}stop(){this.timer!=null&&clearTimeout(this.timer),this.timer=void 0}}p(Rw,"tag","bootstrap");function oP(n){return t=>new Rw(t,n)}var $c;(function(n){let t;n.codec=()=>(t==null&&(t=Ce((e,r,s={})=>{s.lengthDelimited!==!1&&r.fork(),e.publicKey!=null&&e.publicKey.byteLength>0&&(r.uint32(10),r.bytes(e.publicKey)),e.payloadType!=null&&e.payloadType.byteLength>0&&(r.uint32(18),r.bytes(e.payloadType)),e.payload!=null&&e.payload.byteLength>0&&(r.uint32(26),r.bytes(e.payload)),e.signature!=null&&e.signature.byteLength>0&&(r.uint32(42),r.bytes(e.signature)),s.lengthDelimited!==!1&&r.ldelim()},(e,r,s={})=>{const i={publicKey:Ke(0),payloadType:Ke(0),payload:Ke(0),signature:Ke(0)},o=r==null?e.len:e.pos+r;for(;e.pos<o;){const a=e.uint32();switch(a>>>3){case 1:{i.publicKey=e.bytes();break}case 2:{i.payloadType=e.bytes();break}case 3:{i.payload=e.bytes();break}case 5:{i.signature=e.bytes();break}default:{e.skipType(a&7);break}}}return i})),t),n.encode=e=>Te(e,n.codec()),n.decode=(e,r)=>ke(e,n.codec(),r)})($c||($c={}));class aP extends Error{constructor(t="Invalid signature"){super(t),this.name="InvalidSignatureError"}}const Zr=class Zr{constructor(t){p(this,"publicKey");p(this,"payloadType");p(this,"payload");p(this,"signature");p(this,"marshaled");const{publicKey:e,payloadType:r,payload:s,signature:i}=t;this.publicKey=e,this.payloadType=r,this.payload=s,this.signature=i}marshal(){return this.marshaled==null&&(this.marshaled=$c.encode({publicKey:nr(this.publicKey),payloadType:this.payloadType,payload:this.payload.subarray(),signature:this.signature})),this.marshaled}equals(t){return It(this.marshal(),t.marshal())}async validate(t){const e=kg(t,this.payloadType,this.payload);return this.publicKey.verify(e.subarray(),this.signature)}};p(Zr,"createFromProtobuf",async t=>{const e=$c.decode(t),r=Lr(e.publicKey);return new Zr({publicKey:r,payloadType:e.payloadType,payload:e.payload,signature:e.signature})}),p(Zr,"seal",async(t,e)=>{if(e==null)throw new Error("Missing private key");const r=t.domain,s=t.codec,i=t.marshal(),o=kg(r,s,i),a=await e.sign(o.subarray());return new Zr({publicKey:e.publicKey,payloadType:s,payload:i,signature:a})}),p(Zr,"openAndCertify",async(t,e)=>{const r=await Zr.createFromProtobuf(t);if(!await r.validate(e))throw new aP("Envelope signature is not valid for the given domain");return r});let Hs=Zr;const kg=(n,t,e)=>{const r=te(n),s=Vn(r.byteLength),i=Vn(t.length),o=Vn(e.length);return new Ge(s,r,i,t,o,e)};function cP(n,t){const e=(r,s)=>r.toString().localeCompare(s.toString());return n.length!==t.length?!1:(t.sort(e),n.sort(e).every((r,s)=>t[s].equals(r)))}const lP="libp2p-peer-record",uP=Uint8Array.from([3,1]);var Uc;(function(n){(function(e){let r;e.codec=()=>(r==null&&(r=Ce((s,i,o={})=>{o.lengthDelimited!==!1&&i.fork(),s.multiaddr!=null&&s.multiaddr.byteLength>0&&(i.uint32(10),i.bytes(s.multiaddr)),o.lengthDelimited!==!1&&i.ldelim()},(s,i,o={})=>{const a={multiaddr:Ke(0)},l=i==null?s.len:s.pos+i;for(;s.pos<l;){const u=s.uint32();switch(u>>>3){case 1:{a.multiaddr=s.bytes();break}default:{s.skipType(u&7);break}}}return a})),r),e.encode=s=>Te(s,e.codec()),e.decode=(s,i)=>ke(s,e.codec(),i)})(n.AddressInfo||(n.AddressInfo={}));let t;n.codec=()=>(t==null&&(t=Ce((e,r,s={})=>{if(s.lengthDelimited!==!1&&r.fork(),e.peerId!=null&&e.peerId.byteLength>0&&(r.uint32(10),r.bytes(e.peerId)),e.seq!=null&&e.seq!==0n&&(r.uint32(16),r.uint64(e.seq)),e.addresses!=null)for(const i of e.addresses)r.uint32(26),n.AddressInfo.codec().encode(i,r);s.lengthDelimited!==!1&&r.ldelim()},(e,r,s={})=>{const i={peerId:Ke(0),seq:0n,addresses:[]},o=r==null?e.len:e.pos+r;for(;e.pos<o;){const a=e.uint32();switch(a>>>3){case 1:{i.peerId=e.bytes();break}case 2:{i.seq=e.uint64();break}case 3:{if(s.limits?.addresses!=null&&i.addresses.length===s.limits.addresses)throw new gt('Decode error - map field "addresses" had too many elements');i.addresses.push(n.AddressInfo.codec().decode(e,e.uint32(),{limits:s.limits?.addresses$}));break}default:{e.skipType(a&7);break}}}return i})),t),n.encode=e=>Te(e,n.codec()),n.decode=(e,r)=>ke(e,n.codec(),r)})(Uc||(Uc={}));const vr=class vr{constructor(t){p(this,"peerId");p(this,"multiaddrs");p(this,"seqNumber");p(this,"domain",vr.DOMAIN);p(this,"codec",vr.CODEC);p(this,"marshaled");const{peerId:e,multiaddrs:r,seqNumber:s}=t;this.peerId=e,this.multiaddrs=r??[],this.seqNumber=s??BigInt(Date.now())}marshal(){return this.marshaled==null&&(this.marshaled=Uc.encode({peerId:this.peerId.toMultihash().bytes,seq:BigInt(this.seqNumber),addresses:this.multiaddrs.map(t=>({multiaddr:t.bytes}))})),this.marshaled}equals(t){return!(!(t instanceof vr)||!this.peerId.equals(t.peerId)||this.seqNumber!==t.seqNumber||!cP(this.multiaddrs,t.multiaddrs))}};p(vr,"createFromProtobuf",t=>{const e=Uc.decode(t),r=Zs($r(e.peerId)),s=(e.addresses??[]).map(o=>me(o.multiaddr)),i=e.seq;return new vr({peerId:r,multiaddrs:s,seqNumber:i})}),p(vr,"DOMAIN",lP),p(vr,"CODEC",uP);let Dr=vr;class dP{constructor(){p(this,"readNext");p(this,"haveNext");p(this,"ended");p(this,"nextResult");this.ended=!1,this.readNext=bt(),this.haveNext=bt()}[Symbol.asyncIterator](){return this}async next(){if(this.nextResult==null&&await this.haveNext.promise,this.nextResult==null)throw new Error("HaveNext promise resolved but nextResult was undefined");const t=this.nextResult;return this.nextResult=void 0,this.readNext.resolve(),this.readNext=bt(),t}async throw(t){return this.ended=!0,t!=null&&(this.haveNext.promise.catch(()=>{}),this.haveNext.reject(t)),{done:!0,value:void 0}}async return(){const t={done:!0,value:void 0};return this.ended=!0,this.nextResult=t,this.haveNext.resolve(),t}async push(t,e){await this._push(t,e)}async end(t,e){t!=null?await this.throw(t):await this._push(void 0,e)}async _push(t,e){if(t!=null&&this.ended)throw new Error("Cannot push value onto an ended pushable");for(;this.nextResult!=null;)await this.readNext.promise;t!=null?this.nextResult={done:!1,value:t}:(this.ended=!0,this.nextResult={done:!0,value:void 0}),this.haveNext.resolve(),this.haveNext=bt(),await Ir(this.readNext.promise,e?.signal,e)}}function hP(){return new dP}class fP extends Error{constructor(){super(...arguments);p(this,"name","UnexpectedEOFError");p(this,"code","ERR_UNEXPECTED_EOF")}}class pP extends Error{constructor(e,r){super(e);p(this,"code");this.code=r}}let gP=class extends pP{constructor(e){super(e,"ABORT_ERR");p(this,"type");this.type="aborted",this.name="AbortError"}};function Ow(n,t){const e=hP();n.sink(e).catch(async o=>{await e.end(o)}),n.sink=async o=>{for await(const a of o)await e.push(a);await e.end()};let r=n.source;n.source[Symbol.iterator]!=null?r=n.source[Symbol.iterator]():n.source[Symbol.asyncIterator]!=null&&(r=n.source[Symbol.asyncIterator]());const s=new Ge;return{read:async(o,a)=>{a?.signal?.throwIfAborted();let l;const u=new Promise((h,c)=>{l=()=>{c(new gP("Read aborted"))},a?.signal?.addEventListener("abort",l)});try{if(o==null){const{done:c,value:d}=await Promise.race([r.next(),u]);return c===!0?new Ge:d}for(;s.byteLength<o;){const{value:c,done:d}=await Promise.race([r.next(),u]);if(d===!0)throw new fP("unexpected end of input");s.append(c)}const h=s.sublist(0,o);return s.consume(o),h}finally{l!=null&&a?.signal?.removeEventListener("abort",l)}},write:async(o,a)=>{a?.signal?.throwIfAborted(),o instanceof Uint8Array?await e.push(o,a):await e.push(o.subarray(),a)},unwrap:()=>{if(s.byteLength>0){const o=n.source;n.source=async function*(){t?.yieldBytes===!1?yield s:yield*s,yield*o}()}return n}}}class mP extends Error{constructor(){super(...arguments);p(this,"name","InvalidMessageLengthError");p(this,"code","ERR_INVALID_MSG_LENGTH")}}let yP=class extends Error{constructor(){super(...arguments);p(this,"name","InvalidDataLengthError");p(this,"code","ERR_MSG_DATA_TOO_LONG")}};class vP extends Error{constructor(){super(...arguments);p(this,"name","InvalidDataLengthLengthError");p(this,"code","ERR_MSG_LENGTH_TOO_LONG")}}function Wl(n,t={}){const e=Ow(n,t);t.maxDataLength!=null&&t.maxLengthLength==null&&(t.maxLengthLength=ln(t.maxDataLength));const r=t?.lengthDecoder??js,s=t?.lengthEncoder??Vn;return{read:async o=>{let a=-1;const l=new Ge;for(;;){l.append(await e.read(1,o));try{a=r(l)}catch(u){if(u instanceof RangeError)continue;throw u}if(a<0)throw new mP("Invalid message length");if(t?.maxLengthLength!=null&&l.byteLength>t.maxLengthLength)throw new vP("message length length too long");if(a>-1)break}if(t?.maxDataLength!=null&&a>t.maxDataLength)throw new yP("message length too long");return e.read(a,o)},write:async(o,a)=>{await e.write(new Ge(s(o.byteLength),o),a)},writeV:async(o,a)=>{const l=new Ge(...o.flatMap(u=>[s(u.byteLength),u]));await e.write(l,a)},unwrap:()=>e.unwrap()}}function Wi(n,t){const e=Wl(n,t),r={read:async(s,i)=>{const o=await e.read(i);return s.decode(o)},write:async(s,i,o)=>{await e.write(i.encode(s),o)},writeV:async(s,i,o)=>{await e.writeV(s.map(a=>i.encode(a)),o)},pb:s=>({read:async i=>r.read(s,i),write:async(i,o)=>r.write(i,s,o),writeV:async(i,o)=>r.writeV(i,s,o),unwrap:()=>r}),unwrap:()=>e.unwrap()};return r}const bP=290,wP=1,Fw=2e3,_P=100,Ua=`${Xh}-circuit-relay`;BigInt(1<<17);const Vc="/libp2p/circuit/relay/0.2.0/hop",Tg="/libp2p/circuit/relay/0.2.0/stop",Cg=300,SP=4096,EP=.001;var Gi;(function(n){(function(r){r.RESERVE="RESERVE",r.CONNECT="CONNECT",r.STATUS="STATUS"})(n.Type||(n.Type={}));let t;(function(r){r[r.RESERVE=0]="RESERVE",r[r.CONNECT=1]="CONNECT",r[r.STATUS=2]="STATUS"})(t||(t={})),function(r){r.codec=()=>Ia(t)}(n.Type||(n.Type={}));let e;n.codec=()=>(e==null&&(e=Ce((r,s,i={})=>{i.lengthDelimited!==!1&&s.fork(),r.type!=null&&(s.uint32(8),n.Type.codec().encode(r.type,s)),r.peer!=null&&(s.uint32(18),Ki.codec().encode(r.peer,s)),r.reservation!=null&&(s.uint32(26),Hc.codec().encode(r.reservation,s)),r.limit!=null&&(s.uint32(34),Yi.codec().encode(r.limit,s)),r.status!=null&&(s.uint32(40),Kt.codec().encode(r.status,s)),i.lengthDelimited!==!1&&s.ldelim()},(r,s,i={})=>{const o={},a=s==null?r.len:r.pos+s;for(;r.pos<a;){const l=r.uint32();switch(l>>>3){case 1:{o.type=n.Type.codec().decode(r);break}case 2:{o.peer=Ki.codec().decode(r,r.uint32(),{limits:i.limits?.peer});break}case 3:{o.reservation=Hc.codec().decode(r,r.uint32(),{limits:i.limits?.reservation});break}case 4:{o.limit=Yi.codec().decode(r,r.uint32(),{limits:i.limits?.limit});break}case 5:{o.status=Kt.codec().decode(r);break}default:{r.skipType(l&7);break}}}return o})),e),n.encode=r=>Te(r,n.codec()),n.decode=(r,s)=>ke(r,n.codec(),s)})(Gi||(Gi={}));var mr;(function(n){(function(r){r.CONNECT="CONNECT",r.STATUS="STATUS"})(n.Type||(n.Type={}));let t;(function(r){r[r.CONNECT=0]="CONNECT",r[r.STATUS=1]="STATUS"})(t||(t={})),function(r){r.codec=()=>Ia(t)}(n.Type||(n.Type={}));let e;n.codec=()=>(e==null&&(e=Ce((r,s,i={})=>{i.lengthDelimited!==!1&&s.fork(),r.type!=null&&(s.uint32(8),n.Type.codec().encode(r.type,s)),r.peer!=null&&(s.uint32(18),Ki.codec().encode(r.peer,s)),r.limit!=null&&(s.uint32(26),Yi.codec().encode(r.limit,s)),r.status!=null&&(s.uint32(32),Kt.codec().encode(r.status,s)),i.lengthDelimited!==!1&&s.ldelim()},(r,s,i={})=>{const o={},a=s==null?r.len:r.pos+s;for(;r.pos<a;){const l=r.uint32();switch(l>>>3){case 1:{o.type=n.Type.codec().decode(r);break}case 2:{o.peer=Ki.codec().decode(r,r.uint32(),{limits:i.limits?.peer});break}case 3:{o.limit=Yi.codec().decode(r,r.uint32(),{limits:i.limits?.limit});break}case 4:{o.status=Kt.codec().decode(r);break}default:{r.skipType(l&7);break}}}return o})),e),n.encode=r=>Te(r,n.codec()),n.decode=(r,s)=>ke(r,n.codec(),s)})(mr||(mr={}));var Ki;(function(n){let t;n.codec=()=>(t==null&&(t=Ce((e,r,s={})=>{if(s.lengthDelimited!==!1&&r.fork(),e.id!=null&&e.id.byteLength>0&&(r.uint32(10),r.bytes(e.id)),e.addrs!=null)for(const i of e.addrs)r.uint32(18),r.bytes(i);s.lengthDelimited!==!1&&r.ldelim()},(e,r,s={})=>{const i={id:Ke(0),addrs:[]},o=r==null?e.len:e.pos+r;for(;e.pos<o;){const a=e.uint32();switch(a>>>3){case 1:{i.id=e.bytes();break}case 2:{if(s.limits?.addrs!=null&&i.addrs.length===s.limits.addrs)throw new gt('Decode error - map field "addrs" had too many elements');i.addrs.push(e.bytes());break}default:{e.skipType(a&7);break}}}return i})),t),n.encode=e=>Te(e,n.codec()),n.decode=(e,r)=>ke(e,n.codec(),r)})(Ki||(Ki={}));var Hc;(function(n){let t;n.codec=()=>(t==null&&(t=Ce((e,r,s={})=>{if(s.lengthDelimited!==!1&&r.fork(),e.expire!=null&&e.expire!==0n&&(r.uint32(8),r.uint64(e.expire)),e.addrs!=null)for(const i of e.addrs)r.uint32(18),r.bytes(i);e.voucher!=null&&(r.uint32(26),qc.codec().encode(e.voucher,r)),s.lengthDelimited!==!1&&r.ldelim()},(e,r,s={})=>{const i={expire:0n,addrs:[]},o=r==null?e.len:e.pos+r;for(;e.pos<o;){const a=e.uint32();switch(a>>>3){case 1:{i.expire=e.uint64();break}case 2:{if(s.limits?.addrs!=null&&i.addrs.length===s.limits.addrs)throw new gt('Decode error - map field "addrs" had too many elements');i.addrs.push(e.bytes());break}case 3:{i.voucher=qc.codec().decode(e,e.uint32(),{limits:s.limits?.voucher});break}default:{e.skipType(a&7);break}}}return i})),t),n.encode=e=>Te(e,n.codec()),n.decode=(e,r)=>ke(e,n.codec(),r)})(Hc||(Hc={}));var Yi;(function(n){let t;n.codec=()=>(t==null&&(t=Ce((e,r,s={})=>{s.lengthDelimited!==!1&&r.fork(),e.duration!=null&&(r.uint32(8),r.uint32(e.duration)),e.data!=null&&(r.uint32(16),r.uint64(e.data)),s.lengthDelimited!==!1&&r.ldelim()},(e,r,s={})=>{const i={},o=r==null?e.len:e.pos+r;for(;e.pos<o;){const a=e.uint32();switch(a>>>3){case 1:{i.duration=e.uint32();break}case 2:{i.data=e.uint64();break}default:{e.skipType(a&7);break}}}return i})),t),n.encode=e=>Te(e,n.codec()),n.decode=(e,r)=>ke(e,n.codec(),r)})(Yi||(Yi={}));var Kt;(function(n){n.UNUSED="UNUSED",n.OK="OK",n.RESERVATION_REFUSED="RESERVATION_REFUSED",n.RESOURCE_LIMIT_EXCEEDED="RESOURCE_LIMIT_EXCEEDED",n.PERMISSION_DENIED="PERMISSION_DENIED",n.CONNECTION_FAILED="CONNECTION_FAILED",n.NO_RESERVATION="NO_RESERVATION",n.MALFORMED_MESSAGE="MALFORMED_MESSAGE",n.UNEXPECTED_MESSAGE="UNEXPECTED_MESSAGE"})(Kt||(Kt={}));var Jd;(function(n){n[n.UNUSED=0]="UNUSED",n[n.OK=100]="OK",n[n.RESERVATION_REFUSED=200]="RESERVATION_REFUSED",n[n.RESOURCE_LIMIT_EXCEEDED=201]="RESOURCE_LIMIT_EXCEEDED",n[n.PERMISSION_DENIED=202]="PERMISSION_DENIED",n[n.CONNECTION_FAILED=203]="CONNECTION_FAILED",n[n.NO_RESERVATION=204]="NO_RESERVATION",n[n.MALFORMED_MESSAGE=400]="MALFORMED_MESSAGE",n[n.UNEXPECTED_MESSAGE=401]="UNEXPECTED_MESSAGE"})(Jd||(Jd={}));(function(n){n.codec=()=>Ia(Jd)})(Kt||(Kt={}));var zc;(function(n){let t;n.codec=()=>(t==null&&(t=Ce((e,r,s={})=>{s.lengthDelimited!==!1&&r.fork(),e.relay!=null&&e.relay.byteLength>0&&(r.uint32(10),r.bytes(e.relay)),e.peer!=null&&e.peer.byteLength>0&&(r.uint32(18),r.bytes(e.peer)),e.expiration!=null&&e.expiration!==0n&&(r.uint32(24),r.uint64(e.expiration)),s.lengthDelimited!==!1&&r.ldelim()},(e,r,s={})=>{const i={relay:Ke(0),peer:Ke(0),expiration:0n},o=r==null?e.len:e.pos+r;for(;e.pos<o;){const a=e.uint32();switch(a>>>3){case 1:{i.relay=e.bytes();break}case 2:{i.peer=e.bytes();break}case 3:{i.expiration=e.uint64();break}default:{e.skipType(a&7);break}}}return i})),t),n.encode=e=>Te(e,n.codec()),n.decode=(e,r)=>ke(e,n.codec(),r)})(zc||(zc={}));var qc;(function(n){let t;n.codec=()=>(t==null&&(t=Ce((e,r,s={})=>{s.lengthDelimited!==!1&&r.fork(),e.publicKey!=null&&e.publicKey.byteLength>0&&(r.uint32(10),r.bytes(e.publicKey)),e.payloadType!=null&&e.payloadType.byteLength>0&&(r.uint32(18),r.bytes(e.payloadType)),e.payload!=null&&(r.uint32(26),zc.codec().encode(e.payload,r)),e.signature!=null&&e.signature.byteLength>0&&(r.uint32(42),r.bytes(e.signature)),s.lengthDelimited!==!1&&r.ldelim()},(e,r,s={})=>{const i={publicKey:Ke(0),payloadType:Ke(0),signature:Ke(0)},o=r==null?e.len:e.pos+r;for(;e.pos<o;){const a=e.uint32();switch(a>>>3){case 1:{i.publicKey=e.bytes();break}case 2:{i.payloadType=e.bytes();break}case 3:{i.payload=zc.codec().decode(e,e.uint32(),{limits:s.limits?.payload});break}case 5:{i.signature=e.bytes();break}default:{e.skipType(a&7);break}}}return i})),t),n.encode=e=>Te(e,n.codec()),n.decode=(e,r)=>ke(e,n.codec(),r)})(qc||(qc={}));const AP=n=>n.toString().split("/").slice(1),Ca=n=>({match:t=>t.length<1?!1:n(t[0])?t.slice(1):!1,pattern:"fn"}),ve=n=>({match:t=>Ca(e=>e===n).match(t),pattern:n}),uo=()=>({match:n=>Ca(t=>typeof t=="string").match(n),pattern:"{string}"}),Gl=()=>({match:n=>Ca(t=>!isNaN(parseInt(t))).match(n),pattern:"{number}"}),He=()=>({match:n=>{if(n.length<2||n[0]!=="p2p"&&n[0]!=="ipfs")return!1;if(n[1].startsWith("Q")||n[1].startsWith("1"))try{ot.decode(`z${n[1]}`)}catch{return!1}else return!1;return n.slice(2)},pattern:"/p2p/{peerid}"}),Wc=()=>({match:n=>{if(n.length<2||n[0]!=="certhash")return!1;try{Rb.decode(n[1])}catch{return!1}return n.slice(2)},pattern:"/certhash/{certhash}"}),Ne=n=>({match:t=>{const e=n.match(t);return e===!1?t:e},pattern:`optional(${n.pattern})`}),Yt=(...n)=>({match:t=>{let e;for(const r of n){const s=r.match(t);s!==!1&&(e==null||s.length<e.length)&&(e=s)}return e??!1},pattern:`or(${n.map(t=>t.pattern).join(", ")})`}),Se=(...n)=>({match:t=>{for(const e of n){const r=e.match(t);if(r===!1)return!1;t=r}return t},pattern:`and(${n.map(t=>t.pattern).join(", ")})`});function Xe(...n){function t(s){let i=AP(s);for(const o of n){const a=o.match(i);if(a===!1)return!1;i=a}return i}function e(s){return t(s)!==!1}function r(s){const i=t(s);return i===!1?!1:i.length===0}return{matchers:n,matches:e,exactMatch:r}}const Kl=Se(ve("dns4"),uo()),Yl=Se(ve("dns6"),uo()),Ql=Se(ve("dnsaddr"),uo()),Hf=Se(ve("dns"),uo());Xe(Kl,Ne(He()));Xe(Yl,Ne(He()));Xe(Ql,Ne(He()));Xe(Yt(Hf,Ql,Kl,Yl),Ne(He()));const $w=Se(ve("ip4"),Ca(zi)),Uw=Se(ve("ip6"),Ca(Lf)),zf=Yt($w,Uw),Mr=Yt(zf,Hf,Kl,Yl,Ql),xP=Xe(Yt(zf,Se(Yt(Hf,Ql,Kl,Yl),Ne(He())))),Pg=Xe($w),Dg=Xe(Uw);Xe(zf);const qf=Se(Mr,ve("tcp"),Gl()),Pa=Se(Mr,ve("udp"),Gl()),Gc=Xe(Se(qf,Ne(He())));Xe(Pa);const Wf=Se(Pa,ve("quic"),Ne(He())),jl=Se(Pa,ve("quic-v1"),Ne(He())),IP=Yt(Wf,jl);Xe(Wf);const kP=Xe(jl),eh=Yt(Mr,qf,Pa,Wf,jl),Vw=Yt(Se(eh,ve("ws"),Ne(He()))),ra=Xe(Vw),Hw=Yt(Se(eh,ve("wss"),Ne(He())),Se(eh,ve("tls"),Ne(Se(ve("sni"),uo())),ve("ws"),Ne(He()))),Kc=Xe(Hw),zw=Se(Pa,ve("webrtc-direct"),Ne(Wc()),Ne(Wc()),Ne(He())),Mg=Xe(zw),qw=Se(jl,ve("webtransport"),Ne(Wc()),Ne(Wc()),Ne(He())),Lg=Xe(qw),Yc=Yt(Vw,Hw,Se(qf,Ne(He())),Se(IP,Ne(He())),Se(Mr,Ne(He())),zw,qw,He()),TP=Xe(Yc),CP=Se(Yc,ve("p2p-circuit"),He()),sa=Xe(CP),PP=Yt(Se(Yc,ve("p2p-circuit"),ve("webrtc"),Ne(He())),Se(Yc,ve("webrtc"),Ne(He())),Se(ve("webrtc"),Ne(He()))),Bg=Xe(PP),DP=Yt(Se(Mr,ve("tcp"),Gl(),ve("http"),Ne(He())),Se(Mr,ve("http"),Ne(He())));Xe(DP);const MP=Yt(Se(Mr,ve("tcp"),Yt(Se(ve("443"),ve("http")),Se(Gl(),ve("https"))),Ne(He())),Se(Mr,ve("tls"),ve("http"),Ne(He())),Se(Mr,ve("https"),Ne(He())));Xe(MP);const LP=Yt(Se(ve("memory"),uo(),Ne(He())));Xe(LP);function Qi(n){const t=new globalThis.AbortController;function e(){t.abort();for(const i of n)i?.removeEventListener!=null&&i.removeEventListener("abort",e)}for(const i of n){if(i?.aborted===!0){e();break}i?.addEventListener!=null&&i.addEventListener("abort",e)}function r(){for(const i of n)i?.removeEventListener!=null&&i.removeEventListener("abort",e)}const s=t.signal;return s.clear=r,s}class th extends Error{constructor(){super(...arguments);p(this,"name","HadEnoughRelaysError")}}p(th,"name","HadEnoughRelaysError");class Ww extends Error{constructor(){super(...arguments);p(this,"name","DoubleRelayError")}}p(Ww,"name","DoubleRelayError");class Gw extends Error{constructor(){super(...arguments);p(this,"name","RelayQueueFullError")}}p(Gw,"name","RelayQueueFullError");function Ng(n){const t=n*BigInt(1e3),e=new Date().getTime();return Number(t-BigInt(e))}class Rg{constructor(t){p(this,"expires");p(this,"bytes");t?.duration!=null&&t?.duration!==0&&(this.expires=Date.now()+t.duration*1e3),this.bytes=t?.data,this.bytes===0n&&(this.bytes=void 0),this.onData=this.onData.bind(this)}onData(t){this.bytes!=null&&(this.bytes-=BigInt(t.byteLength),this.bytes<0n&&(this.bytes=0n))}getLimits(){if(this.expires==null&&this.bytes==null)return;const t={};if(this.bytes!=null){const e=this;Object.defineProperty(t,"bytes",{get(){return e.bytes}})}if(this.expires!=null){const e=this;Object.defineProperty(t,"seconds",{get(){return Math.round(((e.expires??0)-Date.now())/1e3)}})}return t}}const Kw=Xe(Se(TP.matchers[0],ve("p2p-circuit"))),Yw=Xe(ve("p2p-circuit"));function Uo(n,t){const e={[Symbol.iterator]:()=>e,next:()=>{const r=n.next(),s=r.value;return r.done===!0||s==null?{done:!0,value:void 0}:{done:!1,value:t(s)}}};return e}function Du(n){const t=$r(ot.decode(`z${n}`));return Zs(t)}class Zl{constructor(t){p(this,"map");if(this.map=new Map,t!=null)for(const[e,r]of t.entries())this.map.set(e.toString(),{key:e,value:r})}[Symbol.iterator](){return this.entries()}clear(){this.map.clear()}delete(t){return this.map.delete(t.toString())}entries(){return Uo(this.map.entries(),t=>[t[1].key,t[1].value])}forEach(t){this.map.forEach((e,r)=>{t(e.value,e.key,this)})}get(t){return this.map.get(t.toString())?.value}has(t){return this.map.has(t.toString())}set(t,e){this.map.set(t.toString(),{key:t,value:e})}keys(){return Uo(this.map.values(),t=>t.key)}values(){return Uo(this.map.values(),t=>t.value)}get size(){return this.map.size}}class xi{constructor(t){p(this,"set");if(this.set=new Set,t!=null)for(const e of t)this.set.add(e.toString())}get size(){return this.set.size}[Symbol.iterator](){return this.values()}add(t){this.set.add(t.toString())}clear(){this.set.clear()}delete(t){this.set.delete(t.toString())}entries(){return Uo(this.set.entries(),t=>{const e=Du(t[0]);return[e,e]})}forEach(t){this.set.forEach(e=>{const r=Du(e);t(r,r,this)})}has(t){return this.set.has(t.toString())}values(){return Uo(this.set.values(),t=>Du(t))}intersection(t){const e=new xi;for(const r of t)this.has(r)&&e.add(r);return e}difference(t){const e=new xi;for(const r of this)t.has(r)||e.add(r);return e}union(t){const e=new xi;for(const r of t)e.add(r);for(const r of this)e.add(r);return e}}const Gf={32:16777619n,64:1099511628211n,128:309485009821345068724781371n,256:374144419156711147060143317175368453031918731002211n,512:35835915874844867368919076489095108449946327955754392558399825615420669938882575126094039892345713852759n,1024:5016456510113118655434598811035278955030765345404790744303017523831112055108147451509157692220295382716162651878526895249385292291816524375083746691371804094271873160484737966720260389217684476157468082573n},Qw={32:2166136261n,64:14695981039346656037n,128:144066263297769815596495629667062367629n,256:100029257958052580907070968620625704837092796014241193945225284501741471925557n,512:9659303129496669498009435400716310466090418745672637896108374329434462657994582932197716438449813051892206539805784495328239340083876191928701583869517785n,1024:14197795064947621068722070641403218320880622795441933960878474914617582723252296732303717722150864096521202355549365628174669108571814760471015076148029755969804077320157692458563003215304957150157403644460363550505412711285966361610267868082893823963790439336411086884584107735010676915n},jw=new globalThis.TextEncoder;function BP(n,t){const e=Gf[t];let r=Qw[t];for(let s=0;s<n.length;s++)r^=BigInt(n[s]),r=BigInt.asUintN(t,r*e);return r}function NP(n,t,e){if(e.length===0)throw new Error("The `utf8Buffer` option must have a length greater than zero");const r=Gf[t];let s=Qw[t],i=n;for(;i.length>0;){const o=jw.encodeInto(i,e);i=i.slice(o.read);for(let a=0;a<o.written;a++)s^=BigInt(e[a]),s=BigInt.asUintN(t,s*r)}return s}function RP(n,{size:t=32,utf8Buffer:e}={}){if(!Gf[t])throw new Error("The `size` option must be one of 32, 64, 128, 256, 512, or 1024");if(typeof n=="string"){if(e)return NP(n,t,e);n=jw.encode(n)}return BP(n,t)}const Kf={hash:n=>Number(RP(n,{size:32})),hashV:(n,t)=>OP(Kf.hash(n,t))};function OP(n){let t=n.toString(16);return t.length%2===1&&(t=`0${t}`),te(t,"base16")}const Zw=64;class Es{constructor(t,e,r,s=2){p(this,"fp");p(this,"h");p(this,"seed");if(s>Zw)throw new TypeError("Invalid Fingerprint Size");const i=e.hashV(t,r),o=Ke(s);for(let a=0;a<o.length;a++)o[a]=i[a];o.length===0&&(o[0]=7),this.fp=o,this.h=e,this.seed=r}hash(){return this.h.hash(this.fp,this.seed)}equals(t){return t?.fp instanceof Uint8Array?It(this.fp,t.fp):!1}}function Qc(n,t){return Math.floor(Math.random()*(t-n))+n}class Va{constructor(t){p(this,"contents");this.contents=new Array(t).fill(null)}has(t){if(!(t instanceof Es))throw new TypeError("Invalid Fingerprint");return this.contents.some(e=>t.equals(e))}add(t){if(!(t instanceof Es))throw new TypeError("Invalid Fingerprint");for(let e=0;e<this.contents.length;e++)if(this.contents[e]==null)return this.contents[e]=t,!0;return!0}swap(t){if(!(t instanceof Es))throw new TypeError("Invalid Fingerprint");const e=Qc(0,this.contents.length-1),r=this.contents[e];return this.contents[e]=t,r}remove(t){if(!(t instanceof Es))throw new TypeError("Invalid Fingerprint");const e=this.contents.findIndex(r=>t.equals(r));return e>-1?(this.contents[e]=null,!0):!1}}const FP=500;class Og{constructor(t){p(this,"bucketSize");p(this,"filterSize");p(this,"fingerprintSize");p(this,"buckets");p(this,"count");p(this,"hash");p(this,"seed");this.filterSize=t.filterSize,this.bucketSize=t.bucketSize??4,this.fingerprintSize=t.fingerprintSize??2,this.count=0,this.buckets=[],this.hash=t.hash??Kf,this.seed=t.seed??Qc(0,Math.pow(2,10))}add(t){typeof t=="string"&&(t=te(t));const e=new Es(t,this.hash,this.seed,this.fingerprintSize),r=this.hash.hash(t,this.seed)%this.filterSize,s=(r^e.hash())%this.filterSize;if(this.buckets[r]==null&&(this.buckets[r]=new Va(this.bucketSize)),this.buckets[s]==null&&(this.buckets[s]=new Va(this.bucketSize)),this.buckets[r].add(e)||this.buckets[s].add(e))return this.count++,!0;const i=[r,s];let o=i[Qc(0,i.length-1)];this.buckets[o]==null&&(this.buckets[o]=new Va(this.bucketSize));for(let a=0;a<FP;a++){const l=this.buckets[o].swap(e);if(l!=null&&(o=(o^l.hash())%this.filterSize,this.buckets[o]==null&&(this.buckets[o]=new Va(this.bucketSize)),this.buckets[o].add(l)))return this.count++,!0}return!1}has(t){typeof t=="string"&&(t=te(t));const e=new Es(t,this.hash,this.seed,this.fingerprintSize),r=this.hash.hash(t,this.seed)%this.filterSize,s=this.buckets[r]?.has(e)??!1;if(s)return s;const i=(r^e.hash())%this.filterSize;return this.buckets[i]?.has(e)??!1}remove(t){typeof t=="string"&&(t=te(t));const e=new Es(t,this.hash,this.seed,this.fingerprintSize),r=this.hash.hash(t,this.seed)%this.filterSize,s=this.buckets[r]?.remove(e)??!1;if(s)return this.count--,s;const i=(r^e.hash())%this.filterSize,o=this.buckets[i]?.remove(e)??!1;return o&&this.count--,o}get reliable(){return Math.floor(100*(this.count/this.filterSize))<=90}}const $P={1:.5,2:.84,4:.95,8:.98};function UP(n=.001){return n>.002?2:n>1e-5?4:8}function VP(n,t=.001){const e=UP(t),r=$P[e],s=Math.round(n/r),i=Math.min(Math.ceil(Math.log2(1/t)+Math.log2(2*e)),Zw);return{filterSize:s,bucketSize:e,fingerprintSize:i}}class HP{constructor(t){p(this,"filterSize");p(this,"bucketSize");p(this,"fingerprintSize");p(this,"scale");p(this,"filterSeries");p(this,"hash");p(this,"seed");this.bucketSize=t.bucketSize??4,this.filterSize=t.filterSize??(1<<18)/this.bucketSize,this.fingerprintSize=t.fingerprintSize??2,this.scale=t.scale??2,this.hash=t.hash??Kf,this.seed=t.seed??Qc(0,Math.pow(2,10)),this.filterSeries=[new Og({filterSize:this.filterSize,bucketSize:this.bucketSize,fingerprintSize:this.fingerprintSize,hash:this.hash,seed:this.seed})]}add(t){if(typeof t=="string"&&(t=te(t)),this.has(t))return!0;let e=this.filterSeries.find(r=>r.reliable);if(e==null){const r=this.filterSize*Math.pow(this.scale,this.filterSeries.length);e=new Og({filterSize:r,bucketSize:this.bucketSize,fingerprintSize:this.fingerprintSize,hash:this.hash,seed:this.seed}),this.filterSeries.push(e)}return e.add(t)}has(t){typeof t=="string"&&(t=te(t));for(let e=0;e<this.filterSeries.length;e++)if(this.filterSeries[e].has(t))return!0;return!1}remove(t){typeof t=="string"&&(t=te(t));for(let e=0;e<this.filterSeries.length;e++)if(this.filterSeries[e].remove(t))return!0;return!1}get count(){return this.filterSeries.reduce((t,e)=>t+e.count,0)}}function ia(n,t=.001,e){return new HP({...VP(n,t)})}class zP{constructor(t,e){p(this,"filter");this.filter=ia(t,e)}has(t){return this.filter.has(t.toMultihash().bytes)}add(t){this.filter.add(t.toMultihash().bytes)}remove(t){this.filter.remove?.(t.toMultihash().bytes)}}function qP(n,t=.001){return new zP(n,t)}function Fg(n){const{stream:t,remoteAddr:e,logger:r,onDataRead:s,onDataWrite:i}=n,o=r.forComponent("libp2p:stream:converter");let a=!1,l=!1;const u=t.close.bind(t);t.close=async g=>{await u(g),f(!0)};const h=t.abort.bind(t);t.abort=g=>{h(g),f(!0)};const c=t.sink.bind(t);t.sink=async g=>{try{await c(Br(g,y=>xw(y,m=>i?.(m))))}catch(y){y.type!=="aborted"&&o.error("%s error in sink",e,y)}finally{l=!0,f()}};const d={log:o,sink:t.sink,source:async function*(){try{for await(const g of t.source)s?.(g),yield g}finally{a=!0,f()}}(),remoteAddr:e,timeline:{open:Date.now(),close:void 0},close:t.close,abort:t.abort};function f(g){g===!0&&(a=!0,l=!0),a&&l&&d.timeline.close==null&&(d.timeline.close=Date.now())}return d}class vt extends Event{constructor(e,r){super(e);p(this,"type");p(this,"detail");this.type=e,this.detail=r}}let WP=class extends Error{constructor(e,r){super(e??"The operation was aborted");p(this,"type");p(this,"code");this.type="aborted",this.name="AbortError",this.code=r??"ABORT_ERR"}};async function rc(n,t,e,r){const s=new WP(r?.errorMessage,r?.errorCode);return e?.aborted===!0?Promise.reject(s):new Promise((i,o)=>{function a(){e?.removeEventListener("abort",h),n.removeEventListener(t,l),r?.errorEvent!=null&&n.removeEventListener(r.errorEvent,u)}const l=c=>{try{if(r?.filter?.(c)===!1)return}catch(d){a(),o(d);return}a(),i(c)},u=c=>{a(),o(c.detail)},h=()=>{a(),o(s)};e?.addEventListener("abort",h),n.addEventListener(t,l),r?.errorEvent!=null&&n.addEventListener(r.errorEvent,u)})}class GP extends Error{constructor(e="Rate limit exceeded",r){super(e);p(this,"remainingPoints");p(this,"msBeforeNext");p(this,"consumedPoints");p(this,"isFirstInDuration");this.name="RateLimitError",this.remainingPoints=r.remainingPoints,this.msBeforeNext=r.msBeforeNext,this.consumedPoints=r.consumedPoints,this.isFirstInDuration=r.isFirstInDuration}}class Xw extends Error{constructor(t="The queue was full"){super(t),this.name="QueueFullError"}}p(Xw,"name","QueueFullError");class KP{constructor(t){p(this,"deferred");p(this,"signal");this.signal=t,this.deferred=bt(),this.onAbort=this.onAbort.bind(this),this.signal?.addEventListener("abort",this.onAbort)}onAbort(){this.deferred.reject(this.signal?.reason??new Ns)}cleanup(){this.signal?.removeEventListener("abort",this.onAbort)}}function YP(){return`${parseInt(String(Math.random()*1e9),10).toString()}${Date.now()}`}class QP{constructor(t,e){p(this,"id");p(this,"fn");p(this,"options");p(this,"recipients");p(this,"status");p(this,"timeline");p(this,"controller");this.id=YP(),this.status="queued",this.fn=t,this.options=e,this.recipients=[],this.timeline={created:Date.now()},this.controller=new AbortController,this.controller.signal,this.onAbort=this.onAbort.bind(this)}abort(t){this.controller.abort(t)}onAbort(){this.recipients.reduce((e,r)=>e&&r.signal?.aborted===!0,!0)&&(this.controller.abort(new Ns),this.cleanup())}async join(t={}){const e=new KP(t.signal);return this.recipients.push(e),t.signal?.addEventListener("abort",this.onAbort),e.deferred.promise}async run(){this.status="running",this.timeline.started=Date.now();try{this.controller.signal.throwIfAborted();const t=await Ir(this.fn({...this.options??{},signal:this.controller.signal}),this.controller.signal);this.recipients.forEach(e=>{e.deferred.resolve(t)}),this.status="complete"}catch(t){this.recipients.forEach(e=>{e.deferred.reject(t)}),this.status="errored"}finally{this.timeline.finished=Date.now(),this.cleanup()}}cleanup(){this.recipients.forEach(t=>{t.cleanup(),t.signal?.removeEventListener("abort",this.onAbort)})}}class Jw extends ar{constructor(e={}){super();p(this,"concurrency");p(this,"maxSize");p(this,"queue");p(this,"pending");p(this,"sort");this.concurrency=e.concurrency??Number.POSITIVE_INFINITY,this.maxSize=e.maxSize??Number.POSITIVE_INFINITY,this.pending=0,e.metricName!=null&&e.metrics?.registerMetricGroup(e.metricName,{calculate:()=>({size:this.queue.length,running:this.pending,queued:this.queue.length-this.pending})}),this.sort=e.sort,this.queue=[]}tryToStartAnother(){if(this.size===0)return queueMicrotask(()=>{this.safeDispatchEvent("empty")}),this.running===0&&queueMicrotask(()=>{this.safeDispatchEvent("idle")}),!1;if(this.pending<this.concurrency){let e;for(const r of this.queue)if(r.status==="queued"){e=r;break}return e==null?!1:(this.safeDispatchEvent("active"),this.pending++,e.run().finally(()=>{for(let r=0;r<this.queue.length;r++)if(this.queue[r]===e){this.queue.splice(r,1);break}this.pending--,this.tryToStartAnother(),this.safeDispatchEvent("next")}),!0)}return!1}enqueue(e){this.queue.push(e),this.sort!=null&&this.queue.sort(this.sort)}async add(e,r){if(r?.signal?.throwIfAborted(),this.size===this.maxSize)throw new Xw;const s=new QP(e,r);return this.enqueue(s),this.safeDispatchEvent("add"),this.tryToStartAnother(),s.join(r).then(i=>(this.safeDispatchEvent("completed",{detail:i}),this.safeDispatchEvent("success",{detail:{job:s,result:i}}),i)).catch(i=>{if(s.status==="queued"){for(let o=0;o<this.queue.length;o++)if(this.queue[o]===s){this.queue.splice(o,1);break}}throw this.safeDispatchEvent("error",{detail:i}),this.safeDispatchEvent("failure",{detail:{job:s,error:i}}),i})}clear(){this.queue.splice(0,this.queue.length)}abort(){this.queue.forEach(e=>{e.abort(new Ns)}),this.clear()}async onEmpty(e){this.size!==0&&await rc(this,"empty",e?.signal)}async onSizeLessThan(e,r){this.size<e||await rc(this,"next",r?.signal,{filter:()=>this.size<e})}async onIdle(e){this.pending===0&&this.size===0||await rc(this,"idle",e?.signal)}get size(){return this.queue.length}get queued(){return this.queue.length-this.pending}get running(){return this.pending}async*toGenerator(e){e?.signal?.throwIfAborted();const r=ds({objectMode:!0}),s=u=>{u!=null?this.abort():this.clear(),r.end(u)},i=u=>{u.detail!=null&&r.push(u.detail)},o=u=>{s(u.detail)},a=()=>{s()},l=()=>{s(new Ns("Queue aborted"))};this.addEventListener("completed",i),this.addEventListener("error",o),this.addEventListener("idle",a),e?.signal?.addEventListener("abort",l);try{yield*r}finally{this.removeEventListener("completed",i),this.removeEventListener("error",o),this.removeEventListener("idle",a),e?.signal?.removeEventListener("abort",l),s()}}}class Yf extends Jw{has(t){return this.find(t)!=null}find(t){return this.queue.find(e=>t.equals(e.options.peerId))}}class jP extends ar{constructor(e,r={}){super();p(this,"peerStore");p(this,"registrar");p(this,"connectionManager");p(this,"randomWalk");p(this,"started");p(this,"running");p(this,"topologyId");p(this,"log");p(this,"discoveryController");p(this,"filter");p(this,"queue");this.log=e.logger.forComponent("libp2p:circuit-relay:discover-relays"),this.started=!1,this.running=!1,this.peerStore=e.peerStore,this.registrar=e.registrar,this.connectionManager=e.connectionManager,this.randomWalk=e.randomWalk,this.filter=r.filter,this.discoveryController=new AbortController,this.discoveryController.signal}isStarted(){return this.started}async start(){this.topologyId=await this.registrar.register(Vc,{filter:this.filter,onConnect:e=>{this.log.trace("discovered relay %p queue (length: %d, active %d)",e,this.queue?.size,this.queue?.running),this.safeDispatchEvent("relay:discover",{detail:e})}}),this.started=!0}stop(){this.topologyId!=null&&this.registrar.unregister(this.topologyId),this.discoveryController?.abort(),this.started=!1}startDiscovery(){this.running||(this.log("start discovery"),this.running=!0,this.discoveryController=new AbortController,this.discoveryController.signal,Promise.resolve().then(async()=>{this.log("searching peer store for relays");const e=await this.peerStore.all({filters:[s=>s.protocols.includes(Vc)],orders:[()=>Math.random()<.5?1:-1,(s,i)=>{const o=$g(s),a=$g(i);return o>a?-1:a>o?1:0}]});for(const s of e)this.log.trace("found relay peer %p in peer store",s.id),this.safeDispatchEvent("relay:discover",{detail:s.id});this.log("found %d relay peers in peer store",e.length);const r=this.queue=new Yf({concurrency:5});this.log("start random walk");for await(const s of this.randomWalk.walk({signal:this.discoveryController.signal})){if(this.log.trace("found random peer %p",s.id),r.has(s.id)){this.log.trace("random peer %p was already in queue",s.id);continue}if(this.connectionManager.getConnections(s.id)?.length>0){this.log.trace("random peer %p was already connected",s.id);continue}if(!await this.connectionManager.isDialable(s.multiaddrs)){this.log.trace("random peer %p was not dialable",s.id,s.multiaddrs.map(i=>i.toString()));continue}r.queued>10&&(this.log.trace("wait for space in queue for %p",s.id),await r.onSizeLessThan(10,{signal:this.discoveryController.signal})),this.log("adding random peer %p to dial queue (length: %d, active %d)",s.id,r.size,r.running),r.add(async()=>{const i=Qi([this.discoveryController.signal,AbortSignal.timeout(5e3)]);try{await this.connectionManager.openConnection(s.id,{signal:i})}finally{i.clear()}},{peerId:s.id,signal:this.discoveryController.signal}).catch(i=>{this.log.error("error opening connection to random peer %p",s.id,i)})}this.log("stop random walk"),await r.onIdle()}).catch(e=>{this.discoveryController.signal.aborted||this.log.error("failed when finding relays on the network",e)}))}stopDiscovery(){this.log("stop discovery"),this.running=!1,this.discoveryController?.abort()}}function $g(n){const t=n.metadata.get("last-dial-success");return t==null?0:new Date(he(t)).getTime()}class ZP extends ar{constructor(e,r={}){super();p(this,"connectionManager");p(this,"addressManager");p(this,"reservationStore");p(this,"listeningAddrs");p(this,"log");p(this,"listenTimeout");p(this,"reservationId");p(this,"relay");p(this,"_onRemoveRelayPeer",e=>{this.log("relay removed %p our relay %p",e.detail.relay,this.relay,this.relay?.equals(e.detail.relay)),this.relay?.equals(e.detail.relay)===!0&&(this.log("relay peer removed %p",e.detail.relay),this.listeningAddrs.forEach(r=>{this.addressManager.removeObservedAddr(r)}),this.listeningAddrs=[],this.safeDispatchEvent("listening"))});p(this,"_onAddRelayPeer",e=>{const{details:r}=e.detail;r.type!=="configured"&&r.id===this.reservationId&&this.addedRelay(e.detail)});this.log=e.logger.forComponent("libp2p:circuit-relay:transport:listener"),this.connectionManager=e.connectionManager,this.addressManager=e.addressManager,this.reservationStore=e.reservationStore,this.listeningAddrs=[],this.listenTimeout=r.listenTimeout??Fw,this.reservationStore.addEventListener("relay:removed",this._onRemoveRelayPeer),this.reservationStore.addEventListener("relay:created-reservation",this._onAddRelayPeer)}async listen(e){if(Yw.exactMatch(e))this.log("searching for circuit relay servers"),this.reservationId=this.reservationStore.reserveRelay();else if(Kw.exactMatch(e)){this.log("listen on specific relay server %a",e);const r=AbortSignal.timeout(this.listenTimeout),s=e.decapsulate("/p2p-circuit"),i=await this.connectionManager.openConnection(s,{signal:r});if(!this.reservationStore.hasReservation(i.remotePeer)){this.log("making reservation on peer %p",i.remotePeer);const o=await this.reservationStore.addRelay(i.remotePeer,"configured");this.addedRelay(o)}}else throw new Ac(`Could not listen on p2p-circuit address "${e}"`)}getAddrs(){return[...this.listeningAddrs.values()].flat()}updateAnnounceAddrs(){}async close(){this.reservationStore.cancelReservations(),this.listeningAddrs=[],this.reservationStore.removeEventListener("relay:removed",this._onRemoveRelayPeer),queueMicrotask(()=>{this.safeDispatchEvent("close")})}addedRelay(e){this.log("relay peer added %p",e.relay),this.relay=e.relay,this.listeningAddrs=e.details.reservation.addrs.map(r=>me(r).encapsulate("/p2p-circuit")),this.listeningAddrs.forEach(r=>{this.addressManager.confirmObservedAddr(r,{type:"transport"})}),queueMicrotask(()=>{this.safeDispatchEvent("listening")})}}function XP(n){return new ZP(n)}const JP="useandom-26T198340PX75pxJACKVERYMINDBUSHWOLF_GQZbfghjklqvwyzrict";let eD=(n=21)=>{let t="",e=crypto.getRandomValues(new Uint8Array(n|=0));for(;n--;)t+=JP[e[n]&63];return t};const tD=60*1e3*10,nD=60*1e3*5,rD=30*1e3;var an,e0,Po,Do;class sD extends ar{constructor(e,r){super();_e(this,an);p(this,"peerId");p(this,"connectionManager");p(this,"peerStore");p(this,"events");p(this,"reserveQueue");p(this,"reservations");p(this,"pendingReservations");p(this,"maxReservationQueueLength");p(this,"reservationCompletionTimeout");p(this,"started");p(this,"log");p(this,"relayFilter");this.log=e.logger.forComponent("libp2p:circuit-relay:transport:reservation-store"),this.peerId=e.peerId,this.connectionManager=e.connectionManager,this.peerStore=e.peerStore,this.events=e.events,this.reservations=new Zl,this.pendingReservations=[],this.maxReservationQueueLength=r?.maxReservationQueueLength??_P,this.reservationCompletionTimeout=r?.reservationCompletionTimeout??Fw,this.started=!1,this.relayFilter=ia(100),this.reserveQueue=new Yf({concurrency:r?.reservationConcurrency??wP,metricName:"libp2p_relay_reservation_queue",metrics:e.metrics}),this.events.addEventListener("connection:close",s=>{[...this.reservations.values()].find(o=>o.connection===s.detail.id)!=null&&de(this,an,Po).call(this,s.detail.remotePeer).catch(o=>{this.log("could not remove relay %p - %e",s.detail,o)})})}isStarted(){return this.started}start(){this.started=!0}afterStart(){Promise.resolve().then(async()=>{const e=await this.peerStore.all({filters:[r=>r.tags.has(Ua)]});this.log("removing tag from %d old relays",e.length),await Promise.all(e.map(async r=>{await this.peerStore.merge(r.id,{tags:{[Ua]:void 0}})})),this.log("redialing %d old relays",e.length),await Promise.all(e.map(async r=>this.addRelay(r.id,"discovered"))),de(this,an,Do).call(this)}).catch(e=>{this.log.error(e)})}stop(){this.reserveQueue.clear(),this.reservations.forEach(({timeout:e})=>{clearTimeout(e)}),this.reservations.clear(),this.started=!1}reserveRelay(){const e=eD();return this.pendingReservations.push(e),de(this,an,Do).call(this),e}async addRelay(e,r){if(this.peerId.equals(e))throw this.log.trace("not trying to use self as relay"),new Ac("Cannot use self as relay");if(this.reserveQueue.size>this.maxReservationQueueLength)throw new Gw("The reservation queue is full");const s=this.reserveQueue.find(e);if(s!=null)return this.log.trace("potential relay peer %p is already in the reservation queue",e),s.join();if(this.relayFilter.has(e.toMultihash().bytes))throw new Ac("The relay was previously invalid");return this.log.trace("try to reserve relay slot with %p",e),this.reserveQueue.add(async()=>{const i=Date.now();try{const o=this.reservations.get(e);if(o!=null){const y=this.connectionManager.getConnections(e);let m=!1;if(y.length===0&&this.log("already have relay reservation with %p but we are no longer connected",e),y.map(v=>v.id).includes(o.connection)&&(this.log("already have relay reservation with %p and the original connection is still open",e),m=!0),m&&Ng(o.reservation.expire)>tD)return this.log("already have relay reservation with %p but we are still connected and it does not expire soon",e),{relay:e,details:o};await de(this,an,Po).call(this,e)}if(r==="discovered"&&this.pendingReservations.length===0)throw new th("Not making reservation on discovered relay because we do not need any more relays");const a=AbortSignal.timeout(this.reservationCompletionTimeout);const l=await this.connectionManager.openConnection(e,{signal:a});if(sa.matches(l.remoteAddr))throw new Ww("not creating reservation over relayed connection");const u=await de(this,an,e0).call(this,l,{signal:a}),h=Ng(u.expire);this.log("created reservation on relay peer %p, expiry date is %s",e,new Date(Date.now()+h).toString());const c=Math.min(Math.max(h-nD,rD),Math.pow(2,31)-1),d=setTimeout(()=>{this.log("refresh reservation to relay %p",e),this.addRelay(e,r).catch(async y=>{this.log.error("could not refresh reservation to relay %p - %e",e,y),await de(this,an,Po).call(this,e)}).catch(y=>{this.log.error("could not remove expired reservation to relay %p - %e",e,y)})},c);let f;if(r==="discovered"){const y=this.pendingReservations.pop();if(y==null)throw new th("Made reservation on relay but did not need any more discovered relays");f={timeout:d,reservation:u,type:r,connection:l.id,id:y}}else f={timeout:d,reservation:u,type:r,connection:l.id};this.reservations.set(e,f),await this.peerStore.merge(e,{tags:{[Ua]:{value:1,ttl:h}}}),de(this,an,Do).call(this);const g={relay:e,details:f};return this.safeDispatchEvent("relay:created-reservation",{detail:g}),g}catch(o){throw r==="discovered"&&o.name==="HadEnoughRelaysError"||this.log.error("could not reserve slot on %p after %dms - %e",e,Date.now()-i,o),(o.name==="DialError"||o.name==="UnsupportedProtocolError")&&this.relayFilter.add(e.toMultihash().bytes),de(this,an,Po).call(this,e).catch(a=>{this.log.error("could not remove reservation on %p after reserving slot failed - %e",e,a)}),o}},{peerId:e})}hasReservation(e){return this.reservations.has(e)}getReservation(e){return this.reservations.get(e)?.reservation}reservationCount(e){return e==null?this.reservations.size:[...this.reservations.values()].reduce((r,s)=>(s.type===e&&r++,r),0)}cancelReservations(){[...this.reservations.values()].forEach(e=>{clearTimeout(e.timeout)}),this.reservations.clear()}}an=new WeakSet,e0=async function(e,r){r.signal?.throwIfAborted(),this.log("requesting reservation from %p",e.remotePeer);const s=await e.newStream(Vc,r),o=Wi(s).pb(Gi);this.log.trace("send RESERVE to %p",e.remotePeer),await o.write({type:Gi.Type.RESERVE},r);let a;try{this.log.trace("reading response from %p",e.remotePeer),a=await o.read(r)}catch(u){throw s.abort(u),u}finally{s.status!=="closed"&&await s.close(r)}if(this.log.trace("read response %o",a),a.status===Kt.OK&&a.reservation!=null){const u=new Set;u.add(e.remoteAddr.toString());for(const h of a.reservation.addrs){let c=me(h);c.getPeerId()==null&&(c=c.encapsulate(`/p2p/${e.remotePeer}`)),c=me(c.toString().replace(`/p2p/${e.remotePeer}/p2p/${e.remotePeer}`,`/p2p/${e.remotePeer}`)),u.add(c.toString())}return a.reservation.addrs=[...u].map(h=>me(h).bytes),a.reservation}const l=`reservation failed with status ${a.status??"undefined"}`;throw this.log.error(l),new Error(l)},Po=async function(e){const r=this.reservations.get(e);r!=null&&(this.log("removing relay reservation with %p from local store",e),clearTimeout(r.timeout),this.reservations.delete(e),r.type==="discovered"&&this.pendingReservations.push(r.id),await this.peerStore.merge(e,{tags:{[Ua]:void 0}}),this.safeDispatchEvent("relay:removed",{detail:{relay:e,details:r}}),de(this,an,Do).call(this))},Do=function(){if(this.pendingReservations.length===0){this.log.trace("have discovered enough relays"),this.reserveQueue.clear(),this.safeDispatchEvent("relay:found-enough-relays");return}this.relayFilter=ia(100),this.log("not discovered enough relays %d/%d",this.reservations.size,this.pendingReservations.length),this.safeDispatchEvent("relay:not-enough-relays")};const iD=n=>{if(n.peer==null)return!1;try{n.peer.addrs.forEach(me)}catch{return!1}return!0},Ug={maxInboundStopStreams:Cg,maxOutboundStopStreams:Cg};var hy,fy,py,gy;class oD{constructor(t,e={}){p(this,"discovery");p(this,"registrar");p(this,"peerStore");p(this,"connectionManager");p(this,"transportManager");p(this,"peerId");p(this,"upgrader");p(this,"addressManager");p(this,"connectionGater");p(this,"reservationStore");p(this,"logger");p(this,"maxInboundStopStreams");p(this,"maxOutboundStopStreams");p(this,"started");p(this,"log");p(this,"shutdownController");p(this,gy,"@libp2p/circuit-relay-v2-transport");p(this,py,["@libp2p/transport","@libp2p/circuit-relay-v2-transport"]);p(this,hy,!0);this.log=t.logger.forComponent("libp2p:circuit-relay:transport"),this.registrar=t.registrar,this.peerStore=t.peerStore,this.connectionManager=t.connectionManager,this.transportManager=t.transportManager,this.logger=t.logger,this.peerId=t.peerId,this.upgrader=t.upgrader,this.addressManager=t.addressManager,this.connectionGater=t.connectionGater,this.maxInboundStopStreams=e.maxInboundStopStreams??Ug.maxInboundStopStreams,this.maxOutboundStopStreams=e.maxOutboundStopStreams??Ug.maxOutboundStopStreams,this.shutdownController=new AbortController,this.discovery=new jP(t,{filter:e.discoveryFilter??qP(SP,EP)}),this.discovery.addEventListener("relay:discover",r=>{this.reservationStore.addRelay(r.detail,"discovered").catch(s=>{s.name!=="HadEnoughRelaysError"&&s.name!=="RelayQueueFullError"&&this.log.error("could not add discovered relay %p",r.detail,s)})}),this.reservationStore=new sD(t,e),this.reservationStore.addEventListener("relay:not-enough-relays",()=>{this.discovery?.startDiscovery()}),this.reservationStore.addEventListener("relay:found-enough-relays",()=>{this.discovery?.stopDiscovery()}),this.started=!1}get[(gy=Symbol.toStringTag,py=Wn,fy=xc,hy=tb,fy)](){return this.discovery!=null?["@libp2p/identify"]:[]}isStarted(){return this.started}async start(){this.shutdownController=new AbortController,await this.registrar.handle(Tg,t=>{const e=this.upgrader.createInboundAbortSignal(this.shutdownController.signal);this.onStop(t,e).catch(r=>{this.log.error("error while handling STOP protocol",r),t.stream.abort(r)}).finally(()=>{e.clear()})},{maxInboundStreams:this.maxInboundStopStreams,maxOutboundStreams:this.maxOutboundStopStreams,runOnLimitedConnection:!0}),await ub(this.discovery,this.reservationStore),this.started=!0}async stop(){this.shutdownController.abort(),await db(this.discovery,this.reservationStore),await this.registrar.unhandle(Tg),this.started=!1}async dial(t,e){if(t.protoCodes().filter(f=>f===bP).length!==1){const f="Invalid circuit relay address";throw this.log.error(f,t),new Ei(f)}const r=t.toString().split("/p2p-circuit"),s=me(r[0]),i=me(r[r.length-1]),o=s.getPeerId(),a=i.getPeerId();if(o==null||a==null){const f=`ircuit relay dial to ${t.toString()} failed as address did not have both relay and destination PeerIDs`;throw this.log.error(`c${f}`),new Ei(`C${f}`)}const l=Bt(o),u=Bt(a);let c=this.connectionManager.getConnections(l)[0];c==null?(await this.peerStore.merge(l,{multiaddrs:[s]}),e.onProgress?.(new vt("circuit-relay:open-connection")),c=await this.connectionManager.openConnection(l,e)):e.onProgress?.(new vt("circuit-relay:reuse-connection"));let d;try{e.onProgress?.(new vt("circuit-relay:open-hop-stream")),d=await c.newStream(Vc,e);const f=Wi(d),g=f.pb(Gi);e.onProgress?.(new vt("circuit-relay:write-connect-message")),await g.write({type:Gi.Type.CONNECT,peer:{id:u.toMultihash().bytes,addrs:[me(i).bytes]}},e),e.onProgress?.(new vt("circuit-relay:read-connect-response"));const y=await g.read(e);if(y.status!==Kt.OK)throw new Xn(`failed to connect via relay with status ${y?.status?.toString()??"undefined"}`);const m=new Rg(y.limit),v=Fg({stream:f.unwrap(),remoteAddr:t,localAddr:s.encapsulate(`/p2p-circuit/p2p/${this.peerId.toString()}`),logger:this.logger,onDataRead:m.onData,onDataWrite:m.onData});return this.log("new outbound relayed connection %a",v.remoteAddr),await this.upgrader.upgradeOutbound(v,{...e,limits:m.getLimits()})}catch(f){throw this.log.error("circuit relay dial to destination %p via relay %p failed",u,l,f),d?.abort(f),f}}createListener(t){return XP({peerId:this.peerId,connectionManager:this.connectionManager,addressManager:this.addressManager,reservationStore:this.reservationStore,logger:this.logger})}listenFilter(t){return t=Array.isArray(t)?t:[t],t.filter(e=>Kw.exactMatch(e)||Yw.exactMatch(e))}dialFilter(t){return t=Array.isArray(t)?t:[t],t.filter(e=>sa.exactMatch(e))}async onStop({connection:t,stream:e},r){if(!this.reservationStore.hasReservation(t.remotePeer))try{this.log("dialed via relay we did not have a reservation on, start listening on that relay address"),await this.transportManager.listen([t.remoteAddr.encapsulate("/p2p-circuit")])}catch(h){this.log.error("failed to listen on a relay peer we were dialed via but did not have a reservation on",h)}const s=Wi(e).pb(mr),i=await s.read({signal:r});if(this.log("new circuit relay v2 stop stream from %p with type %s",t.remotePeer,i.type),i?.type===void 0){this.log.error("type was missing from circuit v2 stop protocol request from %s",t.remotePeer),await s.write({type:mr.Type.STATUS,status:Kt.MALFORMED_MESSAGE},{signal:r}),await e.close();return}if(i.type!==mr.Type.CONNECT){this.log.error("invalid stop connect request via peer %p",t.remotePeer),await s.write({type:mr.Type.STATUS,status:Kt.UNEXPECTED_MESSAGE},{signal:r}),await e.close();return}if(!iD(i)){this.log.error("invalid stop connect request via peer %p",t.remotePeer),await s.write({type:mr.Type.STATUS,status:Kt.MALFORMED_MESSAGE},{signal:r}),await e.close({signal:r});return}const o=Zs($r(i.peer.id));if(await this.connectionGater.denyInboundRelayedConnection?.(t.remotePeer,o)===!0){this.log.error("connection gater denied inbound relayed connection from %p",t.remotePeer),await s.write({type:mr.Type.STATUS,status:Kt.PERMISSION_DENIED},{signal:r}),await e.close({signal:r});return}this.log.trace("sending success response to %p",t.remotePeer),await s.write({type:mr.Type.STATUS,status:Kt.OK},{signal:r});const a=new Rg(i.limit),l=t.remoteAddr.encapsulate(`/p2p-circuit/p2p/${o.toString()}`);this.addressManager.getAddresses()[0];const u=Fg({stream:s.unwrap().unwrap(),remoteAddr:l,logger:this.logger,onDataRead:a.onData,onDataWrite:a.onData});this.log("new inbound relayed connection %a",u.remoteAddr),await this.upgrader.upgradeInbound(u,{limits:a.getLimits(),signal:r}),this.log("%s connection %a upgraded","inbound",u.remoteAddr)}}function aD(n={}){return t=>new oD(t,n)}const pr="/",t0=new TextEncoder().encode(pr),Ha=t0[0];class ut{constructor(t,e){p(this,"_buf");if(typeof t=="string")this._buf=te(t);else if(t instanceof Uint8Array)this._buf=t;else throw new Error("Invalid key, should be String of Uint8Array");if(e==null&&(e=!0),e&&this.clean(),this._buf.byteLength===0||this._buf[0]!==Ha)throw new Error("Invalid key")}toString(t="utf8"){return he(this._buf,t)}uint8Array(){return this._buf}get[Symbol.toStringTag](){return`Key(${this.toString()})`}static withNamespaces(t){return new ut(t.join(pr))}static random(){return new ut(Math.random().toString().substring(2))}static asKey(t){return t instanceof Uint8Array||typeof t=="string"?new ut(t):typeof t.uint8Array=="function"?new ut(t.uint8Array()):null}clean(){if((this._buf==null||this._buf.byteLength===0)&&(this._buf=t0),this._buf[0]!==Ha){const t=new Uint8Array(this._buf.byteLength+1);t.fill(Ha,0,1),t.set(this._buf,1),this._buf=t}for(;this._buf.byteLength>1&&this._buf[this._buf.byteLength-1]===Ha;)this._buf=this._buf.subarray(0,-1)}less(t){const e=this.list(),r=t.list();for(let s=0;s<e.length;s++){if(r.length<s+1)return!1;const i=e[s],o=r[s];if(i<o)return!0;if(i>o)return!1}return e.length<r.length}reverse(){return ut.withNamespaces(this.list().slice().reverse())}namespaces(){return this.list()}baseNamespace(){const t=this.namespaces();return t[t.length-1]}list(){return this.toString().split(pr).slice(1)}type(){return cD(this.baseNamespace())}name(){return lD(this.baseNamespace())}instance(t){return new ut(this.toString()+":"+t)}path(){let t=this.parent().toString();return t.endsWith(pr)||(t+=pr),t+=this.type(),new ut(t)}parent(){const t=this.list();return t.length===1?new ut(pr):new ut(t.slice(0,-1).join(pr))}child(t){return this.toString()===pr?t:t.toString()===pr?this:new ut(this.toString()+t.toString(),!1)}isAncestorOf(t){return t.toString()===this.toString()?!1:t.toString().startsWith(this.toString())}isDecendantOf(t){return t.toString()===this.toString()?!1:this.toString().startsWith(t.toString())}isTopLevel(){return this.list().length===1}concat(...t){return ut.withNamespaces([...this.namespaces(),...uD(t.map(e=>e.namespaces()))])}}function cD(n){const t=n.split(":");return t.length<2?"":t.slice(0,-1).join(":")}function lD(n){const t=n.split(":");return t[t.length-1]}function uD(n){return[].concat(...n)}var Mu,Vg;function dD(){return Vg||(Vg=1,Mu=n=>{if(Object.prototype.toString.call(n)!=="[object Object]")return!1;const t=Object.getPrototypeOf(n);return t===null||t===Object.prototype}),Mu}var za,Hg;function hD(){if(Hg)return za;Hg=1;const n=dD(),{hasOwnProperty:t}=Object.prototype,{propertyIsEnumerable:e}=Object,r=(f,g,y)=>Object.defineProperty(f,g,{value:y,writable:!0,enumerable:!0,configurable:!0}),s=za,i={concatArrays:!1,ignoreUndefined:!1},o=f=>{const g=[];for(const y in f)t.call(f,y)&&g.push(y);if(Object.getOwnPropertySymbols){const y=Object.getOwnPropertySymbols(f);for(const m of y)e.call(f,m)&&g.push(m)}return g};function a(f){return Array.isArray(f)?l(f):n(f)?u(f):f}function l(f){const g=f.slice(0,0);return o(f).forEach(y=>{r(g,y,a(f[y]))}),g}function u(f){const g=Object.getPrototypeOf(f)===null?Object.create(null):{};return o(f).forEach(y=>{r(g,y,a(f[y]))}),g}const h=(f,g,y,m)=>(y.forEach(v=>{typeof g[v]>"u"&&m.ignoreUndefined||(v in f&&f[v]!==Object.getPrototypeOf(f)?r(f,v,d(f[v],g[v],m)):r(f,v,a(g[v])))}),f),c=(f,g,y)=>{let m=f.slice(0,0),v=0;return[f,g].forEach(_=>{const w=[];for(let S=0;S<_.length;S++)t.call(_,S)&&(w.push(String(S)),_===f?r(m,v++,_[S]):r(m,v++,a(_[S])));m=h(m,_,o(_).filter(S=>!w.includes(S)),y)}),m};function d(f,g,y){return y.concatArrays&&Array.isArray(f)&&Array.isArray(g)?c(f,g,y):!n(g)||!n(f)?a(g):h(f,g,o(g),y)}return za=function(...f){const g=d(a(i),this!==s&&this||{},i);let y={_:{}};for(const m of f)if(m!==void 0){if(!n(m))throw new TypeError("`"+m+"` is not an Option Object");y=d(y,{_:m},g)}return y._},za}var fD=hD();const Qf=ao(fD);var Lu,zg;function pD(){if(zg)return Lu;zg=1;function n(e){return e>=55296&&e<=56319}function t(e){return e>=56320&&e<=57343}return Lu=function(r,s,i){if(typeof s!="string")throw new Error("Input must be string");for(var o=s.length,a=0,l,u,h=0;h<o;h+=1){if(l=s.charCodeAt(h),u=s[h],n(l)&&t(s.charCodeAt(h+1))&&(h+=1,u+=s[h]),a+=r(u),a===i)return s.slice(0,h+1);if(a>i)return s.slice(0,h-u.length+1)}return s},Lu}var Bu,qg;function gD(){if(qg)return Bu;qg=1;function n(e){return e>=55296&&e<=56319}function t(e){return e>=56320&&e<=57343}return Bu=function(r){if(typeof r!="string")throw new Error("Input must be string");for(var s=r.length,i=0,o=null,a=null,l=0;l<s;l++)o=r.charCodeAt(l),t(o)?a!=null&&n(a)?i+=1:i+=3:o<=127?i+=1:o>=128&&o<=2047?i+=2:o>=2048&&o<=65535&&(i+=3),a=o;return i},Bu}var Nu,Wg;function mD(){if(Wg)return Nu;Wg=1;var n=pD(),t=gD();return Nu=n.bind(null,t),Nu}var Ru,Gg;function yD(){if(Gg)return Ru;Gg=1;var n=mD(),t=/[\/\?<>\\:\*\|"]/g,e=/[\x00-\x1f\x80-\x9f]/g,r=/^\.+$/,s=/^(con|prn|aux|nul|com[0-9]|lpt[0-9])(\..*)?$/i,i=/[\. ]+$/;function o(a,l){if(typeof a!="string")throw new Error("Input must be string");var u=a.replace(t,l).replace(e,l).replace(r,l).replace(s,l).replace(i,l);return n(u,255)}return Ru=function(a,l){var u=l&&l.replacement||"",h=o(a,u);return u===""?h:o(h,"")},Ru}var vD=yD();const bD=ao(vD),Ou={alg:"A128GCM",ext:!0,k:"scm9jmO_4BJAgdwWGVulLg",key_ops:["encrypt","decrypt"],kty:"oct"};function n0(n){const t="AES-GCM";let e=16;const r=12,s="SHA-256",i=16,o=32767,a=lr.get();e*=8;async function l(c,d){const f=a.getRandomValues(new Uint8Array(i)),g=a.getRandomValues(new Uint8Array(r)),y={name:t,iv:g};typeof d=="string"&&(d=te(d));let m;if(d.length===0){m=await a.subtle.importKey("jwk",Ou,{name:"AES-GCM"},!0,["encrypt"]);try{const _={name:"PBKDF2",salt:f,iterations:o,hash:{name:s}},w=await a.subtle.importKey("raw",d,{name:"PBKDF2"},!1,["deriveKey"]);m=await a.subtle.deriveKey(_,w,{name:t,length:e},!0,["encrypt"])}catch{m=await a.subtle.importKey("jwk",Ou,{name:"AES-GCM"},!0,["encrypt"])}}else{const _={name:"PBKDF2",salt:f,iterations:o,hash:{name:s}},w=await a.subtle.importKey("raw",d,{name:"PBKDF2"},!1,["deriveKey"]);m=await a.subtle.deriveKey(_,w,{name:t,length:e},!0,["encrypt"])}const v=await a.subtle.encrypt(y,m,c);return bn([f,y.iv,new Uint8Array(v)])}async function u(c,d){const f=c.subarray(0,i),g=c.subarray(i,i+r),y=c.subarray(i+r),m={name:t,iv:g};typeof d=="string"&&(d=te(d));let v;if(d.length===0)try{const w={name:"PBKDF2",salt:f,iterations:o,hash:{name:s}},S=await a.subtle.importKey("raw",d,{name:"PBKDF2"},!1,["deriveKey"]);v=await a.subtle.deriveKey(w,S,{name:t,length:e},!0,["decrypt"])}catch{v=await a.subtle.importKey("jwk",Ou,{name:"AES-GCM"},!0,["decrypt"])}else{const w={name:"PBKDF2",salt:f,iterations:o,hash:{name:s}},S=await a.subtle.importKey("raw",d,{name:"PBKDF2"},!1,["deriveKey"]);v=await a.subtle.deriveKey(w,S,{name:t,length:e},!0,["decrypt"])}const _=await a.subtle.decrypt(m,v,y);return new Uint8Array(_)}return{encrypt:l,decrypt:u}}/*!
 * MIT License
 * 
 * Copyright (c) 2017-2024 Peculiar Ventures, LLC
 * 
 * Permission is hereby granted, free of charge, to any person obtaining a copy
 * of this software and associated documentation files (the "Software"), to deal
 * in the Software without restriction, including without limitation the rights
 * to use, copy, modify, merge, publish, distribute, sublicense, and/or sell
 * copies of the Software, and to permit persons to whom the Software is
 * furnished to do so, subject to the following conditions:
 * 
 * The above copyright notice and this permission notice shall be included in all
 * copies or substantial portions of the Software.
 * 
 * THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR
 * IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,
 * FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE
 * AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER
 * LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,
 * OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN THE
 * SOFTWARE.
 * 
 */const wD="[object ArrayBuffer]";class ze{static isArrayBuffer(t){return Object.prototype.toString.call(t)===wD}static toArrayBuffer(t){return this.isArrayBuffer(t)?t:t.byteLength===t.buffer.byteLength||t.byteOffset===0&&t.byteLength===t.buffer.byteLength?t.buffer:this.toUint8Array(t.buffer).slice(t.byteOffset,t.byteOffset+t.byteLength).buffer}static toUint8Array(t){return this.toView(t,Uint8Array)}static toView(t,e){if(t.constructor===e)return t;if(this.isArrayBuffer(t))return new e(t);if(this.isArrayBufferView(t))return new e(t.buffer,t.byteOffset,t.byteLength);throw new TypeError("The provided value is not of type '(ArrayBuffer or ArrayBufferView)'")}static isBufferSource(t){return this.isArrayBufferView(t)||this.isArrayBuffer(t)}static isArrayBufferView(t){return ArrayBuffer.isView(t)||t&&this.isArrayBuffer(t.buffer)}static isEqual(t,e){const r=ze.toUint8Array(t),s=ze.toUint8Array(e);if(r.length!==s.byteLength)return!1;for(let i=0;i<r.length;i++)if(r[i]!==s[i])return!1;return!0}static concat(...t){let e;Array.isArray(t[0])&&!(t[1]instanceof Function)||Array.isArray(t[0])&&t[1]instanceof Function?e=t[0]:t[t.length-1]instanceof Function?e=t.slice(0,t.length-1):e=t;let r=0;for(const o of e)r+=o.byteLength;const s=new Uint8Array(r);let i=0;for(const o of e){const a=this.toUint8Array(o);s.set(a,i),i+=a.length}return t[t.length-1]instanceof Function?this.toView(s,t[t.length-1]):s.buffer}}const Fu="string",_D=/^[0-9a-f\s]+$/i,SD=/^(?:[A-Za-z0-9+/]{4})*(?:[A-Za-z0-9+/]{2}==|[A-Za-z0-9+/]{3}=)?$/,ED=/^[a-zA-Z0-9-_]+$/;class Kg{static fromString(t){const e=unescape(encodeURIComponent(t)),r=new Uint8Array(e.length);for(let s=0;s<e.length;s++)r[s]=e.charCodeAt(s);return r.buffer}static toString(t){const e=ze.toUint8Array(t);let r="";for(let i=0;i<e.length;i++)r+=String.fromCharCode(e[i]);return decodeURIComponent(escape(r))}}class Qn{static toString(t,e=!1){const r=ze.toArrayBuffer(t),s=new DataView(r);let i="";for(let o=0;o<r.byteLength;o+=2){const a=s.getUint16(o,e);i+=String.fromCharCode(a)}return i}static fromString(t,e=!1){const r=new ArrayBuffer(t.length*2),s=new DataView(r);for(let i=0;i<t.length;i++)s.setUint16(i*2,t.charCodeAt(i),e);return r}}class rt{static isHex(t){return typeof t===Fu&&_D.test(t)}static isBase64(t){return typeof t===Fu&&SD.test(t)}static isBase64Url(t){return typeof t===Fu&&ED.test(t)}static ToString(t,e="utf8"){const r=ze.toUint8Array(t);switch(e.toLowerCase()){case"utf8":return this.ToUtf8String(r);case"binary":return this.ToBinary(r);case"hex":return this.ToHex(r);case"base64":return this.ToBase64(r);case"base64url":return this.ToBase64Url(r);case"utf16le":return Qn.toString(r,!0);case"utf16":case"utf16be":return Qn.toString(r);default:throw new Error(`Unknown type of encoding '${e}'`)}}static FromString(t,e="utf8"){if(!t)return new ArrayBuffer(0);switch(e.toLowerCase()){case"utf8":return this.FromUtf8String(t);case"binary":return this.FromBinary(t);case"hex":return this.FromHex(t);case"base64":return this.FromBase64(t);case"base64url":return this.FromBase64Url(t);case"utf16le":return Qn.fromString(t,!0);case"utf16":case"utf16be":return Qn.fromString(t);default:throw new Error(`Unknown type of encoding '${e}'`)}}static ToBase64(t){const e=ze.toUint8Array(t);if(typeof btoa<"u"){const r=this.ToString(e,"binary");return btoa(r)}else return Buffer.from(e).toString("base64")}static FromBase64(t){const e=this.formatString(t);if(!e)return new ArrayBuffer(0);if(!rt.isBase64(e))throw new TypeError("Argument 'base64Text' is not Base64 encoded");return typeof atob<"u"?this.FromBinary(atob(e)):new Uint8Array(Buffer.from(e,"base64")).buffer}static FromBase64Url(t){const e=this.formatString(t);if(!e)return new ArrayBuffer(0);if(!rt.isBase64Url(e))throw new TypeError("Argument 'base64url' is not Base64Url encoded");return this.FromBase64(this.Base64Padding(e.replace(/\-/g,"+").replace(/\_/g,"/")))}static ToBase64Url(t){return this.ToBase64(t).replace(/\+/g,"-").replace(/\//g,"_").replace(/\=/g,"")}static FromUtf8String(t,e=rt.DEFAULT_UTF8_ENCODING){switch(e){case"ascii":return this.FromBinary(t);case"utf8":return Kg.fromString(t);case"utf16":case"utf16be":return Qn.fromString(t);case"utf16le":case"usc2":return Qn.fromString(t,!0);default:throw new Error(`Unknown type of encoding '${e}'`)}}static ToUtf8String(t,e=rt.DEFAULT_UTF8_ENCODING){switch(e){case"ascii":return this.ToBinary(t);case"utf8":return Kg.toString(t);case"utf16":case"utf16be":return Qn.toString(t);case"utf16le":case"usc2":return Qn.toString(t,!0);default:throw new Error(`Unknown type of encoding '${e}'`)}}static FromBinary(t){const e=t.length,r=new Uint8Array(e);for(let s=0;s<e;s++)r[s]=t.charCodeAt(s);return r.buffer}static ToBinary(t){const e=ze.toUint8Array(t);let r="";for(let s=0;s<e.length;s++)r+=String.fromCharCode(e[s]);return r}static ToHex(t){const e=ze.toUint8Array(t);let r="";const s=e.length;for(let i=0;i<s;i++){const o=e[i];o<16&&(r+="0"),r+=o.toString(16)}return r}static FromHex(t){let e=this.formatString(t);if(!e)return new ArrayBuffer(0);if(!rt.isHex(e))throw new TypeError("Argument 'hexString' is not HEX encoded");e.length%2&&(e=`0${e}`);const r=new Uint8Array(e.length/2);for(let s=0;s<e.length;s=s+2){const i=e.slice(s,s+2);r[s/2]=parseInt(i,16)}return r.buffer}static ToUtf16String(t,e=!1){return Qn.toString(t,e)}static FromUtf16String(t,e=!1){return Qn.fromString(t,e)}static Base64Padding(t){const e=4-t.length%4;if(e<4)for(let r=0;r<e;r++)t+="=";return t}static formatString(t){return t?.replace(/[\n\r\t ]/g,"")||""}}rt.DEFAULT_UTF8_ENCODING="utf8";/*!
 Copyright (c) Peculiar Ventures, LLC
*/function ji(n,t){let e=0;if(n.length===1)return n[0];for(let r=n.length-1;r>=0;r--)e+=n[n.length-1-r]*Math.pow(2,t*r);return e}function zs(n,t,e=-1){const r=e;let s=n,i=0,o=Math.pow(2,t);for(let a=1;a<8;a++){if(n<o){let l;if(r<0)l=new ArrayBuffer(a),i=a;else{if(r<a)return new ArrayBuffer(0);l=new ArrayBuffer(r),i=r}const u=new Uint8Array(l);for(let h=a-1;h>=0;h--){const c=Math.pow(2,h*t);u[i-h-1]=Math.floor(s/c),s-=u[i-h-1]*c}return l}o*=Math.pow(2,t)}return new ArrayBuffer(0)}function nh(...n){let t=0,e=0;for(const i of n)t+=i.length;const r=new ArrayBuffer(t),s=new Uint8Array(r);for(const i of n)s.set(i,e),e+=i.length;return s}function r0(){const n=new Uint8Array(this.valueHex);if(this.valueHex.byteLength>=2){const a=n[0]===255&&n[1]&128,l=n[0]===0&&(n[1]&128)===0;(a||l)&&this.warnings.push("Needlessly long format")}const t=new ArrayBuffer(this.valueHex.byteLength),e=new Uint8Array(t);for(let a=0;a<this.valueHex.byteLength;a++)e[a]=0;e[0]=n[0]&128;const r=ji(e,8),s=new ArrayBuffer(this.valueHex.byteLength),i=new Uint8Array(s);for(let a=0;a<this.valueHex.byteLength;a++)i[a]=n[a];return i[0]&=127,ji(i,8)-r}function AD(n){const t=n<0?n*-1:n;let e=128;for(let r=1;r<8;r++){if(t<=e){if(n<0){const o=e-t,a=zs(o,8,r),l=new Uint8Array(a);return l[0]|=128,a}let s=zs(t,8,r),i=new Uint8Array(s);if(i[0]&128){const o=s.slice(0),a=new Uint8Array(o);s=new ArrayBuffer(s.byteLength+1),i=new Uint8Array(s);for(let l=0;l<o.byteLength;l++)i[l+1]=a[l];i[0]=0}return s}e*=Math.pow(2,8)}return new ArrayBuffer(0)}function xD(n,t){if(n.byteLength!==t.byteLength)return!1;const e=new Uint8Array(n),r=new Uint8Array(t);for(let s=0;s<e.length;s++)if(e[s]!==r[s])return!1;return!0}function pn(n,t){const e=n.toString(10);if(t<e.length)return"";const r=t-e.length,s=new Array(r);for(let o=0;o<r;o++)s[o]="0";return s.join("").concat(e)}/*!
 * Copyright (c) 2014, GMO GlobalSign
 * Copyright (c) 2015-2022, Peculiar Ventures
 * All rights reserved.
 * 
 * Author 2014-2019, Yury Strozhevsky
 * 
 * Redistribution and use in source and binary forms, with or without modification,
 * are permitted provided that the following conditions are met:
 * 
 * * Redistributions of source code must retain the above copyright notice, this
 *   list of conditions and the following disclaimer.
 * 
 * * Redistributions in binary form must reproduce the above copyright notice, this
 *   list of conditions and the following disclaimer in the documentation and/or
 *   other materials provided with the distribution.
 * 
 * * Neither the name of the copyright holder nor the names of its
 *   contributors may be used to endorse or promote products derived from
 *   this software without specific prior written permission.
 * 
 * THIS SOFTWARE IS PROVIDED BY THE COPYRIGHT HOLDERS AND CONTRIBUTORS "AS IS" AND
 * ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE IMPLIED
 * WARRANTIES OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE ARE
 * DISCLAIMED. IN NO EVENT SHALL THE COPYRIGHT HOLDER OR CONTRIBUTORS BE LIABLE FOR
 * ANY DIRECT, INDIRECT, INCIDENTAL, SPECIAL, EXEMPLARY, OR CONSEQUENTIAL DAMAGES
 * (INCLUDING, BUT NOT LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS OR SERVICES;
 * LOSS OF USE, DATA, OR PROFITS; OR BUSINESS INTERRUPTION) HOWEVER CAUSED AND ON
 * ANY THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT LIABILITY, OR TORT
 * (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY OUT OF THE USE OF THIS
 * SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF SUCH DAMAGE.
 * 
 */function jc(){if(typeof BigInt>"u")throw new Error("BigInt is not defined. Your environment doesn't implement BigInt.")}function jf(n){let t=0,e=0;for(let s=0;s<n.length;s++){const i=n[s];t+=i.byteLength}const r=new Uint8Array(t);for(let s=0;s<n.length;s++){const i=n[s];r.set(new Uint8Array(i),e),e+=i.byteLength}return r.buffer}function Ur(n,t,e,r){return t instanceof Uint8Array?t.byteLength?e<0?(n.error="Wrong parameter: inputOffset less than zero",!1):r<0?(n.error="Wrong parameter: inputLength less than zero",!1):t.byteLength-e-r<0?(n.error="End of input reached before message was fully decoded (inconsistent offset and length values)",!1):!0:(n.error="Wrong parameter: inputBuffer has zero length",!1):(n.error="Wrong parameter: inputBuffer must be 'Uint8Array'",!1)}class Zf{constructor(){this.items=[]}write(t){this.items.push(t)}final(){return jf(this.items)}}const Ao=[new Uint8Array([1])],Yg="0123456789",ho="",Gn=new ArrayBuffer(0),Xf=new Uint8Array(0),oa="EndOfContent",s0="OCTET STRING",i0="BIT STRING";function Vr(n){var t;return t=class extends n{constructor(...r){var s;super(...r);const i=r[0]||{};this.isHexOnly=(s=i.isHexOnly)!==null&&s!==void 0?s:!1,this.valueHexView=i.valueHex?ze.toUint8Array(i.valueHex):Xf}get valueHex(){return this.valueHexView.slice().buffer}set valueHex(r){this.valueHexView=new Uint8Array(r)}fromBER(r,s,i){const o=r instanceof ArrayBuffer?new Uint8Array(r):r;if(!Ur(this,o,s,i))return-1;const a=s+i;return this.valueHexView=o.subarray(s,a),this.valueHexView.length?(this.blockLength=i,a):(this.warnings.push("Zero buffer length"),s)}toBER(r=!1){return this.isHexOnly?r?new ArrayBuffer(this.valueHexView.byteLength):this.valueHexView.byteLength===this.valueHexView.buffer.byteLength?this.valueHexView.buffer:this.valueHexView.slice().buffer:(this.error="Flag 'isHexOnly' is not set, abort",Gn)}toJSON(){return{...super.toJSON(),isHexOnly:this.isHexOnly,valueHex:rt.ToHex(this.valueHexView)}}},t.NAME="hexBlock",t}class Xs{constructor({blockLength:t=0,error:e=ho,warnings:r=[],valueBeforeDecode:s=Xf}={}){this.blockLength=t,this.error=e,this.warnings=r,this.valueBeforeDecodeView=ze.toUint8Array(s)}static blockName(){return this.NAME}get valueBeforeDecode(){return this.valueBeforeDecodeView.slice().buffer}set valueBeforeDecode(t){this.valueBeforeDecodeView=new Uint8Array(t)}toJSON(){return{blockName:this.constructor.NAME,blockLength:this.blockLength,error:this.error,warnings:this.warnings,valueBeforeDecode:rt.ToHex(this.valueBeforeDecodeView)}}}Xs.NAME="baseBlock";class un extends Xs{fromBER(t,e,r){throw TypeError("User need to make a specific function in a class which extends 'ValueBlock'")}toBER(t,e){throw TypeError("User need to make a specific function in a class which extends 'ValueBlock'")}}un.NAME="valueBlock";class o0 extends Vr(Xs){constructor({idBlock:t={}}={}){var e,r,s,i;super(),t?(this.isHexOnly=(e=t.isHexOnly)!==null&&e!==void 0?e:!1,this.valueHexView=t.valueHex?ze.toUint8Array(t.valueHex):Xf,this.tagClass=(r=t.tagClass)!==null&&r!==void 0?r:-1,this.tagNumber=(s=t.tagNumber)!==null&&s!==void 0?s:-1,this.isConstructed=(i=t.isConstructed)!==null&&i!==void 0?i:!1):(this.tagClass=-1,this.tagNumber=-1,this.isConstructed=!1)}toBER(t=!1){let e=0;switch(this.tagClass){case 1:e|=0;break;case 2:e|=64;break;case 3:e|=128;break;case 4:e|=192;break;default:return this.error="Unknown tag class",Gn}if(this.isConstructed&&(e|=32),this.tagNumber<31&&!this.isHexOnly){const s=new Uint8Array(1);if(!t){let i=this.tagNumber;i&=31,e|=i,s[0]=e}return s.buffer}if(!this.isHexOnly){const s=zs(this.tagNumber,7),i=new Uint8Array(s),o=s.byteLength,a=new Uint8Array(o+1);if(a[0]=e|31,!t){for(let l=0;l<o-1;l++)a[l+1]=i[l]|128;a[o]=i[o-1]}return a.buffer}const r=new Uint8Array(this.valueHexView.byteLength+1);if(r[0]=e|31,!t){const s=this.valueHexView;for(let i=0;i<s.length-1;i++)r[i+1]=s[i]|128;r[this.valueHexView.byteLength]=s[s.length-1]}return r.buffer}fromBER(t,e,r){const s=ze.toUint8Array(t);if(!Ur(this,s,e,r))return-1;const i=s.subarray(e,e+r);if(i.length===0)return this.error="Zero buffer length",-1;switch(i[0]&192){case 0:this.tagClass=1;break;case 64:this.tagClass=2;break;case 128:this.tagClass=3;break;case 192:this.tagClass=4;break;default:return this.error="Unknown tag class",-1}this.isConstructed=(i[0]&32)===32,this.isHexOnly=!1;const a=i[0]&31;if(a!==31)this.tagNumber=a,this.blockLength=1;else{let l=1,u=this.valueHexView=new Uint8Array(255),h=255;for(;i[l]&128;){if(u[l-1]=i[l]&127,l++,l>=i.length)return this.error="End of input reached before message was fully decoded",-1;if(l===h){h+=255;const d=new Uint8Array(h);for(let f=0;f<u.length;f++)d[f]=u[f];u=this.valueHexView=new Uint8Array(h)}}this.blockLength=l+1,u[l-1]=i[l]&127;const c=new Uint8Array(l);for(let d=0;d<l;d++)c[d]=u[d];u=this.valueHexView=new Uint8Array(l),u.set(c),this.blockLength<=9?this.tagNumber=ji(u,7):(this.isHexOnly=!0,this.warnings.push("Tag too long, represented as hex-coded"))}if(this.tagClass===1&&this.isConstructed)switch(this.tagNumber){case 1:case 2:case 5:case 6:case 9:case 13:case 14:case 23:case 24:case 31:case 32:case 33:case 34:return this.error="Constructed encoding used for primitive type",-1}return e+this.blockLength}toJSON(){return{...super.toJSON(),tagClass:this.tagClass,tagNumber:this.tagNumber,isConstructed:this.isConstructed}}}o0.NAME="identificationBlock";class a0 extends Xs{constructor({lenBlock:t={}}={}){var e,r,s;super(),this.isIndefiniteForm=(e=t.isIndefiniteForm)!==null&&e!==void 0?e:!1,this.longFormUsed=(r=t.longFormUsed)!==null&&r!==void 0?r:!1,this.length=(s=t.length)!==null&&s!==void 0?s:0}fromBER(t,e,r){const s=ze.toUint8Array(t);if(!Ur(this,s,e,r))return-1;const i=s.subarray(e,e+r);if(i.length===0)return this.error="Zero buffer length",-1;if(i[0]===255)return this.error="Length block 0xFF is reserved by standard",-1;if(this.isIndefiniteForm=i[0]===128,this.isIndefiniteForm)return this.blockLength=1,e+this.blockLength;if(this.longFormUsed=!!(i[0]&128),this.longFormUsed===!1)return this.length=i[0],this.blockLength=1,e+this.blockLength;const o=i[0]&127;if(o>8)return this.error="Too big integer",-1;if(o+1>i.length)return this.error="End of input reached before message was fully decoded",-1;const a=e+1,l=s.subarray(a,a+o);return l[o-1]===0&&this.warnings.push("Needlessly long encoded length"),this.length=ji(l,8),this.longFormUsed&&this.length<=127&&this.warnings.push("Unnecessary usage of long length form"),this.blockLength=o+1,e+this.blockLength}toBER(t=!1){let e,r;if(this.length>127&&(this.longFormUsed=!0),this.isIndefiniteForm)return e=new ArrayBuffer(1),t===!1&&(r=new Uint8Array(e),r[0]=128),e;if(this.longFormUsed){const s=zs(this.length,8);if(s.byteLength>127)return this.error="Too big length",Gn;if(e=new ArrayBuffer(s.byteLength+1),t)return e;const i=new Uint8Array(s);r=new Uint8Array(e),r[0]=s.byteLength|128;for(let o=0;o<s.byteLength;o++)r[o+1]=i[o];return e}return e=new ArrayBuffer(1),t===!1&&(r=new Uint8Array(e),r[0]=this.length),e}toJSON(){return{...super.toJSON(),isIndefiniteForm:this.isIndefiniteForm,longFormUsed:this.longFormUsed,length:this.length}}}a0.NAME="lengthBlock";const X={};class Qt extends Xs{constructor({name:t=ho,optional:e=!1,primitiveSchema:r,...s}={},i){super(s),this.name=t,this.optional=e,r&&(this.primitiveSchema=r),this.idBlock=new o0(s),this.lenBlock=new a0(s),this.valueBlock=i?new i(s):new un(s)}fromBER(t,e,r){const s=this.valueBlock.fromBER(t,e,this.lenBlock.isIndefiniteForm?r:this.lenBlock.length);return s===-1?(this.error=this.valueBlock.error,s):(this.idBlock.error.length||(this.blockLength+=this.idBlock.blockLength),this.lenBlock.error.length||(this.blockLength+=this.lenBlock.blockLength),this.valueBlock.error.length||(this.blockLength+=this.valueBlock.blockLength),s)}toBER(t,e){const r=e||new Zf;e||c0(this);const s=this.idBlock.toBER(t);if(r.write(s),this.lenBlock.isIndefiniteForm)r.write(new Uint8Array([128]).buffer),this.valueBlock.toBER(t,r),r.write(new ArrayBuffer(2));else{const i=this.valueBlock.toBER(t);this.lenBlock.length=i.byteLength;const o=this.lenBlock.toBER(t);r.write(o),r.write(i)}return e?Gn:r.final()}toJSON(){const t={...super.toJSON(),idBlock:this.idBlock.toJSON(),lenBlock:this.lenBlock.toJSON(),valueBlock:this.valueBlock.toJSON(),name:this.name,optional:this.optional};return this.primitiveSchema&&(t.primitiveSchema=this.primitiveSchema.toJSON()),t}toString(t="ascii"){return t==="ascii"?this.onAsciiEncoding():rt.ToHex(this.toBER())}onAsciiEncoding(){return`${this.constructor.NAME} : ${rt.ToHex(this.valueBlock.valueBeforeDecodeView)}`}isEqual(t){if(this===t)return!0;if(!(t instanceof this.constructor))return!1;const e=this.toBER(),r=t.toBER();return xD(e,r)}}Qt.NAME="BaseBlock";function c0(n){if(n instanceof X.Constructed)for(const t of n.valueBlock.value)c0(t)&&(n.lenBlock.isIndefiniteForm=!0);return!!n.lenBlock.isIndefiniteForm}class l0 extends Qt{constructor({value:t=ho,...e}={},r){super(e,r),t&&this.fromString(t)}getValue(){return this.valueBlock.value}setValue(t){this.valueBlock.value=t}fromBER(t,e,r){const s=this.valueBlock.fromBER(t,e,this.lenBlock.isIndefiniteForm?r:this.lenBlock.length);return s===-1?(this.error=this.valueBlock.error,s):(this.fromBuffer(this.valueBlock.valueHexView),this.idBlock.error.length||(this.blockLength+=this.idBlock.blockLength),this.lenBlock.error.length||(this.blockLength+=this.lenBlock.blockLength),this.valueBlock.error.length||(this.blockLength+=this.valueBlock.blockLength),s)}onAsciiEncoding(){return`${this.constructor.NAME} : '${this.valueBlock.value}'`}}l0.NAME="BaseStringBlock";class u0 extends Vr(un){constructor({isHexOnly:t=!0,...e}={}){super(e),this.isHexOnly=t}}u0.NAME="PrimitiveValueBlock";var d0;class h0 extends Qt{constructor(t={}){super(t,u0),this.idBlock.isConstructed=!1}}d0=h0;X.Primitive=d0;h0.NAME="PRIMITIVE";function ID(n,t){if(n instanceof t)return n;const e=new t;return e.idBlock=n.idBlock,e.lenBlock=n.lenBlock,e.warnings=n.warnings,e.valueBeforeDecodeView=n.valueBeforeDecodeView,e}function Xl(n,t=0,e=n.length){const r=t;let s=new Qt({},un);const i=new Xs;if(!Ur(i,n,t,e))return s.error=i.error,{offset:-1,result:s};if(!n.subarray(t,t+e).length)return s.error="Zero buffer length",{offset:-1,result:s};let a=s.idBlock.fromBER(n,t,e);if(s.idBlock.warnings.length&&s.warnings.concat(s.idBlock.warnings),a===-1)return s.error=s.idBlock.error,{offset:-1,result:s};if(t=a,e-=s.idBlock.blockLength,a=s.lenBlock.fromBER(n,t,e),s.lenBlock.warnings.length&&s.warnings.concat(s.lenBlock.warnings),a===-1)return s.error=s.lenBlock.error,{offset:-1,result:s};if(t=a,e-=s.lenBlock.blockLength,!s.idBlock.isConstructed&&s.lenBlock.isIndefiniteForm)return s.error="Indefinite length form used for primitive encoding form",{offset:-1,result:s};let l=Qt;switch(s.idBlock.tagClass){case 1:if(s.idBlock.tagNumber>=37&&s.idBlock.isHexOnly===!1)return s.error="UNIVERSAL 37 and upper tags are reserved by ASN.1 standard",{offset:-1,result:s};switch(s.idBlock.tagNumber){case 0:if(s.idBlock.isConstructed&&s.lenBlock.length>0)return s.error="Type [UNIVERSAL 0] is reserved",{offset:-1,result:s};l=X.EndOfContent;break;case 1:l=X.Boolean;break;case 2:l=X.Integer;break;case 3:l=X.BitString;break;case 4:l=X.OctetString;break;case 5:l=X.Null;break;case 6:l=X.ObjectIdentifier;break;case 10:l=X.Enumerated;break;case 12:l=X.Utf8String;break;case 13:l=X.RelativeObjectIdentifier;break;case 14:l=X.TIME;break;case 15:return s.error="[UNIVERSAL 15] is reserved by ASN.1 standard",{offset:-1,result:s};case 16:l=X.Sequence;break;case 17:l=X.Set;break;case 18:l=X.NumericString;break;case 19:l=X.PrintableString;break;case 20:l=X.TeletexString;break;case 21:l=X.VideotexString;break;case 22:l=X.IA5String;break;case 23:l=X.UTCTime;break;case 24:l=X.GeneralizedTime;break;case 25:l=X.GraphicString;break;case 26:l=X.VisibleString;break;case 27:l=X.GeneralString;break;case 28:l=X.UniversalString;break;case 29:l=X.CharacterString;break;case 30:l=X.BmpString;break;case 31:l=X.DATE;break;case 32:l=X.TimeOfDay;break;case 33:l=X.DateTime;break;case 34:l=X.Duration;break;default:{const u=s.idBlock.isConstructed?new X.Constructed:new X.Primitive;u.idBlock=s.idBlock,u.lenBlock=s.lenBlock,u.warnings=s.warnings,s=u}}break;case 2:case 3:case 4:default:l=s.idBlock.isConstructed?X.Constructed:X.Primitive}return s=ID(s,l),a=s.fromBER(n,t,s.lenBlock.isIndefiniteForm?e:s.lenBlock.length),s.valueBeforeDecodeView=n.subarray(r,r+s.blockLength),{offset:a,result:s}}function $u(n){if(!n.byteLength){const t=new Qt({},un);return t.error="Input buffer has zero length",{offset:-1,result:t}}return Xl(ze.toUint8Array(n).slice(),0,n.byteLength)}function kD(n,t){return n?1:t}class os extends un{constructor({value:t=[],isIndefiniteForm:e=!1,...r}={}){super(r),this.value=t,this.isIndefiniteForm=e}fromBER(t,e,r){const s=ze.toUint8Array(t);if(!Ur(this,s,e,r))return-1;if(this.valueBeforeDecodeView=s.subarray(e,e+r),this.valueBeforeDecodeView.length===0)return this.warnings.push("Zero buffer length"),e;let i=e;for(;kD(this.isIndefiniteForm,r)>0;){const o=Xl(s,i,r);if(o.offset===-1)return this.error=o.result.error,this.warnings.concat(o.result.warnings),-1;if(i=o.offset,this.blockLength+=o.result.blockLength,r-=o.result.blockLength,this.value.push(o.result),this.isIndefiniteForm&&o.result.constructor.NAME===oa)break}return this.isIndefiniteForm&&(this.value[this.value.length-1].constructor.NAME===oa?this.value.pop():this.warnings.push("No EndOfContent block encoded")),i}toBER(t,e){const r=e||new Zf;for(let s=0;s<this.value.length;s++)this.value[s].toBER(t,r);return e?Gn:r.final()}toJSON(){const t={...super.toJSON(),isIndefiniteForm:this.isIndefiniteForm,value:[]};for(const e of this.value)t.value.push(e.toJSON());return t}}os.NAME="ConstructedValueBlock";var f0;class fo extends Qt{constructor(t={}){super(t,os),this.idBlock.isConstructed=!0}fromBER(t,e,r){this.valueBlock.isIndefiniteForm=this.lenBlock.isIndefiniteForm;const s=this.valueBlock.fromBER(t,e,this.lenBlock.isIndefiniteForm?r:this.lenBlock.length);return s===-1?(this.error=this.valueBlock.error,s):(this.idBlock.error.length||(this.blockLength+=this.idBlock.blockLength),this.lenBlock.error.length||(this.blockLength+=this.lenBlock.blockLength),this.valueBlock.error.length||(this.blockLength+=this.valueBlock.blockLength),s)}onAsciiEncoding(){const t=[];for(const r of this.valueBlock.value)t.push(r.toString("ascii").split(`
`).map(s=>`  ${s}`).join(`
`));const e=this.idBlock.tagClass===3?`[${this.idBlock.tagNumber}]`:this.constructor.NAME;return t.length?`${e} :
${t.join(`
`)}`:`${e} :`}}f0=fo;X.Constructed=f0;fo.NAME="CONSTRUCTED";class p0 extends un{fromBER(t,e,r){return e}toBER(t){return Gn}}p0.override="EndOfContentValueBlock";var g0;class m0 extends Qt{constructor(t={}){super(t,p0),this.idBlock.tagClass=1,this.idBlock.tagNumber=0}}g0=m0;X.EndOfContent=g0;m0.NAME=oa;var y0;class Zc extends Qt{constructor(t={}){super(t,un),this.idBlock.tagClass=1,this.idBlock.tagNumber=5}fromBER(t,e,r){return this.lenBlock.length>0&&this.warnings.push("Non-zero length of value block for Null type"),this.idBlock.error.length||(this.blockLength+=this.idBlock.blockLength),this.lenBlock.error.length||(this.blockLength+=this.lenBlock.blockLength),this.blockLength+=r,e+r>t.byteLength?(this.error="End of input reached before message was fully decoded (inconsistent offset and length values)",-1):e+r}toBER(t,e){const r=new ArrayBuffer(2);if(!t){const s=new Uint8Array(r);s[0]=5,s[1]=0}return e&&e.write(r),r}onAsciiEncoding(){return`${this.constructor.NAME}`}}y0=Zc;X.Null=y0;Zc.NAME="NULL";class v0 extends Vr(un){constructor({value:t,...e}={}){super(e),e.valueHex?this.valueHexView=ze.toUint8Array(e.valueHex):this.valueHexView=new Uint8Array(1),t&&(this.value=t)}get value(){for(const t of this.valueHexView)if(t>0)return!0;return!1}set value(t){this.valueHexView[0]=t?255:0}fromBER(t,e,r){const s=ze.toUint8Array(t);return Ur(this,s,e,r)?(this.valueHexView=s.subarray(e,e+r),r>1&&this.warnings.push("Boolean value encoded in more then 1 octet"),this.isHexOnly=!0,r0.call(this),this.blockLength=r,e+r):-1}toBER(){return this.valueHexView.slice()}toJSON(){return{...super.toJSON(),value:this.value}}}v0.NAME="BooleanValueBlock";var b0;let w0=class extends Qt{constructor(t={}){super(t,v0),this.idBlock.tagClass=1,this.idBlock.tagNumber=1}getValue(){return this.valueBlock.value}setValue(t){this.valueBlock.value=t}onAsciiEncoding(){return`${this.constructor.NAME} : ${this.getValue}`}};b0=w0;X.Boolean=b0;w0.NAME="BOOLEAN";class _0 extends Vr(os){constructor({isConstructed:t=!1,...e}={}){super(e),this.isConstructed=t}fromBER(t,e,r){let s=0;if(this.isConstructed){if(this.isHexOnly=!1,s=os.prototype.fromBER.call(this,t,e,r),s===-1)return s;for(let i=0;i<this.value.length;i++){const o=this.value[i].constructor.NAME;if(o===oa){if(this.isIndefiniteForm)break;return this.error="EndOfContent is unexpected, OCTET STRING may consists of OCTET STRINGs only",-1}if(o!==s0)return this.error="OCTET STRING may consists of OCTET STRINGs only",-1}}else this.isHexOnly=!0,s=super.fromBER(t,e,r),this.blockLength=r;return s}toBER(t,e){return this.isConstructed?os.prototype.toBER.call(this,t,e):t?new ArrayBuffer(this.valueHexView.byteLength):this.valueHexView.slice().buffer}toJSON(){return{...super.toJSON(),isConstructed:this.isConstructed}}}_0.NAME="OctetStringValueBlock";var S0;class is extends Qt{constructor({idBlock:t={},lenBlock:e={},...r}={}){var s,i;(s=r.isConstructed)!==null&&s!==void 0||(r.isConstructed=!!(!((i=r.value)===null||i===void 0)&&i.length)),super({idBlock:{isConstructed:r.isConstructed,...t},lenBlock:{...e,isIndefiniteForm:!!r.isIndefiniteForm},...r},_0),this.idBlock.tagClass=1,this.idBlock.tagNumber=4}fromBER(t,e,r){if(this.valueBlock.isConstructed=this.idBlock.isConstructed,this.valueBlock.isIndefiniteForm=this.lenBlock.isIndefiniteForm,r===0)return this.idBlock.error.length===0&&(this.blockLength+=this.idBlock.blockLength),this.lenBlock.error.length===0&&(this.blockLength+=this.lenBlock.blockLength),e;if(!this.valueBlock.isConstructed){const i=(t instanceof ArrayBuffer?new Uint8Array(t):t).subarray(e,e+r);try{if(i.byteLength){const o=Xl(i,0,i.byteLength);o.offset!==-1&&o.offset===r&&(this.valueBlock.value=[o.result])}}catch{}}return super.fromBER(t,e,r)}onAsciiEncoding(){return this.valueBlock.isConstructed||this.valueBlock.value&&this.valueBlock.value.length?fo.prototype.onAsciiEncoding.call(this):`${this.constructor.NAME} : ${rt.ToHex(this.valueBlock.valueHexView)}`}getValue(){if(!this.idBlock.isConstructed)return this.valueBlock.valueHexView.slice().buffer;const t=[];for(const e of this.valueBlock.value)e instanceof is&&t.push(e.valueBlock.valueHexView);return ze.concat(t)}}S0=is;X.OctetString=S0;is.NAME=s0;class E0 extends Vr(os){constructor({unusedBits:t=0,isConstructed:e=!1,...r}={}){super(r),this.unusedBits=t,this.isConstructed=e,this.blockLength=this.valueHexView.byteLength}fromBER(t,e,r){if(!r)return e;let s=-1;if(this.isConstructed){if(s=os.prototype.fromBER.call(this,t,e,r),s===-1)return s;for(const a of this.value){const l=a.constructor.NAME;if(l===oa){if(this.isIndefiniteForm)break;return this.error="EndOfContent is unexpected, BIT STRING may consists of BIT STRINGs only",-1}if(l!==i0)return this.error="BIT STRING may consists of BIT STRINGs only",-1;const u=a.valueBlock;if(this.unusedBits>0&&u.unusedBits>0)return this.error='Using of "unused bits" inside constructive BIT STRING allowed for least one only',-1;this.unusedBits=u.unusedBits}return s}const i=ze.toUint8Array(t);if(!Ur(this,i,e,r))return-1;const o=i.subarray(e,e+r);if(this.unusedBits=o[0],this.unusedBits>7)return this.error="Unused bits for BitString must be in range 0-7",-1;if(!this.unusedBits){const a=o.subarray(1);try{if(a.byteLength){const l=Xl(a,0,a.byteLength);l.offset!==-1&&l.offset===r-1&&(this.value=[l.result])}}catch{}}return this.valueHexView=o.subarray(1),this.blockLength=o.length,e+r}toBER(t,e){if(this.isConstructed)return os.prototype.toBER.call(this,t,e);if(t)return new ArrayBuffer(this.valueHexView.byteLength+1);if(!this.valueHexView.byteLength)return Gn;const r=new Uint8Array(this.valueHexView.length+1);return r[0]=this.unusedBits,r.set(this.valueHexView,1),r.buffer}toJSON(){return{...super.toJSON(),unusedBits:this.unusedBits,isConstructed:this.isConstructed}}}E0.NAME="BitStringValueBlock";var A0;class x0 extends Qt{constructor({idBlock:t={},lenBlock:e={},...r}={}){var s,i;(s=r.isConstructed)!==null&&s!==void 0||(r.isConstructed=!!(!((i=r.value)===null||i===void 0)&&i.length)),super({idBlock:{isConstructed:r.isConstructed,...t},lenBlock:{...e,isIndefiniteForm:!!r.isIndefiniteForm},...r},E0),this.idBlock.tagClass=1,this.idBlock.tagNumber=3}fromBER(t,e,r){return this.valueBlock.isConstructed=this.idBlock.isConstructed,this.valueBlock.isIndefiniteForm=this.lenBlock.isIndefiniteForm,super.fromBER(t,e,r)}onAsciiEncoding(){if(this.valueBlock.isConstructed||this.valueBlock.value&&this.valueBlock.value.length)return fo.prototype.onAsciiEncoding.call(this);{const t=[],e=this.valueBlock.valueHexView;for(const s of e)t.push(s.toString(2).padStart(8,"0"));const r=t.join("");return`${this.constructor.NAME} : ${r.substring(0,r.length-this.valueBlock.unusedBits)}`}}}A0=x0;X.BitString=A0;x0.NAME=i0;var I0;function TD(n,t){const e=new Uint8Array([0]),r=new Uint8Array(n),s=new Uint8Array(t);let i=r.slice(0);const o=i.length-1,a=s.slice(0),l=a.length-1;let u=0;const h=l<o?o:l;let c=0;for(let d=h;d>=0;d--,c++){switch(!0){case c<a.length:u=i[o-c]+a[l-c]+e[0];break;default:u=i[o-c]+e[0]}switch(e[0]=u/10,!0){case c>=i.length:i=nh(new Uint8Array([u%10]),i);break;default:i[o-c]=u%10}}return e[0]>0&&(i=nh(e,i)),i}function Qg(n){if(n>=Ao.length)for(let t=Ao.length;t<=n;t++){const e=new Uint8Array([0]);let r=Ao[t-1].slice(0);for(let s=r.length-1;s>=0;s--){const i=new Uint8Array([(r[s]<<1)+e[0]]);e[0]=i[0]/10,r[s]=i[0]%10}e[0]>0&&(r=nh(e,r)),Ao.push(r)}return Ao[n]}function CD(n,t){let e=0;const r=new Uint8Array(n),s=new Uint8Array(t),i=r.slice(0),o=i.length-1,a=s.slice(0),l=a.length-1;let u,h=0;for(let c=l;c>=0;c--,h++)switch(u=i[o-h]-a[l-h]-e,!0){case u<0:e=1,i[o-h]=u+10;break;default:e=0,i[o-h]=u}if(e>0)for(let c=o-l+1;c>=0;c--,h++)if(u=i[o-h]-e,u<0)e=1,i[o-h]=u+10;else{e=0,i[o-h]=u;break}return i.slice()}class Jf extends Vr(un){constructor({value:t,...e}={}){super(e),this._valueDec=0,e.valueHex&&this.setValueHex(),t!==void 0&&(this.valueDec=t)}setValueHex(){this.valueHexView.length>=4?(this.warnings.push("Too big Integer for decoding, hex only"),this.isHexOnly=!0,this._valueDec=0):(this.isHexOnly=!1,this.valueHexView.length>0&&(this._valueDec=r0.call(this)))}set valueDec(t){this._valueDec=t,this.isHexOnly=!1,this.valueHexView=new Uint8Array(AD(t))}get valueDec(){return this._valueDec}fromDER(t,e,r,s=0){const i=this.fromBER(t,e,r);if(i===-1)return i;const o=this.valueHexView;return o[0]===0&&(o[1]&128)!==0?this.valueHexView=o.subarray(1):s!==0&&o.length<s&&(s-o.length>1&&(s=o.length+1),this.valueHexView=o.subarray(s-o.length)),i}toDER(t=!1){const e=this.valueHexView;switch(!0){case(e[0]&128)!==0:{const r=new Uint8Array(this.valueHexView.length+1);r[0]=0,r.set(e,1),this.valueHexView=r}break;case(e[0]===0&&(e[1]&128)===0):this.valueHexView=this.valueHexView.subarray(1);break}return this.toBER(t)}fromBER(t,e,r){const s=super.fromBER(t,e,r);return s===-1||this.setValueHex(),s}toBER(t){return t?new ArrayBuffer(this.valueHexView.length):this.valueHexView.slice().buffer}toJSON(){return{...super.toJSON(),valueDec:this.valueDec}}toString(){const t=this.valueHexView.length*8-1;let e=new Uint8Array(this.valueHexView.length*8/3),r=0,s;const i=this.valueHexView;let o="",a=!1;for(let l=i.byteLength-1;l>=0;l--){s=i[l];for(let u=0;u<8;u++){if((s&1)===1)switch(r){case t:e=CD(Qg(r),e),o="-";break;default:e=TD(e,Qg(r))}r++,s>>=1}}for(let l=0;l<e.length;l++)e[l]&&(a=!0),a&&(o+=Yg.charAt(e[l]));return a===!1&&(o+=Yg.charAt(0)),o}}I0=Jf;Jf.NAME="IntegerValueBlock";Object.defineProperty(I0.prototype,"valueHex",{set:function(n){this.valueHexView=new Uint8Array(n),this.setValueHex()},get:function(){return this.valueHexView.slice().buffer}});var k0;class rr extends Qt{constructor(t={}){super(t,Jf),this.idBlock.tagClass=1,this.idBlock.tagNumber=2}toBigInt(){return jc(),BigInt(this.valueBlock.toString())}static fromBigInt(t){jc();const e=BigInt(t),r=new Zf,s=e.toString(16).replace(/^-/,""),i=new Uint8Array(rt.FromHex(s));if(e<0){const a=new Uint8Array(i.length+(i[0]&128?1:0));a[0]|=128;const u=BigInt(`0x${rt.ToHex(a)}`)+e,h=ze.toUint8Array(rt.FromHex(u.toString(16)));h[0]|=128,r.write(h)}else i[0]&128&&r.write(new Uint8Array([0])),r.write(i);return new rr({valueHex:r.final()})}convertToDER(){const t=new rr({valueHex:this.valueBlock.valueHexView});return t.valueBlock.toDER(),t}convertFromDER(){return new rr({valueHex:this.valueBlock.valueHexView[0]===0?this.valueBlock.valueHexView.subarray(1):this.valueBlock.valueHexView})}onAsciiEncoding(){return`${this.constructor.NAME} : ${this.valueBlock.toString()}`}}k0=rr;X.Integer=k0;rr.NAME="INTEGER";var T0;class C0 extends rr{constructor(t={}){super(t),this.idBlock.tagClass=1,this.idBlock.tagNumber=10}}T0=C0;X.Enumerated=T0;C0.NAME="ENUMERATED";class rh extends Vr(un){constructor({valueDec:t=-1,isFirstSid:e=!1,...r}={}){super(r),this.valueDec=t,this.isFirstSid=e}fromBER(t,e,r){if(!r)return e;const s=ze.toUint8Array(t);if(!Ur(this,s,e,r))return-1;const i=s.subarray(e,e+r);this.valueHexView=new Uint8Array(r);for(let a=0;a<r&&(this.valueHexView[a]=i[a]&127,this.blockLength++,(i[a]&128)!==0);a++);const o=new Uint8Array(this.blockLength);for(let a=0;a<this.blockLength;a++)o[a]=this.valueHexView[a];return this.valueHexView=o,(i[this.blockLength-1]&128)!==0?(this.error="End of input reached before message was fully decoded",-1):(this.valueHexView[0]===0&&this.warnings.push("Needlessly long format of SID encoding"),this.blockLength<=8?this.valueDec=ji(this.valueHexView,7):(this.isHexOnly=!0,this.warnings.push("Too big SID for decoding, hex only")),e+this.blockLength)}set valueBigInt(t){jc();let e=BigInt(t).toString(2);for(;e.length%7;)e="0"+e;const r=new Uint8Array(e.length/7);for(let s=0;s<r.length;s++)r[s]=parseInt(e.slice(s*7,s*7+7),2)+(s+1<r.length?128:0);this.fromBER(r.buffer,0,r.length)}toBER(t){if(this.isHexOnly){if(t)return new ArrayBuffer(this.valueHexView.byteLength);const s=this.valueHexView,i=new Uint8Array(this.blockLength);for(let o=0;o<this.blockLength-1;o++)i[o]=s[o]|128;return i[this.blockLength-1]=s[this.blockLength-1],i.buffer}const e=zs(this.valueDec,7);if(e.byteLength===0)return this.error="Error during encoding SID value",Gn;const r=new Uint8Array(e.byteLength);if(!t){const s=new Uint8Array(e),i=e.byteLength-1;for(let o=0;o<i;o++)r[o]=s[o]|128;r[i]=s[i]}return r}toString(){let t="";if(this.isHexOnly)t=rt.ToHex(this.valueHexView);else if(this.isFirstSid){let e=this.valueDec;this.valueDec<=39?t="0.":this.valueDec<=79?(t="1.",e-=40):(t="2.",e-=80),t+=e.toString()}else t=this.valueDec.toString();return t}toJSON(){return{...super.toJSON(),valueDec:this.valueDec,isFirstSid:this.isFirstSid}}}rh.NAME="sidBlock";class P0 extends un{constructor({value:t=ho,...e}={}){super(e),this.value=[],t&&this.fromString(t)}fromBER(t,e,r){let s=e;for(;r>0;){const i=new rh;if(s=i.fromBER(t,s,r),s===-1)return this.blockLength=0,this.error=i.error,s;this.value.length===0&&(i.isFirstSid=!0),this.blockLength+=i.blockLength,r-=i.blockLength,this.value.push(i)}return s}toBER(t){const e=[];for(let r=0;r<this.value.length;r++){const s=this.value[r].toBER(t);if(s.byteLength===0)return this.error=this.value[r].error,Gn;e.push(s)}return jf(e)}fromString(t){this.value=[];let e=0,r=0,s="",i=!1;do if(r=t.indexOf(".",e),r===-1?s=t.substring(e):s=t.substring(e,r),e=r+1,i){const o=this.value[0];let a=0;switch(o.valueDec){case 0:break;case 1:a=40;break;case 2:a=80;break;default:this.value=[];return}const l=parseInt(s,10);if(isNaN(l))return;o.valueDec=l+a,i=!1}else{const o=new rh;if(s>Number.MAX_SAFE_INTEGER){jc();const a=BigInt(s);o.valueBigInt=a}else if(o.valueDec=parseInt(s,10),isNaN(o.valueDec))return;this.value.length||(o.isFirstSid=!0,i=!0),this.value.push(o)}while(r!==-1)}toString(){let t="",e=!1;for(let r=0;r<this.value.length;r++){e=this.value[r].isHexOnly;let s=this.value[r].toString();r!==0&&(t=`${t}.`),e?(s=`{${s}}`,this.value[r].isFirstSid?t=`2.{${s} - 80}`:t+=s):t+=s}return t}toJSON(){const t={...super.toJSON(),value:this.toString(),sidArray:[]};for(let e=0;e<this.value.length;e++)t.sidArray.push(this.value[e].toJSON());return t}}P0.NAME="ObjectIdentifierValueBlock";var D0;class ws extends Qt{constructor(t={}){super(t,P0),this.idBlock.tagClass=1,this.idBlock.tagNumber=6}getValue(){return this.valueBlock.toString()}setValue(t){this.valueBlock.fromString(t)}onAsciiEncoding(){return`${this.constructor.NAME} : ${this.valueBlock.toString()||"empty"}`}toJSON(){return{...super.toJSON(),value:this.getValue()}}}D0=ws;X.ObjectIdentifier=D0;ws.NAME="OBJECT IDENTIFIER";class sh extends Vr(Xs){constructor({valueDec:t=0,...e}={}){super(e),this.valueDec=t}fromBER(t,e,r){if(r===0)return e;const s=ze.toUint8Array(t);if(!Ur(this,s,e,r))return-1;const i=s.subarray(e,e+r);this.valueHexView=new Uint8Array(r);for(let a=0;a<r&&(this.valueHexView[a]=i[a]&127,this.blockLength++,(i[a]&128)!==0);a++);const o=new Uint8Array(this.blockLength);for(let a=0;a<this.blockLength;a++)o[a]=this.valueHexView[a];return this.valueHexView=o,(i[this.blockLength-1]&128)!==0?(this.error="End of input reached before message was fully decoded",-1):(this.valueHexView[0]===0&&this.warnings.push("Needlessly long format of SID encoding"),this.blockLength<=8?this.valueDec=ji(this.valueHexView,7):(this.isHexOnly=!0,this.warnings.push("Too big SID for decoding, hex only")),e+this.blockLength)}toBER(t){if(this.isHexOnly){if(t)return new ArrayBuffer(this.valueHexView.byteLength);const s=this.valueHexView,i=new Uint8Array(this.blockLength);for(let o=0;o<this.blockLength-1;o++)i[o]=s[o]|128;return i[this.blockLength-1]=s[this.blockLength-1],i.buffer}const e=zs(this.valueDec,7);if(e.byteLength===0)return this.error="Error during encoding SID value",Gn;const r=new Uint8Array(e.byteLength);if(!t){const s=new Uint8Array(e),i=e.byteLength-1;for(let o=0;o<i;o++)r[o]=s[o]|128;r[i]=s[i]}return r.buffer}toString(){let t="";return this.isHexOnly?t=rt.ToHex(this.valueHexView):t=this.valueDec.toString(),t}toJSON(){return{...super.toJSON(),valueDec:this.valueDec}}}sh.NAME="relativeSidBlock";class M0 extends un{constructor({value:t=ho,...e}={}){super(e),this.value=[],t&&this.fromString(t)}fromBER(t,e,r){let s=e;for(;r>0;){const i=new sh;if(s=i.fromBER(t,s,r),s===-1)return this.blockLength=0,this.error=i.error,s;this.blockLength+=i.blockLength,r-=i.blockLength,this.value.push(i)}return s}toBER(t,e){const r=[];for(let s=0;s<this.value.length;s++){const i=this.value[s].toBER(t);if(i.byteLength===0)return this.error=this.value[s].error,Gn;r.push(i)}return jf(r)}fromString(t){this.value=[];let e=0,r=0,s="";do{r=t.indexOf(".",e),r===-1?s=t.substring(e):s=t.substring(e,r),e=r+1;const i=new sh;if(i.valueDec=parseInt(s,10),isNaN(i.valueDec))return!0;this.value.push(i)}while(r!==-1);return!0}toString(){let t="",e=!1;for(let r=0;r<this.value.length;r++){e=this.value[r].isHexOnly;let s=this.value[r].toString();r!==0&&(t=`${t}.`),e&&(s=`{${s}}`),t+=s}return t}toJSON(){const t={...super.toJSON(),value:this.toString(),sidArray:[]};for(let e=0;e<this.value.length;e++)t.sidArray.push(this.value[e].toJSON());return t}}M0.NAME="RelativeObjectIdentifierValueBlock";var L0;class B0 extends Qt{constructor(t={}){super(t,M0),this.idBlock.tagClass=1,this.idBlock.tagNumber=13}getValue(){return this.valueBlock.toString()}setValue(t){this.valueBlock.fromString(t)}onAsciiEncoding(){return`${this.constructor.NAME} : ${this.valueBlock.toString()||"empty"}`}toJSON(){return{...super.toJSON(),value:this.getValue()}}}L0=B0;X.RelativeObjectIdentifier=L0;B0.NAME="RelativeObjectIdentifier";var N0;class On extends fo{constructor(t={}){super(t),this.idBlock.tagClass=1,this.idBlock.tagNumber=16}}N0=On;X.Sequence=N0;On.NAME="SEQUENCE";var R0;let O0=class extends fo{constructor(t={}){super(t),this.idBlock.tagClass=1,this.idBlock.tagNumber=17}};R0=O0;X.Set=R0;O0.NAME="SET";class F0 extends Vr(un){constructor({...t}={}){super(t),this.isHexOnly=!0,this.value=ho}toJSON(){return{...super.toJSON(),value:this.value}}}F0.NAME="StringValueBlock";class $0 extends F0{}$0.NAME="SimpleStringValueBlock";class _n extends l0{constructor({...t}={}){super(t,$0)}fromBuffer(t){this.valueBlock.value=String.fromCharCode.apply(null,ze.toUint8Array(t))}fromString(t){const e=t.length,r=this.valueBlock.valueHexView=new Uint8Array(e);for(let s=0;s<e;s++)r[s]=t.charCodeAt(s);this.valueBlock.value=t}}_n.NAME="SIMPLE STRING";class U0 extends _n{fromBuffer(t){this.valueBlock.valueHexView=ze.toUint8Array(t);try{this.valueBlock.value=rt.ToUtf8String(t)}catch(e){this.warnings.push(`Error during "decodeURIComponent": ${e}, using raw string`),this.valueBlock.value=rt.ToBinary(t)}}fromString(t){this.valueBlock.valueHexView=new Uint8Array(rt.FromUtf8String(t)),this.valueBlock.value=t}}U0.NAME="Utf8StringValueBlock";var V0;class Js extends U0{constructor(t={}){super(t),this.idBlock.tagClass=1,this.idBlock.tagNumber=12}}V0=Js;X.Utf8String=V0;Js.NAME="UTF8String";class H0 extends _n{fromBuffer(t){this.valueBlock.value=rt.ToUtf16String(t),this.valueBlock.valueHexView=ze.toUint8Array(t)}fromString(t){this.valueBlock.value=t,this.valueBlock.valueHexView=new Uint8Array(rt.FromUtf16String(t))}}H0.NAME="BmpStringValueBlock";var z0;class q0 extends H0{constructor({...t}={}){super(t),this.idBlock.tagClass=1,this.idBlock.tagNumber=30}}z0=q0;X.BmpString=z0;q0.NAME="BMPString";class W0 extends _n{fromBuffer(t){const e=ArrayBuffer.isView(t)?t.slice().buffer:t.slice(0),r=new Uint8Array(e);for(let s=0;s<r.length;s+=4)r[s]=r[s+3],r[s+1]=r[s+2],r[s+2]=0,r[s+3]=0;this.valueBlock.value=String.fromCharCode.apply(null,new Uint32Array(e))}fromString(t){const e=t.length,r=this.valueBlock.valueHexView=new Uint8Array(e*4);for(let s=0;s<e;s++){const i=zs(t.charCodeAt(s),8),o=new Uint8Array(i);if(o.length>4)continue;const a=4-o.length;for(let l=o.length-1;l>=0;l--)r[s*4+l+a]=o[l]}this.valueBlock.value=t}}W0.NAME="UniversalStringValueBlock";var G0;class K0 extends W0{constructor({...t}={}){super(t),this.idBlock.tagClass=1,this.idBlock.tagNumber=28}}G0=K0;X.UniversalString=G0;K0.NAME="UniversalString";var Y0;class Q0 extends _n{constructor(t={}){super(t),this.idBlock.tagClass=1,this.idBlock.tagNumber=18}}Y0=Q0;X.NumericString=Y0;Q0.NAME="NumericString";var j0;class Z0 extends _n{constructor(t={}){super(t),this.idBlock.tagClass=1,this.idBlock.tagNumber=19}}j0=Z0;X.PrintableString=j0;Z0.NAME="PrintableString";var X0;class J0 extends _n{constructor(t={}){super(t),this.idBlock.tagClass=1,this.idBlock.tagNumber=20}}X0=J0;X.TeletexString=X0;J0.NAME="TeletexString";var e_;class t_ extends _n{constructor(t={}){super(t),this.idBlock.tagClass=1,this.idBlock.tagNumber=21}}e_=t_;X.VideotexString=e_;t_.NAME="VideotexString";var n_;class r_ extends _n{constructor(t={}){super(t),this.idBlock.tagClass=1,this.idBlock.tagNumber=22}}n_=r_;X.IA5String=n_;r_.NAME="IA5String";var s_;class i_ extends _n{constructor(t={}){super(t),this.idBlock.tagClass=1,this.idBlock.tagNumber=25}}s_=i_;X.GraphicString=s_;i_.NAME="GraphicString";var o_;class ep extends _n{constructor(t={}){super(t),this.idBlock.tagClass=1,this.idBlock.tagNumber=26}}o_=ep;X.VisibleString=o_;ep.NAME="VisibleString";var a_;class c_ extends _n{constructor(t={}){super(t),this.idBlock.tagClass=1,this.idBlock.tagNumber=27}}a_=c_;X.GeneralString=a_;c_.NAME="GeneralString";var l_;class u_ extends _n{constructor(t={}){super(t),this.idBlock.tagClass=1,this.idBlock.tagNumber=29}}l_=u_;X.CharacterString=l_;u_.NAME="CharacterString";var d_;class tp extends ep{constructor({value:t,valueDate:e,...r}={}){if(super(r),this.year=0,this.month=0,this.day=0,this.hour=0,this.minute=0,this.second=0,t){this.fromString(t),this.valueBlock.valueHexView=new Uint8Array(t.length);for(let s=0;s<t.length;s++)this.valueBlock.valueHexView[s]=t.charCodeAt(s)}e&&(this.fromDate(e),this.valueBlock.valueHexView=new Uint8Array(this.toBuffer())),this.idBlock.tagClass=1,this.idBlock.tagNumber=23}fromBuffer(t){this.fromString(String.fromCharCode.apply(null,ze.toUint8Array(t)))}toBuffer(){const t=this.toString(),e=new ArrayBuffer(t.length),r=new Uint8Array(e);for(let s=0;s<t.length;s++)r[s]=t.charCodeAt(s);return e}fromDate(t){this.year=t.getUTCFullYear(),this.month=t.getUTCMonth()+1,this.day=t.getUTCDate(),this.hour=t.getUTCHours(),this.minute=t.getUTCMinutes(),this.second=t.getUTCSeconds()}toDate(){return new Date(Date.UTC(this.year,this.month-1,this.day,this.hour,this.minute,this.second))}fromString(t){const r=/(\d{2})(\d{2})(\d{2})(\d{2})(\d{2})(\d{2})Z/ig.exec(t);if(r===null){this.error="Wrong input string for conversion";return}const s=parseInt(r[1],10);s>=50?this.year=1900+s:this.year=2e3+s,this.month=parseInt(r[2],10),this.day=parseInt(r[3],10),this.hour=parseInt(r[4],10),this.minute=parseInt(r[5],10),this.second=parseInt(r[6],10)}toString(t="iso"){if(t==="iso"){const e=new Array(7);return e[0]=pn(this.year<2e3?this.year-1900:this.year-2e3,2),e[1]=pn(this.month,2),e[2]=pn(this.day,2),e[3]=pn(this.hour,2),e[4]=pn(this.minute,2),e[5]=pn(this.second,2),e[6]="Z",e.join("")}return super.toString(t)}onAsciiEncoding(){return`${this.constructor.NAME} : ${this.toDate().toISOString()}`}toJSON(){return{...super.toJSON(),year:this.year,month:this.month,day:this.day,hour:this.hour,minute:this.minute,second:this.second}}}d_=tp;X.UTCTime=d_;tp.NAME="UTCTime";var h_;class f_ extends tp{constructor(t={}){var e;super(t),(e=this.millisecond)!==null&&e!==void 0||(this.millisecond=0),this.idBlock.tagClass=1,this.idBlock.tagNumber=24}fromDate(t){super.fromDate(t),this.millisecond=t.getUTCMilliseconds()}toDate(){return new Date(Date.UTC(this.year,this.month-1,this.day,this.hour,this.minute,this.second,this.millisecond))}fromString(t){let e=!1,r="",s="",i=0,o,a=0,l=0;if(t[t.length-1]==="Z")r=t.substring(0,t.length-1),e=!0;else{const c=new Number(t[t.length-1]);if(isNaN(c.valueOf()))throw new Error("Wrong input string for conversion");r=t}if(e){if(r.indexOf("+")!==-1)throw new Error("Wrong input string for conversion");if(r.indexOf("-")!==-1)throw new Error("Wrong input string for conversion")}else{let c=1,d=r.indexOf("+"),f="";if(d===-1&&(d=r.indexOf("-"),c=-1),d!==-1){if(f=r.substring(d+1),r=r.substring(0,d),f.length!==2&&f.length!==4)throw new Error("Wrong input string for conversion");let g=parseInt(f.substring(0,2),10);if(isNaN(g.valueOf()))throw new Error("Wrong input string for conversion");if(a=c*g,f.length===4){if(g=parseInt(f.substring(2,4),10),isNaN(g.valueOf()))throw new Error("Wrong input string for conversion");l=c*g}}}let u=r.indexOf(".");if(u===-1&&(u=r.indexOf(",")),u!==-1){const c=new Number(`0${r.substring(u)}`);if(isNaN(c.valueOf()))throw new Error("Wrong input string for conversion");i=c.valueOf(),s=r.substring(0,u)}else s=r;switch(!0){case s.length===8:if(o=/(\d{4})(\d{2})(\d{2})/ig,u!==-1)throw new Error("Wrong input string for conversion");break;case s.length===10:if(o=/(\d{4})(\d{2})(\d{2})(\d{2})/ig,u!==-1){let c=60*i;this.minute=Math.floor(c),c=60*(c-this.minute),this.second=Math.floor(c),c=1e3*(c-this.second),this.millisecond=Math.floor(c)}break;case s.length===12:if(o=/(\d{4})(\d{2})(\d{2})(\d{2})(\d{2})/ig,u!==-1){let c=60*i;this.second=Math.floor(c),c=1e3*(c-this.second),this.millisecond=Math.floor(c)}break;case s.length===14:if(o=/(\d{4})(\d{2})(\d{2})(\d{2})(\d{2})(\d{2})/ig,u!==-1){const c=1e3*i;this.millisecond=Math.floor(c)}break;default:throw new Error("Wrong input string for conversion")}const h=o.exec(s);if(h===null)throw new Error("Wrong input string for conversion");for(let c=1;c<h.length;c++)switch(c){case 1:this.year=parseInt(h[c],10);break;case 2:this.month=parseInt(h[c],10);break;case 3:this.day=parseInt(h[c],10);break;case 4:this.hour=parseInt(h[c],10)+a;break;case 5:this.minute=parseInt(h[c],10)+l;break;case 6:this.second=parseInt(h[c],10);break;default:throw new Error("Wrong input string for conversion")}if(e===!1){const c=new Date(this.year,this.month,this.day,this.hour,this.minute,this.second,this.millisecond);this.year=c.getUTCFullYear(),this.month=c.getUTCMonth(),this.day=c.getUTCDay(),this.hour=c.getUTCHours(),this.minute=c.getUTCMinutes(),this.second=c.getUTCSeconds(),this.millisecond=c.getUTCMilliseconds()}}toString(t="iso"){if(t==="iso"){const e=[];return e.push(pn(this.year,4)),e.push(pn(this.month,2)),e.push(pn(this.day,2)),e.push(pn(this.hour,2)),e.push(pn(this.minute,2)),e.push(pn(this.second,2)),this.millisecond!==0&&(e.push("."),e.push(pn(this.millisecond,3))),e.push("Z"),e.join("")}return super.toString(t)}toJSON(){return{...super.toJSON(),millisecond:this.millisecond}}}h_=f_;X.GeneralizedTime=h_;f_.NAME="GeneralizedTime";var p_;class g_ extends Js{constructor(t={}){super(t),this.idBlock.tagClass=1,this.idBlock.tagNumber=31}}p_=g_;X.DATE=p_;g_.NAME="DATE";var m_;class y_ extends Js{constructor(t={}){super(t),this.idBlock.tagClass=1,this.idBlock.tagNumber=32}}m_=y_;X.TimeOfDay=m_;y_.NAME="TimeOfDay";var v_;class b_ extends Js{constructor(t={}){super(t),this.idBlock.tagClass=1,this.idBlock.tagNumber=33}}v_=b_;X.DateTime=v_;b_.NAME="DateTime";var w_;class __ extends Js{constructor(t={}){super(t),this.idBlock.tagClass=1,this.idBlock.tagNumber=34}}w_=__;X.Duration=w_;__.NAME="Duration";var S_;class E_ extends Js{constructor(t={}){super(t),this.idBlock.tagClass=1,this.idBlock.tagNumber=14}}S_=E_;X.TIME=S_;E_.NAME="TIME";const PD=16,ih=32,oh=1e4;async function np(n,t){const r=await n0().encrypt(n,t);return Aa.encode(r)}async function jg(n,t,e){if(n.type==="RSA")return LD(n,t,e);if(n.type==="Ed25519")return DD(n,t,e);if(n.type==="secp256k1")return MD(n,t,e);throw new Qs}async function DD(n,t,e="libp2p-key"){if(e==="libp2p-key")return np($l(n),t);throw new Z(`export format '${e}' is not supported`)}async function MD(n,t,e="libp2p-key"){if(e==="libp2p-key")return np($l(n),t);throw new Z("Export format is not supported")}async function LD(n,t,e="pkcs-8"){if(e==="pkcs-8")return BD(n,t);if(e==="libp2p-key")return np($l(n),t);throw new Z("Export format is not supported")}async function BD(n,t){const e=lr.get(),s=new On({value:[new rr({value:0}),new On({value:[new ws({value:"1.2.840.113549.1.1.1"}),new Zc]}),new is({valueHex:n.raw})]}).toBER(),i=new Uint8Array(s,0,s.byteLength),o=Ui(PD),a=await aw(Ml,t,o,{c:oh,dkLen:ih}),l=Ui(16),u=await e.subtle.importKey("raw",a,"AES-CBC",!1,["encrypt"]),h=await e.subtle.encrypt({name:"AES-CBC",iv:l},u,i),c=new On({value:[new is({valueHex:o}),new rr({value:oh}),new rr({value:ih}),new On({value:[new ws({value:"1.2.840.113549.2.11"}),new Zc]})]}),d=new On({value:[new ws({value:"1.2.840.113549.1.5.13"}),new On({value:[new On({value:[new ws({value:"1.2.840.113549.1.5.12"}),c]}),new On({value:[new ws({value:"2.16.840.1.101.3.4.1.42"}),new is({valueHex:l})]})]})]}),g=new On({value:[d,new is({valueHex:h})]}).toBER(),y=new Uint8Array(g,0,g.byteLength);return["-----BEGIN ENCRYPTED PRIVATE KEY-----",...he(y,"base64pad").split(/(.{64})/).filter(Boolean),"-----END ENCRYPTED PRIVATE KEY-----"].join(`
`)}async function Zg(n,t){try{const e=await ND(n,t);return gk(e)}catch{}if(!n.includes("BEGIN"))throw new Z("Encrypted key was not a libp2p-key or a PEM file");return RD(n,t)}async function ND(n,t){const e=Aa.decode(n);return n0().decrypt(e,t)}async function RD(n,t){const e=lr.get();let r;if(n.includes("-----BEGIN ENCRYPTED PRIVATE KEY-----")){const i=te(n.replace("-----BEGIN ENCRYPTED PRIVATE KEY-----","").replace("-----END ENCRYPTED PRIVATE KEY-----","").replace(/\n/g,"").trim(),"base64pad"),{result:o}=$u(i),{iv:a,salt:l,iterations:u,keySize:h,cipherText:c}=OD(o),d=await aw(Ml,t,l,{c:u,dkLen:h}),f=await e.subtle.importKey("raw",d,"AES-CBC",!1,["decrypt"]),g=Vo(await e.subtle.decrypt({name:"AES-CBC",iv:a},f,c)),{result:y}=$u(g);r=Xg(y)}else if(n.includes("-----BEGIN PRIVATE KEY-----")){const i=te(n.replace("-----BEGIN PRIVATE KEY-----","").replace("-----END PRIVATE KEY-----","").replace(/\n/g,"").trim(),"base64pad"),{result:o}=$u(i);r=Xg(o)}else throw new Z("Could not parse private key from PEM data");const s=mk(r);if(s.type!=="RSA")throw new Z("Could not parse RSA private key from PEM data");return s}function OD(n){const t=n.valueBlock.value[0];if(t.valueBlock.value[0].toString()!=="OBJECT IDENTIFIER : 1.2.840.113549.1.5.13")throw new Z("Only pkcs5PBES2 encrypted private keys are supported");const r=t.valueBlock.value[1].valueBlock.value[0];if(r.valueBlock.value[0].toString()!=="OBJECT IDENTIFIER : 1.2.840.113549.1.5.12")throw new Z("Only pkcs5PBKDF2 key derivation functions are supported");const i=r.valueBlock.value[1],o=Vo(i.valueBlock.value[0].getValue());let a=oh,l=ih;if(i.valueBlock.value.length===3)a=Number(i.valueBlock.value[1].toBigInt()),l=Number(i.valueBlock.value[2].toBigInt());else if(i.valueBlock.value.length===2)throw new Z("Could not derive key size and iterations from PEM file - please use @libp2p/rsa to re-import your key");const u=t.valueBlock.value[1].valueBlock.value[1],h=u.valueBlock.value[0].toString();if(h!=="OBJECT IDENTIFIER : 1.2.840.113549.3.7"){if(h!=="OBJECT IDENTIFIER : 1.3.14.3.2.7"){if(h!=="OBJECT IDENTIFIER : 2.16.840.1.101.3.4.1.2"){if(h!=="OBJECT IDENTIFIER : 2.16.840.1.101.3.4.1.22"){if(h!=="OBJECT IDENTIFIER : 2.16.840.1.101.3.4.1.42")throw new Z("Only AES-CBC encryption schemes are supported")}}}}const c=Vo(u.valueBlock.value[1].getValue());return{cipherText:Vo(n.valueBlock.value[1].getValue()),salt:o,iterations:a,keySize:l,iv:c}}function Xg(n){return Vo(n.valueBlock.value[2].getValue())}function Vo(n){return new Uint8Array(n,0,n.byteLength)}const FD="/pkcs8/",ah="/info/",xo=new WeakMap,ps={minKeyLength:112/8,minSaltLength:128/8,minIterationCount:1e3},Uu={dek:{keyLength:512/8,iterationCount:1e4,salt:"you should override this value with a crypto secure random number",hash:"sha2-512"}};function ci(n){return n==null||typeof n!="string"?!1:n===bD(n.trim())&&n.length>0}async function Et(){const e=Math.random()*800+200;await new Promise(r=>setTimeout(r,e))}function gs(n){return new ut(FD+n)}function li(n){return new ut(ah+n)}async function $D(n){const t=$l(n),e=await xa.digest(t);return ot.encode(e.bytes).substring(1)}var my,yy;yy=Symbol.toStringTag,my=Wn;class UD{constructor(t,e){p(this,"components");p(this,"init");p(this,"log");p(this,"self");p(this,yy,"@libp2p/keychain");p(this,my,["@libp2p/keychain"]);if(this.components=t,this.log=t.logger.forComponent("libp2p:keychain"),this.init=Qf(Uu,e),this.self=e.selfKey??"self",this.init.pass!=null&&this.init.pass?.length<20)throw new Error("pass must be least 20 characters");if(this.init.dek?.keyLength!=null&&this.init.dek.keyLength<ps.minKeyLength)throw new Error(`dek.keyLength must be least ${ps.minKeyLength} bytes`);if(this.init.dek?.salt?.length!=null&&this.init.dek.salt.length<ps.minSaltLength)throw new Error(`dek.saltLength must be least ${ps.minSaltLength} bytes`);if(this.init.dek?.iterationCount!=null&&this.init.dek.iterationCount<ps.minIterationCount)throw new Error(`dek.iterationCount must be least ${ps.minIterationCount}`);const r=this.init.pass!=null&&this.init.dek?.salt!=null?fg(this.init.pass,this.init.dek?.salt,this.init.dek?.iterationCount,this.init.dek?.keyLength,this.init.dek?.hash):"";xo.set(this,{dek:r})}static generateOptions(){const t=Object.assign({},Uu),e=Math.ceil(ps.minSaltLength/3)*3;return t.dek.salt=he(Ui(e),"base64"),t}static get options(){return Uu}async findKeyByName(t){if(!ci(t))throw await Et(),new Z(`Invalid key name '${t}'`);const e=li(t);try{const r=await this.components.datastore.get(e);return JSON.parse(he(r))}catch(r){throw await Et(),this.log.error(r),new Ec(`Key '${t}' does not exist.`)}}async findKeyById(t){try{const e={prefix:ah};for await(const r of this.components.datastore.query(e)){const s=JSON.parse(he(r.value));if(s.id===t)return s}throw new Z(`Key with id '${t}' does not exist.`)}catch(e){throw await Et(),e}}async importKey(t,e){if(!ci(t))throw await Et(),new Z(`Invalid key name '${t}'`);if(e==null)throw await Et(),new Z("Key is required");const r=gs(t);if(await this.components.datastore.has(r))throw await Et(),new Z(`Key '${t}' already exists`);let i,o;try{i=await $D(e);const u=xo.get(this);if(u==null)throw new Z("dek missing");const h=u.dek;o=await jg(e,h,e.type==="RSA"?"pkcs-8":"libp2p-key")}catch(u){throw await Et(),u}const a={name:t,id:i},l=this.components.datastore.batch();return l.put(r,te(o)),l.put(li(t),te(JSON.stringify(a))),await l.commit(),a}async exportKey(t){if(!ci(t))throw await Et(),new Z(`Invalid key name '${t}'`);const e=gs(t);try{const r=await this.components.datastore.get(e),s=he(r),i=xo.get(this);if(i==null)throw new Z("dek missing");const o=i.dek;return await Zg(s,o)}catch(r){throw await Et(),r}}async removeKey(t){if(!ci(t)||t===this.self)throw await Et(),new Z(`Invalid key name '${t}'`);const e=gs(t),r=await this.findKeyByName(t),s=this.components.datastore.batch();return s.delete(e),s.delete(li(t)),await s.commit(),r}async listKeys(){const t={prefix:ah},e=[];for await(const r of this.components.datastore.query(t))e.push(JSON.parse(he(r.value)));return e}async renameKey(t,e){if(!ci(t)||t===this.self)throw await Et(),new Z(`Invalid old key name '${t}'`);if(!ci(e)||e===this.self)throw await Et(),new Z(`Invalid new key name '${e}'`);const r=gs(t),s=gs(e),i=li(t),o=li(e);if(await this.components.datastore.has(s))throw await Et(),new Z(`Key '${e}' already exists`);try{const l=await this.components.datastore.get(r),u=await this.components.datastore.get(i),h=JSON.parse(he(u));h.name=e;const c=this.components.datastore.batch();return c.put(s,l),c.put(o,te(JSON.stringify(h))),c.delete(r),c.delete(i),await c.commit(),h}catch(l){throw await Et(),l}}async rotateKeychainPass(t,e){if(typeof t!="string")throw await Et(),new Z(`Invalid old pass type '${typeof t}'`);if(typeof e!="string")throw await Et(),new Z(`Invalid new pass type '${typeof e}'`);if(e.length<20)throw await Et(),new Z(`Invalid pass length ${e.length}`);this.log("recreating keychain");const r=xo.get(this);if(r==null)throw new Z("dek missing");const s=r.dek;this.init.pass=e;const i=e!=null&&this.init.dek?.salt!=null?fg(e,this.init.dek.salt,this.init.dek?.iterationCount,this.init.dek?.keyLength,this.init.dek?.hash):"";xo.set(this,{dek:i});const o=await this.listKeys();for(const a of o){const l=await this.components.datastore.get(gs(a.name)),u=he(l),h=await Zg(u,s),c=i.toString(),d=await jg(h,c,h.type==="RSA"?"pkcs-8":"libp2p-key"),f=this.components.datastore.batch(),g={name:a.name,id:a.id};f.put(gs(a.name),te(d)),f.put(li(a.name),te(JSON.stringify(g))),await f.commit()}this.log("keychain reconstructed")}}function A_(n={}){return t=>new UD(t,n)}const Zi=1e3,Xi=Zi*60,Ji=Xi*60,qs=Ji*24,VD=qs*7,HD=qs*365.25;function x_(n,t){try{if(typeof n=="string"&&n.length>0)return zD(n);if(typeof n=="number"&&isFinite(n))return t?.long?WD(n):qD(n);throw new Error("Value is not a string or number.")}catch(e){const r=GD(e)?`${e.message}. value=${JSON.stringify(n)}`:"An unknown error has occured.";throw new Error(r)}}function zD(n){if(n=String(n),n.length>100)throw new Error("Value exceeds the maximum length of 100 characters.");const t=/^(-?(?:\d+)?\.?\d+) *(milliseconds?|msecs?|ms|seconds?|secs?|s|minutes?|mins?|m|hours?|hrs?|h|days?|d|weeks?|w|years?|yrs?|y)?$/i.exec(n);if(!t)return NaN;const e=parseFloat(t[1]),r=(t[2]||"ms").toLowerCase();switch(r){case"years":case"year":case"yrs":case"yr":case"y":return e*HD;case"weeks":case"week":case"w":return e*VD;case"days":case"day":case"d":return e*qs;case"hours":case"hour":case"hrs":case"hr":case"h":return e*Ji;case"minutes":case"minute":case"mins":case"min":case"m":return e*Xi;case"seconds":case"second":case"secs":case"sec":case"s":return e*Zi;case"milliseconds":case"millisecond":case"msecs":case"msec":case"ms":return e;default:throw new Error(`The unit ${r} was matched, but no matching case exists.`)}}function qD(n){const t=Math.abs(n);return t>=qs?`${Math.round(n/qs)}d`:t>=Ji?`${Math.round(n/Ji)}h`:t>=Xi?`${Math.round(n/Xi)}m`:t>=Zi?`${Math.round(n/Zi)}s`:`${n}ms`}function WD(n){const t=Math.abs(n);return t>=qs?qa(n,t,qs,"day"):t>=Ji?qa(n,t,Ji,"hour"):t>=Xi?qa(n,t,Xi,"minute"):t>=Zi?qa(n,t,Zi,"second"):`${n} ms`}function qa(n,t,e,r){const s=t>=e*1.5;return`${Math.round(n/e)} ${r}${s?"s":""}`}function GD(n){return typeof n=="object"&&n!==null&&"message"in n}function KD(n){e.debug=e,e.default=e,e.coerce=l,e.disable=i,e.enable=s,e.enabled=o,e.humanize=x_,e.destroy=u,Object.keys(n).forEach(h=>{e[h]=n[h]}),e.names=[],e.skips=[],e.formatters={};function t(h){let c=0;for(let d=0;d<h.length;d++)c=(c<<5)-c+h.charCodeAt(d),c|=0;return e.colors[Math.abs(c)%e.colors.length]}e.selectColor=t;function e(h){let c,d=null,f,g;function y(...m){if(!y.enabled)return;const v=y,_=Number(new Date),w=_-(c||_);v.diff=w,v.prev=c,v.curr=_,c=_,m[0]=e.coerce(m[0]),typeof m[0]!="string"&&m.unshift("%O");let S=0;m[0]=m[0].replace(/%([a-zA-Z%])/g,(E,I)=>{if(E==="%%")return"%";S++;const k=e.formatters[I];if(typeof k=="function"){const x=m[S];E=k.call(v,x),m.splice(S,1),S--}return E}),e.formatArgs.call(v,m),(v.log||e.log).apply(v,m)}return y.namespace=h,y.useColors=e.useColors(),y.color=e.selectColor(h),y.extend=r,y.destroy=e.destroy,Object.defineProperty(y,"enabled",{enumerable:!0,configurable:!1,get:()=>d!==null?d:(f!==e.namespaces&&(f=e.namespaces,g=e.enabled(h)),g),set:m=>{d=m}}),typeof e.init=="function"&&e.init(y),y}function r(h,c){const d=e(this.namespace+(typeof c>"u"?":":c)+h);return d.log=this.log,d}function s(h){e.save(h),e.namespaces=h,e.names=[],e.skips=[];let c;const d=(typeof h=="string"?h:"").split(/[\s,]+/),f=d.length;for(c=0;c<f;c++)d[c]&&(h=d[c].replace(/\*/g,".*?"),h[0]==="-"?e.skips.push(new RegExp("^"+h.substr(1)+"$")):e.names.push(new RegExp("^"+h+"$")))}function i(){const h=[...e.names.map(a),...e.skips.map(a).map(c=>"-"+c)].join(",");return e.enable(""),h}function o(h){if(h[h.length-1]==="*")return!0;let c,d;for(c=0,d=e.skips.length;c<d;c++)if(e.skips[c].test(h))return!1;for(c=0,d=e.names.length;c<d;c++)if(e.names[c].test(h))return!0;return!1}function a(h){return h.toString().substring(2,h.toString().length-2).replace(/\.\*\?$/,"*")}function l(h){return h instanceof Error?h.stack??h.message:h}function u(){console.warn("Instance method `debug.destroy()` is deprecated and no longer does anything. It will be removed in the next major version of `debug`.")}return e.setupFormatters(e.formatters),e.enable(e.load()),e}var YD={};const Xc=tM(),QD=["#0000CC","#0000FF","#0033CC","#0033FF","#0066CC","#0066FF","#0099CC","#0099FF","#00CC00","#00CC33","#00CC66","#00CC99","#00CCCC","#00CCFF","#3300CC","#3300FF","#3333CC","#3333FF","#3366CC","#3366FF","#3399CC","#3399FF","#33CC00","#33CC33","#33CC66","#33CC99","#33CCCC","#33CCFF","#6600CC","#6600FF","#6633CC","#6633FF","#66CC00","#66CC33","#9900CC","#9900FF","#9933CC","#9933FF","#99CC00","#99CC33","#CC0000","#CC0033","#CC0066","#CC0099","#CC00CC","#CC00FF","#CC3300","#CC3333","#CC3366","#CC3399","#CC33CC","#CC33FF","#CC6600","#CC6633","#CC9900","#CC9933","#CCCC00","#CCCC33","#FF0000","#FF0033","#FF0066","#FF0099","#FF00CC","#FF00FF","#FF3300","#FF3333","#FF3366","#FF3399","#FF33CC","#FF33FF","#FF6600","#FF6633","#FF9900","#FF9933","#FFCC00","#FFCC33"];function jD(){return typeof window<"u"&&window.process&&(window.process.type==="renderer"||window.process.__nwjs)?!0:typeof navigator<"u"&&navigator.userAgent?.toLowerCase().match(/(edge|trident)\/(\d+)/)!=null?!1:typeof document<"u"&&document.documentElement?.style?.WebkitAppearance||typeof window<"u"&&window.console&&(window.console.firebug||window.console.exception&&window.console.table)||typeof navigator<"u"&&navigator.userAgent?.toLowerCase().match(/firefox\/(\d+)/)!=null&&parseInt(RegExp.$1,10)>=31||typeof navigator<"u"&&navigator.userAgent?.toLowerCase().match(/applewebkit\/(\d+)/)}function ZD(n){if(n[0]=(this.useColors?"%c":"")+this.namespace+(this.useColors?" %c":" ")+n[0]+(this.useColors?"%c ":" ")+"+"+x_(this.diff),!this.useColors)return;const t="color: "+this.color;n.splice(1,0,t,"color: inherit");let e=0,r=0;n[0].replace(/%[a-zA-Z%]/g,s=>{s!=="%%"&&(e++,s==="%c"&&(r=e))}),n.splice(r,0,t)}const XD=console.debug??console.log??(()=>{});function JD(n){try{n?Xc?.setItem("debug",n):Xc?.removeItem("debug")}catch{}}function eM(){let n;try{n=Xc?.getItem("debug")}catch{}return!n&&typeof globalThis.process<"u"&&"env"in globalThis.process&&(n=YD.DEBUG),n}function tM(){try{return localStorage}catch{}}function nM(n){n.j=function(t){try{return JSON.stringify(t)}catch(e){return"[UnexpectedJSONParseError]: "+e.message}}}const mn=KD({formatArgs:ZD,save:JD,load:eM,useColors:jD,setupFormatters:nM,colors:QD,storage:Xc,log:XD});mn.formatters.b=n=>n==null?"undefined":ot.baseEncode(n);mn.formatters.t=n=>n==null?"undefined":Cr.baseEncode(n);mn.formatters.m=n=>n==null?"undefined":Aa.baseEncode(n);mn.formatters.p=n=>n==null?"undefined":n.toString();mn.formatters.c=n=>n==null?"undefined":n.toString();mn.formatters.k=n=>n==null?"undefined":n.toString();mn.formatters.a=n=>n==null?"undefined":n.toString();mn.formatters.e=n=>n==null?"undefined":Jg(n.stack)??Jg(n.message)??n.toString();function rM(n){const t=()=>{};return t.enabled=!1,t.color="",t.diff=0,t.log=()=>{},t.namespace=n,t.destroy=()=>!0,t.extend=()=>t,t}function rp(){return{forComponent(n){return I_(n)}}}function I_(n){let t=rM(`${n}:trace`);return mn.enabled(`${n}:trace`)&&mn.names.map(e=>e.toString()).find(e=>e.includes(":trace"))!=null&&(t=mn(`${n}:trace`)),Object.assign(mn(n),{error:mn(`${n}:error`),trace:t})}function Jg(n){if(n!=null&&(n=n.trim(),n.length!==0))return n}async function sM(n,t={}){const e=t.selfKey??"self",r=A_(t)({datastore:n,logger:rp()});let s;return await n.has(new ut(`/pkcs8/${e}`))?s=await r.exportKey(e):(s=await jb(t.keyType??"Ed25519"),await r.importKey(e,s)),s}function iM(n){return n[Symbol.asyncIterator]!=null}function em(n){if(iM(n))return(async()=>{for await(const t of n);})();for(const t of n);}const Wa=globalThis.CustomEvent??Event;async function*oM(n,t={}){let e=t.concurrency??1/0;e<1&&(e=1/0);const r=t.ordered??!1,s=new EventTarget,i=[];let o=bt(),a=bt(),l=!1,u,h=!1;s.addEventListener("task-complete",()=>{a.resolve()}),Promise.resolve().then(async()=>{try{for await(const g of n){if(i.length===e&&(o=bt(),await o.promise),h)break;const y={done:!1};i.push(y),g().then(m=>{y.done=!0,y.ok=!0,y.value=m,s.dispatchEvent(new Wa("task-complete"))},m=>{y.done=!0,y.err=m,s.dispatchEvent(new Wa("task-complete"))})}l=!0,s.dispatchEvent(new Wa("task-complete"))}catch(g){u=g,s.dispatchEvent(new Wa("task-complete"))}});function c(){return r?i[0]?.done:!!i.find(g=>g.done)}function*d(){for(;i.length>0&&i[0].done;){const g=i[0];if(i.shift(),g.ok)yield g.value;else throw h=!0,o.resolve(),g.err;o.resolve()}}function*f(){for(;c();)for(let g=0;g<i.length;g++)if(i[g].done){const y=i[g];if(i.splice(g,1),g--,y.ok)yield y.value;else throw h=!0,o.resolve(),y.err;o.resolve()}}for(;;){if(c()||(a=bt(),await a.promise),u!=null)throw u;if(r?yield*d():yield*f(),l&&i.length===0)break}}const aM="0.1.0",cM="id",lM="1.0.0",uM=1024*8;var Jc;(function(n){let t;n.codec=()=>(t==null&&(t=Ce((e,r,s={})=>{if(s.lengthDelimited!==!1&&r.fork(),e.protocolVersion!=null&&(r.uint32(42),r.string(e.protocolVersion)),e.agentVersion!=null&&(r.uint32(50),r.string(e.agentVersion)),e.publicKey!=null&&(r.uint32(10),r.bytes(e.publicKey)),e.listenAddrs!=null)for(const i of e.listenAddrs)r.uint32(18),r.bytes(i);if(e.observedAddr!=null&&(r.uint32(34),r.bytes(e.observedAddr)),e.protocols!=null)for(const i of e.protocols)r.uint32(26),r.string(i);e.signedPeerRecord!=null&&(r.uint32(66),r.bytes(e.signedPeerRecord)),s.lengthDelimited!==!1&&r.ldelim()},(e,r,s={})=>{const i={listenAddrs:[],protocols:[]},o=r==null?e.len:e.pos+r;for(;e.pos<o;){const a=e.uint32();switch(a>>>3){case 5:{i.protocolVersion=e.string();break}case 6:{i.agentVersion=e.string();break}case 1:{i.publicKey=e.bytes();break}case 2:{if(s.limits?.listenAddrs!=null&&i.listenAddrs.length===s.limits.listenAddrs)throw new gt('Decode error - map field "listenAddrs" had too many elements');i.listenAddrs.push(e.bytes());break}case 4:{i.observedAddr=e.bytes();break}case 3:{if(s.limits?.protocols!=null&&i.protocols.length===s.limits.protocols)throw new gt('Decode error - map field "protocols" had too many elements');i.protocols.push(e.string());break}case 8:{i.signedPeerRecord=e.bytes();break}default:{e.skipType(a&7);break}}}return i})),t),n.encode=e=>Te(e,n.codec()),n.decode=(e,r)=>ke(e,n.codec(),r)})(Jc||(Jc={}));const yr={protocolPrefix:"ipfs",timeout:5e3,maxInboundStreams:1,maxOutboundStreams:1,maxObservedAddresses:10,maxMessageSize:uM,runOnConnectionOpen:!0,runOnLimitedConnection:!0};function dM(n){if(n!=null&&n.length>0)try{return me(n)}catch{}}function hM(n,t){return t??n.userAgent}async function fM(n,t,e,r,s){if(e("received identify from %p",r.remotePeer),s==null)throw new Xn("message was null or undefined");const i={};if(s.listenAddrs.length>0&&(i.addresses=s.listenAddrs.map(l=>({isCertified:!1,multiaddr:me(l)}))),s.protocols.length>0&&(i.protocols=s.protocols),s.publicKey!=null){const l=Lr(s.publicKey);if(!Ta(l).equals(r.remotePeer))throw new Xn("public key did not match remote PeerId");i.publicKey=l}let o;if(s.signedPeerRecord!=null){e.trace("received signedPeerRecord from %p",r.remotePeer);let l=s.signedPeerRecord;const u=await Hs.openAndCertify(l,Dr.DOMAIN);let h=Dr.createFromProtobuf(u.payload);const c=Ul(u.publicKey.toCID());if(!h.peerId.equals(c))throw new Xn("signing key does not match PeerId in the PeerRecord");if(!r.remotePeer.equals(h.peerId))throw new Xn("signing key does not match remote PeerId");let d;try{d=await n.get(h.peerId)}catch(f){if(f.name!=="NotFoundError")throw f}if(d!=null&&(i.metadata=d.metadata,d.peerRecordEnvelope!=null)){const f=await Hs.createFromProtobuf(d.peerRecordEnvelope),g=Dr.createFromProtobuf(f.payload);g.seqNumber>=h.seqNumber&&(e("sequence number was lower or equal to existing sequence number - stored: %d received: %d",g.seqNumber,h.seqNumber),h=g,l=d.peerRecordEnvelope)}i.peerRecordEnvelope=l,i.addresses=h.multiaddrs.map(f=>({isCertified:!0,multiaddr:f})),o={seq:h.seqNumber,addresses:h.multiaddrs}}else e("%p did not send a signed peer record",r.remotePeer);if(e.trace("patching %p with",r.remotePeer,i),await n.patch(r.remotePeer,i),s.agentVersion!=null||s.protocolVersion!=null){const l={};s.agentVersion!=null&&(l.AgentVersion=te(s.agentVersion)),s.protocolVersion!=null&&(l.ProtocolVersion=te(s.protocolVersion)),e.trace("merging %p metadata",r.remotePeer,l),await n.merge(r.remotePeer,{metadata:l})}const a={peerId:r.remotePeer,protocolVersion:s.protocolVersion,agentVersion:s.agentVersion,publicKey:s.publicKey,listenAddrs:s.listenAddrs.map(l=>me(l)),observedAddr:s.observedAddr==null?void 0:me(s.observedAddr),protocols:s.protocols,signedPeerRecord:o,connection:r};return t.safeDispatchEvent("peer:identify",{detail:a}),a}class pM{constructor(t,e){p(this,"host");p(this,"protocol");p(this,"started");p(this,"timeout");p(this,"peerId");p(this,"privateKey");p(this,"peerStore");p(this,"registrar");p(this,"addressManager");p(this,"maxInboundStreams");p(this,"maxOutboundStreams");p(this,"maxMessageSize");p(this,"maxObservedAddresses");p(this,"events");p(this,"runOnLimitedConnection");p(this,"log");this.protocol=e.protocol,this.started=!1,this.peerId=t.peerId,this.privateKey=t.privateKey,this.peerStore=t.peerStore,this.registrar=t.registrar,this.addressManager=t.addressManager,this.events=t.events,this.log=e.log,this.timeout=e.timeout??yr.timeout,this.maxInboundStreams=e.maxInboundStreams??yr.maxInboundStreams,this.maxOutboundStreams=e.maxOutboundStreams??yr.maxOutboundStreams,this.maxMessageSize=e.maxMessageSize??yr.maxMessageSize,this.maxObservedAddresses=e.maxObservedAddresses??yr.maxObservedAddresses,this.runOnLimitedConnection=e.runOnLimitedConnection??yr.runOnLimitedConnection,this.host={protocolVersion:`${e.protocolPrefix??yr.protocolPrefix}/${aM}`,agentVersion:hM(t.nodeInfo,e.agentVersion)}}isStarted(){return this.started}async start(){this.started||(await this.peerStore.merge(this.peerId,{metadata:{AgentVersion:te(this.host.agentVersion),ProtocolVersion:te(this.host.protocolVersion)}}),await this.registrar.handle(this.protocol,t=>{this.handleProtocol(t).catch(e=>{this.log.error(e)})},{maxInboundStreams:this.maxInboundStreams,maxOutboundStreams:this.maxOutboundStreams,runOnLimitedConnection:this.runOnLimitedConnection}),this.started=!0)}async stop(){await this.registrar.unhandle(this.protocol),this.started=!1}}const gM=41;function mM(n){try{const[[t,e]]=n.stringTuples();if(e==null)return!1;if(t===gM)return aC("2000::/3",e)}catch{}return!1}var ui={},tm;function yM(){return tm||(tm=1,function(){var n,t,e,r,s,i,o,a;a=function(l){var u,h,c,d;return u=(l&255<<24)>>>24,h=(l&255<<16)>>>16,c=(l&65280)>>>8,d=l&255,[u,h,c,d].join(".")},o=function(l){var u,h,c,d,f,g;for(u=[],c=d=0;d<=3&&l.length!==0;c=++d){if(c>0){if(l[0]!==".")throw new Error("Invalid IP");l=l.substring(1)}g=t(l),f=g[0],h=g[1],l=l.substring(h),u.push(f)}if(l.length!==0)throw new Error("Invalid IP");switch(u.length){case 1:if(u[0]>4294967295)throw new Error("Invalid IP");return u[0]>>>0;case 2:if(u[0]>255||u[1]>16777215)throw new Error("Invalid IP");return(u[0]<<24|u[1])>>>0;case 3:if(u[0]>255||u[1]>255||u[2]>65535)throw new Error("Invalid IP");return(u[0]<<24|u[1]<<16|u[2])>>>0;case 4:if(u[0]>255||u[1]>255||u[2]>255||u[3]>255)throw new Error("Invalid IP");return(u[0]<<24|u[1]<<16|u[2]<<8|u[3])>>>0;default:throw new Error("Invalid IP")}},e=function(l){return l.charCodeAt(0)},r=e("0"),i=e("a"),s=e("A"),t=function(l){var u,h,c,d,f;for(d=0,u=10,h="9",c=0,l.length>1&&l[c]==="0"&&(l[c+1]==="x"||l[c+1]==="X"?(c+=2,u=16):"0"<=l[c+1]&&l[c+1]<="9"&&(c++,u=8,h="7")),f=c;c<l.length;){if("0"<=l[c]&&l[c]<=h)d=d*u+(e(l[c])-r)>>>0;else if(u===16)if("a"<=l[c]&&l[c]<="f")d=d*u+(10+e(l[c])-i)>>>0;else if("A"<=l[c]&&l[c]<="F")d=d*u+(10+e(l[c])-s)>>>0;else break;else break;if(d>4294967295)throw new Error("too large");c++}if(c===f)throw new Error("empty octet");return[d,c]},n=function(){function l(u,h){var c,d,f;if(typeof u!="string")throw new Error("Missing `net' parameter");if(h||(f=u.split("/",2),u=f[0],h=f[1]),h||(h=32),typeof h=="string"&&h.indexOf(".")>-1){try{this.maskLong=o(h)}catch{throw new Error("Invalid mask: "+h)}for(c=d=32;d>=0;c=--d)if(this.maskLong===4294967295<<32-c>>>0){this.bitmask=c;break}}else if(h||h===0)this.bitmask=parseInt(h,10),this.maskLong=0,this.bitmask>0&&(this.maskLong=4294967295<<32-this.bitmask>>>0);else throw new Error("Invalid mask: empty");try{this.netLong=(o(u)&this.maskLong)>>>0}catch{throw new Error("Invalid net address: "+u)}if(!(this.bitmask<=32))throw new Error("Invalid mask for ip4: "+h);this.size=Math.pow(2,32-this.bitmask),this.base=a(this.netLong),this.mask=a(this.maskLong),this.hostmask=a(~this.maskLong),this.first=this.bitmask<=30?a(this.netLong+1):this.base,this.last=this.bitmask<=30?a(this.netLong+this.size-2):a(this.netLong+this.size-1),this.broadcast=this.bitmask<=30?a(this.netLong+this.size-1):void 0}return l.prototype.contains=function(u){return typeof u=="string"&&(u.indexOf("/")>0||u.split(".").length!==4)&&(u=new l(u)),u instanceof l?this.contains(u.base)&&this.contains(u.broadcast||u.last):(o(u)&this.maskLong)>>>0===(this.netLong&this.maskLong)>>>0},l.prototype.next=function(u){return u==null&&(u=1),new l(a(this.netLong+this.size*u),this.mask)},l.prototype.forEach=function(u){var h,c,d;for(d=o(this.first),c=o(this.last),h=0;d<=c;)u(a(d),d,h),h++,d++},l.prototype.toString=function(){return this.base+"/"+this.bitmask},l}(),ui.ip2long=o,ui.long2ip=a,ui.Netmask=n}.call(ui)),ui}var vM=yM();const bM=["0.0.0.0/8","10.0.0.0/8","100.64.0.0/10","127.0.0.0/8","169.254.0.0/16","172.16.0.0/12","192.0.0.0/24","192.0.0.0/29","192.0.0.8/32","192.0.0.9/32","192.0.0.10/32","192.0.0.170/32","192.0.0.171/32","192.0.2.0/24","192.31.196.0/24","192.52.193.0/24","192.88.99.0/24","192.168.0.0/16","192.175.48.0/24","198.18.0.0/15","198.51.100.0/24","203.0.113.0/24","240.0.0.0/4","255.255.255.255/32"],wM=bM.map(n=>new vM.Netmask(n));function sp(n){for(const t of wM)if(t.contains(n))return!0;return!1}function _M(n){return/^::ffff:([0-9a-fA-F]{1,4}):([0-9a-fA-F]{1,4})$/.test(n)}function SM(n){const t=n.split(":");if(t.length<2)return!1;const e=t[t.length-1].padStart(4,"0"),r=t[t.length-2].padStart(4,"0"),s=`${parseInt(r.substring(0,2),16)}.${parseInt(r.substring(2),16)}.${parseInt(e.substring(0,2),16)}.${parseInt(e.substring(2),16)}`;return sp(s)}function EM(n){return/^::ffff:([0-9]{1,3})\.([0-9]{1,3})\.([0-9]{1,3})\.([0-9]{1,3})$/.test(n)}function AM(n){const t=n.split(":"),e=t[t.length-1];return sp(e)}function xM(n){return/^::$/.test(n)||/^::1$/.test(n)||/^64:ff9b::([0-9]{1,3})\.([0-9]{1,3})\.([0-9]{1,3})\.([0-9]{1,3})$/.test(n)||/^100::([0-9a-fA-F]{0,4}):?([0-9a-fA-F]{0,4}):?([0-9a-fA-F]{0,4}):?([0-9a-fA-F]{0,4})$/.test(n)||/^2001::([0-9a-fA-F]{0,4}):?([0-9a-fA-F]{0,4}):?([0-9a-fA-F]{0,4}):?([0-9a-fA-F]{0,4}):?([0-9a-fA-F]{0,4}):?([0-9a-fA-F]{0,4})$/.test(n)||/^2001:2[0-9a-fA-F]:([0-9a-fA-F]{0,4}):?([0-9a-fA-F]{0,4}):?([0-9a-fA-F]{0,4}):?([0-9a-fA-F]{0,4}):?([0-9a-fA-F]{0,4}):?([0-9a-fA-F]{0,4})$/.test(n)||/^2001:db8:([0-9a-fA-F]{0,4}):?([0-9a-fA-F]{0,4}):?([0-9a-fA-F]{0,4}):?([0-9a-fA-F]{0,4}):?([0-9a-fA-F]{0,4}):?([0-9a-fA-F]{0,4})$/.test(n)||/^2002:([0-9a-fA-F]{0,4}):?([0-9a-fA-F]{0,4}):?([0-9a-fA-F]{0,4}):?([0-9a-fA-F]{0,4}):?([0-9a-fA-F]{0,4}):?([0-9a-fA-F]{0,4}):?([0-9a-fA-F]{0,4})$/.test(n)||/^f[c-d]([0-9a-fA-F]{2,2}):/i.test(n)||/^fe[8-9a-bA-B][0-9a-fA-F]:/i.test(n)||/^ff([0-9a-fA-F]{2,2}):/i.test(n)}function Jl(n){return zi(n)?sp(n):_M(n)?SM(n):EM(n)?AM(n):Lf(n)?xM(n):void 0}const IM=4,kM=41;function k_(n){try{const[[t]]=n.stringTuples();return t===IM||t===kM}catch{}return!1}function aa(n){try{if(!k_(n))return!1;const[[,t]]=n.stringTuples();return t==null?!1:Jl(t)??!1}catch{}return!0}const TM=41;var vy,by;class CM extends(by=pM,vy=Wn,by){constructor(e,r={}){super(e,{...r,protocol:`/${r.protocolPrefix??yr.protocolPrefix}/${cM}/${lM}`,log:e.logger.forComponent("libp2p:identify")});p(this,vy,["@libp2p/identify"]);(r.runOnConnectionOpen??yr.runOnConnectionOpen)&&e.events.addEventListener("connection:open",s=>{const i=s.detail;this.identify(i).catch(o=>{o.name!==kl.name&&this.log.error("error during identify trigged by connection:open",o)})})}async _identify(e,r={}){let s;if(r.signal==null){const i=AbortSignal.timeout(this.timeout);r={...r,signal:i}}try{s=await e.newStream(this.protocol,{...r,runOnLimitedConnection:this.runOnLimitedConnection});const o=await Wi(s,{maxDataLength:this.maxMessageSize}).pb(Jc).read(r);return await s.close(r),o}catch(i){throw s?.abort(i),i}}async identify(e,r={}){const s=await this._identify(e,r),{publicKey:i,protocols:o,observedAddr:a}=s;if(i==null)throw new Xn("public key was missing from identify message");const l=Lr(i),u=Ul(l.toCID());if(!e.remotePeer.equals(u))throw new Xn("identified peer does not match the expected peer");if(this.peerId.equals(u))throw new Xn("identified peer is our own peer id?");return this.maybeAddObservedAddress(a),this.log("identify completed for peer %p and protocols %o",u,o),fM(this.peerStore,this.events,this.log,e,s)}maybeAddObservedAddress(e){const r=dM(e);if(r==null)return;if(this.log.trace("our observed address was %a",r),aa(r)){this.log.trace("our observed address was private");return}if(r.stringTuples()[0][0]===TM&&!mM(r)){this.log.trace("our observed address was IPv6 but not a global unicast address");return}Gc.exactMatch(r)||(this.log.trace("storing the observed address"),this.addressManager.addObservedAddr(r))}async handleProtocol(e){const{connection:r,stream:s}=e,i=AbortSignal.timeout(this.timeout);try{const o=await this.peerStore.get(this.peerId),a=this.addressManager.getAddresses().map(c=>c.decapsulateCode(pe("p2p").code));let l=o.peerRecordEnvelope;if(a.length>0&&l==null){const c=new Dr({peerId:this.peerId,multiaddrs:a});l=(await Hs.seal(c,this.privateKey)).marshal().subarray()}let u=r.remoteAddr.bytes;xP.matches(r.remoteAddr)||(u=void 0),await Wi(s).pb(Jc).write({protocolVersion:this.host.protocolVersion,agentVersion:this.host.agentVersion,publicKey:nr(this.privateKey.publicKey),listenAddrs:a.map(c=>c.bytes),signedPeerRecord:l,observedAddr:u,protocols:o.protocols},{signal:i}),await s.close({signal:i})}catch(o){this.log.error("could not respond to identify request",o),s.abort(o)}}}function PM(n={}){return t=>new CM(t,n)}var ch;(function(n){let t;n.codec=()=>(t==null&&(t=Ce((e,r,s={})=>{s.lengthDelimited!==!1&&r.fork(),e.id!=null&&(r.uint32(10),r.bytes(e.id)),e.pubkey!=null&&(r.uint32(18),el.codec().encode(e.pubkey,r)),s.lengthDelimited!==!1&&r.ldelim()},(e,r,s={})=>{const i={},o=r==null?e.len:e.pos+r;for(;e.pos<o;){const a=e.uint32();switch(a>>>3){case 1:{i.id=e.bytes();break}case 2:{i.pubkey=el.codec().decode(e,e.uint32(),{limits:s.limits?.pubkey});break}default:{e.skipType(a&7);break}}}return i})),t),n.encode=e=>Te(e,n.codec()),n.decode=(e,r)=>ke(e,n.codec(),r)})(ch||(ch={}));var Ws;(function(n){n.RSA="RSA",n.Ed25519="Ed25519",n.secp256k1="secp256k1",n.ECDSA="ECDSA"})(Ws||(Ws={}));var lh;(function(n){n[n.RSA=0]="RSA",n[n.Ed25519=1]="Ed25519",n[n.secp256k1=2]="secp256k1",n[n.ECDSA=3]="ECDSA"})(lh||(lh={}));(function(n){n.codec=()=>Ia(lh)})(Ws||(Ws={}));var el;(function(n){let t;n.codec=()=>(t==null&&(t=Ce((e,r,s={})=>{s.lengthDelimited!==!1&&r.fork(),e.Type!=null&&(r.uint32(8),Ws.codec().encode(e.Type,r)),e.Data!=null&&e.Data.byteLength>0&&(r.uint32(18),r.bytes(e.Data)),s.lengthDelimited!==!1&&r.ldelim()},(e,r,s={})=>{const i={Data:Ke(0)},o=r==null?e.len:e.pos+r;for(;e.pos<o;){const a=e.uint32();switch(a>>>3){case 1:{i.Type=Ws.codec().decode(e);break}case 2:{i.Data=e.bytes();break}default:{e.skipType(a&7);break}}}return i})),t),n.encode=e=>Te(e,n.codec()),n.decode=(e,r)=>ke(e,n.codec(),r)})(el||(el={}));const DM="/plaintext/2.0.0";var wy,_y;_y=Symbol.toStringTag,wy=Wn;class MM{constructor(t){p(this,"protocol",DM);p(this,"privateKey");p(this,"log");p(this,_y,"@libp2p/plaintext");p(this,wy,["@libp2p/connection-encryption"]);this.privateKey=t.privateKey,this.log=t.logger.forComponent("libp2p:plaintext")}async secureInbound(t,e){return this._encrypt(t,e)}async secureOutbound(t,e){return this._encrypt(t,e)}async _encrypt(t,e){const r=Wi(t).pb(ch);this.log("write pubkey exchange to peer %p",e?.remotePeer);const s=this.privateKey.publicKey,[,i]=await Promise.all([r.write({id:s.toMultihash().bytes,pubkey:{Type:Ws[s.type],Data:s.raw}},e),r.read(e)]);let o;try{if(i.pubkey==null)throw new tc("Public key missing");if(i.pubkey.Data.byteLength===0)throw new tc("Public key data too short");if(i.id==null)throw new tc("Remote id missing");const a=fk(i.pubkey.Data);if(o=Ta(a),!It(o.toMultihash().bytes,i.id))throw new Td("Public key did not match id")}catch(a){throw this.log.error(a),new Td("Invalid public key - "+a.message)}if(e?.remotePeer!=null&&!o.equals(e?.remotePeer))throw new nb;return this.log("plaintext key exchange completed successfully with peer %p",o),{conn:r.unwrap().unwrap(),remotePeer:o}}}function LM(){return n=>new MM(n)}var tl;(function(n){let t;n.codec=()=>(t==null&&(t=Ce((e,r,s={})=>{if(s.lengthDelimited!==!1&&r.fork(),e.publicKey!=null&&e.publicKey.byteLength>0&&(r.uint32(10),r.bytes(e.publicKey)),e.addrs!=null)for(const i of e.addrs)r.uint32(18),r.bytes(i);s.lengthDelimited!==!1&&r.ldelim()},(e,r,s={})=>{const i={publicKey:Ke(0),addrs:[]},o=r==null?e.len:e.pos+r;for(;e.pos<o;){const a=e.uint32();switch(a>>>3){case 1:{i.publicKey=e.bytes();break}case 2:{if(s.limits?.addrs!=null&&i.addrs.length===s.limits.addrs)throw new gt('Decode error - map field "addrs" had too many elements');i.addrs.push(e.bytes());break}default:{e.skipType(a&7);break}}}return i})),t),n.encode=e=>Te(e,n.codec()),n.decode=(e,r)=>ke(e,n.codec(),r)})(tl||(tl={}));const BM="_peer-discovery._p2p._pubsub";var Sy,Ey,Ay;class NM extends(Ay=ar,Ey=_c,Sy=Symbol.toStringTag,Ay){constructor(e,r={}){super();p(this,Ey,!0);p(this,Sy,"@libp2p/pubsub-peer-discovery");p(this,"interval");p(this,"listenOnly");p(this,"topics");p(this,"intervalId");p(this,"components");p(this,"log");const{interval:s,topics:i,listenOnly:o}=r;this.components=e,this.interval=s??1e4,this.listenOnly=o??!1,this.log=e.logger.forComponent("libp2p:discovery:pubsub"),Array.isArray(i)&&i.length>0?this.topics=i:this.topics=[BM],this._onMessage=this._onMessage.bind(this)}isStarted(){return this.intervalId!=null}start(){}afterStart(){if(this.intervalId!=null)return;const e=this.components.pubsub;if(e==null)throw new Error("PubSub not configured");for(const r of this.topics)e.subscribe(r),e.addEventListener("message",this._onMessage);this.listenOnly||(this._broadcast(),this.intervalId=setInterval(()=>{this._broadcast()},this.interval))}beforeStop(){const e=this.components.pubsub;if(e==null)throw new Error("PubSub not configured");for(const r of this.topics)e.unsubscribe(r),e.removeEventListener("message",this._onMessage)}stop(){this.intervalId!=null&&(clearInterval(this.intervalId),this.intervalId=void 0)}_broadcast(){const e=this.components.peerId;if(e.publicKey==null)throw new Error("PeerId was missing public key");const r={publicKey:nr(e.publicKey),addrs:this.components.addressManager.getAddresses().map(o=>o.bytes)},s=tl.encode(r),i=this.components.pubsub;if(i==null)throw new Error("PubSub not configured");for(const o of this.topics){if(i.getSubscribers(o).length===0){this.log("skipping broadcasting our peer data on topic %s because there are no peers present",o);continue}this.log("broadcasting our peer data on topic %s",o),i.publish(o,s)}}_onMessage(e){if(!this.isStarted())return;const r=e.detail;if(this.topics.includes(r.topic))try{const s=tl.decode(r.data),i=Lr(s.publicKey),o=Ta(i);if(o.equals(this.components.peerId))return;this.log("discovered peer %p on %s",o,r.topic),this.safeDispatchEvent("peer",{detail:{id:o,multiaddrs:s.addrs.map(a=>me(a))}})}catch(s){this.log.error("error handling incoming message",s)}}}function RM(n={}){return t=>new NM(t,n)}const OM=[pe("tcp").code,pe("dns").code,pe("dnsaddr").code,pe("dns4").code,pe("dns6").code];function nm(n){return T_("sni",n)?.[1]}function rm(n){const t=T_("tcp",n)?.[1];return t==null?"":`:${t}`}function T_(n,t){let e;try{e=pe(n).code}catch{return}for(const[r,s]of t)if(r===e&&s!=null)return[r,s]}function sm(n){return n.some(([t,e])=>t===pe("tls").code)}function Nn(n,t,e){const r=C_[pe(n).name];if(r==null)throw new Error(`Can't interpret protocol ${pe(n).name}`);const s=r(t,e);return n===pe("ip6").code?`[${s}]`:s}const C_={ip4:(n,t)=>n,ip6:(n,t)=>t.length===0?n:`[${n}]`,tcp:(n,t)=>{const e=t.pop();if(e==null)throw new Error("Unexpected end of multiaddr");return`tcp://${Nn(e[0],e[1]??"",t)}:${n}`},udp:(n,t)=>{const e=t.pop();if(e==null)throw new Error("Unexpected end of multiaddr");return`udp://${Nn(e[0],e[1]??"",t)}:${n}`},dnsaddr:(n,t)=>n,dns4:(n,t)=>n,dns6:(n,t)=>n,dns:(n,t)=>n,ipfs:(n,t)=>{const e=t.pop();if(e==null)throw new Error("Unexpected end of multiaddr");return`${Nn(e[0],e[1]??"",t)}`},p2p:(n,t)=>{const e=t.pop();if(e==null)throw new Error("Unexpected end of multiaddr");return`${Nn(e[0],e[1]??"",t)}`},http:(n,t)=>{const e=sm(t),r=nm(t),s=rm(t);if(e&&r!=null)return`https://${r}${s}`;const i=e?"https://":"http://",o=t.pop();if(o==null)throw new Error("Unexpected end of multiaddr");let a=Nn(o[0],o[1]??"",t);return a=a.replace("tcp://",""),`${i}${a}`},"http-path":(n,t)=>{const e=t.pop();if(e==null)throw new Error("Unexpected end of multiaddr");const r=Nn(e[0],e[1]??"",t),s=decodeURIComponent(n);return`${r}/${s}`},tls:(n,t)=>{const e=t.pop();if(e==null)throw new Error("Unexpected end of multiaddr");return Nn(e[0],e[1]??"",t)},sni:(n,t)=>{const e=t.pop();if(e==null)throw new Error("Unexpected end of multiaddr");return Nn(e[0],e[1]??"",t)},https:(n,t)=>{const e=t.pop();if(e==null)throw new Error("Unexpected end of multiaddr");let r=Nn(e[0],e[1]??"",t);return r=r.replace("tcp://",""),`https://${r}`},ws:(n,t)=>{const e=sm(t),r=nm(t),s=rm(t);if(e&&r!=null)return`wss://${r}${s}`;const i=e?"wss://":"ws://",o=t.pop();if(o==null)throw new Error("Unexpected end of multiaddr");let a=Nn(o[0],o[1]??"",t);return a=a.replace("tcp://",""),`${i}${a}`},wss:(n,t)=>{const e=t.pop();if(e==null)throw new Error("Unexpected end of multiaddr");let r=Nn(e[0],e[1]??"",t);return r=r.replace("tcp://",""),`wss://${r}`}};function FM(n,t){const r=me(n).stringTuples(),s=r.pop();if(s==null)throw new Error("Unexpected end of multiaddr");const i=pe(s[0]),o=C_[i.name];if(o==null)throw new Error(`No interpreter found for ${i.name}`);let a=o(s[1]??"",r);return OM.includes(s[0])&&(a=a.replace(/^.*:\/\//,""),s[1]==="443"?a=`https://${a}`:a=`http://${a}`),(a.startsWith("http://")||a.startsWith("https://")||a.startsWith("ws://")||a.startsWith("wss://"))&&(a=new URL(a).toString(),a.endsWith("/")&&(a=a.substring(0,a.length-1))),a}const $M=async n=>{if(n.readyState>=2)throw new Error("socket closed");n.readyState!==1&&await new Promise((t,e)=>{function r(){n.removeEventListener("open",s),n.removeEventListener("error",i)}function s(){r(),t()}function i(o){r(),e(o.error??new Error(`connect ECONNREFUSED ${n.url}`))}n.addEventListener("open",s),n.addEventListener("error",i)})},UM=(n,t)=>(t=t??{},t.closeOnEnd=t.closeOnEnd!==!1,async r=>{for await(const s of r){try{await $M(n)}catch(i){if(i.message==="socket closed")break;throw i}if(n.readyState===n.CLOSING||n.readyState===n.CLOSED)break;n.send(s)}t.closeOnEnd!=null&&n.readyState<=1&&await new Promise((s,i)=>{n.addEventListener("close",o=>{if(o.wasClean||o.code===1006)s();else{const a=Object.assign(new Error("ws error"),{event:o});i(a)}}),setTimeout(()=>{n.close()})})});var di={},Io={},im;function VM(){if(im)return Io;im=1,Object.defineProperty(Io,"__esModule",{value:!0});class n{constructor(){this.pullQueue=[],this.pushQueue=[],this.eventHandlers={},this.isPaused=!1,this.isStopped=!1}push(r){if(this.isStopped)return;const s={value:r,done:!1};if(this.pullQueue.length){const i=this.pullQueue.shift();i&&i.resolve(s)}else this.pushQueue.push(Promise.resolve(s)),this.highWaterMark!==void 0&&this.pushQueue.length>=this.highWaterMark&&!this.isPaused&&(this.isPaused=!0,this.eventHandlers.highWater?this.eventHandlers.highWater():console&&console.warn(`EventIterator queue reached ${this.pushQueue.length} items`))}stop(){if(!this.isStopped){this.isStopped=!0,this.remove();for(const r of this.pullQueue)r.resolve({value:void 0,done:!0});this.pullQueue.length=0}}fail(r){if(!this.isStopped)if(this.isStopped=!0,this.remove(),this.pullQueue.length){for(const s of this.pullQueue)s.reject(r);this.pullQueue.length=0}else{const s=Promise.reject(r);s.catch(()=>{}),this.pushQueue.push(s)}}remove(){Promise.resolve().then(()=>{this.removeCallback&&this.removeCallback()})}[Symbol.asyncIterator](){return{next:r=>{const s=this.pushQueue.shift();return s?(this.lowWaterMark!==void 0&&this.pushQueue.length<=this.lowWaterMark&&this.isPaused&&(this.isPaused=!1,this.eventHandlers.lowWater&&this.eventHandlers.lowWater()),s):this.isStopped?Promise.resolve({value:void 0,done:!0}):new Promise((i,o)=>{this.pullQueue.push({resolve:i,reject:o})})},return:()=>(this.isStopped=!0,this.pushQueue.length=0,this.remove(),Promise.resolve({value:void 0,done:!0}))}}}class t{constructor(r,{highWaterMark:s=100,lowWaterMark:i=1}={}){const o=new n;o.highWaterMark=s,o.lowWaterMark=i,o.removeCallback=r({push:a=>o.push(a),stop:()=>o.stop(),fail:a=>o.fail(a),on:(a,l)=>{o.eventHandlers[a]=l}})||(()=>{}),this[Symbol.asyncIterator]=()=>o[Symbol.asyncIterator](),Object.freeze(this)}}return Io.EventIterator=t,Io.default=t,Io}var om;function HM(){if(om)return di;om=1,Object.defineProperty(di,"__esModule",{value:!0});const n=VM();di.EventIterator=n.EventIterator;function t(e,r,s){return new n.EventIterator(({push:i})=>(this.addEventListener(e,i,r),()=>this.removeEventListener(e,i,r)),s)}return di.subscribe=t,di.default=n.EventIterator,di}var zM=HM();function am(n){return n instanceof ArrayBuffer||n?.constructor?.name==="ArrayBuffer"&&typeof n?.byteLength=="number"}const qM=n=>{n.binaryType="arraybuffer";const t=async()=>{await new Promise((i,o)=>{if(r){i();return}if(s!=null){o(s);return}const a=h=>{n.removeEventListener("open",l),n.removeEventListener("error",u),h()},l=()=>{a(i)},u=h=>{a(()=>{o(h.error??new Error(`connect ECONNREFUSED ${n.url}`))})};n.addEventListener("open",l),n.addEventListener("error",u)})},e=async function*(){const i=new zM.EventIterator(({push:o,stop:a,fail:l})=>{const u=c=>{let d=null;typeof c.data=="string"&&(d=te(c.data)),am(c.data)&&(d=new Uint8Array(c.data)),c.data instanceof Uint8Array&&(d=c.data),d!=null&&o(d)},h=c=>{l(c.error??new Error("Socket error"))};return n.addEventListener("message",u),n.addEventListener("error",h),n.addEventListener("close",a),()=>{n.removeEventListener("message",u),n.removeEventListener("error",h),n.removeEventListener("close",a)}},{highWaterMark:1/0});await t();for await(const o of i)yield am(o)?new Uint8Array(o):o}();let r=n.readyState===1,s;return n.addEventListener("open",()=>{r=!0,s=null}),n.addEventListener("close",()=>{r=!1,s=null}),n.addEventListener("error",i=>{r||(s=i.error??new Error(`connect ECONNREFUSED ${n.url}`))}),Object.assign(e,{connected:t})},WM=(n,t)=>{t=t??{};const e=qM(n);let r=t.remoteAddress,s=t.remotePort;if(n.url!=null)try{const o=new URL(n.url);r=o.hostname,s=parseInt(o.port,10)}catch{}if(r==null||s==null)throw new Error("Remote connection did not have address and/or port");return{sink:UM(n,t),source:e,connected:async()=>{await e.connected()},close:async()=>{(n.readyState===n.CONNECTING||n.readyState===n.OPEN)&&await new Promise(o=>{n.addEventListener("close",()=>{o()}),n.close()})},destroy:()=>{n.terminate!=null?n.terminate():n.close()},remoteAddress:r,remotePort:s,socket:n}},GM=WebSocket,KM={"http:":"ws:","https:":"wss:"},cm="ws:",YM=(n,t)=>{if(n.startsWith("//")&&(n=`${t?.protocol??cm}${n}`),n.startsWith("/")&&t!=null){const r=t.protocol??cm,s=t.host,i=t.port!=null&&s?.endsWith(`:${t.port}`)!==!0?`:${t.port}`:"";n=`${r}//${s}${i}${n}`}const e=new URL(n);for(const[r,s]of Object.entries(KM))e.protocol===r&&(e.protocol=s);return e};function QM(n,t){const e=typeof window>"u"?void 0:window.location;t=t??{};const r=YM(n,e),s=new GM(r.toString(),t.websocket);return WM(s,t)}function jM(n){return n.filter(t=>Kc.exactMatch(t)||ra.exactMatch(t))}function ZM(){throw new Error("WebSocket Servers can not be created in the browser!")}const XM=500;function JM(n,t,e){const r=e.logger.forComponent("libp2p:websockets:maconn"),s=e.metrics,i=e.metricPrefix??"",o={log:r,async sink(a){try{await n.sink(async function*(){for await(const l of a)l instanceof Uint8Array?yield l:yield l.subarray()}())}catch(l){l.type!=="aborted"&&r.error(l)}},source:n.source,remoteAddr:t,timeline:{open:Date.now()},async close(a={}){const l=Date.now();if(a.signal==null){const h=AbortSignal.timeout(XM);a={...a,signal:h}}const u=()=>{const{host:h,port:c}=o.remoteAddr.toOptions();r("timeout closing stream to %s:%s after %dms, destroying it manually",h,c,Date.now()-l),this.abort(new Ns("Socket close timeout"))};a.signal?.addEventListener("abort",u);try{await n.close()}catch(h){r.error("error closing WebSocket gracefully",h),this.abort(h)}finally{a.signal?.removeEventListener("abort",u),o.timeline.close=Date.now()}},abort(a){const{host:l,port:u}=o.remoteAddr.toOptions();r("timeout closing stream to %s:%s due to error",l,u,a),n.destroy(),o.timeline.close=Date.now(),s?.increment({[`${i}error`]:!0})}};return n.socket.addEventListener("close",()=>{s?.increment({[`${i}close`]:!0}),o.timeline.close==null&&(o.timeline.close=Date.now())},{once:!0}),o}var xy,Iy,ky;ky=tb,Iy=Symbol.toStringTag,xy=Wn;class eL{constructor(t,e={}){p(this,"log");p(this,"init");p(this,"logger");p(this,"metrics");p(this,"components");p(this,ky,!0);p(this,Iy,"@libp2p/websockets");p(this,xy,["@libp2p/transport"]);this.log=t.logger.forComponent("libp2p:websockets"),this.logger=t.logger,this.components=t,this.init=e,t.metrics!=null&&(this.metrics={dialerEvents:t.metrics.registerCounterGroup("libp2p_websockets_dialer_events_total",{label:"event",help:"Total count of WebSockets dialer events by type"})})}async dial(t,e){this.log("dialing %s",t),e=e??{};const r=await this._connect(t,e),s=JM(r,t,{logger:this.logger,metrics:this.metrics?.dialerEvents});this.log("new outbound connection %s",s.remoteAddr);const i=await e.upgrader.upgradeOutbound(s,e);return this.log("outbound connection %s upgraded",s.remoteAddr),i}async _connect(t,e){e?.signal?.throwIfAborted();const r=t.toOptions();this.log("dialing %s:%s",r.host,r.port);const s=bt(),i=QM(FM(t),this.init);i.socket.addEventListener("error",()=>{const o=new sb(`Could not connect to ${t.toString()}`);this.log.error("connection error:",o),this.metrics?.dialerEvents.increment({error:!0}),s.reject(o)});try{e.onProgress?.(new vt("websockets:open-connection")),await Ir(Promise.race([i.connected(),s.promise]),e.signal)}catch(o){throw e.signal?.aborted&&this.metrics?.dialerEvents.increment({abort:!0}),i.close().catch(a=>{this.log.error("error closing raw socket",a)}),o}return this.log("connected %s",t),this.metrics?.dialerEvents.increment({connect:!0}),i}createListener(t){return ZM({logger:this.logger,events:this.components.events,metrics:this.components.metrics},{...this.init,...t})}listenFilter(t){return t=Array.isArray(t)?t:[t],this.init?.filter!=null?this.init?.filter(t):jM(t)}dialFilter(t){return this.listenFilter(t)}}function tL(n={}){return t=>new eL(t,n)}const nL="SHARDING";function rL(n){return n[Symbol.asyncIterator]!=null}function jr(n,t){let e=0;if(rL(n))return async function*(){for await(const l of n)await t(l,e++)&&(yield l)}();const r=Aw(n),{value:s,done:i}=r.next();if(i===!0)return function*(){}();const o=t(s,e++);if(typeof o.then=="function")return async function*(){await o&&(yield s);for await(const l of r)await t(l,e++)&&(yield l)}();const a=t;return function*(){o===!0&&(yield s);for(const l of r)a(l,e++)&&(yield l)}()}function sL(n){return n[Symbol.asyncIterator]!=null}function uh(n){if(sL(n))return(async()=>{const e=[];for await(const r of n)e.push(r);return e})();const t=[];for(const e of n)t.push(e);return t}function iL(n){return n[Symbol.asyncIterator]!=null}function nl(n,t){return iL(n)?async function*(){yield*(await uh(n)).sort(t)}():function*(){yield*uh(n).sort(t)}()}function oL(n){return n[Symbol.asyncIterator]!=null}function lm(n,t){return oL(n)?async function*(){let e=0;if(!(t<1)){for await(const r of n)if(yield r,e++,e===t)return}}():function*(){let e=0;if(!(t<1)){for(const r of n)if(yield r,e++,e===t)return}}()}class P_{put(t,e,r){return Promise.reject(new Error(".put is not implemented"))}get(t,e){return Promise.reject(new Error(".get is not implemented"))}has(t,e){return Promise.reject(new Error(".has is not implemented"))}delete(t,e){return Promise.reject(new Error(".delete is not implemented"))}async*putMany(t,e={}){for await(const{key:r,value:s}of t)await this.put(r,s,e),yield r}async*getMany(t,e={}){for await(const r of t)yield{key:r,value:await this.get(r,e)}}async*deleteMany(t,e={}){for await(const r of t)await this.delete(r,e),yield r}batch(){let t=[],e=[];return{put(r,s){t.push({key:r,value:s})},delete(r){e.push(r)},commit:async r=>{await em(this.putMany(t,r)),t=[],await em(this.deleteMany(e,r)),e=[]}}}async*_all(t,e){throw new Error("._all is not implemented")}async*_allKeys(t,e){throw new Error("._allKeys is not implemented")}query(t,e){let r=this._all(t,e);if(t.prefix!=null){const s=t.prefix;r=jr(r,i=>i.key.toString().startsWith(s))}if(Array.isArray(t.filters)&&(r=t.filters.reduce((s,i)=>jr(s,i),r)),Array.isArray(t.orders)&&(r=t.orders.reduce((s,i)=>nl(s,i),r)),t.offset!=null){let s=0;const i=t.offset;r=jr(r,()=>s++>=i)}return t.limit!=null&&(r=lm(r,t.limit)),r}queryKeys(t,e){let r=this._allKeys(t,e);if(t.prefix!=null){const s=t.prefix;r=jr(r,i=>i.toString().startsWith(s))}if(Array.isArray(t.filters)&&(r=t.filters.reduce((s,i)=>jr(s,i),r)),Array.isArray(t.orders)&&(r=t.orders.reduce((s,i)=>nl(s,i),r)),t.offset!=null){const s=t.offset;let i=0;r=jr(r,()=>i++>=s)}return t.limit!=null&&(r=lm(r,t.limit)),r}}const yi=class yi extends Error{constructor(e="Open failed"){super(e);p(this,"name",yi.name);p(this,"code",yi.code)}};p(yi,"name","OpenFailedError"),p(yi,"code","ERR_OPEN_FAILED");let dh=yi;const vi=class vi extends Error{constructor(e="Put failed"){super(e);p(this,"name",vi.name);p(this,"code",vi.code)}};p(vi,"name","PutFailedError"),p(vi,"code","ERR_PUT_FAILED");let hh=vi;const bi=class bi extends Error{constructor(e="Get failed"){super(e);p(this,"name",bi.name);p(this,"code",bi.code)}};p(bi,"name","GetFailedError"),p(bi,"code","ERR_GET_FAILED");let rl=bi;const wi=class wi extends Error{constructor(e="Delete failed"){super(e);p(this,"name",wi.name);p(this,"code",wi.code)}};p(wi,"name","DeleteFailedError"),p(wi,"code","ERR_DELETE_FAILED");let fh=wi;const _i=class _i extends Error{constructor(e="Not Found"){super(e);p(this,"name",_i.name);p(this,"code",_i.code)}};p(_i,"name","NotFoundError"),p(_i,"code","ERR_NOT_FOUND");let sl=_i;class aL extends P_{constructor(){super();p(this,"data");this.data=new Map}put(e,r){return this.data.set(e.toString(),r),e}get(e){const r=this.data.get(e.toString());if(r==null)throw new sl;return r}has(e){return this.data.has(e.toString())}delete(e){this.data.delete(e.toString())}*_all(){for(const[e,r]of this.data.entries())yield{key:new ut(e),value:r}}*_allKeys(){for(const e of this.data.keys())yield new ut(e)}}new ut(nL);I_("datastore:core:tiered");const ph=(n,t)=>t.some(e=>n instanceof e);let um,dm;function cL(){return um||(um=[IDBDatabase,IDBObjectStore,IDBIndex,IDBCursor,IDBTransaction])}function lL(){return dm||(dm=[IDBCursor.prototype.advance,IDBCursor.prototype.continue,IDBCursor.prototype.continuePrimaryKey])}const gh=new WeakMap,Vu=new WeakMap,eu=new WeakMap;function uL(n){const t=new Promise((e,r)=>{const s=()=>{n.removeEventListener("success",i),n.removeEventListener("error",o)},i=()=>{e(as(n.result)),s()},o=()=>{r(n.error),s()};n.addEventListener("success",i),n.addEventListener("error",o)});return eu.set(t,n),t}function dL(n){if(gh.has(n))return;const t=new Promise((e,r)=>{const s=()=>{n.removeEventListener("complete",i),n.removeEventListener("error",o),n.removeEventListener("abort",o)},i=()=>{e(),s()},o=()=>{r(n.error||new DOMException("AbortError","AbortError")),s()};n.addEventListener("complete",i),n.addEventListener("error",o),n.addEventListener("abort",o)});gh.set(n,t)}let mh={get(n,t,e){if(n instanceof IDBTransaction){if(t==="done")return gh.get(n);if(t==="store")return e.objectStoreNames[1]?void 0:e.objectStore(e.objectStoreNames[0])}return as(n[t])},set(n,t,e){return n[t]=e,!0},has(n,t){return n instanceof IDBTransaction&&(t==="done"||t==="store")?!0:t in n}};function D_(n){mh=n(mh)}function hL(n){return lL().includes(n)?function(...t){return n.apply(yh(this),t),as(this.request)}:function(...t){return as(n.apply(yh(this),t))}}function fL(n){return typeof n=="function"?hL(n):(n instanceof IDBTransaction&&dL(n),ph(n,cL())?new Proxy(n,mh):n)}function as(n){if(n instanceof IDBRequest)return uL(n);if(Vu.has(n))return Vu.get(n);const t=fL(n);return t!==n&&(Vu.set(n,t),eu.set(t,n)),t}const yh=n=>eu.get(n);function pL(n,t,{blocked:e,upgrade:r,blocking:s,terminated:i}={}){const o=indexedDB.open(n,t),a=as(o);return r&&o.addEventListener("upgradeneeded",l=>{r(as(o.result),l.oldVersion,l.newVersion,as(o.transaction),l)}),e&&o.addEventListener("blocked",l=>e(l.oldVersion,l.newVersion,l)),a.then(l=>{i&&l.addEventListener("close",()=>i()),s&&l.addEventListener("versionchange",u=>s(u.oldVersion,u.newVersion,u))}).catch(()=>{}),a}function gL(n,{blocked:t}={}){const e=indexedDB.deleteDatabase(n);return t&&e.addEventListener("blocked",r=>t(r.oldVersion,r)),as(e).then(()=>{})}const mL=["get","getKey","getAll","getAllKeys","count"],yL=["put","add","delete","clear"],Hu=new Map;function hm(n,t){if(!(n instanceof IDBDatabase&&!(t in n)&&typeof t=="string"))return;if(Hu.get(t))return Hu.get(t);const e=t.replace(/FromIndex$/,""),r=t!==e,s=yL.includes(e);if(!(e in(r?IDBIndex:IDBObjectStore).prototype)||!(s||mL.includes(e)))return;const i=async function(o,...a){const l=this.transaction(o,s?"readwrite":"readonly");let u=l.store;return r&&(u=u.index(a.shift())),(await Promise.all([u[e](...a),s&&l.done]))[0]};return Hu.set(t,i),i}D_(n=>({...n,get:(t,e,r)=>hm(t,e)||n.get(t,e,r),has:(t,e)=>!!hm(t,e)||n.has(t,e)}));const vL=["continue","continuePrimaryKey","advance"],fm={},vh=new WeakMap,M_=new WeakMap,bL={get(n,t){if(!vL.includes(t))return n[t];let e=fm[t];return e||(e=fm[t]=function(...r){vh.set(this,M_.get(this)[t](...r))}),e}};async function*wL(...n){let t=this;if(t instanceof IDBCursor||(t=await t.openCursor(...n)),!t)return;t=t;const e=new Proxy(t,bL);for(M_.set(e,t),eu.set(e,yh(t));t;)yield e,t=await(vh.get(e)||t.continue()),vh.delete(e)}function pm(n,t){return t===Symbol.asyncIterator&&ph(n,[IDBIndex,IDBObjectStore,IDBCursor])||t==="iterate"&&ph(n,[IDBIndex,IDBObjectStore])}D_(n=>({...n,get(t,e,r){return pm(t,e)?wL:n.get(t,e,r)},has(t,e){return pm(t,e)||n.has(t,e)}}));var da,bh;class _L extends P_{constructor(e,r={}){super();_e(this,da);p(this,"location");p(this,"version");p(this,"db");this.location=`${r.prefix??""}${e}`,this.version=r.version??1}async open(){try{const e=this.location;this.db=await pL(e,this.version,{upgrade(r){r.createObjectStore(e)}})}catch(e){throw new dh(String(e))}}async close(){this.db?.close()}async put(e,r){if(this.db==null)throw new Error("Datastore needs to be opened.");try{return await this.db.put(this.location,r,e.toString()),e}catch(s){throw new hh(String(s))}}async get(e){if(this.db==null)throw new Error("Datastore needs to be opened.");let r;try{r=await this.db.get(this.location,e.toString())}catch(s){throw new rl(String(s))}if(r===void 0)throw new sl;return r}async has(e){if(this.db==null)throw new Error("Datastore needs to be opened.");try{return!!await this.db.getKey(this.location,e.toString())}catch(r){throw new rl(String(r))}}async delete(e){if(this.db==null)throw new Error("Datastore needs to be opened.");try{await this.db.delete(this.location,e.toString())}catch(r){throw new fh(String(r))}}batch(){const e=[],r=[];return{put(s,i){e.push({key:s,value:i})},delete(s){r.push(s)},commit:async()=>{if(this.db==null)throw new Error("Datastore needs to be opened.");const s=this.db.transaction(this.location,"readwrite");try{const i=e.filter(({key:o})=>r.find(a=>a.toString()===o.toString())==null).map(o=>async()=>{await s.store.put(o.value,o.key.toString())}).concat(r.map(o=>async()=>{await s.store.delete(o.toString())})).concat(async()=>{await s.done});await Promise.all(i.map(async o=>{await o()}))}catch{s.abort()}}}}async*query(e){let r=de(this,da,bh).call(this,e,(s,i)=>({key:s,value:i}));Array.isArray(e.filters)&&(r=e.filters.reduce((s,i)=>jr(s,i),r)),Array.isArray(e.orders)&&(r=e.orders.reduce((s,i)=>nl(s,i),r)),yield*r}async*queryKeys(e){let r=de(this,da,bh).call(this,e,s=>s);Array.isArray(e.filters)&&(r=e.filters.reduce((s,i)=>jr(s,i),r)),Array.isArray(e.orders)&&(r=e.orders.reduce((s,i)=>nl(s,i),r)),yield*r}async destroy(){await gL(this.location)}}da=new WeakSet,bh=async function*(e,r){if(this.db==null)throw new Error("Datastore needs to be opened.");let s=0,i=-1;for(const o of await this.db.getAllKeys(this.location)){if(e.prefix!=null&&!o.toString().startsWith(e.prefix))continue;if(e.limit!=null&&s===e.limit)return;if(i++,e.offset!=null&&i<e.offset)continue;const a=new ut(o.toString());let l;try{l=await this.get(a)}catch(u){if(u.name!=="NotFoundError")throw u;continue}l!=null&&(yield r(a,l),s++)}};var zu={exports:{}},gm;function SL(){return gm||(gm=1,function(n){var t=Object.prototype.hasOwnProperty,e="~";function r(){}Object.create&&(r.prototype=Object.create(null),new r().__proto__||(e=!1));function s(l,u,h){this.fn=l,this.context=u,this.once=h||!1}function i(l,u,h,c,d){if(typeof h!="function")throw new TypeError("The listener must be a function");var f=new s(h,c||l,d),g=e?e+u:u;return l._events[g]?l._events[g].fn?l._events[g]=[l._events[g],f]:l._events[g].push(f):(l._events[g]=f,l._eventsCount++),l}function o(l,u){--l._eventsCount===0?l._events=new r:delete l._events[u]}function a(){this._events=new r,this._eventsCount=0}a.prototype.eventNames=function(){var u=[],h,c;if(this._eventsCount===0)return u;for(c in h=this._events)t.call(h,c)&&u.push(e?c.slice(1):c);return Object.getOwnPropertySymbols?u.concat(Object.getOwnPropertySymbols(h)):u},a.prototype.listeners=function(u){var h=e?e+u:u,c=this._events[h];if(!c)return[];if(c.fn)return[c.fn];for(var d=0,f=c.length,g=new Array(f);d<f;d++)g[d]=c[d].fn;return g},a.prototype.listenerCount=function(u){var h=e?e+u:u,c=this._events[h];return c?c.fn?1:c.length:0},a.prototype.emit=function(u,h,c,d,f,g){var y=e?e+u:u;if(!this._events[y])return!1;var m=this._events[y],v=arguments.length,_,w;if(m.fn){switch(m.once&&this.removeListener(u,m.fn,void 0,!0),v){case 1:return m.fn.call(m.context),!0;case 2:return m.fn.call(m.context,h),!0;case 3:return m.fn.call(m.context,h,c),!0;case 4:return m.fn.call(m.context,h,c,d),!0;case 5:return m.fn.call(m.context,h,c,d,f),!0;case 6:return m.fn.call(m.context,h,c,d,f,g),!0}for(w=1,_=new Array(v-1);w<v;w++)_[w-1]=arguments[w];m.fn.apply(m.context,_)}else{var S=m.length,A;for(w=0;w<S;w++)switch(m[w].once&&this.removeListener(u,m[w].fn,void 0,!0),v){case 1:m[w].fn.call(m[w].context);break;case 2:m[w].fn.call(m[w].context,h);break;case 3:m[w].fn.call(m[w].context,h,c);break;case 4:m[w].fn.call(m[w].context,h,c,d);break;default:if(!_)for(A=1,_=new Array(v-1);A<v;A++)_[A-1]=arguments[A];m[w].fn.apply(m[w].context,_)}}return!0},a.prototype.on=function(u,h,c){return i(this,u,h,c,!1)},a.prototype.once=function(u,h,c){return i(this,u,h,c,!0)},a.prototype.removeListener=function(u,h,c,d){var f=e?e+u:u;if(!this._events[f])return this;if(!h)return o(this,f),this;var g=this._events[f];if(g.fn)g.fn===h&&(!d||g.once)&&(!c||g.context===c)&&o(this,f);else{for(var y=0,m=[],v=g.length;y<v;y++)(g[y].fn!==h||d&&!g[y].once||c&&g[y].context!==c)&&m.push(g[y]);m.length?this._events[f]=m.length===1?m[0]:m:o(this,f)}return this},a.prototype.removeAllListeners=function(u){var h;return u?(h=e?e+u:u,this._events[h]&&o(this,h)):(this._events=new r,this._eventsCount=0),this},a.prototype.off=a.prototype.removeListener,a.prototype.addListener=a.prototype.on,a.prefixed=e,a.EventEmitter=a,n.exports=a}(zu)),zu.exports}var EL=SL();const AL=ao(EL);class L_ extends Error{constructor(t){super(t),this.name="TimeoutError"}}let xL=class extends Error{constructor(t){super(),this.name="AbortError",this.message=t}};const mm=n=>globalThis.DOMException===void 0?new xL(n):new DOMException(n),ym=n=>{const t=n.reason===void 0?mm("This operation was aborted."):n.reason;return t instanceof Error?t:mm(t)};function B_(n,t){const{milliseconds:e,fallback:r,message:s,customTimers:i={setTimeout,clearTimeout}}=t;let o,a;const u=new Promise((h,c)=>{if(typeof e!="number"||Math.sign(e)!==1)throw new TypeError(`Expected \`milliseconds\` to be a positive number, got \`${e}\``);if(t.signal){const{signal:f}=t;f.aborted&&c(ym(f)),a=()=>{c(ym(f))},f.addEventListener("abort",a,{once:!0})}if(e===Number.POSITIVE_INFINITY){n.then(h,c);return}const d=new L_;o=i.setTimeout.call(void 0,()=>{if(r){try{h(r())}catch(f){c(f)}return}typeof n.cancel=="function"&&n.cancel(),s===!1?h():s instanceof Error?c(s):(d.message=s??`Promise timed out after ${e} milliseconds`,c(d))},e),(async()=>{try{h(await n)}catch(f){c(f)}})()}).finally(()=>{u.clear(),a&&t.signal&&t.signal.removeEventListener("abort",a)});return u.clear=()=>{i.clearTimeout.call(void 0,o),o=void 0},u}function IL(n,t,e){let r=0,s=n.length;for(;s>0;){const i=Math.trunc(s/2);let o=r+i;e(n[o],t)<=0?(r=++o,s-=i+1):s=i}return r}var En,Ty;let kL=(Ty=class{constructor(){_e(this,En,[])}enqueue(t,e){e={priority:0,...e};const r={priority:e.priority,id:e.id,run:t};if(this.size===0||F(this,En)[this.size-1].priority>=e.priority){F(this,En).push(r);return}const s=IL(F(this,En),r,(i,o)=>o.priority-i.priority);F(this,En).splice(s,0,r)}setPriority(t,e){const r=F(this,En).findIndex(i=>i.id===t);if(r===-1)throw new ReferenceError(`No promise function with the id "${t}" exists in the queue.`);const[s]=F(this,En).splice(r,1);this.enqueue(s.run,{priority:e,id:t})}dequeue(){return F(this,En).shift()?.run}filter(t){return F(this,En).filter(e=>e.priority===t.priority).map(e=>e.run)}get size(){return F(this,En).length}},En=new WeakMap,Ty);var Ci,Pi,ts,ha,Di,fa,An,Mi,Wt,pa,xn,Li,Sr,ga,ll,Ie,N_,R_,O_,F_,$_,sc,_h,Sh,ic,U_,oc;class wh extends AL{constructor(e){super();_e(this,Ie);_e(this,Ci);_e(this,Pi);_e(this,ts,0);_e(this,ha);_e(this,Di);_e(this,fa,0);_e(this,An);_e(this,Mi);_e(this,Wt);_e(this,pa);_e(this,xn,0);_e(this,Li);_e(this,Sr);_e(this,ga);_e(this,ll,1n);p(this,"timeout");if(e={carryoverConcurrencyCount:!1,intervalCap:Number.POSITIVE_INFINITY,interval:0,concurrency:Number.POSITIVE_INFINITY,autoStart:!0,queueClass:kL,...e},!(typeof e.intervalCap=="number"&&e.intervalCap>=1))throw new TypeError(`Expected \`intervalCap\` to be a number from 1 and up, got \`${e.intervalCap?.toString()??""}\` (${typeof e.intervalCap})`);if(e.interval===void 0||!(Number.isFinite(e.interval)&&e.interval>=0))throw new TypeError(`Expected \`interval\` to be a finite number >= 0, got \`${e.interval?.toString()??""}\` (${typeof e.interval})`);Me(this,Ci,e.carryoverConcurrencyCount),Me(this,Pi,e.intervalCap===Number.POSITIVE_INFINITY||e.interval===0),Me(this,ha,e.intervalCap),Me(this,Di,e.interval),Me(this,Wt,new e.queueClass),Me(this,pa,e.queueClass),this.concurrency=e.concurrency,this.timeout=e.timeout,Me(this,ga,e.throwOnTimeout===!0),Me(this,Sr,e.autoStart===!1)}get concurrency(){return F(this,Li)}set concurrency(e){if(!(typeof e=="number"&&e>=1))throw new TypeError(`Expected \`concurrency\` to be a number from 1 and up, got \`${e}\` (${typeof e})`);Me(this,Li,e),de(this,Ie,ic).call(this)}setPriority(e,r){F(this,Wt).setPriority(e,r)}async add(e,r={}){return r.id??(r.id=(vo(this,ll)._++).toString()),r={timeout:this.timeout,throwOnTimeout:F(this,ga),...r},new Promise((s,i)=>{F(this,Wt).enqueue(async()=>{vo(this,xn)._++,vo(this,ts)._++;try{r.signal?.throwIfAborted();let o=e({signal:r.signal});r.timeout&&(o=B_(Promise.resolve(o),{milliseconds:r.timeout})),r.signal&&(o=Promise.race([o,de(this,Ie,U_).call(this,r.signal)]));const a=await o;s(a),this.emit("completed",a)}catch(o){if(o instanceof L_&&!r.throwOnTimeout){s();return}i(o),this.emit("error",o)}finally{de(this,Ie,O_).call(this)}},r),this.emit("add"),de(this,Ie,sc).call(this)})}async addAll(e,r){return Promise.all(e.map(async s=>this.add(s,r)))}start(){return F(this,Sr)?(Me(this,Sr,!1),de(this,Ie,ic).call(this),this):this}pause(){Me(this,Sr,!0)}clear(){Me(this,Wt,new(F(this,pa)))}async onEmpty(){F(this,Wt).size!==0&&await de(this,Ie,oc).call(this,"empty")}async onSizeLessThan(e){F(this,Wt).size<e||await de(this,Ie,oc).call(this,"next",()=>F(this,Wt).size<e)}async onIdle(){F(this,xn)===0&&F(this,Wt).size===0||await de(this,Ie,oc).call(this,"idle")}get size(){return F(this,Wt).size}sizeBy(e){return F(this,Wt).filter(e).length}get pending(){return F(this,xn)}get isPaused(){return F(this,Sr)}}Ci=new WeakMap,Pi=new WeakMap,ts=new WeakMap,ha=new WeakMap,Di=new WeakMap,fa=new WeakMap,An=new WeakMap,Mi=new WeakMap,Wt=new WeakMap,pa=new WeakMap,xn=new WeakMap,Li=new WeakMap,Sr=new WeakMap,ga=new WeakMap,ll=new WeakMap,Ie=new WeakSet,N_=function(){return F(this,Pi)||F(this,ts)<F(this,ha)},R_=function(){return F(this,xn)<F(this,Li)},O_=function(){vo(this,xn)._--,de(this,Ie,sc).call(this),this.emit("next")},F_=function(){de(this,Ie,Sh).call(this),de(this,Ie,_h).call(this),Me(this,Mi,void 0)},$_=function(){const e=Date.now();if(F(this,An)===void 0){const r=F(this,fa)-e;if(r<0)Me(this,ts,F(this,Ci)?F(this,xn):0);else return F(this,Mi)===void 0&&Me(this,Mi,setTimeout(()=>{de(this,Ie,F_).call(this)},r)),!0}return!1},sc=function(){if(F(this,Wt).size===0)return F(this,An)&&clearInterval(F(this,An)),Me(this,An,void 0),this.emit("empty"),F(this,xn)===0&&this.emit("idle"),!1;if(!F(this,Sr)){const e=!F(this,Ie,$_);if(F(this,Ie,N_)&&F(this,Ie,R_)){const r=F(this,Wt).dequeue();return r?(this.emit("active"),r(),e&&de(this,Ie,_h).call(this),!0):!1}}return!1},_h=function(){F(this,Pi)||F(this,An)!==void 0||(Me(this,An,setInterval(()=>{de(this,Ie,Sh).call(this)},F(this,Di))),Me(this,fa,Date.now()+F(this,Di)))},Sh=function(){F(this,ts)===0&&F(this,xn)===0&&F(this,An)&&(clearInterval(F(this,An)),Me(this,An,void 0)),Me(this,ts,F(this,Ci)?F(this,xn):0),de(this,Ie,ic).call(this)},ic=function(){for(;de(this,Ie,sc).call(this););},U_=async function(e){return new Promise((r,s)=>{e.addEventListener("abort",()=>{s(e.reason)},{once:!0})})},oc=async function(e,r){return new Promise(s=>{const i=()=>{r&&!r()||(this.off(e,i),s())};this.on(e,i)})};function V_(n){const t=[hs.A];return n==null?t:Array.isArray(n)?n.length===0?t:n:[n]}const H_=60;function z_(n){return{Status:n.Status??0,TC:n.TC??n.flag_tc??!1,RD:n.RD??n.flag_rd??!1,RA:n.RA??n.flag_ra??!1,AD:n.AD??n.flag_ad??!1,CD:n.CD??n.flag_cd??!1,Question:(n.Question??n.questions??[]).map(t=>({name:t.name,type:hs[t.type]})),Answer:(n.Answer??n.answers??[]).map(t=>({name:t.name,type:hs[t.type],TTL:t.TTL??t.ttl??H_,data:t.data instanceof Uint8Array?he(t.data):t.data}))}}const TL=4;function vm(n,t={}){const e=new wh({concurrency:t.queryConcurrency??TL});return async(r,s={})=>{const i=new URLSearchParams;i.set("name",r),V_(s.types).forEach(a=>{i.append("type",hs[a])}),s.onProgress?.(new vt("dns:query",{detail:r}));const o=await e.add(async()=>{const a=await fetch(`${n}?${i}`,{headers:{accept:"application/dns-json"},signal:s?.signal});if(a.status!==200)throw new Error(`Unexpected HTTP status: ${a.status} - ${a.statusText}`);const l=z_(await a.json());return s.onProgress?.(new vt("dns:response",{detail:l})),l},{signal:s.signal});if(o==null)throw new Error("No DNS response received");return o}}function CL(){return[vm("https://cloudflare-dns.com/dns-query"),vm("https://dns.google/resolve")]}var qu,bm;function PL(){return bm||(bm=1,qu=function(n){if(!n)throw Error("hashlru must have a max value, of type number, greater than 0");var t=0,e=Object.create(null),r=Object.create(null);function s(i,o){e[i]=o,t++,t>=n&&(t=0,r=e,e=Object.create(null))}return{has:function(i){return e[i]!==void 0||r[i]!==void 0},remove:function(i){e[i]!==void 0&&(e[i]=void 0),r[i]!==void 0&&(r[i]=void 0)},get:function(i){var o=e[i];if(o!==void 0)return o;if((o=r[i])!==void 0)return s(i,o),o},set:function(i,o){e[i]!==void 0?e[i]=o:s(i,o)},clear:function(){e=Object.create(null),r=Object.create(null)}}}),qu}var DL=PL();const ML=ao(DL);class LL{constructor(t){p(this,"lru");this.lru=ML(t)}get(t,e){let r=!0;const s=[];for(const i of e){const o=this.getAnswers(t,i);if(o.length===0){r=!1;break}s.push(...o)}if(r)return z_({answers:s})}getAnswers(t,e){const r=`${t.toLowerCase()}-${e}`,s=this.lru.get(r);if(s!=null){const i=s.filter(o=>o.expires>Date.now()).map(({expires:o,value:a})=>({...a,TTL:Math.round((o-Date.now())/1e3),type:hs[a.type]}));return i.length===0&&this.lru.remove(r),i}return[]}add(t,e){const r=`${t.toLowerCase()}-${e.type}`,s=this.lru.get(r)??[];s.push({expires:Date.now()+(e.TTL??H_)*1e3,value:e}),this.lru.set(r,s)}remove(t,e){const r=`${t.toLowerCase()}-${e}`;this.lru.remove(r)}clear(){this.lru.clear()}}function BL(n){return new LL(n)}const NL=1e3;class RL{constructor(t){p(this,"resolvers");p(this,"cache");this.resolvers={},this.cache=BL(t.cacheSize??NL),Object.entries(t.resolvers??{}).forEach(([e,r])=>{Array.isArray(r)||(r=[r]),e.endsWith(".")||(e=`${e}.`),this.resolvers[e]=r}),this.resolvers["."]==null&&(this.resolvers["."]=CL())}async query(t,e={}){const r=V_(e.types),s=e.cached!==!1?this.cache.get(t,r):void 0;if(s!=null)return e.onProgress?.(new vt("dns:cache",{detail:s})),s;const i=`${t.split(".").pop()}.`,o=(this.resolvers[i]??this.resolvers["."]).sort(()=>Math.random()>.5?-1:1),a=[];for(const l of o){if(e.signal?.aborted===!0)break;try{const u=await l(t,{...e,types:r});for(const h of u.Answer)this.cache.add(t,h);return u}catch(u){a.push(u),e.onProgress?.(new vt("dns:error",{detail:u}))}}throw a.length===1?a[0]:new AggregateError(a,`DNS lookup of ${t} ${r} failed`)}}var hs;(function(n){n[n.A=1]="A",n[n.CNAME=5]="CNAME",n[n.TXT=16]="TXT",n[n.AAAA=28]="AAAA"})(hs||(hs={}));function OL(n={}){return new RL(n)}const FL=32,{code:$L}=pe("dnsaddr");class UL extends Error{constructor(t="Max recursive depth reached"){super(t),this.name="RecursionLimitError"}}const q_=async function(t,e={}){const r=e.maxRecursiveDepth??FL;if(r===0)throw new UL("Max recursive depth reached");const[,s]=t.stringTuples().find(([u])=>u===$L)??[],o=await(e?.dns??OL()).query(`_dnsaddr.${s}`,{signal:e?.signal,types:[hs.TXT]}),a=t.getPeerId(),l=[];for(const u of o.Answer){const h=u.data.replace(/["']/g,"").trim().split("=")[1];if(h==null||a!=null&&!h.includes(a))continue;const c=me(h);if(h.startsWith("/dnsaddr")){const d=await c.resolve({...e,maxRecursiveDepth:r-1});l.push(...d.map(f=>f.toString()))}else l.push(c.toString())}return l},VL={addresses:{listen:[],announce:[],noAnnounce:[],announceFilter:n=>n},connectionManager:{resolvers:{dnsaddr:q_}},transportManager:{faultTolerance:Yo.FATAL_ALL}};async function HL(n){const t=Qf(VL,n);if(t.connectionProtector===null&&globalThis.process?.env?.LIBP2P_FORCE_PNET!=null)throw new Z("Private network is enforced, but no protector was provided");return t}const cs={},Gs=n=>{n.addEventListener("message",t=>{Gs.dispatchEvent("message",n,t)}),n.port!=null&&n.port.addEventListener("message",t=>{Gs.dispatchEvent("message",n,t)})};Gs.addEventListener=(n,t)=>{cs[n]==null&&(cs[n]=[]),cs[n].push(t)};Gs.removeEventListener=(n,t)=>{cs[n]!=null&&(cs[n]=cs[n].filter(e=>e===t))};Gs.dispatchEvent=function(n,t,e){cs[n]!=null&&cs[n].forEach(r=>r(t,e))};const wm="lock:worker:request-read",_m="lock:worker:release-read",Sm="lock:master:grant-read",Em="lock:worker:request-write",Am="lock:worker:release-write",xm="lock:master:grant-write",zL=(n=21)=>Math.random().toString().substring(2),Im=(n,t,e,r,s)=>(i,o)=>{if(o.data.type!==e)return;const a={type:o.data.type,name:o.data.name,identifier:o.data.identifier};n.dispatchEvent(new MessageEvent(t,{data:{name:a.name,handler:async()=>{i.postMessage({type:s,name:a.name,identifier:a.identifier}),await new Promise(l=>{const u=h=>{if(h?.data==null)return;const c={type:h.data.type,name:h.data.name,identifier:h.data.identifier};c.type===r&&c.identifier===a.identifier&&(i.removeEventListener("message",u),l())};i.addEventListener("message",u)})}}}))},km=(n,t,e,r)=>async()=>{const s=zL();return globalThis.postMessage({type:t,identifier:s,name:n}),new Promise(i=>{const o=a=>{if(a?.data==null)return;const l={type:a.data.type,identifier:a.data.identifier};l.type===e&&l.identifier===s&&(globalThis.removeEventListener("message",o),i(()=>{globalThis.postMessage({type:r,identifier:s,name:n})}))};globalThis.addEventListener("message",o)})},qL={singleProcess:!1},WL=n=>{if(n=Object.assign({},qL,n),!!globalThis.document||n.singleProcess){const e=new EventTarget;return Gs.addEventListener("message",Im(e,"requestReadLock",wm,_m,Sm)),Gs.addEventListener("message",Im(e,"requestWriteLock",Em,Am,xm)),e}return{isWorker:!0,readLock:e=>km(e,wm,Sm,_m),writeLock:e=>km(e,Em,xm,Am)}},ms={};let Xr;async function Wu(n,t){let e;const r=new Promise(s=>{e=s});return n.add(async()=>B_((async()=>{await new Promise(s=>{e(()=>{s()})})})(),{milliseconds:t.timeout})),r}const GL=(n,t)=>{if(Xr.isWorker===!0)return{readLock:Xr.readLock(n,t),writeLock:Xr.writeLock(n,t)};const e=new wh({concurrency:1});let r;return{async readLock(){if(r!=null)return Wu(r,t);r=new wh({concurrency:t.concurrency,autoStart:!1});const s=r,i=Wu(r,t);return e.add(async()=>{s.start(),await s.onIdle().then(()=>{r===s&&(r=null)})}),i},async writeLock(){return r=null,Wu(e,t)}}},KL={name:"lock",concurrency:1/0,timeout:846e5,singleProcess:!1};function YL(n){const t=Object.assign({},KL,n);return Xr==null&&(Xr=WL(t),Xr.isWorker!==!0&&(Xr.addEventListener("requestReadLock",e=>{ms[e.data.name]!=null&&ms[e.data.name].readLock().then(async r=>e.data.handler().finally(()=>{r()}))}),Xr.addEventListener("requestWriteLock",async e=>{ms[e.data.name]!=null&&ms[e.data.name].writeLock().then(async r=>e.data.handler().finally(()=>{r()}))}))),ms[t.name]==null&&(ms[t.name]=GL(t.name,t)),ms[t.name]}const QL=36e5,jL=216e5;var As;(function(n){(function(e){let r;e.codec=()=>(r==null&&(r=Ce((s,i,o={})=>{o.lengthDelimited!==!1&&i.fork(),s.key!=null&&s.key!==""&&(i.uint32(10),i.string(s.key)),s.value!=null&&s.value.byteLength>0&&(i.uint32(18),i.bytes(s.value)),o.lengthDelimited!==!1&&i.ldelim()},(s,i,o={})=>{const a={key:"",value:Ke(0)},l=i==null?s.len:s.pos+i;for(;s.pos<l;){const u=s.uint32();switch(u>>>3){case 1:{a.key=s.string();break}case 2:{a.value=s.bytes();break}default:{s.skipType(u&7);break}}}return a})),r),e.encode=s=>Te(s,e.codec()),e.decode=(s,i)=>ke(s,e.codec(),i)})(n.Peer$metadataEntry||(n.Peer$metadataEntry={})),function(e){let r;e.codec=()=>(r==null&&(r=Ce((s,i,o={})=>{o.lengthDelimited!==!1&&i.fork(),s.key!=null&&s.key!==""&&(i.uint32(10),i.string(s.key)),s.value!=null&&(i.uint32(18),ol.codec().encode(s.value,i)),o.lengthDelimited!==!1&&i.ldelim()},(s,i,o={})=>{const a={key:""},l=i==null?s.len:s.pos+i;for(;s.pos<l;){const u=s.uint32();switch(u>>>3){case 1:{a.key=s.string();break}case 2:{a.value=ol.codec().decode(s,s.uint32(),{limits:o.limits?.value});break}default:{s.skipType(u&7);break}}}return a})),r),e.encode=s=>Te(s,e.codec()),e.decode=(s,i)=>ke(s,e.codec(),i)}(n.Peer$tagsEntry||(n.Peer$tagsEntry={}));let t;n.codec=()=>(t==null&&(t=Ce((e,r,s={})=>{if(s.lengthDelimited!==!1&&r.fork(),e.addresses!=null)for(const i of e.addresses)r.uint32(10),il.codec().encode(i,r);if(e.protocols!=null)for(const i of e.protocols)r.uint32(18),r.string(i);if(e.publicKey!=null&&(r.uint32(34),r.bytes(e.publicKey)),e.peerRecordEnvelope!=null&&(r.uint32(42),r.bytes(e.peerRecordEnvelope)),e.metadata!=null&&e.metadata.size!==0)for(const[i,o]of e.metadata.entries())r.uint32(50),n.Peer$metadataEntry.codec().encode({key:i,value:o},r);if(e.tags!=null&&e.tags.size!==0)for(const[i,o]of e.tags.entries())r.uint32(58),n.Peer$tagsEntry.codec().encode({key:i,value:o},r);e.updated!=null&&(r.uint32(64),r.uint64Number(e.updated)),s.lengthDelimited!==!1&&r.ldelim()},(e,r,s={})=>{const i={addresses:[],protocols:[],metadata:new Map,tags:new Map},o=r==null?e.len:e.pos+r;for(;e.pos<o;){const a=e.uint32();switch(a>>>3){case 1:{if(s.limits?.addresses!=null&&i.addresses.length===s.limits.addresses)throw new gt('Decode error - map field "addresses" had too many elements');i.addresses.push(il.codec().decode(e,e.uint32(),{limits:s.limits?.addresses$}));break}case 2:{if(s.limits?.protocols!=null&&i.protocols.length===s.limits.protocols)throw new gt('Decode error - map field "protocols" had too many elements');i.protocols.push(e.string());break}case 4:{i.publicKey=e.bytes();break}case 5:{i.peerRecordEnvelope=e.bytes();break}case 6:{if(s.limits?.metadata!=null&&i.metadata.size===s.limits.metadata)throw new Kp('Decode error - map field "metadata" had too many elements');const l=n.Peer$metadataEntry.codec().decode(e,e.uint32());i.metadata.set(l.key,l.value);break}case 7:{if(s.limits?.tags!=null&&i.tags.size===s.limits.tags)throw new Kp('Decode error - map field "tags" had too many elements');const l=n.Peer$tagsEntry.codec().decode(e,e.uint32(),{limits:{value:s.limits?.tags$value}});i.tags.set(l.key,l.value);break}case 8:{i.updated=e.uint64Number();break}default:{e.skipType(a&7);break}}}return i})),t),n.encode=e=>Te(e,n.codec()),n.decode=(e,r)=>ke(e,n.codec(),r)})(As||(As={}));var il;(function(n){let t;n.codec=()=>(t==null&&(t=Ce((e,r,s={})=>{s.lengthDelimited!==!1&&r.fork(),e.multiaddr!=null&&e.multiaddr.byteLength>0&&(r.uint32(10),r.bytes(e.multiaddr)),e.isCertified!=null&&(r.uint32(16),r.bool(e.isCertified)),e.observed!=null&&(r.uint32(24),r.uint64Number(e.observed)),s.lengthDelimited!==!1&&r.ldelim()},(e,r,s={})=>{const i={multiaddr:Ke(0)},o=r==null?e.len:e.pos+r;for(;e.pos<o;){const a=e.uint32();switch(a>>>3){case 1:{i.multiaddr=e.bytes();break}case 2:{i.isCertified=e.bool();break}case 3:{i.observed=e.uint64Number();break}default:{e.skipType(a&7);break}}}return i})),t),n.encode=e=>Te(e,n.codec()),n.decode=(e,r)=>ke(e,n.codec(),r)})(il||(il={}));var ol;(function(n){let t;n.codec=()=>(t==null&&(t=Ce((e,r,s={})=>{s.lengthDelimited!==!1&&r.fork(),e.value!=null&&e.value!==0&&(r.uint32(8),r.uint32(e.value)),e.expiry!=null&&(r.uint32(16),r.uint64(e.expiry)),s.lengthDelimited!==!1&&r.ldelim()},(e,r,s={})=>{const i={value:0},o=r==null?e.len:e.pos+r;for(;e.pos<o;){const a=e.uint32();switch(a>>>3){case 1:{i.value=e.uint32();break}case 2:{i.expiry=e.uint64();break}default:{e.skipType(a&7);break}}}return i})),t),n.encode=e=>Te(e,n.codec()),n.decode=(e,r)=>ke(e,n.codec(),r)})(ol||(ol={}));function ZL(n,t){if(n.publicKey!=null||t.publicKey==null)return n;let e;if(n.type==="RSA"){const s=ot.decode(`z${n}`);e=$r(s)}const r=Lr(t.publicKey,e);return Ta(r)}function Eh(n,t,e){const r=As.decode(t);return Ah(n,r,e)}function Ah(n,t,e){const r=new Map,s=BigInt(Date.now());for(const[i,o]of t.tags.entries())o.expiry!=null&&o.expiry<s||r.set(i,o);return{...t,id:ZL(n,t),addresses:t.addresses.filter(({observed:i})=>i!=null&&i>Date.now()-e).map(({multiaddr:i,isCertified:o})=>({multiaddr:me(i),isCertified:o??!1})),metadata:t.metadata,peerRecordEnvelope:t.peerRecordEnvelope??void 0,tags:r}}function XL(n,t){return JL(n.addresses,t.addresses)&&eB(n.protocols,t.protocols)&&tB(n.publicKey,t.publicKey)&&nB(n.peerRecordEnvelope,t.peerRecordEnvelope)&&rB(n.metadata,t.metadata)&&sB(n.tags,t.tags)}function JL(n,t){return G_(n,t,(e,r)=>!(e.isCertified!==r.isCertified||!It(e.multiaddr,r.multiaddr)))}function eB(n,t){return G_(n,t,(e,r)=>e===r)}function tB(n,t){return W_(n,t)}function nB(n,t){return W_(n,t)}function rB(n,t){return K_(n,t,(e,r)=>It(e,r))}function sB(n,t){return K_(n,t,(e,r)=>e.value===r.value&&e.expiry===r.expiry)}function W_(n,t){return n==null&&t==null?!0:n!=null&&t!=null?It(n,t):!1}function G_(n,t,e){if(n.length!==t.length)return!1;for(let r=0;r<n.length;r++)if(!e(n[r],t[r]))return!1;return!0}function K_(n,t,e){if(n.size!==t.size)return!1;for(const[r,s]of n.entries()){const i=t.get(r);if(i==null||!e(s,i))return!1}return!0}const Y_="/peers/";function Ga(n){if(!eb(n)||n.type==null)throw new Z("Invalid PeerId");const t=n.toCID().toString();return new ut(`${Y_}${t}`)}async function iB(n,t,e,r){const s=new Map;for(const i of e){if(i==null)continue;if(i.multiaddr instanceof Uint8Array&&(i.multiaddr=me(i.multiaddr)),!Hl(i.multiaddr))throw new Z("Multiaddr was invalid");if(!await t(n,i.multiaddr))continue;const o=i.isCertified??!1,a=i.multiaddr.toString(),l=s.get(a);l!=null?i.isCertified=l.isCertified||o:s.set(a,{multiaddr:i.multiaddr,isCertified:o})}return[...s.values()].sort((i,o)=>i.multiaddr.toString().localeCompare(o.multiaddr.toString())).map(({isCertified:i,multiaddr:o})=>({isCertified:i,multiaddr:o.bytes}))}async function Gu(n,t,e,r){if(t==null)throw new Z("Invalid PeerData");if(t.publicKey!=null&&n.publicKey!=null&&!t.publicKey.equals(n.publicKey))throw new Z("publicKey bytes do not match peer id publicKey bytes");const s=r.existingPeer?.peer;if(s!=null&&!n.equals(s.id))throw new Z("peer id did not match existing peer id");let i=s?.addresses??[],o=new Set(s?.protocols??[]),a=s?.metadata??new Map,l=s?.tags??new Map,u=s?.peerRecordEnvelope;if(e==="patch"){if((t.multiaddrs!=null||t.addresses!=null)&&(i=[],t.multiaddrs!=null&&i.push(...t.multiaddrs.map(d=>({isCertified:!1,multiaddr:d}))),t.addresses!=null&&i.push(...t.addresses)),t.protocols!=null&&(o=new Set(t.protocols)),t.metadata!=null){const d=t.metadata instanceof Map?[...t.metadata.entries()]:Object.entries(t.metadata);a=Ka(d,{validate:Tm})}if(t.tags!=null){const d=t.tags instanceof Map?[...t.tags.entries()]:Object.entries(t.tags);l=Ka(d,{validate:Cm,map:Pm})}t.peerRecordEnvelope!=null&&(u=t.peerRecordEnvelope)}if(e==="merge"){if(t.multiaddrs!=null&&i.push(...t.multiaddrs.map(d=>({isCertified:!1,multiaddr:d}))),t.addresses!=null&&i.push(...t.addresses),t.protocols!=null&&(o=new Set([...o,...t.protocols])),t.metadata!=null){const d=t.metadata instanceof Map?[...t.metadata.entries()]:Object.entries(t.metadata);for(const[f,g]of d)g==null?a.delete(f):a.set(f,g);a=Ka([...a.entries()],{validate:Tm})}if(t.tags!=null){const d=t.tags instanceof Map?[...t.tags.entries()]:Object.entries(t.tags),f=new Map(l);for(const[g,y]of d)y==null?f.delete(g):f.set(g,y);l=Ka([...f.entries()],{validate:Cm,map:Pm})}t.peerRecordEnvelope!=null&&(u=t.peerRecordEnvelope)}let h;s?.id.publicKey!=null?h=nr(s.id.publicKey):t.publicKey!=null?h=nr(t.publicKey):n.publicKey!=null&&(h=nr(n.publicKey));const c={addresses:await iB(n,r.addressFilter??(async()=>!0),i,r.existingPeer?.peerPB.addresses),protocols:[...o.values()].sort((d,f)=>d.localeCompare(f)),metadata:a,tags:l,publicKey:h,peerRecordEnvelope:u};return c.addresses.forEach(d=>{d.observed=r.existingPeer?.peerPB.addresses?.find(f=>It(f.multiaddr,f.multiaddr))?.observed??Date.now()}),n.type!=="RSA"&&delete c.publicKey,c}function Ka(n,t){const e=new Map;for(const[r,s]of n)s!=null&&t.validate(r,s);for(const[r,s]of n.sort(([i],[o])=>i.localeCompare(o)))s!=null&&e.set(r,t.map?.(r,s)??s);return e}function Tm(n,t){if(typeof n!="string")throw new Z("Metadata key must be a string");if(!(t instanceof Uint8Array))throw new Z("Metadata value must be a Uint8Array")}function Cm(n,t){if(typeof n!="string")throw new Z("Tag name must be a string");if(t.value!=null){if(parseInt(`${t.value}`,10)!==t.value)throw new Z("Tag value must be an integer");if(t.value<0||t.value>100)throw new Z("Tag value must be between 0-100")}if(t.ttl!=null){if(parseInt(`${t.ttl}`,10)!==t.ttl)throw new Z("Tag ttl must be an integer");if(t.ttl<0)throw new Z("Tag ttl must be between greater than 0")}}function Pm(n,t){let e;return t.expiry!=null&&(e=t.expiry),t.ttl!=null&&(e=BigInt(Date.now()+Number(t.ttl))),{value:t.value??0,expiry:e}}function Q_(n){const t=n.toString().split("/")[2],e=Qe.parse(t,Cr);return Ul(e)}function Ku(n,t,e){const r=Q_(n);return Eh(r,t,e)}function oB(n,t){return{prefix:Y_,filters:(n.filters??[]).map(e=>({key:r,value:s})=>e(Ku(r,s,t))),orders:(n.orders??[]).map(e=>(r,s)=>e(Ku(r.key,r.value,t),Ku(s.key,s.value,t)))}}var cn,ac,cc,lc;class aB{constructor(t,e={}){_e(this,cn);p(this,"peerId");p(this,"datastore");p(this,"lock");p(this,"addressFilter");p(this,"log");p(this,"maxAddressAge");p(this,"maxPeerAge");this.log=t.logger.forComponent("libp2p:peer-store"),this.peerId=t.peerId,this.datastore=t.datastore,this.addressFilter=e.addressFilter,this.lock=YL({name:"peer-store",singleProcess:!0}),this.maxAddressAge=e.maxAddressAge??QL,this.maxPeerAge=e.maxPeerAge??jL}async has(t){try{return await this.load(t),!0}catch(e){if(e.name!=="NotFoundError")throw e}return!1}async delete(t){this.peerId.equals(t)||await this.datastore.delete(Ga(t))}async load(t){const e=Ga(t),r=await this.datastore.get(e),s=As.decode(r);if(de(this,cn,lc).call(this,s))throw await this.datastore.delete(e),new Ec;return Ah(t,s,this.maxAddressAge)}async save(t,e){const r=await de(this,cn,ac).call(this,t),s=await Gu(t,e,"patch",{addressFilter:this.addressFilter});return de(this,cn,cc).call(this,t,s,r)}async patch(t,e){const r=await de(this,cn,ac).call(this,t),s=await Gu(t,e,"patch",{addressFilter:this.addressFilter,existingPeer:r});return de(this,cn,cc).call(this,t,s,r)}async merge(t,e){const r=await de(this,cn,ac).call(this,t),s=await Gu(t,e,"merge",{addressFilter:this.addressFilter,existingPeer:r});return de(this,cn,cc).call(this,t,s,r)}async*all(t){for await(const{key:e,value:r}of this.datastore.query(oB(t??{},this.maxAddressAge))){const s=Q_(e);if(s.equals(this.peerId))continue;const i=As.decode(r);if(de(this,cn,lc).call(this,i)){await this.datastore.delete(e);continue}yield Ah(s,i,this.maxAddressAge)}}}cn=new WeakSet,ac=async function(t){try{const e=Ga(t),r=await this.datastore.get(e),s=As.decode(r);if(de(this,cn,lc).call(this,s))throw await this.datastore.delete(e),new Ec;return{peerPB:s,peer:Eh(t,r,this.maxAddressAge)}}catch(e){e.name!=="NotFoundError"&&this.log.error("invalid peer data found in peer store - %e",e)}},cc=async function(t,e,r){e.updated=Date.now();const s=As.encode(e);return await this.datastore.put(Ga(t),s),{peer:Eh(t,s,this.maxAddressAge),previous:r?.peer,updated:r==null||!XL(e,r.peerPB)}},lc=function(t){if(t.updated==null)return!0;const e=t.updated<Date.now()-this.maxPeerAge,r=Date.now()-this.maxAddressAge,s=t.addresses.filter(i=>i.observed!=null&&i.observed>r);return e&&s.length===0};var Cy,Bi,uc;Cy=Symbol.toStringTag;class cB{constructor(t,e={}){_e(this,Bi);p(this,"store");p(this,"events");p(this,"peerId");p(this,"log");p(this,Cy,"@libp2p/peer-store");this.log=t.logger.forComponent("libp2p:peer-store"),this.events=t.events,this.peerId=t.peerId,this.store=new aB(t,e)}async forEach(t,e){this.log.trace("forEach await read lock");const r=await this.store.lock.readLock();this.log.trace("forEach got read lock");try{for await(const s of this.store.all(e))t(s)}finally{this.log.trace("forEach release read lock"),r()}}async all(t){this.log.trace("all await read lock");const e=await this.store.lock.readLock();this.log.trace("all got read lock");try{return await uh(this.store.all(t))}finally{this.log.trace("all release read lock"),e()}}async delete(t){this.log.trace("delete await write lock");const e=await this.store.lock.writeLock();this.log.trace("delete got write lock");try{await this.store.delete(t)}finally{this.log.trace("delete release write lock"),e()}}async has(t){this.log.trace("has await read lock");const e=await this.store.lock.readLock();this.log.trace("has got read lock");try{return await this.store.has(t)}finally{this.log.trace("has release read lock"),e()}}async get(t){this.log.trace("get await read lock");const e=await this.store.lock.readLock();this.log.trace("get got read lock");try{return await this.store.load(t)}finally{this.log.trace("get release read lock"),e()}}async save(t,e){this.log.trace("save await write lock");const r=await this.store.lock.writeLock();this.log.trace("save got write lock");try{const s=await this.store.save(t,e);return de(this,Bi,uc).call(this,t,s),s.peer}finally{this.log.trace("save release write lock"),r()}}async patch(t,e){this.log.trace("patch await write lock");const r=await this.store.lock.writeLock();this.log.trace("patch got write lock");try{const s=await this.store.patch(t,e);return de(this,Bi,uc).call(this,t,s),s.peer}finally{this.log.trace("patch release write lock"),r()}}async merge(t,e){this.log.trace("merge await write lock");const r=await this.store.lock.writeLock();this.log.trace("merge got write lock");try{const s=await this.store.merge(t,e);return de(this,Bi,uc).call(this,t,s),s.peer}finally{this.log.trace("merge release write lock"),r()}}async consumePeerRecord(t,e){const r=await Hs.openAndCertify(t,Dr.DOMAIN),s=Ul(r.publicKey.toCID());if(e?.equals(s)===!1)return this.log("envelope peer id was not the expected peer id - expected: %p received: %p",e,s),!1;const i=Dr.createFromProtobuf(r.payload);let o;try{o=await this.get(s)}catch(a){if(a.name!=="NotFoundError")throw a}if(o?.peerRecordEnvelope!=null){const a=await Hs.createFromProtobuf(o.peerRecordEnvelope),l=Dr.createFromProtobuf(a.payload);if(l.seqNumber>=i.seqNumber)return this.log("sequence number was lower or equal to existing sequence number - stored: %d received: %d",l.seqNumber,i.seqNumber),!1}return await this.patch(i.peerId,{peerRecordEnvelope:t,addresses:i.multiaddrs.map(a=>({isCertified:!0,multiaddr:a}))}),!0}}Bi=new WeakSet,uc=function(t,e){e.updated&&(this.peerId.equals(t)?this.events.safeDispatchEvent("self:peer:update",{detail:e}):this.events.safeDispatchEvent("peer:update",{detail:e}))};function lB(n,t={}){return new cB(n,t)}function uB(n,t){let e;const r=function(){const s=function(){e=void 0,n()};clearTimeout(e),e=setTimeout(s,t)};return r.start=()=>{},r.stop=()=>{clearTimeout(e)},r}const Dm=864e13,dB=448,Yu=449,hB=53,fB=54,pB=55,gB=56;class mB{constructor(t,e={}){p(this,"log");p(this,"mappings");this.log=t.logger.forComponent("libp2p:address-manager:dns-mappings"),this.mappings=new Map}has(t){const e=this.findHost(t);for(const r of this.mappings.values())if(r.domain===e)return!0;return!1}add(t,e){e.forEach(r=>{this.log("add DNS mapping %s to %s",r,t);const s=Jl(r)===!0;this.mappings.set(r,{domain:t,verified:s,expires:s?Dm-Date.now():0,lastVerified:s?Dm-Date.now():void 0})})}remove(t){const e=this.findHost(t);let r=!1;for(const[s,i]of this.mappings.entries())i.domain===e&&(this.log("removing %s to %s DNS mapping %e",s,i.domain,new Error("where")),this.mappings.delete(s),r=r||i.verified);return r}getAll(t){const e=[];for(let r=0;r<t.length;r++){const i=t[r].multiaddr.stringTuples(),o=i[0][1];if(o!=null)for(const[a,l]of this.mappings.entries()){if(o!==a)continue;this.maybeAddSNITuple(i,l.domain)&&(t.splice(r,1),r--,e.push({multiaddr:me(`/${i.map(h=>[pe(h[0]).name,h[1]].join("/")).join("/")}`),verified:l.verified,type:"dns-mapping",expires:l.expires,lastVerified:l.lastVerified}))}}return e}maybeAddSNITuple(t,e){for(let r=0;r<t.length;r++)if(t[r][0]===dB&&t[r+1]?.[0]!==Yu)return t.splice(r+1,0,[Yu,e]),!0;return!1}confirm(t,e){const r=this.findHost(t);let s=!1;for(const[i,o]of this.mappings.entries())o.domain===r&&(this.log("marking %s to %s DNS mapping as verified",i,o.domain),s=o.verified,o.verified=!0,o.expires=Date.now()+e,o.lastVerified=Date.now());return s}unconfirm(t,e){const r=this.findHost(t);let s=!1;for(const[i,o]of this.mappings.entries())o.domain===r&&(this.log("removing verification of %s to %s DNS mapping",i,o.domain),s=s||o.verified,o.verified=!1,o.expires=Date.now()+e);return s}findHost(t){for(const e of t.stringTuples())if(e[0]===Yu||e[0]===hB||e[0]===fB||e[0]===pB||e[0]===gB)return e[1]}}const Qu=4,ju=41,Zu=6,yB=273;class vB{constructor(t,e={}){p(this,"log");p(this,"mappings");this.log=t.logger.forComponent("libp2p:address-manager:ip-mappings"),this.mappings=new Map}has(t){const e=t.stringTuples();for(const r of this.mappings.values())for(const s of r)if(s.externalIp===e[0][1])return!0;return!1}add(t,e,r,s=e,i="tcp"){const o=`${t}-${e}-${i}`,a=this.mappings.get(o)??[],l={internalIp:t,internalPort:e,externalIp:r,externalPort:s,externalFamily:zi(r)?4:6,protocol:i,verified:!1,expires:0};a.push(l),this.mappings.set(o,a)}remove(t){const e=t.stringTuples(),r=e[0][1]??"",s=e[1][0]===Zu?"tcp":"udp",i=parseInt(e[1][1]??"0");let o=!1;for(const[a,l]of this.mappings.entries()){for(let u=0;u<l.length;u++){const h=l[u];h.externalIp===r&&h.externalPort===i&&h.protocol===s&&(this.log("removing %s:%s to %s:%s %s IP mapping",h.externalIp,h.externalPort,r,i,s),o=o||h.verified,l.splice(u,1),u--)}l.length===0&&this.mappings.delete(a)}return o}getAll(t){const e=[];for(const{multiaddr:r}of t){const s=r.stringTuples();let i;if((s[0][0]===Qu||s[0][0]===ju)&&s[1][0]===Zu?i=`${s[0][1]}-${s[1][1]}-tcp`:(s[0][0]===Qu||s[0][0]===ju)&&s[1][0]===yB&&(i=`${s[0][1]}-${s[1][1]}-udp`),i==null)continue;const o=this.mappings.get(i);if(o!=null)for(const a of o)s[0][0]=a.externalFamily===4?Qu:ju,s[0][1]=a.externalIp,s[1][1]=`${a.externalPort}`,e.push({multiaddr:me(`/${s.map(l=>[pe(l[0]).name,l[1]].join("/")).join("/")}`),verified:a.verified,type:"ip-mapping",expires:a.expires,lastVerified:a.lastVerified})}return e}confirm(t,e){const s=t.stringTuples()[0][1];let i=!1;for(const o of this.mappings.values())for(const a of o)a.externalIp===s&&(this.log("marking %s to %s IP mapping as verified",a.internalIp,a.externalIp),i=a.verified,a.verified=!0,a.expires=Date.now()+e,a.lastVerified=Date.now());return i}unconfirm(t,e){const r=t.stringTuples(),s=r[0][1]??"",i=r[1][0]===Zu?"tcp":"udp",o=parseInt(r[1][1]??"0");let a=!1;for(const l of this.mappings.values())for(let u=0;u<l.length;u++){const h=l[u];h.externalIp===s&&h.externalPort===o&&h.protocol===i&&(this.log("removing verification of %s:%s to %s:%s %s IP mapping",h.externalIp,h.externalPort,s,o,i),a=a||h.verified,h.verified=!1,h.expires=Date.now()+e)}return a}}const bB=4,wB=41;function _B(n){try{const[[t,e]]=n.stringTuples();if(e==null)return!1;if(t===bB)return e.startsWith("169.254.");if(t===wB)return e.toLowerCase().startsWith("fe80")}catch{}return!1}const SB={maxObservedAddresses:10};class EB{constructor(t,e={}){p(this,"log");p(this,"addresses");p(this,"maxObservedAddresses");this.log=t.logger.forComponent("libp2p:address-manager:observed-addresses"),this.addresses=new Map,this.maxObservedAddresses=e.maxObservedAddresses??SB.maxObservedAddresses}has(t){return this.addresses.has(t.toString())}removePrefixed(t){for(const e of this.addresses.keys())e.toString().startsWith(t)&&this.addresses.delete(e)}add(t){this.addresses.size!==this.maxObservedAddresses&&(aa(t)||_B(t)||(this.log("adding observed address %a",t),this.addresses.set(t.toString(),{verified:!1,expires:0})))}getAll(){return Array.from(this.addresses).map(([t,e])=>({multiaddr:me(t),verified:e.verified,type:"observed",expires:e.expires,lastVerified:e.lastVerified}))}remove(t){const e=this.addresses.get(t.toString())?.verified??!1;return this.log("removing observed address %a",t),this.addresses.delete(t.toString()),e}confirm(t,e){const r=t.toString(),s=this.addresses.get(r)??{verified:!1,expires:Date.now()+e,lastVerified:Date.now()},i=s.verified;return s.verified=!0,s.expires=Date.now()+e,s.lastVerified=Date.now(),this.log("marking observed address %a as verified",r),this.addresses.set(r,s),i}}const AB=4,xB=41,IB=53,kB=54,TB=55,CB=56,PB=[AB,xB,IB,kB,TB,CB];function Mm(n){try{const[[t]]=n.stringTuples();return PB.includes(t)}catch{}return!1}const DB={maxObservedAddresses:10};class MB{constructor(t,e={}){p(this,"log");p(this,"addresses");p(this,"maxObservedAddresses");this.log=t.logger.forComponent("libp2p:address-manager:observed-addresses"),this.addresses=new Map,this.maxObservedAddresses=e.maxObservedAddresses??DB.maxObservedAddresses}get(t,e){if(aa(t))return{multiaddr:t,verified:!0,type:"transport",expires:Date.now()+e,lastVerified:Date.now()};const r=this.toKey(t);let s=this.addresses.get(r);return s==null&&(s={verified:!Mm(t),expires:0},this.addresses.set(r,s)),{multiaddr:t,verified:s.verified,type:"transport",expires:s.expires,lastVerified:s.lastVerified}}has(t){const e=this.toKey(t);return this.addresses.has(e)}remove(t){const e=this.toKey(t),r=this.addresses.get(e)?.verified??!1;return this.log("removing observed address %a",t),this.addresses.delete(e),r}confirm(t,e){const r=this.toKey(t),s=this.addresses.get(r)??{verified:!1,expires:0,lastVerified:0},i=s.verified;return s.verified=!0,s.expires=Date.now()+e,s.lastVerified=Date.now(),this.addresses.set(r,s),i}unconfirm(t,e){const r=this.toKey(t),s=this.addresses.get(r)??{verified:!1,expires:0},i=s.verified;return s.verified=!1,s.expires=Date.now()+e,this.addresses.set(r,s),i}toKey(t){if(Mm(t)){const e=t.toOptions();return`${e.host}-${e.port}-${e.transport}`}return t.toString()}}const Lm=6e4,Bm={addressVerificationTTL:Lm*10,addressVerificationRetry:Lm*5},LB=n=>n;function Xu(n,t){const e=n.getPeerId();return e!=null&&Bt(e).equals(t)&&(n=n.decapsulate(me(`/p2p/${t.toString()}`))),n}var Py;Py=Symbol.toStringTag;class BB{constructor(t,e={}){p(this,"log");p(this,"components");p(this,"listen");p(this,"announce");p(this,"appendAnnounce");p(this,"announceFilter");p(this,"observed");p(this,"dnsMappings");p(this,"ipMappings");p(this,"transportAddresses");p(this,"observedAddressFilter");p(this,"addressVerificationTTL");p(this,"addressVerificationRetry");p(this,Py,"@libp2p/address-manager");const{listen:r=[],announce:s=[],appendAnnounce:i=[]}=e;this.components=t,this.log=t.logger.forComponent("libp2p:address-manager"),this.listen=r.map(o=>o.toString()),this.announce=new Set(s.map(o=>o.toString())),this.appendAnnounce=new Set(i.map(o=>o.toString())),this.observed=new EB(t,e),this.dnsMappings=new mB(t,e),this.ipMappings=new vB(t,e),this.transportAddresses=new MB(t,e),this.announceFilter=e.announceFilter??LB,this.observedAddressFilter=ia(1024),this.addressVerificationTTL=e.addressVerificationTTL??Bm.addressVerificationTTL,this.addressVerificationRetry=e.addressVerificationRetry??Bm.addressVerificationRetry,this._updatePeerStoreAddresses=uB(this._updatePeerStoreAddresses.bind(this),1e3),t.events.addEventListener("transport:listening",()=>{this._updatePeerStoreAddresses()}),t.events.addEventListener("transport:close",()=>{this._updatePeerStoreAddresses()})}_updatePeerStoreAddresses(){const t=this.getAddresses().map(e=>e.getPeerId()===this.components.peerId.toString()?e.decapsulate(`/p2p/${this.components.peerId.toString()}`):e);this.components.peerStore.patch(this.components.peerId,{multiaddrs:t}).catch(e=>{this.log.error("error updating addresses",e)})}getListenAddrs(){return Array.from(this.listen).map(t=>me(t))}getAnnounceAddrs(){return Array.from(this.announce).map(t=>me(t))}getAppendAnnounceAddrs(){return Array.from(this.appendAnnounce).map(t=>me(t))}getObservedAddrs(){return this.observed.getAll().map(t=>t.multiaddr)}addObservedAddr(t){const e=t.stringTuples(),r=`${e[0][1]}:${e[1][1]}`;this.observedAddressFilter.has(r)||(this.observedAddressFilter.add(r),t=Xu(t,this.components.peerId),!this.ipMappings.has(t)&&(this.dnsMappings.has(t)||this.observed.add(t)))}confirmObservedAddr(t,e){t=Xu(t,this.components.peerId);let r=!0;(e?.type==="transport"||this.transportAddresses.has(t))&&!this.transportAddresses.confirm(t,e?.ttl??this.addressVerificationTTL)&&r&&(r=!1),(e?.type==="dns-mapping"||this.dnsMappings.has(t))&&!this.dnsMappings.confirm(t,e?.ttl??this.addressVerificationTTL)&&r&&(r=!1),(e?.type==="ip-mapping"||this.ipMappings.has(t))&&!this.ipMappings.confirm(t,e?.ttl??this.addressVerificationTTL)&&r&&(r=!1),(e?.type==="observed"||this.observed.has(t))&&(this.maybeUpgradeToIPMapping(t)?(this.ipMappings.confirm(t,e?.ttl??this.addressVerificationTTL),r=!1):!this.observed.confirm(t,e?.ttl??this.addressVerificationTTL)&&r&&(r=!1)),r||this._updatePeerStoreAddresses()}removeObservedAddr(t,e){t=Xu(t,this.components.peerId),this.observed.has(t)&&this.observed.remove(t),this.transportAddresses.has(t)&&this.transportAddresses.unconfirm(t,e?.ttl??this.addressVerificationRetry),this.dnsMappings.has(t)&&this.dnsMappings.unconfirm(t,e?.ttl??this.addressVerificationRetry),this.ipMappings.has(t)&&this.ipMappings.unconfirm(t,e?.ttl??this.addressVerificationRetry)}getAddresses(){const t=new Set,e=this.getAddressesWithMetadata().filter(r=>{if(!r.verified)return!1;const s=r.multiaddr.toString();return t.has(s)?!1:(t.add(s),!0)}).map(r=>r.multiaddr);return this.announceFilter(e.map(r=>{const s=me(r);return s.protos().pop()?.path===!0||s.getPeerId()===this.components.peerId.toString()?s:s.encapsulate(`/p2p/${this.components.peerId.toString()}`)}))}getAddressesWithMetadata(){const t=this.getAnnounceAddrs();if(t.length>0)return this.components.transportManager.getListeners().forEach(r=>{r.updateAnnounceAddrs(t)}),t.map(r=>({multiaddr:r,verified:!0,type:"announce",expires:Date.now()+this.addressVerificationTTL,lastVerified:Date.now()}));let e=[];return e=e.concat(this.components.transportManager.getAddrs().map(r=>this.transportAddresses.get(r,this.addressVerificationTTL))),e=e.concat(this.getAppendAnnounceAddrs().map(r=>({multiaddr:r,verified:!0,type:"announce",expires:Date.now()+this.addressVerificationTTL,lastVerified:Date.now()}))),e=e.concat(this.observed.getAll()),e=e.concat(this.ipMappings.getAll(e)),e=e.concat(this.dnsMappings.getAll(e)),e}addDNSMapping(t,e){this.dnsMappings.add(t,e)}removeDNSMapping(t){this.dnsMappings.remove(me(`/dns/${t}`))&&this._updatePeerStoreAddresses()}addPublicAddressMapping(t,e,r,s=e,i="tcp"){this.ipMappings.add(t,e,r,s,i),this.observed.removePrefixed(`/ip${zi(r)?4:6}/${r}/${i}/${s}`)}removePublicAddressMapping(t,e,r,s=e,i="tcp"){this.ipMappings.remove(me(`/ip${zi(r)?4:6}/${r}/${i}/${s}`))&&this._updatePeerStoreAddresses()}maybeUpgradeToIPMapping(t){if(this.ipMappings.has(t))return!1;const e=t.toOptions();if(e.family===6||e.host==="127.0.0.1"||Jl(e.host)===!0)return!1;const r=this.components.transportManager.getListeners(),s=[i=>ra.exactMatch(i)||Kc.exactMatch(i),i=>Gc.exactMatch(i),i=>kP.exactMatch(i)];for(const i of s){if(!i(t))continue;const o=r.filter(u=>u.getAddrs().filter(h=>h.toOptions().family===4&&i(h)).length>0);if(o.length!==1)continue;const a=o[0].getAddrs().filter(u=>u.toOptions().host!=="127.0.0.1").pop();if(a==null)continue;const l=a.toOptions();return this.observed.remove(t),this.ipMappings.add(l.host,l.port,e.host,e.port,e.transport),!0}return!1}}var Nm;(function(n){n.NOT_STARTED_YET="The libp2p node is not started yet",n.NOT_FOUND="Not found"})(Nm||(Nm={}));class NB extends Error{constructor(t="Missing service"){super(t),this.name="MissingServiceError"}}class RB extends Error{constructor(t="Unmet service dependencies"){super(t),this.name="UnmetServiceDependenciesError"}}class Ju extends Error{constructor(t="No content routers available"){super(t),this.name="NoContentRoutersError"}}class Rm extends Error{constructor(t="No peer routers available"){super(t),this.name="NoPeerRoutersError"}}class OB extends Error{constructor(t="Should not try to find self"){super(t),this.name="QueriedForSelfError"}}class FB extends Error{constructor(t="Unhandled protocol error"){super(t),this.name="UnhandledProtocolError"}}class $B extends Error{constructor(t="Duplicate protocol handler error"){super(t),this.name="DuplicateProtocolHandlerError"}}class Om extends Error{constructor(t="Dial denied error"){super(t),this.name="DialDeniedError"}}class UB extends Error{constructor(t="No transport was configured to listen on this address"){super(t),this.name="UnsupportedListenAddressError"}}class VB extends Error{constructor(t="Configured listen addresses could not be listened on"){super(t),this.name="UnsupportedListenAddressesError"}}class HB extends Error{constructor(t="No valid addresses"){super(t),this.name="NoValidAddressesError"}}class zB extends Error{constructor(t="Connection intercepted"){super(t),this.name="ConnectionInterceptedError"}}class qB extends Error{constructor(t="Connection denied"){super(t),this.name="ConnectionDeniedError"}}class Ya extends Error{constructor(t="Stream is not multiplexed"){super(t),this.name="MuxerUnavailableError"}}class Qa extends Error{constructor(t="Encryption failed"){super(t),this.name="EncryptionFailedError"}}class WB extends Error{constructor(t="Transport unavailable"){super(t),this.name="TransportUnavailableError"}}class GB{constructor(t={}){p(this,"components",{});p(this,"_started",!1);this.components={};for(const[e,r]of Object.entries(t))this.components[e]=r;this.components.logger==null&&(this.components.logger=rp())}isStarted(){return this._started}async _invokeStartableMethod(t){await Promise.all(Object.values(this.components).filter(e=>af(e)).map(async e=>{await e[t]?.()}))}async beforeStart(){await this._invokeStartableMethod("beforeStart")}async start(){await this._invokeStartableMethod("start"),this._started=!0}async afterStart(){await this._invokeStartableMethod("afterStart")}async beforeStop(){await this._invokeStartableMethod("beforeStop")}async stop(){await this._invokeStartableMethod("stop"),this._started=!1}async afterStop(){await this._invokeStartableMethod("afterStop")}}const KB=["metrics","connectionProtector","dns"],YB=["components","isStarted","beforeStart","start","afterStart","beforeStop","stop","afterStop","then","_invokeStartableMethod"];function QB(n={}){const t=new GB(n);return new Proxy(t,{get(r,s,i){if(typeof s=="string"&&!YB.includes(s)){const o=t.components[s];if(o==null&&!KB.includes(s))throw new NB(`${s} not set`);return o}return Reflect.get(r,s,i)},set(r,s,i){return typeof s=="string"?t.components[s]=i:Reflect.set(r,s,i),!0}})}function jB(n){const t={};for(const e of Object.values(n.components))for(const r of ZB(e))t[r]=!0;for(const e of Object.values(n.components))for(const r of XB(e))if(t[r]!==!0)throw new RB(`Service "${JB(e)}" required capability "${r}" but it was not provided by any component, you may need to add additional configuration when creating your node.`)}function ZB(n){return Array.isArray(n?.[Wn])?n[Wn]:[]}function XB(n){return Array.isArray(n?.[xc])?n[xc]:[]}function JB(n){return n?.[Symbol.toStringTag]??n?.toString()??"unknown"}const eN=4,tN=41;function nN(n={}){return{denyDialPeer:async()=>!1,denyDialMultiaddr:async t=>{if(ra.matches(t))return!1;const e=t.stringTuples();return e[0][0]===eN||e[0][0]===tN?!!Jl(`${e[0][1]}`):!1},denyInboundConnection:async()=>!1,denyOutboundConnection:async()=>!1,denyInboundEncryptedConnection:async()=>!1,denyOutboundEncryptedConnection:async()=>!1,denyInboundUpgradedConnection:async()=>!1,denyOutboundUpgradedConnection:async()=>!1,filterMultiaddrForPeer:async()=>!0,...n}}const Fm=()=>{const n=new Error("Delay aborted");return n.name="AbortError",n},rN=new WeakMap;function sN({clearTimeout:n,setTimeout:t}={}){return(e,{value:r,signal:s}={})=>{if(s?.aborted)return Promise.reject(Fm());let i,o,a;const l=n??clearTimeout,u=()=>{l(i),a(Fm())},h=()=>{s&&s.removeEventListener("abort",u)},c=new Promise((d,f)=>{o=()=>{h(),d(r)},a=f,i=(t??setTimeout)(o,e)});return s&&s.addEventListener("abort",u,{once:!0}),rN.set(c,()=>{l(i),i=null,o()}),c}}const iN=sN();class oN{constructor(t={}){p(this,"memoryStorage");p(this,"points");p(this,"duration");p(this,"blockDuration");p(this,"execEvenly");p(this,"execEvenlyMinDelayMs");p(this,"keyPrefix");this.points=t.points??4,this.duration=t.duration??1,this.blockDuration=t.blockDuration??0,this.execEvenly=t.execEvenly??!1,this.execEvenlyMinDelayMs=t.execEvenlyMinDelayMs??this.duration*1e3/this.points,this.keyPrefix=t.keyPrefix??"rlflx",this.memoryStorage=new aN}async consume(t,e=1,r={}){const s=this.getKey(t),i=this._getKeySecDuration(r);let o=this.memoryStorage.incrby(s,e,i);if(o.remainingPoints=Math.max(this.points-o.consumedPoints,0),o.consumedPoints>this.points)throw this.blockDuration>0&&o.consumedPoints<=this.points+e&&(o=this.memoryStorage.set(s,o.consumedPoints,this.blockDuration)),new GP("Rate limit exceeded",o);if(this.execEvenly&&o.msBeforeNext>0&&!o.isFirstInDuration){let a=Math.ceil(o.msBeforeNext/(o.remainingPoints+2));a<this.execEvenlyMinDelayMs&&(a=o.consumedPoints*this.execEvenlyMinDelayMs),await iN(a)}return o}penalty(t,e=1,r={}){const s=this.getKey(t),i=this._getKeySecDuration(r),o=this.memoryStorage.incrby(s,e,i);return o.remainingPoints=Math.max(this.points-o.consumedPoints,0),o}reward(t,e=1,r={}){const s=this.getKey(t),i=this._getKeySecDuration(r),o=this.memoryStorage.incrby(s,-e,i);return o.remainingPoints=Math.max(this.points-o.consumedPoints,0),o}block(t,e){const r=e*1e3,s=this.points+1;return this.memoryStorage.set(this.getKey(t),s,e),{remainingPoints:0,msBeforeNext:r===0?-1:r,consumedPoints:s,isFirstInDuration:!1}}set(t,e,r=0){const s=(r>=0?r:this.duration)*1e3;return this.memoryStorage.set(this.getKey(t),e,r),{remainingPoints:0,msBeforeNext:s===0?-1:s,consumedPoints:e,isFirstInDuration:!1}}get(t){const e=this.memoryStorage.get(this.getKey(t));return e!=null&&(e.remainingPoints=Math.max(this.points-e.consumedPoints,0)),e}delete(t){this.memoryStorage.delete(this.getKey(t))}_getKeySecDuration(t){return t?.customDuration!=null&&t.customDuration>=0?t.customDuration:this.duration}getKey(t){return this.keyPrefix.length>0?`${this.keyPrefix}:${t}`:t}parseKey(t){return t.substring(this.keyPrefix.length)}}class aN{constructor(){p(this,"storage");this.storage=new Map}incrby(t,e,r){const s=this.storage.get(t);if(s!=null){const i=s.expiresAt!=null?s.expiresAt.getTime()-new Date().getTime():-1;return s.expiresAt==null||i>0?(s.value+=e,{remainingPoints:0,msBeforeNext:i,consumedPoints:s.value,isFirstInDuration:!1}):this.set(t,e,r)}return this.set(t,e,r)}set(t,e,r){const s=r*1e3,i=this.storage.get(t);i!=null&&clearTimeout(i.timeoutId);const o={value:e,expiresAt:s>0?new Date(Date.now()+s):void 0};return this.storage.set(t,o),s>0&&(o.timeoutId=setTimeout(()=>{this.storage.delete(t)},s),o.timeoutId.unref!=null&&o.timeoutId.unref()),{remainingPoints:0,msBeforeNext:s===0?-1:s,consumedPoints:o.value,isFirstInDuration:!0}}get(t){const e=this.storage.get(t);if(e!=null)return{remainingPoints:0,msBeforeNext:e.expiresAt!=null?e.expiresAt.getTime()-new Date().getTime():-1,consumedPoints:e.value,isFirstInDuration:!1}}delete(t){const e=this.storage.get(t);return e!=null?(e.timeoutId!=null&&clearTimeout(e.timeoutId),this.storage.delete(t),!0):!1}}function j_(n){if(eb(n))return{peerId:n,multiaddrs:[]};Array.isArray(n)||(n=[n]);let t;if(n.length>0){const e=n[0].getPeerId();t=e==null?void 0:Bt(e),n.forEach(r=>{if(!Hl(r))throw new Il("Invalid multiaddr");const s=r.getPeerId();if(s==null){if(t!=null)throw new Z("Multiaddrs must all have the same peer id or have no peer id")}else{const i=Bt(s);if(t?.equals(i)!==!0)throw new Z("Multiaddrs must all have the same peer id or have no peer id")}})}return{peerId:t,multiaddrs:n}}const cN=["/ipfs/id/1.0.0","/ipfs/id/push/1.0.0","/libp2p/autonat/1.0.0","/libp2p/dcutr"];async function lN(n,t){const e=n?.streams?.map(s=>s.protocol)??[],r=t?.closableProtocols??cN;if(!(e.filter(s=>s!=null&&!r.includes(s)).length>0))try{await n?.close(t)}catch(s){n?.abort(s)}}const Z_=1e4,uN=1e4,$m=1e4,X_=25,dN=5,hN=10,fN=5,pN="last-dial-failure",gN="last-dial-success",J_=500,e1=100,t1=50;async function mN(n,t){let e=!1;for(const s of Vf.keys())if(e=n.protoNames().includes(s),e)break;if(!e)return[n];const r=await n.resolve(t);return t.log("resolved %s to",n,r.map(s=>s.toString())),r}function xh(n){try{let t;if(typeof n=="string"?t=me(n):t=n,!t.protoNames().includes("ipcidr")){const r=t.protoNames().includes("ip6")?"/ipcidr/128":"/ipcidr/32";t=t.encapsulate(r)}return gC(t)}catch{throw new Error(`Can't convert to IpNet, Invalid multiaddr format: ${n}`)}}const yN={maxConnections:e1};class vN{constructor(t,e={}){p(this,"maxConnections");p(this,"connectionManager");p(this,"peerStore");p(this,"allow");p(this,"events");p(this,"log");this.maxConnections=e.maxConnections??yN.maxConnections,this.allow=(e.allow??[]).map(r=>xh(r)),this.connectionManager=t.connectionManager,this.peerStore=t.peerStore,this.events=t.events,this.log=t.logger.forComponent("libp2p:connection-manager:connection-pruner"),this.maybePruneConnections=this.maybePruneConnections.bind(this)}start(){this.events.addEventListener("connection:open",this.maybePruneConnections)}stop(){this.events.removeEventListener("connection:open",this.maybePruneConnections)}maybePruneConnections(){this._maybePruneConnections().catch(t=>{this.log.error("error while pruning connections %e",t)})}async _maybePruneConnections(){const t=this.connectionManager.getConnections(),e=t.length;if(this.log("checking max connections limit %d/%d",e,this.maxConnections),e<=this.maxConnections)return;const r=new Zl;for(const a of t){const l=a.remotePeer;if(!r.has(l)){r.set(l,0);try{const u=await this.peerStore.get(l);r.set(l,[...u.tags.values()].reduce((h,c)=>h+c.value,0))}catch(u){u.name!=="NotFoundError"&&this.log.error("error loading peer tags",u)}}}const s=this.sortConnections(t,r),i=Math.max(e-this.maxConnections,0),o=[];for(const a of s)if(this.log("too many connections open - closing a connection to %p",a.remotePeer),this.allow.some(u=>u.contains(a.remoteAddr.nodeAddress().address))||o.push(a),o.length===i)break;await Promise.all(o.map(async a=>{await lN(a,{signal:AbortSignal.timeout(1e3)})})),this.events.safeDispatchEvent("connection:prune",{detail:o})}sortConnections(t,e){return t.sort((r,s)=>{const i=r.timeline.open,o=s.timeline.open;return i<o?1:i>o?-1:0}).sort((r,s)=>r.direction==="outbound"&&s.direction==="inbound"?1:r.direction==="inbound"&&s.direction==="outbound"?-1:0).sort((r,s)=>r.streams.length>s.streams.length?1:r.streams.length<s.streams.length?-1:0).sort((r,s)=>{const i=e.get(r.remotePeer)??0,o=e.get(s.remotePeer)??0;return i>o?1:i<o?-1:0})}}class bN extends Jw{constructor(t={}){super({...t,sort:(e,r)=>e.options.priority>r.options.priority?-1:e.options.priority<r.options.priority?1:0})}}function wN(n){return/^127\.([0-9]{1,3})\.([0-9]{1,3})\.([0-9]{1,3})$/i.test(n)||/^::1$/.test(n)}function Um(n){if(!k_(n))return!1;const{address:t}=n.nodeAddress();return wN(t)}function _N(n,t){const e=Gc.exactMatch(n.multiaddr),r=Gc.exactMatch(t.multiaddr);if(e&&!r)return-1;if(!e&&r)return 1;const s=Kc.exactMatch(n.multiaddr),i=Kc.exactMatch(t.multiaddr);if(s&&!i)return-1;if(!s&&i)return 1;const o=ra.exactMatch(n.multiaddr),a=ra.exactMatch(t.multiaddr);if(o&&!a)return-1;if(!o&&a)return 1;const l=Bg.exactMatch(n.multiaddr),u=Bg.exactMatch(t.multiaddr);if(l&&!u)return-1;if(!l&&u)return 1;const h=Mg.exactMatch(n.multiaddr),c=Mg.exactMatch(t.multiaddr);if(h&&!c)return-1;if(!h&&c)return 1;const d=Lg.exactMatch(n.multiaddr),f=Lg.exactMatch(t.multiaddr);return d&&!f?-1:!d&&f?1:0}function SN(n,t){const e=Um(n.multiaddr),r=Um(t.multiaddr);return e&&!r?1:!e&&r?-1:0}function EN(n,t){const e=aa(n.multiaddr),r=aa(t.multiaddr);return e&&!r?1:!e&&r?-1:0}function AN(n,t){return n.isCertified&&!t.isCertified?-1:!n.isCertified&&t.isCertified?1:0}function xN(n,t){const e=sa.exactMatch(n.multiaddr),r=sa.exactMatch(t.multiaddr);return e&&!r?1:!e&&r?-1:0}function IN(n){return n.sort(_N).sort(AN).sort(xN).sort(EN).sort(SN)}const ja={maxParallelDials:t1,maxDialQueueLength:J_,maxPeerAddrsToDial:X_,dialTimeout:Z_};class kN{constructor(t,e={}){p(this,"queue");p(this,"components");p(this,"addressSorter");p(this,"maxPeerAddrsToDial");p(this,"maxDialQueueLength");p(this,"dialTimeout");p(this,"shutDownController");p(this,"connections");p(this,"log");this.addressSorter=e.addressSorter,this.maxPeerAddrsToDial=e.maxPeerAddrsToDial??ja.maxPeerAddrsToDial,this.maxDialQueueLength=e.maxDialQueueLength??ja.maxDialQueueLength,this.dialTimeout=e.dialTimeout??ja.dialTimeout,this.connections=e.connections??new Zl,this.log=t.logger.forComponent("libp2p:connection-manager:dial-queue"),this.components=t,this.shutDownController=new AbortController,this.shutDownController.signal;for(const[r,s]of Object.entries(e.resolvers??{}))Vf.set(r,s);this.queue=new bN({concurrency:e.maxParallelDials??ja.maxParallelDials,metricName:"libp2p_dial_queue",metrics:t.metrics}),this.queue.addEventListener("error",r=>{r.detail.name!==Ns.name&&this.log.error("error in dial queue - %e",r.detail)})}start(){this.shutDownController=new AbortController,this.shutDownController.signal}stop(){this.shutDownController.abort(),this.queue.abort()}async dial(t,e={}){const{peerId:r,multiaddrs:s}=j_(t),i=Array.from(this.connections.values()).flat().find(a=>e.force===!0?!1:a.remotePeer.equals(r)?!0:s.find(l=>l.equals(a.remoteAddr)));if(i?.status==="open")return this.log("already connected to %a",i.remoteAddr),e.onProgress?.(new vt("dial-queue:already-connected")),i;const o=this.queue.queue.find(a=>{if(r?.equals(a.options.peerId)===!0)return!0;const l=a.options.multiaddrs;if(l==null)return!1;for(const u of s)if(l.has(u.toString()))return!0;return!1});if(o!=null){this.log("joining existing dial target for %p",r);for(const a of s)o.options.multiaddrs.add(a.toString());return e.onProgress?.(new vt("dial-queue:already-in-dial-queue")),o.join(e)}if(this.queue.size>=this.maxDialQueueLength)throw new Ei("Dial queue is full");return this.log("creating dial target for %p",r,s.map(a=>a.toString())),e.onProgress?.(new vt("dial-queue:add-to-dial-queue")),this.queue.add(async a=>{a.onProgress?.(new vt("dial-queue:start-dial"));const l=Qi([this.shutDownController.signal,a.signal]);try{return await this.dialPeer(a,l)}finally{l.clear()}},{peerId:r,priority:e.priority??n1,multiaddrs:new Set(s.map(a=>a.toString())),signal:e.signal??AbortSignal.timeout(this.dialTimeout),onProgress:e.onProgress})}async dialPeer(t,e){const r=t.peerId,s=t.multiaddrs,i=new Set;let o=t.multiaddrs.size===0,a=0,l=0;const u=[];for(this.log("starting dial to %p",r);o||s.size>0;){l++,o=!1;const h=[],c=new Set(t.multiaddrs);s.clear(),this.log("calculating addrs to dial %p from %s",r,[...c]);const d=await this.calculateMultiaddrs(r,c,{...t,signal:e});for(const f of d){if(i.has(f.multiaddr.toString())){this.log.trace("skipping previously failed multiaddr %a while dialing %p",f.multiaddr,r);continue}h.push(f)}this.log("%s dial to %p with %s",l===1?"starting":"continuing",r,h.map(f=>f.multiaddr.toString())),t?.onProgress?.(new vt("dial-queue:calculated-addresses",h));for(const f of h){if(a===this.maxPeerAddrsToDial)throw this.log("dialed maxPeerAddrsToDial (%d) addresses for %p, not trying any others",a,t.peerId),new Ei("Peer had more than maxPeerAddrsToDial");a++;try{const g=await this.components.transportManager.dial(f.multiaddr,{...t,signal:e});this.log("dial to %a succeeded",f.multiaddr);try{await this.components.peerStore.merge(g.remotePeer,{multiaddrs:[g.remoteAddr],metadata:{[gN]:te(Date.now().toString())}})}catch(y){this.log.error("could not update last dial failure key for %p",r,y)}return g}catch(g){if(this.log.error("dial failed to %a",f.multiaddr,g),i.add(f.multiaddr.toString()),r!=null)try{await this.components.peerStore.merge(r,{metadata:{[pN]:te(Date.now().toString())}})}catch(y){this.log.error("could not update last dial failure key for %p",r,y)}if(e.aborted)throw new mA(g.message);u.push(g)}}}throw u.length===1?u[0]:new AggregateError(u,"All multiaddr dials failed")}async calculateMultiaddrs(t,e=new Set,r={}){const s=[...e].map(c=>({multiaddr:me(c),isCertified:!1}));if(t!=null){if(this.components.peerId.equals(t))throw new Ei("Tried to dial self");if(await this.components.connectionGater.denyDialPeer?.(t)===!0)throw new Om("The dial request is blocked by gater.allowDialPeer");if(s.length===0){this.log("loading multiaddrs for %p",t);try{const c=await this.components.peerStore.get(t);s.push(...c.addresses),this.log("loaded multiaddrs for %p",t,s.map(({multiaddr:d})=>d.toString()))}catch(c){if(c.name!=="NotFoundError")throw c}}if(s.length===0){this.log("looking up multiaddrs for %p in the peer routing",t);try{const c=await this.components.peerRouting.findPeer(t,r);this.log("found multiaddrs for %p in the peer routing",t,s.map(({multiaddr:d})=>d.toString())),s.push(...c.multiaddrs.map(d=>({multiaddr:d,isCertified:!1})))}catch(c){c.name==="NoPeerRoutersError"?this.log("no peer routers configured",t):this.log.error("looking up multiaddrs for %p in the peer routing failed - %e",t,c)}}}let i=(await Promise.all(s.map(async c=>{const d=await mN(c.multiaddr,{dns:this.components.dns,...r,log:this.log});return d.length===1&&d[0].equals(c.multiaddr)?c:d.map(f=>({multiaddr:f,isCertified:!1}))}))).flat();if(t!=null){const c=`/p2p/${t.toString()}`;i=i.map(d=>d.multiaddr.protos().pop()?.path===!0?d:d.multiaddr.getPeerId()==null?{multiaddr:d.multiaddr.encapsulate(c),isCertified:d.isCertified}:d)}const o=i.filter(c=>{if(this.components.transportManager.dialTransportForMultiaddr(c.multiaddr)==null)return!1;const d=c.multiaddr.getPeerId();return t!=null&&d!=null?t.equals(d):!0}),a=new Map;for(const c of o){const d=c.multiaddr.toString(),f=a.get(d);if(f!=null){f.isCertified=f.isCertified||c.isCertified||!1;continue}a.set(d,c)}const l=[...a.values()];if(l.length===0)throw new HB("The dial request has no valid addresses");const u=[];for(const c of l)this.components.connectionGater.denyDialMultiaddr!=null&&await this.components.connectionGater.denyDialMultiaddr(c.multiaddr)||u.push(c);const h=this.addressSorter==null?IN(u):u.sort(this.addressSorter);if(h.length===0)throw new Om("The connection gater denied all addresses in the dial request");return this.log.trace("addresses for %p before filtering",t??"unknown peer",i.map(({multiaddr:c})=>c.toString())),this.log.trace("addresses for %p after filtering",t??"unknown peer",h.map(({multiaddr:c})=>c.toString())),h}async isDialable(t,e={}){Array.isArray(t)||(t=[t]);try{const r=await this.calculateMultiaddrs(void 0,new Set(t.map(s=>s.toString())),e);return e.runOnLimitedConnection===!1?r.find(s=>!sa.matches(s.multiaddr))!=null:!0}catch(r){this.log.trace("error calculating if multiaddr(s) were dialable",r)}return!1}}var ed={},td,Vm;function TN(){if(Vm)return td;Vm=1;function n(t,e){typeof e=="boolean"&&(e={forever:e}),this._originalTimeouts=JSON.parse(JSON.stringify(t)),this._timeouts=t,this._options=e||{},this._maxRetryTime=e&&e.maxRetryTime||1/0,this._fn=null,this._errors=[],this._attempts=1,this._operationTimeout=null,this._operationTimeoutCb=null,this._timeout=null,this._operationStart=null,this._timer=null,this._options.forever&&(this._cachedTimeouts=this._timeouts.slice(0))}return td=n,n.prototype.reset=function(){this._attempts=1,this._timeouts=this._originalTimeouts.slice(0)},n.prototype.stop=function(){this._timeout&&clearTimeout(this._timeout),this._timer&&clearTimeout(this._timer),this._timeouts=[],this._cachedTimeouts=null},n.prototype.retry=function(t){if(this._timeout&&clearTimeout(this._timeout),!t)return!1;var e=new Date().getTime();if(t&&e-this._operationStart>=this._maxRetryTime)return this._errors.push(t),this._errors.unshift(new Error("RetryOperation timeout occurred")),!1;this._errors.push(t);var r=this._timeouts.shift();if(r===void 0)if(this._cachedTimeouts)this._errors.splice(0,this._errors.length-1),r=this._cachedTimeouts.slice(-1);else return!1;var s=this;return this._timer=setTimeout(function(){s._attempts++,s._operationTimeoutCb&&(s._timeout=setTimeout(function(){s._operationTimeoutCb(s._attempts)},s._operationTimeout),s._options.unref&&s._timeout.unref()),s._fn(s._attempts)},r),this._options.unref&&this._timer.unref(),!0},n.prototype.attempt=function(t,e){this._fn=t,e&&(e.timeout&&(this._operationTimeout=e.timeout),e.cb&&(this._operationTimeoutCb=e.cb));var r=this;this._operationTimeoutCb&&(this._timeout=setTimeout(function(){r._operationTimeoutCb()},r._operationTimeout)),this._operationStart=new Date().getTime(),this._fn(this._attempts)},n.prototype.try=function(t){console.log("Using RetryOperation.try() is deprecated"),this.attempt(t)},n.prototype.start=function(t){console.log("Using RetryOperation.start() is deprecated"),this.attempt(t)},n.prototype.start=n.prototype.try,n.prototype.errors=function(){return this._errors},n.prototype.attempts=function(){return this._attempts},n.prototype.mainError=function(){if(this._errors.length===0)return null;for(var t={},e=null,r=0,s=0;s<this._errors.length;s++){var i=this._errors[s],o=i.message,a=(t[o]||0)+1;t[o]=a,a>=r&&(e=i,r=a)}return e},td}var Hm;function CN(){return Hm||(Hm=1,function(n){var t=TN();n.operation=function(e){var r=n.timeouts(e);return new t(r,{forever:e&&(e.forever||e.retries===1/0),unref:e&&e.unref,maxRetryTime:e&&e.maxRetryTime})},n.timeouts=function(e){if(e instanceof Array)return[].concat(e);var r={retries:10,factor:2,minTimeout:1*1e3,maxTimeout:1/0,randomize:!1};for(var s in e)r[s]=e[s];if(r.minTimeout>r.maxTimeout)throw new Error("minTimeout is greater than maxTimeout");for(var i=[],o=0;o<r.retries;o++)i.push(this.createTimeout(o,r));return e&&e.forever&&!i.length&&i.push(this.createTimeout(o,r)),i.sort(function(a,l){return a-l}),i},n.createTimeout=function(e,r){var s=r.randomize?Math.random()+1:1,i=Math.round(s*Math.max(r.minTimeout,1)*Math.pow(r.factor,e));return i=Math.min(i,r.maxTimeout),i},n.wrap=function(e,r,s){if(r instanceof Array&&(s=r,r=null),!s){s=[];for(var i in e)typeof e[i]=="function"&&s.push(i)}for(var o=0;o<s.length;o++){var a=s[o],l=e[a];e[a]=function(h){var c=n.operation(r),d=Array.prototype.slice.call(arguments,1),f=d.pop();d.push(function(g){c.retry(g)||(g&&(arguments[0]=c.mainError()),f.apply(this,arguments))}),c.attempt(function(){h.apply(e,d)})}.bind(e,l),e[a].options=r}}}(ed)),ed}var nd,zm;function PN(){return zm||(zm=1,nd=CN()),nd}var DN=PN();const MN=ao(DN),LN=Object.prototype.toString,BN=n=>LN.call(n)==="[object Error]",NN=new Set(["network error","Failed to fetch","NetworkError when attempting to fetch resource.","The Internet connection appears to be offline.","Load failed","Network request failed","fetch failed","terminated"]);function RN(n){return n&&BN(n)&&n.name==="TypeError"&&typeof n.message=="string"?n.message==="Load failed"?n.stack===void 0:NN.has(n.message):!1}class ON extends Error{constructor(t){super(),t instanceof Error?(this.originalError=t,{message:t}=t):(this.originalError=new Error(t),this.originalError.stack=this.stack),this.name="AbortError",this.message=t}}const qm=(n,t,e)=>{const r=e.retries-(t-1);return n.attemptNumber=t,n.retriesLeft=r,n};async function FN(n,t){return new Promise((e,r)=>{t={...t},t.onFailedAttempt??(t.onFailedAttempt=()=>{}),t.shouldRetry??(t.shouldRetry=()=>!0),t.retries??(t.retries=10);const s=MN.operation(t),i=()=>{s.stop(),r(t.signal?.reason)};t.signal&&!t.signal.aborted&&t.signal.addEventListener("abort",i,{once:!0});const o=()=>{t.signal?.removeEventListener("abort",i),s.stop()};s.attempt(async a=>{try{const l=await n(a);o(),e(l)}catch(l){try{if(!(l instanceof Error))throw new TypeError(`Non-error was thrown: "${l}". You should only throw errors.`);if(l instanceof ON)throw l.originalError;if(l instanceof TypeError&&!RN(l))throw l;if(qm(l,a,t),await t.shouldRetry(l)||(s.stop(),r(l)),await t.onFailedAttempt(l),!s.retry(l))throw s.mainError()}catch(u){qm(u,a,t),o(),r(u)}}})})}class $N{constructor(t,e={}){p(this,"log");p(this,"queue");p(this,"started");p(this,"peerStore");p(this,"retries");p(this,"retryInterval");p(this,"backoffFactor");p(this,"connectionManager");p(this,"events");this.log=t.logger.forComponent("libp2p:reconnect-queue"),this.peerStore=t.peerStore,this.connectionManager=t.connectionManager,this.queue=new Yf({concurrency:e.maxParallelReconnects??fN,metricName:"libp2p_reconnect_queue",metrics:t.metrics}),this.started=!1,this.retries=e.retries??5,this.backoffFactor=e.backoffFactor,this.retryInterval=e.retryInterval,this.events=t.events,t.events.addEventListener("peer:disconnect",r=>{this.maybeReconnect(r.detail).catch(s=>{this.log.error("failed to maybe reconnect to %p - %e",r.detail,s)})})}async maybeReconnect(t){if(!this.started)return;const e=await this.peerStore.get(t);Wm(e)&&(this.queue.has(t)||this.queue.add(async r=>{await FN(async s=>{if(this.started)try{await this.connectionManager.openConnection(t,{signal:r?.signal})}catch(i){throw this.log("reconnecting to %p attempt %d of %d failed - %e",t,s,this.retries,i),i}},{signal:r?.signal,retries:this.retries,factor:this.backoffFactor,minTimeout:this.retryInterval})},{peerId:t}).catch(async r=>{this.log.error("failed to reconnect to %p - %e",t,r);const s={};[...e.tags.keys()].forEach(i=>{i.startsWith(Xh)&&(s[i]=void 0)}),await this.peerStore.merge(t,{tags:s}),this.events.safeDispatchEvent("peer:reconnect-failure",{detail:t})}).catch(async r=>{this.log.error("failed to remove keep-alive tag from %p - %e",t,r)}))}start(){this.started=!0}async afterStart(){Promise.resolve().then(async()=>{const t=await this.peerStore.all({filters:[e=>Wm(e)]});await Promise.all(t.map(async e=>{await this.connectionManager.openConnection(e.id).catch(r=>{this.log.error(r)})}))}).catch(t=>{this.log.error(t)})}stop(){this.started=!1,this.queue.abort()}}function Wm(n){for(const t of n.tags.keys())if(t.startsWith(Xh))return!0;return!1}const n1=50,rd={maxConnections:e1,inboundConnectionThreshold:dN,maxIncomingPendingConnections:hN};var Dy;Dy=Symbol.toStringTag;class UN{constructor(t,e={}){p(this,"started");p(this,"connections");p(this,"allow");p(this,"deny");p(this,"maxIncomingPendingConnections");p(this,"incomingPendingConnections");p(this,"outboundPendingConnections");p(this,"maxConnections");p(this,"dialQueue");p(this,"reconnectQueue");p(this,"connectionPruner");p(this,"inboundConnectionRateLimiter");p(this,"peerStore");p(this,"metrics");p(this,"events");p(this,"log");p(this,"peerId");p(this,Dy,"@libp2p/connection-manager");if(this.maxConnections=e.maxConnections??rd.maxConnections,this.maxConnections<1)throw new Z("Connection Manager maxConnections must be greater than 0");this.connections=new Zl,this.started=!1,this.peerId=t.peerId,this.peerStore=t.peerStore,this.metrics=t.metrics,this.events=t.events,this.log=t.logger.forComponent("libp2p:connection-manager"),this.onConnect=this.onConnect.bind(this),this.onDisconnect=this.onDisconnect.bind(this),this.allow=(e.allow??[]).map(r=>xh(r)),this.deny=(e.deny??[]).map(r=>xh(r)),this.incomingPendingConnections=0,this.maxIncomingPendingConnections=e.maxIncomingPendingConnections??rd.maxIncomingPendingConnections,this.outboundPendingConnections=0,this.inboundConnectionRateLimiter=new oN({points:e.inboundConnectionThreshold??rd.inboundConnectionThreshold,duration:1}),this.connectionPruner=new vN({connectionManager:this,peerStore:t.peerStore,events:t.events,logger:t.logger},{maxConnections:this.maxConnections,allow:e.allow?.map(r=>me(r))}),this.dialQueue=new kN(t,{addressSorter:e.addressSorter,maxParallelDials:e.maxParallelDials??t1,maxDialQueueLength:e.maxDialQueueLength??J_,maxPeerAddrsToDial:e.maxPeerAddrsToDial??X_,dialTimeout:e.dialTimeout??Z_,resolvers:e.resolvers??{dnsaddr:q_},connections:this.connections}),this.reconnectQueue=new $N({events:t.events,peerStore:t.peerStore,logger:t.logger,connectionManager:this},{retries:e.reconnectRetries,retryInterval:e.reconnectRetryInterval,backoffFactor:e.reconnectBackoffFactor,maxParallelReconnects:e.maxParallelReconnects})}async start(){this.metrics?.registerMetricGroup("libp2p_connection_manager_connections",{calculate:()=>{const t={inbound:0,"inbound pending":this.incomingPendingConnections,outbound:0,"outbound pending":this.outboundPendingConnections};for(const e of this.connections.values())for(const r of e)t[r.direction]++;return t}}),this.metrics?.registerMetricGroup("libp2p_protocol_streams_total",{label:"protocol",calculate:()=>{const t={};for(const e of this.connections.values())for(const r of e)for(const s of r.streams){const i=`${s.direction} ${s.protocol??"unnegotiated"}`;t[i]=(t[i]??0)+1}return t}}),this.metrics?.registerMetricGroup("libp2p_connection_manager_protocol_streams_per_connection_90th_percentile",{label:"protocol",calculate:()=>{const t={};for(const r of this.connections.values())for(const s of r){const i={};for(const o of s.streams){const a=`${o.direction} ${o.protocol??"unnegotiated"}`;i[a]=(i[a]??0)+1}for(const[o,a]of Object.entries(i))t[o]=t[o]??[],t[o].push(a)}const e={};for(let[r,s]of Object.entries(t)){s=s.sort((o,a)=>o-a);const i=Math.floor(s.length*.9);e[r]=s[i]}return e}}),this.events.addEventListener("connection:open",this.onConnect),this.events.addEventListener("connection:close",this.onDisconnect),await ub(this.dialQueue,this.reconnectQueue,this.connectionPruner),this.started=!0,this.log("started")}async stop(){this.events.removeEventListener("connection:open",this.onConnect),this.events.removeEventListener("connection:close",this.onDisconnect),await db(this.reconnectQueue,this.dialQueue,this.connectionPruner);const t=[];for(const e of this.connections.values())for(const r of e)t.push((async()=>{try{await r.close()}catch(s){this.log.error(s)}})());this.log("closing %d connections",t.length),await Promise.all(t),this.connections.clear(),this.log("stopped")}getMaxConnections(){return this.maxConnections}onConnect(t){this._onConnect(t).catch(e=>{this.log.error(e)})}async _onConnect(t){const{detail:e}=t;if(!this.started){await e.close();return}if(e.status!=="open")return;const r=e.remotePeer,s=!this.connections.has(r),i=this.connections.get(r)??[];i.push(e),this.connections.set(r,i),r.publicKey!=null&&r.type==="RSA"&&await this.peerStore.patch(r,{publicKey:r.publicKey}),s&&this.events.safeDispatchEvent("peer:connect",{detail:e.remotePeer})}onDisconnect(t){const{detail:e}=t,r=e.remotePeer,i=(this.connections.get(r)??[]).filter(o=>o.id!==e.id);this.connections.set(r,i),i.length===0&&(this.log("onDisconnect remove all connections for peer %p",r),this.connections.delete(r),this.events.safeDispatchEvent("peer:disconnect",{detail:e.remotePeer}))}getConnections(t){if(t!=null)return this.connections.get(t)??[];let e=[];for(const r of this.connections.values())e=e.concat(r);return e}getConnectionsMap(){return this.connections}async openConnection(t,e={}){if(!this.started)throw new Qo("Not started");this.outboundPendingConnections++;try{e.signal?.throwIfAborted();const{peerId:r}=j_(t);if(this.peerId.equals(r))throw new rf("Can not dial self");if(r!=null&&e.force!==!0){this.log("dial %p",r);const a=this.getConnections(r).find(l=>l.limits==null);if(a!=null)return this.log("had an existing non-limited connection to %p",r),e.onProgress?.(new vt("dial-queue:already-connected")),a}const s=await this.dialQueue.dial(t,{...e,priority:e.priority??n1});if(s.status!=="open")throw new nf("Remote closed connection during opening");let i=this.connections.get(s.remotePeer);i==null&&(i=[],this.connections.set(s.remotePeer,i));let o=!1;for(const a of i)if(a.id===s.id&&(o=!0),e.force!==!0&&a.id!==s.id&&a.remoteAddr.equals(s.remoteAddr))return s.abort(new Il("Duplicate multiaddr connection")),a;return o||i.push(s),s}finally{this.outboundPendingConnections--}}async closeConnections(t,e={}){const r=this.connections.get(t)??[];await Promise.all(r.map(async s=>{try{await s.close(e)}catch(i){s.abort(i)}}))}async acceptIncomingConnection(t){if(this.deny.some(s=>s.contains(t.remoteAddr.nodeAddress().address)))return this.log("connection from %a refused - connection remote address was in deny list",t.remoteAddr),!1;if(this.allow.some(s=>s.contains(t.remoteAddr.nodeAddress().address)))return this.incomingPendingConnections++,!0;if(this.incomingPendingConnections===this.maxIncomingPendingConnections)return this.log("connection from %a refused - incomingPendingConnections exceeded by host",t.remoteAddr),!1;if(t.remoteAddr.isThinWaistAddress()){const s=t.remoteAddr.nodeAddress().address;try{await this.inboundConnectionRateLimiter.consume(s,1)}catch{return this.log("connection from %a refused - inboundConnectionThreshold exceeded by host %s",t.remoteAddr,s),!1}}return this.getConnections().length<this.maxConnections?(this.incomingPendingConnections++,!0):(this.log("connection from %a refused - maxConnections exceeded",t.remoteAddr),!1)}afterUpgradeInbound(){this.incomingPendingConnections--}getDialQueue(){const t={queued:"queued",running:"active",errored:"error",complete:"success"};return this.dialQueue.queue.queue.map(e=>({id:e.id,status:t[e.status],peerId:e.options.peerId,multiaddrs:[...e.options.multiaddrs].map(r=>me(r))}))}async isDialable(t,e={}){return this.dialQueue.isDialable(t,e)}}class sd{constructor(t){p(this,"movingAverage");p(this,"variance");p(this,"deviation");p(this,"forecast");p(this,"timeSpan");p(this,"previousTime");this.timeSpan=t,this.movingAverage=0,this.variance=0,this.deviation=0,this.forecast=0}alpha(t,e){return 1-Math.exp(-(t-e)/this.timeSpan)}push(t,e=Date.now()){if(this.previousTime!=null){const r=this.alpha(e,this.previousTime),s=t-this.movingAverage,i=r*s;this.movingAverage=r*t+(1-r)*this.movingAverage,this.variance=(1-r)*(this.variance+s*i),this.deviation=Math.sqrt(this.variance),this.forecast=this.movingAverage+r*s}else this.movingAverage=t;this.previousTime=e}}const VN=1.2,HN=2,zN=2e3;class qN{constructor(t={}){p(this,"success");p(this,"failure");p(this,"next");p(this,"metric");p(this,"timeoutMultiplier");p(this,"failureMultiplier");p(this,"minTimeout");this.success=new sd(t.interval??5e3),this.failure=new sd(t.interval??5e3),this.next=new sd(t.interval??5e3),this.failureMultiplier=t.failureMultiplier??HN,this.timeoutMultiplier=t.timeoutMultiplier??VN,this.minTimeout=t.minTimeout??zN,t.metricName!=null&&(this.metric=t.metrics?.registerMetricGroup(t.metricName))}getTimeoutSignal(t={}){const e=Math.max(Math.round(this.next.movingAverage*(t.timeoutFactor??this.timeoutMultiplier)),this.minTimeout),r=AbortSignal.timeout(e),s=Qi([t.signal,r]);return s.start=Date.now(),s.timeout=e,s}cleanUp(t){const e=Date.now()-t.start;t.aborted?(this.failure.push(e),this.next.push(e*this.failureMultiplier),this.metric?.update({failureMovingAverage:this.failure.movingAverage,failureDeviation:this.failure.deviation,failureForecast:this.failure.forecast,failureVariance:this.failure.variance,failure:e})):(this.success.push(e),this.next.push(e),this.metric?.update({successMovingAverage:this.success.movingAverage,successDeviation:this.success.deviation,successForecast:this.success.forecast,successVariance:this.success.variance,success:e}))}}const WN=1e4,GN="1.0.0",KN="ping",YN="ipfs",Gm=32,QN=!0;var My,Ly;Ly=Symbol.toStringTag,My=Wn;class jN{constructor(t,e={}){p(this,"protocol");p(this,"components");p(this,"log");p(this,"heartbeatInterval");p(this,"pingIntervalMs");p(this,"abortController");p(this,"timeout");p(this,"abortConnectionOnPingFailure");p(this,Ly,"@libp2p/connection-monitor");p(this,My,["@libp2p/connection-monitor"]);this.components=t,this.protocol=`/${e.protocolPrefix??YN}/${KN}/${GN}`,this.log=t.logger.forComponent("libp2p:connection-monitor"),this.pingIntervalMs=e.pingInterval??WN,this.abortConnectionOnPingFailure=e.abortConnectionOnPingFailure??QN,this.timeout=new qN({...e.pingTimeout??{},metrics:t.metrics,metricName:"libp2p_connection_monitor_ping_time_milliseconds"})}start(){this.abortController=new AbortController,this.abortController.signal,this.heartbeatInterval=setInterval(()=>{this.components.connectionManager.getConnections().forEach(t=>{Promise.resolve().then(async()=>{let e=Date.now();try{const r=this.timeout.getTimeoutSignal({signal:this.abortController?.signal}),s=await t.newStream(this.protocol,{signal:r,runOnLimitedConnection:!0}),i=Ow(s);e=Date.now(),await Promise.all([i.write(Ui(Gm),{signal:r}),i.read(Gm,{signal:r})]),t.rtt=Date.now()-e,await i.unwrap().close({signal:r})}catch(r){if(r.name!=="UnsupportedProtocolError")throw r;t.rtt=(Date.now()-e)/2}}).catch(e=>{this.log.error("error during heartbeat",e),this.abortConnectionOnPingFailure?(this.log.error("aborting connection due to ping failure"),t.abort(e)):this.log("connection ping failed, but not aborting due to abortConnectionOnPingFailure flag")})})},this.pingIntervalMs)}stop(){this.abortController?.abort(),this.heartbeatInterval!=null&&clearInterval(this.heartbeatInterval)}}var By;By=Symbol.toStringTag;class ZN{constructor(t,e){p(this,"routers");p(this,"started");p(this,"components");p(this,By,"@libp2p/content-routing");this.routers=e.routers??[],this.started=!1,this.components=t,this.findProviders=t.metrics?.traceFunction("libp2p.contentRouting.findProviders",this.findProviders.bind(this),{optionsIndex:1,getAttributesFromArgs:([r],s)=>({...s,cid:r.toString()}),getAttributesFromYieldedValue:(r,s)=>({...s,providers:[...Array.isArray(s.providers)?s.providers:[],r.id.toString()]})})??this.findProviders,this.provide=t.metrics?.traceFunction("libp2p.contentRouting.provide",this.provide.bind(this),{optionsIndex:1,getAttributesFromArgs:([r],s)=>({...s,cid:r.toString()})})??this.provide,this.cancelReprovide=t.metrics?.traceFunction("libp2p.contentRouting.cancelReprovide",this.cancelReprovide.bind(this),{optionsIndex:1,getAttributesFromArgs:([r],s)=>({...s,cid:r.toString()})})??this.cancelReprovide,this.put=t.metrics?.traceFunction("libp2p.contentRouting.put",this.put.bind(this),{optionsIndex:2,getAttributesFromArgs:([r])=>({key:he(r,"base36")})})??this.put,this.get=t.metrics?.traceFunction("libp2p.contentRouting.get",this.get.bind(this),{optionsIndex:1,getAttributesFromArgs:([r])=>({key:he(r,"base36")})})??this.get}isStarted(){return this.started}async start(){this.started=!0}async stop(){this.started=!1}async*findProviders(t,e={}){if(this.routers.length===0)throw new Ju("No content routers available");const r=this,s=new xi;for await(const i of Bc(...r.routers.map(o=>o.findProviders(t,e))))i!=null&&(i.multiaddrs.length>0&&await this.components.peerStore.merge(i.id,{multiaddrs:i.multiaddrs}),!s.has(i.id)&&(s.add(i.id),yield i))}async provide(t,e={}){if(this.routers.length===0)throw new Ju("No content routers available");await Promise.all(this.routers.map(async r=>{await r.provide(t,e)}))}async cancelReprovide(t,e={}){if(this.routers.length===0)throw new Ju("No content routers available");await Promise.all(this.routers.map(async r=>{await r.cancelReprovide(t,e)}))}async put(t,e,r){if(!this.isStarted())throw new Qo;await Promise.all(this.routers.map(async s=>{await s.put(t,e,r)}))}async get(t,e){if(!this.isStarted())throw new Qo;return Promise.any(this.routers.map(async r=>r.get(t,e)))}}var Ny;Ny=Symbol.toStringTag;class XN{constructor(t,e={}){p(this,"log");p(this,"peerId");p(this,"peerStore");p(this,"routers");p(this,Ny,"@libp2p/peer-routing");this.log=t.logger.forComponent("libp2p:peer-routing"),this.peerId=t.peerId,this.peerStore=t.peerStore,this.routers=e.routers??[],this.findPeer=t.metrics?.traceFunction("libp2p.peerRouting.findPeer",this.findPeer.bind(this),{optionsIndex:1,getAttributesFromArgs:([r],s)=>({...s,peer:r.toString()})})??this.findPeer,this.getClosestPeers=t.metrics?.traceFunction("libp2p.peerRouting.getClosestPeers",this.getClosestPeers.bind(this),{optionsIndex:1,getAttributesFromArgs:([r],s)=>({...s,key:he(r,"base36")}),getAttributesFromYieldedValue:(r,s)=>({...s,peers:[...Array.isArray(s.peers)?s.peers:[],r.id.toString()]})})??this.getClosestPeers}async findPeer(t,e){if(this.routers.length===0)throw new Rm("No peer routers available");if(t.toString()===this.peerId.toString())throw new OB("Should not try to find self");const r=this,s=Bc(...this.routers.map(i=>async function*(){try{yield await i.findPeer(t,e)}catch(o){r.log.error(o)}}()));for await(const i of s)if(i!=null)return i.multiaddrs.length>0&&await this.peerStore.merge(i.id,{multiaddrs:i.multiaddrs}),i;throw new Ec}async*getClosestPeers(t,e={}){if(this.routers.length===0)throw new Rm("No peer routers available");const r=this,s=ia(1024);for await(const i of oM(async function*(){const o=Bc(...r.routers.map(a=>a.getClosestPeers(t,e)));for await(let a of o)yield async()=>{if(a.multiaddrs.length===0)try{a=await r.findPeer(a.id,{...e,useCache:!1})}catch(l){r.log.error("could not find peer multiaddrs",l);return}return a}}()))i!=null&&(i.multiaddrs.length>0&&await this.peerStore.merge(i.id,{multiaddrs:i.multiaddrs}),!s.has(i.id.toMultihash().bytes)&&(s.add(i.id.toMultihash().bytes),yield i))}}var Ry,Oy;class JN extends(Oy=ar,Ry=Symbol.toStringTag,Oy){constructor(e){super();p(this,"peerRouting");p(this,"log");p(this,"walking");p(this,"walkers");p(this,"shutdownController");p(this,"walkController");p(this,"needNext");p(this,Ry,"@libp2p/random-walk");this.log=e.logger.forComponent("libp2p:random-walk"),this.peerRouting=e.peerRouting,this.walkers=0,this.walking=!1,this.shutdownController=new AbortController,this.shutdownController.signal}start(){this.shutdownController=new AbortController,this.shutdownController.signal}stop(){this.shutdownController.abort()}async*walk(e){this.walking||this.startWalk(),this.walkers++;const r=Qi([this.shutdownController.signal,e?.signal]);try{for(;;)this.needNext?.resolve(),this.needNext=bt(),yield(await rc(this,"walk:peer",r,{errorEvent:"walk:error"})).detail}finally{r.clear(),this.walkers--,this.walkers===0&&(this.walkController?.abort(),this.walkController=void 0)}}startWalk(){this.walking=!0,this.walkController=new AbortController,this.walkController.signal;const e=Qi([this.walkController.signal,this.shutdownController.signal]),r=Date.now();let s=0;Promise.resolve().then(async()=>{for(this.log("start walk");this.walkers>0;)try{const i=Ui(32);let o=Date.now();for await(const a of this.peerRouting.getClosestPeers(i,{signal:e}))e.aborted&&this.log("aborting walk"),e.throwIfAborted(),this.log("found peer %p after %dms for %d walkers",a.id,Date.now()-o,this.walkers),s++,this.safeDispatchEvent("walk:peer",{detail:a}),this.walkers===1&&this.needNext!=null&&(this.log("wait for need next"),await Ir(this.needNext.promise,e)),o=Date.now();this.log("walk iteration for %b and %d walkers finished, found %d peers",i,this.walkers,s)}catch(i){this.log.error("random walk errored",i),this.safeDispatchEvent("walk:error",{detail:i})}this.log("no walkers left, ended walk")}).catch(i=>{this.log.error("random walk errored",i)}).finally(()=>{this.log("finished walk, found %d peers after %dms",s,Date.now()-r),this.walking=!1})}}const r1=32,s1=64;var Fy;Fy=Symbol.toStringTag;class e3{constructor(t){p(this,"log");p(this,"topologies");p(this,"handlers");p(this,"components");p(this,Fy,"@libp2p/registrar");this.log=t.logger.forComponent("libp2p:registrar"),this.topologies=new Map,this.handlers=new Map,this.components=t,this._onDisconnect=this._onDisconnect.bind(this),this._onPeerUpdate=this._onPeerUpdate.bind(this),this._onPeerIdentify=this._onPeerIdentify.bind(this),this.components.events.addEventListener("peer:disconnect",this._onDisconnect),this.components.events.addEventListener("peer:update",this._onPeerUpdate),this.components.events.addEventListener("peer:identify",this._onPeerIdentify)}getProtocols(){return Array.from(new Set([...this.handlers.keys()])).sort()}getHandler(t){const e=this.handlers.get(t);if(e==null)throw new FB(`No handler registered for protocol ${t}`);return e}getTopologies(t){const e=this.topologies.get(t);return e==null?[]:[...e.values()]}async handle(t,e,r){if(this.handlers.has(t)&&r?.force!==!0)throw new $B(`Handler already registered for protocol ${t}`);const s=Qf.bind({ignoreUndefined:!0})({maxInboundStreams:r1,maxOutboundStreams:s1},r);this.handlers.set(t,{handler:e,options:s}),await this.components.peerStore.merge(this.components.peerId,{protocols:[t]})}async unhandle(t){(Array.isArray(t)?t:[t]).forEach(r=>{this.handlers.delete(r)}),await this.components.peerStore.patch(this.components.peerId,{protocols:this.getProtocols()})}async register(t,e){if(e==null)throw new Z("invalid topology");const r=`${(Math.random()*1e9).toString(36)}${Date.now()}`;let s=this.topologies.get(t);return s==null&&(s=new Map,this.topologies.set(t,s)),s.set(r,e),r}unregister(t){for(const[e,r]of this.topologies.entries())r.has(t)&&(r.delete(t),r.size===0&&this.topologies.delete(e))}_onDisconnect(t){const e=t.detail;this.components.peerStore.get(e).then(r=>{for(const s of r.protocols){const i=this.topologies.get(s);if(i!=null)for(const o of i.values())o.filter?.has(e)!==!1&&(o.filter?.remove(e),o.onDisconnect?.(e))}}).catch(r=>{r.name!=="NotFoundError"&&this.log.error("could not inform topologies of disconnecting peer %p",e,r)})}_onPeerUpdate(t){const{peer:e,previous:r}=t.detail,s=(r?.protocols??[]).filter(i=>!e.protocols.includes(i));for(const i of s){const o=this.topologies.get(i);if(o!=null)for(const a of o.values())a.filter?.has(e.id)!==!1&&(a.filter?.remove(e.id),a.onDisconnect?.(e.id))}}_onPeerIdentify(t){const e=t.detail.protocols,r=t.detail.connection,s=t.detail.peerId;for(const i of e){const o=this.topologies.get(i);if(o!=null)for(const a of o.values())r.limits!=null&&a.notifyOnLimitedConnection!==!0||a.filter?.has(s)!==!0&&(a.filter?.add(s),a.onConnect?.(s,r))}}}class t3 extends Map{constructor(e){super();p(this,"metric");const{name:r,metrics:s}=e;this.metric=s.registerMetric(r),this.updateComponentMetric()}set(e,r){return super.set(e,r),this.updateComponentMetric(),this}delete(e){const r=super.delete(e);return this.updateComponentMetric(),r}clear(){super.clear(),this.updateComponentMetric()}updateComponentMetric(){this.metric.update(this.size)}}function n3(n){const{name:t,metrics:e}=n;let r;return e!=null?r=new t3({name:t,metrics:e}):r=new Map,r}var $y;$y=Symbol.toStringTag;class r3{constructor(t,e={}){p(this,"log");p(this,"components");p(this,"transports");p(this,"listeners");p(this,"faultTolerance");p(this,"started");p(this,$y,"@libp2p/transport-manager");this.log=t.logger.forComponent("libp2p:transports"),this.components=t,this.started=!1,this.transports=new Map,this.listeners=n3({name:"libp2p_transport_manager_listeners",metrics:this.components.metrics}),this.faultTolerance=e.faultTolerance??Yo.FATAL_ALL}add(t){const e=t[Symbol.toStringTag];if(e==null)throw new Z("Transport must have a valid tag");if(this.transports.has(e))throw new Z(`There is already a transport with the tag ${e}`);this.log("adding transport %s",e),this.transports.set(e,t),this.listeners.has(e)||this.listeners.set(e,[])}isStarted(){return this.started}start(){this.started=!0}async afterStart(){const t=this.components.addressManager.getListenAddrs();await this.listen(t)}async stop(){const t=[];for(const[e,r]of this.listeners)for(this.log("closing listeners for %s",e);r.length>0;){const s=r.pop();s!=null&&t.push(s.close())}await Promise.all(t),this.log("all listeners closed");for(const e of this.listeners.keys())this.listeners.set(e,[]);this.started=!1}async dial(t,e){const r=this.dialTransportForMultiaddr(t);if(r==null)throw new WB(`No transport available for address ${String(t)}`);return e?.onProgress?.(new vt("transport-manager:selected-transport",r[Symbol.toStringTag])),r.dial(t,{...e,upgrader:this.components.upgrader})}getAddrs(){let t=[];for(const e of this.listeners.values())for(const r of e)t=[...t,...r.getAddrs()];return t}getTransports(){return Array.of(...this.transports.values())}getListeners(){return Array.of(...this.listeners.values()).flat()}dialTransportForMultiaddr(t){for(const e of this.transports.values())if(e.dialFilter([t]).length>0)return e}listenTransportForMultiaddr(t){for(const e of this.transports.values())if(e.listenFilter([t]).length>0)return e}async listen(t){if(!this.isStarted())throw new Qo("Not started");if(t==null||t.length===0){this.log("no addresses were provided for listening, this node is dial only");return}const e={errors:new Map,ipv4:{success:0,attempts:0},ipv6:{success:0,attempts:0}};t.forEach(i=>{e.errors.set(i.toString(),new UB)});const r=[];for(const[i,o]of this.transports.entries()){const a=o.listenFilter(t);for(const l of a){this.log("creating listener for %s on %a",i,l);const u=o.createListener({upgrader:this.components.upgrader});let h=this.listeners.get(i)??[];h==null&&(h=[],this.listeners.set(i,h)),h.push(u),u.addEventListener("listening",()=>{this.components.events.safeDispatchEvent("transport:listening",{detail:u})}),u.addEventListener("close",()=>{const c=h.findIndex(d=>d===u);h.splice(c,1),this.components.events.safeDispatchEvent("transport:close",{detail:u})}),Pg.matches(l)?e.ipv4.attempts++:Dg.matches(l)&&e.ipv6.attempts++,r.push(u.listen(l).then(()=>{e.errors.delete(l.toString()),Pg.matches(l)&&e.ipv4.success++,Dg.matches(l)&&e.ipv6.success++},c=>{throw this.log.error("transport %s could not listen on address %a - %e",i,l,c),e.errors.set(l.toString(),c),c}))}}const s=await Promise.allSettled(r);if(!(s.length>0&&s.every(i=>i.status==="fulfilled"))){if(this.ipv6Unsupported(e)){this.log("all IPv4 addresses succeed but all IPv6 failed");return}if(this.faultTolerance===Yo.NO_FATAL){this.log("failed to listen on any address but fault tolerance allows this");return}throw new VB(`Some configured addresses failed to be listened on, you may need to remove one or more listen addresses from your configuration or set \`transportManager.faultTolerance\` to NO_FATAL:
${[...e.errors.entries()].map(([i,o])=>`
  ${i}: ${`${o.stack??o}`.split(`
`).join(`
  `)}
`).join("")}`)}}ipv6Unsupported(t){if(t.ipv4.attempts===0||t.ipv6.attempts===0)return!1;const e=t.ipv4.attempts===t.ipv4.success,r=t.ipv6.success===0;return e&&r}async remove(t){const e=this.listeners.get(t)??[];this.log.trace("removing transport %s",t);const r=[];for(this.log.trace("closing listeners for %s",t);e.length>0;){const s=e.pop();s!=null&&r.push(s.close())}await Promise.all(r),this.transports.delete(t),this.listeners.delete(t)}async removeAll(){const t=[];for(const e of this.transports.keys())t.push(this.remove(e));await Promise.all(t)}}const nn="/multistream/1.0.0",ip=1024,s3=te(`
`);async function Mo(n,t,e){await n.write(t,e)}async function i3(n,t,e){await n.writeV(t,e)}async function o3(n,t){const e=await n.read(t);if(e.byteLength===0||e.get(e.byteLength-1)!==s3[0])throw t.log.error("Invalid mss message - missing newline",e),new Xn("Missing newline");return e.sublist(0,-1)}async function Ii(n,t){const e=await o3(n,t);return he(e.subarray())}async function id(n,t,e){if(t=Array.isArray(t)?[...t]:[t],t.length===1&&e.negotiateFully===!1)return a3(n,t[0],e);const r=Wl(n,{...e,maxDataLength:ip}),s=t.shift();if(s==null)throw new Error("At least one protocol must be specified");e.log.trace('select: write ["%s", "%s"]',nn,s);const i=te(`${nn}
`),o=te(`${s}
`);await i3(r,[i,o],e),e.log.trace("select: reading multistream-select header");let a=await Ii(r,e);if(e.log.trace('select: read "%s"',a),a===nn&&(e.log.trace("select: reading protocol response"),a=await Ii(r,e),e.log.trace('select: read "%s"',a)),a===s)return{stream:r.unwrap(),protocol:s};for(const l of t){e.log.trace('select: write "%s"',l),await Mo(r,te(`${l}
`),e),e.log.trace("select: reading protocol response");const u=await Ii(r,e);if(e.log.trace('select: read "%s" for "%s"',u,l),u===l)return{stream:r.unwrap(),protocol:l}}throw new kl("protocol selection failed")}function a3(n,t,e){const r=n.sink.bind(n),s=n.source;let i=!1,o=!1;const a=bt();let l=!1,u=!1;const h=bt();let c=!1,d=!1;const f=bt(),g=Wl({sink:r,source:s},{...e,maxDataLength:ip});n.sink=async _=>{const{sink:w}=g.unwrap();await w(async function*(){let S=!1;for await(const A of _){if(u&&await h.promise,l)yield A;else{u=!0,e.log.trace('optimistic: write ["%s", "%s", data(%d)] in sink',nn,t,A.byteLength);const E=`${t}
`;yield new Ge(Uint8Array.from([19]),te(`${nn}
`),Vn(E.length),te(E),A).subarray(),e.log.trace('optimistic: wrote ["%s", "%s", data(%d)] in sink',nn,t,A.byteLength),l=!0,u=!1,h.resolve(),y().catch(I=>{e.log.error("could not finish optimistic protocol negotiation of %s",t,I)})}S=!0}S||await y()}())};async function y(){if(o){e.log.trace("optimistic: already negotiating %s stream",t),await a.promise;return}o=!0;try{l||(e.log.trace("optimistic: doing send protocol for %s stream",t),await m()),c||(e.log.trace("optimistic: doing read protocol for %s stream",t),await v())}finally{o=!1,i=!0,a.resolve()}}async function m(){if(u){await h.promise;return}u=!0;try{e.log.trace('optimistic: write ["%s", "%s", data] in source',nn,t),await g.writeV([te(`${nn}
`),te(`${t}
`)]),e.log.trace('optimistic: wrote ["%s", "%s", data] in source',nn,t)}finally{l=!0,u=!1,h.resolve()}}async function v(){if(d){await f.promise;return}d=!0;try{e.log.trace("optimistic: reading multistream select header");let _=await Ii(g,e);if(e.log.trace('optimistic: read multistream select header "%s"',_),_===nn&&(_=await Ii(g,e)),e.log.trace('optimistic: read protocol "%s", expecting "%s"',_,t),_!==t)throw new kl("protocol selection failed")}finally{c=!0,d=!1,f.resolve()}}if(n.source=async function*(){await y(),e.log.trace('optimistic: reading data from "%s" stream',t),yield*g.unwrap().source}(),n.closeRead!=null){const _=n.closeRead.bind(n);n.closeRead=async w=>{i||await y().catch(S=>{e.log.error("could not negotiate protocol before close read",S)}),await _(w)}}if(n.closeWrite!=null){const _=n.closeWrite.bind(n);n.closeWrite=async w=>{i||await y().catch(S=>{e.log.error("could not negotiate protocol before close write",S)}),await _(w)}}if(n.close!=null){const _=n.close.bind(n);n.close=async w=>{const S=[];u&&S.push(h.promise),d&&S.push(f.promise),S.length>0?await Ir(Promise.all(S),w?.signal):(i=!0,o=!1,a.resolve()),await _(w)}}return{stream:n,protocol:t}}const i1=1024*1024*4;class c3 extends Error{constructor(){super(...arguments);p(this,"name","InvalidDataLengthError");p(this,"code","ERR_MSG_DATA_TOO_LONG")}}function l3(n){return n[Symbol.asyncIterator]!=null}function o1(n,t){if(n.byteLength>t)throw new c3("Message length too long")}const tu=n=>{const t=ln(n),e=cr(t);return Vn(n,e),tu.bytes=t,e};tu.bytes=0;function a1(n,t){t=t??{};const e=t.lengthEncoder??tu,r=t?.maxDataLength??i1;function*s(i){o1(i,r);const o=e(i.byteLength);o instanceof Uint8Array?yield o:yield*o,i instanceof Uint8Array?yield i:yield*i}return l3(n)?async function*(){for await(const i of n)yield*s(i)}():function*(){for(const i of n)yield*s(i)}()}a1.single=(n,t)=>{t=t??{};const e=t.lengthEncoder??tu,r=t?.maxDataLength??i1;return o1(n,r),new Ge(e(n.byteLength),n)};var Km;(function(n){n[n.LENGTH=0]="LENGTH",n[n.DATA=1]="DATA"})(Km||(Km={}));async function od(n,t,e){t=Array.isArray(t)?t:[t],e.log.trace("handle: available protocols %s",t);const r=Wl(n,{...e,maxDataLength:ip,maxLengthLength:2});for(;;){e.log.trace("handle: reading incoming string");const s=await Ii(r,e);if(e.log.trace('handle: read "%s"',s),s===nn){e.log.trace('handle: respond with "%s" for "%s"',nn,s),await Mo(r,te(`${nn}
`),e),e.log.trace('handle: responded with "%s" for "%s"',nn,s);continue}if(t.includes(s))return e.log.trace('handle: respond with "%s" for "%s"',s,s),await Mo(r,te(`${s}
`),e),e.log.trace('handle: responded with "%s" for "%s"',s,s),{stream:r.unwrap(),protocol:s};if(s==="ls"){const i=new Ge(...t.map(o=>a1.single(te(`${o}
`))),te(`
`));e.log.trace('handle: respond with "%s" for %s',t,s),await Mo(r,i,e),e.log.trace('handle: responded with "%s" for %s',t,s);continue}e.log.trace('handle: respond with "na" for "%s"',s),await Mo(r,te(`na
`),e),e.log('handle: responded with "na" for "%s"',s)}}const u3=500;var Uy,Vy;Vy=Symbol.toStringTag,Uy=gA;class d3{constructor(t){p(this,"id");p(this,"remoteAddr");p(this,"remotePeer");p(this,"direction");p(this,"timeline");p(this,"multiplexer");p(this,"encryption");p(this,"status");p(this,"limits");p(this,"log");p(this,"tags");p(this,"_newStream");p(this,"_close");p(this,"_abort");p(this,"_getStreams");p(this,Vy,"Connection");p(this,Uy,!0);const{remoteAddr:e,remotePeer:r,newStream:s,close:i,abort:o,getStreams:a}=t;this.id=`${parseInt(String(Math.random()*1e9)).toString(36)}${Date.now()}`,this.remoteAddr=e,this.remotePeer=r,this.direction=t.direction,this.status="open",this.timeline=t.timeline,this.multiplexer=t.multiplexer,this.encryption=t.encryption,this.limits=t.limits,this.log=t.logger.forComponent(`libp2p:connection:${this.direction}:${this.id}`),this.remoteAddr.getPeerId()==null&&(this.remoteAddr=this.remoteAddr.encapsulate(`/p2p/${this.remotePeer}`)),this._newStream=s,this._close=i,this._abort=o,this._getStreams=a,this.tags=[]}get streams(){return this._getStreams()}async newStream(t,e){if(this.status==="closing")throw new rb("the connection is being closed");if(this.status==="closed")throw new nf("the connection is closed");if(Array.isArray(t)||(t=[t]),this.limits!=null&&e?.runOnLimitedConnection!==!0)throw new sf("Cannot open protocol stream on limited connection");const r=await this._newStream(t,e);return r.direction="outbound",r}async close(t={}){if(!(this.status==="closed"||this.status==="closing")){if(this.log("closing connection to %a",this.remoteAddr),this.status="closing",t.signal==null){const e=AbortSignal.timeout(u3);t={...t,signal:e}}try{this.log.trace("closing underlying transport"),await this._close(t),this.log.trace("updating timeline with close time"),this.status="closed",this.timeline.close=Date.now()}catch(e){this.log.error("error encountered during graceful close of connection to %a",this.remoteAddr,e),this.abort(e)}}}abort(t){this.status!=="closed"&&(this.log.error("aborting connection to %a due to error",this.remoteAddr,t),this.status="closing",this._abort(t),this.status="closed",this.timeline.close=Date.now())}}function h3(n){return new d3(n)}function f3(n,t){try{const{options:e}=t.getHandler(n);return e.maxInboundStreams}catch(e){if(e.name!=="UnhandledProtocolError")throw e}return r1}function p3(n,t,e={}){try{const{options:r}=t.getHandler(n);if(r.maxOutboundStreams!=null)return r.maxOutboundStreams}catch(r){if(r.name!=="UnhandledProtocolError")throw r}return e.maxOutboundStreams??s1}function Ym(n,t,e){let r=0;return e.streams.forEach(s=>{s.direction===t&&s.protocol===n&&r++}),r}var Hy;Hy=Symbol.toStringTag;class g3{constructor(t,e){p(this,"components");p(this,"connectionEncrypters");p(this,"streamMuxers");p(this,"inboundUpgradeTimeout");p(this,"inboundStreamProtocolNegotiationTimeout");p(this,"outboundStreamProtocolNegotiationTimeout");p(this,"events");p(this,"metrics");p(this,Hy,"@libp2p/upgrader");this.components=t,this.connectionEncrypters=new Map,e.connectionEncrypters.forEach(r=>{this.connectionEncrypters.set(r.protocol,r)}),this.streamMuxers=new Map,e.streamMuxers.forEach(r=>{this.streamMuxers.set(r.protocol,r)}),this.inboundUpgradeTimeout=e.inboundUpgradeTimeout??uN,this.inboundStreamProtocolNegotiationTimeout=e.inboundStreamProtocolNegotiationTimeout??$m,this.outboundStreamProtocolNegotiationTimeout=e.outboundStreamProtocolNegotiationTimeout??$m,this.events=t.events,this.metrics={dials:t.metrics?.registerCounterGroup("libp2p_connection_manager_dials_total"),errors:t.metrics?.registerCounterGroup("libp2p_connection_manager_dial_errors_total")}}async shouldBlockConnection(t,...e){const r=this.components.connectionGater[t];if(r==null)return;if(await r.apply(this.components.connectionGater,e)===!0)throw new zB(`The multiaddr connection is blocked by gater.${t}`)}createInboundAbortSignal(t){return Qi([AbortSignal.timeout(this.inboundUpgradeTimeout),t])}async upgradeInbound(t,e){let r=!1;const s=this.createInboundAbortSignal(e.signal);try{if(this.metrics.dials?.increment({inbound:!0}),r=await this.components.connectionManager.acceptIncomingConnection(t),!r)throw new qB("Connection denied");await this.shouldBlockConnection("denyInboundConnection",t),await this._performUpgrade(t,"inbound",{...e,signal:s})}catch(i){throw this.metrics.errors?.increment({inbound:!0}),i}finally{s.clear(),r&&this.components.connectionManager.afterUpgradeInbound()}}async upgradeOutbound(t,e){try{this.metrics.dials?.increment({outbound:!0});const r=t.remoteAddr.getPeerId();let s;r!=null&&(s=Bt(r),await this.shouldBlockConnection("denyOutboundConnection",s,t));let i="outbound";return e.initiator===!1&&(i="inbound"),await this._performUpgrade(t,i,e)}catch(r){throw this.metrics.errors?.increment({outbound:!0}),r}}async _performUpgrade(t,e,r){let s,i,o,a,l;this.components.metrics?.trackMultiaddrConnection(t),t.log.trace("starting the %s connection upgrade",e);let u=t;if(r?.skipProtection!==!0){const h=this.components.connectionProtector;h!=null&&(t.log("protecting the %s connection",e),u=await h.protect(t,r))}try{if(s=u,r?.skipEncryption!==!0){r?.onProgress?.(new vt(`upgrader:encrypt-${e}-connection`)),{conn:s,remotePeer:i,protocol:l,streamMuxer:a}=await(e==="inbound"?this._encryptInbound(u,r):this._encryptOutbound(u,r));const h={...u,...s};await this.shouldBlockConnection(e==="inbound"?"denyInboundEncryptedConnection":"denyOutboundEncryptedConnection",i,h)}else{const h=t.remoteAddr.getPeerId();if(h==null)throw new Il(`${e} connection that skipped encryption must have a peer id`);const c=Bt(h);l="native",i=c}if(i.equals(this.components.peerId)){const h=new rf("Can not dial self");throw t.abort(h),h}if(o=s,r?.muxerFactory!=null)a=r.muxerFactory;else if(a==null&&this.streamMuxers.size>0){r?.onProgress?.(new vt(`upgrader:multiplex-${e}-connection`));const h=await(e==="inbound"?this._multiplexInbound({...u,...s},this.streamMuxers,r):this._multiplexOutbound({...u,...s},this.streamMuxers,r));a=h.muxerFactory,o=h.stream}}catch(h){throw t.log.error("failed to upgrade inbound connection %s %a - %e",e==="inbound"?"from":"to",t.remoteAddr,h),h}return await this.shouldBlockConnection(e==="inbound"?"denyInboundUpgradedConnection":"denyOutboundUpgradedConnection",i,t),t.log("successfully upgraded %s connection",e),this._createConnection({cryptoProtocol:l,direction:e,maConn:t,upgradedConn:o,muxerFactory:a,remotePeer:i,limits:r?.limits})}_createConnection(t){const{cryptoProtocol:e,direction:r,maConn:s,upgradedConn:i,remotePeer:o,muxerFactory:a,limits:l}=t;let u,h,c;a!=null&&(u=a.createStreamMuxer({direction:r,onIncomingStream:g=>{c!=null&&Promise.resolve().then(async()=>{const y=this.components.registrar.getProtocols(),m=AbortSignal.timeout(this.inboundStreamProtocolNegotiationTimeout),{stream:v,protocol:_}=await od(g,y,{signal:m,log:g.log,yieldBytes:!1});if(c==null)return;c.log("incoming stream opened on %s",_);const w=f3(_,this.components.registrar);if(Ym(_,"inbound",c)===w){const A=new lb(`Too many inbound protocol streams for protocol "${_}" - limit ${w}`);throw g.abort(A),A}g.source=v.source,g.sink=v.sink,g.protocol=_,v.closeWrite!=null&&(g.closeWrite=v.closeWrite),v.closeRead!=null&&(g.closeRead=v.closeRead),v.close!=null&&(g.close=v.close),await this.components.peerStore.merge(o,{protocols:[_]}),this.components.metrics?.trackProtocolStream(g,c),this._onStream({connection:c,stream:g,protocol:_})}).catch(async y=>{c.log.error("error handling incoming stream id %s - %e",g.id,y),g.timeline.close==null&&await g.close()})}}),h=async(g,y={})=>{if(u==null)throw new Ya("Connection is not multiplexed");c.log.trace("starting new stream for protocols %s",g);const m=await u.newStream();c.log.trace("started new stream %s for protocols %s",m.id,g);try{if(y.signal==null){m.log("no abort signal was passed while trying to negotiate protocols %s falling back to default timeout",g);const A=AbortSignal.timeout(this.outboundStreamProtocolNegotiationTimeout);y={...y,signal:A}}m.log.trace("selecting protocol from protocols %s",g);const{stream:v,protocol:_}=await id(m,g,{...y,log:m.log,yieldBytes:!0});m.log.trace("selected protocol %s",_);const w=p3(_,this.components.registrar,y),S=Ym(_,"outbound",c);if(S>=w){const A=new of(`Too many outbound protocol streams for protocol "${_}" - ${S}/${w}`);throw m.abort(A),A}return await this.components.peerStore.merge(o,{protocols:[_]}),m.source=v.source,m.sink=v.sink,m.protocol=_,v.closeWrite!=null&&(m.closeWrite=v.closeWrite),v.closeRead!=null&&(m.closeRead=v.closeRead),v.close!=null&&(m.close=v.close),this.components.metrics?.trackProtocolStream(m,c),m}catch(v){throw c.log.error("could not create new outbound stream on connection %s %a for protocols %s - %e",r==="inbound"?"from":"to",t.maConn.remoteAddr,g,v),m.timeline.close==null&&m.abort(v),v}},Promise.all([u.sink(i.source),i.sink(u.source)]).catch(g=>{c.log.error("error piping data through muxer - %e",g)}));const d=s.timeline;s.timeline=new Proxy(d,{set:(...g)=>(g[1]==="close"&&g[2]!=null&&d.close==null&&(async()=>{try{c.status==="open"&&await c.close()}catch(y){c.log.error("error closing connection after timeline close %e",y)}finally{this.events.safeDispatchEvent("connection:close",{detail:c})}})().catch(y=>{c.log.error("error thrown while dispatching connection:close event %e",y)}),Reflect.set(...g))}),s.timeline.upgraded=Date.now();const f=()=>{throw new Ya("Connection is not multiplexed")};return c=h3({remoteAddr:s.remoteAddr,remotePeer:o,status:"open",direction:r,timeline:s.timeline,multiplexer:u?.protocol,encryption:e,limits:l,logger:this.components.logger,newStream:h??f,getStreams:()=>u?.streams??[],close:async g=>{await u?.close(g),await s.close(g)},abort:g=>{s.abort(g),u?.abort(g)}}),this.events.safeDispatchEvent("connection:open",{detail:c}),c.__maConnTimeline=d,c}_onStream(t){const{connection:e,stream:r,protocol:s}=t,{handler:i,options:o}=this.components.registrar.getHandler(s);if(e.limits!=null&&o.runOnLimitedConnection!==!0)throw new sf("Cannot open protocol stream on limited connection");i({connection:e,stream:r})}async _encryptInbound(t,e){const r=Array.from(this.connectionEncrypters.keys());try{const{stream:s,protocol:i}=await od(t,r,{...e,log:t.log}),o=this.connectionEncrypters.get(i);if(o==null)throw new Qa(`no crypto module found for ${i}`);return t.log("encrypting inbound connection to %a using %s",t.remoteAddr,i),{...await o.secureInbound(s,e),protocol:i}}catch(s){throw t.log.error("encrypting inbound connection from %a failed",t.remoteAddr,s),new Qa(s.message)}}async _encryptOutbound(t,e){const r=Array.from(this.connectionEncrypters.keys());try{t.log.trace("selecting encrypter from %s",r);const{stream:s,protocol:i}=await id(t,r,{...e,log:t.log,yieldBytes:!0}),o=this.connectionEncrypters.get(i);if(o==null)throw new Qa(`no crypto module found for ${i}`);return t.log("encrypting outbound connection to %a using %s",t.remoteAddr,i),{...await o.secureOutbound(s,e),protocol:i}}catch(s){throw t.log.error("encrypting outbound connection to %a failed",t.remoteAddr,s),new Qa(s.message)}}async _multiplexOutbound(t,e,r){const s=Array.from(e.keys());t.log("outbound selecting muxer %s",s);try{t.log.trace("selecting stream muxer from %s",s);const{stream:i,protocol:o}=await id(t,s,{...r,log:t.log,yieldBytes:!0});t.log("selected %s as muxer protocol",o);const a=e.get(o);return{stream:i,muxerFactory:a}}catch(i){throw t.log.error("error multiplexing outbound connection",i),new Ya(String(i))}}async _multiplexInbound(t,e,r){const s=Array.from(e.keys());t.log("inbound handling muxers %s",s);try{const{stream:i,protocol:o}=await od(t,s,{...r,log:t.log}),a=e.get(o);return{stream:i,muxerFactory:a}}catch(i){throw t.log.error("error multiplexing inbound connection",i),new Ya(String(i))}}getConnectionEncrypters(){return this.connectionEncrypters}getStreamMuxers(){return this.streamMuxers}}const c1="2.8.0",l1="js-libp2p";function m3(n,t){return`${n??l1}/${t??c1} browser/${globalThis.navigator.userAgent}`}var ma,Ih;class y3 extends ar{constructor(e){super();_e(this,ma);p(this,"peerId");p(this,"peerStore");p(this,"contentRouting");p(this,"peerRouting");p(this,"metrics");p(this,"services");p(this,"logger");p(this,"status");p(this,"components");p(this,"log");this.status="stopped";const r=new ar,s=r.dispatchEvent.bind(r);r.dispatchEvent=h=>{const c=s(h),d=this.dispatchEvent(new CustomEvent(h.type,{detail:h.detail}));return c||d},this.peerId=e.peerId,this.logger=e.logger??rp(),this.log=this.logger.forComponent("libp2p"),this.services={};const i=e.nodeInfo?.name??l1,o=e.nodeInfo?.version??c1,a=this.components=QB({peerId:e.peerId,privateKey:e.privateKey,nodeInfo:{name:i,version:o,userAgent:e.nodeInfo?.userAgent??m3(i,o)},logger:this.logger,events:r,datastore:e.datastore??new aL,connectionGater:nN(e.connectionGater),dns:e.dns});this.peerStore=this.configureComponent("peerStore",lB(a,{addressFilter:this.components.connectionGater.filterMultiaddrForPeer,...e.peerStore})),e.metrics!=null&&(this.metrics=this.configureComponent("metrics",e.metrics(this.components))),a.events.addEventListener("peer:update",h=>{if(h.detail.previous==null){const c={id:h.detail.peer.id,multiaddrs:h.detail.peer.addresses.map(d=>d.multiaddr)};a.events.safeDispatchEvent("peer:discovery",{detail:c})}}),e.connectionProtector!=null&&this.configureComponent("connectionProtector",e.connectionProtector(a)),this.components.upgrader=new g3(this.components,{connectionEncrypters:(e.connectionEncrypters??[]).map((h,c)=>this.configureComponent(`connection-encryption-${c}`,h(this.components))),streamMuxers:(e.streamMuxers??[]).map((h,c)=>this.configureComponent(`stream-muxers-${c}`,h(this.components))),inboundUpgradeTimeout:e.connectionManager?.inboundUpgradeTimeout,inboundStreamProtocolNegotiationTimeout:e.connectionManager?.inboundStreamProtocolNegotiationTimeout??e.connectionManager?.protocolNegotiationTimeout,outboundStreamProtocolNegotiationTimeout:e.connectionManager?.outboundStreamProtocolNegotiationTimeout??e.connectionManager?.protocolNegotiationTimeout}),this.configureComponent("transportManager",new r3(this.components,e.transportManager)),this.configureComponent("connectionManager",new UN(this.components,e.connectionManager)),e.connectionMonitor?.enabled!==!1&&this.configureComponent("connectionMonitor",new jN(this.components,e.connectionMonitor)),this.configureComponent("registrar",new e3(this.components)),this.configureComponent("addressManager",new BB(this.components,e.addresses));const l=(e.peerRouters??[]).map((h,c)=>this.configureComponent(`peer-router-${c}`,h(this.components)));this.peerRouting=this.components.peerRouting=this.configureComponent("peerRouting",new XN(this.components,{routers:l}));const u=(e.contentRouters??[]).map((h,c)=>this.configureComponent(`content-router-${c}`,h(this.components)));if(this.contentRouting=this.components.contentRouting=this.configureComponent("contentRouting",new ZN(this.components,{routers:u})),this.configureComponent("randomWalk",new JN(this.components)),(e.peerDiscovery??[]).forEach((h,c)=>{this.configureComponent(`peer-discovery-${c}`,h(this.components)).addEventListener("peer",f=>{de(this,ma,Ih).call(this,f)})}),e.transports?.forEach((h,c)=>{this.components.transportManager.add(this.configureComponent(`transport-${c}`,h(this.components)))}),e.services!=null)for(const h of Object.keys(e.services)){const c=e.services[h],d=c(this.components);if(d==null){this.log.error("service factory %s returned null or undefined instance",h);continue}this.services[h]=d,this.configureComponent(h,d),d[Dp]!=null&&(this.log("registering service %s for content routing",h),u.push(d[Dp])),d[Mp]!=null&&(this.log("registering service %s for peer routing",h),l.push(d[Mp])),d[_c]!=null&&(this.log("registering service %s for peer discovery",h),d[_c].addEventListener?.("peer",f=>{de(this,ma,Ih).call(this,f)}))}jB(a)}configureComponent(e,r){return r==null&&this.log.error("component %s was null or undefined",e),this.components[e]=r,r}async start(){if(this.status==="stopped"){this.status="starting",this.log("libp2p is starting");try{await this.components.beforeStart?.(),await this.components.start(),await this.components.afterStart?.(),this.status="started",this.safeDispatchEvent("start",{detail:this}),this.log("libp2p has started")}catch(e){throw this.log.error("An error occurred starting libp2p",e),this.status="started",await this.stop(),e}}}async stop(){this.status==="started"&&(this.log("libp2p is stopping"),this.status="stopping",await this.components.beforeStop?.(),await this.components.stop(),await this.components.afterStop?.(),this.status="stopped",this.safeDispatchEvent("stop",{detail:this}),this.log("libp2p has stopped"))}getConnections(e){return this.components.connectionManager.getConnections(e)}getDialQueue(){return this.components.connectionManager.getDialQueue()}getPeers(){const e=new xi;for(const r of this.components.connectionManager.getConnections())e.add(r.remotePeer);return Array.from(e)}async dial(e,r={}){return this.components.connectionManager.openConnection(e,{priority:75,...r})}async dialProtocol(e,r,s={}){if(r==null)throw new Z("no protocols were provided to open a stream");if(r=Array.isArray(r)?r:[r],r.length===0)throw new Z("no protocols were provided to open a stream");return(await this.dial(e,s)).newStream(r,s)}getMultiaddrs(){return this.components.addressManager.getAddresses()}getProtocols(){return this.components.registrar.getProtocols()}async hangUp(e,r={}){Hl(e)&&(e=Bt(e.getPeerId()??"")),await this.components.connectionManager.closeConnections(e,r)}async getPublicKey(e,r={}){if(this.log("getPublicKey %p",e),e.publicKey!=null)return e.publicKey;try{const a=await this.peerStore.get(e);if(a.id.publicKey!=null)return a.id.publicKey}catch(a){if(a.name!=="NotFoundError")throw a}const s=bn([te("/pk/"),e.toMultihash().bytes]),i=await this.contentRouting.get(s,r),o=Lr(i);return await this.peerStore.patch(e,{publicKey:o}),o}async handle(e,r,s){Array.isArray(e)||(e=[e]),await Promise.all(e.map(async i=>{await this.components.registrar.handle(i,r,s)}))}async unhandle(e){Array.isArray(e)||(e=[e]),await Promise.all(e.map(async r=>{await this.components.registrar.unhandle(r)}))}async register(e,r){return this.components.registrar.register(e,r)}unregister(e){this.components.registrar.unregister(e)}async isDialable(e,r={}){return this.components.connectionManager.isDialable(e,r)}}ma=new WeakSet,Ih=function(e){const{detail:r}=e;if(r.id.toString()===this.peerId.toString()){this.log.error("peer discovery mechanism discovered self");return}this.components.peerStore.merge(r.id,{multiaddrs:r.multiaddrs}).catch(s=>{this.log.error(s)})};async function v3(n={}){n.privateKey??(n.privateKey=await jb("Ed25519"));const t=new y3({...await HL(n),peerId:wk(n.privateKey)});return n.start!==!1&&await t.start(),t}function b3({data:n=[],maxSize:t=1/0,compare:e=(s,i)=>s<i?-1:s>i?1:0,extractKey:r=s=>s}={}){this.data=n;const s=new Map(n.map((a,l)=>[r(a),l]));this.indexes=s;const i=a=>{const l=n[a];for(;a>0;){const u=a-1>>1,h=n[u];if(e(l,h)>=0)break;s.set(r(h),a),n[a]=h,a=u}s.set(r(l),a),n[a]=l},o=a=>{const l=n.length>>1,u=n[a];for(;a<l;){let h=(a<<1)+1,c=n[h];const d=h+1;if(d<n.length&&e(n[d],c)<0&&(h=d,c=n[d]),e(c,u)>=0)break;s.set(r(c),a),n[a]=c,a=h}s.set(r(u),a),n[a]=u};if(n.length>0)for(let a=(n.length>>1)-1;a>=0;a--)o(a);this.push=a=>{let l=s.get(r(a));if(l===void 0)return n.push(a),i(n.length-1),n.length<=t?void 0:this.pop();e(n[l],a)>=0||(n[l]=a,o(l))},this.pop=()=>{if(n.length===0)return;const a=n[0],l=n.pop();return n.length>0&&(s.set(r(l),0),n[0]=l,o(0)),s.delete(r(a)),a},this.peek=()=>n[0]}function u1(n){return n.toLowerCase().replace(/[^a-z0-9@&$!?\-+=.:/_]/g,"")}async function d1(n={}){const{type:t,moves:e,playerName:r,timestamp:s,value:i}=n;if(!t||!e||!r||!s||!i)throw new Error(["RECORD VALIDATION: BAD GAME DATA!",n]);if(u1(r)!==r)throw new Error(["RECORD VALIDATION: BAD PLAYER NAME!",n]);return new Promise((o,a)=>{const l=setTimeout(()=>a(["RECORD VALIDATION: TIMEOUT!",n]),3e3),u=Ov({cards:mt($e.cards),energy:mt($e.energy),log:mt($e.log),matchedIndexes:mt($e.matchedIndexes),moves:To(e),options:To({playerName:r,cluster:!1,rapid:!0}),phase:mt($e.phase),plusIndex:mt($e.plusIndex),records:mt({...$e.records}),score:mt($e.score),seed:To(Wh(n)),timestamp:To(s)});u.records.subscribe(h=>{const{movesInitial:c,phase:d}=u;if(c!==null&&Oe(d)!==se.gameOver)return;clearTimeout(l);const f=h[t][$.value];n={type:t,moves:e,playerName:r,timestamp:s,value:i},f>=i?(n.value=f,o(n)):a(["RECORD VALIDATION: WRONG VALUE!",n,f])})})}const eo={root:"/digifall/root/1.0",preview:"/digifall/preview/1.0"},op="12D3KooWP8LPHKp89km1GrGZemAshNGmEUc8KMndHhhAVBMSSKDf",h1="/dns4/relay.digifall.app/tcp/443/wss/p2p/"+op;let Lt;const f1=new Set,w3=HE($.digifall,$.leaderboard),nu=Ys.reduce((n,t)=>(n[t]=w3(t,$e[$.leaderboard][t]),n),{});function ap(n,t){return n.value>t.value?1:n.value<t.value?-1:n.timestamp===t.timestamp?0:n.timestamp<t.timestamp?1:-1}function _3({playerName:n}){return n}const yn=Ys.reduce((n,t)=>(n[t]=new b3({maxSize:lt,compare:ap,extractKey:_3}),n),{}),Ms=Ys.reduce((n,t)=>(n[t]=0,n),{});function cp(n){return JSON.parse(he(n.subarray()))}function ru(n){return te(JSON.stringify(n))}async function p1(n){for await(const t of n){const e=cp(t),{type:r,playerName:s,value:i}=e,{data:o,indexes:a}=yn[r],l=a.get(s);l in o&&o[l].value>=i||d1(e).then(u=>{yn[r].push(u),nu[r].set(yn[r].data),console.warn("P2P LEADERBOARD UPDATED!",r,s,i)}).catch(u=>vn&&console.error(...u))}}async function S3({stream:n}){vn&&console.log("handlePreview"),Br(n.source,async function*(t){const e=new Set,r=Ys.reduce((i,o)=>(i[o]=new Set,i),{});for await(const i of t){const{type:o,playerName:a,value:l}=cp(i);o in Ms&&e.add(o);const u=yn[o].indexes.get(a);u!==void 0&&(yn[o].data[u].value>l||r[o].add(a))}const s=Array.from(e).flatMap(i=>yn[i].data.filter(o=>!r[i].has(o.playerName)).map(ru));for(const i of s)yield i},n.sink).catch(t=>vn&&console.error(t))}async function E3(n,t){vn&&console.log(eo.preview);const e=t.flatMap(r=>yn[r].data.map(({playerName:s,value:i})=>ru({type:r,playerName:s,value:i})));return n.newStream(eo.preview,{runOnLimitedConnection:!0}).then(r=>Br(e,r,p1)).catch(r=>vn&&console.error(r))}async function A3({connection:n,stream:t}){vn&&console.log("handleRoot"),Br(t.source,async function*(e){const r=new Set;for await(const s of e){const[i,o]=cp(s);if(o===0){for(const a of yn[i].data)yield ru(a);continue}i in Ms&&o!==Ms[i]&&r.add(i)}r.size===0||n.status!=="open"||E3(n,Array.from(r))},t.sink).catch(e=>vn&&console.error(e))}async function g1(n){vn&&console.log(eo.root);const t=Object.entries(Ms).map(ru);return n.newStream(eo.root,{runOnLimitedConnection:!0}).then(e=>Br(t,e,p1)).catch(e=>{vn&&console.error(e),e.name==="UnsupportedProtocolError"&&f1.add(n.remotePeer.toString()),n.close()})}async function x3({detail:n}){const t=n.remotePeer.toString();vn&&console.log("connection:open",t),t!==op&&n.status==="open"&&await g1(n)}async function I3({detail:{from:n}}){vn&&console.log("pubsub:message",n.toString(),n===Lt.peerId?"local":"remote"),Lt.dial(n).catch(()=>{})}async function k3(){return Lt.getConnections().length!==0?!1:(vn&&console.log("restoreRelay"),Lt.dial(me(h1)))}(async function(){const t=new _L("keystore");await t.open();const e=await sM(t);Lt=await v3({privateKey:e,addresses:{listen:["/p2p-circuit"]},transports:[tL(),aD({discoverRelays:1})],connectionEncrypters:[LM()],streamMuxers:[qC()],peerDiscovery:[oP({list:[h1]}),RM({interval:13e3,topics:["digifall._peer-discovery"],listenOnly:!1})],connectionGater:{denyDialPeer(r){return f1.has(r.toString())?!0:Lt.getConnections().length>=3},denyInboundConnection(){return Lt.getConnections().length>=5}},services:{identify:PM({protocolPrefix:"digifall"}),pubsub:xC({emitSelf:!0}),keychain:A_()}}),setInterval(()=>k3().catch(()=>{}),73e3),Lt.services.pubsub.addEventListener("message",I3),Lt.addEventListener("connection:open",x3),Lt.handle(eo.root,A3,{runOnLimitedConnection:!0}),Lt.handle(eo.preview,S3,{runOnLimitedConnection:!0}),vn&&(window.libp2p=Lt)})();async function T3(){Lt.getConnections().filter(({remotePeer:n,status:t})=>t==="open"&&n.toString()!==op).forEach(g1)}Ys.forEach(n=>{const t=nu[n];t.subscribe(async e=>{if(!(!e||e.length===0)){if(yn[n].data.length>0){const r=Ms[n];return Ms[n]=_d(e.slice().sort(ap).map(s=>_d([Wh(s),s.value]))),r!==Ms[n]&&Lt&&T3()}Promise.allSettled(e.map(r=>d1(r).then(s=>yn[n].push(s)))).then(()=>t.set(yn[n].data))}})});wa.subscribe(n=>{const t=Oe(Fr);t!==se.idle&&t!==se.gameOver||Ys.forEach(e=>{const r=n[e];r[$.value]!==0&&(r[$.type]=e,yn[e].push(r),nu[e].set(yn[e].data))})});Ft.subscribe(({leaderboard:n})=>{setTimeout(()=>n?Lt.start():Lt.stop(),3e3)});var C3=ce('<div class="virtual-item svelte-16kyil9"><!></div>'),P3=ce('<div class="virtual-scroll svelte-16kyil9"><div class="virtual-list"></div></div>');function m1(n,t){if(new.target)return Ut({component:m1,...n});kt(t,!1);const e=Q(),r=Q(),s=Q(),i=Q(),o=Q();let a=At(t,"items",12),l=At(t,"startIndex",12),u=At(t,"endIndex",12),h=Q(0),c=Q(0),d=Q(1),f=Q();const g=18;function y(w){M(h,w.target.scrollTop)}function m(w,S=!1){w<0||w>=a().length||b(f)&&(b(f).scrollTo({top:w*b(d),behavior:S?"smooth":"instant"}),!S&&setTimeout(()=>{b(f).scrollTo({top:w*b(d),behavior:"instant"})},60))}ae(()=>(b(h),b(d)),()=>{l(Math.floor(b(h)/b(d)))}),ae(()=>(kn(l()),b(c),b(d)),()=>{u(l()+Math.ceil(b(c)/b(d)))}),ae(()=>kn(l()),()=>{M(e,Math.max(0,l()-g))}),ae(()=>(kn(u()),kn(a())),()=>{M(r,Math.min(u()+g,a().length))}),ae(()=>(kn(a()),b(e),b(r)),()=>{M(s,a().slice(b(e),b(r)))}),ae(()=>(b(e),b(d)),()=>{M(i,b(e)*b(d))}),ae(()=>(kn(a()),b(d)),()=>{M(o,a().length*b(d))}),dr(),Vt();var v=P3(),_=G(v);return Ts(_,5,()=>b(s),Oi,(w,S)=>{var A=C3(),E=G(A);Ev(E,t,"default",{get item(){return b(S)}}),W(A),Ep(A,"clientHeight",I=>M(d,I)),oe(w,A)}),W(_),W(v),ht(v,w=>M(f,w),()=>b(f)),Ze(()=>{gn(_,"height",`${b(o)??""}px`),gn(_,"padding-top",`${b(i)??""}px`)}),Ep(v,"clientHeight",w=>M(c,w)),Be("scroll",v,y),oe(n,v),Ae(t,"scrollToIndex",m),Tt({scrollToIndex:m,get items(){return a()},set items(w){a(w),yt()},get startIndex(){return l()},set startIndex(w){l(w),yt()},get endIndex(){return u()},set endIndex(w){u(w),yt()},$set:zt,$on:(w,S)=>Ht(t,w,S)})}var D3=ce("<li> </li>"),M3=ce('<div><div class="place svelte-18hkl83"> </div> <div> </div> <div></div> <div> </div></div>'),L3=ce('<div class="leaderboard content svelte-18hkl83"><div class="section-1"><div class="types svelte-18hkl83" title="[switch leaderboard]" tabindex="0" role="button"><span>combos</span> <span class="high svelte-18hkl83">high</span> <span>scores</span></div></div> <div class="section-2"><ul class="pages svelte-18hkl83" title="[select page]" tabindex="0" role="button"></ul></div> <div class="section-3 board svelte-18hkl83" tabindex="-1"><!></div> <div class="section-4"><div class="col"><button title="[open menu]">menu</button></div></div></div>');function y1(n,t){if(new.target)return Ut({component:y1,...n});kt(t,!1);const[e,r]=wn(),s=()=>ge(Ft,"$options",e),i=()=>ge(b(o),"$leaderboardStore",e),o=Q(),a=Q(),l=Q(),u=Q(),h=Q(),c=100,d=Math.ceil(lt/c)+1;let f=Q(0),g=Q($.highScore),y=Q(),m=Q(),v=Q(null);function _(q){M(g,b(g)===$.highScore?$.highCombo:$.highScore)}function w(q){if(q)return M(f,b(f)<1?d-1:b(f)-1),b(v).scrollToIndex(Math.max(b(f)*c-1,0)),b(f);b(h)(Math.max(b(y)-8,0),!0)}function S(q){if(q)return M(f,b(f)<d-1?b(f)+1:0),b(v).scrollToIndex(Math.max(b(f)*c-1,0)),b(f);b(h)(Math.min(b(y)+8,lt-1),!0)}function A(q){const ue=q.composedPath().find(({dataset:we})=>we&&we.index);if(ue===void 0)return;M(f,Number(ue.dataset.index));const Ee=b(f)===0?0:b(f)===10?lt-1:ue.dataset.index*100-1;b(v).scrollToIndex(Ee)}function E(){xt(_t,ye.menu)}function I(q){return q>=lt-2?M(f,10):M(f,k(q))}function k(q){return q>0&&q<lt*.1?0:q>=100&&q<lt*.2?1:q>=200&&q<lt*.3?2:q>=300&&q<lt*.4?3:q>=400&&q<lt*.5?4:q>=500&&q<lt*.6?5:q>=600&&q<lt*.7?6:q>=700&&q<lt*.8?7:q>=800&&q<lt*.9?8:q>=900&&q<lt?9:0}function x(q){return q===0&&b(u)===-1?"???":Array.from({length:3-q.toString().length}).map(()=>"0").join("")+q}function U(q,ue){return ue===0&&b(u)===-1?s()[$.playerName]:q}async function B(q){await dv(),b(v).scrollToIndex(b(u)===-1?lt-1:Math.max(b(u)-7,0))}function N(q,ue){let Ee=0;return(...we)=>{const H=Date.now();if(!(H-Ee<ue))return Ee=H,q(...we)}}ae(()=>b(g),()=>{rE(M(o,nu[b(g)]),"$leaderboardStore",e)}),ae(()=>(i(),lt),()=>{M(a,i().slice().sort((q,ue)=>ap(ue,q)).slice(0,lt))}),ae(()=>(b(a),lt),()=>{M(l,[...b(a).map((q,ue)=>({place:ue===999?0:ue+1,...q})),...Array.from({length:lt-b(a).length}).map((q,ue,Ee)=>({place:ue===Ee.length-1?0:ue+b(a).length+1,playerName:"",value:0}))])}),ae(()=>(b(a),s(),$),()=>{M(u,b(a).findIndex(({playerName:q})=>q===s()[$.playerName]))}),ae(()=>b(m),()=>{I(b(m))}),ae(()=>b(a),()=>{B(b(a))}),ae(()=>b(v),()=>{M(h,b(v)?N(b(v).scrollToIndex,250):()=>{})}),dr(),Vt();var z=L3(),D=G(z),L=G(D),P=G(L);let T;var C=J(P,4);let R;W(L),W(D);var O=J(D,2),V=G(O);Ts(V,5,()=>Array.from({length:d}),Oi,(q,ue,Ee)=>{var we=D3();const H=Nt(()=>Ee>9?0:Ee);let ne;Ot(we,"data-index",Ee);var De=G(we,!0);W(we),Ze(()=>{ne=nt(we,1,"page svelte-18hkl83",null,ne,{active:Ee===b(f)}),gn(we,"--color",`var(--color-${b(H)??""})`),st(De,b(H))}),oe(q,we)}),W(V),W(O);var K=J(O,2),ee=G(K);ht(m1(ee,{get items(){return b(l)},get startIndex(){return b(y)},set startIndex(q){M(y,q)},get endIndex(){return b(m)},set endIndex(q){M(m,q)},children:uS,$$slots:{default:(q,ue)=>{const Ee=Nt(()=>ue.item);var we=M3();const H=Nt(()=>{const{place:ti,playerName:ni,value:ri}=b(Ee);return{place:ti,playerName:ni,value:ri}}),ne=Nt(()=>b(H).playerName===s()[$.playerName]),De=Nt(()=>"place: "+b(H).place+`
name: `+b(H).playerName.toUpperCase()+`
score: `+b(H).value);var Pt=G(we),po=G(Pt,!0);W(Pt);var Hr=J(Pt,2);let ei;var iu=G(Hr,!0);W(Hr);var go=J(Hr,2);let mo;var fs=J(go,2);let yo;var Da=G(fs,!0);W(fs),W(we),Ze((ti,ni,ri)=>{nt(we,1,zS(["grid",{first:b(H).place===1,second:b(H).place===2,third:b(H).place===3}]),"svelte-18hkl83"),Ot(we,"title",b(De)),gn(Pt,"color",`var(--color-${ti??""})`),st(po,ni),ei=nt(Hr,1,"player-name svelte-18hkl83",null,ei,{self:b(ne)}),st(iu,ri),mo=nt(go,1,"bar svelte-18hkl83",null,mo,{self:b(ne)}),yo=nt(fs,1,"record svelte-18hkl83",null,yo,{self:b(ne)}),st(Da,b(H).value)},[()=>k(b(H).place),()=>x(b(H).place),()=>U(b(H).playerName,b(H).place)],Nt),oe(q,we)}},$$legacy:!0}),q=>M(v,q),()=>b(v)),W(K);var Y=J(K,2),le=G(Y),re=G(le);W(le),W(Y),W(z),Ze(()=>{T=nt(P,1,"type svelte-18hkl83",null,T,{active:b(g)===$.highCombo}),R=nt(C,1,"type svelte-18hkl83",null,R,{active:b(g)===$.highScore})}),Ye(5,L,()=>tr,()=>({y:-48})),Be("click",L,_),Be("click",V,A),Be("click",re,E),Ye(1,re,()=>tr,()=>({y:48})),Ye(1,z,()=>Tr),oe(n,z),Ae(t,"prevPage",w),Ae(t,"nextPage",S);var be=Tt({prevPage:w,nextPage:S,$set:zt,$on:(q,ue)=>Ht(t,q,ue)});return r(),be}var B3=ce('<span class="title"> </span>'),N3=ce('<div class="dialog content"><div class="section-1"><!></div> <div class="section-2"></div> <div class="section-3"><!></div> <div class="section-4"></div></div>');function su(n,t){if(new.target)return Ut({component:su,...n});kt(t,!1);const e=tE();let r=At(t,"title",12,""),s=At(t,"opened",12,!1);function i(){return s()}function o(){s(!1),e("close")}function a(){s(!0),e("show")}Vt();var l=wl(),u=on(l);{var h=c=>{var d=N3(),f=G(d),g=G(f);{var y=_=>{var w=B3(),S=G(w,!0);W(w),Ze(()=>st(S,r())),Ye(1,w,()=>tr,()=>({y:-48})),oe(_,w)};Ve(g,_=>{r()&&_(y)})}W(f);var m=J(f,4),v=G(m);Ev(v,t,"default",{}),W(m),fc(2),W(d),Ye(1,m,()=>tr,()=>({y:24})),Ye(1,d,()=>Tr),oe(c,d)};Ve(u,c=>{s()&&c(h)})}return oe(n,l),Ae(t,"isOpened",i),Ae(t,"close",o),Ae(t,"show",a),Tt({isOpened:i,close:o,show:a,get title(){return r()},set title(c){r(c),yt()},get opened(){return s()},set opened(c){s(c),yt()},$set:zt,$on:(c,d)=>Ht(t,c,d)})}const R3="0.10.1";var O3=ce('<span class="rapid">rapid</span>'),F3=ce("<button>new game</button>"),$3=ce("<button>resume</button> <button>new game</button>",1),U3=ce("<button>p2p leaderboard</button>"),V3=ce('<div class="menu content"><div class="section-1"><h1>digifall <!></h1></div> <div class="section-2"></div> <div class="section-3"><div class="col"><!> <!> <button>options</button></div></div> <div class="section-4"></div></div> <span class="version"></span> <a href="https://github.com/shlavik/digifall" class="github-corner" aria-label="View source on GitHub"><svg viewBox="0 0 250 250" aria-hidden="true"><path d="M0,0 L115,115 L130,115 L142,142 L250,250 L250,0 Z"></path><path class="octo-arm" d="M128.3,109.0 C113.8,99.7 119.0,89.6 119.0,89.6 C122.0,82.7 120.5,78.6 120.5,78.6 C119.2,72.0 123.4,76.3 123.4,76.3 C127.3,80.9 125.5,87.3 125.5,87.3 C122.9,97.6 130.6,101.9 134.4,103.2" fill="currentColor"></path><path class="octo-body" d="M115.0,115.0 C114.9,115.1 118.7,116.5 119.8,115.4 L133.7,101.6 C136.9,99.2 139.9,98.4 142.2,98.6 C133.8,88.0 127.5,74.4 143.8,58.0 C148.5,53.4 154.0,51.2 159.7,51.0 C160.3,49.4 163.2,43.6 171.4,40.1 C171.4,40.1 176.1,42.5 178.8,56.2 C183.1,58.6 187.2,61.8 190.9,65.4 C194.5,69.0 197.7,73.2 200.1,77.6 C213.8,80.2 216.3,84.9 216.3,84.9 C212.7,93.1 206.9,96.0 205.4,96.6 C205.1,102.4 203.0,107.8 198.3,112.5 C181.9,128.9 168.3,122.5 157.7,114.1 C157.9,116.9 156.7,120.9 152.7,124.9 L141.0,136.5 C139.8,137.7 141.6,141.9 141.8,141.8 Z" fill="currentColor"></path></svg></a>',1),H3=ce('<div class="col"><p>start a new game?</p> <div class="row"><button>yes</button> <button>no</button></div></div>'),z3=ce("<!> <!>",1);function v1(n,t){if(new.target)return Ut({component:v1,...n});kt(t,!1);const[e,r]=wn(),s=()=>ge(Ft,"$options",e),i=()=>ge(Fr,"$phase",e);let o=Q(null),a=Q(!1);JS(()=>{s().playerName===""&&xt(_t,ye.wellcome)});function l(){return b(o).isOpened()}function u(){b(o).close()}function h(){xt(_t,null)}function c(){b(o).close(),Yh()}function d(){xt(_t,ye.leaderboard)}function f(){xt(_t,ye.options)}Vt();var g=z3(),y=on(g);{var m=w=>{var S=V3(),A=on(S),E=G(A),I=G(E),k=J(G(I));{var x=O=>{var V=O3();oe(O,V)};Ve(k,O=>{s().rapid&&O(x)})}W(I),W(E);var U=J(E,4),B=G(U),N=G(B);{var z=O=>{var V=F3();Be("click",V,c),oe(O,V)},D=O=>{var V=$3(),K=on(V),ee=J(K,2);Be("click",K,h),Be("click",ee,function(...Y){b(o).show?.apply(this,Y)}),oe(O,V)};Ve(N,O=>{i()===se.gameOver?O(z):O(D,!1)})}var L=J(N,2);{var P=O=>{var V=U3();Be("click",V,d),oe(O,V)};Ve(L,O=>{s()[$.leaderboard]&&O(P)})}var T=J(L,2);W(B),W(U),fc(2),W(A);var C=J(A,2);C.textContent=R3;var R=J(C,2);Be("click",T,f),Ye(5,A,()=>Tr),Ye(5,C,()=>Tr),Ye(5,R,()=>Tr),oe(w,S)};Ve(y,w=>{b(a)||w(m)})}var v=J(y,2);ht(su(v,{get opened(){return b(a)},set opened(w){M(a,w)},children:(w,S)=>{var A=H3(),E=J(G(A),2),I=G(E),k=J(I,2);W(E),W(A),Be("click",I,c),Be("click",k,function(...x){b(o).close?.apply(this,x)}),oe(w,A)},$$slots:{default:!0},$$legacy:!0}),w=>M(o,w),()=>b(o)),oe(n,g),Ae(t,"isNewGameDialog",l),Ae(t,"closeNewGameDialog",u);var _=Tt({isNewGameDialog:l,closeNewGameDialog:u,$set:zt,$on:(w,S)=>Ht(t,w,S)});return r(),_}var q3=ce('<span class="symbols">a-z 0-9 @&$!?-+=.:/_</span> <input class="player-name" type="text" inputmode="url" placeholder="player name" spellcheck="false" maxlength="42">',1);function lp(n,t){if(new.target)return Ut({component:lp,...n});kt(t,!1);const[e,r]=wn(),s=()=>ge(Ft,"$options",e),i=Q();let o=At(t,"playerName",28,()=>s().playerName),a=Q(null),l=Q("hidden");function u(g=400){M(l,"hidden"),b(a)&&(b(a).classList.toggle("blink"),setTimeout(()=>b(a).classList.toggle("blink"),g))}ae(()=>(kn(o()),b(a)),()=>{let g=o();o(u1(o())),M(l,g!==o()?"visible":"hidden"),o()===""&&b(a)&&b(a).focus()}),ae(()=>kn(o()),()=>{M(i,"player name: "+o().toUpperCase())}),dr(),Vt();var h=q3(),c=on(h),d=J(c,2);Xa(d),ht(d,g=>M(a,g),()=>b(a)),Ze(()=>{gn(c,"visibility",b(l)),Ot(d,"title",b(i))}),ZS(d,o),oe(n,h),Ae(t,"blink",u);var f=Tt({blink:u,get playerName(){return o()},set playerName(g){o(g),yt()},$set:zt,$on:(g,y)=>Ht(t,g,y)});return r(),f}var W3=ce('<form class="options content"><div class="section-1"><span>options</span></div> <div class="section-2"></div> <div class="section-3"><div class="col"><!> <input type="checkbox" id="leaderboard"> <label for="leaderboard" tabindex="0" role="button">p2p leaderboard</label> <input type="checkbox" id="rapid"> <label for="rapid" tabindex="0" role="button">rapid mode</label> <input type="checkbox" id="sound"> <label for="sound" tabindex="0" role="button">sound effects</label></div></div> <div class="section-4"><div class="col"><button type="submit" title="[open menu]">menu</button></div></div></form>'),G3=ce('<div class="col exclam-fix"><p>new name detected!</p> <p>progress will be lost!</p> <div class="row"><button>accept</button> <button>reject</button></div></div>'),K3=ce("<!> <!>",1);function b1(n,t){if(new.target)return Ut({component:b1,...n});kt(t,!1);const[e,r]=wn(),s=()=>ge(Ft,"$options",e);let i=Q(null),o=Q(!1),a=Q(null),l=Q(s().playerName);function u(){return b(o)}function h(){b(i).close(),xt(wa,$e.records),Yh(b(l))}function c(){b(i).close(),M(l,s().playerName)}function d(){if(b(l)==="")return b(a).blink();if(b(l)===s().playerName)return xt(_t,ye.menu);b(i).show()}Vt();var f=K3(),g=on(f);{var y=_=>{var w=W3(),S=G(w),A=G(S);W(S);var E=J(S,4),I=G(E),k=G(I);ht(lp(k,{get playerName(){return b(l)},set playerName(C){M(l,C)},$$legacy:!0}),C=>M(a,C),()=>b(a));var x=J(k,2);Xa(x);var U=J(x,2),B=J(U,2);Xa(B);var N=J(B,2),z=J(N,2);Xa(z);var D=J(z,2);W(I),W(E);var L=J(E,2),P=G(L),T=G(P);W(P),W(L),W(w),Ze(()=>{Ot(U,"title",`sharing records ${(s().leaderboard?"enabled":"disabled")??""}`),Ot(N,"title",`boring animations ${(s().rapid?"disabled":"enabled")??""}`),WS(z,s().sound),Ot(D,"title",`making sounds ${(s().sound?"enabled":"disabled")??""}`)}),Ye(5,A,()=>tr,()=>({y:-48})),Sp(x,()=>s().leaderboard,C=>Ja(Ft,it(s).leaderboard=C,it(s))),Sp(B,()=>s().rapid,C=>Ja(Ft,it(s).rapid=C,it(s))),Be("click",z,()=>Ja(Ft,it(s).sound=!s().sound,it(s))),Ye(5,E,()=>tr,()=>({y:24})),Ye(5,T,()=>tr,()=>({y:48})),Ye(5,w,()=>Tr),Be("submit",w,Hh(d)),oe(_,w)};Ve(g,_=>{b(o)||_(y)})}var m=J(g,2);ht(su(m,{get title(){return b(l)},get opened(){return b(o)},set opened(_){M(o,_)},children:(_,w)=>{var S=G3(),A=J(G(S),4),E=G(A),I=J(E,2);W(A),W(S),Be("click",E,h),Be("click",I,c),oe(_,S)},$$slots:{default:!0},$$legacy:!0}),_=>M(i,_),()=>b(i)),oe(n,f),Ae(t,"isDialogOpened",u);var v=Tt({isDialogOpened:u,$set:zt,$on:(_,w)=>Ht(t,_,w)});return r(),v}var Y3=ce('<form class="wellcome content"><div class="section-1"><h1>digifall</h1></div> <div class="section-2"></div> <div class="section-3"><div class="col"><!> <button type="submit">start</button></div></div> <div class="section-4"></div></form>'),Q3=ce(`<div class="col"><p>this game doesn't contain tutorial mode!</p> <p>the rules may not be obvious at first, but they're pretty simple!</p> <button>continue</button></div>`),j3=ce("<!> <!>",1);function w1(n,t){if(new.target)return Ut({component:w1,...n});kt(t,!1);const[e,r]=wn(),s=()=>ge(Ft,"$options",e);let i=Q(null),o=Q(!0),a=Q(null),l=Q(s().playerName);function u(){xt(Kh,Date.now()),Ja(Ft,it(s).playerName=b(l),it(s))}function h(){if(b(l)==="")return b(a).blink();xt(_t,null)}Vt();var c=j3(),d=on(c);{var f=m=>{var v=Y3(),_=J(G(v),4),w=G(_),S=G(w);ht(lp(S,{get playerName(){return b(l)},set playerName(A){M(l,A)},$$legacy:!0}),A=>M(a,A),()=>b(a)),fc(2),W(w),W(_),fc(2),W(v),Ye(5,v,()=>Tr),Be("input",v,u),Be("submit",v,Hh(h)),oe(m,v)};Ve(d,m=>{b(o)||m(f)})}var g=J(d,2);ht(su(g,{title:"heads up!",get opened(){return b(o)},set opened(m){M(o,m)},children:(m,v)=>{var _=Q3(),w=J(G(_),4);W(_),Be("click",w,function(...S){b(i).close?.apply(this,S)}),oe(m,_)},$$slots:{default:!0},$$legacy:!0}),m=>M(i,m),()=>b(i)),oe(n,c);var y=Tt({$set:zt,$on:(m,v)=>Ht(t,m,v)});return r(),y}var Z3=ce('<div class="overlay"><!></div>');function _1(n,t){if(new.target)return Ut({component:_1,...n});kt(t,!1);const[e,r]=wn(),s=()=>ge(_t,"$overlay",e),i=()=>ge(Fr,"$phase",e);let o=Q(null),a=Q(null),l=Q(null),u=Q(null),h=null;async function c(){if(await dv(),b(a)&&b(a).isNewGameDialog())return b(a).closeNewGameDialog();xt(_t,s()===null?ye.menu:s()===ye.menu?null:s()===ye.leaderboard||s()===ye.options?ye.menu:null)}function d(){S(-1)}function f(){S(1)}function g(){if(s()===ye.leaderboard)return h?h.classList.contains("types")?h.click():b(o).prevPage(h.classList.contains("pages")):void 0;(s()!==ye.options||b(l).isDialogOpened())&&S(-1)}function y(){if(s()===ye.leaderboard)return h?h.classList.contains("types")?h.click():b(o).nextPage(h.classList.contains("pages")):void 0;(s()!==ye.options||b(l).isDialogOpened())&&S(-1)}function m(){h&&(b(u)&&b(u).isFocused()?b(u).nextType():h.classList.contains("focus")&&h.click())}function v(){if(h&&h.blur(),s()===ye.options||s()===ye.leaderboard||s()===ye.gameOver)return xt(_t,ye.menu);if(s()===ye.menu&&i()!==se.gameOver)return xt(_t,null)}function _({node:x,selectors:U,shift:B=0}={}){if(!U||U.length<1)return;const N=U.map(P=>".overlay "+P).join(", "),z=Array.from(document.querySelectorAll(N));if(!x)return B<0?z[z.length+B]:z[0];if(B===0)return x;const D=z.indexOf(x);if(D===-1)return B<0?z[z.length+B]:z[0];let L=D+B;return L<0&&(L=z.length+L),L>z.length-1&&(L=L-z.length),z[L]}function w(x){if(x){if(b(u)&&b(u).isFocused()&&b(u).blur(),h&&(h.classList.remove("focus"),h.blur()),x.classList.contains("score"))return b(u)&&b(u).focus();h=x,h.classList.add("focus"),h.focus()}}function S(x){const U=["button:not(.digifall)","[role='button']","input:not([type='checkbox'])","[tabindex='-1']"],B=U.map(D=>".overlay "+D+".focus").join(", "),N=document.querySelector(B),z=_({node:N,selectors:U,shift:x});w(z)}Vt();var A=wl(),E=on(A);{var I=x=>{var U=Z3(),B=G(U);{var N=D=>{Jv(D,{get scoreComponent(){return b(u)},set scoreComponent(L){M(u,L)},$$legacy:!0})},z=(D,L)=>{{var P=C=>{ht(y1(C,{$$legacy:!0}),R=>M(o,R),()=>b(o))},T=(C,R)=>{{var O=K=>{ht(v1(K,{$$legacy:!0}),ee=>M(a,ee),()=>b(a))},V=(K,ee)=>{{var Y=re=>{ht(b1(re,{$$legacy:!0}),be=>M(l,be),()=>b(l))},le=(re,be)=>{{var q=ue=>{w1(ue,{})};Ve(re,ue=>{s()===ye.wellcome&&ue(q)},be)}};Ve(K,re=>{s()===ye.options?re(Y):re(le,!1)},ee)}};Ve(C,K=>{s()===ye.menu?K(O):K(V,!1)},R)}};Ve(D,C=>{s()===ye.leaderboard?C(P):C(T,!1)},L)}};Ve(B,D=>{s()===ye.gameOver?D(N):D(z,!1)})}W(U),Ye(3,U,()=>ec,()=>({duration:200})),oe(x,U)};Ve(E,x=>{s()&&x(I)})}oe(n,A),Ae(t,"switchOverlay",c),Ae(t,"moveUp",d),Ae(t,"moveDown",f),Ae(t,"moveLeft",g),Ae(t,"moveRight",y),Ae(t,"perfomAction",m),Ae(t,"blur",v);var k=Tt({switchOverlay:c,moveUp:d,moveDown:f,moveLeft:g,moveRight:y,perfomAction:m,blur:v,$set:zt,$on:(x,U)=>Ht(t,x,U)});return r(),k}var X3=ce('<div class="app"><!> <!></div>');function S1(n,t){if(new.target)return Ut({component:S1,...n});kt(t,!1);const[e,r]=wn(),s=()=>ge(Fr,"$phase",e),i=()=>ge(_t,"$overlay",e),o=()=>ge(Al,"$energy",e),a=()=>ge(_a,"$seed",e);let l=Q(null),u=Q(null);Ip>0&&setTimeout(()=>location=location,Ip*1e3),onstorage=function(){document.hasFocus()||(document.location=document.location)};function h(){const{style:v,offsetHeight:_,offsetWidth:w}=document.documentElement,E=_/w<1.5?_/192:w/128,I=E%.25;v.setProperty("font-size",E-I+"px")}h(),onresize=h,document.addEventListener("visibilitychange",h);function c(v){document.documentElement.classList[v?"add":"remove"]("random-color")}function d(v){const _=i()===null?b(l):b(u);switch(v.code){case"Escape":return v.preventDefault(),_.blur();case"Tab":return v.preventDefault(),!a()||i()===ye.wellcome||i()===ye.gameOver?void 0:b(u).switchOverlay();case"ArrowUp":return _.moveUp();case"ArrowDown":return _.moveDown();case"ArrowLeft":return _.moveLeft();case"ArrowRight":return _.moveRight();case"Enter":case"Space":case"KeyF":case"KeyJ":return _.perfomAction()}}ae(()=>(s(),ye),()=>{s()===se.gameOver&&xt(_t,ye.gameOver)}),ae(()=>(o(),s(),i(),ye),()=>{c(o().value>100||s()===se.extra||s()===se.combo||i()===ye.leaderboard||i()===ye.gameOver)}),dr(),Vt();var f=X3();Be("keydown",hd,d);var g=G(f);ht(Xv(g,{$$legacy:!0}),v=>M(l,v),()=>b(l));var y=J(g,2);ht(_1(y,{$$legacy:!0}),v=>M(u,v),()=>b(u)),W(f),oe(n,f);var m=Tt({$set:zt,$on:(v,_)=>Ht(t,v,_)});return r(),m}Ov(Bs,VE);new S1({target:document.body});
